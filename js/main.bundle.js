!function(){var e,t={45813:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoftType=t.FilletErrorCode=t.RevolveErrorCode=t.SweepErrorCode=t.PreviewType=void 0,function(e){e[e.TryGenerate=0]="TryGenerate",e[e.GenerateOnly=1]="GenerateOnly",e[e.PreviewOnly=2]="PreviewOnly"}(t.PreviewType||(t.PreviewType={})),function(e){e.CoordinateZUnparallelWithPath="CoordinateZUnparallelWithPath",e.PathReversedConnection="PathReversedConnection",e.PathTwistedLoop="PathTwistedLoop",e.SurfaceDegenerate="SurfaceDegenerate"}(t.SweepErrorCode||(t.SweepErrorCode={})),function(e){e.InputInvalidLoop="InputInvalidLoop",e.AllCurveInRevolveLine="AllCurveInRevolveLine",e.PathProjectError="PathProjectError",e.InvalidRevolveBody="InvalidRevolveBody"}(t.RevolveErrorCode||(t.RevolveErrorCode={})),function(e){e.InputInvalidRadius="InputInvalidRadius",e.InputInvalidEdges="InputInvalidEdges",e.FilletSelfIntersect="FilletSelfIntersect",e.InvalidFilletBody="InvalidFilletBody"}(t.FilletErrorCode||(t.FilletErrorCode={})),function(e){e[e.CURVESLOFT=0]="CURVESLOFT",e[e.FACESLOFT=1]="FACESLOFT"}(t.LoftType||(t.LoftType={}))},45968:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PositionType=void 0,function(e){e[e.UNKWON=0]="UNKWON",e[e.OUT=1]="OUT",e[e.IN=2]="IN",e[e.INOUT=3]="INOUT",e[e.OUTIN=4]="OUTIN"}(t.PositionType||(t.PositionType={}))},53265:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getLeftAndRightCoedgeEx=t.getLeftAndRightCoedge=void 0,t.getLeftAndRightCoedge=function(e){const t=e.getCoedge3ds();let n=t[0].getSameDirWithEdge(),r=t[1].getSameDirWithEdge();const s=e.getFaces();let i,o;if(s[0].getSameDirWithSurface()||(n=!n),s[1].getSameDirWithSurface()||(r=!r),n)i=t[0],o=t[1];else{if(!r)throw new Error("getLeftAndRightCoedge：体的数据存在拓扑错误！");i=t[1],o=t[0]}return[i,o]},t.getLeftAndRightCoedgeEx=function(e){const t=e.getCoedge3ds(),n=[];for(const e of t)n.push(e.getSameDirWithEdge());const r=e.getFaces(),s=[];for(const e of r)s.push(e.getSameDirWithSurface());for(let e=0;e<t.length;e++)s[e]||(n[e]=!n[e]);const i=[],o=[];for(let e=0;e<t.length;e++)n[e]?i.push(t[e]):o.push(t[e]);return[i,o]}},74852:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveSolidAnalysis=void 0;const r=n(98106),s=n(53265);t.CurveSolidAnalysis=class{static curveFace(e,t,n){let s,i;n instanceof r.Vector3?(s=e.getParamAt(n),i=t.getSurface().getUVAt(n)):(s=n.curveT,i=n.surfaceUV);const o=e.getTangentAt(s),a=t.getNormAt(i);let c=!1;const l=e.getSingularities();for(const e of l)Math.abs(e-s)<r.Tolerance.NUMBER_EPS&&(c=!0);let d,u;const h=o.dot(a);if(Math.abs(h)<=r.Tolerance.ANGLE_EPS||c){const n={point:e.getPtAt(s),curveT:s,surfaceUV:i};return d=this._curveFaceTangent(e,t,n,!1),u=this._curveFaceTangent(e,t,n,!0),{prev:d,next:u}}return h>0?{prev:-1,next:1}:{prev:1,next:-1}}static curveEdge(e,t,n,i){let o,a;if(i)[o,a]=i;else{const[e,n]=i||s.getLeftAndRightCoedge(t);o=e.getFace(),a=n.getFace()}const c=o.getSurface(),l=a.getSurface(),d=c.getUVAt(n),u=l.getUVAt(n),h=o.getNormAt(d),g=a.getNormAt(u),f=t.getCurve(),p=f.getParamAt(n),_=f.getTangentAt(p),m=h.cross(_),v=_.cross(g),E=_.cross(v),P=new r.Coordinate3(n,v,E),y=v.angleTo(m,_),C=e.getParamAt(n);let S=!1;const T=e.getSingularities();for(const e of T)if(Math.abs(e-C)<r.Tolerance.NUMBER_EPS)throw S=!0,new Error;let b,w,x,M,N,A;if(S){M=e.getTangentAt(C);const t=P.getLocalVectorAt(M);if(t.getSqLength()<r.Tolerance.ANGLE_EPS*r.Tolerance.ANGLE_EPS)throw new Error;const n=new r.Vector3(t.x,t.y,0);w=r.Vector3.X().angleTo(n,r.Vector3.Z()),x=e.getTangentAt(C,!0);const s=P.getLocalVectorAt(x);if(s.getSqLength()<r.Tolerance.ANGLE_EPS*r.Tolerance.ANGLE_EPS)throw new Error;const i=new r.Vector3(s.x,s.y,0);b=r.Vector3.X().angleTo(i,r.Vector3.Z())}else{const t=e.getTangentAt(C);x=t,M=t;const n=P.getLocalVectorAt(t);if(n.getSqLength()<r.Tolerance.ANGLE_EPS*r.Tolerance.ANGLE_EPS)throw new Error;const s=new r.Vector3(n.x,n.y,0);w=r.Vector3.X().angleTo(s,r.Vector3.Z()),b=w+r.CONST.PI,b=b>r.CONST.PI2?b-r.CONST.PI2:b}if(_.isParallel(M)){const t=this._edgeFacesContainsCurve([o,a],e);if(t>-1){const r=1===t?o:a,s={point:n,curveT:C,surfaceUV:1===t?d:u},i=this._curveFaceTangent(e,r,s,!0);N=-1===i||0===i?-1:1}else{const t={point:n,curveT:C,surfaceUV:d};if(1===this._curveFaceTangent(e,o,t,!0))N=1;else{const t={point:n,curveT:C,surfaceUV:u},r=this._curveFaceTangent(e,a,t,!0);N=-1===r||0===r?-1:1}}}else if(w<r.Tolerance.ANGLE_EPS||Math.abs(w-r.CONST.PI2)<r.Tolerance.ANGLE_EPS||Math.abs(w-y)<r.Tolerance.ANGLE_EPS){let t,s,i,c;if(w<r.Tolerance.ANGLE_EPS||Math.abs(w-r.CONST.PI2)<r.Tolerance.ANGLE_EPS?(t=a,s=o,i=u,c=d):(t=o,s=a,i=d,c=u),Math.abs(y)<r.Tolerance.ANGLE_EPS){const r={point:n,curveT:C,surfaceUV:c};if(1===this._curveFaceTangent(e,s,r,!0))N=1;else{const r={point:n,curveT:C,surfaceUV:i},s=this._curveFaceTangent(e,t,r,!0);N=-1===s||0===s?-1:1}}else{const r={point:n,curveT:C,surfaceUV:i},s=this._curveFaceTangent(e,t,r,!0);N=-1===s||0===s?-1:1}}else if(w<y-r.Tolerance.ANGLE_EPS)N=-1;else{if(!(w>y+r.Tolerance.ANGLE_EPS))throw new Error;N=1}if(_.isParallel(x)){const t=this._edgeFacesContainsCurve([o,a],e);if(t>-1){const r=1===t?o:a,s={point:n,curveT:C,surfaceUV:1===t?d:u},i=this._curveFaceTangent(e,r,s,!1);A=-1===i||0===i?-1:1}else{const t={point:n,curveT:C,surfaceUV:d};if(1===this._curveFaceTangent(e,o,t,!1))A=1;else{const t={point:n,curveT:C,surfaceUV:u},r=this._curveFaceTangent(e,a,t,!1);A=-1===r||0===r?-1:1}}}else if(b<r.Tolerance.ANGLE_EPS||Math.abs(b-r.CONST.PI2)<r.Tolerance.ANGLE_EPS||Math.abs(b-y)<r.Tolerance.ANGLE_EPS){let t,s,i,c;if(b<r.Tolerance.ANGLE_EPS||Math.abs(b-r.CONST.PI2)<r.Tolerance.ANGLE_EPS?(t=a,s=o,i=u,c=d):(t=o,s=a,i=d,c=u),Math.abs(y)<r.Tolerance.ANGLE_EPS){const r={point:n,curveT:C,surfaceUV:c};if(1===this._curveFaceTangent(e,s,r,!1))A=1;else{const r={point:n,curveT:C,surfaceUV:i},s=this._curveFaceTangent(e,t,r,!1);A=-1===s||0===s?-1:1}}else{const r={point:n,curveT:C,surfaceUV:i},s=this._curveFaceTangent(e,t,r,!1);A=-1===s||0===s?-1:1}}else if(b<y-r.Tolerance.ANGLE_EPS)A=-1;else{if(!(b>y+r.Tolerance.ANGLE_EPS))throw new Error;A=1}return{prev:A,next:N}}static _curveFaceTangent(e,t,n,s){const i=e.getRange(),o=s?n.curveT+i.getLength()/1e3:n.curveT-i.getLength()/1e3;if(s){if(e.isNurbsCurve3d()&&o>e.getDomain().max||e.isOffsetCurve3d()&&e.getBaseCurve().isNurbsCurve3d()&&o>e.getDomain().max)return 0}else if(e.isNurbsCurve3d()&&o<e.getDomain().min||e.isOffsetCurve3d()&&e.getBaseCurve().isNurbsCurve3d()&&o<e.getDomain().min)return 0;const a=t.getSurface(),c=e.getPtAt(o),l=a.getUVAt(c);if(a.isNurbsSurface()&&!a.uvInDomains(l))return 0;const d=a.getPtAt(l),u=t.getNormAt(l),h=c.subtracted(d).normalize().dot(u);return h<-r.Tolerance.ANGLE_EPS?-1:h>r.Tolerance.ANGLE_EPS?1:0}static _edgeFacesContainsCurve(e,t){let n=-1;const[r,s]=e.map((e=>e.getSurface()));return r.isPlane()&&r.containsCurve(t)?n=0:s.isPlane()&&s.containsCurve(t)?n=1:(r.isCylinder()||r.isCone())&&r.containsCurve(t)?n=0:(s.isCylinder()||s.isCone())&&s.containsCurve(t)&&(n=1),n}}},79701:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FaceFaceAnalysis=void 0;const r=n(98106),s=n(45968);t.FaceFaceAnalysis=class{static FaceFace(e,t,n,i=r.Tolerance.LENGTH_EPS){const o=this._calcTryPtsNumber([e,t],n),a=n.getRange(),c=a.getLength()/o;let l;const d=e.getSurface(),u=t.getSurface();for(let r=0;r<o;r++){const o=a.min+r*c,h=n.getPtAt(o),g=n.getTangentAt(o),f=d.getUVAt(h),p=e.getNormAt(f),_=u.getUVAt(h),m=t.getNormAt(_);if(!p.isParallel(m))return s.PositionType.UNKWON;const v=p.cross(g),E=h.added(v.multiplied(.01)),P=d.getUVAt(E),y=u.getUVAt(E),C=d.getPtAt(P),S=u.getPtAt(y).subtracted(C).normalize(),T=e.getNormAt(P).dot(S),b=h.subtracted(v.multiplied(.01)),w=d.getUVAt(b),x=u.getUVAt(b),M=d.getPtAt(w),N=u.getPtAt(x).subtracted(M).normalize(),A=e.getNormAt(w).dot(N);if(T*A<0)return s.PositionType.UNKWON;if(T>i&&A>i){const e=s.PositionType.OUT;if(void 0===l)l=e;else if(l!==e)return s.PositionType.UNKWON}else if(T<-i&&A<-i){const e=s.PositionType.IN;if(void 0===l)l=e;else if(l!==e)return s.PositionType.UNKWON}}return void 0===l?s.PositionType.UNKWON:l}static FaceAndEdgeFaces(e,t,n,i,o=r.Tolerance.LENGTH_EPS){if(i.length>1)return{position1:s.PositionType.IN,position2:s.PositionType.IN};const[a,c]=n,l=this._calcTryPtsNumber([e,...n],t),d=t.getRange(),u=d.getLength()/l;let h,g;const f=e.getSurface(),p=a.getSurface(),_=c.getSurface();for(let n=0;n<l;n++){const l=d.min+n*u,m=t.getPtAt(l),v=t.getTangentAt(l),E=f.getUVAt(m),P=e.getNormAt(E),y=p.getUVAt(m),C=_.getUVAt(m),S=a.getNormAt(y),T=c.getNormAt(C),b=v,w=b.cross(P),x=S.cross(b),M=b.cross(T),N=M.angleTo(x,b),A=new r.PeriodInterval(0,N,r.CONST.PI2),O=M.angleTo(w,b),I=new r.PeriodInterval(O,O+r.CONST.PI,r.CONST.PI2);if(I.containsPointAtStartOrEnd(0)||I.containsPointAtStartOrEnd(N)){if(0===i.length&&f.isPlane()&&_.isPlane()&&p.isPlane()){const e=o/100,t=I.containsPoint(N,e)?s.PositionType.IN:s.PositionType.OUT,n=I.containsPoint(0,e)?s.PositionType.IN:s.PositionType.OUT;g=this._judgeFaceAndEdgeFacesPostion(g,t,n);const i=A.containsPoint(O+r.CONST.PI,e)?s.PositionType.IN:s.PositionType.OUT,a=A.containsPoint(O,e)?s.PositionType.IN:s.PositionType.OUT;h=this._judgeFaceAndEdgeFacesPostion(h,i,a);continue}let t,n;I.containsPointAtStartOrEnd(0)?(t=M.reversed(),n=M):(t=x,n=x.reversed());const l=this._tangentFaceHalfFaceTryPosition(e,a,m,x,t,o),d=this._tangentFaceHalfFaceTryPosition(e,c,m,M,n,o);g=this._judgeFaceAndEdgeFacesPostion(g,l.position2,d.position2),h=this._judgeFaceAndEdgeFacesPostion(h,l.position1,d.position1)}else{const e=I.containsPoint(N,o)?s.PositionType.IN:s.PositionType.OUT,t=I.containsPoint(0,o)?s.PositionType.IN:s.PositionType.OUT;g=this._judgeFaceAndEdgeFacesPostion(g,e,t);const n=A.containsPoint(O+r.CONST.PI,o)?s.PositionType.IN:s.PositionType.OUT,i=A.containsPoint(O,o)?s.PositionType.IN:s.PositionType.OUT;h=this._judgeFaceAndEdgeFacesPostion(h,n,i)}if(h===s.PositionType.UNKWON&&g===s.PositionType.UNKWON)break}return{position1:h,position2:g}}static EdgeFacesAndEdgeFaces(e,t,n,i,o,a=r.Tolerance.LENGTH_EPS){const[c,l]=n,[d,u]=t?[i[0],i[1]]:[i[1],i[0]],h=this._calcTryPtsNumber([...n,...i],e),g=e.getRange(),f=g.getLength()/h;let p,_;const m=c.getSurface(),v=l.getSurface(),E=d.getSurface(),P=u.getSurface();for(let n=0;n<h;n++){const h=g.min+n*f,y=e.getPtAt(h),C=e.getTangentAt(h),S=m.getUVAt(y),T=v.getUVAt(y),b=c.getNormAt(S),w=l.getNormAt(T),x=E.getUVAt(y),M=P.getUVAt(y),N=d.getNormAt(x),A=u.getNormAt(M),O=C,I=b.cross(O),D=O.cross(w),L=N.cross(O),V=O.cross(A),R=this._classifyOverlapFacePair({face:c,faceProjDir:I},{face:l,faceProjDir:D},{face:d,faceProjDir:L},{face:u,faceProjDir:V},o);let U=D.angleTo(I,O),B=D.angleTo(V,O),F=D.angleTo(L,O);const k=e.getStartPt(),G=e.getEndPt();if(I.equals(D)){const e=this._adjustFaceProjectDir(k,G,c,I);if(e){U=D.angleTo(e,O)>r.CONST.PI?r.CONST.PI2:0}else{const e=this._adjustFaceProjectDir(k,G,l,D);if(e){U=e.angleTo(I,O)>r.CONST.PI?r.CONST.PI2:0}}}if(L.equals(V)){const e=this._adjustFaceProjectDir(k,G,d,L);if(e){F=V.angleTo(e,O)>r.CONST.PI?B+r.CONST.PI2:B}else{const e=this._adjustFaceProjectDir(k,G,u,V);if(e){F=e.angleTo(L,O)>r.CONST.PI?B+r.CONST.PI2:B}}}for(const e of R)e.face2===d?F=e.face1===c?U:0:B=e.face1===c?U:0;const j=new r.PeriodInterval(0,U,r.CONST.PI2),[z,W]=t?[B,F]:[F,B],q=new r.PeriodInterval(B,F,r.CONST.PI2);if(I.equals(D)||L.equals(V)){let e,n,r,i;if(I.equals(L)){const t=this._tangentFaceHalfFaceTryPosition(c,d,y,L,I,a);[e,r]=[t.position1,t.position2]}if(I.equals(V)){const t=this._tangentFaceHalfFaceTryPosition(c,u,y,V,I,a);[e,i]=[t.position1,t.position2]}if(D.equals(L)){const e=this._tangentFaceHalfFaceTryPosition(l,d,y,L,D,a);[n,r]=[e.position1,e.position2]}if(D.equals(V)){const e=this._tangentFaceHalfFaceTryPosition(l,u,y,V,D,a);[n,i]=[e.position1,e.position2]}e||(e=q.containsPoint(U)?s.PositionType.IN:s.PositionType.OUT),n||(n=q.containsPoint(0)?s.PositionType.IN:s.PositionType.OUT),r||(r=j.containsPoint(F)?s.PositionType.IN:s.PositionType.OUT),i||(i=j.containsPoint(B)?s.PositionType.IN:s.PositionType.OUT);const[o,h]=t?[r,i]:[i,r];_=this._judgeFaceAndEdgeFacesPostion(_,o,h),p=this._judgeFaceAndEdgeFacesPostion(p,e,n)}const H=R.filter((e=>!1===e.isFaceSameDir));if(H.length>0&&j.getLength()+q.getLength()<r.CONST.PI2-.001){p=H[0].face1===c?s.PositionType.INOUT:s.PositionType.OUTIN,_=H[0].face2===i[0]?s.PositionType.INOUT:s.PositionType.OUTIN;continue}if(1===R.length){if(R[0].face1===l&&R[0].face2===i[1]){const[e,t]=[s.PositionType.IN,s.PositionType.IN],n=q.containsPoint(U,a)?s.PositionType.IN:s.PositionType.OUT,r=j.containsPoint(W,a)?s.PositionType.IN:s.PositionType.OUT;_=this._judgeFaceAndEdgeFacesPostion(_,r,t),p=this._judgeFaceAndEdgeFacesPostion(p,n,e)}else if(R[0].face1===c&&R[0].face2===i[1]){const[e,t]=[s.PositionType.IN,s.PositionType.IN],n=q.containsPoint(0,a)?s.PositionType.IN:s.PositionType.OUT,r=j.containsPoint(W,a)?s.PositionType.IN:s.PositionType.OUT;_=this._judgeFaceAndEdgeFacesPostion(_,r,t),p=this._judgeFaceAndEdgeFacesPostion(p,e,n)}else if(R[0].face1===l&&R[0].face2===i[0]){const[e,t]=[s.PositionType.IN,s.PositionType.IN],n=q.containsPoint(U,a)?s.PositionType.IN:s.PositionType.OUT,r=j.containsPoint(z,a)?s.PositionType.IN:s.PositionType.OUT;_=this._judgeFaceAndEdgeFacesPostion(_,t,r),p=this._judgeFaceAndEdgeFacesPostion(p,n,e)}else if(R[0].face1===c&&R[0].face2===i[0]){const[e,t]=[s.PositionType.IN,s.PositionType.IN],n=q.containsPoint(0,a)?s.PositionType.IN:s.PositionType.OUT,r=j.containsPoint(z,a)?s.PositionType.IN:s.PositionType.OUT;_=this._judgeFaceAndEdgeFacesPostion(_,t,r),p=this._judgeFaceAndEdgeFacesPostion(p,e,n)}continue}const Y=(e,t,n)=>{const s=r.PeriodInterval.RegularizeParam(e,r.CONST.PI2),i=r.PeriodInterval.RegularizeParam(t,r.CONST.PI2);return r.MathUtil.isNearlyEqual(s,i,n)};if(Y(j.min,q.min,a)&&Y(j.max,q.max,a)){const e=this._tangentFaceHalfFaceTryPosition(l,u,y,V,D,a),n=this._tangentFaceHalfFaceTryPosition(c,d,y,L,I,a),[r,s]=[e.position1,e.position2],[i,o]=[n.position1,n.position2],[h,g]=t?[o,s]:[s,o];_=this._judgeFaceAndEdgeFacesPostion(_,h,g),p=this._judgeFaceAndEdgeFacesPostion(p,i,r)}else if(Y(j.min,q.max,a)&&Y(j.max,q.min,a)){const e=this._tangentFaceHalfFaceTryPosition(c,u,y,V,I,a),[n,r]=[e.position1,e.position2],s=this._tangentFaceHalfFaceTryPosition(l,d,y,L,D,a),[i,o]=[s.position1,s.position2],[h,g]=t?[o,r]:[r,o];_=this._judgeFaceAndEdgeFacesPostion(_,h,g),p=this._judgeFaceAndEdgeFacesPostion(p,n,i)}else if(j.containsPointAtStartOrEnd(q.min,a)||j.containsPointAtStartOrEnd(q.max,a))if(Y(j.min,q.min,a)){const e=this._tangentFaceHalfFaceTryPosition(l,u,y,V,D,a),[n,r]=[e.position1,e.position2],i=q.containsPoint(U,a)?s.PositionType.IN:s.PositionType.OUT,o=j.containsPoint(F,a)?s.PositionType.IN:s.PositionType.OUT,[c,d]=t?[o,r]:[r,o];_=this._judgeFaceAndEdgeFacesPostion(_,c,d),p=this._judgeFaceAndEdgeFacesPostion(p,i,n)}else if(Y(j.max,q.min,a)){const e=this._tangentFaceHalfFaceTryPosition(c,u,y,V,I,a),[n,r]=[e.position1,e.position2],i=q.containsPoint(0,a)?s.PositionType.IN:s.PositionType.OUT,o=j.containsPoint(F,a)?s.PositionType.IN:s.PositionType.OUT,[l,d]=t?[o,r]:[r,o];_=this._judgeFaceAndEdgeFacesPostion(_,l,d),p=this._judgeFaceAndEdgeFacesPostion(p,n,i)}else if(Y(j.min,q.max,a)){const e=this._tangentFaceHalfFaceTryPosition(l,d,y,L,D,a),[n,r]=[e.position1,e.position2],i=q.containsPoint(U,a)?s.PositionType.IN:s.PositionType.OUT,o=j.containsPoint(B,a)?s.PositionType.IN:s.PositionType.OUT,[c,u]=t?[r,o]:[o,r];_=this._judgeFaceAndEdgeFacesPostion(_,c,u),p=this._judgeFaceAndEdgeFacesPostion(p,i,n)}else{if(!Y(j.max,q.max,a))throw new Error;{const e=this._tangentFaceHalfFaceTryPosition(c,d,y,L,I,a),[n,r]=[e.position1,e.position2],i=q.containsPoint(0,a)?s.PositionType.IN:s.PositionType.OUT,o=j.containsPoint(B,a)?s.PositionType.IN:s.PositionType.OUT,[l,u]=t?[r,o]:[o,r];_=this._judgeFaceAndEdgeFacesPostion(_,l,u),p=this._judgeFaceAndEdgeFacesPostion(p,n,i)}}else{const e=j.containsPoint(W,a)?s.PositionType.IN:s.PositionType.OUT,t=j.containsPoint(z,a)?s.PositionType.IN:s.PositionType.OUT;_=this._judgeFaceAndEdgeFacesPostion(_,e,t);const n=q.containsPoint(U,a)?s.PositionType.IN:s.PositionType.OUT,r=q.containsPoint(0,a)?s.PositionType.IN:s.PositionType.OUT;p=this._judgeFaceAndEdgeFacesPostion(p,n,r)}if(p===s.PositionType.UNKWON&&_===s.PositionType.UNKWON)break}return{position1:p,position2:_}}static FaceHalfFace(e,t,n,s,i=r.Tolerance.LENGTH_EPS){const o=s?1:-1,a=n.getRange(),c=a.getLength()/6;let l;const d=e.getSurface(),u=t.getSurface();for(let r=0;r<6;r++){const s=a.min+r*c,h=n.getPtAt(s),g=n.getTangentAt(s),f=u.getUVAt(h),p=t.getNormAt(f).cross(g),_=h.added(p.multiplied(.01*o)),m=d.getUVAt(_),v=u.getUVAt(_),E=d.getPtAt(m),P=u.getPtAt(v).subtracted(E).normalize(),y=e.getNormAt(m).dot(P);if(y>i){const e=-1;if(void 0===l)l=e;else if(l!==e)return 0}else if(y<-i){const e=1;if(void 0===l)l=e;else if(l!==e)return 0}}return void 0===l?0:l}static _tangentFaceHalfFaceTryPosition(e,t,n,i,o,a=r.Tolerance.LENGTH_EPS){const c=a*a;let l=.01;const d=e.getSurface(),u=t.getSurface();d.isCylinder()&&d.isEqualAB()&&d.getRadius()>10?l*=d.getRadius()/10:u.isCylinder()&&u.isEqualAB()&&u.getRadius()>10&&(l*=u.getRadius()/10);const h=n.added(i.multiplied(l)),g=t.getSurface().getUVAt(h),f=t.getSurface().getPtAt(g),p=e.getSurface().getUVAt(h),_=e.getSurface().getPtAt(p),m=f.subtracted(_);if(m.getSqLength()<c)return{position1:s.PositionType.IN,position2:s.PositionType.IN};const v=m.normalize(),E=e.getNormAt(p),P=E.dot(v);let y;if(P>a)y=s.PositionType.OUT;else if(P<-a)y=s.PositionType.IN;else{const e=t.getNormAt(g);if(!E.isParallel(e))throw new Error("");y=s.PositionType.IN}const C=v.reversed(),S=t.getNormAt(g).dot(C);let T;if(S>a)T=s.PositionType.OUT;else if(S<-a)T=s.PositionType.IN;else{const r=n.added(o.multiplied(.01)),i=t.getSurface().getUVAt(r),c=t.getSurface().getPtAt(i),l=e.getSurface().getUVAt(r),d=e.getSurface().getPtAt(l).subtracted(c).normalize(),u=t.getNormAt(i),h=u.dot(d);if(h>a)T=s.PositionType.OUT;else if(h<-a)T=s.PositionType.IN;else{const e=t.getNormAt(l);if(!u.isParallel(e))throw new Error("");T=s.PositionType.IN}}return{position1:T,position2:y}}static _judgeFaceAndEdgeFacesPostion(e,t,n){let r=e;if(t===s.PositionType.IN&&n===s.PositionType.IN){const e=s.PositionType.IN;r=void 0===r||r===e?e:s.PositionType.UNKWON}else if(t===s.PositionType.OUT&&n===s.PositionType.OUT){const e=s.PositionType.OUT;r=void 0===r||r===e?e:s.PositionType.UNKWON}else if(t===s.PositionType.IN&&n===s.PositionType.OUT){const e=s.PositionType.INOUT;r=void 0===r||r===e?e:s.PositionType.UNKWON}else if(t===s.PositionType.OUT&&n===s.PositionType.IN){const e=s.PositionType.OUTIN;r=void 0===r||r===e?e:s.PositionType.UNKWON}else r=s.PositionType.UNKWON;return r}static _adjustFaceProjectDir(e,t,n,r){if(n.getSurface().isPlane())return;let s;for(const i of n.getWires()[0].getCoedge3ds()){const n=i.getCurve(),o=n.getStartTangent(),a=n.getEndTangent(),c=n.getRange();if(n.getStartPt().equals(e)&&o.isParallel(r)){s=n.getPtAt(c.min+c.getLength()/8).subtracted(e);break}if(n.getEndPt().equals(e)&&a.isParallel(r)){s=n.getPtAt(c.max-c.getLength()/8).subtracted(e);break}if(n.getStartPt().equals(t)&&o.isParallel(r)){s=n.getPtAt(c.min+c.getLength()/8).subtracted(t);break}if(n.getEndPt().equals(t)&&a.isParallel(r)){s=n.getPtAt(c.max-c.getLength()/8).subtracted(t);break}}return s}static _classifyOverlapFacePair(e,t,n,r,s){const i=(e,t)=>{for(const n of s)if(n.face1===e.face&&n.face2===t.face)return e.faceProjDir.dot(t.faceProjDir)>0?n:void 0},o=[],a=i(e,n);a&&o.push(a);const c=i(e,r);c&&o.push(c);const l=i(t,n);l&&o.push(l);const d=i(t,r);return d&&o.push(d),o}static _calcTryPtsNumber(e,t){if(!t.isLine3d())return 4;let n=1;for(const t of e){const e=t.getSurface();if(e.isPlane()||e.isCylinder()||e.isCone())n=1;else{if(e.isNurbsSurface())return 4;if(!(e instanceof r.OffsetSurface))return 4;{const t=e.getBaseSurface();if(!t.isCylinder()&&!t.isCone())return 4;n=1}}}return n}}},1572:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.searchOneWireInReciprocateCoedges=t.searchWires=t.searchWire=t.isWireDegenerated=t.searchCoedge=void 0;const r=n(98106),s=n(52928);function i(e,t,n){var s;const i=t.getEndVertex(),o=n.filter((e=>e.getStartVertex()===i));if(0===o.length)return;if(1===o.length)return o[0];const a=o.filter((e=>{var t;return null===(t=e.getEdge())||void 0===t?void 0:t.isDegenerate()}));if(a.length>1){const e=a[0].getPCurve(),t=a[1].getPCurve();if(e&&t){if(e.getEndPt().equals(t.getStartPt()))return a[0];if(t.getEndPt().equals(e.getStartPt()))return a[1];throw new Error("Boolean3d: searchWires: pCurve is wrong")}}else if(1===a.length&&(null===(s=t.getEdge())||void 0===s?void 0:s.isDegenerate()))return a[0];const c=e.getNormAtPoint(i.getPoint()),l=t.getEndTangent().reversed();let d=o[0];const u=d.getStartTangent();let h=l.angleTo(u,c);for(let e=1;e<o.length;e++){const t=o[e].getStartTangent(),n=l.angleTo(t,c);if(Math.abs(n-h)<r.Tolerance.ANGLE_EPS){const t=d.getCurve(),s=t.getDerivatives(t.getStartParam(),2),i=o[e].getCurve(),a=i.getDerivatives(i.getStartParam(),2),u=c.cross(l),g=s[2].multiplied(1/s[1].dot(s[1])),f=a[2].multiplied(1/a[1].dot(a[1])),p=g.dot(u),_=f.dot(u);Math.abs(p-_),r.Tolerance.NUMBER_EPS,p<_&&(h=n,d=o[e])}else n>h+r.Tolerance.ANGLE_EPS&&(h=n,d=o[e])}return d}t.searchCoedge=i,t.isWireDegenerated=function(e){return 2===e.length&&e[0].getEdge()===e[1].getEdge()},t.searchWire=function(e,t,n){let r=t;const o=[];o.push(r),n.splice(0,1);const a=r.getStartVertex();let c=-1;for(;o.length<1e4;){const t=i(e,r,n);if(void 0===t)break;const s=n.findIndex((e=>e===t));s>-1&&n.splice(s,1),o.push(t),r=t,t.getEndVertex()===a&&(c=o.length-1)}if(o[o.length-1].getEndVertex()!==a&&(c>=0?o.splice(c+1,o.length-c-1):o.splice(0,o.length)),o.length>0){return new s.Wire(o)}},t.searchWires=function(e,t,n,o=!1){const a=[];for(let e=0;e<n.length;e++)n[e].getStartVertex()===n[e].getEndVertex()&&n[e].getEdge().getCurve().getRange().getLength()<r.Tolerance.LENGTH_EPS&&!n[e].getEdge().isDegenerate()&&(n.splice(e,1),e--);for(let e=0;e<t.length;e++)t[e].getStartVertex()===t[e].getEndVertex()&&t[e].getEdge().getCurve().getRange().getLength()<r.Tolerance.LENGTH_EPS&&(t.splice(e,1),e--);const c=[];for(let e=0;e<t.length;e++){const n=t[e];let r=!1;const s=n.getTwins();for(const e of s){const n=t.findIndex((t=>t===e));n>-1&&(t.splice(n,1),c.push(e),r=!0)}r&&(t.splice(e,1),c.push(n),e--)}t.push(...c);let l=0;for(;t.length>0&&!(l>t.length-1);){let r=t[l];const c=[];c.push(r);const d=r.getStartVertex();let u=-1;const h=[...n];for(const e of t)e!==r&&h.push(e);for(;c.length<1e4;){const t=i(e,r,h);if(void 0===t)break;const n=h.findIndex((e=>e===t));if(n>-1&&h.splice(n,1),c.push(t),r=t,t.getEndVertex()===d){if(o)break;u=c.length-1}}if(c[c.length-1].getEndVertex()!==d&&(u>=0?c.splice(u+1,c.length-u-1):c.splice(0,c.length)),0!==c.length){l=0;for(const e of c){const r=n.findIndex((t=>t===e));if(r>-1)n.splice(r,1);else{const n=t.findIndex((t=>t===e));t.splice(n,1)}}if(c.length>0){const e=new s.Wire(c);a.push(e)}}else l++}return a},t.searchOneWireInReciprocateCoedges=function(e,t,n){for(let e=0;e<n.length;e++)n[e].getStartVertex()!==n[e].getEndVertex()||n[e].getEdge().getCurve().isPeriodic()||(n.splice(e,1),e--);for(let e=0;e<t.length;e++)t[e].getStartVertex()!==t[e].getEndVertex()||t[e].getEdge().getCurve().isPeriodic()||(t.splice(e,1),e--);let r=0;for(;t.length>0&&!(r>t.length-1);){let o=t[r];const a=[];a.push(o);const c=o.getStartVertex(),l=[...n];for(const e of t)e!==o&&l.push(e);for(;a.length<1e4;){const t=i(e,o,l);if(void 0===t)break;const n=l.findIndex((e=>e===t));if(n>-1&&l.splice(n,1),a.push(t),o=t,t.getEndVertex()===c)break}if(a[a.length-1].getEndVertex()!==c&&a.splice(0,a.length),0!==a.length){r=0;for(const e of a){const r=n.findIndex((t=>t===e));if(r>-1)n.splice(r,1);else{const n=t.findIndex((t=>t===e));t.splice(n,1)}}if(a.length>0){return new s.Wire(a)}}else r++}}},27140:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.BodyBuilder=void 0;const i=n(98106),o=n(11953),a=n(77354),c=n(38096),l=n(58501),d=n(45813),u=n(3025),h=n(65767),g=n(89195);class f{static createCubic(e,t,n=t,r=t){return g.BasicBodyBuilder.makeCubic(e,t,n,r)}static createCone(e,t,n,r,s=r,o=[0,i.CONST.PI2]){return g.BasicBodyBuilder.makeCone(e,t,n,r,s,o)}static createSphere(e,t,n,r,s=[0,i.CONST.PI2],o=[-i.CONST.PI_2,i.CONST.PI_2]){return g.BasicBodyBuilder.makeSphere(e,t,n,r,s,o)}static createTorus(e,t,n,r,s){return g.BasicBodyBuilder.makeTorus(e,t,n,r,s)}static extrude(e,t,n,r,s,i=!0,o){return a.ExtrudeBody.execute(e,t,n,r,s,i,!1,o)}static sweep(e,t,n,r=!0,s=!1,i){return new c.SweepBody(e.clone(),t,n,r,s,i).execute()}static sweepByCurve2ds(e,t,n,r=d.PreviewType.TryGenerate,s,o=i.Tolerance.DEFAULT,a,c=!1,u=i.UnitType.MM){if(u!==i.UnitType.MM){const d=new i.Vector3(0,0,0),h=i.UnitsConversion.getScale(u);e.map((e=>e.scale(h,d))),t.map((e=>e.map((e=>e.scale(h,d)))));const g=l.SweepBody2.makeByLoops2d(e,t,n,o),f=g.execute(r,c);if(f.scale(1/h,d),s&&g.getTopoTrack(t,s),a)for(const e of Object.keys(g.topo))a[e]=g.topo[e];return e.map((e=>e.scale(1/h,d))),t.map((e=>e.map((e=>e.scale(1/h,d))))),f}const h=l.SweepBody2.makeByLoops2d(e,t,n,o),g=h.execute(r,c);if(s&&h.getTopoTrack(t,s),a)for(const e of Object.keys(h.topo))a[e]=h.topo[e];return g}static sweepByCurve3ds(e,t,n=d.PreviewType.TryGenerate,r,s=i.Tolerance.DEFAULT,o,a=!1,c=i.UnitType.MM){if(c!==i.UnitType.MM){const d=new i.Vector3(0,0,0),u=i.UnitsConversion.getScale(c);e.map((e=>e.scale(u,d))),t.map((e=>e.map((e=>e.scale(u,d)))));const h=l.SweepBody2.makeByLoops3d(e,t,s),g=h.execute(n,a);if(g.scale(1/u,d),r&&h.getTopoTrack(t,r),o)for(const e of Object.keys(h.topo))o[e]=h.topo[e];return e.map((e=>e.scale(1/u,d))),t.map((e=>e.map((e=>e.scale(1/u,d))))),g}const u=l.SweepBody2.makeByLoops3d(e,t,s),h=u.execute(n,a);if(r&&u.getTopoTrack(t,r),o)for(const e of Object.keys(u.topo))o[e]=u.topo[e];return h}static revolve(e,t,n=0,r=2*Math.PI,s,o=i.Tolerance.DEFAULT){let a;if(t[0]instanceof i.Curve2d){a=new u.RevolveBody(e,[t],n,r,s,o).execute()}else{a=new u.RevolveBody(e,[t],n,r,s,o).execute()}return a}static loftShell(e,t,n,r=!0){return new h.LoftingShell(e,n,r).execute(t)}static loftShellOrderCurves(e,t){return h.LoftingShell.orderCurves(e,t)}}r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,Number,Number,Number,Number,Array]),s("design:returntype",o.BrepBody)],f,"createCone",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,Number,Number,Number,Array,Array]),s("design:returntype",o.BrepBody)],f,"createSphere",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,Number,Number,Number,Number]),s("design:returntype",o.BrepBody)],f,"createTorus",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,i.Polygon,i.Vector3,Number,Number,Object,Array]),s("design:returntype",o.BrepBody)],f,"extrude",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,i.Polygon,Array,Boolean,Boolean,Map]),s("design:returntype",o.BrepBody)],f,"sweep",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Array,i.Coordinate3,Object,Object,i.Tolerance,Object,Object,Object]),s("design:returntype",o.BrepBody)],f,"sweepByCurve2ds",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Array,Object,Object,i.Tolerance,Object,Object,Object]),s("design:returntype",o.BrepBody)],f,"sweepByCurve3ds",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,Array,Number,Number,i.Coordinate3,i.Tolerance]),s("design:returntype",o.BrepBody)],f,"revolve",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Number,Array,Object]),s("design:returntype",o.BrepBody)],f,"loftShell",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Array]),s("design:returntype",void 0)],f,"loftShellOrderCurves",null),t.BodyBuilder=f},89195:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.BasicBodyBuilder=void 0;const i=n(98106),o=n(40775),a=n(52928),c=n(11953),l=n(9548),d=n(91343),u=n(70750),h=n(58501);class g{static makeCubic(e,t,n=t,r=t){const s=new i.Line3d(e.getOrigin(),e.getDz(),[0,r]),o=i.CurveUtil.makeRectangleByXY(0,t,0,n);return h.SweepBody2.makeByLoops2d([s],[o],e).executePreview()}static makeCone(e,t,n,r,s=r,l=[0,i.CONST.PI2]){const d=s>r?r:s,u=d===r,h=new i.PeriodInterval(l[0],l[1]).isClosed(),g=new i.Arc3d(e,t,n,l),f=e.clone();f.setOrigin(e.getWorldPtAt({x:0,y:0,z:d}));const p=u?1:1-d/r,_=new i.Arc3d(f,t*p,n*p,l),m=[[],[]],v=[[],[]],E=new c.BrepBody,P=E.createVertex(g.getStartPt());m[0].push(P);const y=u?f.getOrigin():_.getStartPt(),C=E.createVertex(y);if(m[1].push(C),h){const e=E.createEdge(g,P,P);if(v[0].push(e),u){const e=E.createLineEdge(C,C);e.setDegenerateFlag(!0),v[1].push(e)}else{const e=E.createEdge(_,C,C);v[1].push(e)}}else{const e=E.createVertex(g.getEndPt()),t=E.createVertex(g.getCenter());m[0].push(e),m[0].push(t);const n=E.createEdge(g,P,e),r=E.createLineEdge(e,t),s=E.createLineEdge(t,P);if(v[0].push(n),v[0].push(r),v[0].push(s),u){m[1].push(C),m[1].push(C);const e=E.createLineEdge(C,C);e.setDegenerateFlag(!0),v[1].push(e)}else{const e=E.createVertex(_.getEndPt()),t=E.createVertex(_.getCenter());m[1].push(e),m[1].push(t);const n=E.createEdge(_,C,e),r=E.createLineEdge(e,t),s=E.createLineEdge(t,C);v[1].push(n),v[1].push(r),v[1].push(s)}}const S=[],T=E.createLineEdge(m[0][0],m[1][0]);if(S.push(T),!h){const e=E.createLineEdge(m[0][1],m[1][1]),t=E.createLineEdge(m[0][2],m[1][2]);S.push(e),S.push(t)}const b=new i.Plane(e),w=new a.Wire;for(const e of v[0])w.addCoedge3d(new o.Coedge3d(e,!0));E.createFace(b,!1,[w],"bottom");const x=new a.Wire,M=r<i.CONST.MODEL_MAX_LENGTH?new i.Cone(e,t,n,r):new i.Cylinder(e,t,n),N=new o.Coedge3d(v[1][0],!1);if(x.addCoedge3d(N),u){const e=new i.Vector2(l[1],d),t=new i.Vector2(l[0],d),n=e.midTo(t),r=new i.Line2d(e,n);N.setPCurve(r);const s=new o.Coedge3d(v[1][0],!0);x.addCoedge3d(s);const a=new i.Line2d(n,t);s.setPCurve(a)}const A=new o.Coedge3d(S[0],!1),O=new o.Coedge3d(v[0][0],!0),I=h?S[0]:S[1],D=new o.Coedge3d(I,!0);if(x.addCoedge3d(A),x.addCoedge3d(O),x.addCoedge3d(D),E.createFace(M,!0,[x],"side"),!u){const e=new i.Plane(f),t=new a.Wire;for(const e of v[1])t.addCoedge3d(new o.Coedge3d(e,!0));E.createFace(e,!0,[t],"top")}if(!h){const t=new i.Plane(g.getCenter(),m[0][1].getPoint().subtracted(g.getCenter()),e.getDz().reversed()),n=new i.Plane(g.getCenter(),m[0][0].getPoint().subtracted(g.getCenter()),e.getDz()),r=new a.Wire([new o.Coedge3d(S[1],!1),new o.Coedge3d(v[0][1],!0),new o.Coedge3d(S[2],!0)]);u||r.addCoedge3d(new o.Coedge3d(v[1][1],!1)),E.createFace(t,!0,[r],"planeEd");const s=new a.Wire([new o.Coedge3d(S[2],!1),new o.Coedge3d(v[0][2],!0),new o.Coedge3d(S[0],!0)]);u||s.addCoedge3d(new o.Coedge3d(v[1][2],!1)),E.createFace(n,!0,[s],"planeSt")}return E}static makeSphere(e,t,n,r,s=[0,i.CONST.PI2],h=[-i.CONST.PI_2,i.CONST.PI_2]){const g=h[0]<-i.CONST.PI_2?-r:r*Math.sin(h[0]),f=Math.abs(g+r)<i.Tolerance.LENGTH_EPS,p=h[1]>i.CONST.PI_2?r:r*Math.sin(h[1]),_=Math.abs(p-r)<i.Tolerance.LENGTH_EPS,m=new i.PeriodInterval(s[0],s[1]).isClosed(),v=r*r,E=[Math.sqrt(1-g*g/v),Math.sqrt(1-p*p/v)],P=new c.BrepBody,y=[[],[]],C=[[],[]],S=(r,c)=>{const h=e.clone();h.setOrigin(e.getWorldPtAt({x:0,y:0,z:c}));const g=new i.Arc3d(h,t*E[r],n*E[r],s),f=new d.Vertex(g.getStartPt());if(P.addVertex(f),m){const e=new l.Edge(g,f,f);P.addEdge(e),y[r].push(f),C[r].push(e)}else{const e=new d.Vertex(g.getEndPt());P.addVertex(e);const t=new l.Edge(g,f,e);P.addEdge(t),y[r].push(f),y[r].push(e),C[r].push(t);const n=h.getOrigin(),s=new d.Vertex(n);P.addVertex(s);const o=new i.Line3d(g.getEndPt(),n),a=new l.Edge(o,e,s),c=new i.Line3d(n,g.getStartPt()),u=new l.Edge(c,s,f);P.addEdge(a),P.addEdge(u),y[r].push(s),C[r].push(a),C[r].push(u)}const p=r>0?h.clone():h.clone().reverseZDir(),_=new i.Plane(p),v=new u.Face(_,!0),S=new a.Wire;if(r>0)for(const e of C[r]){const t=new o.Coedge3d(e,!0);S.addCoedge3d(t)}else for(let e=C[r].length-1;e>=0;e--){const t=new o.Coedge3d(C[r][e],!1);S.addCoedge3d(t)}v.setWires([S]),P.addFace(v)};if(f){const t=e.getWorldPtAt({x:0,y:0,z:-r}),n=new d.Vertex(t);P.addVertex(n),y[0].push(n);const s=new i.Line3d(t,e.getDz(),[0,0]),o=new l.Edge(s,n,n);o.setDegenerateFlag(!0),P.addEdge(o),C[0].push(o)}else S(0,g);if(_){const t=e.getWorldPtAt({x:0,y:0,z:r}),n=new d.Vertex(t);P.addVertex(n),y[1].push(n);const s=new i.Line3d(t,e.getDz(),[0,0]),o=new l.Edge(s,n,n);o.setDegenerateFlag(!0),P.addEdge(o),C[1].push(o)}else S(1,p);const T=new i.Sphere(e,t,n,r),b=new u.Face(T,!0),w=new a.Wire;b.setWires([w]),P.addFace(b);const x=new o.Coedge3d(C[1][0],!1);if(w.addCoedge3d(x),_){const e=new i.Vector2(s[1],h[1]),t=new i.Vector2(s[0],h[1]),n=e.midTo(t),r=new i.Line2d(e,n);x.setPCurve(r);const a=new o.Coedge3d(C[1][0],!0);w.addCoedge3d(a);const c=new i.Line2d(n,t);a.setPCurve(c)}const M=T.getPtAt(new i.Vector2(s[0],0)),N=new i.Coordinate3(e.getOrigin().clone(),M.subtracted(e.getOrigin()),e.getDz()),A=Math.cos(s[0]),O=Math.sin(s[0]),I=Math.sqrt(t*t*A*A+n*n*O*O),D=new i.Arc3d(N,I,r,h),L=new l.Edge(D,y[0][0],y[1][0]);P.addEdge(L);const V=new o.Coedge3d(L,!1);w.addCoedge3d(V);const R=new o.Coedge3d(C[0][0],!0);if(w.addCoedge3d(R),f){const e=new i.Vector2(s[0],h[0]),t=new i.Vector2(s[1],h[0]),n=e.midTo(t),r=new i.Line2d(e,n);R.setPCurve(r);const a=new o.Coedge3d(C[0][0],!1);w.addCoedge3d(a);const c=new i.Line2d(n,t);a.setPCurve(c)}if(m){const e=new o.Coedge3d(L,!0);w.addCoedge3d(e)}else{const c=T.getPtAt(new i.Vector2(s[1],0)),d=new i.Coordinate3(e.getOrigin().clone(),c.subtracted(e.getOrigin()),e.getDz().reversed()),m=Math.cos(s[1]),v=Math.sin(s[1]),E=Math.sqrt(t*t*m*m+n*n*v*v),S=new i.Arc3d(d,E,r,[-h[1],-h[0]]),b=f?y[1][0]:y[1][1],x=_?y[0][0]:y[0][1],M=new l.Edge(S,b,x);P.addEdge(M);const A=new o.Coedge3d(M,!1);w.addCoedge3d(A);const O=new i.Line3d(e.getWorldPtAt({x:0,y:0,z:g}),e.getWorldPtAt({x:0,y:0,z:p})),I=f?y[0][0]:y[0][2],D=_?y[1][0]:y[1][2],V=new l.Edge(O,I,D);P.addEdge(V);const R=new i.Plane(d),U=new u.Face(R,!0),B=new a.Wire;U.setWires([B]);const F=new o.Coedge3d(V,!0);if(B.addCoedge3d(F),!f){const e=new o.Coedge3d(C[1][1],!1);B.addCoedge3d(e)}const k=new o.Coedge3d(M,!0);if(B.addCoedge3d(k),!f){const e=new o.Coedge3d(C[0][1],!0);B.addCoedge3d(e)}P.addFace(U);const G=new i.Plane(N),j=new u.Face(G,!0),z=new a.Wire;j.setWires([z]);const W=new o.Coedge3d(V,!1);if(z.addCoedge3d(W),!f){const e=new o.Coedge3d(C[0][2],!0);z.addCoedge3d(e)}const q=new o.Coedge3d(L,!0);if(z.addCoedge3d(q),!f){const e=new o.Coedge3d(C[1][2],!1);z.addCoedge3d(e)}P.addFace(j)}return P}static makeTorus(e,t,n,r,s){const o=new i.Arc2d(i.Coordinate2.XOY(),r,s,!0,[0,i.CONST.PI2]),a=new i.Arc3d(e,t,n,[0,i.CONST.PI2]);return h.SweepBody2.makeByLoops2d([a],[[o]]).execute()}}r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,Number,Number,Number,Number,Array]),s("design:returntype",void 0)],g,"makeCone",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,Number,Number,Number,Array,Array]),s("design:returntype",void 0)],g,"makeSphere",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Coordinate3,Number,Number,Number,Number]),s("design:returntype",c.BrepBody)],g,"makeTorus",null),t.BasicBodyBuilder=g},77354:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtrudeBody=void 0;const r=n(98106),s=n(40775),i=n(52928),o=n(70750),a=n(11953),c=n(28465),l=n(37632);t.ExtrudeBody=class{static execute(e,t,n,s,i,c=!0,d=!1,u){let h=t;d||(h=this._decomposeSmoothPoly(t)),r.MathAssert.assert(n.isSameDirection(e.getDz()),"构造拉伸体：限定拉伸方向和coordinate z轴方向必须同向 \n\n"),r.MathAssert.assert((()=>h.isValid()),`构造拉伸体：输入polygon 不合法\n\n${h}`),r.MathAssert.assert(i>s+r.Tolerance.NUMBER_EPS,"构造拉伸体：endHeight必须大于startHeight \n\n");for(const e of h.getLoops()){const t=e.getAllCurves();for(let e=0;e<t.length;e++)t[e].getEndPt().equals(t[(e+1)%t.length].getStartPt(),r.Tolerance.LENGTH_EPS)||r.MathAssert.assert(!1,`构造拉伸体：Polygon本身误差过大,请处理${h}`)}let g=[h];c&&(g=r.MathAlg.SearchGraph.polygonToPolygonExes(h));const f=new a.BrepBody;for(let t=0;t<=g.length-1;t++){const a=g[t],c={topVertexs:[],bottomVertexs:[],topEdges:[],sideEdges:[],bottomEdges:[],topFace:new o.Face(r.Plane.XOY(),!0),sideFaces:[],bottomFace:new o.Face(r.Plane.XOY(),!0)},l=this.extrudePolygonEx(e,a,n,s,i,c);l.getEdges().forEach((e=>{f.addEdge(e)})),l.getFaces().forEach((e=>{f.addFace(e)})),l.getVertexs().forEach((e=>{f.addVertex(e)})),u&&u.push(c)}return l.BodyUtil.mergeCoincideVertexAndEdges(f),f}static extrudePolygonEx(e,t,n,l,d,u){const h=new a.BrepBody,g=new r.Plane(e),f=n.clone().normalize(),p=g.clone().translate(f.multiplied(l)),_=g.clone().translate(f.multiplied(d)),m=t.getLoops().slice(),v=m.findIndex((e=>e.isAnticlockwise()));if(v>0){const e=m[v];m.splice(v,1),m.unshift(e)}const E=new o.Face(p,!1);h.addFace(E),u.bottomFace=E;const P=new o.Face(_,!0);h.addFace(P),u.topFace=P;const y=new Map;for(const t of m){const n=new i.Wire;P.addWire(n);const a=new i.Wire;E.addWire(a);const g=[],m=[],v=t.getAllCurves();for(let e=0;e<v.length;e++){const t=v[e].getStartPt(),n=(e+v.length-1)%v.length,r=c.SmoothUtil.isSameSmoothPoly(v[e],v[n]),s=h.createVertex(p.getPtAt(t));r&&s.setSmooth(!0),m.push(s);const i=h.createVertex(_.getPtAt(t));r&&i.setSmooth(!0),g.push(i)}u.topVertexs.push(g),u.bottomVertexs.push(m);const C=[],S=[],T=[],b=[];for(let t=0;t<v.length;t++){const c=v[t],u=g[t],_=g[(t+1)%g.length],E=m[t],P=m[(t+1)%m.length];let w;if(c.isArc2d()&&c.isEqualAB()){const e=c,t=p.getPtAt(e.getCenter()),n=e.isCCW()?f:f.clone().reverse(),s=r.Arc3d.makeArcByStartEndPoints(t,e.getRadius(),n,E.getPoint(),P.getPoint(),!0);e.getRange().getLength()<1e-6&&s.setRange(s.getRange().min,s.getRange().min+e.getRange().getLength()),w=s}else if(c.isArc2d()){const e=c,t=p.getPtAt(e.getCenter()),n=r.Arc3d.makeEllipseByFivePoints(t,p.getPtAt(e.getPtAt(0)),p.getPtAt(e.getPtAt(.5*Math.PI)),p.getPtAt(e.getStartPt()),p.getPtAt(e.getEndPt()));n&&e.getRange().getLength()<1e-6&&n.setRange(n.getRange().min,n.getRange().min+e.getRange().getLength()),w=n}else if(c.isLine2d())w=new r.Line3d(E.getPoint(),P.getPoint());else if(c.isNurbsCurve2d())w=r.NurbsCurve3d.makeByControlPoints(c.getControlPoints().map((e=>p.getPtAt(e))),c.getDegree(),c.getKnots(),c.getWeights()),w.setRange(c.getRange());else{const e=c.discrete();w=r.NurbsCurve3d.makeByInterpolationPoints(e.map((e=>p.getPtAt(e))))}const x=h.createEdge(w,E,P);S.push(x);const M=w.clone().translate(f.multiplied(d-l)),N=h.createEdge(M,u,_);C.push(N),n.addCoedge3d(new s.Coedge3d(N,!0)),a.addCoedge3d(new s.Coedge3d(x,!0));let A=y.get(E.tag+u.tag);A||(A=h.createLineEdge(E,u),E.getSmooth()&&A.setSmooth(!0),y.set(E.tag+u.tag,A)),T.push(A);let O=y.get(P.tag+_.tag);O||(O=h.createLineEdge(P,_),P.getSmooth()&&O.setSmooth(!0),y.set(P.tag+_.tag,O));const I=new i.Wire([new s.Coedge3d(x,!0),new s.Coedge3d(O,!0),new s.Coedge3d(N,!1),new s.Coedge3d(A,!1)]);let D;if(c.isArc2d()){const e=r.Cylinder.makeCylinderByArc3d(w);c.isCCW()?D=new o.Face(e,!0,[I]):(I.reverse(),D=new o.Face(e,!1,[I]))}else if(c.isLine2d()){const e=new r.Plane(E.getPoint(),new r.Vector3(E.getPoint(),P.getPoint()),new r.Vector3(E.getPoint(),u.getPoint()));D=new o.Face(e,!0,[I])}else{const t=new r.Line3d(e.getOrigin(),e.getWorldPtAt(new r.Vector3(0,0,100)));D=new o.Face(new r.SweepSurface(t,c,!0,e.getDy()),!0,[I])}h.addFace(D),b.push(D)}u.topEdges.push(C),u.bottomEdges.push(S),u.sideEdges.push(T),u.sideFaces.push(b)}return h}static _decomposeSmoothPoly(e){const t=new r.Polygon;return e.getLoops().forEach((e=>{const n=c.SmoothUtil.decomposeSmoothPoly(e.getAllCurves());t.addLoop(new r.Loop(n),!1)})),t}}},65767:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoftingShell=void 0;const r=n(98106),s=n(3319),i=n(45813);class o{constructor(e,t,n=!0){this._body=new s.BrepBody,this._iLoops=e,t&&(this._surfaces=t),this._reorderCurves=n}static orderCurves(e,t){const n=(e,t)=>{const n=[];for(const s of e){const e=r.MathAlg.Project.curve3dToPlane(s,t);e&&n.push(e)}r.MathAlg.LoopArea.areaOfLoop(n)>0||(n.forEach((e=>e.reverse())),n.reverse(),e.forEach((e=>e.reverse())),e.reverse());const s=r.MathAlg.LoopCentroid.centroidOfLoop(n),i=t.getPtAt(s),o=r.Matrix3.makeTranslate(s.reversed());return n.forEach((e=>e.transform(o))),{curve3ds:e.slice(),curve2ds:n,plane:t.translate(i.subtracted(t.getOrigin()))}},s=(e,t,n)=>{const s=t.curve2ds[0].getStartPt(),i=e.curve3ds[0];if(1===e.curve3ds.length&&i instanceof r.Arc3d&&i.isEqualAB()){const t=e.plane.getPtAt(s).subtracted(i.getCenter()).normalize(),n=i.getCenter().added(t.multiplied(i.getRadius())),o=r.Arc3d.makeArcByStartEndPoints(i.getCenter(),i.getRadius(),i.getNormal(),n,n,!0);e.curve3ds=[o],e.curve2ds=[r.MathAlg.Project.curve3dToPlane(o,e.plane)]}let o=0,a=r.CONST.MAX_INTEGER;e.curve2ds.forEach(((e,t)=>{const n=e.getStartPt().sqDistanceTo(s);a>n&&(o=t,a=n)}));let c=[];const l=[];for(let t=0;t<e.curve3ds.length;++t)c.push(e.curve3ds[(t+o)%e.curve3ds.length]),l.push(e.curve2ds[(t+o)%e.curve2ds.length]);if(e.curve3ds=c,e.curve2ds=l,n===e.curve3ds.length)return;c=[];const d=t.curve3ds.map((e=>e.getLength()));let u=0;d.forEach(((e,t)=>{d[t]=e+u,u=d[t]}));const h=d.map((e=>e/u));h.unshift(0);const g=e.curve3ds.map((e=>e.getLength()));let f=0;g.forEach(((e,t)=>{g[t]=e+f,f=g[t]}));const p=g.map((e=>e/f));p.unshift(0);let _=0;for(let t=0;t<e.curve3ds.length;t++){const n=p[t+1];let s=_+1;a=r.CONST.MAX_INTEGER;for(let e=_+1;e<=h.length-(p.length-t-1);e++)Math.abs(n-h[e])<a&&(a=Math.abs(n-h[e]),s=e);const i=h.slice(_,s+1),o=i[i.length-1]-i[0],l=[],d=e.curve3ds[t];for(let e=1;e<i.length-1;e++){const t=d.getStartParam()+d.getRange().getLength()*((i[e]-i[0])/o);l.push(t)}let u=d.split(l);u.length||(u=[d]),c.push(...u),_=s}e.curve3ds=c,e.curve2ds=c.map((t=>r.MathAlg.Project.curve3dToPlane(t,e.plane)))},i=(e,t)=>{let n=e.getNorm();t.getNorm().dot(n)<0&&(n=n.reversed());const s=n.cross(t.getCoord().getDx()).normalize(),i=s.cross(n);return new r.Plane(e.getOrigin(),i,s)};let o=0,a=0;for(let t=0;t<e.length;++t)e[t].length>a&&(o=t,a=e[0].length);const c=e[o].length,l=[n(e[o],t[o])],d=l[0];let u=d;for(let r=o+1;r<e.length;r++){const o=i(t[r],u.plane),a=n(e[r],o);s(a,u,c),l.push(a),u=a}u=d;for(let r=o-1;r>=0;r--){const o=i(t[r],u.plane),a=n(e[r],o);s(a,u,c),l.unshift(a),u=a}return{loops:l.map((e=>e.curve3ds)),planes:l.map((e=>e.plane))}}execute(e){return e===i.LoftType.CURVESLOFT?this.curvesExecute():this.facesExecute()}facesExecute(){this._checkData(this._iLoops);let e=this._iLoops,t=this._surfaces;if(this._reorderCurves){const n=o.orderCurves(e,t);e=n.loops,t=n.planes}const n=t[1].getOrigin().subtracted(t[0].getOrigin()).dot(t[0].getNorm())>0,r=[];for(let t=0;t<e[0].length;++t){const n=[];for(let r=0;r<e.length;++r)n.push(e[r][t]);r.push(n)}const s=this._buildPlaneFace(e[0],t[0],!n),i=this._buildPlaneFace(e[e.length-1],t[t.length-1],n);return this._buildSideFace(r,s.vertices,s.edges,i.vertices,i.edges,n),this._body}curvesExecute(){const e=this._iLoops.map((e=>e[0]));if(!e||e.length<2)return this._body;const t=this._body.createVertex(e[0].getStartPt());let n;n=e[0].getStartPt().equals(e[0].getEndPt())?t:this._body.createVertex(e[0].getEndPt());const i=this._body.createVertex(e[e.length-1].getEndPt());let o;o=e[e.length-1].getStartPt().equals(e[e.length-1].getEndPt())?i:this._body.createVertex(e[e.length-1].getStartPt());const a=r.NurbsCurve3d.makeByInterpolationPoints(e.map((e=>e.getStartPt()))),c=r.NurbsCurve3d.makeByInterpolationPoints(e.map((e=>e.getEndPt()))),l=this._body.createEdge(e[0],t,n),d=this._body.createEdge(c,n,i),u=this._body.createEdge(e[e.length-1],o,i);let h;h=a.equals(c)?d:this._body.createEdge(a,t,o);const g=[new s.Coedge3d(l,!0),new s.Coedge3d(d,!0),new s.Coedge3d(u,!1),new s.Coedge3d(h,!1)],f=r.NurbsSurface.byLoftingCurves(e);return this._body.createFace(f,!0,[new s.Wire(g)]),this._body}_buildPlaneFace(e,t,n){const r=[];e.forEach((e=>{const t=this._body.createVertex(e.getStartPt());r.push(t)}));const i=[];e.forEach(((e,t)=>{const n=this._body.createEdge(e,r[t],r[(t+1)%r.length]);i.push(n)}));const o=i.map((e=>new s.Coedge3d(e,!0)));return this._body.createFace(t,n,[new s.Wire(o)]),{vertices:r,edges:i}}_buildSideFace(e,t,n,i,o,a){const c=[];for(let n=0;n<e.length;++n){const s=e[n],o=r.NurbsCurve3d.makeByInterpolationPoints(s.map((e=>e.getStartPt()))),a=this._body.createEdge(o,t[n],i[n]);c.push(a)}for(let t=0;t<e.length;++t){const i=e[t],l=r.NurbsSurface.byLoftingCurves(i),d=[new s.Coedge3d(n[t],!0),new s.Coedge3d(c[(t+1)%c.length],!0),new s.Coedge3d(o[t],!1),new s.Coedge3d(c[t],!1)];this._body.createFace(l,a,[new s.Wire(d)])}}_checkData(e){this._iLoops.length<2&&r.MathError.assert(!1,"曲线不满足放样数量");for(const t of e)for(let e=0;e<t.length;e++)r.MathError.assert(t[e].getEndPt().equals(t[(e+1)%t.length].getStartPt()),"面放样存在不封闭面，放样失败");r.MathError.assert(this._surfaces&&e.length===this._surfaces.length,"面放样缺少面数据，放样失败");for(const e of this._surfaces)r.MathError.assert(e.isPlane(),"面放样存在暂不支持的曲面类型，放样失败")}}t.LoftingShell=o},3025:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RevolveBody=void 0;const r=n(98106),s=n(11953),i=n(40775),o=n(52928),a=n(45813);t.RevolveBody=class{constructor(e,t,n=0,i=2*Math.PI,o,a=r.Tolerance.DEFAULT){this._baseCoord=e,this._startAngle=n,this._endAngle=i,this._loop2dCoord=o,this._baseLoop=[],this._baseLoop3d=[],this._startIndex=0,this._startFlag=!0,t[0][0]instanceof r.Curve2d?this._baseLoop=t:this._baseLoop3d=t,this._body=new s.BrepBody,this._isFullPath=r.MathUtil.isNearlyEqual(i-n,2*Math.PI),this._edgeTol=new r.Tolerance(a.edgeLengthEps,a.edgeLengthEps,.1*a.edgeLengthEps,a.edgeLengthEps)}execute(){if(this._baseLoop.length<1&&this._baseLoop3d.length<1)return this._body;this._initValid();const e=this._preProcessLoop();this._initPath(e[0]);const t=this._initLoop(e);if(this._isFullPath)return this._buildFullRevolveBody(t);const n=this._buildBodySideSweepFace(t);return this._buildBodySidePlaneFace(n.startSideEdges,n.endSideEdges),this._body}_preProcessLoop(){const e=new r.Line3d(this._baseCoord.getOrigin(),this._baseCoord.getDz(),[0,0]);if(this._revolveLine=e.toInfiniteLine(),this._baseLoop.length>0){const e=new r.Plane(this._loop2dCoord);this._baseLoop3d=this._baseLoop.map((t=>t.map((t=>e.getCurve3d(t)))))}const t=this._filterProfile(this._baseLoop3d[0].map((e=>e.clone())),this._revolveLine),n=t.outer;this._isLoopClosed=n[0].getStartPt().equals(n[n.length-1].getEndPt()),t.inner.push(n),this._isLoopClosed||(t.inner=t.inner.map(((e,t)=>{let n=e;for(;n.length>0&&n[0]instanceof r.Line3d;){if(!n[0].isPerpendicularTo(this._revolveLine))break;n.shift()}for(;n.length>0&&n[n.length-1]instanceof r.Line3d;){if(!n[n.length-1].isPerpendicularTo(this._revolveLine))break;n.pop()}0===t&&r.MathError.assert(n.length>0,"不存在合理的回转线段");return n[n.length-1].getEndPt().subtracted(n[0].getStartPt()).dot(this._baseCoord.getDz())>0&&(n.reverse(),n.forEach((e=>e.reverse()))),1===n.length&&0===t&&this._revolveLine.containsPoint(n[0].getStartPt())&&this._revolveLine.containsPoint(n[0].getEndPt())&&(n=n[0].split([n[0].getRange().getMid()])),n})));const s=[];this._sortInnerHole(n,t.inner).forEach((e=>s.push(e)));for(let e=1;e<this._baseLoop3d.length;++e)s.push(this._baseLoop3d[e].map((e=>e.clone())));return s}_sortInnerHole(e,t){const n=t.filter((e=>e.length>0)),r=[],s=this._revolveLine.getClosestPoint(e[0].getStartPt());return n.forEach((e=>{const t=this._revolveLine.getClosestPoint(e[0].getStartPt()),n=s.sqDistanceTo(t);r.push({curve:e,dis:n})})),r.sort(((e,t)=>e.dis-t.dis)),r.map((e=>e.curve))}_initPath(e){var t;let n=new r.Vector3,s=new r.Vector3,i=0;for(let r=0;r<e.length;++r){if(s=this._baseLoop.length>0?null===(t=this._loop2dCoord)||void 0===t?void 0:t.getOrigin():e[r].getStartPt(),n=this._revolveLine.getClosestPoint(s),i=n.distanceTo(s),!this._edgeTol.isLengthZero(i)){this._startIndex=r;break}if(s=e[r].getEndPt(),n=this._revolveLine.getClosestPoint(s),i=n.distanceTo(s),!this._edgeTol.isLengthZero(i)){this._startFlag=!1,this._startIndex=r;break}}r.MathError.assert(!this._edgeTol.isLengthZero(i),a.RevolveErrorCode.AllCurveInRevolveLine,r.MathErrorType.Input);const o=r.Arc3d.makeArcByStartEndPoints(n,i,this._baseCoord.getDz(),s,s,!0);o.setRange(this._startAngle,this._endAngle),this._path=o;const c=n.subtract(s),l=o.getTangentAt(0);this._revolveCoord=new r.Coordinate3(e[0].getStartPt(),c,l.cross(c))}_initLoop(e){const t=new r.Plane(this._revolveCoord);let n=e.map((e=>e.map((e=>r.MathAlg.CalculateProject.curve3dToPlane(e,t)))));return n.filter((e=>void 0===e)),n.forEach((e=>e.filter((e=>void 0===e)))),r.MathError.assert(n.length>0,a.RevolveErrorCode.PathProjectError,r.MathErrorType.Algorithm),n=n.map((e=>r.CurveUtil.simplifyCurves2d(e,{smoothPolyToLines:!0,splitOffsetCurve:!0}).curves)),n}_initValid(){0}_buildBodySideSweepFace(e){const t=[],n=[];for(const s of e){const a=s===e[0],c=new r.Plane(this._revolveCoord),l=s.map((e=>c.getCurve3d(e))),d=l.map((e=>e.clone().rotate(this._startAngle,this._baseCoord.getOrigin(),this._baseCoord.getDz()))),u=l.map((e=>e.clone().rotate(this._endAngle,this._baseCoord.getOrigin(),this._baseCoord.getDz()))),h=this._buildVertexs(d),g=this._buildVertexs(u);if(r.MathError.assert(h.length===g.length,"顶点数据计算错误"),g[0].getPoint().equals(h[0].getPoint())){const e=g.shift();this._body.deleteVertex(e),g.unshift(h[0])}if(g[g.length-1].getPoint().equals(h[h.length-1].getPoint())){const e=g.pop();this._body.deleteVertex(e),g.push(h[h.length-1])}const f=this._buildFrameEdge(h,d),p=this._buildFrameEdge(g,u),_=this._buildSweepEdge(h,g),m=this._buildSweepFace(s,a);a||m.forEach((e=>e.setSameDirWithSurface(!e.getSameDirWithSurface())));for(let e=0;e<s.length;e++){const t=new i.Coedge3d(f[e],!0),n=new i.Coedge3d(_[(e+1)%_.length],!0);r.MathUtil.isNearlyZero(n.getCurve().getLength())&&m[e].getSurface().isSweepSurface()&&n.setPCurve(this._getPCurve(_[e].getCurve(),d[e],!1));const s=new i.Coedge3d(p[e],!1),a=new i.Coedge3d(_[e],!1);r.MathUtil.isNearlyZero(a.getCurve().getLength())&&m[e].getSurface().isSweepSurface()&&a.setPCurve(this._getPCurve(_[(e+1)%_.length].getCurve(),u[e],!0));let c=[t,n,s,a];m[e].getSurface().isPlane()&&(c=c.filter((e=>!r.MathUtil.isNearlyZero(e.getCurve().getLength())))),m[e].addWire(new o.Wire(c))}if(!s[0].getStartPt().equals(s[s.length-1].getEndPt())){const e=h[0].getPoint(),t=this._revolveLine.getClosestPoint(e);let n,s,c;if(t.distanceTo(e)>this._edgeTol.numberEps){const l=this._baseCoord.clone();l.setOrigin(t);const d=new r.Plane(l);n=this._body.createVertex(t),s=this._body.createEdge(new r.Line3d(t,e),n,h[0]),c=this._body.createEdge(new r.Line3d(t,g[0].getPoint()),n,g[0]),f.unshift(s),p.unshift(c);const u=new o.Wire([new i.Coedge3d(s,!0),new i.Coedge3d(_[0],!0),new i.Coedge3d(c,!1)]);this._body.createFace(d,!!a,[u])}const l=h.length-1,d=h[l].getPoint(),u=this._revolveLine.getClosestPoint(d);let m,v,E;if(u.distanceTo(d)>this._edgeTol.numberEps){const e=this._baseCoord.clone();e.setOrigin(u),e.reverseZDir();const t=new r.Plane(e);m=this._body.createVertex(u),v=this._body.createEdge(new r.Line3d(d,u),h[l],m),E=this._body.createEdge(new r.Line3d(g[l].getPoint(),u),g[l],m),f.push(v),p.push(E);const n=new o.Wire([new i.Coedge3d(E,!1),new i.Coedge3d(_[_.length-1],!1),new i.Coedge3d(v,!0)]);this._body.createFace(t,!!a,[n])}}t.push(f),n.push(p)}return{startSideEdges:t,endSideEdges:n}}_buildBodySidePlaneFace(e,t){r.MathError.assert(e.length===t.length,"计算错误");const n=this._revolveCoord.clone(),s=this._revolveCoord.clone(),a=n.getDx(),c=new r.Vector3(0,0,0);a.rotate(this._baseCoord.getOrigin(),this._baseCoord.getDz(),this._startAngle),a.subtract(c.rotated(this._baseCoord.getOrigin(),this._baseCoord.getDz(),this._startAngle)),n.setXYDirs(a,n.getDy()),n.setOrigin(this._baseCoord.getOrigin()),n.reverseZDir();const l=new r.Plane(n),d=s.getDx();d.rotate(this._baseCoord.getOrigin(),this._baseCoord.getDz(),this._endAngle),d.subtract(c.rotated(this._baseCoord.getOrigin(),this._baseCoord.getDz(),this._endAngle)),s.setXYDirs(d,s.getDy()),s.setOrigin(this._baseCoord.getOrigin());const u=new r.Plane(s);if(this._isLoopClosed){const n=[];e.forEach((e=>{const t=[];e.forEach((e=>t.push(new i.Coedge3d(e,!0)))),n.push(new o.Wire(t))})),this._body.createFace(l,!0,n);const r=[];return t.forEach((e=>{const t=[];for(let n=e.length-1;n>=0;--n)t.push(new i.Coedge3d(e[n],!1));r.push(new o.Wire(t))})),void this._body.createFace(u,!0,r)}if(r.MathUtil.isNearlyEqual(this._endAngle-this._startAngle,Math.PI)){const n=[];e.forEach(((e,r)=>{const s=0===r;let a=[];if(!this._isEdgeLoopClosed(e)&&s){t[r].forEach((e=>a.push(new i.Coedge3d(e,!0))));for(let t=e.length-1;t>=0;--t)a.push(new i.Coedge3d(e[t],!1))}else if(this._isEdgeLoopClosed(e)){e.forEach((e=>a.push(new i.Coedge3d(e,!0)))),n.push(new o.Wire(a)),a=[];for(let e=t[r].length-1;e>=0;--e)a.push(new i.Coedge3d(t[r][e],!1))}else{e.forEach((e=>a.push(new i.Coedge3d(e,!0))));for(let e=t[r].length-1;e>=0;--e)a.push(new i.Coedge3d(t[r][e],!1))}n.push(new o.Wire(a))})),this._body.createFace(l,!0,n)}else{const n=[],s=[];for(let r=1;r<e.length;++r)this._isEdgeLoopClosed(e[r])||(n.push({start:e[r],end:t[r]}),s.push(e[r]));s.push(e[0]);const a=[];let c=e[0][0].getStartVertex();for(let e=0;e<s.length;++e){const t=e===s.length-1?s[e][s[e].length-1].getEndVertex():s[e][0].getStartVertex(),n=this._body.createEdge(new r.Line3d(c.getPoint(),t.getPoint()),c,t);c=s[e][s[e].length-1].getEndVertex(),a.push(n)}const d=[],h=[];for(let t=e[0].length-1;t>=0;--t)h.push(new i.Coedge3d(e[0][t],!1));r.MathError.assert(a.length===n.length+1,"旋转剖面不符合要求"),h.push(new i.Coedge3d(a[0],!0));for(let e=0;e<n.length;++e)n[e].start.forEach((e=>h.push(new i.Coedge3d(e,!0)))),h.push(new i.Coedge3d(a[e+1],!0));d.push(new o.Wire(h));for(const t of e)if(this._isEdgeLoopClosed(t)){const e=[];t.forEach((t=>e.push(new i.Coedge3d(t,!0)))),d.push(new o.Wire(e))}this._body.createFace(l,!0,d);const g=[],f=[];t[0].forEach((e=>f.push(new i.Coedge3d(e,!0))));for(let e=n.length-1;e>=0;--e){f.push(new i.Coedge3d(a[e+1],!1));for(let t=n[e].end.length-1;t>=0;--t)f.push(new i.Coedge3d(n[e].end[t],!1))}f.push(new i.Coedge3d(a[0],!1)),g.push(new o.Wire(f));for(const e of t)if(this._isEdgeLoopClosed(e)){const t=[];e.reverse(),e.forEach((e=>t.push(new i.Coedge3d(e,!1)))),g.push(new o.Wire(t))}this._body.createFace(u,!0,g)}}_isEdgeLoopClosed(e){return r.MathError.assert(void 0!==e,"算法流程错误"),e[0].getStartVertex().getPoint().equals(e[e.length-1].getEndVertex().getPoint())}_buildFullRevolveBody(e){const t=e[0],n=new r.Plane(this._revolveCoord),s=t.map((e=>n.getCurve3d(e))),a=this._buildVertexs(s),c=this._buildFrameEdge(a,s),l=this._buildRevolveEdge(a,t),d=this._buildSweepFace(t,!0);for(let e=0;e<t.length;e++){const t=new i.Coedge3d(c[e],!0),n=new i.Coedge3d(l[(e+1)%l.length],!0);r.MathUtil.isNearlyZero(n.getCurve().getLength())&&d[e].getSurface().isSweepSurface()&&n.setPCurve(this._getPCurve(l[e].getCurve(),s[e],!1));const a=new i.Coedge3d(c[e],!1),u=new i.Coedge3d(l[e],!1);r.MathUtil.isNearlyZero(u.getCurve().getLength())&&d[e].getSurface().isSweepSurface()&&u.setPCurve(this._getPCurve(l[(e+1)%l.length].getCurve(),s[e],!0));let h=[t,n,a,u];d[e].getSurface().isPlane()&&(h=h.filter((e=>!r.MathUtil.isNearlyZero(e.getCurve().getLength())))),d[e].addWire(new o.Wire(h))}if(!this._isLoopClosed){const e=a[0].getPoint(),t=this._revolveLine.getClosestPoint(e);if(t.distanceTo(e)>this._edgeTol.numberEps){const e=this._baseCoord.clone();e.setOrigin(t);const n=new r.Plane(e),s=new o.Wire([new i.Coedge3d(l[0],!0)]);this._body.createFace(n,!0,[s])}const n=a[a.length-1].getPoint(),s=this._revolveLine.getClosestPoint(n);if(s.distanceTo(n)>this._edgeTol.numberEps){const e=this._baseCoord.clone();e.setOrigin(s),e.reverseZDir();const t=new r.Plane(e),n=new o.Wire([new i.Coedge3d(l[l.length-1],!1)]);this._body.createFace(t,!0,[n])}}return this._body}_buildVertexs(e){const t=[],n=e.length;for(let r=0;r<n;++r){const n=e[r].getStartPt(),s=this._body.createVertex(n),i=`V${r}`;s.userData={debugTag:i},t.push(s)}if(e.length>0&&!e[0].getStartPt().equals(e[e.length-1].getEndPt())){const r=e[n-1].getEndPt(),s=this._body.createVertex(r),i="V"+(n-1);s.userData={debugTag:i},t.push(s)}return t}_buildFrameEdge(e,t){const n=[],r=t.length,s=e.length;for(let i=0;i<r;i++){const r=this._body.createEdge(t[i],e[i],e[(i+1)%s]),o=`EF${i}`;r.userData={debugTag:o},n.push(r)}return n}_buildSweepEdge(e,t){const n=e.length,s=[];for(let i=0;i<n;i++){const n=e[i].getPoint(),o=r.OffsetCurve3d.makeByTargetPoint(this._path,n),a=this._body.createEdge(o,e[i],t[i]),c=`ES${i}`;a.userData={debugTag:c},s.push(a)}return s}_buildRevolveEdge(e,t){const n=e.length,s=[];for(let t=0;t<n;t++){const n=r.OffsetCurve3d.makeByTargetPoint(this._path,e[t].getPoint()),i=this._body.createEdge(n,e[t],e[t]),o=`ES${t}`;i.userData={debugTag:o},s.push(i)}return s}_buildSweepFace(e,t){const n=e.length,s=[];if(t){const t=e[0].getStartPt().subtracted(this._startFlag?e[this._startIndex].getStartPt():e[this._startIndex].getEndPt());e.forEach((e=>e.translate(t)))}else{const t=this._revolveCoord.getLocalPtAt(this._path.getStartPt()).reverse();e.forEach((e=>e.translate(t)))}for(let t=0;t<n;t++){const n=r.SweepSurface.make(this._path,e[t],this._revolveCoord.getDy(),!0),i=this._body.createFace(n.surface,n.isSameDirection,[]),o=`F${t}`;i.userData={debugTag:o},s.push(i)}return s}_filterProfile(e,t){const n=e.filter((e=>!(e instanceof r.Line3d&&e.isColinearWith(t)))),s=[];if(n.length===e.length)return{outer:n,inner:s};const i=[];let o=[];if(n.length>0){o.push(n[0]);let e=n[0];for(n.shift(),n.length<1&&i.push(o);n.length>0;)e.getEndPt().equals(n[0].getStartPt())?o.push(n[0]):(i.push(o),o=[n[0]]),e=n[0],n.shift(),n.length<1&&i.push(o)}if(i.length>1){const e=i[0],t=i[i.length-1];if(t[t.length-1].getEndPt().equals(e[0].getStartPt())){const n=t.concat(e);i.shift(),i.pop(),i.push(n)}}let a=[],c=0;return i.forEach((e=>{const t=e[0].getStartPt().sqDistanceTo(e[e.length-1].getEndPt());t>c&&(a=e,c=t)})),i.forEach((e=>{e!==a&&s.push(e)})),{outer:a,inner:s}}_getPCurve(e,t,n){const s=e.getRange();let i;const o=t.getRange();return o.min>o.max&&([o.min,o.max]=[o.max,o.min]),i=n?new r.Line2d({x:o.min,y:s.max},{x:o.min,y:s.min}):new r.Line2d({x:o.max,y:s.min},{x:o.max,y:s.max}),i}}},38096:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SweepBody=void 0;const r=n(98106),s=n(40775),i=n(70750),o=n(52928),a=n(11953),c=n(28465);t.SweepBody=class{constructor(e,t,n,r=!0,s=!1,i){this.coordinate=e,this.polygon2d=t,this.path3d=n,this.adjustProfile=r,this.adjustPath=s,this.topoTrack=i,this._pathClosed=!0,this._profile2ds=[],this._profileReverse=!1}execute(){const e=new a.BrepBody;let t;this._init();try{const e=this._calcSweepCurves();t=this._trimSweepCurves(e)}catch(t){return e}return this._buildSweepBody(t,e),e}_init(){this.polygon2d.getLoops().length&&this.path3d.length&&(this._decomposeSmoothPoly(),this._pathClosed=!0,this.path3d[this.path3d.length-1].getEndPt().equals(this.path3d[0].getStartPt(),r.Tolerance.LENGTH_EPS)||(this._pathClosed=!1),r.MathAssert.assert((()=>this._pathIsValid()),`构造扫略体：输入路径中曲线类型不支持\n\n${this.path3d}`),r.MathAssert.assert((()=>this._profileIsValid()),`构造扫略体：输入轮廓中曲线类型不支持\n\n${this.polygon2d}`),this._adjustPath(),this._adjustProfile())}_decomposeSmoothPoly(){this.path3d=c.SmoothUtil.decomposeSmoothPoly(this.path3d),this.polygon2d.getLoops().forEach((e=>{const t=c.SmoothUtil.decomposeSmoothPoly(e.getAllCurves());this._profile2ds.push(t)}))}_pathIsValid(){return this.path3d.every((e=>e.isArc3d()||e.isLine3d()))}_profileIsValid(){for(const e of this._profile2ds)for(const t of e)if(!t.isLine2d())return!1;return!0}_adjustPath(){if(!this.adjustPath)return;const e=this.coordinate.getWorldPtAt(this.polygon2d.getCentroidPoint()),t=this.path3d.map(((t,n)=>({d:r.MathAlg.CalculateDistance.pointToCurve3d(e,t),i:n})));t.sort(((e,t)=>e.d-t.d));const n=[t.shift()];let s;for(;;){const e=t.shift();if(!e)break;if(!this.path3d[n[n.length-1].i].getStartTangent().isParallel(this.path3d[e.i].getStartTangent())){s=e;break}n.push(e)}if(!s)return;const i=n[0],o=s;let a=this.path3d[i.i].getStartTangent().cross(this.coordinate.getDz()).getLength()<this.path3d[o.i].getStartTangent().cross(this.coordinate.getDz()).getLength()?i.i:o.i;if(this._pathClosed)for(;a;)this.path3d.push(this.path3d.shift()),a--;else{this.coordinate.translate(new r.Vector3(this.path3d[a].getStartPt(),this.path3d[0].getStartPt()));const e=this.path3d[a].getStartTangent(),t=this.path3d[0].getStartTangent();if(e.isSameDirection(t))return;let n;if(e.isParallel(t)){const t=new r.Vector3(this.path3d[a].getStartPt(),this.path3d[0].getStartPt()).normalize();n=e.cross(t)}else n=e.cross(t);const s=r.Matrix4.makeRotate(this.path3d[0].getStartPt(),n,e.angleTo(t,n));this.coordinate.transform(s)}}_adjustProfile(){const e=this.path3d[0],t=e.getProjectedPtBy(this.coordinate.getOrigin()),n=e.getTangentAt(e.getParamAt(t)),s=n.dot(this.coordinate.getDz())>=0;if(!n.isParallel(this.coordinate.getDz())){if(!this.adjustProfile)throw new Error("扫略：轮廓曲线不合法");const e=r.Plane.makePlaneByPointNormal(t,n),s=e.getProjectedPtBy(this.coordinate.getOrigin()),i=e.getProjectedPtBy(this.coordinate.getOrigin().add(this.coordinate.getDx())).subtracted(s).normalize(),o=new r.Coordinate3(s,i,n.cross(i)),a=new r.Plane(o);for(const e of this._profile2ds){const t=e.map((e=>{const t=e,n=a.getUVAt(this.coordinate.getWorldPtAt(t.getStartPt())),s=a.getUVAt(this.coordinate.getWorldPtAt(t.getEndPt())),i=new r.Line2d(n,s);return c.SmoothUtil.copySmoothInfo(t,i),i}));e.splice(0,e.length),e.push(...t)}this.coordinate=o}r.MathAlg.LoopArea.areaOfLoop(this._profile2ds[0])>=0!==s&&(this._profileReverse=!0,this._profile2ds=this._profile2ds.map((e=>(e.forEach((e=>e.reverse())),e.reverse()))))}_calcSweepCurves(){const e=[];let t=this.coordinate.clone();for(let n=0;n<this.path3d.length;n++){const s=new r.Plane(t),i=this._profile2ds.map((e=>e.map((e=>s.getCurve3d(e))))),o=this.path3d[n],a=o.getProjectedPtBy(s.getOrigin()),c=o instanceof r.Arc3d?new r.Plane(o.getCenter(),o.getNormal()):void 0,l=[];for(let e=0;e<i.length;e++){const t=i[e],n=[];for(let e=0;e<t.length;e++){const s=t[e].getStartPt();if(o instanceof r.Arc3d){const e=c.getProjectedPtBy(s);if(r.MathUtil.isNearlySmallerOrEqual(e.subtracted(o.getCenter()).dot(o.getStartPt().subtract(o.getCenter())),0))throw new Error("扫略：轮廓曲线计算失败");const t=e.distanceTo(o.getCenter()),i=o.getCenter().add(o.getEndPt().subtract(o.getCenter()).normalize().multiply(t)),a=r.Arc3d.makeArcByStartEndPoints(o.getCenter(),t,o.getNormal(),e,i,!0);a.translate(s.subtracted(e)),n.push(a)}else{const e=s.subtracted(a);n.push(o.clone().translate(e))}}l.push(n)}if(e.push(l),n<this.path3d.length-1){const e=this.path3d[n+1];let s=new r.Matrix4;s=o instanceof r.Arc3d?r.Matrix4.makeRotate(o.getCenter(),o.getNormal(),(o.getRange().max-o.getParamAt(a))/o.getRadius()):r.Matrix4.makeTranslate(o.getEndPt().subtracted(a)),t=t.transform(s);const i=o.getTangentAt(o.getRange().max),c=e.getTangentAt(e.getRange().min),l=i.cross(c);if(!l.isZero()){l.normalize();const n=i.angleTo(c,l);s=r.Matrix4.makeRotate(e.getStartPt(),l,n),t=t.transform(s)}}}return e}_trimSweepCurves(e){const t=e.map(((e,t)=>e.map((e=>e.map((e=>({path:this.path3d[t],originCurve:e,extendCurve:this._extendCurve(e)})))))));for(let e=1;e<t.length;e++)for(let n=0;n<t[e].length;n++)for(let r=0;r<t[e][n].length;r++){const s=t[e-1][n][r],i=t[e][n][r];this._calculateTrimedPoint(s,i)}if(this._pathClosed&&this.path3d.length>1)for(let e=0;e<t[0].length;e++)for(let n=0;n<t[0][e].length;n++){const r=t[t.length-1][e][n],s=t[0][e][n];this._calculateTrimedPoint(r,s)}else for(let e=0;e<t[0].length;e++)for(let n=0;n<t[0][e].length;n++){const r=t[t.length-1][e][n],s=t[0][e][n];r.trimedEPt=r.originCurve.getEndPt(),s.trimedSPt=s.originCurve.getStartPt()}for(let e=0;e<t.length;e++)for(let n=0;n<t[e].length;n++)for(let r=0;r<t[e][n].length;r++)this._calculateTrimedCurve(t[e][n][r]);return t.map((e=>e.map((e=>e.map((e=>e.trimedCurve))))))}_calculateTrimedPoint(e,t){if(e.originCurve.getEndPt().equals(t.originCurve.getStartPt()))return e.trimedEPt=e.originCurve.getEndPt(),void(t.trimedSPt=t.originCurve.getStartPt());const n=r.MathAlg.CalculateIntersect.curve3ds(e.extendCurve,t.extendCurve);if(!n.length)throw new Error("扫略：裁剪点计算失败");if(1===n.length&&(e.trimedEPt=n[0].point,t.trimedSPt=n[0].point),n.length>1)if(e.originCurve.isLine3d()&&t.originCurve.isArc3d()||e.originCurve.isArc3d()&&t.originCurve.isLine3d()){const r=e.path.getEndPt();n.sort(((e,t)=>e.point.distanceTo(r)-t.point.distanceTo(r)));const s=n[0].point;e.trimedEPt=s,t.trimedSPt=s}else{if(!e.originCurve.isArc3d()||!t.originCurve.isArc3d())throw new Error("扫略：选择裁剪点失败");{const s=e.path.getEndPt();n.sort(((e,t)=>e.point.distanceTo(s)-t.point.distanceTo(s)));let i=n[0].point;if(r.MathUtil.isNearlyEqual(n[0].point.distanceTo(s),n[1].point.distanceTo(s))){const t=e.path.getMidPt();n[0].point.distanceTo(t)>n[1].point.distanceTo(t)&&(i=n[1].point)}e.trimedEPt=i,t.trimedSPt=i}}}_calculateTrimedCurve(e){if(e.originCurve.getParamAt(e.trimedSPt)>e.originCurve.getParamAt(e.trimedEPt))throw new Error("扫略：裁剪点无效");if(e.originCurve.isLine3d())e.trimedCurve=new r.Line3d(e.trimedSPt,e.trimedEPt);else{if(!e.originCurve.isArc3d())throw new Error("不支持的曲线类型");{const t=e.extendCurve,n=r.Arc3d.makeArcByCircleAndPts(t,e.trimedSPt,e.trimedEPt,!0);e.trimedCurve=n}}}_buildSweepBody(e,t){const n=new Map,a=new Map,l=[];for(let t=0;t<e.length;t++){let e;e=!(!this._pathClosed&&0===t)&&c.SmoothUtil.isSameSmoothPoly(this.path3d[t],this.path3d[(t+this.path3d.length-1)%this.path3d.length]),l.push(e)}const d=[];for(let t=0;t<e[0].length;t++){const n=[];for(let r=0;r<e[0][t].length;r++){const s=c.SmoothUtil.isSameSmoothPoly(this._profile2ds[t][r],this._profile2ds[t][(r+e[0][t].length-1)%e[0][t].length]);n.push(s)}d.push(n)}for(let r=0;r<e.length;r++){let s=0;for(let i=0;i<e[r].length;i++)for(let o=0;o<e[r][i].length;o++){const a=e[r][i][o],c=t.createVertex(a.getStartPt());n.set(`${r}-${s++}`,c),(l[r]||d[i][o])&&c.setSmooth(!0)}if(r===e.length-1&&!this._pathClosed){s=0;for(let i=0;i<e[r].length;i++)for(let o=0;o<e[r][i].length;o++){const a=e[r][i][o],c=t.createVertex(a.getEndPt());n.set(`${r+1}-${s++}`,c),d[i][o]&&c.setSmooth(!0)}}}for(let r=0;r<e.length;r++){let s=0;for(let i=0;i<e[r].length;i++){const o=e[r][i].length;for(let e=0;e<o;e++){const i=`${r}-${e+s}`,c=`${r}-${(e+1)%o+s}`,d=t.createLineEdge(n.get(i),n.get(c));a.set(`${i}>${c}`,d),l[r]&&d.setSmooth(!0)}s+=o}if(r===e.length-1&&!this._pathClosed){s=0;for(let i=0;i<e[r].length;i++){const o=e[r][i].length;for(let e=0;e<o;e++){const i=`${r+1}-${e+s}`,c=`${r+1}-${(e+1)%o+s}`,l=t.createLineEdge(n.get(i),n.get(c));a.set(`${i}>${c}`,l)}s+=o}}}const u=this._pathClosed?this.path3d.length:this.path3d.length+1;for(let r=0;r<e.length;r++){let s=0;for(let i=0;i<e[r].length;i++){for(let o=0;o<e[r][i].length;o++){const c=`${r}-${o+s}`,l=`${(r+1)%u}-${o+s}`,h=t.createEdge(e[r][i][o],n.get(c),n.get(l));a.set(`${c}>${l}`,h),d[i][o]&&h.setSmooth(!0)}s+=e[r][i].length}}let h;if(this.topoTrack){h=[];for(let t=0;t<e[0][0].length;t++){const e=[];null==h||h.push(e)}}for(let n=0;n<e.length;n++){const c=(n+1)%u;let l=0;for(let d=0;d<e[n].length;d++){const u=e[n][d].length;for(let g=0;g<e[n][d].length;g++){const f=(g+1)%u,p=`${n}-${g+l}`,_=`${n}-${f+l}`,m=`${c}-${g+l}`,v=`${c}-${f+l}`,E=[new s.Coedge3d(a.get(`${p}>${_}`),!0),new s.Coedge3d(a.get(`${_}>${v}`),!0),new s.Coedge3d(a.get(`${m}>${v}`),!1),new s.Coedge3d(a.get(`${p}>${m}`),!1)],P=e[n][d][g],y=e[n][d][f];let C,S=!0;if(this.path3d[n]instanceof r.Arc3d){const e=P,t=y,n=t.getCenter().subtracted(e.getCenter());if(n.isZero()){const e=y.getStartPt().subtracted(P.getStartPt()).normalize().cross(P.getStartTangent()).normalize();C=new r.Plane(P.getStartPt(),e)}else r.MathUtil.isNearlyEqual(e.getRadius(),t.getRadius())?(C=r.Cylinder.makeCylinderByArc3d(e),n.dot(e.getNormal())>0&&(S=!1)):(C=r.Cone.makeConeByArc3ds(e,t),n.dot(e.getNormal())>0&&(S=!1))}else{const e=new r.Vector3(P.getStartPt(),y.getStartPt()).normalize(),t=y.toVector3().normalized(),n=e.cross(t).normalize().cross(t);C=new r.Plane(y.getStartPt(),t,n)}const T=new o.Wire(E);S||T.reverse();const b=new i.Face(C,S,[T]);null==h||h[g].push(b),t.addFace(b)}l+=u}}if(this.topoTrack){const e=this.polygon2d.getAllCurves();e.forEach(((t,n)=>{var r;const s=this._profileReverse?e.length-n-1:n;null===(r=this.topoTrack)||void 0===r||r.set(e[s],h[n])}))}if(!this._pathClosed){{const n=0;let c=0;const l=[];for(let t=0;t<e[n].length;t++){const r=e[n][t].length,i=[];for(let e=0;e<r;e++)i.push(new s.Coedge3d(a.get(`${n}-${e+c}>${n}-${(e+1)%r+c}`),!0));l.push(new o.Wire(i)),c+=r}const d=l[0].getCoedge3ds()[0].getStartVertex().getPoint(),u=new r.Plane(d,this.coordinate.getDx(),this.coordinate.getDy()),h=new i.Face(u,!1,l);t.addFace(h),this.topoTrack&&this.topoTrack.set(1,[h])}{const n=e.length;let c=0;const l=[];for(let t=0;t<e[n-1].length;t++){const r=e[n-1][t].length,i=[];for(let e=0;e<r;e++)i.push(new s.Coedge3d(a.get(`${n}-${e+c}>${n}-${(e+1)%r+c}`),!0));l.push(new o.Wire(i)),c+=r}const d=e[e.length-1][0].map((e=>e.getEndPt())),u=this._getPointsCCWNormal(d),h=l[0].getCoedge3ds()[0].getStartVertex().getPoint(),g=new r.Plane(h,u),f=new i.Face(g,!0,l);t.addFace(f),this.topoTrack&&this.topoTrack.set(0,[f])}}}_extendCurve(e){if(e instanceof r.Line3d)return new r.Line3d(e.getOrigin(),e.getDirection(),[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]);if(e instanceof r.Arc3d)return e.getCircle();throw new Error("不支持的曲线类型")}_getPointsCCWNormal(e){const t=this._getNormalOfPtSequence(e);if(!t)return;const n=new r.Plane(e[0],t),s=e.map((e=>n.getUVAt(e)));return new r.Loop(s).isAnticlockwise()?t:t.reverse()}_getNormalOfPtSequence(e){let t;for(let n=0,r=e.length;n<r;n++){const s=e[n];for(let i=n+1;i<r+n;i++){const o=e[i%r];for(let a=i+1;a<r+n;a++){const n=e[a%r];if(t=this._getNormalOfThreePoints(s,o,n),t)break}if(t)break}if(t)break}return t}_getNormalOfThreePoints(e,t,n){const s=t.subtracted(e),i=n.subtracted(e),o=n.subtracted(t);if(r.MathUtil.isNearlyZero(s.getLength())||r.MathUtil.isNearlyZero(i.getLength())||r.MathUtil.isNearlyZero(o.getLength()))return;const a=s.cross(i);return a.isZero()?void 0:a.normalize()}}},58501:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SweepBody2=void 0;const r=n(98106),s=n(11953),i=n(52928),o=n(40775),a=n(45813),c=n(29537);class l{constructor(e,t,n,s=r.Tolerance.DEFAULT){this.paths=e,this.baseCoord=n,this.tol=s,this.baseLoops=[],this.baseLoop3ds=[],t[0][0]instanceof r.Curve2d?this.baseLoops=t:this.baseLoop3ds=t,this.edgeTol=new r.Tolerance(s.edgeLengthEps,s.edgeLengthEps,.1*s.edgeLengthEps,s.edgeLengthEps)}static makeByLoops3d(e,t,n=r.Tolerance.DEFAULT){return new l(e,t,void 0,n)}static makeByLoops2d(e,t,n,s=r.Tolerance.DEFAULT){return new l(e,t,n,s)}static _getStartCoord(e){const t=e[0],n=t.getStartPt(),s=t.getStartTangent(),i=r.CurveUtil.getDzByCurves(e),o=e=>{const t=e.cross(s);e.dot(i)<0&&t.reverse();const o=s.cross(t);return new r.Coordinate3(n,t,o)};if(!t.isLineLike())return o(r.CurveUtil.getDzByCurve(t));const a=e=>{const t=s.cross(e);t.dot(i)<0&&t.reverse();const o=t.cross(s);return new r.Coordinate3(n,o,t)},c=e[e.length-1];if(c.getEndPt().equals(t.getStartPt())){if(!c.isLineLike())return o(r.CurveUtil.getDzByCurve(c));const e=c.getEndTangent();if(!e.isParallel(s))return a(e)}const l=e[1%e.length];{if(!(l instanceof r.Line3d))return o(r.CurveUtil.getDzByCurve(l));const e=l.getStartTangent();if(!e.isParallel(s))return a(e)}return o(i)}static _refineBaseCoord(e,t,n,s){const{minCurves1:i}=l._findNearestCurves(n,e.getOrigin(),s);let o,a,c=0,d=0,u=n[0].getRange().min;for(const t of i){const r=n[t.pi].getTangentAt(t.t).dot(e.getDz());Math.abs(r)>Math.abs(c)&&(c=r,d=t.pi,u=t.t)}if(c>0)o=e,a=t;else{o=new r.Coordinate3(e.getOrigin(),e.getDx().reverse(),e.getDy());const n=r.Matrix3.makeMirror({x:0,y:0},{x:0,y:1}),s=n.decompose();t.forEach((e=>e.reverse())),t.forEach((e=>e.map((e=>e.reverse())))),a=t.map((e=>e.map((e=>e.transformed(n,s)))))}for(let e=d;e>=0;e--){const t=n[e],r=e===d?u:t.getRange().max,s=t.getTangentAt(r);o=l._rotateCoord(o,s).coord;const i=t.getStartTangent();o=l._rotateCoord(o,i).coord}return o.setOrigin(n[0].getStartPt()),{coord:o,loops:a}}static _rotateCoord(e,t,n=e.getOrigin(),s){const i=e.getDz();if(i.isParallel(t)){if(i.dot(t)>0){const t=e.clone();return t.setOrigin(n),{coord:t,rotateAxis:e.getDy(),rotateAngle:0}}r.MathError.assert(s,a.SweepErrorCode.PathReversedConnection,r.MathErrorType.Input,e,e.getDz(),t)}const o=s||i.cross(t).normalize(),c=i.angleTo(t,o),l={x:0,y:0,z:0},d=e.getDx().rotate(l,o,c),u=e.getDy().rotate(l,o,c);return{coord:new r.Coordinate3(n,d,u),rotateAxis:o,rotateAngle:c}}static _findNearestCurves(e,t,n){let s=r.CONST.MODEL_MAX_LENGTH,i=[],o=r.CONST.MODEL_MAX_LENGTH,a=[];for(let c=0;c<e.length;c++){const l=e[c],d=r.MathAlg.CalculateDistance.pointToCurve3dInfo(t,l),u=d.distance;if(u>o+n)continue;const h={t:d.param,pi:c};u<s-n?(o=s,a=i,s=u,i=[h]):u<s+n?i.push(h):u<o-n?(o=u,a=[h]):a.push(h)}return{minCurves1:i,minCurves2:a}}static _getFrameCurveDirection(e,t,n,r){const s=e.getSurface(),i=t.getSurface(),o=s.getNormAt(s.getUVAt(n)).multiply(e.getSameDirWithSurface()?1:-1),a=i.getNormAt(i.getUVAt(n)).multiply(t.getSameDirWithSurface()?1:-1),c=o.added(a);return r.cross(c)}static _intersectSurfaces(e,t,n,s,i,o){const a=l._getFrameCurveDirection(e,t,s,n),c=r.MathAlg.CalculateIntersect.surfacesNearPoint(e.getSurface(),t.getSurface(),s,a,o,!0);if(!c)return;c.getTangentAt(c.getParamAt(s)).dot(a)<0&&c.reverse();let d=c.getParamAt(s);if(Math.abs(d-c.getRange().max)<r.Tolerance.NUMBER_EPS&&c.getStartPt().equals(c.getEndPt(),o.edgeLengthEps)&&(d=c.getRange().min),i){const e=c.getParamAt(i);if(r.MathUtil.isNearlyBiggerOrEqual(e,d)){c.setRange(d,e);const t=c.getRange();t instanceof r.PeriodInterval&&r.MathUtil.isNearlyEqual(d,e)&&c.setRange(d,d+t.period)}else r.MathError.warn(!1,"wierd frame curve direction"),c.setRange(e,d),c.reverse()}else c.setRangeInfinit(d);return c}static _reduceCurveXResult(e,t){const n=r.CONST.MODEL_MAX_LENGTH,s={point:new r.Vector3(n,n,n),param:n,xCoedges:[]},i=t.edgeLengthEps2;return e.reduce(((e,t)=>e.point.sqDistanceTo(t.xPoint.point)<i?(e.xCoedges.push({coedge:t.coedge,param:t.xPoint.param2}),e):t.xPoint.param1<e.param?{point:t.xPoint.point,param:t.xPoint.param1,xCoedges:[{coedge:t.coedge,param:t.xPoint.param2}]}:e),s)}static _removeGeoms(e,t,n){const r=new Set(n);let s=new Set(e),i=new Set;const o=new Set,a=new Set,c=(e,t)=>{if(!o.has(e)){if(t){const n=e.getAnotherVertex(t);if(r.has(t)&&n)return;n&&!r.has(n)&&i.add(n)}for(const t of e.getCoedge3ds()){const e=t.getWire();if(e&&(e.deleteCoedge3d(t),0===e.getCoedge3ds().length)){const t=e.getParent();t.getShell().deleteFace(t),t.dispose()}}e.getShell().deleteEdge(e),e.dispose(),o.add(e)}};for(;s.size>0;){for(const e of s)if(!a.has(e)){for(const t of e.getEdges())c(t,e);r.has(e)||e.getShell().deleteVertex(e),a.add(e)}s=i,i=new Set}for(const e of t)c(e)}static _removeIsolatedVertices(e){const t=new Set;for(const n of e.getEdges())t.add(n.getStartVertex()),t.add(n.getEndVertex());for(const n of e.getVertexs())t.has(n)||e.deleteVertexByTag(n.tag)}execute(e=a.PreviewType.TryGenerate,t=!1){if(e===a.PreviewType.GenerateOnly)return this.executeGenerate();if(e===a.PreviewType.PreviewOnly)return this.executePreview(t);try{return this.executeGenerate()}catch(e){return this.executePreview(t)}}executeGenerate(){if(this._validateInputs(),this._initPaths(),this._initProfiles(),this._orderPathForRing(),this._initTopo(),this._makeSingleRing())return this.body;if(this._initGeoms(),this.isPathClosed)for(let e=0;e<this.baseLoops.length;e++){const t=this._buildFirstOpenFaces(e);let n=t.faces;for(let t=0;t<this.paths.length-1;t++)n=this._closeOpenFace(e,t,n);this._connectLastLoop(e,n,t.faces,t.coedges)}else for(let e=0;e<this.baseLoops.length;e++){let t=this._buildLoopOnFirstFace(e);for(let n=0;n<this.paths.length-1;n++)t=this._closeOpenFace(e,n,t);this._closeLastLoop(e,t)}return l._removeIsolatedVertices(this.body),this._reverseSweepFaces(),this._splitExtendCurves(),this._setSmoothVerticesAndEdges(),this.body}executePreview(e=!1){if(this._validateInputs(),this._initPaths(),this._initProfiles(),this.pathIndexOffset=0,this._initTopo(),this._makeSingleRing())return this.body;this._initGeoms();for(let e=0;e<this.baseLoops.length;e++){const t=this.baseLoops[e].length,n=this.paths.length,s=this.basePointLoops[e],a=s.length,c=[],d=[],u=[],h=[];for(let t=0;t<n;t++)c.push(this._buildSweepFaces(e,t)),d.push(this._buildSweepEdges(e,t));if(!this.isPathClosed){const t=this.startCoords[0];h.push(this._buildVertices(e,0,t));const n=this.baseLoops[e].map((e=>r.MathAlg.CalculateProject.curve2dTo3d(e,t))),s=this._buildFrameEdges(e,0,h[0],n);u.push(s),this.isProfilesClosed[e]&&this.topo.firstFace.addWire(new i.Wire(s.map((e=>new o.Coedge3d(e,!0)))))}for(let i=this.isPathClosed?0:1;i<n;i++){const o=(i-1+n)%n,g=d[o],f=d[i],p=[],_=this.midCoordInfos[o];for(let t=0;t<a;t++){const n=s[t].transformed(_.mat),o=r.MathAlg.CalculateIntersect.curve3dsNearPoint(g[t].getCurve(),f[t].getCurve(),n,this.tol);r.MathError.warn(o,"No intersect point between curves");const a=o?o.point:n,c=this._createVertex(a,i,e,t);p.push(c)}h.push(p);const m=[],v=this.paths[o].getEndTangent(),E=this.paths[i].getStartTangent(),P=v.isParallel(E,this.tol.angleEps);for(let s=0;s<t;s++){let t;t=P?r.MathAlg.CalculateProject.curve2dTo3d(this.baseLoops[e][s],this.midCoordInfos[o].coord):l._intersectSurfaces(c[(i-1+n)%n][s],c[i][s],this.midCoordInfos[o].coord.getDz(),p[s].getPoint(),p[(s+1)%a].getPoint(),this.tol)||new r.Line3d(p[s].getPoint(),p[(s+1)%a].getPoint());const d=this._createFrameEdge(t,p[s],p[(s+1)%a],i,e,s);m.push(d)}u.push(m)}if(this.isPathClosed)h.push(h[0]),u.push(u[0]);else{const t=this.endCoords[n-1];h.push(this._buildVertices(e,n,t));const s=this.baseLoops[e].map((e=>r.MathAlg.CalculateProject.curve2dTo3d(e,t))),a=this._buildFrameEdges(e,n,h[n],s);u.push(a),this.isProfilesClosed[e]&&this.topo.lastFace.addWire(new i.Wire(a.map((e=>new o.Coedge3d(e,!0)))))}for(let e=0;e<n;e++){for(let t=0;t<a;t++){const n=d[e][t],s=h[e][t],i=h[e+1][t],o=n.getCurve(),a=o.getParamAt(s.getPoint()),c=o.getParamAt(i.getPoint());a<=c||o.getRange()instanceof r.PeriodInterval?o.setRange(a,c):(o.setRange(c,a),o.reverse()),n.setStartVertex(s),n.setEndVertex(i)}for(let n=0;n<t;n++){const t=new o.Coedge3d(u[e][n],!0),s=new o.Coedge3d(d[e][(n+1)%a],!0),l=new o.Coedge3d(u[e+1][n],!1),h=new o.Coedge3d(d[e][n],!1),g=s.getCurve()instanceof r.ExtendCurve3d?s.getEdge().getCurve().getBaseCurve():s.getEdge().getCurve(),f=h.getCurve()instanceof r.ExtendCurve3d?h.getEdge().getCurve().getBaseCurve():h.getEdge().getCurve();if(r.MathUtil.isNearlyZero(g.getLength())&&c[e][n].getSurface().isSweepSurface()){const e=t.getEdge().getCurve().getRange().max,n=new r.Line2d(new r.Vector2(e,f.getRange().min),new r.Vector2(e,f.getRange().max));s.setPCurve(n)}if(r.MathUtil.isNearlyZero(f.getLength())&&c[e][n].getSurface().isSweepSurface()){const e=l.getEdge().getCurve().getRange().min,t=new r.Line2d(new r.Vector2(e,g.getRange().max),new r.Vector2(e,g.getRange().min));h.setPCurve(t)}c[e][n].addWire(new i.Wire([t,s,l,h]))}}}return this._reverseSweepFaces(),this._splitExtendCurves(),this._setSmoothVerticesAndEdges(),e&&this._mergeCoplaneFace(),this.body}getTopoTrack(e,t){const n=[];for(let e=0;e<this.baseLoops.length;e++){const t=this.baseLoops[e],r=this.baseLoopSplitEvos[e],s=[];let i,o=-1,a=0;for(const e of t){const t=r.get(e)[0];t===i?a++:(o++,a=0),s.push({mainIdx:o,subIdx:a}),i=t}n.push(s)}const r=this.paths.length;for(let s=0;s<n.length;s++){const i=e[s],o=n[s];for(let e=o.length-1;e>=0;){const n=o[e],s=i[n.mainIdx],a=new Array(r*(n.subIdx+1)).fill(void 0);t.set(s,a),e-=n.subIdx+1}}for(const s of this.body.getFaces()){const i=l._getFaceInfo(s);if(void 0!==i.isStart)t.set(i.isStart?0:1,[s]);else{const o=n[i.loopIndex][i.edgeIndex];t.get(e[i.loopIndex][o.mainIdx])[i.pathIndex+r*o.subIdx]=s}}return t}_validateInputs(){0}_initPaths(){const e=[];for(let t=1;t<this.paths.length;t++)if(this.paths[t-1].isLine()){const n=new r.Line3d(this.paths[t-1].getStartPt(),this.paths[t].getStartPt());e.push(n)}else e.push(this.paths[t-1].clone());e.push(this.paths[this.paths.length-1].clone()),this.paths=e;{const e=r.MathAlg.CurveCurveMerge.mergeCurves3ds(this.paths),t=r.CurveUtil.simplifyCurves3d(e,{smoothPolyToLines:!0,splitOffsetCurve:!0});this.paths=t.curves,this.pathSplitEvo=t.evolution,this.isPathClosed=this.edgeTol.areNear(this.paths[0].getStartPt(),this.paths[this.paths.length-1].getEndPt())}let t;if(this.baseCoord){const e=l._refineBaseCoord(this.baseCoord,this.baseLoops,this.paths,this.tol.edgeLengthEps);t=e.coord,this.baseLoops=e.loops}else t=l._getStartCoord(this.paths);this.startCoords=[t],this.endCoords=[],this.midCoordInfos=[];for(let e=0;e<this.paths.length;e++){const t=this.paths[e],n=t.getEndTangent(),s=t.getEndPt(),i=l._rotateCoord(this.startCoords[e],n,s,r.CurveUtil.getDzByCurve(t)).coord;if(this.endCoords.push(i),!this.isPathClosed&&e===this.paths.length-1)break;const o=this.paths[(e+1)%this.paths.length].getStartTangent(),a=n.midTo(o).normalize(),{coord:c,rotateAxis:d,rotateAngle:u}=l._rotateCoord(i,a,s),h=d.cross(a),g=Math.abs(1/Math.cos(u)),f=new r.Coordinate3(c.getOrigin(),h,d),p=c.getLocalToWorldMatrix().preMultiply(f.getWorldToLocalMatrix()).applyScale({x:0,y:0,z:0},{x:g,y:1,z:1}).preMultiply(f.getLocalToWorldMatrix()),_={coord:c,mat:p};this.midCoordInfos.push(_);const m=l._rotateCoord(i,o).coord;this.startCoords.push(m)}if(this.isPathClosed){const e=this.startCoords.pop();r.MathError.assert(this.edgeTol.areNear(this.startCoords[0].getDx(),e.getDx()),a.SweepErrorCode.CoordinateZUnparallelWithPath,r.MathErrorType.Input,this.startCoords)}}_initProfiles(){0===this.baseLoops.length&&this._parseBaseLoops3dTo2d();const e=this.baseLoops.map((e=>r.CurveUtil.simplifyCurves2d(e,{smoothPolyToLines:!0,splitOffsetCurve:!0})));this.baseLoops=e.map((e=>e.curves)),this.baseLoopSplitEvos=e.map((e=>e.evolution)),this.isProfilesClosed=this.baseLoops.map((e=>e[0].getStartPt().equals(e[e.length-1].getEndPt())));for(let e=0;e<this.baseLoops.length;e++){const t=this.baseLoops[e];r.MathAlg.LoopArea.areaOfLoop(t)>0!=(0===e)&&(t.forEach((e=>e.reverse())),t.reverse())}this.basePointLoops=this.baseLoops.map((e=>{const t=e.length,n=e[0].getStartPt(),s=e[t-1].getEndPt(),i=n.equals(s),o=[new r.Vector3((i?n.midTo(s):n).toXYZ())];for(let n=1;n<t;n++){const t=e[n-1].getEndPt(),s=e[n].getStartPt();o.push(new r.Vector3(t.midTo(s).toXYZ()))}return i||o.push(new r.Vector3(s.toXYZ())),o})),this.body=new s.BrepBody}_parseBaseLoops3dTo2d(){const{centroid:e,areaNormal:t}=r.MathAlg.LoopCentroid.centroidInfoOfCurve3ds(this.baseLoop3ds[0],r.DiscreteParameter.NORMAL),{minCurves1:n,minCurves2:s}=l._findNearestCurves(this.paths,e,this.tol.lengthEps);let i=n.find((e=>!this.paths[e.pi].getTangentAt(e.t).isPerpendicular(t)));if(i||(i=s.find((e=>!this.paths[e.pi].getTangentAt(e.t).isPerpendicular(t)))),!i){let s;if(n.length>0){s=this.paths[n[0].pi].getPtAt(n[0].t)}else s=e;const i=new r.Plane(s,t);return void(this.baseLoops=this.baseLoop3ds.map((e=>e.map((e=>r.MathAlg.CalculateProject.curve3dToPlane(e,i))).filter((e=>e)))))}const o=this.startCoords[i.pi],a=this.paths[i.pi],c=a.getTangentAt(i.t),d=a.getPtAt(i.t),u=l._rotateCoord(o,c,d).coord,h=new r.Plane(u);this.baseLoops=this.baseLoop3ds.map((e=>e.map((e=>r.MathAlg.CalculateProject.curve3dToPlane(e,h))).filter((e=>e))))}_makeSingleRing(){if(1!==this.paths.length)return!1;const e=this.paths[0];if(e.getStartPt().sqDistanceTo(e.getEndPt())>this.tol.edgeLengthEps2)return!1;for(let t=0;t<this.baseLoops.length;t++){const n=this.baseLoops[t];let s,a,c,l;if(e.getStartTangent().equals(e.getEndTangent(),this.tol.edgeLengthEps)){c=this._buildSweepEdges(t,0),l=this._buildSweepFaces(t,0),s=this._buildVertices(t,0,this.startCoords[0]);const e=new r.Plane(this.startCoords[0]),i=n.map((t=>e.getCurve3d(t)));a=this._buildFrameEdges(t,0,s,i);for(const e of c)e.setCurve(e.getCurve().getBaseCurve())}else{l=this._buildSweepFaces(t,0),c=this._buildSingleSweepEdges(t,0);const i=e.getRange(),o=this.midCoordInfos[0];s=[];const d=[];for(let e=0;e<c.length;e++){const n=c[e].getCurve(),a=r.MathAlg.Intersect.curve3dsNearParams(n,n,i.min,i.max,this.tol);d.push(a);const l=a?a.point:this.basePointLoops[t][e].transformed(o.mat),u=this._createVertex(l,0,t,e);s.push(u)}a=[];const u=r.Coordinate3.XOY();for(let i=0;i<l.length;i++){const c=l[i].getSurface(),d=n[i],h=d.getStartTangent(),g=new r.Vector3(h.x,h.y,0).vecTransformed(o.mat),f=d.getRange().min,p=new r.Vector2(f,e.getRange().min),_=new r.Vector2(f,e.getRange().max),m=s[i],v=s[(i+1)%s.length];let E=r.MathAlg.Intersect.surfacesSelfIntersect(c,p,_,g,this.tol)||r.MathAlg.Project.curve2dTo3d(d,u).transformed(o.mat);E.getStartPt().equals(m.getPoint())&&E.getEndPt().equals(v.getPoint())||m.getPoint().equals(v.getPoint())||(E=new r.Line3d(m.getPoint(),v.getPoint()));const P=this._createFrameEdge(E,m,v,0,t,i);a.push(P)}for(let e=0;e<c.length;e++){const t=d[e];if(t){const n=c[e].getCurve(),[r,s]=t.param1<t.param2?[t.param1,t.param2]:[t.param2,t.param1];n.setRange(r,s)}else{const t=c[e].getCurve(),n=s[e].getPoint(),i=t.getAllFootParams(n,this.tol.lengthEps),o=r.CurveUtil.filterParamsByDistance(i,n,t,this.tol.lengthEps);if(2===o.length)t.setRange(o[0],o[1]);else{r.MathError.warn(!1,"wierd number of vtx params found");const n=t instanceof r.OffsetCurve3d?t.getBaseCurve():t,s=n instanceof r.ExtendCurve3d?n.getBaseCurve():n;c[e].setCurve(s)}}}}for(let e=0;e<c.length;e++)c[e].setStartVertex(s[e]),c[e].setEndVertex(s[e]);for(let e=0;e<n.length;e++){const t=new o.Coedge3d(a[e],!0),s=new o.Coedge3d(c[(e+1)%c.length],!0),d=s.getCurve()instanceof r.ExtendCurve3d?s.getEdge().getCurve().getBaseCurve():s.getEdge().getCurve();r.MathUtil.isNearlyZero(d.getLength())&&s.setPCurve(this._getPCurve(c[e].getCurve(),n[e],!1));const u=new o.Coedge3d(a[e],!1),h=new o.Coedge3d(c[e],!1),g=h.getCurve()instanceof r.ExtendCurve3d?h.getEdge().getCurve().getBaseCurve():h.getEdge().getCurve();r.MathUtil.isNearlyZero(g.getLength())&&h.setPCurve(this._getPCurve(c[(e+1)%c.length].getCurve(),n[e],!0)),l[e].addWire(new i.Wire([t,s,u,h]))}}return this._reverseSweepFaces(),this._splitExtendCurves(),!0}_getPCurve(e,t,n){const s=e.getRange();let i;const o=t.getRange();return o.min>o.max&&([o.min,o.max]=[o.max,o.min]),i=n?new r.Line2d({x:o.min,y:s.max},{x:o.min,y:s.min}):new r.Line2d({x:o.max,y:s.min},{x:o.max,y:s.max}),i}_orderPathForRing(){if(!this.isPathClosed||1===this.paths.length)return void(this.pathIndexOffset=0);const e=[];this.baseLoops.forEach((t=>t.forEach((t=>{e.concat(...t.discrete(r.DiscreteParameter.NORMAL).map((e=>r.Vector3.XY(e,0))))}))));const t=this.paths.length,n=this.paths.map((e=>new r.Line3d(e.getStartPt(),e.getEndPt()))),s=n.map((e=>[[],[]]));for(let r=0;r<t;r++){const i=(r+t-1)%t,o=e.map((e=>e.transformed(this.midCoordInfos[i].mat))),a=n[r],c=n[i];s[r][0]=o.map((e=>a.getParamAt(e))),s[i][0]=o.map((e=>c.getParamAt(e)))}const i=s.map((e=>{let t=r.CONST.MODEL_MAX_LENGTH;for(let n=0;n<e[0].length;n++){const r=e[1][n]-e[0][n];r<t&&(t=r)}return t}));let o=0,a=-r.CONST.MODEL_MAX_LENGTH;for(let e=0;e<i.length;e++){const t=Math.min(i[e],i[(e+i.length-1)%i.length]);t>a&&(a=t,o=e)}const c=o;if(c>0){[this.paths,this.startCoords,this.endCoords,this.midCoordInfos].forEach((e=>{const t=e.slice(0,c-1);e.splice(0,c-1),e.push(...t)})),this.pathIndexOffset=t-c}else this.pathIndexOffset=0}_initTopo(){const e=new Array(this.paths.length+(this.isPathClosed?0:1)).fill(0),t=[];for(let e=0;e<this.baseLoops.length;e++){const n=this.baseLoops[e].length+(this.isProfilesClosed[e]?0:1);t.push(new Array(n).fill(0))}const n=e.map((e=>t.map((e=>e.map((e=>[])))))),r=this.paths.map((e=>t.map((e=>e.map((e=>[])))))),s=e.map((e=>this.baseLoops.map((e=>e.map((e=>[])))))),i=this.paths.map((e=>this.baseLoops.map((e=>[])))),o=l._getSplitCounts(this.paths,this.pathSplitEvo),a=[];for(let e=0;e<this.baseLoops.length;e++){const t=l._getSplitCounts(this.baseLoops[e],this.baseLoopSplitEvos[e]);a.push(t)}this.topo={vertices:n,sweepEdges:r,frameEdges:s,sideFaces:i,pathSplitCounts:o,baseLoopSplitCounts:a}}_initGeoms(){if(this.startSweepEdges=this.baseLoops.map((e=>[])),this.endSweepEdges=this.baseLoops.map((e=>[])),!this.isPathClosed&&this.isProfilesClosed.findIndex((e=>e))>=0){const e=new r.Plane(this.startCoords[0]);this.topo.firstFace=this._createFace(e,!1,[],0,-1,0);const t=new r.Plane(this.endCoords[this.paths.length-1]);this.topo.lastFace=this._createFace(t,!0,[],1,-1,0)}}_buildLoopOnFirstFace(e){const t=this.baseLoops[e],n=this._buildVertices(e,0,this.startCoords[0]),s=t.map((e=>r.MathAlg.CalculateProject.curve2dTo3d(e,this.startCoords[0]))),a=this._buildFrameEdges(e,0,n,s);if(this.isProfilesClosed[e]){const e=new i.Wire(a.map((e=>new o.Coedge3d(e,!0))));this.topo.firstFace.addWire(e)}const c=this._buildSweepEdges(e,0),l=t.length,d=c.length;for(let e=0;e<d;e++){const t=n[e],r=c[e].getCurve(),s=r.getParamAt(t.getPoint());r.setRangeInfinit(s),c[e].setStartVertex(t)}const u=this._buildSweepFaces(e,0);for(let e=0;e<l;e++){const t=new i.Wire([new o.Coedge3d(c[e],!1),new o.Coedge3d(a[e],!0),new o.Coedge3d(c[(e+1)%d],!0)]);u[e].addWire(t)}return d>l&&(this.startSweepEdges[e].push(c[0]),this.endSweepEdges[e].push(c[l])),u}_closeOpenFace(e,t,n){const s=this._buildSweepFaces(e,t+1),i=this._buildSweepEdges(e,t+1),o=s.length,a=i.length,c=[],d=[],u=[];for(let r=0;r<o;r++){const s=n[r].getWires()[0].getCoedge3ds()[0].getEdge(),o=this._connectEdges(s,i[r],t+1,e,r);o&&c.push(o)}const h=(n,s,i)=>{for(let r=n.length-1;r>=0;r--){const o=this._connectEdges(n[r],s,t+1,e,i);if(o){const e=n.splice(r+1,n.length-r,s);return u.push(...e),void c.push(o)}}r.MathError.assert(!1,`side sweep edge error: p${t}-${t+1} l${e} v${i}`)};a>o&&(h(this.startSweepEdges[e],i[0],0),h(this.endSweepEdges[e],i[o],o));const g=i.findIndex((e=>e.getStartVertex()));r.MathError.assert(g>=0,"no clean intersect vtx");for(let r=g;r<o;){if(!i[r].getStartVertex())continue;let l,h=(r+1)%a;for(;!i[h].getStartVertex();)h=(h+1)%a;if(a>o&&0===r){const t=this.startSweepEdges[e];l=t[t.length-2].getCoedge3ds()[0].getFace()}else l=n[r];const f={nextFaceIdx:r,curFace:l,curStCoedge:l.getWires()[0].getCoedge3ds()[0],curVtx:i[r].getStartVertex(),curCoedges:[],nextCoedges:[],barrierVertices:c,delVertices:d,delEdges:u},p=i[h].getStartVertex();do{if(f.curFace.getSurface().isCoplanar(s[f.nextFaceIdx].getSurface(),this.tol)){const n=this._closeOpenCoplanarFace(e,t,h,s,i,f);if(n>=0){r=n;break}}else{const n=this._closeOpenNormalFace(e,t,h,s,i,f);n>=0&&(r=n)}}while(f.curVtx!==p);if(++r===g)break}return l._removeGeoms(d,u,c),s}_closeOpenCoplanarFace(e,t,n,s,i,a){const{nextFaceIdx:c,curFace:l,nextCoedges:d,barrierVertices:u,delVertices:h}=a,g=s[c],f=i[n].getStartVertex(),p=i.length,_=s.length;this.body.deleteFace(g),g.dispose(),s[c]=l;const m=l.getWires()[0];m.insertCoedge3d(0,new o.Coedge3d(i[c],!1),...d.reverse());const v=m.getCoedge3ds(),E=v[v.length-1],P=E.getEdge();if(P.getEndVertex()===f)return m.addCoedge3d(new o.Coedge3d(i[n],!0)),c;const y=i[(c+1)%p];for(let n=v.length-2;n>=0;n--){const s=v[n].getEdge(),i=r.MathAlg.CalculateIntersect.curve3ds(y.getCurve(),s.getCurve(),this.edgeTol).filter((e=>!e.isOverlap));if(0===i.length)continue;r.MathError.warn(1===i.length,"Multiple intersection found",r.MathErrorType.Algorithm,l.tag,s.tag,y.tag),m.deleteCoedge3dAt(n+1,v.length-n-1),m.addCoedge3d(new o.Coedge3d(y,!0));const g=i[0];if(g.point.equals(f.getPoint()))return c;r.MathError.warn((()=>!this.edgeTol.areNear(g.point,s.getStartVertex().getPoint())&&!this.edgeTol.areNear(g.point,s.getEndVertex().getPoint())),"Intersect at knot not supported yet.",r.MathErrorType.Algorithm,l,s,y);const P=this._createVertex(g.point,t+1,e,(c+1)%p);return u.push(P),y.getCurve().setRangeInfinit(g.param1),y.setStartVertex(P),E.getSameDirWithEdge()?(h.push(s.getEndVertex()),s.setEndVertex(P),s.getCurve().getRange().max=g.param2):(h.push(s.getStartVertex()),s.setStartVertex(P),s.getCurve().getRange().min=g.param2),a.nextFaceIdx=(c+1)%_,a.curVtx=P,a.curStCoedge=v[n].getTwins()[0],a.curFace=a.curStCoedge.getFace(),d.splice(0,d.length),-1}a.curVtx=E.getStartVertex(),u.push(a.curVtx);const C=E.getTwin();return a.curStCoedge=C.getNextCoedge(),a.curFace=a.curStCoedge.getFace(),m.deleteCoedge3dAt(v.length-1),C.getWire().deleteCoedge3dAt(0),this.body.deleteEdge(P),P.dispose(),-1}_closeOpenNormalFace(e,t,n,s,a,c){const{curFace:d,nextFaceIdx:u,curVtx:h,curCoedges:g,nextCoedges:f,barrierVertices:p,delVertices:_,delEdges:m}=c,v=s[u],E=a[n].getStartVertex(),P=a.length,y=s.length;let C,S=-1;{const n=this.midCoordInfos[t].coord.getDz(),s=l._intersectSurfaces(d,v,n,h.getPoint(),void 0,this.tol);C=s||r.MathAlg.CalculateProject.curve2dTo3d(this.baseLoops[e][u],this.midCoordInfos[t].coord)}const T=C.getStartPt().equals(C.getEndPt(),this.tol.edgeLengthEps);let b,w;{const e=[],t=[];for(const n of d.getWires()[0].getCoedge3ds()){const s=n.getEdge().getCurve(),i=r.MathAlg.CalculateIntersect.curve3ds(C,s,this.edgeTol);for(const r of i){if(r.isOverlap)continue;const s={xPoint:r,coedge:n};if(r.point.equals(h.getPoint(),this.tol.edgeLengthEps)){const e=n.getEndVertex();e&&r.point.equals(e.getPoint(),this.tol.edgeLengthEps)||t.push(s)}else e.push(s)}}if(T&&0===e.length){for(const e of t)e.xPoint.param1=C.getRange().max;e.push(...t)}r.MathError.assert(e.length>0,"No edge intersect with xCurve on curFace");{const t=a[(u+1)%P],n=r.MathAlg.CalculateIntersect.curve3ds(C,t.getCurve(),this.edgeTol).filter((e=>!e.isOverlap));e.push(...n.map((e=>({xPoint:e,coedge:void 0}))))}b=l._reduceCurveXResult(e,this.edgeTol),r.MathError.assert(b.param<r.CONST.MODEL_MAX_LENGTH,"No interseciton point?",r.MathErrorType.Algorithm,d,v,C,e)}{if(this.edgeTol.areNear(b.point,E.getPoint()))w=E,S=u;else{const n=new Set;b.xCoedges.forEach((e=>{if(e.coedge){const t=e.coedge.getEdge().getEndVertex();t&&this.edgeTol.areNear(b.point,t.getPoint())&&n.add(t)}})),r.MathError.warn(n.size<2,"Too many vertices, not supported yet.",r.MathErrorType.Algorithm,n),w=0===n.size?this._createVertex(b.point,t+1,e,u):n.values().next().value,p.push(w)}const n=this._createFrameEdge(C,h,w,t+1,e,u);C.getRange().max=b.param,g.push(new o.Coedge3d(n,!1)),f.push(new o.Coedge3d(n,!0))}const x=b.xCoedges.filter((e=>e.coedge));if(x.length>0){r.MathError.warn(1===x.length,"Do not suppot multiple edges intersect together",r.MathErrorType.Unimplemented,x);const e=x[0],t=d.getWires()[0];let n=t.getCoedge3ds().length;if(w!==E){const s=e.coedge.getEdge();let i=!1;if(s.getEndVertex()){const o=e.coedge.getEndVertex();if(o===w){const t=e.coedge.getNextCoedge(),n=t.getEndVertex();n?_.push(n):m.push(t.getEdge()),i=!0}else _.push(o);e.coedge.getSameDirWithEdge()?(s.setEndVertex(w),s.getCurve().getRange().max=e.param):(s.setStartVertex(w),s.getCurve().getRange().min=e.param);const a=t.getCoedge3ds(),l=c.curStCoedge,d=a.findIndex((e=>e===l)),u=a.findIndex((t=>t===e.coedge));d<u?(t.deleteCoedge3dAt(u+1,a.length-u-2),t.deleteCoedge3dAt(0,d),n=t.getCoedge3ds().length):u<d?(t.deleteCoedge3dAt(u+1,d-u-1),n=u+1):r.MathError.warn(!1,"trim on same edge not supported yet",r.MathErrorType.Unimplemented,s,w)}else s.setEndVertex(w),s.getCurve().getRange().max=e.param;if(i){const t=[],n=d;w.getEdges().forEach((e=>{let r;for(const t of e.getCoedge3ds()){const e=t.getFace();if(e===n||void 0===e)return;t.getStartVertex()===w&&(r=t)}r&&t.push(r)})),r.MathError.warn(t.length<=1,"Multiple edges intersect at next Vertex",r.MathErrorType.Unimplemented,w),0===t.length?c.curStCoedge=e.coedge.getTwin():c.curStCoedge=t[0]}else c.curStCoedge=e.coedge.getTwin();c.curFace=c.curStCoedge.getFace()}t.insertCoedge3d(n,...g.reverse()),g.length=0}const M=b.xCoedges.filter((e=>!e.coedge));if(M.length>0){if(r.MathError.warn(1===M.length,"wierd number of nextXCoedge found",r.MathErrorType.Algorithm,M),w!==E){const e=a[(u+1)%P];e.setStartVertex(w);const t=e.getCurve().getParamAt(w.getPoint());e.getCurve().setRangeInfinit(t)}if(0===s[u].getWires().length){const e=new i.Wire([new o.Coedge3d(a[u],!1),...f,new o.Coedge3d(a[(u+1)%P],!0)]);s[u].addWire(e)}else{const e=s[u].getWires()[0];e.insertCoedge3d(e.getCoedge3ds().length,...f,new o.Coedge3d(a[(u+1)%P],!0))}f.length=0,c.nextFaceIdx=(u+1)%y}return c.curVtx=w,S}_closeLastLoop(e,t){const n=this.baseLoops[e],s=n.length,a=this.endCoords[this.endCoords.length-1],c=this._buildVertices(e,this.paths.length,a),l=(e,t)=>{const n=e.getCurve(),s=t.getPoint(),i=n.getParamAt(s),o=n.getPtAt(i);r.MathError.warn((()=>this.edgeTol.areNear(s,o)),"Weird interseciton point between sweep curve and last plane",r.MathErrorType.Algorithm,e.tag,t.tag),e.setEndVertex(t),n.getRange().max=i};for(let e=0;e<s;e++)l(t[e].getWires()[0].getCoedge3ds()[0].getEdge(),c[e]);if(!this.isProfilesClosed[e]){const e=t[s-1].getWires()[0].getCoedge3ds();l(e[e.length-1].getEdge(),c[s])}const d=n.map((e=>r.MathAlg.CalculateProject.curve2dTo3d(e,this.endCoords[this.paths.length-1]))),u=this._buildFrameEdges(e,this.paths.length,c,d);if(this.isProfilesClosed[e]){const e=new i.Wire(u.map((e=>new o.Coedge3d(e,!0))));this.topo.lastFace.addWire(e)}for(let e=0;e<s;e++)t[e].getWires()[0].addCoedge3d(new o.Coedge3d(u[e],!1))}_buildFirstOpenFaces(e){const t=this._buildSweepFaces(e,0),n=this._buildSweepEdges(e,0),r=t.length,s=n.length,a=[];for(let e=0;e<r;e++){const r=new o.Coedge3d(n[e],!1),c=new o.Coedge3d(n[(e+1)%s],!0),l=new i.Wire([r,c]);t[e].addWire(l),a.push(r)}return s>r&&(this.startSweepEdges[e].push(n[0]),this.endSweepEdges[e].push(n[r])),{faces:t,coedges:a}}_connectLastLoop(e,t,n,s){const a=t.length,c=this.basePointLoops[e].length,d=[],u=this.midCoordInfos[this.midCoordInfos.length-1];for(let n=0;n<a;n++){const r=t[n].getWires()[0].getCoedge3ds()[0].getEdge(),i=s[n].getEdge(),o=this._connectEdges(r,i,0,e,n);d.push(o)}if(!this.isProfilesClosed[e]){const t=this.endSweepEdges[e];d.push(this._connectEdges(t[t.length-1],t[0],0,e,a))}const h=u.coord.getDz();for(let g=0;g<a;g++){const a=t[g].getWires()[0],f=n[g].getWires()[0],p=f.getCoedge3ds().findIndex((e=>e===s[g]));if(r.MathError.assert(p>=0,"init coedge not found",r.MathErrorType.Algorithm,n[g],s[g]),t[g].getSurface().isCoplanar(n[g].getSurface(),this.tol))if(t[g]===n[g]){const e=new i.Wire(f.getCoedge3ds().slice(p+1)),n=new i.Wire(f.getCoedge3ds().slice(0,p+1)),s=t[g].getSurface();if(s instanceof r.Plane){const i=e.getCoedge3ds().map((e=>e.getCurve())),o=n.getCoedge3ds().map((e=>e.getCurve())),a=s.getNorm(),c=r.MathAlg.LoopArea.areaVectorOfCurve3ds(i).dot(a),l=r.MathAlg.LoopArea.areaVectorOfCurve3ds(o).dot(a);c>0&&l<=0?t[g].setWires([e,n]):(c<=0&&l>0||r.MathError.warn(!1,"Wierd wire direction",r.MathErrorType.Algorithm,t[g],i,o,c,l),t[g].setWires([n,e]))}else r.MathError.assert(!1,"Surface type do not support coplanar",r.MathErrorType.Algorithm,t[g])}else a.insertCoedge3d(a.getCoedge3ds().length,...f.getCoedge3ds().slice(p+1)),a.insertCoedge3d(a.getCoedge3ds().length,...f.getCoedge3ds().slice(0,p+1)),n[g].dispose(),this.body.deleteFace(n[g]);else{const s=l._intersectSurfaces(t[g],n[g],h,d[g].getPoint(),d[(g+1)%c].getPoint(),this.tol)||r.MathAlg.CalculateProject.curve2dTo3d(this.baseLoops[e][g],u.coord),i=this._createFrameEdge(s,d[g],d[(g+1)%c],0,e,g);a.addCoedge3d(new o.Coedge3d(i,!1)),f.insertCoedge3d(p+1,new o.Coedge3d(i,!0))}}}_buildVertices(e,t,n){const r=this.basePointLoops[e],s=[];for(let i=0;i<r.length;i++){const o=n.getWorldPtAt(r[i]),a=this._createVertex(o,t,e,i);s.push(a)}return s}_buildFrameEdges(e,t,n,r){const s=[],i=r.length,o=n.length;for(let a=0;a<i;a++){const i=this._createFrameEdge(r[a],n[a],n[(a+1)%o],t,e,a);s.push(i)}return s}_buildSweepEdges(e,t){const n=this.basePointLoops[e],s=this.paths[t],i=[];for(let o=0;o<n.length;o++){const c=r.OffsetCurve3d.makeByTargetPoint(s,this.startCoords[t].getWorldPtAt(n[o])),l=r.ExtendCurve3d.makeByCurve(c,!1),d=this._createSweepEdge(l,void 0,void 0,t,e,o);r.MathError.assert(l.getStartTangent().isParallel(c.getStartTangent())&&l.getEndTangent().isParallel(c.getEndTangent()),a.SweepErrorCode.SurfaceDegenerate,r.MathErrorType.Input,d.userData.debugTag),i.push(d)}return i}_buildSingleSweepEdges(e,t){const n=this.basePointLoops[e],s=this.baseLoops[e],i=this.paths[t],o=this.startCoords[t],a=o.getDy(),c=r.CurveUtil.getDzByCurve(i,a),l=c.angleTo(a,o.getDz()),d=[];for(const e of s){const t=r.SweepSurface.make(i,e.clone().rotate(l),c,!1);d.push(t.surface)}const u=[];for(let s=0;s<n.length;s++){let i=d[s].getIsoCurve(this.baseLoops[0][s].getStartParam(),!1);if(!d[s].isSweepSurface()){const e=0===s?n.length-1:s-1;i=d[e].getIsoCurve(this.baseLoops[0][e].getEndParam(),!1)}const o=r.ExtendCurve3d.makeByCurve(i,!1),a=this._createSweepEdge(o,void 0,void 0,t,e,s);u.push(a)}return u}_buildSweepFaces(e,t){const n=this.baseLoops[e],s=this.paths[t],i=[],o=this.startCoords[t],a=o.getDy(),c=r.CurveUtil.getDzByCurve(s,a),l=c.angleTo(a,o.getDz());for(let o=0;o<n.length;o++){const a=n[o].clone().rotate(l),d=r.SweepSurface.make(s,a,c,!0),u=this._createFace(d.surface,d.isSameDirection,[],t,e,o);i.push(u)}return i}_connectEdges(e,t,n,s,i){const o=this.paths.length,a=this.midCoordInfos[(n-1+o)%o],c=this.basePointLoops[s][i].transformed(a.mat),l=e.getCurve(),d=t.getCurve();let u,h;if(r.MathAlg.CurveCurveColinear.curve3ds(l,d,this.tol)){u={param1:l.getParamAt(c),param2:d.getParamAt(c),point:c,isOverlap:!1}}else u=r.MathAlg.CalculateIntersect.curve3dsNearPoint(l,d,c,this.tol);if(!u)return;if(e.getStartVertex()&&e.getStartVertex().getPoint().equals(u.point))return;const g=e.getEndVertex();return h=g&&g.getPoint().equals(u.point)?g:this._createVertex(u.point,n,s,i),e.setEndVertex(h),t.setStartVertex(h),e.getCurve().getRange().max=u.param1,t.getCurve().getRange().min=u.param2,h}_reverseSweepFaces(){this.body.getFaces().forEach((e=>{if(!e.getSameDirWithSurface()&&e!==this.topo.firstFace)for(const t of e.getWires())t.reverse()}))}_splitExtendCurves(){for(const e of this.body.getEdges()){const t=e.getCurve();if(t instanceof r.ExtendCurve3d){const n=t.toSimpleCurves(),s=e.getStartVertex(),i=e.getEndVertex(),a=l._getVertexInfo(s),c=[s];for(let e=1;e<n.length;e++){const t=this._createVertex(n[e].getStartPt(),a.pathIndex,a.loopIndex,a.vertexIndex);c.push(t)}c.push(i);const d=l._getEdgeInfo(e),u=[];for(let t=0;t<n.length;t++){let s;n[t]instanceof r.Line3d?s=this._createExtendEdge(n[t],c[t],c[t+1],d,0===t):(s=e,s.setCurve(n[t]),s.setStartVertex(c[t]),s.setEndVertex(c[t+1])),u.push(s)}const h=e.getCoedge3ds();e.deleteAllCoedge3ds();for(const e of h){const t=e.getWire(),n=e.getSameDirWithEdge(),r=u.map((t=>{const r=new o.Coedge3d(t,n);return r.setPCurve(e.getPCurve()),r}));n||r.reverse();const s=t.getCoedge3ds().indexOf(e);t.replaceCoedge3d(s,r)}}}}_setSmoothVerticesAndEdges(){const e=l._getSmoothInidces(this.paths,this.pathSplitEvo),t=new Set(e),n=new Set;for(let e=0;e<this.baseLoops.length;e++){const t=l._getSmoothInidces(this.baseLoops[e],this.baseLoopSplitEvos[e]);for(const r of t)n.add({loopIndex:e,edgeIndex:r})}for(const e of t)for(const t of this.topo.vertices[e])for(const e of t)for(const t of e)t.setSmooth(!0);for(const e of this.topo.vertices)for(const t of n)for(const n of e[t.loopIndex][t.edgeIndex])n.setSmooth(!0);for(const e of t)for(const t of this.topo.frameEdges[e])for(const e of t)for(const t of e)t.setSmooth(!0);for(const e of this.topo.sweepEdges)for(const t of n)for(const n of e[t.loopIndex][t.edgeIndex])n.setSmooth(!0)}_mergeCoplaneFace(){const e=this.topo.sideFaces;if(0===e.length)return;const t=[];for(let n=0;n<e.length;++n){let r=0;for(let s=0;s<e[n].length;++s){for(let i=0;i<e[n][s].length;++i){let o=[];0===n?(o=[],t.push(o)):o=t[r+i],o.push(e[n][s][i])}r+=e[n][s].length}}for(const e of t){if(e.length<2)continue;if(!e[0].getSurface().isPlane())continue;let t=!0;const n=e[0].getSurface();for(let r=1;r<e.length;++r)t=n.isCoplanar(e[r].getSurface());if(!t)continue;const r=c.mergeConnectedFace(e);r&&(r.userData=e[0].userData)}}static _getSplitCounts(e,t){const n=new Array(e.length).fill(1);let r=-1;for(const s of e){const e=t.get(s),i=e?e[0]:void 0;i&&undefined===i?n[r]++:r++}return n}static _getSmoothInidces(e,t){let n;const s=[];for(let i=0;i<e.length;i++){const o=e[i],a=t.get(o),c=a?a[0]:void 0;(c instanceof r.SmoothPoly3d||c instanceof r.SmoothPoly2d)&&(c===n?s.push(i):n=c)}return s}_getLoopTag(e){return this.baseLoops.length>1?`L${e}`:""}_createVertex(e,t,n,r){const s=this._getPathTagIdx(t),i=this.topo.vertices[s][n][r],o=this.body.createVertex(e),a=i.length;i.push(o);const c=`P${s}${this._getLoopTag(n)}V${r}s${a}`;return o.userData={debugTag:c},o}_createSweepEdge(e,t,n,r,s,i){const o=this._getPathTagIdx(r),a=this.topo.sweepEdges[o][s][i],c=this.body.createEdge(e,t,n),l=a.length;a.push(c);const d=`P${o}${this._getLoopTag(s)}S${i}s${l}`;return c.userData={debugTag:d},c}_createFrameEdge(e,t,n,r,s,i){const o=this._getPathTagIdx(r),a=this.topo.frameEdges[o][s][i],c=this.body.createEdge(e,t,n),l=a.length;a.push(c);const d=`P${o}${this._getLoopTag(s)}F${i}s${l}`;return c.userData={debugTag:d},c}_createExtendEdge(e,t,n,r,s){const i=(r.isSweepEdge?this.topo.sweepEdges:this.topo.frameEdges)[r.pathIndex][r.loopIndex][r.edgeIndex],o=this.body.createEdge(e,t,n),a=i.findIndex((e=>e===o));i.splice(a+(s?0:1),0,o);const c=r.isSweepEdge?"S":"F",l=s?"st":"ed",d=this._getLoopTag(r.loopIndex),u=`P${r.pathIndex}${d}${c}${r.edgeIndex}s${r.subIndex}${l}`;return o.userData={debugTag:u},o}_createFace(e,t,n,r,s,i){const o=this._getPathTagIdx(r),a=this.body.createFace(e,t,n);let c;return s<0?0===r?(c="First",this.topo.firstFace=a):(c="Last",this.topo.lastFace=a):(this.topo.sideFaces[o][s][i]=a,c=`P${o}${this._getLoopTag(s)}E${i}`),a.userData={debugTag:c},a}_getPathTagIdx(e){return this.isPathClosed?(e+this.pathIndexOffset)%this.paths.length:e}static _getVertexInfo(e){const t=e.userData.debugTag,[,n,r,s,i]=/P(\d+)(L\d+)?V(\d+)s(\d+)/.exec(t);return{pathIndex:Number(n),loopIndex:r?Number(r.substr(1)):0,vertexIndex:Number(s),subIndex:Number(i)}}static _getEdgeInfo(e){const t=e.userData.debugTag,[,n,r,s,i,o]=/P(\d+)(L\d+)?([FS])(\d+)s(\d+)/.exec(t),a="S"===s;return{pathIndex:Number(n),loopIndex:r?Number(r.substr(1)):0,edgeIndex:Number(i),subIndex:Number(o),isSweepEdge:a}}static _getFaceInfo(e){const t=e.userData.debugTag;if("First"===t)return{isStart:!0,pathIndex:-1,loopIndex:-1,edgeIndex:-1};if("Last"===t)return{isStart:!1,pathIndex:-1,loopIndex:-1,edgeIndex:-1};const[,n,r,s]=/P(\d+)(L\d+)?E(\d+)/.exec(t);return{pathIndex:Number(n),loopIndex:r?Number(r.substr(1)):0,edgeIndex:Number(s)}}}t.SweepBody2=l},88078:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.BodyEdit=void 0;const i=n(98106),o=n(11953),a=n(79624),c=n(41002);class l{static planeCutBody(e,t){return a.PlaneCutBody.execute(e,t)}static boolean(e,t,n,r=!0,s=!1){return new c.Boolean3d(e,t,n,r,s).execute()}}r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[o.BrepBody,o.BrepBody,Number,Object,Object]),s("design:returntype",Object)],l,"boolean",null),t.BodyEdit=l},79624:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaneCutBody=void 0;const r=n(98106),s=n(70750),i=n(45548),o=n(16710),a=n(79849);t.PlaneCutBody=class{static execute(e,t){const n=new Set;for(const s of[...t.getEdges()]){const o=r.MathAlg.CalculateIntersect.curveSurface(s.getCurve(),e);if(!o.length)continue;r.MathAssert.assert(1===o.length,"暂没有处理该case");const a=i.SplitEdge.execute(t,s.tag,o[0]);n.add(a)}if(0===n.size){return r.MathAlg.CalculateDistance.pointToSurfaceSigned(t.getVertexs()[0].getPoint(),e)<0&&(t.clear(),!0)}const c=new Set;n.forEach((e=>{var n;null===(n=t.getVertexByTag(e))||void 0===n||n.getFaces().forEach((e=>c.add(e.tag)))}));const l=t.getFaces().filter((e=>!c.has(e.tag)));for(const n of l){const s=n.getWires()[0].getCoedge3ds()[0].getEdge();r.MathAssert.assert(s);const i=s.getCurve().getMidPt();r.MathAlg.CalculateDistance.pointToSurfaceSigned(i,e)<0&&(t.deleteFaceByTag(n.tag),n.dispose())}const d=[],u=new Set;for(const r of c){const s=t.getFaceByTag(r),[i,a]=new o.SplitFaceForPlaneCutBody(s,e,n).execute();i.forEach((e=>u.add(e))),d.push(...a)}u.forEach((e=>{t.getVertexByTag(e).getEdges().forEach((e=>{t.deleteEdgeByTag(e.tag),e.dispose()})),t.deleteVertexByTag(e)}));const h=new s.Face(e.clone().reverse(),!0);t.addFace(h);const g=a.SearchWireListOnFace.execute(h,[...n].map((e=>t.getVertexByTag(e))),d);return h.setWires(g[0]),g.shift(),g.forEach((n=>{const r=new s.Face(e.clone().reverse(),!0,n);t.addFace(r)})),!0}}},16710:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SplitFaceForPlaneCutBody=void 0;const r=n(98106),s=n(70750),i=n(79849);t.SplitFaceForPlaneCutBody=class{constructor(e,t,n){this._face=e,this._plane=t,this._newVertexTags=n}execute(){const[e,t,n]=this.vertexesToGroup(),r=this._patchEdges(e),o=[...r,...this._face.getEdges()];this._face.deleteAllWires();const a=i.SearchWireListOnFace.execute(this._face,[...t,...e],o);return a[0].forEach((e=>this._face.addWire(e))),a.shift(),a.forEach((e=>{const t=new s.Face(this._face.getSurface(),this._face.getSameDirWithSurface(),e);this._face.getParent().addFace(t)})),[[...n],r]}vertexesToGroup(){const e=new Set,t=[],n=[];return this._face.getVertexes().forEach((s=>{this._newVertexTags.has(s.tag)?n.push(s):r.MathAlg.PositionJudge.isPtAbovePlane(s.getPoint(),this._plane)?t.push(s):e.add(s.tag)})),[n,t,e]}_patchEdges(e){r.MathAssert.assert(e.length%2==0,"暂没有处理该情况");const t=r.MathAlg.CalculateIntersect.surfacesSimplified(this._plane,this._face.getSurface());r.MathAssert.assert(1===t.length,"暂没有处理该情况");const n=t[0];e.sort(((e,t)=>n.getParamAt(e.getPoint())-n.getParamAt(t.getPoint())));const s=this._face.getParent(),i=[];for(let t=0;t<e.length;t+=2){const n=s.createLineEdge(e[t],e[t+1]);i.push(n)}return i}}},79849:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SearchWireListOnFace=void 0;const r=n(98106),s=n(52928),i=n(40775);t.SearchWireListOnFace=class{static execute(e,t,n){const o=new Set([...t].map((e=>e.tag))),a=new Map;t.forEach((e=>{e.getEdges().forEach((t=>{const n=t.getAnotherVertex(e);if(!o.has(n.tag))return;let r=a.get(e.tag);r||(r=new Set,a.set(e.tag,r)),r.add(n.tag)})),r.MathAssert.assert(a.get(e.tag)&&2===a.get(e.tag).size)}));const c=[],l=[];for(;a.size>0;){const e=[...a.keys()][0],t=a.get(e);a.delete(e);const n=[e,[...t][0]];for(l.push(n);;){const e=n[n.length-1],t=a.get(e);if(a.delete(e),r.MathAssert.assert(t&&t.size),!(t.size>1))break;if(t.delete(n[n.length-2]),r.MathAssert.assert(1===t.size),n.push([...t.keys()][0]),n[0]===n[n.length-1])break;if(!a.size)break}r.MathAssert.assert(n[0]===n[n.length-1])}l.forEach((e=>{const t=new s.Wire;e.forEach(((s,o)=>{const a=e[o+1];if(!a)return;const c=n.find((e=>e.getStartVertex().tag===s&&e.getEndVertex().tag===a||e.getStartVertex().tag===a&&e.getEndVertex().tag===s));r.MathAssert.assert(c),t.addCoedge3d(new i.Coedge3d(c,c.getStartVertex().tag===s))})),c.push(t)})),c.forEach((t=>e.addWire(t)));const d=r.MathAlg.ILoopsToPolygonExes.execute(c,!0,!1,(e=>e.calcLoop()));return c.forEach((t=>e.deleteWireByTag(t.tag))),d}}},45548:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SplitEdge=void 0;const r=n(98106),s=n(40775);t.SplitEdge=class{static execute(e,t,n){const i=e.getEdgeByTag(t);r.MathAssert.assert(i);const o=i.getCurve().getParamAt(n);r.MathAssert.assert(i.getCurve().getRange().containsPoint(o),"打断点不合法");const a=i.getCurve().getPtAt(o),c=e.createVertex(a),l=e.createEdge(i.getCurve().clone(),i.getStartVertex(),c),d=e.createEdge(i.getCurve().clone(),c,i.getEndVertex()),u=i.getCoedge3ds();return r.MathAssert.assert(2===u.length),u.forEach((e=>{const t=e.getWire(),n=e.getIndexInWire();e.getSameDirWithEdge()?(t.insertCoedge3d(n,new s.Coedge3d(l,e.getSameDirWithEdge())),t.deleteCoedge3d(e),t.insertCoedge3d(n+1,new s.Coedge3d(d,e.getSameDirWithEdge()))):(t.insertCoedge3d(n,new s.Coedge3d(d,e.getSameDirWithEdge())),t.deleteCoedge3d(e),t.insertCoedge3d(n+1,new s.Coedge3d(l,e.getSameDirWithEdge())))})),e.deleteEdgeByTag(t),i.dispose(),c.tag}}},37632:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BodyUtil=void 0;const r=n(98106);class s{static getReversedFaces(e,t){const n=e.getFaces(),s=[t||n[0]],i=new Set(s),o=new Set;for(;s.length>0;){const e=s.pop(),t=o.has(e);for(const n of e.getWires())for(const a of n.getCoedge3ds()){const n=a.getTwins();if(0===n.length)continue;if(n.length>1){let t=1,o=0;for(const c of n){const n=c.getFace();n?(i.has(n)||(s.push(n),i.add(n)),a.getSameDirWithEdge()===c.getSameDirWithEdge()==(e.getSameDirWithSurface()===n.getSameDirWithSurface())?t++:o++):r.MathError.warn("getReversedFaces: coedge对应的face为undefined")}(t%2||o%2)&&r.MathError.warn("getReversedFaces: 非流形且face方向存在错误！");continue}const c=n[0],l=c.getFace();l&&!i.has(l)&&(s.push(l),i.add(l),a.getSameDirWithEdge()!==c.getSameDirWithEdge()==(e.getSameDirWithSurface()===l.getSameDirWithSurface())===t&&o.add(l))}}return o}static unifyFaceDirectOutside(e){if(1===e.getFaces().length){return void(e.getFaces()[0].getSurface().isSphere()&&e.getFaces()[0].setSameDirWithSurface(!0))}const t=e.tolerance||r.Tolerance.LENGTH_EPS,n=e.getVertexs();let i=[n[0]];for(const e of n)e.getPoint().z>i[0].getPoint().z+t?i=[e]:Math.abs(e.getPoint().z-i[0].getPoint().z)<t&&i.push(e);const o=new Set;for(const e of i)e.getEdges().map((e=>o.add(e)));let a,c=!0;for(const e of o)if(!e.getCurve().isLine3d()){c=!1;break}let l=new r.Vector3(0,0,0);if(c){const e=i[0].getFaces();a=e[0],l=a.getSurface().getNormAtPoint(i[0].getPoint());for(let t=1;t<e.length;t++){const n=e[t].getSurface().getNormAtPoint(i[0].getPoint());Math.abs(n.z)>Math.abs(l.z)&&(a=e[t],l=n)}}else{let n,r=i[0].getPoint();for(const s of e.getEdges()){const e=s.getCurve();if(!e.isLine3d()){const i=e.getMidPt();i.z>r.z+t&&(r=i,n=s);const o=e.getRange(),a=e.getPtAt(o.min+o.getLength()/4);a.z>r.z+t&&(r=a,n=s);const c=e.getPtAt(o.min+.75*o.getLength());c.z>r.z+t&&(r=c,n=s)}}if(n){const e=n.getFaces();a=e[0],l=a.getSurface().getNormAtPoint(r);for(let t=1;t<e.length;t++){const n=e[t].getSurface().getNormAtPoint(r);Math.abs(n.z)>Math.abs(l.z)&&(a=e[t],l=n)}}else{const e=i[0].getFaces();a=e[0],l=a.getSurface().getNormAtPoint(i[0].getPoint());for(let t=1;t<e.length;t++){const n=e[t].getSurface().getNormAtPoint(i[0].getPoint());Math.abs(n.z)>Math.abs(l.z)&&(a=e[t],l=n)}}}a.setSameDirWithSurface(l.z>0);const d=s.getReversedFaces(e,a);for(const e of d)e.setSameDirWithSurface(!e.getSameDirWithSurface())}static mergeCoincideVertexAndEdges(e){const t=e.getVertexs();t.sort(((e,t)=>((e,t)=>{const n=e.z-t.z;if(n>1e-6)return 1;if(n<-1e-6)return-1;const r=e.y-t.y;return r>1e-6?1:r<-1e-6?-1:e.x-t.x})(e.getPoint(),t.getPoint())));const n=[];for(let e=0;e<t.length-1;e++)if(t[e].getPoint().equals(t[e+1].getPoint())){const r=n.find((n=>n.find((n=>n===t[e]))));r?r.push(t[e+1]):n.push([t[e],t[e+1]])}const r=new Set;if(n.length>0)for(const t of n){const n=t[0];for(const e of n.getEdges())r.add(e);for(let s=1;s<t.length;s++){const i=t[s].getEdges();for(const e of i)r.add(e),e.getStartVertex()===t[s]?e.setStartVertex(n):e.setEndVertex(n);e.deleteVertex(t[s])}}const s=[...r];for(let t=0;t<r.size;t++)for(let n=t+1;n<r.size;n++)(s[t].getStartVertex()===s[n].getStartVertex()&&s[t].getEndVertex()===s[n].getEndVertex()&&s[t].getCurve().getMidPt().equals(s[n].getCurve().getMidPt())||s[t].getStartVertex()===s[n].getEndVertex()&&s[t].getEndVertex()===s[n].getStartVertex()&&s[t].getCurve().getMidPt().equals(s[n].getCurve().getMidPt()))&&(this._replaceEdge(s[n],s[t]),s[n].dispose(),e.deleteEdge(s[n]))}static _replaceEdge(e,t){const n=e.getCoedge3ds();for(let e=0;e<n.length;e++)n[e].setEdge(t),e--}}t.BodyUtil=s},44737:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Bool3d=void 0;const r=n(98106),s=n(11953),i=n(40775),o=n(91343),a=n(52928);function c(e){return!!e.sideKnot}function l(e){return!!e.xEdge}class d{static isXData(e){return e&&e.face1}static isCopyData(e){return e&&e.oldEdge}static getOldEdge(e){const t=e.userData;return d.isCopyData(t)?t.oldEdge:e}}class u{static setToReverse(e,t){e.userData||(e.userData={}),e.userData.toReverse=t}static isToReverse(e){return!(!e.userData||!e.userData.toReverse)}static getStartVertex(e){return u.isToReverse(e)?e.getEndVertex():e.getStartVertex()}static getEndVertex(e){return u.isToReverse(e)?e.getStartVertex():e.getEndVertex()}static getDirection(e){return u.isToReverse(e)!==e.getSameDirWithEdge()}}class h{static execute(e,t,n,i=r.Tolerance.DEFAULT){const o=new s.BrepBody,a=new Map;h._clipAndZip(o,a,{},e,t,n)}static _clipAndZip(e,t,n,i,o,a){let c=!0,l=!0;a===r.MathAlg.BoolType.union||(a===r.MathAlg.BoolType.intersect?(l=!1,c=!1):a===r.MathAlg.BoolType.difference?c=!1:r.MathError.assert(!1,"不支持的布尔类型",r.MathErrorType.Unimplemented,a));const d=[],u={faceSources:new Map},g={edgeSideKnotMap:t,overlapPackInfo:n,boolType:a,needOut1:l,needOut2:c,body1:i,body2:o,clipBody:e,movedOldCoedges:new Set,todoEdge0s:[],todoXEdge0s:[]},f=new Map;for(;;){const t=e.getEdges()[0];if(!t)break;const n=t.userData.face1;g.todoXEdge0s.push({xEdge:t,baseFace:n}),g.newBody=new s.BrepBody,d.push(g.newBody),h._findBodies(f,g)}h._forEachKnotOnOverlapFace(n,t,i,o,a,(e=>{g.todoEdge0s.push(e),g.newBody=new s.BrepBody,h._findBodies(f,g),g.newBody.getEdges().length>0&&d.push(g.newBody)}));for(const e of n.packs)f.has(e.face1)||f.set(e.face1,[]);for(;f.size>0;){const e=[];for(f.clear();e.length>0;){const t=e.pop();g.newBody=t.newBody,g.todoEdge0s.push(t),h._findBodies(f,g)}}return{bodies:Array.from(d),topo:u}}static _forEachKnotOnOverlapFace(e,t,n,s,i,o){for(const a of e.packs)for(const c of a.edges){if(c.getShell()!==n)continue;const l=t.get(c);if(!l)continue;const d=c.getCoedge3ds().find((t=>e.map.get(t.getFace())===a)),u=a.faceDirMap.get(d.getFace());for(const t of l){if([0,1].find((e=>t.newEdges[t.index+e])))continue;const n=t.knot,c=[];for(const r of n.sideKnots){if(r===t)continue;const n=r.edge.getCoedge3ds().find((t=>e.map.get(t.getFace())===a));n&&c.push({coedge:n,sideKnot:r})}r.MathError.warn(1===c.length,"重合面：不支持多边交于一点");const{sideKnot:l,coedge:g}=c[0];if(g.getShell()!==s){r.MathError.warn(!1,"重合面：edge 属于异常 shell");continue}let f;if(u===a.faceDirMap.get(g.getFace())){const e=h._isEdge1InnerToOuter(t,l,d,g);f=[i!==r.MathAlg.BoolType.intersect===e]}else f=i===r.MathAlg.BoolType.union?[!0,!1]:[];for(const e of f)o({sideKnot:t,direction:e,baseFace:d.getFace()})}}}static _findBodies(e,t){const{todoEdge0s:n,todoXEdge0s:s}=t;for(;n.length>0||s.length>0;){const i=n.pop()||s.pop();let o,d;if(c(i)){o=i.baseFace;const e=i.sideKnot.newEdges[i.sideKnot.index+(i.direction?1:0)];if(e&&h._isEdgeOnFace(e,o,t.overlapPackInfo.map))continue;d=i}else if(l(i)){if(o=i.baseFace,h._isEdgeOnFace(i.xEdge,o,t.overlapPackInfo.map))continue;d=i}else{if(t.movedOldCoedges.has(i.coedge))continue;const e=i.coedge.getWire(),n=e.getCoedge3ds().findIndex((e=>e===i.coedge));d={baseWire:e,coedgeIndex:n},o=e.getFace()}const u=new a.Wire;{const n=t.overlapPackInfo.map.get(o),r=n?n.face1:o;u.setParent(r);const s=e.get(r);s?s.push(u):e.set(r,[u])}for(t.baseFace=o,t.newWire=u,t.unsorted=!1,t.searchDir=h._getSearchDirection(o,t.body1,t.overlapPackInfo,t.boolType),t.stVtx0=void 0;d;)r.MathError.assert(t.newWire.getCoedge3ds().length<h.MAX_WIRE_SIZE,"查找Loop陷入死循环"),d=c(d)?h._trySideKnot(d,t):l(d)?h._tryXEdge(d,t):h._tryCoedge(d,t);t.stVtx0=void 0}}static _isEdgeOnFace(e,t,n){const r=n.get(t);return r?!!e.getCoedge3ds().find((e=>r===n.get(e.getFace()))):!!e.getCoedge3ds().find((e=>e.getFace()===t))}static _trySideKnot(e,t){const n=e.sideKnot,r=n.index+(e.direction?1:0);let s,o=n.newEdges[r];if(!o){const s=n.edge.getCurve().clone();if(e.direction)if(r<n.sideKnots.length){const e=n.sideKnots[n.index+1];s.setRange(n.curveT,e.curveT),o=t.newBody.createEdge(s,n.knot.vertex,e.knot.vertex)}else s.getRange().min=n.curveT,o=t.newBody.createEdge(s,n.knot.vertex,n.edge.getEndVertex());else if(r>0){const e=n.sideKnots[n.index-1];s.setRange(e.curveT,n.curveT),o=t.newBody.createEdge(s,e.knot.vertex,n.knot.vertex)}else s.getRange().max=n.curveT,o=t.newBody.createEdge(s,n.edge.getStartVertex(),n.knot.vertex);h._tagSideEdge(o,n.edge,t.body1,r),n.newEdges[r]=o}for(const r of n.edge.getCoedge3ds()){const n=r.getFace();n===t.baseFace?s=r:0===o.getCoedge3ds().length&&t.todoEdge0s.push({sideKnot:e.sideKnot,direction:e.direction,baseFace:n})}const a=s.getSameDirWithEdge()===t.searchDir,c=new i.Coedge3d(o,a);t.newWire.addCoedge3d(c);const l=c.getEndVertex();if(h._moveVertex(l,t.newBody,t.body1,t.body2),t.stVtx0||(t.stVtx0=c.getStartVertex()),l===t.stVtx0)return;const u=r+(a?0:-1);if(u>=0&&u<n.sideKnots.length){const e=h._getNextSideKnotOnOverlapFace(n.sideKnots[u],t.baseFace,t.overlapPackInfo,t.body1,t.boolType,t.searchDir);if(e)return t.searchDir=e.searchDir,t.baseFace=e.baseFace,e.todo;for(const e of l.getEdges()){const n=e.userData;if(d.isXData(n)&&(n.face1===t.baseFace||n.face2===t.baseFace))return{xEdge:e,direction:e.getStartVertex()===l}}return{sideKnot:n.sideKnots[u],direction:a}}{const e=s.getWire(),n=e.getCoedge3ds().findIndex((e=>e===s)),r=e.getCoedge3ds().length,i=t.searchDir?(n+1)%r:(n+r-1)%r;return h._findTodoEdge(e,i,t)}}static _tryCoedge(e,t){const n=e.baseWire.getCoedge3ds(),r=n[e.coedgeIndex],s=r.getEdge();h._moveEdge(s,t.newBody,t.body1,t.body2,(()=>{for(const e of s.getCoedge3ds())e!==r&&t.todoEdge0s.push({coedge:e})})),t.movedOldCoedges.add(r),u.setToReverse(r,!t.searchDir),t.newWire.addCoedge3d(r);const i=u.getEndVertex(r);if(h._moveVertex(i,t.newBody,t.body1,t.body2),t.stVtx0||(t.stVtx0=u.getStartVertex(r)),i===t.stVtx0)return;const o=n.length,a=t.searchDir?(e.coedgeIndex+1)%o:(e.coedgeIndex+o-1)%o;return h._findTodoEdge(e.baseWire,a,t)}static _tryXEdge(e,t){const n=e.xEdge;h._moveEdge(n,t.newBody,t.body1,t.body2,(()=>{const e=n.userData,r=e.face1===t.baseFace?e.face2:e.face1;t.todoXEdge0s.push({xEdge:n,baseFace:r})})),void 0===e.direction&&(t.unsorted=!0);const s=new i.Coedge3d(n,e.direction||void 0===e.direction);t.newWire.addCoedge3d(s);const o=s.getEndVertex();if(h._moveVertex(o,t.newBody,t.body1,t.body2),t.stVtx0||(t.stVtx0=s.getStartVertex()),o!==t.stVtx0)return h._findNextForXEdge(e,o,t);r.MathError.warn(void 0!==e.direction,"未梳理方向的单环交线")}static _findNextForXEdge(e,t,n){const s=t.userData.knot,i=s.sideKnots.length>1?s.sideKnots.filter((e=>e.edge.getCoedge3ds().find((e=>e.getFace()===n.baseFace)))):s.sideKnots;r.MathError.assert(1===i.length,"不支持多棱交于一点");const o=i[0];if(o.face===n.baseFace){const s=t.getEdges().filter((t=>{if(t===e.xEdge)return!1;const r=t.userData;return d.isXData(r)&&(r.face1===n.baseFace||r.face2===n.baseFace)}));return r.MathError.assert(1===s.length,"未找到下一交线或不支持多交线交于一点",r.MathErrorType.Unimplemented,s.length),{xEdge:s[0],direction:s[0].getStartVertex()===t}}{const e=h._getNextDirection(o,n.body1,n.needOut1,n.needOut2);if(n.unsorted){n.unsorted=!1;if(o.edge.getCoedge3ds().find((e=>e.getFace()===n.baseFace)).getSameDirWithEdge()!==e){const e=n.newWire.getCoedge3ds()[0].getEdge();return h._moveVertex(e.getStartVertex(),n.newBody,n.body1,n.body2),n.newWire.reverse(),n.stVtx0=n.newWire.getCoedge3ds()[0].getStartVertex(),h._findNextForXEdge({xEdge:e,direction:!1},e.getStartVertex(),n)}}return{sideKnot:o,direction:e}}}static _findTodoEdge(e,t,n){const r=e.getCoedge3ds()[t],s=n.edgeSideKnotMap.get(r.getEdge());if(s){const e=r.getSameDirWithEdge()===n.searchDir;return{sideKnot:s[e?0:s.length-1],direction:!e}}return{baseWire:e,coedgeIndex:t}}static _getSearchDirection(e,t,n,s){const i=n.map.get(e);return!i||i.face1.getSameDirWithSurface()===e.getSameDirWithSurface()!=(s===r.MathAlg.BoolType.difference&&e.getShell()!==t)}static _getNextDirection(e,t,n,s){const i=e.edge.getCurve().getTangentAt(e.curveT),o=e.face.getSurface().getNormAt(e.surfaceUV),a=i.dot(o);r.MathError.warn(Math.abs(a)>r.Tolerance.ANGLE_EPS,"边与面交点相切",r.MathErrorType.Unimplemented,e.edge,e.face);return i.dot(o)>0===e.face.getSameDirWithSurface()===(e.face.getParent()===t?s:n)}static _isEdge1InnerToOuter(e,t,n,r){const s=e.edge.getCurve().getTangentAt(e.curveT),i=t.edge.getCurve().getTangentAt(t.curveT),o=n.getFace().getSurface().getNormAtPoint(e.knot.point);return s.cross(i).dot(o)>0===r.getSameDirWithEdge()===n.getFace().getSameDirWithSurface()===r.getFace().getSameDirWithSurface()}static _getNextSideKnotOnOverlapFace(e,t,n,s,i,o){const a=n.map.get(t);if(!a)return;const c=e.knot.sideKnots.filter((t=>t!==e));if(0===c.length)return;r.MathError.warn(1===c.length,"重合面：不支持多边交于一点");const l=c[0],d=l.edge.getCoedge3ds().find((e=>n.map.get(e.getFace())===a)),u=d.getFace();if(i!==r.MathAlg.BoolType.union&&a.faceDirMap.get(t)!==a.faceDirMap.get(u)){const n=e.edge.getCoedge3ds().find((e=>e.getFace()===t)).getSameDirWithEdge()===o;return{todo:{sideKnot:e,direction:n},searchDir:o,baseFace:u}}const g=h._getSearchDirection(u,s,n,i);return{todo:{sideKnot:l,direction:d.getSameDirWithEdge()===g},searchDir:g,baseFace:u}}static _moveVertex(e,t,n,r){const s=e.getParent();s!==t&&(t===n||t===r?h._tagOldGeom(e,e.getShell()===n):e.userData=e.userData||{},s.deleteVertex(e),t.addVertex(e))}static _moveEdge(e,t,n,r,s){const i=e.getParent();i!==t&&(i!==n&&i!==r||h._tagOldGeom(e,i===n),i.deleteEdge(e),t.addEdge(e),s&&s())}static _tagOldGeom(e,t){const n=e.getDebugTag(),r=e instanceof o.Vertex?"V":"E";e.userData={debugTag:`${r}${t?"a":"b"}${n}`}}static _tagSideEdge(e,t,n,r){const s=`SE${t.getParent()===n?"a":"b"}${t.getDebugTag()}_s${r}`;e.userData={debugTag:s,oldEdge:t,index:r}}}t.Bool3d=h,h.MAX_WIRE_SIZE=1e5},41002:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Boolean3d=void 0;const r=n(98106),s=n(11953),i=n(70750),o=n(9548),a=n(40775),c=n(91343),l=n(74852),d=n(79701),u=n(1572),h=n(53265),g=n(45968),f=n(57864),p=n(23957),_=n(37632),m=n(15522),v=n(98719),E=n(91859);var P;!function(e){e[e.Success=0]="Success",e[e.TolranceChange=1]="TolranceChange",e[e.TopoInvalid=2]="TopoInvalid"}(P||(P={}));t.Boolean3d=class{constructor(e,t,n,s=!0,i=!1){this._edgeKnots=new Map,this._body1=e,this._body2=t,this._boolType=n,this._mergeFaceFlag=s,this._scale=i?1024:1;const o=this._updateBodyTolerance();o&&o/2>r.Tolerance.LENGTH_EPS?this._tol=new r.Tolerance(2*o):this._tol=r.Tolerance.DEFAULT}execute(){let e;this._validateInput(),this._rectifyInput();let t=0,n=0;const s=()=>{if(0===t)return!0;if(this._errorCode===P.TolranceChange)return!0;if(this._scale<10&&this._bodyBox1.getSize().getSqLength()<400&&this._bodyBox2.getSize().getSqLength()<400)return this._scale=1024,!0;if(n<1){const e=[],t=5*this._tol.lengthEps;for(const n of this._body1.getEdges())n.getCurve().isLine3d()&&n.getCurve().getRange().getLength()<t&&e.push(n);for(const n of this._body2.getEdges())n.getCurve().isLine3d()&&n.getCurve().getRange().getLength()<t&&e.push(n);if(e.length>0){let t=e[0],r=t.getCurve().getRange().getLength();for(let n=1;n<e.length;n++){const s=e[n].getCurve().getRange().getLength();r<s&&(t=e[n],r=s)}const s=t.getCurve().getDirection(),i=t.getCurve().getRange().getLength();return this._body2.translate(s.multiplied(5*i)),n++,!0}}return t<3&&(this._scale=1,this._updateBooleanTolerance(5*this._tol.lengthEps),!0)};let i,o,a;for(;s();){o=this._body1.clone(),a=this._body2.clone(),this._bodyBox1=new r.Box3,this._bodyBox2=new r.Box3;try{e=this._core()}catch(e){this._body1=o,this._body2=a,i=e.message}if(this._errorCode===P.Success||t>4)break;t++}if(this._errorCode===P.Success)return e;throw new Error(i)}_core(){this._preprocess(),this._initial();const e=this._getIntersectFacesPairs();this._calcEdgeXEdges(),this._calcVertexKnots(),this._calcFaceXEdges(this._body1,this._body2,this._faceEdgeKnots1),this._calcFaceXEdges(this._body2,this._body1,this._faceEdgeKnots2),this._calcFaceXFaces(e);const t=this._splitEdges();this._dealVertexVertexOverlaps();const n=this._generateFace(t),s=this._generateBodys(n);for(const e of s){if(this._scale>10){const t=1/this._scale;e.scale(t,r.Vector3.O());for(const t of e.getEdges())t.tolerance&&t.updateTolerance()}if(e.updateTolerance(),e.tolerance&&e.tolerance>.1)throw r.MathError.warn(!1,`Boolean3d: 结果body容差太大（${e.tolerance}）！！！`),new Error("Boolean3d: 布尔运算结果不合法");for(const t of e.getEdges())e.replaceEdgeTag(t.tag,v.BrepUtil.generateShortUUID());for(const t of e.getVertexs())e.replaceVertexTag(t.tag,v.BrepUtil.generateShortUUID());if(!e.isTopoValid())throw new Error("Boolean3d: 布尔运算结果不合法");E.DiagnoseShell.validate(e)}const i={faceSources:n};return this._errorCode=P.Success,{bodies:s,facesMap:i}}_validateInput(){if(this._body1.getType()===r.EN_GEO_ELEMENT_TYPE.EN_BREP_BODY){if(!this._body1.isTopoValid())throw new Error("Boolean3d：body1 is valid")}else if(!this._body1.isTopoValidBrepBody())throw new Error("Boolean3d：body1 is valid");if(this._body2.getType()===r.EN_GEO_ELEMENT_TYPE.EN_BREP_BODY){if(!this._body2.isTopoValid())throw new Error("Boolean3d：body2 is valid")}else if(!this._body1.isTopoValidBrepBody())throw new Error("Boolean3d：body1 is valid")}_rectifyInput(){_.BodyUtil.unifyFaceDirectOutside(this._body1),_.BodyUtil.unifyFaceDirectOutside(this._body2),this._dealNonManifoldBodys()}_preprocess(){if(this._scale>10){this._body1.scale(this._scale,r.Vector3.O()),this._body2.scale(this._scale,r.Vector3.O());const e=this._updateBodyTolerance();e&&this._updateBooleanTolerance(2*e)}this._aligning(),this._dealDegenerateEdgesAndFaces(this._body1),this._dealDegenerateEdgesAndFaces(this._body2)}_initial(){this._errorCode=void 0,this._edgeEdgeKnots=[],this._faceEdgeKnots1=[],this._faceEdgeKnots2=[],this._faceFaceKnots=[],this._facePolyMap=new Map,this._overlapFacePairs=[],this._overlapEdgeFaces=[],this._overlapEdgeEdges=[],this._overlapVertexFaces=[],this._overlapVertexEdges=[],this._overlapVertexVertexs=[],this._edgeOriginTopoInfos=new Map,this._vertexOriginTopoInfos=new Map;for(const e of this._body1.getVertexs())this._vertexOriginTopoInfos.set(e,{origFaces:e.getFaces(),origEdges:e.getEdges()});for(const e of this._body2.getVertexs())this._vertexOriginTopoInfos.set(e,{origFaces:e.getFaces(),origEdges:e.getEdges()});this._splitedEdgeInfos=new Map,this._colinearEdgeEdges=[]}_updateBodyTolerance(){const e=[];for(const t of this._body1.getEdges())t.updateTolerance(),t.tolerance&&e.push(t);this._body1.updateTolerance();const t=[];for(const e of this._body2.getEdges())e.updateTolerance(),e.tolerance&&t.push(e);if(this._body2.updateTolerance(),this._body1.tolerance){let t=0,n="Boolean3d: 输入body1数据存在容差！！";for(const r of e)r.getCurve().isNurbsCurve3d()||(t=Math.max(t,r.tolerance),n+=`\nedge（tag：${r.tag}）存在tolerance（${r.tolerance}）！！！`);t>r.Tolerance.LENGTH_EPS&&r.Log.d(this._body1)}if(this._body2.tolerance){let e=0,n="Boolean3d: 输入body2数据存在容差！！";for(const r of t)r.getCurve().isNurbsCurve3d()||(e=Math.max(e,r.tolerance),n+=`\nedge（tag：${r.tag}）存在tolerance（${r.tolerance}）！！！`);e>r.Tolerance.LENGTH_EPS&&r.Log.d(this._body2)}return this._body1.tolerance&&this._body2.tolerance?Math.max(this._body1.tolerance,this._body2.tolerance):this._body1.tolerance||this._body2.tolerance}_updateBooleanTolerance(e){e>this._tol.lengthEps&&(this._tol=new r.Tolerance(e))}_calcVertexKnots(){for(const e of this._body1.getVertexs())for(const t of this._body2.getVertexs())if(e.getPoint().equals(t.getPoint(),this._tol.lengthEps)){const n=e.getFaces();for(const e of n){const n=e.getSurface().getUVAt(t.getPoint());this._overlapVertexFaces.push({face:e,vt:t,surfaceUV:n})}const r=t.getFaces();for(const t of r){const n=t.getSurface().getUVAt(e.getPoint());this._overlapVertexFaces.push({face:t,vt:e,surfaceUV:n})}const s={vt1:e,vt2:t};this._overlapVertexVertexs.push(s)}const e=(e,t,n)=>{const r=t.getShell()===this._body1;for(const s of e.getEdges()){const i=r?t:s,o=r?s:t,a=this._overlapEdgeEdges.find((e=>e.edge1===i&&e.edge2===o)),c=s.getStartVertex()===e?s.getCurve().getStartParam():s.getCurve().getEndParam(),l={point:e.getPoint(),param1:r?n:c,param2:r?c:n,isOverlap:void 0!==a},d={edge1:i,edge2:o,xPtInfo:l,newXVt:e};this._addEdgeKnot(this._edgeKnots,s,[],[d],[])}};for(const t of this._body1.getEdges()){const n=t.getCurve(),r=n.getRange();for(const s of this._body2.getVertexs()){if(s.getPoint().equals(t.getStartVertex().getPoint(),this._tol.lengthEps)||s.getPoint().equals(t.getEndVertex().getPoint(),this._tol.lengthEps))continue;const i=n.getParamAt(s.getPoint());if(n.getPtAt(i).sqDistanceTo(s.getPoint())<=this._tol.lengthEps2&&r.min<i&&i<r.max){const n={edge:t,curveT:i,vt:s};this._overlapVertexEdges.push(n),this._addEdgeKnot(this._edgeKnots,t,[],[],[n]),e(s,t,i);const r=t.getFaces();for(const e of r){const t=e.getSurface().getUVAt(s.getPoint());this._overlapVertexFaces.push({face:e,vt:s,surfaceUV:t})}}}}for(const t of this._body2.getEdges()){const n=t.getCurve(),r=n.getRange();for(const s of this._body1.getVertexs()){if(s.getPoint().equals(t.getStartVertex().getPoint(),this._tol.lengthEps)||s.getPoint().equals(t.getEndVertex().getPoint(),this._tol.lengthEps))continue;const i=n.getParamAt(s.getPoint());if(n.getPtAt(i).sqDistanceTo(s.getPoint())<=this._tol.lengthEps2&&r.min<i&&i<r.max){const n={edge:t,curveT:i,vt:s};this._overlapVertexEdges.push(n),this._addEdgeKnot(this._edgeKnots,t,[],[],[n]),e(s,t,i);const r=t.getFaces();for(const e of r){const t=e.getSurface().getUVAt(s.getPoint());this._overlapVertexFaces.push({face:e,vt:s,surfaceUV:t})}}}}for(const e of this._body1.getFaces()){const t=e.calcPolygon(),n=e.getSurface();this._facePolyMap.set(e,t);for(const s of this._body2.getVertexs()){if(this._overlapVertexFaces.find((t=>t.vt===s&&t.face===e)))continue;let i=!1;for(const t of this._overlapFacePairs)if(t.face1===e&&t.face2.getVertexes().find((e=>e===s))){i=!0;break}const o=n.getUVAt(s.getPoint()),a=n.getPtAt(o).sqDistanceTo(s.getPoint());if(i||a<this._tol.lengthEps2){if(a>this._tol.lengthEps2)throw this._updateBooleanTolerance(2*Math.sqrt(a)),this._errorCode=P.TolranceChange,new Error("Boolean3d: TolranceChange");r.MathAlg.PositionJudge.ptToPolygon(new r.Vector2(o),t,this._tol.lengthEps)!==r.MathAlg.PtLoopPositonType.OUT&&this._overlapVertexFaces.push({face:e,vt:s,surfaceUV:o})}}}for(const e of this._body2.getFaces()){const t=e.calcPolygon(),n=e.getSurface();this._facePolyMap.set(e,t);for(const s of this._body1.getVertexs()){if(this._overlapVertexFaces.find((t=>t.vt===s&&t.face===e)))continue;let i=!1;for(const t of this._overlapFacePairs)if(t.face2===e&&t.face1.getVertexes().find((e=>e===s))){i=!0;break}const o=n.getUVAt(s.getPoint()),a=n.getPtAt(o).sqDistanceTo(s.getPoint());if(i||a<this._tol.lengthEps2){if(a>this._tol.lengthEps2)throw this._updateBooleanTolerance(2*Math.sqrt(a)),this._errorCode=P.TolranceChange,new Error("Boolean3d: TolranceChange");r.MathAlg.PositionJudge.ptToPolygon(new r.Vector2(o),t,this._tol.lengthEps)!==r.MathAlg.PtLoopPositonType.OUT&&this._overlapVertexFaces.push({face:e,vt:s,surfaceUV:o})}}}}_calcEdgeXEdges(){for(const e of this._body1.getEdges()){const t=e.getCurve();if(!(e.isDegenerate()||e.getStartVertex()===e.getEndVertex()&&t.getRange().getLength()<r.Tolerance.CALCULATE_EPS))for(const n of this._body2.getEdges()){const s=n.getCurve();if(n.isDegenerate()||n.getStartVertex()===n.getEndVertex()&&s.getRange().getLength()<r.Tolerance.CALCULATE_EPS)continue;const i=r.MathAlg.CalculateIntersect.curve3ds(t,s,this._tol);this._generateEdgeEdgeOverlaps(e,n,i);const o=this._tol.lengthEps;for(const a of i){if(a.isOverlap)continue;if(a.point.equals(e.getStartVertex().getPoint(),o)||a.point.equals(e.getEndVertex().getPoint(),o)||a.point.equals(n.getStartVertex().getPoint(),o)||a.point.equals(n.getEndVertex().getPoint(),o)){if(r.MathAlg.CalculateOverlap.curve3dsColinear(t,s,this._tol)){const t=a.point.equals(e.getStartVertex().getPoint(),o)?e.getStartVertex():e.getEndVertex(),r=a.point.equals(n.getStartVertex().getPoint(),o)?n.getStartVertex():n.getEndVertex(),s={edge1:e,edge2:n,xPtInfo:a,vt1:t,vt2:r};this._colinearEdgeEdges.push(s)}continue}if(t.isLine3d()&&s.isLine3d()){if(t.containsPoint(n.getStartVertex().getPoint(),o)||t.containsPoint(n.getStartVertex().getPoint(),o)||s.containsPoint(e.getStartVertex().getPoint(),o)||s.containsPoint(e.getStartVertex().getPoint(),o))continue}else if(e.getCurve().getRange().containsPointAtStartOrEnd(a.param1,o)||n.getCurve().getRange().containsPointAtStartOrEnd(a.param2,o)){const t=e.getCurve().getTangentAt(a.param1),r=n.getCurve().getTangentAt(a.param2);if(t.isParallel(r,o))continue}const i={edge1:e,edge2:n,xPtInfo:a,newXVt:new c.Vertex(a.point)};this._edgeEdgeKnots.push(i),this._addEdgeKnot(this._edgeKnots,e,[],[i],[]),this._addEdgeKnot(this._edgeKnots,n,[],[i],[])}}}}_calcFaceXEdges(e,t,n){for(const s of e.getFaces()){let e=this._facePolyMap.get(s);e||(e=s.calcPolygon());for(const i of t.getEdges()){if(i.isDegenerate()||i.getStartVertex()===i.getEndVertex()&&i.getCurve().getRange().getLength()<r.Tolerance.CALCULATE_EPS)continue;let t=!1;for(const e of this._overlapFacePairs){if(e.face1===s&&e.face2.getEdges().find((e=>e===i))){t=!0;break}if(e.face2===s&&e.face1.getEdges().find((e=>e===i))){t=!0;break}}const o=i.getCurve().isNurbsCurve3d()||s.getSurface().isNurbsSurface()?new r.Tolerance(10*this._tol.lengthEps):this._tol;if(t||(t=r.MathAlg.CalculateOverlap.isCurveSurfaceOverlap(i.getCurve(),s.getSurface(),o)),t){this._generateEdgeFaceOverlaps(i,s,e);continue}const a=r.MathAlg.Intersect.curveSurfaceAll(i.getCurve(),s.getSurface(),o),c=o.lengthEps;for(const t of a){if(t.point.equals(i.getStartVertex().getPoint(),c))continue;if(t.point.equals(i.getEndVertex().getPoint(),c))continue;if(i.getCurve().getRange().containsPointAtStartOrEnd(t.curveT,c)){const e=i.getCurve().getTangentAt(t.curveT);if(s.getSurface().getNormAt(t.surfaceUV).isPerpendicular(e,c))continue}const a=s.getVertexes();if(this._overlapVertexEdges.find((e=>e.edge===i&&a.find((t=>t===e.vt)))))continue;const l=[i.getStartVertex(),i.getEndVertex()];let d;if(d=s.getShell()===this._body1?this._overlapVertexVertexs.find((e=>a.find((t=>t===e.vt1))&&l.find((t=>t===e.vt2)))):this._overlapVertexVertexs.find((e=>a.find((t=>t===e.vt2))&&l.find((t=>t===e.vt1)))),d)continue;if(r.MathAlg.PositionJudge.ptToPolygon(new r.Vector2(t.surfaceUV),e,o.lengthEps)===r.MathAlg.PtLoopPositonType.OUT)continue;const u={face:s,edge:i,xPtInfo:t};this._addEdgeFaceKnotToSet(u,n)}}}}_calcFaceXFaces(e){for(const t of e){const e=t.face1,n=t.face2,r=new Set(e.getEdges()),s=new Set(n.getEdges()),i=[],o=this._faceEdgeKnots1.filter((t=>t.face===e));if(o.length>0){const e=o.filter((e=>s.has(e.edge)));i.push(...e)}const a=this._faceEdgeKnots2.filter((e=>e.face===n));if(a.length>0){const e=a.filter((e=>r.has(e.edge)));i.push(...e)}const c=[],l=this._overlapVertexFaces.filter((t=>t.face===e));if(l.length>0){const e=n.getVertexes(),t=l.filter((t=>e.find((e=>e===t.vt))));c.push(...t)}const d=this._overlapVertexFaces.filter((e=>e.face===n));if(d.length>0){const t=e.getVertexes(),n=d.filter((e=>t.find((t=>t===e.vt))));c.push(...n)}const u=this._edgeEdgeKnots.filter((e=>r.has(e.edge1)&&s.has(e.edge2)));if(0===i.length&&0===c.length&&0===u.length&&(e.getSurface().isPlane()&&n.getSurface().isRuled()||e.getSurface().isRuled()&&n.getSurface().isPlane()))continue;const h={facePair:t,faceEdgeKnots:i,faceVtKnots:c,edgeEdgeKnots:u};if(t.isOverlap){this._faceFaceKnots.push(h);continue}const g=this._calcFaceXFace(e,n,h);h.newEdges=g,g.length>0&&this._faceFaceKnots.push(h)}}_calcFaceXFace(e,t,n){const s=[],i=new Set;for(const e of n.faceVtKnots)if(i.size>0&&this._overlapVertexVertexs.length>0){const t=this._overlapVertexVertexs.find((t=>t.vt1===e.vt||t.vt2===e.vt));if(t&&(i.has(t.vt1)||i.has(t.vt2)))continue;i.add(e.vt)}else i.add(e.vt);for(const e of n.edgeEdgeKnots)i.add(e.newXVt);for(const e of n.faceEdgeKnots){const t=e.xPtInfo.point;e.newXVt||(e.newXVt=new c.Vertex(t)),i.add(e.newXVt)}const a=(n,r)=>{if(r.isLine3d())return!1;const s=e.getSurface(),i=t.getSurface();if(s.isPlane()||i.isPlane())return!1;const o=s.getNormAtPoint(n.getPoint()),a=i.getNormAtPoint(n.getPoint());return!!o.isParallel(a,this._tol.angleEps)},l=(n,s)=>{const i=s.getPoint(),o=n.getParamAt(i),a=n.getTangentAt(o),c=e.getSurface().getNormAtPoint(i).cross(a),l=r.MathAlg.CalculateIntersect.surfacesNearPoint(e.getSurface(),t.getSurface(),i,c,this._tol,!0);if(void 0===l)return;const d=l.getRange(),u=l.getPtAt(0),h=l.getPtAt(.25*d.min+.75*d.max),g=l.getPtAt(.75*d.min+.25*d.max);if(n.containsPoint(u,.1)&&n.containsPoint(h,.1)&&n.containsPoint(g,.1)){const s=a.reversed(),o=r.MathAlg.CalculateIntersect.surfacesNearPoint(e.getSurface(),t.getSurface(),i,s,this._tol,!0);if(void 0===o)return;const c=o.getRange(),l=o.getPtAt(0),d=o.getPtAt(.25*c.min+.75*c.max),u=o.getPtAt(.75*c.min+.25*c.max);if(n.containsPoint(l,.1)&&n.containsPoint(d,.1)&&n.containsPoint(u,.1))return;return o}return l},d=(e,t,n)=>{const r=n.find((e=>e.xCurve===t));r?r.xVts.add(e):n.push({xCurve:t,xVts:new Set([e])})},u=(e,t,n,r)=>{for(const s of t)if(!s.used&&e.containsPoint(s.vt.getPoint(),.01)){if(d(s.vt,e,n),a(s.vt,e)){const t=l(e,s.vt);t&&(r.push(t),d(s.vt,t,n))}s.used=!0}};if(i.size>0){const n=[],o=[];for(const e of i)o.push({vt:e,used:!1});for(const s of o){if(s.used)continue;s.used=!0;const i=s.vt.getPoint();let c;for(const n of this._overlapEdgeFaces)if(n.face===e&&n.edgeFaces.find((e=>e===t))||n.face===t&&n.edgeFaces.find((t=>t===e))){const e=n.edge.getCurve().clone(),t=e.getRange();if(t instanceof r.PeriodInterval?e.setRange(0,t.period):e.setRange(e.getDomain().min,e.getDomain().max),e.containsPoint(i,.01)){c=e;break}}for(const n of this._overlapEdgeEdges)if(n.edge1Faces.find((t=>t===e))&&n.edge2Faces.find((e=>e===t))){const e=n.edge1.getCurve().clone(),t=e.getRange();if(t instanceof r.PeriodInterval?e.setRange(0,t.period):e.setRange(e.getDomain().min,e.getDomain().max),e.containsPoint(i,.01)){c=e;break}}if(c||(c=r.MathAlg.CalculateIntersect.surfacesNearPoint(e.getSurface(),t.getSurface(),i,void 0,this._tol,!0)),void 0===c){const n=e.getSurface(),r=t.getSurface(),s=n.getSingularPoints().find((e=>e.equals(i,this._tol.lengthEps))),o=r.getSingularPoints().find((e=>e.equals(i,this._tol.lengthEps)));if(s||o)continue;const a=n.getNormAt(n.getUVAt(i)),c=r.getNormAt(r.getUVAt(i));if(n.isSphere()||r.isSphere()){if(a.isParallel(c,this._tol.edgeLengthEps))continue}else if(a.isOpposite(c,this._tol.edgeLengthEps))continue;throw new Error("Boolean3d：曲面曲面计算交线失败")}d(s.vt,c,n);const h=[c];if(a(s.vt,c)){const e=l(c,s.vt);e&&(h.push(e),d(s.vt,e,n))}for(const e of h)u(e,o,n,h)}for(let e=0;e<n.length;e++){const t=n[e];for(let s=e+1;s<n.length;s++){const e=n[s],i=t.xCurve.isNurbsCurve3d()||e.xCurve.isNurbsCurve3d()?new r.Tolerance(this._tol.edgeLengthEps):this._tol,a=r.MathAlg.CalculateIntersect.curve3ds(t.xCurve,e.xCurve,i);for(const r of a){let s;t.hasSingularPt=!0,e.hasSingularPt=!0;for(const e of o)if(e.vt.getPoint().equals(r.point,this._tol.edgeLengthEps)){s=e.vt;break}if(s)d(s,t.xCurve,n),d(s,e.xCurve,n);else{const s=new c.Vertex(r.point);d(s,t.xCurve,n),d(s,e.xCurve,n)}}}}for(const r of n){const n=this._createEdgeForXCurve(r,e,t);s.push(...n)}}else{const n=(this._facePolyMap.get(e)||e.calcPolygon()).getBoundingBox(),i=e.getSurface().getDomainU();i.min=Math.max(n.min.x,i.min),i.max=Math.min(n.max.x,i.max);const a=e.getSurface().getDomainV();a.min=Math.max(n.min.y,a.min),a.max=Math.min(n.max.y,a.max);const l=(this._facePolyMap.get(t)||t.calcPolygon()).getBoundingBox(),d=t.getSurface().getDomainU();d.min=Math.max(l.min.x,d.min),d.max=Math.min(l.max.x,d.max);const u=t.getSurface().getDomainV();u.min=Math.max(l.min.y,u.min),u.max=Math.min(l.max.y,u.max);const h=r.MathAlg.CalculateIntersect.surfacesSimplified(e.getSurface(),t.getSurface(),i,a,d,u,this._tol,!0,!0);if(0===h.length)return[];if(h.length>1){let e=!0;for(const t of h)t.isLine3d()||(e=!1);if(e)return[]}let g=this._facePolyMap.get(e);void 0===g&&(g=e.calcPolygon());let f=this._facePolyMap.get(t);void 0===f&&(f=e.calcPolygon());const p=n=>{const s=n.getStartPt(),i=e.getSurface().getUVAt(s);if(r.MathAlg.PositionJudge.ptToPolygon(i,g)===r.MathAlg.PtLoopPositonType.OUT)return!1;const o=t.getSurface().getUVAt(s);return r.MathAlg.PositionJudge.ptToPolygon(o,f)!==r.MathAlg.PtLoopPositonType.OUT};for(const n of h){if(!n||!n.getStartPt().equals(n.getEndPt())){if(!p(n))continue;throw new Error("Boolean3d：计算周期交线错误")}if(!p(n))return[];this._adjustDirOfXCurve(n,e,t);const r=new c.Vertex(n.getStartPt()),i=new o.Edge(n,r,r);s.push(i)}}return s}_splitEdges(){const e=new Map;this._dealOverlapEdgeEdges(e,this._splitedEdgeInfos),this._dealOverlapEdgeFaces(e,this._splitedEdgeInfos);for(const e of this._edgeKnots){const t=e[0];if(t.getShell()===this._body1){if(this._splitedEdgeInfos.has(t))continue;this._splitedEdgeInfos.set(t,t.getCurve().clone());const{edge1FaceKnots:e,edge1EdgeKnots:n,edge1OverlapVtKnots:s}=this._getAllKnotsForBody1Edge(t),i=this._boolType!==r.MathAlg.BoolType.intersect,o=this._splitEdge(t,e,n,s,i);if(1===o.length)continue;const c=t.getCoedge3ds();for(const e of o)for(const t of c){const n=new a.Coedge3d(e,t.getSameDirWithEdge()),r=t.getWire(),s=t.getIndexInWire(),i=t.getSameDirWithEdge()?s:s+1;r.insertCoedge3d(i,n)}const[l,d]=h.getLeftAndRightCoedge(t),u=l.getFace(),g=d.getFace();this._edgeOriginTopoInfos.set(t,{leftCoedge:l,rightCoedge:d,leftFace:u,rightFace:g}),this._deleteEdgeCoedges(t),this._body1.deleteEdge(t)}else if(t.getShell()===this._body2){if(this._splitedEdgeInfos.has(t))continue;this._splitedEdgeInfos.set(t,t.getCurve().clone());const{edge2FaceKnots:e,edge2EdgeKnots:n,edge2OverlapVtKnots:s}=this._getAllKnotsForBody2Edge(t),i=this._boolType===r.MathAlg.BoolType.union,o=this._splitEdge(t,e,n,s,i);if(1===o.length)continue;const c=t.getCoedge3ds();for(const e of o)for(const t of c){const n=new a.Coedge3d(e,t.getSameDirWithEdge()),r=t.getWire(),s=t.getIndexInWire(),i=t.getSameDirWithEdge()?s:s+1;r.insertCoedge3d(i,n)}const[l,d]=h.getLeftAndRightCoedge(t),u=l.getFace(),g=d.getFace();this._edgeOriginTopoInfos.set(t,{leftCoedge:l,rightCoedge:d,leftFace:u,rightFace:g}),this._deleteEdgeCoedges(t),this._body2.deleteEdge(t)}}for(const e of this._colinearEdgeEdges){const t=e.edge1,n=e.vt1,s=e.edge2,i=e.vt2;if(!this._splitedEdgeInfos.has(t)){const s=this._curveVertex(t,e.xPtInfo.param1,i);if(this._boolType===r.MathAlg.BoolType.intersect){if(t.getStartVertex()===n&&1===s.next||t.getEndVertex()===n&&1===s.prev){const e=t.getCoedge3ds();for(const t of e){const e=t.getWire();e&&e.deleteCoedge3d(t)}}}else if(t.getStartVertex()===n&&-1===s.next||t.getEndVertex()===n&&-1===s.prev){const e=t.getCoedge3ds();for(const t of e){const e=t.getWire();e&&e.deleteCoedge3d(t)}}}if(!this._splitedEdgeInfos.has(s)){const t=this._curveVertex(s,e.xPtInfo.param2,n);if(this._boolType===r.MathAlg.BoolType.union){if(s.getStartVertex()===i&&-1===t.next||s.getEndVertex()===i&&-1===t.prev){const e=s.getCoedge3ds();for(const t of e){const e=t.getWire();e&&e.deleteCoedge3d(t)}}}else if(s.getStartVertex()===i&&1===t.next||s.getEndVertex()===i&&1===t.prev){const e=s.getCoedge3ds();for(const t of e){const e=t.getWire();e&&e.deleteCoedge3d(t)}}}}return e}_generateFace(e){const t=new Map,n=new Set,s=new Set;for(const t of e)t[0].getShell()===this._body1?n.add(t[0]):t[0].getShell()===this._body2&&s.add(t[0]);const i=new Map,o=[];for(const r of this._faceFaceKnots)r.facePair.isOverlap?this._generateOverlapFaces(r,e,i,t,o):(n.add(r.facePair.face1),s.add(r.facePair.face2));for(const e of this._faceFaceKnots)e.facePair.isOverlap&&(n.delete(e.facePair.face1),s.delete(e.facePair.face2));for(const r of n){const n=this._findBody1FaceAllNewXCoedges(r,i),s=e.get(r);s&&n.push(...s);const o=this._updateFace(r,n);for(const e of o)t.set(e,[r])}for(const n of s){const s=this._findBody2FaceAllNewXCoedges(n,i),o=e.get(n);o&&s.push(...o);const a=this._updateFace(n,s);for(const e of a)this._boolType===r.MathAlg.BoolType.difference&&e.reverse(),t.set(e,[n])}return t}_generateBodys(e){var t,n;const i=[];for(const t of e)i.push(t[0]);if(0===i.length){const t=this._dealNoIntersectCase();for(const n of t)for(const t of n.getFaces())void 0===e.get(t)&&e.set(t,[t]);return t}this._nonManifoldEdgeMap&&this._mergeNonManifoldEdges();const o=[];for(;i.length>0;){const e=i[0];i.splice(0,1);const a=new Set;a.add(e);const c=e.getEdges();for(const e of c){const t=[],n=e.getCoedge3ds();for(let r=0;r<n.length;r++){const s=n[r].getFace();s?t.push(s):(e.deleteCoedge3d(n[r]),r--)}for(const e of t){if(a.has(e))continue;a.add(e);const t=i.findIndex((t=>t===e));-1!==t&&i.splice(t,1);const n=e.getEdges();for(const e of n)c.find((t=>t===e))||c.push(e);if(c.length>1e5)throw new Error("Boolean3d：body搜索死循环")}}const l=new s.BrepBody;if(this._boolType===r.MathAlg.BoolType.difference)for(const e of a)e.getParent()===this._body2&&e.reverse(),null===(t=e.getShell())||void 0===t||t.deleteFace(e),l.addFace(e);else for(const e of a)null===(n=e.getShell())||void 0===n||n.deleteFace(e),l.addFace(e);for(const e of c){e.updateTolerance();const t=e.tolerance;if(t&&t>this._tol.lengthEps)if(e.getCurve().isNurbsCurve3d()&&t<.001)r.MathError.warn(`Boolean3d: 布尔运算产生了容差（Nurbs曲线：${t}）！！！`);else{const e=`Boolean3d: 布尔运算产生了容差（${t}）！！！！`;t>1e-5||r.MathError.warn(e)}const n=e.getShell();n&&(n.deleteEdge(e),n.deleteVertex(e.getStartVertex()),n.deleteVertex(e.getEndVertex())),e.tag=v.BrepUtil.generateShortUUID(),l.addEdge(e),l.addVertex(e.getStartVertex()),l.addVertex(e.getEndVertex())}this._postProcess(l);for(const e of l.getEdges()){const t=e.getCurve();if(t instanceof r.IntersectCurve3d){const n=t.toSimpleCurve3d();e.setCurve(n)}}o.push(l)}const a=e=>{for(const t of e.getVertexs())for(const n of t.getEdges()){const t=n.getShell();if(t!==e&&o.find((e=>e===t)))return n}};if(o.length>1)for(const e of o){const t=a(e);if(t){const n=t.getShell();for(const t of n.getFaces())e.addFace(t);for(const t of n.getEdges())e.addEdge(t);for(const t of n.getVertexs())e.addVertex(t);const r=o.findIndex((e=>e===n));o.splice(r,1)}}for(const t of o)for(const n of t.getFaces())void 0===e.get(n)&&e.set(n,[n]);for(const e of this._body1.getEdges())e.dispose();for(const e of this._body1.getFaces())e.dispose();for(const e of this._body2.getEdges())e.dispose();for(const e of this._body2.getFaces())e.dispose();return o}_findBody1FaceAllNewXCoedges(e,t){const n=t.get(e);if(void 0!==n)return n;const s=this._faceFaceKnots.filter((t=>t.facePair.face1===e)),i=[],o=e.getSameDirWithSurface();for(const t of s){if(t.facePair.isOverlap)continue;const n=t.facePair.face2;for(const s of t.newEdges){const t=d.FaceFaceAnalysis.FaceFace(e,n,s.getCurve());if(this._boolType===r.MathAlg.BoolType.intersect){if(t===g.PositionType.IN)continue;if(t===g.PositionType.OUT){d.FaceFaceAnalysis.FaceFace(n,e,s.getCurve())===g.PositionType.IN&&(i.push(new a.Coedge3d(s,o)),i.push(new a.Coedge3d(s,!o)))}else i.push(new a.Coedge3d(s,o))}else if(t===g.PositionType.IN)this._boolType===r.MathAlg.BoolType.difference&&(i.push(new a.Coedge3d(s,o)),i.push(new a.Coedge3d(s,!o)));else{if(t===g.PositionType.OUT){d.FaceFaceAnalysis.FaceFace(n,e,s.getCurve())===g.PositionType.OUT&&(i.push(new a.Coedge3d(s,o)),i.push(new a.Coedge3d(s,!o)));continue}i.push(new a.Coedge3d(s,!o))}}}return t.set(e,i),i}_findBody2FaceAllNewXCoedges(e,t){const n=t.get(e);if(void 0!==n)return n;const s=this._faceFaceKnots.filter((t=>t.facePair.face2===e)),i=[],o=e.getSameDirWithSurface();for(const t of s){if(t.facePair.isOverlap)continue;const n=t.facePair.face1;for(const s of t.newEdges){const t=d.FaceFaceAnalysis.FaceFace(e,n,s.getCurve());if(this._boolType===r.MathAlg.BoolType.union)if(t===g.PositionType.IN);else{if(t===g.PositionType.OUT){d.FaceFaceAnalysis.FaceFace(n,e,s.getCurve())===g.PositionType.OUT&&(i.push(new a.Coedge3d(s,o)),i.push(new a.Coedge3d(s,!o)));continue}i.push(new a.Coedge3d(s,o))}else{if(t===g.PositionType.IN)continue;if(t===g.PositionType.OUT){d.FaceFaceAnalysis.FaceFace(n,e,s.getCurve())===g.PositionType.IN&&(i.push(new a.Coedge3d(s,o)),i.push(new a.Coedge3d(s,!o)))}else i.push(new a.Coedge3d(s,!o))}}}return t.set(e,i),i}_updateFace(e,t){if(0===t.length)return[];const n=e.getCoedge3ds(),r=u.searchWires(e.getSurface(),t,n),s=this._dealFaceCompletedWires(e);r.push(...s);return this._newFacesFromWires(e.getSurface().clone(),e.getSameDirWithSurface(),r)}_getNonOverlapVertex(e){const t=0===e?this._body1.getVertexs():this._body2.getVertexs(),n=new Set;for(const t of this._overlapFacePairs){(0===e?t.face1.getVertexes():t.face2.getVertexes()).map((e=>n.add(e)))}for(const t of this._overlapEdgeEdges)0===e?(n.add(t.edge1.getStartVertex()),n.add(t.edge1.getEndVertex())):(n.add(t.edge2.getStartVertex()),n.add(t.edge2.getEndVertex()));for(const e of this._overlapVertexFaces)(e.face.getShell()===this._body2||e.face.getShell()===this._body1)&&n.add(e.vt);for(const e of t)if(!n.has(e))return e.getPoint();const r=0===e?this._body1:this._body2;for(const e of r.getFaces()){if(this._overlapFacePairs.find((t=>t.face1===e)))continue;let t=this._facePolyMap.get(e);void 0===t&&(t=e.calcPolygon());const n=this._getPolygonInnerPt(t);return e.getSurface().getPtAt(n)}const s=r.getFaces()[0];let i=this._facePolyMap.get(s);void 0===i&&(i=s.calcPolygon());const o=this._getPolygonInnerPt(i),a=s.getNormAt(o);return s.getSurface().getPtAt(o).added(a.multiplied(-.1))}_getPolygonInnerPt(e){const t=e.getAllCurves()[0],n=t.getMidPt(),s=t.getMidTangent(),i=new r.Vector2(-s.y,s.x),o=e.getBoundingBox(),a=Math.min(o.getSize().x,o.getSize().y);return n.added(i.multiplied(.1*a))}_dealNoIntersectCase(){if(this._overlapEdgeFaces.length>0||this._overlapEdgeEdges.length>0){const e=this._BodyBodyPosition();return this._boolType===r.MathAlg.BoolType.intersect?e===m.BrepBodyPositionType.INSIDE||e===m.BrepBodyPositionType.EQUAL?[this._body1]:e===m.BrepBodyPositionType.CONTAIN?[this._body2]:[]:this._boolType===r.MathAlg.BoolType.union?e===m.BrepBodyPositionType.INSIDE?[this._body2]:e===m.BrepBodyPositionType.CONTAIN||e===m.BrepBodyPositionType.EQUAL?[this._body1]:[this._body1,this._body2]:e===m.BrepBodyPositionType.INSIDE||e===m.BrepBodyPositionType.EQUAL?[]:e===m.BrepBodyPositionType.CONTAIN?[this._body1,this._body2]:[this._body1]}const e=this._getNonOverlapVertex(0);if(void 0!==e){const t=f.BrepPositionJudge.pointBrepBodyPositionJudge(e,this._body2,this._tol.lengthEps);if(t===p.PointBodyPositionType.INSIDE){if(this._boolType===r.MathAlg.BoolType.intersect)return[this._body1];if(this._boolType===r.MathAlg.BoolType.union)return[this._body2];if(this._boolType===r.MathAlg.BoolType.difference)return[]}else if(t===p.PointBodyPositionType.OUTSIDE){const e=this._getNonOverlapVertex(1);if(!e)throw new Error("Boolean3d: 无交的两个body位置关系判断时错误");const t=f.BrepPositionJudge.pointBrepBodyPositionJudge(e,this._body1,this._tol.lengthEps);if(this._boolType===r.MathAlg.BoolType.intersect)return t===p.PointBodyPositionType.OUTSIDE?[]:[this._body2];if(this._boolType===r.MathAlg.BoolType.union)return t===p.PointBodyPositionType.INSIDE?[this._body1]:[this._body1,this._body2];if(this._boolType===r.MathAlg.BoolType.difference){if(t===p.PointBodyPositionType.INSIDE){for(const e of this._body2.getFaces())e.reverse(),this._body1.addFace(e);for(const e of this._body2.getEdges())this._body1.addEdge(e);for(const e of this._body2.getVertexs())this._body1.addVertex(e);return[this._body1]}return[this._body1]}}throw new Error("Boolean3d: 无交的两个body位置关系判断时错误")}throw new Error("Boolean3d: 无交的两个body位置关系判断时错误")}_getAllKnotsForBody1Edge(e){const t=this._faceEdgeKnots2.filter((t=>t.edge===e)),n=this._edgeEdgeKnots.filter((t=>t.edge1===e)),r=this._overlapVertexEdges.filter((t=>t.edge===e)),s=this._overlapVertexEdges.filter((t=>t.vt===e.getStartVertex()||t.vt===e.getEndVertex()));for(const t of s){if(this._overlapEdgeEdges.find((n=>n.edge1===e&&n.edge2===t.edge)))continue;const r=e.getCurve(),s={point:t.vt.getPoint(),param1:e.getStartVertex()===t.vt?r.getStartParam():r.getEndParam(),param2:t.edge.getCurve().getParamAt(t.vt.getPoint()),isOverlap:!1},i={edge1:e,edge2:t.edge,xPtInfo:s,newXVt:t.vt};n.push(i)}return{edge1FaceKnots:t,edge1EdgeKnots:n,edge1OverlapVtKnots:r}}_getAllKnotsForBody2Edge(e){const t=this._faceEdgeKnots1.filter((t=>t.edge===e)),n=this._edgeEdgeKnots.filter((t=>t.edge2===e)),r=this._overlapVertexEdges.filter((t=>t.edge===e)),s=this._overlapVertexEdges.filter((t=>t.vt===e.getStartVertex()||t.vt===e.getEndVertex()));for(const t of s){if(this._overlapEdgeEdges.find((n=>n.edge1===t.edge&&n.edge2===e)))continue;const r=e.getCurve(),s={point:t.vt.getPoint(),param1:t.edge.getCurve().getParamAt(t.vt.getPoint()),param2:e.getStartVertex()===t.vt?r.getStartParam():r.getEndParam(),isOverlap:!1},i={edge1:t.edge,edge2:e,xPtInfo:s,newXVt:t.vt};n.push(i)}return{edge2FaceKnots:t,edge2EdgeKnots:n,edge2OverlapVtKnots:r}}_splitEdge(e,t,n,s,i){if(0===t.length&&0===n.length&&0===s.length)return[e];const o=e,a=o.getCurve(),c=[];for(const e of s){const t={param:e.curveT,splitVt:e.vt};c.push(t)}if(n.length>0)if(n[0].edge1===e)for(const e of n){const t={param:e.xPtInfo.param1,splitVt:e.newXVt,splitEdge:e.edge2};c.push(t)}else for(const e of n){const t={param:e.xPtInfo.param2,splitVt:e.newXVt,splitEdge:e.edge1};c.push(t)}for(const e of t){const t={param:e.xPtInfo.curveT,splitVt:e.newXVt,splitFace:e.face,faceXInfo:e.xPtInfo};c.push(t)}c.sort(((e,t)=>e.param-t.param));const d=[];let u;for(let t=0;t<c.length;t++){const n=c[t];let s;if(n.splitFace)s=l.CurveSolidAnalysis.curveFace(a,n.splitFace,n.faceXInfo);else if(n.splitEdge){const e=this._edgeOriginTopoInfos.get(n.splitEdge),t=e?[e.leftFace,e.rightFace]:void 0;s=l.CurveSolidAnalysis.curveEdge(a,n.splitEdge,n.splitVt.getPoint(),t)}else{const r=a.getRange(),i=0===t?n.param-r.min:n.param-c[t-1].param,o=t===c.length-1?r.max-n.param:c[t+1].param-n.param,l=Math.min(i,o);s=this._curveVertex(e,n.param,n.splitVt,l)}if(0===t)(i&&1===s.prev||!i&&-1===s.prev)&&(Math.abs(a.getRange().min-n.param)>this._tol.numberEps||o.getStartVertex()!==n.splitVt)&&d.push({min:a.getRange().min,max:n.param,stVt:o.getStartVertex(),endVt:n.splitVt}),u=s.next;else{if(s.prev===u){if(i&&1===s.prev||!i&&-1===s.prev){const e=c[t-1];(Math.abs(e.param-n.param)>this._tol.numberEps||e.splitVt!==n.splitVt)&&d.push({min:e.param,max:n.param,stVt:e.splitVt,endVt:n.splitVt})}}else r.MathError.warn("bool3d: 前后判断不一致！！！");u=s.next}t!==c.length-1||(i&&1===s.next||!i&&-1===s.next)&&(Math.abs(n.param-a.getRange().max)>this._tol.numberEps||n.splitVt!==o.getEndVertex())&&d.push({min:n.param,max:a.getRange().max,stVt:n.splitVt,endVt:o.getEndVertex()})}if(0===d.length)return a.setRange(c[0].param,c[0].param),o.setStartVertex(c[0].splitVt),o.setEndVertex(c[0].splitVt),[e];return this._generateNewEdges(o,d)}_generateNewEdges(e,t){const n=e.getCurve();if(1===t.length){const r=t[0];return n.setRange(r.min,r.max),e.setStartVertex(r.stVt),e.setEndVertex(r.endVt),[e]}const r=[],s=e.getShell();for(const e of t){const t=n.clone();t.setRange(e.min,e.max);const i=new o.Edge(t,e.stVt,e.endVt);s.addEdge(i),r.push(i)}return r}_adjustDirOfXCurve(e,t,n){const s=e.getMidPt(),i=e.getMidTangent(),o=t.getSurface().getNormAtPoint(s);t.getSameDirWithSurface()||o.reverse();const a=n.getSurface().getNormAtPoint(s);n.getSameDirWithSurface()||a.reverse();return o.cross(a).dot(i)<-r.Tolerance.ANGLE_EPS&&(e.reverse(),!0)}_createEdgeForXCurve(e,t,n){const s=e.xCurve,i=[...e.xVts];e.hasSingularPt||this._adjustDirOfXCurve(e.xCurve,t,n);const a=this._sortXCurveVts(i,s),c=[];for(const e of this._overlapEdgeEdges){const r=t.getEdges(),s=n.getEdges();r.find((t=>t===e.edge1))&&s.find((t=>t===e.edge2))&&c.push(e)}const l=[];for(const e of this._overlapEdgeFaces)if(e.face===t){n.getEdges().find((t=>t===e.edge))&&l.push(e)}else if(e.face===n){t.getEdges().find((t=>t===e.edge))&&l.push(e)}const d=(e,t)=>{const n=(e+t)/2,r=s.getPtAt(e),i=s.getPtAt(t),o=s.getPtAt(n),a=this._tol.lengthEps;for(const e of c){const t=e.overlapInfos;for(const e of t){const t=e.stVt.getPoint(),n=e.endVt.getPoint();if(t.equals(r,a)&&n.equals(i,a)||t.equals(i,a)&&n.equals(r,a))return!0}}for(const e of l){const t=e.edge.getCurve();if(t.containsPoint(r,a)&&t.containsPoint(i,a)&&t.containsPoint(o,a))return!0}return!1};let u=this._facePolyMap.get(t);void 0===u&&(u=t.calcPolygon());let h=this._facePolyMap.get(n);void 0===h&&(h=t.calcPolygon());const g=(e,i)=>{const o=(e+i)/2,a=s.getPtAt(o),c=t.getSurface().getUVAt(a);if(r.MathAlg.PositionJudge.ptToPolygon(c,u)===r.MathAlg.PtLoopPositonType.OUT)return!1;const l=n.getSurface().getUVAt(a);return r.MathAlg.PositionJudge.ptToPolygon(l,h)!==r.MathAlg.PtLoopPositonType.OUT};if(1===i.length){for(const e of l){if(e.edge.getCurve().containsPoint(i[0].getPoint()))return[]}for(const e of c){const t=e.overlapInfos;for(const e of t)if(e.stVt.getPoint().equals(i[0].getPoint())&&e.endVt.getPoint().equals(i[0].getPoint()))return[]}if(s.isPeriodic()){const e=s.getRange().period,t=s.getParamAt(i[0].getPoint());s.setRange(t,t+e);if(!g(t,t+e))return[];return[new o.Edge(s,i[0],i[0])]}return[]}if(s.isPeriodic()){const e=s.getRange().period;a.push(a[0]+e),i.push(i[0])}const f=[];for(let r=0;r<a.length-1;r++){if(d(a[r],a[r+1]))continue;if(!g(a[r],a[r+1]))continue;const c=s.clone();if(c.setRange(a[r],a[r+1]),e.hasSingularPt&&this._adjustDirOfXCurve(c,t,n)){const e=new o.Edge(c,i[r+1],i[r]);f.push(e)}else{const e=new o.Edge(c,i[r],i[r+1]);f.push(e)}}return f}_dealFaceCompletedWires(e){const t=[],n=e.getShell()===this._body1?this._body2:this._body1,s=this._findNoSplitWiresInFace(e);for(const i of s){let s=0;for(const e of i.getCoedge3ds()){const t=this._pointToBodyPosition(e.getStartVertex().getPoint(),n);if(-1===t||1===t){s=t;break}}if(e.getShell()===this._body1)if(1===s)this._boolType===r.MathAlg.Bool2dType.intersect||t.push(i);else{if(-1!==s)throw new Error("");this._boolType===r.MathAlg.Bool2dType.intersect&&t.push(i)}else 1===s?this._boolType===r.MathAlg.Bool2dType.union&&t.push(i):-1===s&&(this._boolType===r.MathAlg.Bool2dType.union||t.push(i));e.deleteWire(i)}return t}_dealFaceCompletedWiresInPair(e,t,n){const s=e.face1,i=e.face2,o=this._findNoSplitWiresInFace(s);for(const e of o){const n=this._wireAndFacePostion(e,i);if(1===n){const n=this._wireAndBodyPostion(e,this._body2);this._boolType===r.MathAlg.Bool2dType.intersect?-1===n&&t.push(e):1===n&&t.push(e)}else-1===n&&this._boolType===r.MathAlg.Bool2dType.intersect&&t.push(e);s.deleteWire(e)}const a=this._findNoSplitWiresInFace(i);for(const e of a){const t=this._wireAndFacePostion(e,s);if(1===t){const t=this._wireAndBodyPostion(e,this._body1);this._boolType===r.MathAlg.Bool2dType.union?1===t&&n.push(e):-1===t&&n.push(e)}else-1===t&&(this._boolType===r.MathAlg.Bool2dType.union||n.push(e));i.deleteWire(e)}}_generateOverlapFaces(e,t,n,s,i){if(!1===this._mergeFaceFlag)return void this._generateOverlapFacesForNotMergeFace(e,t,n,s);const o=e.facePair,a=o.isFaceSameDir,c=o.face1,l=o.face2,d=c.getSameDirWithSurface()===l.getSameDirWithSurface(),h=e.edgeEdgeKnots;if(e.faceEdgeKnots.length>0)throw new Error("Boolean3d: 两个重合face计算edge和face的交点有误！");const g=this._findBody1FaceAllNewXCoedges(c,n),f=this._findBody2FaceAllNewXCoedges(l,n),p=t.get(c)||[],_=t.get(l)||[];if(0===h.length&&0===p.length&&0===_.length&&0===g.length&&0===f.length&&this._boolType!==r.MathAlg.Bool2dType.union)return;let m;m=this._boolType===r.MathAlg.BoolType.difference?d:!d;const v=[],E=[];let P=c.getCoedge3ds(),y=l.getCoedge3ds();if(this._dealFaceCompletedWiresInPair(o,v,E),g.length>0)if(this._boolType===r.MathAlg.Bool2dType.union&&!a||this._boolType===r.MathAlg.Bool2dType.difference&&a){const e=[...g];e.push(...p),m&&_.map((e=>e.reverse())),e.push(..._);const t=u.searchWires(c.getSurface(),e,P);v.push(...t),this._deleteUsedCoedges(g,e),this._deleteUsedCoedges(p,e),this._deleteUsedCoedges(_,e),m&&_.map((e=>e.reverse()))}else{const e=[...g];e.push(...p),m&&(_.map((e=>e.reverse())),y.map((e=>e.reverse()))),e.push(..._);const t=P.concat(y),n=u.searchWires(c.getSurface(),e,t);v.push(...n),this._deleteUsedCoedges(g,e),this._deleteUsedCoedges(p,e),this._deleteUsedCoedges(_,e),m&&(_.map((e=>e.reverse())),l.getCoedge3ds().map((e=>e.reverse())))}if(P=c.getCoedge3ds(),y=l.getCoedge3ds(),f.length>0)if(this._boolType===r.MathAlg.Bool2dType.union&&!a||this._boolType===r.MathAlg.Bool2dType.difference&&a){const e=[...f];e.push(..._),m&&p.map((e=>e.reverse())),e.push(...p);const t=u.searchWires(l.getSurface(),e,y);E.push(...t),this._deleteUsedCoedges(f,e),this._deleteUsedCoedges(_,e),this._deleteUsedCoedges(p,e),m&&p.map((e=>e.reverse()))}else{const e=[...f];e.push(..._),m&&(p.map((e=>e.reverse())),P.map((e=>e.reverse()))),e.push(...p);const t=P.concat(y),n=u.searchWires(l.getSurface(),e,t);E.push(...n),this._deleteUsedCoedges(f,e),this._deleteUsedCoedges(_,e),this._deleteUsedCoedges(p,e),m&&(p.map((e=>e.reverse())),c.getCoedge3ds().map((e=>e.reverse())))}if(g.length>0&&f.length>0){const e=[...g];e.push(...p),m&&(f.map((e=>e.reverse())),_.map((e=>e.reverse())),y.map((e=>e.reverse()))),e.push(...f),e.push(..._);const t=P.concat(y),n=u.searchWires(c.getSurface(),e,t);v.push(...n),this._deleteUsedCoedges(p,e),this._deleteUsedCoedges(g,e),this._deleteUsedCoedges(_,e),this._deleteUsedCoedges(f,e),m&&(_.map((e=>e.reverse())),f.map((e=>e.reverse())),l.getCoedge3ds().map((e=>e.reverse())))}P=c.getCoedge3ds(),y=l.getCoedge3ds();const C=[];if(this._boolType===r.MathAlg.Bool2dType.intersect)if(_.length>0&&0===p.length){m&&P.map((e=>e.reverse()));const e=y.concat(P),t=u.searchWires(c.getSurface(),_,e);E.push(...t),m&&c.getCoedge3ds().map((e=>e.reverse()))}else{m&&(_.map((e=>e.reverse())),y.map((e=>e.reverse())));const e=p.concat(_),t=y.concat(P),n=u.searchWires(c.getSurface(),e,t);C.push(...n),this._deleteUsedCoedges(p,e),this._deleteUsedCoedges(_,e),m&&(_.map((e=>e.reverse())),l.getCoedge3ds().map((e=>e.reverse())))}else if(this._boolType===r.MathAlg.Bool2dType.union)if(a){m&&(y.map((e=>e.reverse())),_.map((e=>e.reverse())));const e=[],t=i.find((e=>e.overlapFaces.has(c)||e.overlapFaces.has(l)));t?(e.push(...t.restCoedges),t.overlapFaces.has(c)?(e.push(...y),e.push(..._)):(e.push(...P),e.push(...p))):(e.push(...P),e.push(...y),e.push(...p),e.push(..._));const n=u.searchWires(c.getSurface(),e,[]);if(C.push(...n),c.deleteAllWires(),l.deleteAllWires(),t)t.overlapFaces.add(c),t.overlapFaces.add(l),t.restCoedges=new Set(e);else{const t={overlapFaces:new Set([c,l]),restCoedges:new Set(e)};i.push(t)}}else{const e=u.searchWires(c.getSurface(),p,P),t=u.searchWires(l.getSurface(),_,y);v.push(...e),E.push(...t)}else if(this._boolType===r.MathAlg.Bool2dType.difference){if(_.length>0||y.length>0){const e=u.searchWires(l.getSurface(),_,y);E.push(...e)}m&&(_.map((e=>e.reverse())),y.map((e=>e.reverse())));const e=p.concat(_),t=P.concat(y),n=u.searchWires(c.getSurface(),e,t);v.push(...n),this._deleteUsedCoedges(p,e),this._deleteUsedCoedges(_,e),this._deleteUsedCoedges(y,t),m&&(_.map((e=>e.reverse())),l.getCoedge3ds().map((e=>e.reverse())))}this._boolType===r.MathAlg.Bool2dType.union&&a&&C.length>0&&(C.push(...v),v.splice(0,v.length),m&&E.map((e=>e.reverse())),C.push(...E),E.splice(0,E.length));const S=c.getSurface(),T=this._newFacesFromWires(S,c.getSameDirWithSurface(),v);for(const e of T)s.set(e,[c]);const b=this._newFacesFromWires(S,c.getSameDirWithSurface(),C);for(const e of b)s.set(e,[c,l]);const w=l.getSurface(),x=this._newFacesFromWires(w,l.getSameDirWithSurface(),E);for(const e of x)this._boolType===r.MathAlg.Bool2dType.difference&&e.reverse(),s.set(e,[l])}_generateOverlapFacesForNotMergeFace(e,t,n,s){const o=e.facePair,a=o.isFaceSameDir,c=o.face1,l=o.face2,d=c.getSameDirWithSurface()===l.getSameDirWithSurface(),h=e.edgeEdgeKnots;if(e.faceEdgeKnots.length>0)throw new Error("Boolean3d: 两个重合face计算edge和face的交点有误！");const g=this._findBody1FaceAllNewXCoedges(c,n),f=this._findBody2FaceAllNewXCoedges(l,n),p=t.get(c)||[],_=t.get(l)||[];if(0===h.length&&0===p.length&&0===_.length&&0===g.length&&0===f.length)return;let m;m=this._boolType===r.MathAlg.BoolType.difference?d:!d;const v=[],E=[];if(this._dealFaceCompletedWiresInPair(o,v,E),g.length>0){const e=[...g];e.push(...p);const t=u.searchWires(c.getSurface(),e,c.getCoedge3ds());v.push(...t),this._deleteUsedCoedges(g,e),this._deleteUsedCoedges(p,e)}if(f.length>0){const e=[...f];e.push(..._);const t=u.searchWires(l.getSurface(),e,l.getCoedge3ds());E.push(...t),this._deleteUsedCoedges(f,e),this._deleteUsedCoedges(_,e)}const P=[],y=c.getCoedge3ds(),C=l.getCoedge3ds();if(this._boolType===r.MathAlg.Bool2dType.intersect)if(_.length>0&&0===p.length){m&&y.map((e=>e.reverse()));const e=C.concat(y),t=u.searchWires(c.getSurface(),_,e);E.push(...t),m&&c.getCoedge3ds().map((e=>e.reverse()))}else{m&&(_.map((e=>e.reverse())),C.map((e=>e.reverse())));const e=p.concat(_),t=y.concat(C),n=u.searchWires(c.getSurface(),e,t);P.push(...n),this._deleteUsedCoedges(p,e),this._deleteUsedCoedges(_,e),m&&(_.map((e=>e.reverse())),l.getCoedge3ds().map((e=>e.reverse())))}else if(this._boolType===r.MathAlg.Bool2dType.union)if(!this._mergeFaceFlag&&a){if(y.length>0){const e=u.searchWires(c.getSurface(),y,p),t=u.searchWires(c.getSurface(),p,[]);v.push(...e,...t)}else{const e=u.searchWires(c.getSurface(),p,y);if(1===e.length){new i.Face(c.getSurface(),c.getSameDirWithSurface(),e).getWires()[0].calcLoop().calcArea()>r.Tolerance.EDGE_LENGTH_EPS2?(P.push(...e),P.push(...v),v.splice(0,v.length)):v.push(...e)}else v.push(...e)}if(C.length>0){const e=u.searchWires(l.getSurface(),C,_),t=u.searchWires(l.getSurface(),_,[]);E.push(...e,...t)}else{const e=u.searchWires(l.getSurface(),_,C);if(1===e.length){new i.Face(l.getSurface(),l.getSameDirWithSurface(),e).getWires()[0].calcLoop().calcArea()>r.Tolerance.EDGE_LENGTH_EPS2?(m&&(e.map((e=>e.reverse())),E.map((e=>e.reverse()))),P.push(...e),P.push(...E),E.splice(0,E.length)):E.push(...e)}else E.push(...e)}m&&_.map((e=>e.reverse()));const e=p.concat(_),t=u.searchWires(c.getSurface(),e,[]);P.push(...t),this._deleteUsedCoedges(p,e),this._deleteUsedCoedges(_,e),m&&_.map((e=>e.reverse()))}else if(a){m&&C.map((e=>e.reverse()));const e=[...y];e.push(...C);const t=u.searchWires(c.getSurface(),e,[]);P.push(...t)}else{const e=u.searchWires(c.getSurface(),p,y),t=u.searchWires(l.getSurface(),_,C);v.push(...e),E.push(...t)}else if(this._boolType===r.MathAlg.Bool2dType.difference){if(y.length>0){const e=u.searchWires(c.getSurface(),y,p);v.push(...e)}else{const e=u.searchWires(c.getSurface(),p,[]);v.push(...e)}if(0===p.length&&0===y.length){const e=u.searchWires(l.getSurface(),_,C);E.push(...e)}m&&(_.map((e=>e.reverse())),C.map((e=>e.reverse())));const e=p.concat(_),t=u.searchWires(c.getSurface(),e,y);if(P.push(...t),this._deleteUsedCoedges(p,e),this._deleteUsedCoedges(_,e),m&&(_.map((e=>e.reverse())),l.getCoedge3ds().map((e=>e.reverse()))),C.length>0){const e=u.searchWires(l.getSurface(),_,C);E.push(...e)}}const S=c.getSurface(),T=this._newFacesFromWires(S,c.getSameDirWithSurface(),v);for(const e of T)s.set(e,[c]);const b=this._newFacesFromWires(S,c.getSameDirWithSurface(),P);for(const e of b)s.set(e,[c,l]);const w=l.getSurface(),x=this._newFacesFromWires(w,l.getSameDirWithSurface(),E);for(const e of x)this._boolType===r.MathAlg.Bool2dType.difference&&e.reverse(),s.set(e,[l])}_generateEdgeFaceOverlaps(e,t,n){const s=e.getCurve(),i=s.getRange(),a=[],c=[],l=t.getEdges();for(const t of l){const n=this._edgeEdgeKnots.filter((n=>n.edge1===e&&n.edge2===t||n.edge2===e&&n.edge1===t));a.push(...n);for(const t of n){if(c.find((e=>e.xVt===t.newXVt)))continue;let n=t.edge1===e?t.xPtInfo.param1:t.xPtInfo.param2;i instanceof r.PeriodInterval&&(n=i.getRegularParam(n)),c.push({curveT:n,xVt:t.newXVt})}}const d=this._overlapVertexEdges.filter((t=>t.edge===e));for(const e of d){const t=e.vt;let n=s.getParamAt(t.getPoint());i instanceof r.PeriodInterval&&(n=i.getRegularParam(n)),c.push({curveT:n,xVt:t})}c.sort(((e,t)=>e.curveT-t.curveT));const[u,g]=h.getLeftAndRightCoedge(e),f=u.getFace(),p=g.getFace();this._edgeOriginTopoInfos.set(e,{leftCoedge:u,rightCoedge:g,leftFace:f,rightFace:p});const _=this._overlapEdgeEdges.filter((t=>t.edge1===e||t.edge2===e)),m=t=>{for(const n of _)if(n.edge1===e){for(const e of n.overlapInfos)if(e.range1.containsInterval(t,this._tol.numberEps))return!0}else for(const e of n.overlapInfos)if(e.range2.containsInterval(t,this._tol.numberEps))return!0;return!1},v=t.getSurface();if(0===c.length){if(m(s.getRange()))return;const i=s.getMidPt(),c=v.getUVAt(i);if(r.MathAlg.PositionJudge.ptToPolygon(c,n,this._tol.numberEps)!==r.MathAlg.PtLoopPositonType.OUT){const n=new o.Edge(s.clone(),e.getStartVertex(),e.getEndVertex()),r={edge:e,face:t,edgeFaces:[f,p],edgeEdgesKnots:a,overlapInfos:[{newEdge:n}]};this._overlapEdgeFaces.push(r)}return}const E=[];for(let t=0;t<c.length;t++){if(0===t){const o=(c[t].curveT+i.min)/2,a=s.getPtAt(o),l=v.getUVAt(a);if(r.MathAlg.PositionJudge.ptToPolygon(l,n,this._tol.numberEps/2)!==r.MathAlg.PtLoopPositonType.OUT){const n={min:i.min,stVt:e.getStartVertex(),max:c[t].curveT,endVt:c[t].xVt};E.push(n)}}else{const e=(c[t-1].curveT+c[t].curveT)/2,i=s.getPtAt(e),o=v.getUVAt(i);if(r.MathAlg.PositionJudge.ptToPolygon(o,n,this._tol.numberEps/2)!==r.MathAlg.PtLoopPositonType.OUT){const e={min:c[t-1].curveT,stVt:c[t-1].xVt,max:c[t].curveT,endVt:c[t].xVt};E.push(e)}}if(t===c.length-1){const o=(c[t].curveT+i.max)/2,a=s.getPtAt(o),l=v.getUVAt(a);if(r.MathAlg.PositionJudge.ptToPolygon(l,n,this._tol.numberEps/2)!==r.MathAlg.PtLoopPositonType.OUT){const n={min:c[t].curveT,stVt:c[t].xVt,max:i.max,endVt:e.getEndVertex()};E.push(n)}}}const P=[];for(const e of E){const t=s.clone(),n=t.getRange();if(n.min=e.min,n.max=e.max,m(n))continue;const r={newEdge:new o.Edge(t,e.stVt,e.endVt)};P.push(r)}if(P.length>0){const n={edge:e,face:t,edgeFaces:[f,p],edgeEdgesKnots:a,overlapInfos:P};this._overlapEdgeFaces.push(n)}}_generateEdgeEdgeOverlaps(e,t,n){const r=[],s=e.getCurve().getRange(),i=t.getCurve().getRange();for(const o of n)if(o.isOverlap){let n,a;if(Math.abs(o.overlap1.min-s.min)<this._tol.numberEps?n=e.getStartVertex():o.overlapSameDirection?Math.abs(o.overlap2.min-i.min)<this._tol.numberEps&&(n=t.getStartVertex()):Math.abs(o.overlap2.max-i.max)<this._tol.numberEps&&(n=t.getEndVertex()),Math.abs(o.overlap1.max-s.max)<this._tol.numberEps?a=e.getEndVertex():o.overlapSameDirection?Math.abs(o.overlap2.max-i.max)<this._tol.numberEps&&(a=t.getEndVertex()):Math.abs(o.overlap2.min-i.min)<this._tol.numberEps&&(a=t.getStartVertex()),void 0===n||void 0===a)throw new Error("Boolean3d: 重合edgeedge错误！");const c=o.overlapSameDirection,l={range1:o.overlap1,range2:o.overlap2,stVt:n,endVt:a,isSameDir:c};r.push(l)}if(r.length>0){const[n,s]=h.getLeftAndRightCoedge(e),i=n.getFace(),o=s.getFace();this._edgeOriginTopoInfos.set(e,{leftCoedge:n,rightCoedge:s,leftFace:i,rightFace:o});const[a,c]=h.getLeftAndRightCoedge(t),l=a.getFace(),d=c.getFace();this._edgeOriginTopoInfos.set(t,{leftCoedge:a,rightCoedge:c,leftFace:l,rightFace:d});const u={edge1:e,originCurve1:e.getCurve().clone(),edge1Faces:[i,o],edge2:t,originCurve2:t.getCurve().clone(),edge2Faces:[l,d],overlapInfos:r};this._overlapEdgeEdges.push(u)}}_addNewCoedgesToOverlapFacePairForOEE(e,t,n){const s=e.edge1,i=e.edge2,c=this._getVariables(s),[[l,u],[h,f]]=[c.faces,c.coedges],p=this._getVariables(i),[[_,m],[v,E]]=[p.faces,p.coedges];let P=4;l===u&&P--,_===m&&P--;const y=[],C=new Set;for(const e of this._overlapFacePairs)(e.face1===l&&e.face2===_||e.face1===l&&e.face2===m||e.face1===u&&e.face2===_||e.face1===u&&e.face2===m)&&(C.add(e.face1),C.add(e.face2),y.push(e));const S=s.getCurve().clone();S.setRange(t.range1);const T=new o.Edge(S,t.stVt,t.endVt);if(this._nonManifoldEdgeMap)for(const e of this._nonManifoldEdgeMap){const t=e[1];for(const e of t)e.newEdge!==s&&e.newEdge!==i||e.overlapNewEdgeSegs.push(T)}const b=()=>{const e=h.getSameDirWithEdge(),r=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[r]);const s=f.getSameDirWithEdge(),i=new a.Coedge3d(T,s);this._faceAddCoedges(n,u,[i]);const o=v.getSameDirWithEdge()===t.isSameDir,c=new a.Coedge3d(T,o);this._faceAddCoedges(n,_,[c]);const d=E.getSameDirWithEdge()===t.isSameDir,g=new a.Coedge3d(T,d);this._faceAddCoedges(n,m,[g])},w=e=>{if(e.position1===g.PositionType.OUT||e.position1===g.PositionType.OUTIN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}else e.position1===g.PositionType.IN||(e.position1,g.PositionType.INOUT);if(e.position1===g.PositionType.OUT||e.position1===g.PositionType.INOUT){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}else e.position1===g.PositionType.IN||(e.position1,g.PositionType.OUTIN);if(e.position2===g.PositionType.OUT||e.position2===g.PositionType.OUTIN){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}else e.position2===g.PositionType.IN||(e.position2,g.PositionType.INOUT);if(e.position2===g.PositionType.OUT||e.position2===g.PositionType.INOUT){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}else e.position2===g.PositionType.IN||(e.position2,g.PositionType.OUTIN)},x=()=>{if(!C.has(l)){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}if(!C.has(u)){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}if(!C.has(_)){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}if(!C.has(m)){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}},M=()=>{const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t]);const r=f.getSameDirWithEdge(),s=new a.Coedge3d(T,r);this._faceAddCoedges(n,u,[s])},N=()=>{const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r]);const s=E.getSameDirWithEdge()===t.isSameDir,i=new a.Coedge3d(T,s);this._faceAddCoedges(n,m,[i])};if(C.size===P){const e=y[0].isFaceSameDir,s=y[1].isFaceSameDir;if(e&&s){const e=d.FaceFaceAnalysis.EdgeFacesAndEdgeFaces(S,t.isSameDir,[l,u],[_,m],y,this._tol.lengthEps);t.facesPos=e,this._boolType===r.MathAlg.Bool2dType.intersect?e.position1===g.PositionType.IN&&e.position2===g.PositionType.IN||e.position1===g.PositionType.IN?M():e.position2===g.PositionType.IN&&N():this._boolType===r.MathAlg.Bool2dType.union?e.position1===g.PositionType.IN&&e.position2===g.PositionType.IN||e.position1===g.PositionType.OUT?M():e.position2===g.PositionType.OUT&&N():e.position1===g.PositionType.IN&&e.position2===g.PositionType.IN||(e.position1===g.PositionType.OUT?b():(e.position2,g.PositionType.OUT))}else if(e||s){const s=d.FaceFaceAnalysis.EdgeFacesAndEdgeFaces(S,t.isSameDir,[l,u],[_,m],y,this._tol.lengthEps);if(t.facesPos=s,this._boolType===r.MathAlg.Bool2dType.intersect)s.position1===g.PositionType.IN?M():s.position2===g.PositionType.IN&&N();else if(this._boolType===r.MathAlg.Bool2dType.union)s.position1===g.PositionType.IN?N():s.position2===g.PositionType.IN?M():this._mergeFaceFlag||w(s);else if(s.position1===g.PositionType.IN);else if(s.position2===g.PositionType.IN)if(e){const e=y[1].face1,r=e===l?h.getSameDirWithEdge():f.getSameDirWithEdge(),s=new a.Coedge3d(T,r);this._faceAddCoedges(n,e,[s]);const i=y[1].face2,o=i===_?v.getSameDirWithEdge()===t.isSameDir:E.getSameDirWithEdge()===t.isSameDir,c=new a.Coedge3d(T,o);this._faceAddCoedges(n,i,[c])}else{const e=y[0].face1,r=e===l?h.getSameDirWithEdge():f.getSameDirWithEdge(),s=new a.Coedge3d(T,r);this._faceAddCoedges(n,e,[s]);const i=y[0].face2,o=i===_?v.getSameDirWithEdge()===t.isSameDir:E.getSameDirWithEdge()===t.isSameDir,c=new a.Coedge3d(T,o);this._faceAddCoedges(n,i,[c])}else M()}else if(this._boolType===r.MathAlg.Bool2dType.intersect);else if(this._boolType===r.MathAlg.Bool2dType.union){const e=d.FaceFaceAnalysis.EdgeFacesAndEdgeFaces(S,t.isSameDir,[l,u],[_,m],y,this._tol.lengthEps);t.facesPos=e,e.position1===g.PositionType.IN&&e.position2===g.PositionType.IN||b()}else M();return}const A=d.FaceFaceAnalysis.EdgeFacesAndEdgeFaces(S,t.isSameDir,[l,u],[_,m],y,this._tol.lengthEps);t.facesPos=A;const O=y[0].isFaceSameDir;if(this._boolType===r.MathAlg.Bool2dType.intersect)if(A.position1===g.PositionType.IN&&A.position2===g.PositionType.IN)x();else if(A.position1===g.PositionType.IN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t]);const r=f.getSameDirWithEdge(),s=new a.Coedge3d(T,r);this._faceAddCoedges(n,u,[s])}else if(A.position2===g.PositionType.IN){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r]);const s=E.getSameDirWithEdge()===t.isSameDir,i=new a.Coedge3d(T,s);this._faceAddCoedges(n,m,[i])}else if(A.position1===g.PositionType.OUT||A.position2===g.PositionType.OUT);else if(O){if(A.position1===g.PositionType.INOUT){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}if(A.position1===g.PositionType.OUTIN){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}if(A.position2===g.PositionType.INOUT){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}if(A.position2===g.PositionType.OUTIN){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}}else if(C.size>2);else{const e=A.position1===g.PositionType.INOUT?l:u,r=A.position2===g.PositionType.INOUT?_:m;if(e===y[0].face1&&r===y[0].face2);else{if(A.position1===g.PositionType.INOUT){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}else if(A.position1===g.PositionType.OUTIN){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}if(A.position2===g.PositionType.INOUT){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}else if(A.position2===g.PositionType.OUTIN){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}}}else if(this._boolType===r.MathAlg.Bool2dType.union)if(A.position1===g.PositionType.IN&&A.position2===g.PositionType.IN);else if(A.position1===g.PositionType.IN){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r]);const s=E.getSameDirWithEdge()===t.isSameDir,i=new a.Coedge3d(T,s);this._faceAddCoedges(n,m,[i])}else if(A.position2===g.PositionType.IN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t]);const r=f.getSameDirWithEdge(),s=new a.Coedge3d(T,r);this._faceAddCoedges(n,u,[s])}else if(A.position1===g.PositionType.OUT||A.position2===g.PositionType.OUT)b();else if(O)if(this._mergeFaceFlag);else{if(A.position1===g.PositionType.OUTIN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}else A.position1,g.PositionType.INOUT;if(A.position1===g.PositionType.INOUT){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}else A.position1,g.PositionType.OUTIN;if(A.position2===g.PositionType.OUTIN){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}else A.position2,g.PositionType.INOUT;if(A.position2===g.PositionType.INOUT){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}else A.position2,g.PositionType.OUTIN}else{if(A.position1===g.PositionType.OUTIN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}else A.position1,g.PositionType.INOUT;if(A.position1===g.PositionType.INOUT){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}else A.position1,g.PositionType.OUTIN;if(A.position2===g.PositionType.OUTIN){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}else A.position2,g.PositionType.INOUT;if(A.position2===g.PositionType.INOUT){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}else A.position2,g.PositionType.OUTIN}else if(this._boolType===r.MathAlg.Bool2dType.difference)if(A.position1===g.PositionType.IN&&A.position2===g.PositionType.IN){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r]);const s=E.getSameDirWithEdge()===t.isSameDir,i=new a.Coedge3d(T,s);this._faceAddCoedges(n,m,[i])}else if(A.position1===g.PositionType.IN);else if(A.position2===g.PositionType.IN)if(A.position1===g.PositionType.OUT)b();else if(3===C.size)if(C.has(l))if(C.has(u)){if(C.has(_)){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}else{const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}if(A.position1===g.PositionType.OUTIN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}else{const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}}else{const e=f.getSameDirWithEdge(),r=new a.Coedge3d(T,e);if(this._faceAddCoedges(n,u,[r]),t.isSameDir){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}else{const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}}else{const e=h.getSameDirWithEdge(),r=new a.Coedge3d(T,e);if(this._faceAddCoedges(n,l,[r]),t.isSameDir){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}else{const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}}else x();else if(A.position1===g.PositionType.OUT||A.position2===g.PositionType.OUT){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t]);const r=f.getSameDirWithEdge(),s=new a.Coedge3d(T,r);this._faceAddCoedges(n,u,[s])}else if(O){if(A.position1===g.PositionType.OUTIN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}if(A.position1===g.PositionType.INOUT){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}if(A.position2===g.PositionType.INOUT){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}if(A.position2===g.PositionType.OUTIN){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}}else if(C.size>2){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t]);const r=f.getSameDirWithEdge(),s=new a.Coedge3d(T,r);this._faceAddCoedges(n,u,[s])}else{const e=A.position1===g.PositionType.INOUT?l:u,r=A.position2===g.PositionType.INOUT?_:m;if(e===y[0].face1&&r===y[0].face2){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t]);const r=f.getSameDirWithEdge(),s=new a.Coedge3d(T,r);this._faceAddCoedges(n,u,[s])}else{if(A.position1===g.PositionType.OUTIN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,l,[t])}else if(A.position1===g.PositionType.INOUT){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(T,e);this._faceAddCoedges(n,u,[t])}if(A.position2===g.PositionType.INOUT){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,_,[r])}else if(A.position2===g.PositionType.OUTIN){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(T,e);this._faceAddCoedges(n,m,[r])}}}}_addNewCoedgesForOEE(e,t,n){const s=e.edge1,i=e.edge2,c=this._getVariables(s),[[l,u],[h,f]]=[c.faces,c.coedges],p=this._getVariables(i),[[_,m],[v,E]]=[p.faces,p.coedges],P=s.getCurve().clone();P.setRange(t.range1);const y=new o.Edge(P,t.stVt,t.endVt);if(this._nonManifoldEdgeMap)for(const e of this._nonManifoldEdgeMap){const t=e[1];for(const e of t)e.newEdge!==s&&e.newEdge!==i||e.overlapNewEdgeSegs.push(y)}const C=d.FaceFaceAnalysis.EdgeFacesAndEdgeFaces(P,t.isSameDir,[l,u],[_,m],[],this._tol.lengthEps);if(t.facesPos=C,this._boolType===r.MathAlg.Bool2dType.intersect){if(C.position1===g.PositionType.IN||C.position1===g.PositionType.INOUT){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(y,e);this._faceAddCoedges(n,l,[t])}else C.position1===g.PositionType.OUT||(C.position1,g.PositionType.OUTIN);if(C.position1===g.PositionType.IN||C.position1===g.PositionType.OUTIN){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(y,e);this._faceAddCoedges(n,u,[t])}else C.position1===g.PositionType.OUT||(C.position1,g.PositionType.INOUT);if(C.position2===g.PositionType.IN||C.position2===g.PositionType.INOUT){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(y,e);this._faceAddCoedges(n,_,[r])}else C.position2===g.PositionType.OUT||(C.position2,g.PositionType.OUTIN);if(C.position2===g.PositionType.IN||C.position2===g.PositionType.OUTIN){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(y,e);this._faceAddCoedges(n,m,[r])}else C.position2===g.PositionType.OUT||(C.position2,g.PositionType.INOUT)}else if(this._boolType===r.MathAlg.Bool2dType.union){if(C.position1===g.PositionType.OUT||C.position1===g.PositionType.OUTIN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(y,e);this._faceAddCoedges(n,l,[t])}else C.position1===g.PositionType.IN||(C.position1,g.PositionType.INOUT);if(C.position1===g.PositionType.OUT||C.position1===g.PositionType.INOUT){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(y,e);this._faceAddCoedges(n,u,[t])}else C.position1===g.PositionType.IN||(C.position1,g.PositionType.OUTIN);if(C.position2===g.PositionType.OUT||C.position2===g.PositionType.OUTIN){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(y,e);this._faceAddCoedges(n,_,[r])}else C.position2===g.PositionType.IN||(C.position2,g.PositionType.INOUT);if(C.position2===g.PositionType.OUT||C.position2===g.PositionType.INOUT){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(y,e);this._faceAddCoedges(n,m,[r])}else C.position2===g.PositionType.IN||(C.position2,g.PositionType.OUTIN)}else if(this._boolType===r.MathAlg.Bool2dType.difference){if(C.position1===g.PositionType.OUT||C.position1===g.PositionType.OUTIN){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(y,e);this._faceAddCoedges(n,l,[t])}else C.position1===g.PositionType.IN||(C.position1,g.PositionType.INOUT);if(C.position1===g.PositionType.OUT||C.position1===g.PositionType.INOUT){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(y,e);this._faceAddCoedges(n,u,[t])}else C.position1===g.PositionType.IN||(C.position1,g.PositionType.OUTIN);if(C.position2===g.PositionType.IN||C.position2===g.PositionType.INOUT){const e=v.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(y,e);this._faceAddCoedges(n,_,[r])}else C.position2===g.PositionType.OUT||(C.position2,g.PositionType.OUTIN);if(C.position2===g.PositionType.IN||C.position2===g.PositionType.OUTIN){const e=E.getSameDirWithEdge()===t.isSameDir,r=new a.Coedge3d(y,e);this._faceAddCoedges(n,m,[r])}else C.position2===g.PositionType.OUT||(C.position2,g.PositionType.INOUT)}}_dealOverlapEdgeEdges(e,t){const n=new Set,s=new Set;for(const t of this._overlapEdgeEdges){const r=t.edge1,i=t.edge2,o=t.edge1Faces,a=t.edge2Faces,c=this._overlapFacePairs.find((e=>o.find((t=>t===e.face1))&&a.find((t=>t===e.face2))));for(const n of t.overlapInfos)c?this._addNewCoedgesToOverlapFacePairForOEE(t,n,e):this._addNewCoedgesForOEE(t,n,e);n.add(r),s.add(i)}const i=new Set;for(const e of n){if(this._overlapEdgeFaces.find((t=>t.edge===e)))continue;t.set(e,e.getCurve().clone());const{edge1FaceKnots:n,edge1EdgeKnots:s,edge1OverlapVtKnots:o}=this._getAllKnotsForBody1Edge(e),c=this._boolType!==r.MathAlg.BoolType.intersect,l=this._splitEdge(e,n,s,o,c);let d=!0;const u=e.getCoedge3ds(),h=this._overlapEdgeEdges.filter((t=>t.edge1===e));for(const e of l){const t=e.getCurve().getRange();if(!h.find((e=>e.overlapInfos.find((e=>e.range1.containsInterval(t,this._tol.numberEps))))))if(1!==l.length)for(const t of u){const n=new a.Coedge3d(e,t.getSameDirWithEdge()),r=t.getWire(),s=t.getIndexInWire(),i=t.getSameDirWithEdge()?s:s+1;r.insertCoedge3d(i,n)}else d=!1}d&&i.add(e)}for(const e of s){if(this._overlapEdgeFaces.find((t=>t.edge===e)))continue;t.set(e,e.getCurve().clone());const{edge2FaceKnots:n,edge2EdgeKnots:s,edge2OverlapVtKnots:o}=this._getAllKnotsForBody2Edge(e),c=this._boolType===r.MathAlg.BoolType.union,l=this._splitEdge(e,n,s,o,c);let d=!0;const u=e.getCoedge3ds(),h=this._overlapEdgeEdges.filter((t=>t.edge2===e));for(const e of l){const t=e.getCurve().getRange();if(!h.find((e=>e.overlapInfos.find((e=>e.range2.containsInterval(t,this._tol.numberEps))))))if(1!==l.length)for(const t of u){const n=new a.Coedge3d(e,t.getSameDirWithEdge()),r=t.getWire(),s=t.getIndexInWire(),i=t.getSameDirWithEdge()?s:s+1;r.insertCoedge3d(i,n)}else d=!1}d&&i.add(e)}for(const e of i)this._deleteEdgeCoedges(e),e.getShell().deleteEdge(e);return e}_addNewCoedgesToOverlapFacePairForOEF(e,t,n,s){const i=e.edge,o=e.face,c=this._getVariables(i),[[l,u],[h,f]]=[c.faces,c.coedges],p=t.newEdge,_=p.getCurve(),m=d.FaceFaceAnalysis.FaceAndEdgeFaces(o,_,[l,u],n,this._tol.lengthEps);t.facesPos=m;const v=n[0],E=v.isFaceSameDir,P=()=>{const t=e.edgeFaces;for(const e of t){if(v.face1===e||v.face2===e)continue;if(void 0===this._overlapFacePairs.find((t=>t.face1===o&&t.face2===e||t.face2===o&&t.face1===e)))return!1}return!0},y=()=>{const e=h.getSameDirWithEdge(),t=new a.Coedge3d(p,e);this._faceAddCoedges(s,l,[t]);const n=f.getSameDirWithEdge(),r=new a.Coedge3d(p,n);this._faceAddCoedges(s,u,[r])},C=()=>{if(v.face1===l||v.face2===l){const e=h.getSameDirWithEdge(),t=new a.Coedge3d(p,e);this._faceAddCoedges(s,l,[t]);const n=l.getSameDirWithSurface()===o.getSameDirWithSurface(),r=v.isFaceSameDir===n?!e:e,i=new a.Coedge3d(p,r);this._faceAddCoedges(s,o,[i])}else{const e=f.getSameDirWithEdge(),t=new a.Coedge3d(p,e);this._faceAddCoedges(s,u,[t]);const n=u.getSameDirWithSurface()===o.getSameDirWithSurface(),r=v.isFaceSameDir===n?!e:e,i=new a.Coedge3d(p,r);this._faceAddCoedges(s,o,[i])}},S=()=>{if(v.face1===l||v.face2===l){const e=f.getSameDirWithEdge(),t=new a.Coedge3d(p,e);this._faceAddCoedges(s,u,[t]);const n=h.getSameDirWithEdge(),i=l.getSameDirWithSurface()===o.getSameDirWithSurface()?n:!n,c=new a.Coedge3d(p,i);this._boolType===r.MathAlg.Bool2dType.difference&&c.reverse(),this._faceAddCoedges(s,o,[c])}else{const e=h.getSameDirWithEdge(),t=new a.Coedge3d(p,e);this._faceAddCoedges(s,l,[t]);const n=f.getSameDirWithEdge(),i=u.getSameDirWithSurface()===o.getSameDirWithSurface()?n:!n,c=new a.Coedge3d(p,i);this._boolType===r.MathAlg.Bool2dType.difference&&c.reverse(),this._faceAddCoedges(s,o,[c])}};if(this._boolType===r.MathAlg.Bool2dType.intersect)if(E)if(m.position2===g.PositionType.IN)y();else{if(m.position2!==g.PositionType.INOUT&&m.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position");!1===this._mergeFaceFlag&&C()}else m.position2===g.PositionType.IN&&(P()||S());else if(this._boolType===r.MathAlg.Bool2dType.union)if(E)if(m.position2===g.PositionType.IN)!1===this._mergeFaceFlag&&C();else{if(m.position2!==g.PositionType.INOUT&&m.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position");y()}else if(m.position2===g.PositionType.IN);else{if(m.position2!==g.PositionType.INOUT&&m.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position");S()}else if(this._boolType===r.MathAlg.Bool2dType.difference)if(o.getShell()===this._body1)if(E){if(m.position2===g.PositionType.IN)P()||S();else if(m.position2!==g.PositionType.INOUT&&m.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position")}else if(m.position2===g.PositionType.IN)P()?!1===this._mergeFaceFlag&&y():this._mergeFaceFlag?S():y();else{if(m.position2!==g.PositionType.INOUT&&m.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position");!1===this._mergeFaceFlag&&C()}else if(E)if(m.position2===g.PositionType.IN);else{if(m.position2!==g.PositionType.INOUT&&m.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position");S()}else if(m.position2===g.PositionType.IN)m.position1===g.PositionType.IN?P()?y():C():!1===this._mergeFaceFlag&&C();else{if(m.position2!==g.PositionType.INOUT&&m.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position");y()}}_dealOverlapEdgeFaces(e,t){const n=new Set;for(const t of this._overlapEdgeFaces){const s=t.edge,i=t.face,o=i.getSameDirWithSurface(),c=this._getVariables(s),[[l,u],[h,f]]=[c.faces,c.coedges],p=[];for(const e of this._overlapFacePairs)(e.face1!==i||e.face2!==l&&e.face2!==u)&&(e.face2!==i||e.face1!==l&&e.face1!==u)||p.push(e);const _=(t,n,r)=>{if(!(p.length>0))if(r)if(n.position1===g.PositionType.IN);else if(n.position1===g.PositionType.OUT){const n=new a.Coedge3d(t,!0),r=new a.Coedge3d(t,!1);this._faceAddCoedges(e,i,[n,r])}else{let r=o;if(n.position2===g.PositionType.INOUT);else{if(n.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position");r=!o}const s=new a.Coedge3d(t,r);this._faceAddCoedges(e,i,[s])}else if(n.position1===g.PositionType.IN){const n=new a.Coedge3d(t,!0),r=new a.Coedge3d(t,!1);this._faceAddCoedges(e,i,[n,r])}else if(n.position1===g.PositionType.OUT);else if(n.position1===g.PositionType.OUTIN||n.position1===g.PositionType.INOUT){let r=o;if(n.position2===g.PositionType.INOUT)r=!o;else if(n.position2!==g.PositionType.OUTIN)throw new Error("Boolean3d: wrong face face position");const s=new a.Coedge3d(t,r);this._faceAddCoedges(e,i,[s])}},m=(t,n,r)=>{if(r){if(n.position2===g.PositionType.OUT||n.position2===g.PositionType.OUTIN){const n=h.getSameDirWithEdge(),r=new a.Coedge3d(t,n);this._faceAddCoedges(e,l,[r])}else n.position2===g.PositionType.IN||(n.position2,g.PositionType.INOUT);if(n.position2===g.PositionType.OUT||n.position2===g.PositionType.INOUT){const n=f.getSameDirWithEdge(),r=new a.Coedge3d(t,n);this._faceAddCoedges(e,u,[r])}else n.position2===g.PositionType.IN||(n.position2,g.PositionType.OUTIN)}else{if(n.position2===g.PositionType.IN||n.position2===g.PositionType.INOUT){const n=h.getSameDirWithEdge(),r=new a.Coedge3d(t,n);this._faceAddCoedges(e,l,[r])}else n.position2===g.PositionType.OUT||(n.position2,g.PositionType.OUTIN);if(n.position2===g.PositionType.IN||n.position2===g.PositionType.OUTIN){const n=f.getSameDirWithEdge(),r=new a.Coedge3d(t,n);this._faceAddCoedges(e,u,[r])}else n.position2===g.PositionType.OUT||(n.position2,g.PositionType.INOUT)}},v=e=>{const t=e.newEdge,n=t.getCurve(),s=d.FaceFaceAnalysis.FaceAndEdgeFaces(i,n,[l,u],[]);e.facesPos=s,this._boolType===r.MathAlg.Bool2dType.intersect?(_(t,s,!1),m(t,s,!1)):this._boolType===r.MathAlg.Bool2dType.union?(_(t,s,!0),m(t,s,!0)):this._boolType===r.MathAlg.Bool2dType.difference&&(i.getShell()===this._body1?(_(t,s,!0),m(t,s,!1)):(_(t,s,!1),m(t,s,!0)))};for(const n of t.overlapInfos)p.length>0?this._addNewCoedgesToOverlapFacePairForOEF(t,n,p,e):v(n);n.add(s)}for(const e of n){if(t.has(e))continue;let n;if(t.set(e,e.getCurve().clone()),e.getShell()===this._body1){const{edge1FaceKnots:t,edge1EdgeKnots:s,edge1OverlapVtKnots:i}=this._getAllKnotsForBody1Edge(e),o=this._boolType!==r.MathAlg.BoolType.intersect;n=this._splitEdge(e,t,s,i,o)}else{const{edge2FaceKnots:t,edge2EdgeKnots:s,edge2OverlapVtKnots:i}=this._getAllKnotsForBody2Edge(e),o=this._boolType===r.MathAlg.BoolType.union;n=this._splitEdge(e,t,s,i,o)}let s=!0;const i=e.getCoedge3ds(),o=this._overlapEdgeEdges.filter((t=>t.edge1===e||t.edge2===e)),c=(t,n)=>t.edge1===e?t.overlapInfos.find((e=>e.range1.containsInterval(n,this._tol.numberEps))):t.overlapInfos.find((e=>e.range2.containsInterval(n,this._tol.numberEps))),l=this._overlapEdgeFaces.filter((t=>t.edge===e));for(const e of n){const t=e.getCurve().getRange();if(o.find((e=>c(e,t))))continue;if(!l.find((e=>e.overlapInfos.find((e=>e.newEdge.getCurve().getRange().containsInterval(t,this._tol.numberEps))))))if(1!==n.length)for(const t of i){const n=new a.Coedge3d(e,t.getSameDirWithEdge()),r=t.getWire(),s=t.getIndexInWire(),i=t.getSameDirWithEdge()?s:s+1;r.insertCoedge3d(i,n)}else s=!1}s&&(this._deleteEdgeCoedges(e),e.getShell().deleteEdge(e))}}_dealVertexVertexOverlaps(){for(const e of this._overlapVertexVertexs){const t=e.vt2.getEdges();for(const n of t)n.getStartVertex()===e.vt2&&n.setStartVertex(e.vt1),n.getEndVertex()===e.vt2&&n.setEndVertex(e.vt1);this._body2.addVertex(e.vt2)}}_findNoSplitWiresInFace(e){const t=[];for(const n of e.getWires()){if(0===n.getCoedge3ds().length)continue;let e=!0;for(let t=0;t<n.getCoedge3ds().length;t++){const r=n.getCoedge3ds()[t],s=n.getCoedge3ds()[(t+1)%n.getCoedge3ds().length];r.getEndVertex()!==s.getStartVertex()&&(e=!1)}if(!e)continue;let r=!1;for(const e of n.getCoedge3ds())if(this._splitedEdgeInfos.has(e.getEdge())){r=!0;break}if(r)continue;n.getCoedge3ds().find((e=>!e.getEdge().isDegenerate()))&&t.push(n)}return t}_wireAndFacePostion(e,t){let n;const s=e.getCoedge3ds().map((e=>e.getStartVertex()));for(const e of s){if(this._overlapEdgeEdges.find((t=>t.edge1.getStartVertex()===e||t.edge1.getEndVertex()===e||t.edge2.getStartVertex()===e||t.edge2.getEndVertex()===e)))continue;if(!this._overlapVertexVertexs.find((t=>t.vt1===e||t.vt2===e))){n=e.getPoint();break}}if(!n){for(const t of e.getCoedge3ds()){const e=t.getEdge();this._overlapEdgeEdges.find((t=>t.edge1===e||t.edge2===e))||(n=e.getCurve().getMidPt())}if(!n)return 0}let i=this._facePolyMap.get(t);i||(i=t.calcPolygon());const o=t.getSurface().getUVAt(n);return r.MathAlg.PositionJudge.ptToPolygon(o,i,this._tol.numberEps)===r.MathAlg.PtLoopPositonType.OUT?1:-1}_wireAndBodyPostion(e,t){let n;const r=e.getCoedge3ds().map((e=>e.getStartVertex()));for(const e of r){if(this._overlapEdgeEdges.find((t=>t.edge1.getStartVertex()===e||t.edge1.getEndVertex()===e||t.edge2.getStartVertex()===e||t.edge2.getEndVertex()===e)))continue;if(!this._overlapVertexVertexs.find((t=>t.vt1===e||t.vt2===e))){n=e.getPoint();break}}if(!n){for(const t of e.getCoedge3ds()){const e=t.getEdge();this._overlapEdgeEdges.find((t=>t.edge1===e||t.edge2===e))||(n=e.getCurve().getMidPt())}if(!n)return 0}return this._pointToBodyPosition(n,t)}_BodyBodyPosition(){let e=g.PositionType.UNKWON,t=g.PositionType.UNKWON;if(this._overlapEdgeFaces.length>0){for(const n of this._overlapEdgeFaces){const r=n.face,s=n.overlapInfos;for(const n of s){const s={position1:n.facesPos.position1,position2:n.facesPos.position2};if(r.getShell()===this._body2&&([s.position1,s.position2]=[s.position2,s.position1]),e!==g.PositionType.OUT&&(e=s.position1===g.PositionType.IN?g.PositionType.IN:s.position1===g.PositionType.UNKWON?g.PositionType.UNKWON:g.PositionType.OUT),t!==g.PositionType.OUT&&(t=s.position2===g.PositionType.IN?g.PositionType.IN:s.position2===g.PositionType.UNKWON?g.PositionType.UNKWON:g.PositionType.OUT),e===g.PositionType.OUT&&t===g.PositionType.OUT)return m.BrepBodyPositionType.OUTSIDE}}if(e===g.PositionType.IN&&t===g.PositionType.IN)return m.BrepBodyPositionType.EQUAL;if(e===g.PositionType.IN&&t===g.PositionType.OUT)return m.BrepBodyPositionType.INSIDE;if(e===g.PositionType.OUT&&t===g.PositionType.IN)return m.BrepBodyPositionType.CONTAIN}if(this._overlapEdgeEdges.length>0){for(const n of this._overlapEdgeEdges){const r=n.edge1,s=n.edge2,i=this._getVariables(r),o=this._getVariables(s),a=n.overlapInfos;for(const n of a){if(!n.facesPos){const e=r.getCurve().clone();e.setRange(n.range1),n.facesPos=d.FaceFaceAnalysis.EdgeFacesAndEdgeFaces(e,n.isSameDir,i.faces,o.faces,[],this._tol.lengthEps)}if(e!==g.PositionType.OUT&&(e=n.facesPos.position1===g.PositionType.IN?g.PositionType.IN:n.facesPos.position1===g.PositionType.UNKWON?g.PositionType.UNKWON:g.PositionType.OUT),t!==g.PositionType.OUT&&(t=n.facesPos.position2===g.PositionType.IN?g.PositionType.IN:n.facesPos.position2===g.PositionType.UNKWON?g.PositionType.UNKWON:g.PositionType.OUT),e===g.PositionType.OUT&&t===g.PositionType.OUT)return m.BrepBodyPositionType.OUTSIDE}}if(e===g.PositionType.IN&&t===g.PositionType.IN)return m.BrepBodyPositionType.EQUAL;if(e===g.PositionType.IN&&t===g.PositionType.OUT)return m.BrepBodyPositionType.INSIDE;if(e===g.PositionType.OUT&&t===g.PositionType.IN)return m.BrepBodyPositionType.CONTAIN}throw new Error("Boolean3d： body与body位置关系错误")}_pointToBodyPosition(e,t){let n=0;for(;n<20;){n++;const s=new r.Vector3(Math.random(),Math.random(),Math.random()),i=new r.Line3d(e,s,[0,r.CONST.MODEL_MAX_LENGTH]);let o=!1;const a=[];for(const e of t.getFaces()){let t=this._facePolyMap.get(e);t||(t=e.calcPolygon(),this._facePolyMap.set(e,t));const n=t.getLoops()[0].getBoundingBox(),s=e.getSurface(),c=[s.getDomainU().set(n.min.x,n.max.x),s.getDomainV().set(n.min.y,n.max.y)],l=r.MathAlg.CalculateIntersect.curveSurfaceAll(i,s,this._tol,c);for(const e of l){if(s.getNormAt(e.surfaceUV).isPerpendicular(i.getDirection(),this._tol.angleEps)){o=!0;break}const n=r.MathAlg.PositionJudge.ptToPolygon(new r.Vector2(e.surfaceUV),t,this._tol.numberEps);if(n===r.MathAlg.PtLoopPositonType.ONEDGE||n===r.MathAlg.PtLoopPositonType.ONVERTEX){o=!0;break}n!==r.MathAlg.PtLoopPositonType.OUT&&a.push(e.point)}if(o)break}if(!o)return a.length%2==0?1:-1}return 0}_curveVertex(e,t,n,s){const i=e.getCurve(),o=n.getShell().getFaces(),a=e=>{const t=i.getPtAt(e),s=this._vertexOriginTopoInfos.get(n),a=(null==s?void 0:s.origEdges)||n.getEdges();for(const e of a){if((this._splitedEdgeInfos.get(e)||e.getCurve()).containsPoint(t,this._tol.lengthEps))return-1}const c=(null==s?void 0:s.origFaces)||n.getFaces(),l=new Set([...c,...o]);let d=0;for(;d<20;){d++;const e=new r.Vector3(Math.random(),Math.random(),Math.random()),n=new r.Line3d(t,e,[0,r.CONST.MODEL_MAX_LENGTH]);let s=!1;for(const e of a){const t=e.getCurve();if(r.MathAlg.CalculateIntersect.curve3ds(n,t,this._tol).length>0){s=!0;break}}if(s)continue;const i=[];for(const e of l){let t=this._facePolyMap.get(e);t||(t=e.calcPolygon(),this._facePolyMap.set(e,t));const o=t.getLoops()[0].getBoundingBox(),a=e.getSurface(),c=a.getDomainU(),l=a.getDomainV(),d=[c.clone().set(o.min.x,o.max.x),l.clone().set(o.min.y,o.max.y)],u=r.MathAlg.CalculateIntersect.curveSurfaceAll(n,a,this._tol,d);for(const e of u){if(a.getNormAt(e.surfaceUV).isPerpendicular(n.getDirection(),this._tol.angleEps)){s=!0;break}if(r.MathAlg.PositionJudge.ptToPolygon(new r.Vector2(e.surfaceUV),t,this._tol.numberEps)!==r.MathAlg.PtLoopPositonType.OUT){if(e.curveT<this._tol.lengthEps)return-1;i.push(e.point)}}if(s)break}if(!s)return i.length%2==0?1:-1}return 0};let c;if(s)c=s/2;else{const e=i.getRange();c=e.getLength()<.001?e.getLength()/2:.01}return{prev:a(t-c),next:a(t+c)}}_sortXCurveVts(e,t){const n=[];for(const r of e){const e=t.getParamAt(r.getPoint());n.push({newXVt:r,param:e})}n.sort(((e,t)=>e.param-t.param));const r=n.map((e=>e.newXVt));return e.splice(0,e.length,...r),n.map((e=>e.param))}_getOverlapFacePairs(){const e=[],t=[],n=[];for(const n of this._body1.getFaces())n.getSurface().isPlane()?e.push(n):t.push(n);for(const t of this._body2.getFaces())t.getSurface().isPlane()?e.push(t):n.push(t);this._getOverlapPlaneFacePairs(e),this._getOtherOverlapFacePairs(t,n)}_getIntersectFacesPairs(){const e=[];for(const t of this._body1.getFaces()){const n=t.getBoundingBox();this._bodyBox1.union(n);const s=t.getSurface();for(const i of this._body2.getFaces()){const o=i.getBoundingBox();this._bodyBox2.union(o);const a=i.getSurface();if(n.intersectsBox(o,this._tol.lengthEps)){const n={face1:t,face2:i,isOverlap:!1};e.push(n);if(r.MathAlg.CalculateOverlap.isSurfacesCoplaner(s,a,this._tol)){const e=s.getPtAt(new r.Vector2(0,0)),o=s.getNormAt(new r.Vector2(0,0)),c=a.getNormAtPoint(e),l=o.dot(c)>0,d=t.getSameDirWithSurface()===i.getSameDirWithSurface();n.isOverlap=!0,n.isFaceSameDir=d===l,this._overlapFacePairs.push(n)}}}}return this._body1.getFaces.length+this._body2.getFaces.length>1e4&&this._getOverlapFacePairs(),e}_addEdgeKnot(e,t,n,r,s){const i=e.get(t);if(i)i.edgeFaceKnots.push(...n),i.edgeEdgeKnots.push(...r),i.edgeVertexKnots.push(...s);else{const i={edgeVertexKnots:s,edgeEdgeKnots:r,edgeFaceKnots:n};e.set(t,i)}}_addEdgeFaceKnotToSet(e,t){let n=!1;const r=e.edge,s=this._edgeEdgeKnots.filter((e=>e.edge1===r||e.edge2===r));for(const t of s){if(t.xPtInfo.point.sqDistanceTo(e.xPtInfo.point)<this._tol.lengthEps2)return}const i=t.filter((t=>t.edge===e.edge&&t.face===e.face));for(const t of i){if(t.xPtInfo.point.sqDistanceTo(e.xPtInfo.point)<this._tol.lengthEps2){n=!0;break}}n||(t.push(e),this._addEdgeKnot(this._edgeKnots,e.edge,[e],[],[]))}_faceAddCoedges(e,t,n){const r=e.get(t);r?r.push(...n):e.set(t,n)}_deleteEdgeCoedges(e){const t=e.getCoedge3ds();for(let e=0;e<t.length;e++){const n=t[e].getFace().getWires();for(const r of n)r.deleteCoedge3d(t[e]);t[e].dispose(),e--}}_deleteUsedCoedges(e,t){for(let n=0;n<e.length;n++)t.find((t=>t===e[n]))||(e.splice(n,1),n--)}_getOverlapPlaneFacePairs(e){const t=this._getOverlapPlaneFaces(e);for(const e of t){const t=Array.from(e.keys()),n=t.filter((e=>e.getShell()===this._body1)),r=t.filter((e=>e.getShell()===this._body2));if(0!==n.length&&0!==r.length)for(const t of n){const n=e.get(t);for(const s of r){const r={face1:t,face2:s,isOverlap:!0,isFaceSameDir:n===e.get(s)};this._overlapFacePairs.push(r)}}}}_getOverlapPlaneFaces(e){const t=[],n=this._tol.edgeLengthEps,s=(e,t,r,s)=>{let i;e.sort(t);for(let t=0;t<e.length;t=i){i=t+1;const o=r(e[t]);for(;i<e.length&&r(e[i])-o<n;)i++;i>t+1&&s(e.slice(t,i))}},i=e=>{const n=e[0].face.getSurface().getNorm();e[0].face.getSameDirWithSurface()||n.multiply(-1);const r=new Map;for(const t of e){const e=t.face,s=e.getSurface().getNorm().dot(n)>0===e.getSameDirWithSurface();r.set(e,s)}t.push(r)},o=e=>{s(e,this._sortZ,(e=>e.position.z),i)},a={x:Math.random(),y:Math.random(),z:Math.random()},c=[];for(const t of e){const e=t.getSurface(),s=e.getNorm(),i=e.getOrigin().dot(s);Math.abs(i)>n?s.multiply(i):(s.multiply(r.CONST.MODEL_MAX_LENGTH),s.dot(a)<0&&s.reverse()),c.push({face:t,position:s})}return s(c,this._sortXYZ,(e=>e.position.x),(e=>{s(e,this._sortYZ,(e=>e.position.y),o)})),t}_sortXYZ(e,t){const n=e.position,r=t.position;return n.x!==r.x?n.x-r.x:n.y!==r.y?n.y-r.y:n.z!==r.z?n.z-r.z:e.face.tag<t.face.tag?-1:1}_sortYZ(e,t){const n=e.position,r=t.position;return n.y!==r.y?n.y-r.y:n.z!==r.z?n.z-r.z:e.face.tag<t.face.tag?-1:1}_sortZ(e,t){const n=e.position,r=t.position;return n.z!==r.z?n.z-r.z:e.face.tag<t.face.tag?-1:1}_getOtherOverlapFacePairs(e,t){for(const n of e){const e=n.getSurface();for(const s of t){const t=s.getSurface();if(r.MathAlg.CalculateOverlap.isSurfacesCoplaner(e,t)){const e=n.getSameDirWithSurface()===s.getSameDirWithSurface(),t={face1:n,face2:s,isOverlap:!0,isFaceSameDir:e};this._overlapFacePairs.push(t)}}}}_newFacesFromWires(e,t,n){var s;if(0===n.length)return[];const o=[],a=new i.Face(e.clone(),t,n);if(1===n.length)return o.push(a),o;const c=[],l=[];for(const e of n){const t=e.calcLoop(),n=t.calcArea();n>r.Tolerance.EDGE_LENGTH_EPS2?c.push({wire:e,loop:t,area:n}):l.push({wire:e,loop:t,area:n})}if(0===c.length){let e=!0;for(const t of l){if(!(Math.abs(t.area)<this._tol.lengthEps)){e=!1;break}for(const n of t.wire.getCoedge3ds())if((null===(s=n.getTwin())||void 0===s?void 0:s.getWire())!==t.wire){e=!1;break}}if(!e)throw new Error("Boolean3d： face搜环wire错误")}else if(1===c.length){const n=new i.Face(e.clone(),t,[c[0].wire,...l.map((e=>e.wire))]);return a.deleteAllWires(),o.push(n),o}const d=[];for(let e=0;e<c.length;e++){const t=c[e],n=t.loop;let s;d.length>e?s=d[e]:(s=[t.wire],d.push(s));for(let t=0;t<l.length;t++){const i=l[t].loop;if(r.MathAlg.PositionJudge.ptToLoop(i.getAllCurves()[0].getStartPt(),n).type===r.MathAlg.PtLoopPositonType.OUT){if(e===c.length-2){const n=[c[e+1].wire,l[t].wire];d.push(n),l.splice(t,1),t--}}else s.push(l[t].wire),l.splice(t,1),t--}}a.deleteAllWires();for(const n of d){const r=new i.Face(e.clone(),t,n);o.push(r)}return o}_postProcess(e){for(const t of e.getFaces()){const n=t.getSurface();if(n.isUPeriodic()||n.isVPeriodic())continue;const r=t.getWires();for(const n of r)if(!(1===n.getCoedge3ds().length&&n.getCoedge3ds()[0].getCurve().isPeriodic()&&n.getCoedge3ds()[0].getCurve().getRange().getLength()>this._tol.numberEps)){for(let t=0;t<n.getCoedge3ds().length;t++){const r=n.getCoedge3ds()[t],s=n.getCoedge3ds()[(t+1)%n.getCoedge3ds().length];if(r.getEdge()===s.getEdge()){const i=r.getEdge();if(i&&2===i.getCoedge3ds().length){const o=[i.getStartVertex(),i.getEndVertex()];n.deleteCoedge3d(r),n.deleteCoedge3d(s),r.dispose(),s.dispose(),0===i.getCoedge3ds().length&&e.deleteEdge(i);for(const t of o){0===t.getEdges().filter((t=>t.getShell()===e)).length&&e.deleteVertex(t)}t--}}}0===n.getCoedge3ds().length&&t.deleteWire(n)}}}_dealNonManifoldBodys(){let e=!1;for(const t of[...this._body1.getEdges(),...this._body2.getEdges()])t.getCoedge3ds().length>2&&(e=!0);e&&(this._nonManifoldEdgeMap=new Map);const t=e=>{for(const t of e.getEdges()){const n=t.getCoedge3ds();if(n.length>2){const r=n.length/2,s=[],i=t.getCurve().getMidPt(),a=t.getCurve().getMidTangent(),[c,l]=h.getLeftAndRightCoedgeEx(t);for(const e of l){const t=e.getFace(),n=t.getSurface().getUVAt(i),r=t.getNormAt(n);for(const n of c){const o=n.getFace();if(e.getWire()===n.getWire()&&void 0!==e.getWire()){s.push({lCoedge:n,lFace:o,rCoedge:e,rFace:t});continue}const c=o.getSurface().getUVAt(i),l=o.getNormAt(c);if(l.isSameDirection(r)){s.push({lCoedge:n,lFace:o,rCoedge:e,rFace:t});continue}l.cross(r).dot(a)>0&&s.push({lCoedge:n,lFace:o,rCoedge:e,rFace:t})}}if(0===s.length)throw new Error("Boolean3d：非流形body处理错误");const d=[];d.push({newEdge:t,overlapNewEdgeSegs:[]});for(let n=0;n<r-1;n++){const r=new o.Edge(t.getCurve().clone(),t.getStartVertex(),t.getEndVertex());e.addEdge(r),d.push({newEdge:r,overlapNewEdgeSegs:[]});s[n].lCoedge.setEdge(r);s[n].rCoedge.setEdge(r)}this._nonManifoldEdgeMap.set(t,d)}}};this._boolType===r.MathAlg.Bool2dType.union?(t(this._body1),t(this._body2)):this._boolType===r.MathAlg.Bool2dType.difference&&t(this._body1)}_mergeNonManifoldEdges(){for(const e of this._nonManifoldEdgeMap){const t=e[1];let n=!1;for(let e=1;e<t.length;e++){const r=t[e].overlapNewEdgeSegs;r.length>0&&(n=!0);for(let e=0;e<r.length;e++){const n=r[e].getCoedge3ds();for(let r=0;r<n.length;r++)void 0===n[r].getParent()?n[r].dispose():n[r].setEdge(t[0].overlapNewEdgeSegs[e]),r--}}if(!1===n)for(let e=1;e<t.length;e++){const n=t[e].newEdge.getCoedge3ds();for(let e=0;e<n.length;e++)void 0===n[e].getParent()?n[e].dispose():n[e].setEdge(t[0].newEdge),e--}}}_aligning(){let e=!0;const t=this._tol.lengthEps2/1e4,n=[];for(const r of this._body1.getVertexs())for(const s of this._body2.getVertexs()){const i=r.getPoint().sqDistanceTo(s.getPoint());i<=t?e=!1:i<2*this._tol.lengthEps2&&n.push(r.getPoint().subtracted(s.getPoint()))}if(!e&&n.length>0)return void this._updateBooleanTolerance(2*this._tol.lengthEps);let s=!1;const i=[],o=[];for(const e of this._body1.getEdges()){const a=e.getCurve();for(const e of this._body2.getEdges()){const c=e.getCurve();if(a.isLine3d()&&c.isLine3d()){let e=a.getDirection().angle(c.getDirection());if(e=e>r.CONST.PI_2?r.CONST.PI-e:e,e<this._tol.angleEps/10){s=!0;const e=a.getProjectedPtBy(c.getMidPt()).subtracted(c.getMidPt()),r=e.getSqLength();r<=t?o.push(a.getDirection()):r<=2*this._tol.lengthEps2&&n.push(e)}else if(e<2*this._tol.angleEps){const e=a.getProjectedPtBy(c.getStartPt()).sqDistanceTo(c.getStartPt());if(e<=100*this._tol.lengthEps2){const t=a.getProjectedPtBy(c.getEndPt()).sqDistanceTo(c.getEndPt()),n=c.getProjectedPtBy(a.getStartPt()).sqDistanceTo(a.getStartPt()),r=c.getProjectedPtBy(a.getEndPt()).sqDistanceTo(a.getEndPt()),s=Math.max(e,t,n,r);i.push(Math.sqrt(s))}}}}}if(s&&i.length>0)return void this._updateBooleanTolerance(2*this._tol.lengthEps);if(!e&&n.length>0)return void this._updateBooleanTolerance(2*this._tol.lengthEps);const a=[];for(const e of this._body1.getFaces())e.getSurface().isCylinder()&&a.push(e);const c=[];for(const e of this._body2.getFaces())e.getSurface().isCylinder()&&c.push(e);const l=(e,t)=>!(!e.isEqualAB(this._tol.lengthEps)||!t.isEqualAB(this._tol.lengthEps))&&Math.abs(e.getRadius()-t.getRadius())<this._tol.lengthEps;if(a.length>0&&c.length>0)for(const e of a){const r=e.getSurface();for(const e of c){const s=e.getSurface();if(r.getCenterAxis().isParallel(s.getCenterAxis())&&l(r,s)){const e=s.getCoord().getOrigin().subtracted(r.getCoord().getOrigin()),i=e.dot(r.getCenterAxis()),a=e.subtracted(r.getCenterAxis().multiplied(i)),c=a.getSqLength();c<=t?o.push(r.getCoord().getDz()):c<=2*this._tol.lengthEps2&&n.push(a)}}}if(0===n.length)return;if(!e&&n.length>0)return void this._updateBooleanTolerance(2*this._tol.lengthEps);let d,u=!0;if(1===n.length)d=n[0];else{const e=this._tol.lengthEps/10;for(const t of n)if(void 0===d)d=t;else{if(d.equals(t,e))continue;if(!d.equals(t,2*e)){u=!1;break}d=d.midTo(t)}}if(u&&d)for(const t of o)if(!t.isParallel(d,this._tol.lengthEps)){e=!1;break}e?this._body2.translate(d):this._updateBooleanTolerance(2*this._tol.lengthEps)}_dealDegenerateEdgesAndFaces(e){const t=this._tol.lengthEps/10,n=[];for(const r of e.getEdges())if(!r.isDegenerate()){if(r.getStartVertex().tag===r.getEndVertex().tag){let e=!1;for(const t of r.getFaces())if(!t.getSurface().isPlane()&&!t.getSurface().isCylinder()){e=!0;break}if(e)continue}r.getStartVertex().getPoint().equals(r.getEndVertex().getPoint(),t)&&(r.getCurve().isLine3d()||r.getCurve().isArc3d()&&r.getCurve().getRange().getLength()<t)&&n.push(r)}const r=new Set;for(const t of n){const s=t.getStartVertex(),i=s.getEdges(),o=t.getEndVertex(),a=o.getEdges();if(i.length>a.length){for(const e of a)e.getStartVertex()===o?e.setStartVertex(s):e.setEndVertex(s);e.deleteVertex(o)}else{for(const e of i)e.getStartVertex()===s?e.setStartVertex(o):e.setEndVertex(o);e.deleteVertex(s)}const c=t.getCoedge3ds();for(const e of c){const t=e.getFace();r.add(t);e.getWire().deleteCoedge3d(e),1===t.getCoedge3ds().length&&t.getCoedge3ds()[0].getCurve().isLine3d()&&n.push(e.getEdge())}t.dispose(),e.deleteEdge(t)}const s=e=>{for(const t of e)if(!t.getCurve().isLine3d())return!1;return!0},i=(t,n,r,s)=>{const i=r.getWire(),o=i.getCoedge3ds().findIndex((e=>e===r));i.replaceCoedge3d(o,[t]);r.getSameDirWithEdge()===n.getSameDirWithEdge()&&t.reverse(),(t=>{const n=t.getCoedge3ds();for(let e=0;e<n.length;e++){const t=n[e].getWire();t&&(t.deleteCoedge3d(n[e]),e--)}t.dispose(),e.deleteEdge(t)})(n.getEdge()),s.dispose(),e.deleteFace(s)};for(const t of r){const n=t.getCoedge3ds();if(s(n))if(n.length<1)e.deleteFace(t);else{if(1===n.length)throw new Error("Boolean3d: 处理退化face出现错误！");if(2===n.length){const r=n[0].getEdge();if(r===n[1].getEdge()&&4===(null==r?void 0:r.getCoedge3ds().length)){t.dispose(),e.deleteFace(t);continue}const s=n[0].getTwin(),o=n[1].getTwin();if(s&&o){const e=s.getFace(),r=o.getFace();if(t.getSurface().isPlane()&&e.getSurface().isPlane()&&r.getSurface().isPlane()){const o=t.getSurface().getNorm(),a=e.getSurface().getNorm(),c=r.getSurface().getNorm();if(o.angle(a)<o.angle(c)){i(n[1],n[0],s,t);continue}}i(n[0],n[1],o,t)}}}}if(n.length>0){for(const t of e.getEdges())t.updateTolerance();e.updateTolerance()}}_getVariables(e){const t=this._edgeOriginTopoInfos.get(e);if(t){return{faces:[t.leftFace,t.rightFace],coedges:[t.leftCoedge,t.rightCoedge]}}const[n,r]=h.getLeftAndRightCoedge(e);return{faces:[n.getFace(),r.getFace()],coedges:[n,r]}}}},54979:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BRepCalculateIntersect=void 0;const r=n(98106),s=n(11540),i=n(61245),o=n(11748);t.BRepCalculateIntersect=class{static faceFace(e,t,n=r.Tolerance.NUMBER_EPS){return s.FaceFaceIntersect.execute(e,t,n)}static faceFaces(e,t,n=r.Tolerance.NUMBER_EPS){return i.FaceFacesIntersect.execute(e,t,n)}static line3dFace(e,t,n=r.Tolerance.DEFAULT){return o.LineFacesIntersect.execute(e,t,n)}static isIntersectLine3dFace(e,t,n=r.Tolerance.DEFAULT){return o.LineFacesIntersect.hasIntersect(e,t,n)}}},28670:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BRepCalculateProject=void 0;const r=n(72056),s=n(78791),i=n(36879),o=n(29512),a=n(71277);t.BRepCalculateProject=class{static face(e,t){return r.FaceProject.execute(e,t)}static faceToDiscretePolygons(e,t){return r.FaceProject.toDiscretePolygons(e,t)}static body(e,t){return s.BodyProject.execute(e,t)}static bodysProject(e,t,n){const r=new i.SpaceProject(e,t,n);return r.canProject()?r.execute():new Map}static viewProject(e,t,n){const r=new a.ViewProject(e,t,n);return r.canProject()?r.execute():new Map}static bodyProjectSimple(e,t){return o.SpaceProjectSimple.spaceProjectSimple(e,t)}}},57864:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BrepPositionJudge=void 0;const r=n(98106),s=n(15522),i=n(23957);t.BrepPositionJudge=class{static isPtInFace(e,t,n=r.Tolerance.LENGTH_EPS){const s=t.getSurface(),i=s.getUVAt(e);if(!s.getPtAt(i).equals(e,n))return!1;const o=t.calcPolygon(),a=o.getBoundingBox(),c=(e,t,n,s)=>{const i=s.getLength();return r.MathUtil.isNearlyBigger(n,s.max)?[e,e+i]:r.MathUtil.isNearlySmaller(t,s.min)?[e,e-i]:[e]},l=s.isUPeriodic()?c(i.x,a.min.x,a.max.x,s.getDomainU()):[i.x],d=s.isVPeriodic()?c(i.y,a.min.y,a.max.y,s.getDomainV()):[i.y];for(const e of l)for(const t of d)if(r.MathAlg.PtLoopPositonType.OUT!==r.MathAlg.PositionJudge.ptToPolygon(new r.Vector2(e,t),o,n))return!0;return!1}static isPtAboveFace(e,t){const n=t.getSurface().clone();return t.getSurface().isPlane()?(t.getSameDirWithSurface()||n.reverse(),r.MathAlg.PositionJudge.isPtAbovePlane(e,n)):(r.MathError.warn("只支持平面"),!1)}static pointBrepBodyPositionJudge(e,t,n=r.Tolerance.DEFAULT.lengthEps,s=!1){return i.PointBodyPosition.PositionJudge(e,t,n,s)}static BrepBodiesPositionJudge(e,t,n=r.Tolerance.DEFAULT.lengthEps,i=!1,o=!1){return s.BrepBodyPositionJudge.PositionJudge(e,t,n,i,o)}}},74276:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtrudeBody=t.mergeShellModelingResult=t.ShellModelingUtil=t.Bool3d=t.DiagnoseShell=t.mergeShells=t.LoftType=t.RevolveErrorCode=t.SweepErrorCode=t.PreviewType=t.ShellEdit=t.ShellBuilder=t.BodyEdit=t.BRepCalculateProject=t.BasicBodyBuilder=t.BodyBuilder=t.BodyUtil=t.BRepCalculateIntersect=t.BrepBodyPositionType=t.PointBodyPositionType=t.BrepPositionJudge=void 0;var r=n(57864);Object.defineProperty(t,"BrepPositionJudge",{enumerable:!0,get:function(){return r.BrepPositionJudge}});var s=n(23957);Object.defineProperty(t,"PointBodyPositionType",{enumerable:!0,get:function(){return s.PointBodyPositionType}});var i=n(15522);Object.defineProperty(t,"BrepBodyPositionType",{enumerable:!0,get:function(){return i.BrepBodyPositionType}});var o=n(54979);Object.defineProperty(t,"BRepCalculateIntersect",{enumerable:!0,get:function(){return o.BRepCalculateIntersect}});var a=n(37632);Object.defineProperty(t,"BodyUtil",{enumerable:!0,get:function(){return a.BodyUtil}});var c=n(27140);Object.defineProperty(t,"BodyBuilder",{enumerable:!0,get:function(){return c.BodyBuilder}});var l=n(89195);Object.defineProperty(t,"BasicBodyBuilder",{enumerable:!0,get:function(){return l.BasicBodyBuilder}});var d=n(28670);Object.defineProperty(t,"BRepCalculateProject",{enumerable:!0,get:function(){return d.BRepCalculateProject}});var u=n(88078);Object.defineProperty(t,"BodyEdit",{enumerable:!0,get:function(){return u.BodyEdit}});var h=n(83205);Object.defineProperty(t,"ShellBuilder",{enumerable:!0,get:function(){return h.ShellBuilder}});var g=n(54557);Object.defineProperty(t,"ShellEdit",{enumerable:!0,get:function(){return g.ShellEdit}});var f=n(45813);Object.defineProperty(t,"PreviewType",{enumerable:!0,get:function(){return f.PreviewType}}),Object.defineProperty(t,"SweepErrorCode",{enumerable:!0,get:function(){return f.SweepErrorCode}}),Object.defineProperty(t,"RevolveErrorCode",{enumerable:!0,get:function(){return f.RevolveErrorCode}}),Object.defineProperty(t,"LoftType",{enumerable:!0,get:function(){return f.LoftType}});var p=n(28373);Object.defineProperty(t,"mergeShells",{enumerable:!0,get:function(){return p.mergeShells}});var _=n(91859);Object.defineProperty(t,"DiagnoseShell",{enumerable:!0,get:function(){return _.DiagnoseShell}});var m=n(44737);Object.defineProperty(t,"Bool3d",{enumerable:!0,get:function(){return m.Bool3d}});var v=n(14785);Object.defineProperty(t,"ShellModelingUtil",{enumerable:!0,get:function(){return v.ShellModelingUtil}});var E=n(34652);Object.defineProperty(t,"mergeShellModelingResult",{enumerable:!0,get:function(){return E.mergeShellModelingResult}});var P=n(77354);Object.defineProperty(t,"ExtrudeBody",{enumerable:!0,get:function(){return P.ExtrudeBody}})},11540:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FaceFaceIntersect=void 0;const r=n(98106);class s{static execute(e,t,n=r.Tolerance.NUMBER_EPS){if(e.getCenterNorm().isParallel(t.getCenterNorm()))return[];const i=e.getBoundingBox(),o=t.getBoundingBox();if(!i.intersectsBox(o,n))return[];const a=e.getSurface(),c=t.getSurface(),l=r.MathAlg.CalculateIntersect.surfacesSimplified(a,c),d=[];for(const t of l){if(t.getType()!==r.EN_GEO_ELEMENT_TYPE.EN_LINE_3D)throw new Error("不支持的类型");if(a.getType()===r.EN_GEO_ELEMENT_TYPE.EN_PLANE){const r=s._curve3dIntersectFace(t,e,n);d.push(...r)}}const u=[];for(const e of d){if(e.getType()!==r.EN_GEO_ELEMENT_TYPE.EN_LINE_3D)throw new Error("不支持的类型");if(c.getType()===r.EN_GEO_ELEMENT_TYPE.EN_PLANE){const r=s._curve3dIntersectFace(e,t,n);u.push(...r)}}return u}static _curve3dIntersectFace(e,t,n=r.Tolerance.LENGTH_EPS){const s=t.getSurface(),i=s.getLine2D(e);if(!i)return[];const o=r.MathAlg.BoolOperate2d.polylineIntersect(new r.PolyCurve([i]),[t.calcPolygon()],!0,n),a=[];o.forEach((e=>{const t=e.getAllCurves();t&&t.length>0&&a.push(...t)}));const c=[];return a.forEach((e=>{try{const t=s.getLine3DByPts(e.getStartPt(),e.getEndPt());c.push(t)}catch(e){}})),c}}t.FaceFaceIntersect=s},61245:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FaceFacesIntersect=void 0;const r=n(98106),s=n(54979);t.FaceFacesIntersect=class{static execute(e,t,n=r.Tolerance.NUMBER_EPS){r.MathAssert.assert(e.getSurface().isPlane(),"just suport plane type");const i=e.getSurface(),o=[];for(const a of t){const t=s.BRepCalculateIntersect.faceFace(e,a,n);t.length<1||t.forEach((e=>{r.MathAssert.assert(e.isLine3d(),"just suport line3d type");const t=i.getLine2D(e);t&&o.push(t)}))}return r.MathAlg.SearchGraph.simpleLoop(o)}}},11748:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LineFacesIntersect=void 0;const r=n(98106);t.LineFacesIntersect=class{static execute(e,t,n=r.Tolerance.DEFAULT){const s=t.calcPolygon(),i=s.getLoops()[0].getBoundingBox(),o=t.getSurface(),a=o.getDomainU().set(i.min.x,i.max.x),c=o.getDomainV().set(i.min.y,i.max.y),l=r.MathAlg.CalculateIntersect.curveSurfaceAll(e,o,n,[a,c]),d=[];for(const e of l){r.MathAlg.PositionJudge.ptToPolygon(new r.Vector2(e.surfaceUV),s,n.numberEps)!==r.MathAlg.PtLoopPositonType.OUT&&d.push(e.point)}return d}static hasIntersect(e,t,n=r.Tolerance.DEFAULT){const s=t.calcPolygon(),i=t.getSurface();return r.MathAlg.CalculateIntersect.isIntersectCurveSurface(e,i,s,n)}}},15522:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BrepBodyPositionJudge=t.BrepBodyPositionType=void 0;const r=n(98106),s=n(23957);var i;!function(e){e[e.INTERSECT=0]="INTERSECT",e[e.OUTSIDE=1]="OUTSIDE",e[e.INSIDE=2]="INSIDE",e[e.CONTAIN=3]="CONTAIN",e[e.EQUAL=4]="EQUAL"}(i=t.BrepBodyPositionType||(t.BrepBodyPositionType={}));t.BrepBodyPositionJudge=class{static PositionJudge(e,t,n=r.Tolerance.DEFAULT.lengthEps,o=!1,a=!1){const c=e.getBoundingBox(),l=t.getBoundingBox();if(!c.intersectsBox(l,n))return i.OUTSIDE;if(o&&a)return c.containsBox(l,n)?i.CONTAIN:l.containsBox(c,n)?i.INSIDE:i.INTERSECT;if(o){const e=c.getCornerPts();let r=!1,o=!1;for(const a of e){const e=s.PointBodyPosition.PositionJudge(a,t,n);if(e===s.PointBodyPositionType.INSIDE&&(r=!0),e===s.PointBodyPositionType.OUTSIDE&&(o=!0),r&&o)return i.INTERSECT}return r&&!o?i.INSIDE:!r&&o?i.CONTAIN:i.INSIDE}if(a){const t=l.getCornerPts();let r=!1,o=!1;for(const a of t){const t=s.PointBodyPosition.PositionJudge(a,e,n);if(t===s.PointBodyPositionType.INSIDE&&(r=!0),t===s.PointBodyPositionType.OUTSIDE&&(o=!0),r&&o)return i.INTERSECT}return r&&!o?i.CONTAIN:!r&&o?i.INSIDE:i.CONTAIN}return this._generalBodyPositionJudge(e,t,n)}static _generalBodyPositionJudge(e,t,n=r.Tolerance.DEFAULT.lengthEps){const o=e.getVertexs(),a=t.getVertexs(),c=o>a?a:o,l=o>a?e:t;let d=!1,u=!1;for(const e of c){const t=s.PointBodyPosition.PositionJudge(e.getPoint(),l,n);if(t===s.PointBodyPositionType.INSIDE&&(d=!0),t===s.PointBodyPositionType.OUTSIDE&&(u=!0),d&&u)return i.INTERSECT}const h=e.getBoundingBox(),g=t.getBoundingBox();return h.containsBox(g,n)?i.CONTAIN:g.containsBox(h,n)?i.INSIDE:h.intersectsBox(g)?i.INTERSECT:i.OUTSIDE}}},23957:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointBodyPosition=t.PointBodyPositionType=void 0;const r=n(98106);var s;!function(e){e[e.INSIDE=0]="INSIDE",e[e.OUTSIDE=1]="OUTSIDE",e[e.ON_VERTEX=2]="ON_VERTEX",e[e.ON_EDGE=3]="ON_EDGE",e[e.ON_FACE=4]="ON_FACE"}(s=t.PointBodyPositionType||(t.PointBodyPositionType={}));t.PointBodyPosition=class{static PositionJudge(e,t,n=r.Tolerance.DEFAULT.lengthEps,i=!1){const o=t.getBoundingBox();if(!o.containsPoint(e,n))return s.OUTSIDE;if(i){const t=o.getSquareDistanceTo(e);return r.MathUtil.isNearlyZero(t,n)?s.ON_FACE:s.INSIDE}const a=new r.Line3d(e,new r.Vector3(o.max.x,e.y,e.z));let c=[];for(const e of t.getFaces()){const t=e.getBoundingBox();this._isIntersectBox(a,t,n)&&c.push(e)}const l=new Set,d=new Set;for(const e of c){for(const t of e.getVertexes())l.has(t)||l.add(t);for(const t of e.getEdges())d.has(t)||d.add(t)}for(const t of l)if(t.getPoint().equals(e,n))return s.ON_VERTEX;for(const t of d)if(t.getCurve().containsPoint(e,n))return s.ON_EDGE;let u=!1,h=[],g=0;for(;!u;){u=!1;let i=[];for(const t of c){const s=t.getSurface();if(s.containsPoint(e,n)&&s.isPlane()&&s.getNorm().isPerpendicular(a.getDirection(),n)){u=!0,i=[];break}const o=new r.Tolerance(n),c=r.MathAlg.CalculateIntersect.curveSurfaceAll(a,s,o),l=new r.Polygon(t.getWires().map((e=>e.calcLoop())));for(const e of c){if(e.overlapRange){u=!0;continue}const t=e.surfaceUV;this._calUVPosition(new r.Vector2(t),l,s,n)!==r.MathAlg.PtLoopPositonType.OUT&&i.push(e.point)}}h=i;for(let t=0;t<h.length;++t){if(e.equals(h[t],n))return s.ON_FACE;for(let e=t+1;e<h.length;++e)if(h[t].equals(h[e],n)){u=!0;break}if(u)break}if(u){h=[],c=t.getFaces().map((e=>e));const n=this._farthestDis(e,o);a.setDirection({x:Math.random(),y:Math.random(),z:Math.random()}),a.setRange(0,n),u=!1}if(g>10){u=!0;break}g++}return h.length%2==0?s.OUTSIDE:s.INSIDE}static _isIntersectBox(e,t,n){const s=t.min,i=t.max,o=e.getStartPt(),a=e.getEndPt();return!r.MathUtil.isNearlyBigger(o.x,i.x,n)&&!r.MathUtil.isNearlySmaller(a.x,s.x,n)&&(!r.MathUtil.isNearlySmaller(o.y,s.y,n)&&!r.MathUtil.isNearlyBigger(o.y,i.y,n)&&(!r.MathUtil.isNearlySmaller(o.z,s.z,n)&&!r.MathUtil.isNearlyBigger(o.z,i.z,n)))}static _calUVPosition(e,t,n,s){if(n.isCylinder()){const n=t.getAllCurves().map((e=>e.getStartPt()));let s=r.CONST.MAX_INTEGER,i=-r.CONST.MAX_INTEGER;for(const e of n)s>e.x&&(s=e.x),i<e.x&&(i=e.x);for(;e.x>i;)e.x-=2*Math.PI;for(;e.x<s;)e.x+=2*Math.PI}n.isSweepSurface()&&([e.x,e.y]=[e.y,e.x]);const i=[];for(const e of t.getLoops()){const t=new r.Loop(e.getAllCurves().map((e=>e.discrete())).flat());i.push(t)}return r.MathAlg.PositionJudge.ptToPolygon(e,new r.Polygon(i),s)}static _farthestDis(e,t){const n=t.getCornerPts();let r=0;for(const t of n){const n=e.distanceTo(t);r<n&&(r=n)}return r}}},78791:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BodyProject=void 0;const r=n(98106),s=n(72056);t.BodyProject=class{static execute(e,t){const n=[];for(const i of e.getFaces()){if(i.getNormAt({x:0,y:0}).isPerpendicular(t.getDz()))continue;const e=s.FaceProject.execute(i,t);e instanceof r.Polygon&&n.push(e)}const i=r.MathAlg.BoolOperate2d.polygonExUnion(n);return r.Polygon.fromPolygonEx(i)}}},72056:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FaceProject=void 0;const r=n(98106);class s{static execute(e,t){const n=new r.Plane(t),i=e.getSurface();if(i.isPlane()&&i.getNormAt(r.Vector2.O()).isPerpendicular(t.getDz(),r.Tolerance.ANGLE_EPS)){const t=e.getSurface(),i=e.calcPolygon();r.MathAssert.assert(!i.isEmpty(),"polygon不能为空");const o=i.getLoops().map((e=>r.MathAlg.DiscreteTopology.discretePolyline(e,r.DiscreteParameter.HIGH).map((e=>t.getPtAt(e))).map((e=>n.getUVAt(e)))));return s.mergeLines(o)}if(i.isCylinder()&&i.getCoord().getDz().isParallel(t.getDz())){const t=[];return e.getWires().forEach((e=>{e.getCoedge3ds().forEach((e=>t.push(r.MathAlg.CalculateProject.curve3dToPlane(e.getCurve(),n))))})),this._makeArc2d(i,t,n)}const o=new r.Polygon;let a=!1;return e.getWires().forEach(((e,t)=>{const s=new r.Loop,i=[];e.getCoedge3ds().forEach((e=>i.push(r.MathAlg.CalculateProject.curve3dToPlane(e.getCurve(),n)))),i.forEach((e=>{e instanceof r.Curve2d&&s.addCurve(e)})),s.makeStartEndConnected(),o.addLoop(s,!1),0===t&&(a=s.calcArea()<0)})),a&&o.reverse(),o}static toDiscretePolygons(e,t){const n=new r.Plane(t),s=e.getSurface();if(s.isPlane()){const i=[];for(const t of e.getWires()){const e=[];for(const r of t.getCoedge3ds()){const t=r.getEdge().getCurve().discrete().map((e=>n.getUVAt(e)));r.getSameDirWithEdge()||t.reverse(),e.push(...t)}i.push(e)}if(s.getNormAt(r.Vector2.O()).isPerpendicular(t.getDz(),r.Tolerance.ANGLE_EPS))return[];const o=i.map((e=>new r.Loop(e)));o[0].calcArea()<-r.Tolerance.LENGTH_EPS&&o.map((e=>e.reverse()));return[new r.Polygon(o)]}if(s.isCylinder()&&s.getCoord().getDz().isParallel(t.getDz()))return[];if(s.isSweepSurface()){const e=s.getPath();if(e.isLine3d()&&e.getDirection().isParallel(t.getDz()))return[];const n=s.getProfile();if(n.isLine2d()&&s.getPathDz().isParallel(t.getDz())&&n.getDirection().isParallel(r.Vector2.Y()))return[]}const i={vertices:[],faces:[],normals:[],uvs:[]},o=e.tessellate(void 0,r.DiscreteParameter.LOW).mesh;if(!o)return[];o.vertices.forEach((e=>{i.vertices.push(e[0]),i.vertices.push(e[1]),i.vertices.push(e[2])})),o.faces.forEach((e=>{i.faces.push(e[0]),i.faces.push(e[1]),i.faces.push(e[2])})),o.normals.forEach((e=>{i.normals.push(e[0]),i.normals.push(e[1]),i.normals.push(e[2])})),o.uvs.forEach((e=>{i.uvs.push(e[0]),i.uvs.push(e[1])}));const a=r.MathAlg.MeshUtil.getContour(i);let c=new r.Matrix3(r.MatrixUtil.convertToMatrix3(n.getCoord().getWorldToLocalMatrix()));c.isIdentity()&&(c=void 0);const l=[];return a.forEach((e=>{const t=c?e.map((e=>e.map((e=>new r.Vector2(e).transform(c))))):e;l.push(new r.Polygon(t))})),l}static mergeLines(e){let t;const n=[];for(const s of e)for(let e=0;e<s.length;e++){if(s[e].equals(s[e===s.length-1?0:e+1]))continue;const i=new r.Line2d(s[e],s[e===s.length-1?0:e+1]);if(!t){t=i,n.push(t.getRange());continue}const o=r.MathAlg.CalculateProject.line1ToLine2(i,t);n.push(o)}if(!t)return[];r.MathAssert.assert(t,"line0?");return r.Interval.merge(n).map((e=>{const n=t.clone().setRange(e),s=new r.PolyCurve;return s.addCurve(n),s}))}static _makeArc2d(e,t,n){const s=[],i=n.getCoord().getLocalPtAt(e.getCoord().getOrigin()),o=n.getCoord().getLocalPtAt(e.getPtAt(new r.Vector2(0,0))),a=n.getCoord().getLocalPtAt(e.getPtAt(new r.Vector2(.5*Math.PI,0))),c=r.Arc2d.makeEllipseByFivePoints(i,o,a,o,o);if(void 0===c)return s;let l=r.CONST.MAX_INTEGER,d=-r.CONST.MAX_INTEGER;return t.forEach((e=>{if(void 0!==e){let t=c.getParamAt(e.getStartPt()),n=c.getParamAt(e.getEndPt());t>n&&([t,n]=[n,t]);const r=c.getParamAt(e.getMidPt());r>t&&r<n||([t,n]=[n-2*Math.PI,t]),l>t&&(l=t),d<n&&(d=n)}})),r.MathUtil.isNearlySmaller(d-l,2*Math.PI)&&c.setRange(l,d),s.push(new r.PolyCurve([c])),s}}t.FaceProject=s},36879:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpaceProject=void 0;const r=n(98106),s=n(72056);var i;!function(e){e[e.UP=0]="UP",e[e.ON=1]="ON",e[e.DOWN=2]="DOWN"}(i||(i={}));const o=6/180*r.CONST.PI;t.SpaceProject=class{constructor(e,t,n){this._projectFace=e,this._projectedBodies=n,this._canProjectedBody=[],this._onPlaneBody=new Set,this._tol=new r.Tolerance(r.Tolerance.LENGTH_EPS,r.Tolerance.ANGLE_EPS,r.Tolerance.PROCESS_LENGTH_EPS,.01*r.Tolerance.EDGE_LENGTH_EPS),this._projectPlane=new r.Plane(t)}canProject(){if(!(this._projectFace.getSurface()instanceof r.Plane))return r.MathError.warn(!1,"投影平面暂时只支持平面"),!1;const e=this._projectPlane.getNorm(),t=this._projectFace.getSurface().getNorm();if(!e.isParallel(t))return r.MathError.warn(!1,"目前只支持平行投影的方式构造空间"),!1;let n=this._projectFace.getWires().map((e=>e.getCoedge3ds().map((e=>e.getCurve())))).map((e=>e.map((e=>r.MathAlg.CalculateProject.curve3dToPlane(e,this._projectPlane)))));n=n.map((e=>e.filter((e=>void 0!==e))));for(const e of n)for(let t=0;t<e.length;++t){const n=e[(t+1)%e.length],s=e[t];if(!s.getEndPt().equals(n.getStartPt())){if(!s.getEndPt().equals(n.getEndPt()))return r.MathError.warn(!1,"投影平面边界不连续"),!1;n.reverse()}}const s=n.map((e=>new r.Loop(e)));for(const e of this._projectedBodies){const t=this._judgeBodyPosition(e);t===i.UP?this._canProjectedBody.push(e):t===i.ON&&(this._onPlaneBody.add(e),this._canProjectedBody.push(e))}return this._baseLoop=s,this._canProjectedBody.length>0}execute(){r.MathError.assert(this._canProjectedBody.length>0,"不存在可投影的brep体");const e=this._projectBodies(this._canProjectedBody,this._projectPlane),t=this._analyseLoop(this._baseLoop,e.poly,e.projInfo);for(const e of t)if(e[0].getLoops().length>1){const n=r.MathAlg.SearchGraph.polygonToPolygonExes(e[0]);n.length>1&&(t.delete(e[0]),n.forEach((n=>t.set(n,e[1]))))}for(const e of t)e[0].getLoops()[0].isAnticlockwise()||e[0].getLoops().forEach((e=>e.reverse())),e[0].isValid(this._tol)||t.delete(e[0]);for(const e of t)if(!e[1].projFace.getSurface().getNorm().isParallel(this._projectPlane.getNorm(),o)){const t=this._getDistanceFromLoop(e[0],this._projectPlane,e[1].projFace.getSurface());t&&(e[1].distance=t.minDis,e[1].upDistance=t.maxDis)}return t}_projectBodies(e,t){const n=[],i=[];for(const a of e){const e=[],c=[],l=this._onPlaneBody.has(a);for(const n of a.getFaces()){if(n.getSurface().getType()!==r.EN_GEO_ELEMENT_TYPE.EN_PLANE)continue;const i=n.getSurface().getNorm().clone();if(n.getSameDirWithSurface()||i.reverse(),i.dot(this._projectPlane.getNorm())>0||i.isPerpendicular(this._projectPlane.getNorm()))continue;let a=new r.Polygon;const d=!1;let u=r.CONST.MAX_INTEGER;if(i.isParallel(this._projectPlane.getNorm(),o))u=r.MathAlg.CalculateDistance.pointToSurfaceSigned(n.getVertexes()[0].getPoint(),this._projectPlane);else{const e=s.FaceProject.execute(n,this._projectPlane.getCoord());if(e instanceof r.Polygon){a=e;const s=new r.Polygon(this._baseLoop),i=this._polygonPosition(a,s);if(i===r.MathAlg.LoopLoopPositonType.OUT)continue;if(i===r.MathAlg.LoopLoopPositonType.IN||i===r.MathAlg.LoopLoopPositonType.EQUAL)n.getWires().forEach((e=>{for(const n of e.getCoedge3ds()){const e=n.getCurve();r.MathAlg.CalculateProject.curve3dToPlane(e,t)instanceof r.Curve2d&&(u=Math.min(u,this._GetMinDistance(e,t)))}}));else if(i===r.MathAlg.LoopLoopPositonType.CONTAIN){a=new r.Polygon(this._baseLoop.map((e=>e.clone())));const e=this._getDistanceFromLoop(a,this._projectPlane,n.getSurface());if(!e)continue;u=e.minDis}else if(i===r.MathAlg.LoopLoopPositonType.INTERSECT){a=r.MathAlg.BoolOperateClipper.boolOperate([s],1,[a]);const e=this._getDistanceFromLoop(a,this._projectPlane,n.getSurface());if(!e)continue;u=e.minDis}}}d&&a.reverse(),l&&(u=0),c.push({distance:u,projFace:n}),e.push(a)}i.push(c),n.push(e)}return{poly:n,projInfo:i}}_getDistanceFromLoop(e,t,n){if(e.getLoops().length<1)return;const s=e.getLoops()[0];let i=r.CONST.MAX_INTEGER,o=-r.CONST.MAX_INTEGER,a=!1;for(const e of s.getAllCurves()){const s=t.getCurve3d(e),c=new r.Line3d(s.getStartPt(),t.getNorm(),[0,r.CONST.MODEL_MAX_LENGTH]),l=r.MathAlg.CalculateIntersect.curveSurface(c,n);if(l.length>0){const e=s.getStartPt().distanceTo(l[0]);e<i&&(i=e),e>o&&(o=e),a=!0}}return a?{minDis:i,maxDis:o}:void 0}_GetMinDistance(e,t){if(e instanceof r.Line3d){const n=e.getStartPt(),s=e.getEndPt(),i=r.MathAlg.CalculateDistance.pointToSurface(n,t),o=r.MathAlg.CalculateDistance.pointToSurface(s,t);return Math.min(i,o)}if(e instanceof r.Arc3d){const n=e,r=t.getCoord().getDx().angleTo(n.getCoord().getDx(),t.getCoord().getDz()),s=t.distanceToPoint(n.getStartPt()),i=t.distanceToPoint(n.getEndPt()),o=t.distanceToPoint(n.getPtAt(r)),a=t.distanceToPoint(n.getPtAt(r+.5*Math.PI)),c=t.distanceToPoint(n.getPtAt(r+Math.PI)),l=t.distanceToPoint(n.getPtAt(r+1.5*Math.PI));return Math.min(s,i,o,a,c,l)}const n=r.CONST.MAX_INTEGER;if(e instanceof r.SmoothPoly3d){const r=e.getPoints();for(const e of r)Math.min(n,t.distanceToPoint(e));return n}const s=r.MathAlg.DiscreteUtil.discreteCurve3d(e,r.DiscreteParameter.NORMAL);for(const e of s)Math.min(n,t.distanceToPoint(e));return n}_analyseLoop(e,t,n){let i=new r.Polygon(e);const o=new Map;let a=[];t.map((e=>e.map((e=>a.push(e)))));let c=[];n.map((e=>e.map((e=>c.push(e)))));const l=a.map(((e,t)=>({Loop:e,IProjectInfo:c[t]})));l.sort(((e,t)=>e.IProjectInfo.distance-t.IProjectInfo.distance)),a=l.map((e=>e.Loop)),c=l.map((e=>e.IProjectInfo));for(let e=0;e<a.length;e++){const t=s.FaceProject.execute(c[e].projFace,this._projectPlane.getCoord());if(t instanceof r.Polygon){const n=r.MathAlg.BoolOperateClipper.boolOperate([i],1,[t]);n.getLoops().length>0&&(o.set(n,c[e]),i=r.MathAlg.BoolOperateClipper.boolOperate([i],2,[t]))}if(i.getLoops().length<1)return o}return o}_polygonPosition(e,t){const n=e.getLoops(),s=t.getLoops();let i,o=1,a=1;for(const e of n)for(const t of s){const n=r.MathAlg.PositionJudge.loopToLoop(e,t);if(n===r.MathAlg.LoopLoopPositonType.INTERSECT)return n;if(i){if(i!==n||n!==r.MathAlg.LoopLoopPositonType.OUT)if(i!==n||n!==r.MathAlg.LoopLoopPositonType.IN){if(i!==n||n!==r.MathAlg.LoopLoopPositonType.EQUAL){if(i!==n||n!==r.MathAlg.LoopLoopPositonType.CONTAIN)return r.MathAlg.LoopLoopPositonType.INTERSECT;a++}}else o++}else i=n}return i===r.MathAlg.LoopLoopPositonType.IN&&o/n.length%2==0||i===r.MathAlg.LoopLoopPositonType.CONTAIN&&a/s.length%2==0||i===r.MathAlg.LoopLoopPositonType.OUT?r.MathAlg.LoopLoopPositonType.OUT:i===r.MathAlg.LoopLoopPositonType.EQUAL?r.MathAlg.LoopLoopPositonType.EQUAL:i===r.MathAlg.LoopLoopPositonType.CONTAIN?r.MathAlg.LoopLoopPositonType.CONTAIN:i}_judgeBodyPosition(e){const t=e.getVertexs().map((e=>e.getPoint()));let n=0,s=0;for(const e of t)r.MathAlg.CalculateDistance.pointToSurfaceSigned(e,this._projectPlane)>this._tol.lengthEps?s++:n++;return n>0&&0===s?i.DOWN:s>0&&0===n?i.UP:i.ON}}},29512:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpaceProjectSimple=void 0;const r=n(98106),s=n(72056);var i;!function(e){e[e.UP=0]="UP",e[e.ON=1]="ON",e[e.DOWN=2]="DOWN"}(i||(i={}));t.SpaceProjectSimple=class{static spaceProjectSimple(e,t){const n=new r.Plane(e),o=[];for(const e of t){const t=this._judgeBodyPosition(n,e);t.pos!==i.DOWN&&o.push({body:e,dis:t.dis})}if(o.length<1)return;o.sort(((e,t)=>e.dis-t.dis));const a=[];let c=new r.Polygon;const l=n.getNorm();for(let t=0;t<o.length;++t){const n=o[t].body.getFaces();for(const i of n){if(i.getSurface().getType()!==r.EN_GEO_ELEMENT_TYPE.EN_PLANE)continue;const n=i.getSurface().getNorm().clone();if(i.getSameDirWithSurface()||n.reverse(),n.dot(l)>0||n.isPerpendicular(l))continue;const d=s.FaceProject.execute(i,e);if(d instanceof r.Polygon){if(0===t){c=d,a.push({distance:o[t].dis,projFace:i});continue}const e=r.MathAlg.PositionJudge.loopToLoop(c.getLoops()[0],d.getLoops()[0]);if(e===r.MathAlg.LoopLoopPositonType.CONTAIN||e===r.MathAlg.LoopLoopPositonType.EQUAL)continue;c=r.MathAlg.BoolOperateClipper.boolOperate([d],0,[c]),a.push({distance:o[t].dis,projFace:i})}}}return{poly:c,info:a}}static _judgeBodyPosition(e,t){const n=t.getBoundingBox(),s=n.getCornerPts();s.push(n.getCenter());let o=0,a=0,c=r.CONST.MAX_INTEGER;for(const t of s){const n=e.getProjectedPtBy(t),s=n.subtract(t),i=t.distanceTo(n);c>i&&(c=i),r.MathUtil.isNearlyBiggerOrEqual(s.dot(e.getNorm()),0)?o++:a++}return o>0&&0===a?{pos:i.DOWN,dis:c}:a>0&&0===o?{pos:i.UP,dis:c}:{pos:i.ON,dis:0}}}},71277:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ViewProject=void 0;const r=n(98106),s=n(72056);var i;!function(e){e[e.UP=0]="UP",e[e.ON=1]="ON",e[e.DOWN=2]="DOWN"}(i||(i={}));t.ViewProject=class{constructor(e,t,n){this._projectFace=e,this._projectedBodies=n,this._canProjectedBody=[],this._onPlaneBody=new Set,this._tol=new r.Tolerance(r.Tolerance.LENGTH_EPS,r.Tolerance.ANGLE_EPS,r.Tolerance.PROCESS_LENGTH_EPS,.01*r.Tolerance.EDGE_LENGTH_EPS),this._projectPlane=new r.Plane(t)}canProject(){if(!(this._projectFace.getSurface()instanceof r.Plane))return r.MathError.warn(!1,"投影平面暂时只支持平面"),!1;const e=this._projectPlane.getNorm(),t=this._projectFace.getSurface().getNorm();if(!e.isParallel(t))return r.MathError.warn(!1,"目前只支持平行投影的方式构造空间"),!1;let n=this._projectFace.getWires().map((e=>e.getCoedge3ds().map((e=>e.getCurve())))).map((e=>e.map((e=>r.MathAlg.CalculateProject.curve3dToPlane(e,this._projectPlane)))));n=n.map((e=>e.filter((e=>void 0!==e))));for(const e of n)for(let t=0;t<e.length;++t){const n=e[(t+1)%e.length],s=e[t];if(!s.getEndPt().equals(n.getStartPt())){if(!s.getEndPt().equals(n.getEndPt()))return r.MathError.warn(!1,"投影平面边界不连续"),!1;n.reverse()}}const s=n.map((e=>new r.Loop(e)));for(const e of this._projectedBodies){const t=this._judgeBodyPosition(e);t===i.UP?this._canProjectedBody.push(e):t===i.ON&&(this._onPlaneBody.add(e),this._canProjectedBody.push(e))}return this._baseLoop=s,this._canProjectedBody.length>0}execute(){r.MathError.assert(this._canProjectedBody.length>0,"不存在可投影的brep体");const e=this._projectBodies(this._canProjectedBody,this._projectPlane),t=this._analyseLoop(this._baseLoop,e.poly,e.projInfo);for(const e of t)if(e[0].getLoops().length>1){const n=r.MathAlg.SearchGraph.polygonToPolygonExes(e[0]);n.length>1&&(t.delete(e[0]),n.forEach((n=>t.set(n,e[1]))))}return t}_projectBodies(e,t){const n=[],i=[];for(const t of e){const e=[],o=[],a=this._onPlaneBody.has(t);for(const n of t.getFaces()){if(n.getSurface().getType()!==r.EN_GEO_ELEMENT_TYPE.EN_PLANE)continue;const t=n.getSurface().getNorm().clone();if(n.getSameDirWithSurface()||t.reverse(),t.dot(this._projectPlane.getNorm())>0||t.isPerpendicular(this._projectPlane.getNorm()))continue;let i=new r.Polygon;const c=!1;let l,d=r.CONST.MAX_INTEGER;if(t.isParallel(this._projectPlane.getNorm())){d=r.MathAlg.CalculateDistance.pointToSurfaceSigned(n.getVertexes()[0].getPoint(),this._projectPlane);const e=s.FaceProject.execute(n,this._projectPlane.getCoord());e instanceof r.Polygon&&(i=e)}else{const e=s.FaceProject.execute(n,this._projectPlane.getCoord());if(e instanceof r.Polygon){i=e;const t=new r.Polygon(this._baseLoop),s=this._polygonPosition(i,t);if(s===r.MathAlg.LoopLoopPositonType.OUT)continue;s===r.MathAlg.LoopLoopPositonType.IN||s===r.MathAlg.LoopLoopPositonType.EQUAL||(s===r.MathAlg.LoopLoopPositonType.CONTAIN?i=new r.Polygon(this._baseLoop.map((e=>e.clone()))):s===r.MathAlg.LoopLoopPositonType.INTERSECT&&(i=r.MathAlg.BoolOperateClipper.boolOperate([t],1,[i])));const o=this._getDistanceFromLoop(i,this._projectPlane,n.getSurface());if(!o)continue;d=o.minDis,l=o.maxDis}}c&&i.reverse(),a&&(d=0),o.push({distance:d,projFace:n,upDistance:l}),e.push(i)}i.push(o),n.push(e)}return{poly:n,projInfo:i}}_getDistanceFromLoop(e,t,n){if(e.getLoops().length<1)return;const s=e.getLoops()[0];let i=r.CONST.MAX_INTEGER,o=-r.CONST.MAX_INTEGER,a=!1;for(const e of s.getAllCurves()){const s=t.getCurve3d(e),c=new r.Line3d(s.getStartPt(),t.getNorm(),[0,r.CONST.MODEL_MAX_LENGTH]),l=r.MathAlg.CalculateIntersect.curveSurface(c,n);if(l.length>0){const e=s.getStartPt().distanceTo(l[0]);e<i&&(i=e),e>o&&(o=e),a=!0}}return a?{minDis:i,maxDis:o}:void 0}_analyseLoop(e,t,n){let s=new r.Polygon(e);const i=new Map,o=[];t.map((e=>e.map((e=>o.push(e)))));const a=[];n.map((e=>e.map((e=>a.push(e)))));const c=o.map(((e,t)=>({loop:e,projInfo:a[t]}))),l=this._sortInfo(c);for(const e of l){if(e.loop instanceof r.Polygon){const t=r.MathAlg.BoolOperateClipper.boolOperate([s],1,[e.loop]);t.getLoops().length>0&&(i.set(t,e.projInfo),s=r.MathAlg.BoolOperateClipper.boolOperate([s],2,[e.loop]))}if(s.getLoops().length<1)return i}return i}_sortInfo(e){const t=[],n=[],s=[];for(const i of e){const o=i.loop.loops[0],a=i.projInfo.projFace;let c=r.CONST.MAX_INTEGER,l=-r.CONST.MAX_INTEGER,d=0;for(const t of o.getAllPoints()){const n=this._projectPlane.getPtAt(t),s=new r.Line3d(n,this._projectPlane.getNorm(),[0,r.CONST.MODEL_MAX_LENGTH]),o=r.MathAlg.CalculateIntersect.curveSurface(s,a.getSurface());if(o.length>0){const t=n.distanceTo(o[0]);t<c&&(c=t),t>l&&(l=t);for(const t of e){if(t===i)continue;if(r.MathAlg.PositionJudge.loopToLoop(i.loop.loops[0],t.loop.loops[0])===r.MathAlg.LoopLoopPositonType.OUT)continue;if(r.MathAlg.CalculateDistance.pointToSurfaceSigned(n,t.projInfo.projFace.getSurface())*r.MathAlg.CalculateDistance.pointToSurfaceSigned(o[0],t.projInfo.projFace.getSurface())<-this._tol.lengthEps){d++;break}}}}i.projInfo.distance=c,i.projInfo.upDistance=l,0===d?t.push(i):d!==o.getAllPoints().length?n.push(i):s.push(i)}return t.sort(((e,t)=>e.loop.calcArea()-t.loop.calcArea())),n.sort(((e,t)=>e.projInfo.distance-t.projInfo.distance)),s.sort(((e,t)=>e.projInfo.distance-t.projInfo.distance)),t.concat(n).concat(s)}_polygonPosition(e,t){const n=e.getLoops(),s=t.getLoops();let i,o=1,a=1;for(const e of n)for(const t of s){const n=r.MathAlg.PositionJudge.loopToLoop(e,t);if(n===r.MathAlg.LoopLoopPositonType.INTERSECT)return n;if(i){if(i!==n||n!==r.MathAlg.LoopLoopPositonType.OUT)if(i!==n||n!==r.MathAlg.LoopLoopPositonType.IN){if(i!==n||n!==r.MathAlg.LoopLoopPositonType.EQUAL){if(i!==n||n!==r.MathAlg.LoopLoopPositonType.CONTAIN)return r.MathAlg.LoopLoopPositonType.INTERSECT;a++}}else o++}else i=n}return i===r.MathAlg.LoopLoopPositonType.IN&&o/n.length%2==0||i===r.MathAlg.LoopLoopPositonType.CONTAIN&&a/s.length%2==0||i===r.MathAlg.LoopLoopPositonType.OUT?r.MathAlg.LoopLoopPositonType.OUT:i===r.MathAlg.LoopLoopPositonType.EQUAL?r.MathAlg.LoopLoopPositonType.EQUAL:i===r.MathAlg.LoopLoopPositonType.CONTAIN?r.MathAlg.LoopLoopPositonType.CONTAIN:i}_judgeBodyPosition(e){const t=e.getVertexs().map((e=>e.getPoint()));let n=0,s=0;for(const e of t)r.MathAlg.CalculateDistance.pointToSurfaceSigned(e,this._projectPlane)>this._tol.lengthEps?s++:n++;return n>0&&0===s?i.DOWN:s>0&&0===n?i.UP:i.ON}}},83205:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ShellBuilder=void 0;const i=n(98106),o=n(25574);class a{static createShell(e,t,n){const r={addShells:[]};return r.addShells.push(o.createShellFromCurve3ds.createShell(e,t,n)),r}static createFacesFromCurves(e,t,n,r){const s={};return s.addShells=o.createShellFromCurve3ds.createShells(e,t,n,r),s}}r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Surface,Array,i.Tolerance]),s("design:returntype",Object)],a,"createShell",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Surface,Array,Object,i.Tolerance]),s("design:returntype",Object)],a,"createFacesFromCurves",null),t.ShellBuilder=a},25574:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createShellFromCurve3ds=void 0;const r=n(98106),s=n(91343),i=n(40775),o=n(52928),a=n(9548),c=n(70750),l=n(52667),d=n(28373),u=n(75434);t.createShellFromCurve3ds=class{static createSingWireShell(e,t,n){const s=n||r.Tolerance.DEFAULT,i=new l.Shell;if(!this._checkCurve3dsStrictValid(t,s.lengthEps))return i;const o=new c.Face(e,!0),a=this._createWireFromCurve3ds(i,t);return o.addWire(a),i.addFace(o),i}static createShell(e,t,n){const s=n||r.Tolerance.DEFAULT,i=new l.Shell;for(const e of t)if(!this._checkCurve3dsStrictValid(e,s.lengthEps))return i;const o=new c.Face(e,!0);for(const e of t){const t=this._createWireFromCurve3ds(i,e);o.addWire(t)}return i.addFace(o),i}static createShells(e,t,n,s){const i=s||r.Tolerance.DEFAULT,o=[];if(n&&n.checkOverlap){const r={pointVertexMap:new Map,curveEdgesMap:new Map},s=[];for(const o of t){const t=new l.Shell,a=new c.Face(e.clone(),!0);for(const e of o){const s=this._createWireFromCurve3dsWithCache(t,e,r,i,n);a.addWire(s)}t.addFace(a),s.push(a)}d.mergeShells(s,void 0,!0);let a=s.map((e=>e.getShell()));a=Array.from(new Set(a)),o.push(...a)}else t.forEach((t=>o.push(this.createShell(e,t,i))));return o}static _checkCurve3dsStrictValid(e,t){const n=e[e.length-1].getEndPt();for(let r=0;r<e.length;r++)if(0===r){if(!e[r].getStartPt().equals(n,t))return!1}else if(!e[r].getStartPt().equals(e[r-1].getEndPt(),t))return!1;return!0}static _createWireFromCurve3ds(e,t){const n=new o.Wire,r=new s.Vertex(t[0].getStartPt());let c=r;e.addVertex(r);for(let o=0;o<t.length;o++){let l;if(o===t.length-1)l=new a.Edge(t[o],c,r);else{const n=new s.Vertex(t[o].getEndPt());e.addVertex(n),l=new a.Edge(t[o],c,n),c=n}e.addEdge(l);const d=new i.Coedge3d(l,!0);n.addCoedge3d(d)}return n}static _createWireFromCurve3dsWithCache(e,t,n,c,l){const d=(t,n)=>{let r;for(const[e,s]of n)if(e.equals(t,c.lengthEps)){r=s;break}return r||(r=new s.Vertex(t),e.addVertex(r),n.set(t,r)),r},h=[];for(const s of t){let t,o=!0;for(const[e,i]of n.curveEdgesMap)if(r.MathAlg.PositionJudge.curveCurveOverlap(e,s,c.lengthEps,c.angleEps)===r.MathAlg.CurveCuvePositonType.TOTALLY_OVERLAP){t=i.slice(),o=e.getStartPt().equals(s.getStartPt(),c.lengthEps)&&e.getStartTangent().equals(s.getStartTangent(),c.lengthEps),o||t.reverse();break}if(!t){if(t=[],l&&l.smoothTess){const e=s.discrete();for(let s=0;s<e.length-1;s++){const i=d(e[s],n.pointVertexMap),o=d(e[s+1],n.pointVertexMap);s+1!==e.length-1&&o.setSmooth(!0);const c=new a.Edge(new r.Line3d(i.getPoint(),o.getPoint()),i,o);t.push(c)}}else{const e=d(s.getStartPt(),n.pointVertexMap),r=d(s.getEndPt(),n.pointVertexMap);t.push(new a.Edge(s,e,r))}t.forEach((t=>e.addEdge(t))),n.curveEdgesMap.set(s,t),u.ContinuousUtil.addContinuousEdgeInfo(t,(()=>s))}for(const e of t){const t=new i.Coedge3d(e,o);h.push(t)}}return new o.Wire(h)}}},54557:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ShellEdit=void 0;const i=n(98106),o=n(52667),a=n(15770),c=n(34652),l=n(70750),d=n(7951),u=n(91475),h=n(9548),g=n(75373),f=n(45786),p=n(21554),_=n(30972),m=n(50637),v=n(75434),E=n(23898),P=n(84775),y=n(30896),C=n(46511),S=n(32696),T=n(45759),b=n(38349);class w{static addEdges(e,t=[],n=undefined){return new a.default(e,n,t).execute()}static splitEdge(e,t){return new T.default(e,t).execute()}static mergeEdges(e){return new b.default(e).execute()}static moveEdgesPreview(e,t){return new f.MoveEdges(e,t).preview()}static moveEdges(e,t,n=[]){return new f.MoveEdges(e,t,n).execute()}static moveFaces(e,t,n=[]){return new p.MoveFaces(e,t,n).execute()}static facesAndShellsMerge(e,t,n=!1,r,s){const i=new m.default(e,t,n,!0,s).execute();return r?(c.mergeShellModelingResult(r,i),r):i}static mergeConnectedFaces(e,t){const n=new E.default(e).execute();return t?(c.mergeShellModelingResult(t,n),t):n}static pullPushFace(e,t,n=[],r=!1,s=!0,i=!0){return new d.default(e,t,n,r,s,i).execute()}static pullPushFacePreview(e,t,n=!1){return new P.default(e,t,n).execute()}static isolateFaces(e,t){return new u.default(Array.from(t),e).execute()}static copyFaces(e,t,n){return new g.default(e,t,n).execute()}static deleteFacesAndEdges(e,t,n){return new y.default(e,t,n).execute()}static makeRounding2D(e,t,n,r=[],s=!1){return new _.Rounding2D(e,t,n,r,s).execute()}static fillet(e,t,n=[]){return new S.Fillet3d(e,t,n).execute()}static filletPreview(e,t){return new C.Fillet3dPreview(e,t).execute()}static transformShells(e,t){const n={modifiedShellsMap:new Map};return e.forEach((e=>{e.transform(t),n.modifiedShellsMap.set(e,{modifiedFaces:e.getFaces().slice()}),v.ContinuousUtil.transformContinuousEdgeInfo(e.getEdges(),t)})),n}}r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[h.Edge,Array]),s("design:returntype",void 0)],w,"splitEdge",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array]),s("design:returntype",void 0)],w,"mergeEdges",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,i.Vector3]),s("design:returntype",Object)],w,"moveEdgesPreview",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,i.Vector3,Array]),s("design:returntype",Object)],w,"moveEdges",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,i.Vector3,Array]),s("design:returntype",Object)],w,"moveFaces",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Array,Boolean,Object,i.Tolerance]),s("design:returntype",Object)],w,"facesAndShellsMerge",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Object]),s("design:returntype",Object)],w,"mergeConnectedFaces",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[l.Face,i.Vector3,Array,Boolean,Boolean,Boolean]),s("design:returntype",Object)],w,"pullPushFace",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[l.Face,i.Vector3,Boolean]),s("design:returntype",Object)],w,"pullPushFacePreview",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Shell,Set]),s("design:returntype",Object)],w,"isolateFaces",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Boolean,i.Matrix4]),s("design:returntype",Object)],w,"copyFaces",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Array,Boolean]),s("design:returntype",Object)],w,"deleteFacesAndEdges",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[h.Edge,h.Edge,Number,Array,Boolean]),s("design:returntype",Object)],w,"makeRounding2D",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Number,Array]),s("design:returntype",Object)],w,"fillet",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Number]),s("design:returntype",Array)],w,"filletPreview",null),r([i.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,i.Matrix4]),s("design:returntype",Object)],w,"transformShells",null),t.ShellEdit=w},15770:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(97510),s=n(21755);class i extends r.default{constructor(e,t,n){super(n),this._curves=e,this._curvePlane=t}_executeImpl(){const e={faceSplitMap:new Map,newOuterFaces:[]};try{s.addEdgesCore(this._curves,this._curvePlane,this._contextShells,e)}catch(t){return e.errorStr=t,e}return e.faceSplitMap.size>0||e.newOuterFaces.length>0||(e.errorStr="输入的几何元素不支持"),e}}t.default=i},21755:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addEdgesCore=void 0;const r=n(98106),s=n(70750),i=n(52667),o=n(34652),a=n(9548),c=n(91343),l=n(40775),d=n(90471),u=n(52928),h=n(28373),g=n(11593),f=n(7261),p=n(28465),_=n(70455),m=n(39781),v="输入线条不是共面的.",E="输入线条无效.",P="不能找到有效的平面.",y=new r.Tolerance(r.Tolerance.LENGTH_EPS,2*r.Tolerance.ANGLE_EPS);function C(e,t){e.some((e=>e.isCoplanar(t,y)))||e.push(t.clone())}function S(e,t,n){let r=e.get(t);r||(r=[],e.set(t,r)),r.push(n)}function T(e,t,n){let r;for(const s of e)if(s.has(t)||s.has(n)){r=s;break}r||(r=new Set,e.push(r)),r.add(t),r.add(n)}function b(e,t){const n=e.filter((e=>!r.MathUtil.isNearlyZero(e.getLength())));n.forEach((e=>t.set(e,[e])));const s=new r.Box3,i=new Map;n.forEach((e=>{const t=e.getBoundingBox();i.set(e,t),s.union(t)}));const o=s.getCenter().subtracted(new r.Vector3(0,0,s.getSize().z/2)),a=Math.max(...s.getSize().toArray3()),c=e=>{const t=i.get(e);return[t.min,t.max]},l=new m.Octree(n,c,o,a[2]+100),d=[];return function(e,t,n,s){const i=new Map,o=new Set,a=e.length;for(let s=0;s<a;s++){const a=e[s];o.add(a);const c=t(a).filter((e=>!o.has(e)));for(const e of c){const t=r.MathAlg.CalculateIntersect.curve3ds(a,e);let s=!1;const o=[];if(t.forEach((e=>{e.isOverlap?(o.push(a.getPtAt(e.overlap1.min)),o.push(a.getPtAt(e.overlap1.max)),s=!0):o.push(e.point)})),o.length){s&&T(n,a,e);for(const t of o)S(i,a,t),S(i,e,t)}}}const c=[];for(let t=0;t<a;t++){const o=e[t],a=i.get(o);if(!a||0===a.length){c.push(o);continue}const l=r.GeomUtil.splitCurveByPoints(o,a);if(l.length){const e=s.get(o);for(const t of l)p.SmoothUtil.copySmoothInfo(o,t),c.push(t),e&&s.set(t,e);s.delete(o);for(const e of n)if(e.has(o)){e.delete(o),l.forEach((t=>e.add(t)));break}}else c.push(o)}e.splice(0,e.length),e.push(...c)}(n,(e=>l.getCandidateOverlaps(e,c(e)).filter((t=>t!==e&&i.get(e).intersectsBox(i.get(t))))),d,t),function(e,t,n){const s=new Set(e);for(const e of t){const t=new Map;for(const n of e){let e=!1;for(const[s,i]of t)if(r.MathAlg.PositionJudge.curveCurveOverlap(s,n)===r.MathAlg.CurveCuvePositonType.TOTALLY_OVERLAP){i.push(n),e=!0;break}e||t.set(n,[n])}for(const e of t.values()){if(e.length<=1)continue;const t=n.get(e[0])||[];for(let r=1;r<e.length;r++)s.delete(e[r]),t.concat(n.get(e[r])||[]),n.delete(e[r]);n.set(e[0],t)}}e.splice(0,e.length),s.forEach((t=>e.push(t)))}(n,d,t),n}function w(e,t,n,s,i,o){if(!n.length)return;const a=new r.Box3;if(e.forEach((e=>a.union(e.getBoundingBox()))),!a.isValid())return;const c=new Set;for(const e of n){if(!e||0===e.getFaces().length)continue;const t=e.getFaces(),n=t.map((e=>e.getBoundingBox())),s=new r.Box3;if(n.forEach((e=>s.union(e))),s.intersectsBox(a))for(let e=0;e<t.length;e++){n[e].intersectsBox(a)&&c.add(t[e])}}const l=new Set;for(const e of c)t.isCoplanar(e.getSurface(),y)?s.add(e):l.add(e);for(const e of s){e.getEdges().forEach((e=>i.add(e)));const n=e.getVertexes();for(const e of n){o.add(e);for(const n of e.getEdges()){if(i.has(n))continue;const e=n.getCurve();e&&t.containsCurve(e)&&(i.add(n),o.add(n.getStartVertex()),o.add(n.getEndVertex()))}}}for(const e of l){for(const t of e.getEdges()){if(i.has(t))continue;const e=t.getCurve().getBoundingBox();e&&e.intersectsBox(a)&&(i.add(t),o.add(t.getStartVertex()),o.add(t.getEndVertex()))}for(const n of e.getVertexes())t.containsPoint(n.getPoint())&&o.add(n)}}function x(e,t,n){let r;n.has(e)?r=n.get(e):(r=new Set,n.set(e,r)),r.add(t)}function M(e,t,n,s,i,l,d){for(const e of t){const t=e.getParent();t&&o.addShellModifyInfo(l,t)}let u=new Set(t);if(u.size){const t=new Set,n=[];!function(e,t,n,s,i){const o=new Set;for(const e of t)o.add(e.getStartVertex()),o.add(e.getEndVertex());const a=new WeakMap;for(const n of e)for(const e of t){const t=r.MathAlg.CalculateIntersect.curve3ds(n,e.getCurve()),s=[];t.forEach((e=>{e.isOverlap?(s.push(n.getPtAt(e.overlap1.min)),s.push(n.getPtAt(e.overlap1.max))):s.push(e.point)}));for(const t of s){let r;for(const e of o)if(e.getPoint().equals(t)){r=e;break}r||(r=e.getParent().createVertex(t),o.add(r)),x(n,r,a),x(e,r,a)}}n.splice(0,n.length);for(const t of e){if(!a.has(t)){n.push(t);continue}const e=r.GeomUtil.splitCurveByPoints(t,Array.from(a.get(t)).map((e=>e.getPoint())));if(e.length>0){const r=i.get(t);for(const s of e)p.SmoothUtil.copySmoothInfo(t,s),n.push(s),r&&i.set(s,r);i.delete(t)}else n.push(t)}s.clear();for(const e of t){if(!a.has(e)){s.add(e);continue}const t=f.splitEdgeByVertices(e,Array.from(a.get(e)));if(t.length>1)for(const e of t)s.add(e);else s.add(e)}}(e,u,n,t,d),e.splice(0,e.length),e.push(...n),u=t}!function(e,t,n,s,i,o){const l=new Set(n);for(const e of t)l.add(e.getStartVertex()),l.add(e.getEndVertex());const d=new Map;t.forEach((e=>d.set(e,e.getCurve())));for(const n of e){let e;for(const s of t)if(r.MathAlg.PositionJudge.curveCurveOverlap(d.get(s),n)===r.MathAlg.CurveCuvePositonType.TOTALLY_OVERLAP){e=s,i.add(e);break}if(!e){let t,r;for(const e of l)if(e.getPoint().equals(n.getStartPt())){t=e;break}t||(t=new c.Vertex(n.getStartPt()),l.add(t));for(const e of l)if(e.getPoint().equals(n.getEndPt())){r=e;break}r||(r=new c.Vertex(n.getEndPt()),l.add(r));const i=n.clone();e=new a.Edge(i,t,r),s.add(e),p.SmoothUtil.copySmoothInfo(n,e)}const u=o.get(n);u&&(o.set(e,u),o.delete(n))}}(e,u,n,s,i,d)}function N(e,t,n,s,i){const o=new Map,a=(t,n)=>{for(const a of t){const t=a.getCurve().getMidPt();let c;for(const n of e){let e=o.get(n);e||(e=n.calcPolygon(),o.set(n,e));const s=n.getSurface();if(s.containsPoint(t)&&r.MathAlg.PtLoopPositonType.IN===r.MathAlg.PositionJudge.ptToPolygon(s.getUVAt(t),e)){c=n;break}}c?S(s,c,a):n||i.push(a)}};a(t,!1),a(n,!0)}function A(e,t,n){function r(e,t,n){for(const r of e.edges){n.add(r.edge);const e=t.get(r.edge);e&&(r.bSameDir?e.validP=!1:e.validN=!1)}}function s(e,t,n,s){for(const[i,o]of t){if(o.validP){const o=d.detectLoopFromEdges(i,!0,e,!0);o&&(r(o,t,s),n.push(o))}if(o.validN){const o=d.detectLoopFromEdges(i,!1,e,!0);o&&(r(o,t,s),n.push(o))}}}const i=new Map;t.forEach((e=>i.set(e,{validP:!0,validN:!0})));const o=e.getSurface(),a=[],c=new Set;if(o.isCylinder()){const s=new Set(t);e.getEdges().forEach((e=>s.add(e)));const c=(n,o)=>{var c;const l=new d.VirtualLoop;let u;l.add(n,o);const h=o?n.getStartVertex():n.getEndVertex();let g=o?n.getEndVertex():n.getStartVertex();for(;h!==g;){const n=g.getEdges().filter((e=>s.has(e)));if(!n.length)break;if(u){const e=n.filter((e=>t.findIndex((t=>t===e))>-1));if(e.length){u=void 0;const t=e[0].getStartVertex()===g;l.add(e[0],t),g=t?e[0].getEndVertex():e[0].getStartVertex()}else u=u.getNextCoedge(),l.add(u.getEdge(),u.getSameDirWithEdge()),g=u.getEndVertex()}else{const t=n.filter((t=>e.getEdges().findIndex((e=>e===t))>-1));if(t.length){for(const n of t)for(const t of n.getCoedge3ds())(null===(c=t.getWire())||void 0===c?void 0:c.getFace())===e&&t.getStartVertex()===g&&(u=t);if(!u)break;l.add(u.getEdge(),u.getSameDirWithEdge()),g=u.getEndVertex()}else{const e=l.edges[l.edges.length-1].edge;n.sort(((t,n)=>(t===e?1:0)-(n===e?1:0)));const t=n[0].getStartVertex()===g;l.add(n[0],t),g=t?n[0].getEndVertex():n[0].getStartVertex()}}}r(l,i,new Set);const f=l.edges.some((e=>e.edge.getCurve().isLine3d())),p=l.edges.some((e=>e.edge.getCurve().isArc3d()));if(f&&p&&l.edges.length>1&&h===g){const e=new Set;l.edges.forEach((t=>e.add(t))),e.size===l.edges.length&&a.push(l)}};for(const[e,t]of i)t.validP&&c(e,!0),t.validN&&c(e,!1);if(2===a.length){const t=a.map((e=>new d.VirtualFace([e],o)));n.set(e,t)}}else if(s(o,i,a,c),a.length){i.clear();for(const t of e.getWires())if(t.getCoedge3ds().some((e=>c.has(e.getEdge()))))for(const e of t.getCoedge3ds())c.has(e.getEdge())||(e.getSameDirWithEdge()?i.set(e.getEdge(),{validP:!0,validN:!1}):i.set(e.getEdge(),{validP:!1,validN:!0}));else{const e=new d.VirtualLoop;t.getCoedge3ds().forEach((t=>e.add(t.getEdge(),t.getSameDirWithEdge()))),a.push(e)}s(o,i,a,c);const t=d.virtualLoopsToFaces(a,o);n.set(e,t)}}function O(e){const t=new d.VirtualLoop;return e.edges.forEach((e=>t.add(e.edge,!e.bSameDir))),t.edges.reverse(),t.bc3ds.reverse(),t}function I(e,t,n){let s=t.get(e);if(!s){s={validP:!0,validN:!0},t.set(e,s);for(const t of e.getCoedge3ds())if(t){const e=t.getWire().getParent().getSurface();e instanceof r.Plane&&e.getNorm().isParallel(n.getNorm())&&(t.getSameDirWithEdge()===e.getNorm().isSameDirection(n.getNorm())?s.validP=!1:s.validN=!1)}}return s}function D(e,t,n,r,s){const i=I(e,n,r);s?t?i.validP=!1:i.validN=!1:t?i.validN=!1:i.validP=!1}function L(e,t,n,s){const i=new Map,o=e.slice();t.forEach((e=>o.push(e)));for(const e of o)t.has(e)?I(e,i,n):i.set(e,{validP:!0,validN:!0});function a(e,t,n,r,s){(function(e,t,n){const r=e.getArea(n)>0;for(const s of e.edges){const e=I(s.edge,t,n);if(s.bSameDir===r&&!e.validP||s.bSameDir!==r&&!e.validN)return}return e})(n,r,e)&&(s.push(new d.VirtualFace([t?n:O(n)],e)),n.edges.forEach((n=>D(n.edge,n.bSameDir===t,i,e,!0))))}for(const e of o){const t=i.get(e);if(t.validP&&t.validN){const t=d.detectLoopFromEdges(e,!0,n,!0);if(t&&t.edges.filter((t=>t.edge===e)).length>1)continue;const o=d.detectLoopFromEdges(e,!0,n,!1);if(o&&o.edges.filter((t=>t.edge===e)).length>1)continue;if(t&&o){const e=t.getArea(n)>0,c=o.getArea(n)>0;if(e!==c)a(n,e,t,i,s),a(n,c,o,i,s);else{let c,l;r.MathUtil.isNearlyBigger(Math.abs(t.getArea(n)),Math.abs(o.getArea(n)))?(c=o,l=t):(c=t,l=o),a(n,e,c,i,s),l.edges.forEach((t=>D(t.edge,t.bSameDir===e,i,n,!1)))}}else if(t||o){const e=t||o,r=e.getArea(n)>0;a(n,r,e,i,s)}}else if(t.validP||t.validN){const r=e,o=!!t.validP,c=d.detectLoopFromEdges(r,o,n,!0);if(!c||c&&c.edges.filter((e=>e.edge===r)).length>1)continue;const l=c.getArea(n)>0;a(n,l,c,i,s)}}}function V(e,t,n,s,i){if(!e.length&&!t.size)return;const o=new Set;if(e.forEach((e=>{e.getStartVertex().getEdges().forEach((e=>o.add(e))),e.getEndVertex().getEdges().forEach((e=>o.add(e)))})),t.size||e.length!==o.size?L(e,t,s,i):function(e,t,n){const r=new Map,s=e.slice();for(const e of s)r.set(e,{validP:!0,validN:!0});const i=[];function o(e,t){let n=!0;for(const r of e.edges){const e=t.get(r.edge);(r.bSameDir&&!e.validP||!r.bSameDir&&!e.validN)&&(n=!1)}n&&(i.push(e),e.edges.forEach((e=>{const n=t.get(e.edge);e.bSameDir?n.validP=!1:n.validN=!1})))}for(const e of s){const n=r.get(e);if(n.validP&&n.validN){const n=d.detectLoopFromEdges(e,!0,t,!0);if(n&&n.edges.filter((t=>t.edge===e)).length>1)continue;const s=d.detectLoopFromEdges(e,!1,t,!0);if(s&&s.edges.filter((t=>t.edge===e)).length>1)continue;n&&o(n,r),s&&o(s,r)}else if(n.validP||n.validN){const s=e,i=!!n.validP,a=d.detectLoopFromEdges(s,i,t,!0);if(!a||a&&a.edges.filter((e=>e.edge===s)).length>1)continue;o(a,r)}}i.length&&n.push(...d.virtualLoopsToFaces(i,t,!0))}(e,s,i),!i.length)return;const a=function(e,t){const n=new Set;for(const t of e)t.getEdges().forEach((e=>n.add(e)));const s=new Set;for(const e of n){let n=0;const i=e.getCoedge3ds().map((e=>e.getWire().getParent()));for(const e of i){const s=e.getSurface();if(s instanceof r.Plane&&s.isCoplanar(t,y)&&n++,n>1)break}n<=1&&s.add(e)}return s}(n,s);if(!a.size)return;i.forEach((e=>e.loops.forEach((e=>e.edges.forEach((e=>a.delete(e.edge)))))));const c=[],l=new Map;a.forEach((e=>l.set(e,{valid:!0})));for(const[e,t]of l)if(t.valid){const t=d.detectLoopFromEdges(e,!0,s,!0,a);if(t&&t.edges.every((e=>{var t;return!l.get(e.edge)||(null===(t=l.get(e.edge))||void 0===t?void 0:t.valid)}))){c.push(t);for(const e of t.edges){const t=l.get(e.edge);t&&(t.valid=!1),a.delete(e.edge)}}}c.length&&function(e,t,n){function s(e,t){return e.approxPts.every((e=>r.MathAlg.PositionJudge.ptToLoop(e,new r.Loop(t.bc2ds)).type===r.MathAlg.PtLoopPositonType.IN))}e.forEach((e=>e.loops.forEach((e=>e.prepareData(n))))),t.forEach((e=>e.prepareData(n)));const i=t.slice();t=t.filter((e=>{for(const t of i)if(t!==e&&s(e,t))return!1;return!0}));for(const r of e){const e=r.outerLoop();for(const i of t)if(i.box.intersectsBox(e.box)&&s(i,e)){const t=e.getArea(n)>0==i.getArea(n)>0?O(i):i;r.addInnerLoop(t)}}}(i,c,s)}function R(e,t){t.addFace(e),e.getEdges().forEach((e=>t.addEdge(e))),e.getVertexes().forEach((e=>t.addVertex(e)))}function U(e){for(const t of e.getVertexes()){const e=t.getParent();if(e)return e}}function B(e,t,n,r,a,c){for(const[t,n]of e){const e=[];for(const r of n){const n=r.loops.map((e=>{const t=e.edges.map((e=>new l.Coedge3d(e.edge,e.bSameDir)));return new u.Wire(t)}));e.push(new s.Face(r.plane.clone(),t.getSameDirWithSurface(),n))}const r=t.getShell();e.length&&(e.forEach((e=>R(e,r))),g.disposeFace(t),o.addShellModifyInfo(c.modifiedShellsMap,r,e,[t])),c.faceSplitMap.set(t,e)}for(const e of t){const t=new s.Face(e.plane.clone(),!0),r=e.loops.map((e=>{const t=e.edges.map((e=>new l.Coedge3d(e.edge,e.bSameDir)));return new u.Wire(t)}));t.setWires(r);let a=U(t);a?c.addShells.indexOf(a)<0&&o.addShellModifyInfo(c.modifiedShellsMap,a,[t]):(a=new i.Shell,n.push(a),c.addShells.push(a)),R(t,a),c.newOuterFaces.push(t)}for(const e of r)e.getCoedge3ds().length?p.SmoothUtil.hasSmoothInfo(e)&&a.add(e):e.dispose()}t.addEdgesCore=function(e,t,n,s){s.addShells=[],s.modifiedShellsMap=new Map;let i=p.SmoothUtil.decomposeSmoothPoly(e.slice()),c=[];if(t)c=[t];else{const e=function(e,t){let n=[];for(const t of e)if(t instanceof r.Arc3d){const e=t;C(n,new r.Plane(e.getCoord())),e.isEqualAB()&&C(n,new r.Cylinder(e.getCoord(),e.getA(),e.getB()))}else t instanceof r.OffsetCurve3d&&t.getBaseCurve()instanceof r.Arc3d&&C(n,new r.Plane(t.getBaseCurve().getCoord()));const s=[];for(const t of e){let e=[];e=t.isNurbsCurve3d()?t.getControlPoints().slice():t.discrete(),e.forEach((e=>{s.every((t=>!t.equals(e)))&&s.push(e)}))}if(n.length)return n=n.filter((e=>s.every((t=>e.containsPoint(t))))),n.length?{surfs:n,state:!0}:(t.errorStr=v,{surfs:[],state:!1});const i=r.Plane.makePlaneByPoints(s);if(i)return s.every((e=>i.containsPoint(e)))?{surfs:[i],state:!0}:(t.errorStr=v,{surfs:[],state:!1});return{surfs:[],state:!0}}(i,s);if(!e.state)return;c=e.surfs}const l=new Map;if(i=b(i,l),!i.length)return void(s.errorStr=E);const d=n.slice();if(function(e,t,n){if(!n.length){const s=new r.Box3;e.forEach((e=>s.union(e.getBoundingBox())));const i=new Set,o=new Set;for(const a of t)for(const t of a.getFaces()){const a=t.getSurface(),c=t.getBoundingBox();if(c&&c.intersectsBox(s))if((a.isPlane()||a.isCylinder())&&e.every((e=>a.containsCurve(e,r.Tolerance.LENGTH_EPS))))C(n,a),t.getEdges().forEach((e=>i.add(e)));else for(const e of t.getEdges()){const t=e.getBoundingBox();t&&t.intersectsBox(s)&&o.add(e)}}i.forEach((e=>o.delete(e)));for(const t of o){const s=t.getCurve();for(const t of e){if(!r.MathAlg.CalculateIntersect.curve3ds(t,s).length)continue;let e;if(s instanceof r.Line3d)e=r.Plane.makePlaneByPoints([t.getStartPt(),t.getEndPt(),s.getStartPt(),s.getEndPt()]);else if(s instanceof r.Arc3d){const n=new r.Plane(s.getCoord());n.containsCurve(t)&&(e=n)}if(e){C(n,e);break}}}}}(i,d,c),!c.length)return void(s.errorStr=P);const u=new Set;for(const e of c){const t=new Set,n=new Set,r=new Set;w(i,e,d,t,n,r);const o=new Set,a=new Set;M(i,n,r,a,o,s.modifiedShellsMap,l);const c=new Map,h=[];N(t,Array.from(a),Array.from(o),c,h);const g=new Map;for(const e of t){const t=c.get(e);if(t)try{A(e,t,g)}catch(e){s.errorStr=e}}const f=[];if(e.isPlane())try{V(h,o,t,e,f)}catch(e){s.errorStr=e}B(g,f,d,a,u,s)}const g=Array.from(s.faceSplitMap.values()).flat();s.newOuterFaces.forEach((e=>g.push(e)));const f=h.mergeShells(g);f.deleteShell.forEach((e=>{var t;(null===(t=s.modifiedShellsMap)||void 0===t?void 0:t.has(e))&&s.modifiedShellsMap.delete(e)}));for(const[e,t]of f.addFaceMap)o.addShellModifyInfo(s.modifiedShellsMap,e,t);s.deleteShells=n.filter((e=>!e.getFaces().length)),s.addShells=s.addShells.filter((e=>e.getFaces().length)),s.evolutionMap=new Map;for(const[e,t]of s.faceSplitMap)t.forEach((t=>o.addEvolutionInfo(s,e,t)));for(const[e,t]of l)e instanceof a.Edge&&t.forEach((t=>o.addEvolutionInfo(s,t,e)));!function(e,t){const n=e.newOuterFaces.slice();for(const t of e.faceSplitMap.values())n.push(...t);if(n.forEach((e=>{p.SmoothUtil.udpateSmoothVertices(new Set(e.getVertexes()))})),t.size){_.ContinuousUtil.addContinuousEdgeInfo(Array.from(t),(e=>{var t;return null===(t=p.SmoothUtil.getSmoothInfo(e))||void 0===t?void 0:t.getCurve()}));for(const e of t){p.SmoothUtil.clearSmoothInfo(e);const n=e.getStartVertex(),r=e.getEndVertex();!n.getSmooth()&&2===n.getEdges().length&&n.getEdges().every((e=>t.has(e)))&&n.setSmooth(!0),!r.getSmooth()&&2===r.getEdges().length&&r.getEdges().every((e=>t.has(e)))&&r.setSmooth(!0)}}}(s,u)}},75373:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(52667),s=n(70750),i=n(52928),o=n(40775),a=n(91343),c=n(9548),l=n(98719),d=n(34652),u=n(75434),h=n(97510);class g extends h.default{constructor(e,t,n,r=[]){super(r),this._faces=e,this._reuseTag=t,this._matrix=n}_executeImpl(){const e=new Map;for(const t of this._faces){const n=t.getShell();n&&(e.has(n)?e.get(n).push(t):e.set(n,[t]))}const t={addShells:[],evolutionMap:new Map};for(const[n,r]of e){const e=new Map,s=this._cloneFacesByShell(n,r,this._reuseTag,e);this._matrix&&(s.transform(this._matrix),u.ContinuousUtil.transformContinuousEdgeInfo(s.getEdges(),this._matrix));for(const[n,r]of e)d.addEvolutionInfo(t,n,r);t.addShells.push(s)}return t}_cloneFacesByShell(e,t,n,d){const h="TOPO_CLONE";function g(e,t){const n=e.getCoedge3ds().map((e=>function(e,t){var n;const r=e.getEdge().userData[h],s=new o.Coedge3d(r,e.getSameDirWithEdge());return s.setPCurve(null===(n=e.getPCurve())||void 0===n?void 0:n.clone()),t&&(s.tag=e.tag),s}(e,t))),r=new i.Wire(n);return t&&(r.tag=e.tag),r}function f(e,t){const n=new s.Face(e.getSurface().clone(),e.getSameDirWithSurface());n.setData(l.BrepUtil.loadMapObj(l.BrepUtil.dumpMapObj(e.getData()))),t&&(n.tag=e.tag);for(const r of e.getWires()){const e=g(r,t);n.addWire(e)}return n}const p=new r.Shell;if(n&&(p.tag=e.tag),!t.length)return p;const _=new Set,m=new Set;t.forEach((e=>{e.getEdges().forEach((e=>m.add(e))),e.getVertexes().forEach((e=>_.add(e)))}));const v=Array.from(_);(function(e){const t=[];for(let n=0,r=e.length;n<r;n++){const r=e[n],s=new a.Vertex(r.getPoint());s.setFlags(r.getFlags()),s.setData(l.BrepUtil.loadMapObj(l.BrepUtil.dumpMapObj(r.getData()))),r.userData=r.userData||{},r.userData[h]=s,t.push(s)}return t})(v).forEach((e=>p.addVertex(e)));const E=Array.from(m);(function(e,t){const n=[];for(let r=0,s=e.length;r<s;r++){const s=e[r],i=s.getStartVertex(),o=s.getEndVertex(),a=i.userData[h],d=o.userData[h],u=new c.Edge(s.getCurve().clone(),a,d);u.setFlags(s.getFlags()),u.setData(l.BrepUtil.loadMapObj(l.BrepUtil.dumpMapObj(s.getData()))),s.userData=s.userData||{},s.userData[h]=u,t&&(u.tag=s.tag),n.push(u)}return n})(E,n).forEach((e=>p.addEdge(e))),u.ContinuousUtil.cloneContinuousEdgeInfo(E,(e=>e.userData[h]));for(const e of t){const t=f(e,n);p.addFace(t),d&&d.set(e,t)}for(const e of v)e.userData[h]=void 0;for(const e of E)e.userData[h]=void 0;return p}}t.default=g},726:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(98106),s=n(34652),i=n(70750),o=n(40775),a=n(52928),c=n(90471),l=n(11593);class d extends c.VirtualFace{}t.default=class{static execute(e){const t={modifiedShellsMap:new Map,evolutionMap:new Map},n=new Set(e),u=new Set;n.forEach((e=>{e.getFaces().forEach((e=>u.add(e)))}));const h=new Map;u.forEach((e=>e.getEdges().forEach((t=>{let n=h.get(t);n||(n=[],h.set(t,n)),n.push(e)}))));const g=e=>{let t;if(e.isPlane()){const n=e;t=n.getOrigin().dot(n.getNorm())}if(e.isCylinder()){const n=e;t=n.getA()*n.getCoord().getOrigin().dot(n.getCoord().getDz())}return`${Math.round(1e5*Math.abs(t))}`},f=new Map;for(const e of u){const t=e.getSurface();if(!t.isPlane()&&!t.isCylinder())continue;const n=g(t);let r=f.get(n);r||(r=[],f.set(n,r));if(!this._findFaceGroup(e,r)){const t=[];t.push(e),r.push(t)}}const p=Array.from(f.values()).flat();p.forEach((e=>this._reverseFaces(e)));const _=e=>{const t=e.getEdge(),r=t.getFaces().filter((e=>u.has(e)));return n.has(t)&&1===r.length},m=[],v=[];for(const e of p){const t=e[0].getSurface(),s=new Map,i=[],o=[];t.isCylinder()&&t.isEqualAB()&&this._processCylinder(e,t,n,v,u);for(const a of e){let c=[],l=[];const d=a.getWires(),u=new Map;for(let r=0;r<d.length;r++){const s=new Map,i=t.wireToUV(d[r].getCoedge3ds().map((e=>{const t=e.getCurve();return s.set(e,t),t})));d[r].getCoedge3ds().forEach((e=>{const t=s.get(e),n=i.mapping.get(t);n&&u.set(e,n)}));const o=d[r].getCoedge3ds().filter((e=>!n.has(e.getEdge()))),a=d[r].getCoedge3ds().length;if(o.length===a)l.push(d[r]);else{const t=new Set;d[r].getCoedge3ds().forEach((e=>t.add(e.getEdge()))),1===e.length&&t.size===a||c.push(...o)}if(r>0&&d[r].getCoedge3ds().filter((e=>_(e))).length){c=[],l=[];break}}l.forEach((e=>{const n=e.getCoedge3ds().map((e=>{if(u.has(e)){const t=u.get(e);return s.set(t,{edge:e.getEdge(),bSameDir:e.getSameDirWithEdge()}),t}const n=t.getCurve2d(e.getCurve());return s.set(n,{edge:e.getEdge(),bSameDir:e.getSameDirWithEdge()}),n}));i.push(new r.Loop(n))})),c.forEach((e=>{if(u.has(e)){const t=u.get(e);s.set(t,{edge:e.getEdge(),bSameDir:e.getSameDirWithEdge()}),o.push(t)}else{const n=t.getCurve2d(e.getCurve());s.set(n,{edge:e.getEdge(),bSameDir:e.getSameDirWithEdge()}),o.push(n)}}))}const a=r.MathAlg.SearchGraph.searchLoop2D(o,!0),l=r.MathAlg.ILoopsToPolygonExes.getNestedLoops(i.concat(a),(e=>e));for(let e=l.length-1;e>=0;e--)if(!l[e].isCCW){const t=l[e].nesting;l.splice(e,1,...t)}const g=[],f=new Map;l.forEach((e=>r.MathAlg.ILoopsToPolygonExes.createFaces(e,!0,f,g))),g.forEach((e=>{const n=e.map((e=>{const t=e.loop.getAllCurves().map((e=>s.get(e))),n=new c.VirtualLoop;return n.edges.push(...t),n})),i=this._getSourceFace(n[0],h);let o=i.getSurface();o.isCoplanar(t,r.Tolerance.DEFAULT)||(o=t);const a=new d(n,o.clone());a.sourceFace=i,m.push(a)}))}for(const e of m){const n=e.loops.map((e=>{const t=e.edges.map((e=>new o.Coedge3d(e.edge,e.bSameDir)));return new a.Wire(t)})),r=new i.Face(e.plane,!0,n),c=e.sourceFace.getShell();c.addFace(r),s.addShellModifyInfo(t.modifiedShellsMap,c,[r]),s.addEvolutionInfo(t,e.sourceFace,r)}return u.forEach((e=>{const n=e.getShell();l.disposeFace(e),s.addShellModifyInfo(t.modifiedShellsMap,n,void 0,[e])})),v.forEach((e=>{const n=e.getShell();s.addShellModifyInfo(t.modifiedShellsMap,n,void 0,void 0,[e])})),t}static _findFaceGroup(e,t){if(0===t.length)return!1;const n=e.getSurface();for(const s of t){const t=s[0].getSurface();if(n.isCoplanar(t,r.Tolerance.DEFAULT))return s.push(e),!0}return!1}static _reverseFaces(e){if(e.length)if(e[0].getSurface().isPlane()){const t=e[0].getSurface().getNorm(),n=e.map((e=>e.getSurface().getNorm().isSameDirection(t)?1:0)),r=n.filter((e=>!!e)).length>=n.length/2?0:1;for(let t=0;t<n.length;t++)n[t]===r&&(e[t].getSurface().reverse(),e[t].getWires().forEach((e=>e.reverse())),e[t].reverse())}else if(e[0].getSurface().isCylinder()){const t=e[0].getSurface().getCenterAxis(),n=e.map((e=>e.getSurface().getCenterAxis().isSameDirection(t)?1:0)),r=n.filter((e=>!!e)).length>=n.length/2?0:1;for(let t=0;t<n.length;t++)n[t]===r&&(e[t].getSurface().getCoord().reverseZDir(),e[t].getWires().forEach((e=>e.reverse())),e[t].reverse())}}static _getSourceFace(e,t){const n=new Map;return e.edges.forEach((e=>{const r=t.get(e.edge);r&&r.forEach((e=>{let t=n.get(e)||0;n.set(e,++t)}))})),Array.from(n).sort(((e,t)=>t[1]-e[1]))[0][0]}static _processCylinder(e,t,n,s,i){var o;let a;for(const e of n){const n=t.getCurve2d(e.getCurve());if(r.MathUtil.isNearlyEqual(n.getStartPt().x,n.getEndPt().x)&&(r.MathUtil.isNearlyEqual(n.getStartPt().x,0)||r.MathUtil.isNearlyEqual(n.getStartPt().x,2*Math.PI))){a=e;break}}if(a){let c=a.getFaces()[0],l=0;for(;l<e.length;){l++;const d=c.getWires()[0];let u=!1;for(const l of d.getCoedge3ds()){if(a===l.getEdge())continue;const d=t.getCurve2d(l.getCurve());if(r.MathUtil.isNearlyEqual(d.getStartPt().x,d.getEndPt().x)){if(!n.has(l.getEdge()))return void(null===(o=a.getShell())||void 0===o||o.getFaces().forEach((e=>{if(t.isCoplanar(e.getSurface())){const t=e.getSurface().getCoord(),n=t.getOrigin(),o=t.getDz(),a=new r.Line3d(n,t.getWorldPtAt(new r.Vector3(1,0,0)));a.rotate(d.getStartPt().x,n,o);const c=new r.Line3d(n,t.getWorldPtAt(new r.Vector3(0,1,0)));c.rotate(d.getStartPt().x,n,o),t.setXYDirs(a.getDirection(),c.getDirection()),i.has(e)||s.push(e)}})));a=l.getEdge();for(const t of a.getFaces())if(t!==c&&e.findIndex((e=>e===t))>-1){c=t,u=!0;break}}if(u)break}}}}}},30896:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(75434),s=n(11593),i=n(7057),o=n(95001),a=n(97510),c=n(34652),l=n(726);class d extends a.default{constructor(e,t,n=!1,r=[]){super(r),this._faces=new Set(e),this._edges=t,this._mergeEdge=n}_executeImpl(){var e,t;const n=new Set;this._faces.forEach((e=>n.add(e.getShell()))),this._edges.forEach((e=>n.add(e.getShell())));const a=Array.from(n).map((e=>r.ContinuousUtil.getAllInteractiveFaces(e))),d=new Map;a.forEach((e=>{e.contFaces.forEach((e=>{e.getFaces().forEach((t=>d.set(t,e.getFaces())))}))})),this._edges.forEach((e=>{e.getFaces().forEach((e=>{const t=d.get(e);t&&t.forEach((e=>this._faces.add(e)))}))}));const u={addShells:[],deleteShells:[],modifiedShellsMap:new Map};for(const e of this._faces)c.addShellModifyInfo(u.modifiedShellsMap,e.getShell(),void 0,[e]),s.disposeFace(e);const h=[];n.forEach((e=>h.push(...e.getEdges())));const g=this._edges.filter((e=>e.getCoedge3ds().length)),f=l.default.execute(g);c.mergeShellModelingResult(u,f);for(const e of u.modifiedShellsMap.keys())e.getFaces().length||u.deleteShells.push(e);null===(e=u.deleteShells)||void 0===e||e.forEach((e=>u.modifiedShellsMap.delete(e)));for(const e of u.modifiedShellsMap.keys())r.ContinuousUtil.removeUnusedContinuousEdgeInfo(e);const p={modifiedShellsMap:new Map};for(const e of u.modifiedShellsMap.keys()){const n=o.splitShell(e);for(let r=1;r<n.length;r++)c.addShellModifyInfo(p.modifiedShellsMap,e,void 0,n[r].getFaces().slice()),null===(t=u.addShells)||void 0===t||t.push(n[r])}if(c.mergeShellModelingResult(u,p),this._mergeEdge){const e=h.filter((e=>!e.getCoedge3ds().length)),t=new Set;e.forEach((e=>{const n=e.getStartVertex(),r=e.getEndVertex();n&&t.add(n),r&&t.add(r)}));const n=new Set(u.modifiedShellsMap.keys());u.addShells&&u.addShells.forEach((e=>n.add(e)));const r=new Set;for(const e of n)e.getVertexs().forEach((e=>{t.has(e)&&r.add(e)}));for(const e of r){const t=e.getEdges();2!==t.length||t.some((e=>!e))||i.mergeConnectedEdge(t[0],t[1],e)}}return u}}t.default=d},78597:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.facesSplit=t.facesSubtract=t.facesUnion=t.facesBooleanCore=t.BooleanType=t.addOverlapInfo=t.addToSetInMap=void 0;const r=n(98106),s=n(70750),i=n(28373),o=n(40775),a=n(52928),c=n(11593),l=n(34652),d=n(28465),u=n(7261),h=n(59200),g=n(85870),f="暂不支持的布尔类型",p="输入的圆柱面存在跨周期问题";function _(e,t,n){let r=e.get(t);r||(r=new Set,e.set(t,r)),r.add(n)}function m(e,t,n){let r;for(const s of e)if(s.has(t)||s.has(n)){r=s;break}r||(r=new Set,e.push(r)),r.add(t),r.add(n)}function v(e,t,n,s){function i(e,t){const n=[],s=new r.Vector2(2*Math.PI,0),i=Math.max(t.getA(),t.getB());for(const t of e){let e=t.getStartPt(),o=t.getEndPt();(r.MathUtil.isNearlySmaller(e.x,0)||r.MathUtil.isNearlySmaller(o.x,0))&&(e.add(s),o.add(s)),e=new r.Vector2(e.x*i,e.y),o=new r.Vector2(o.x*i,o.y),n.push(new r.Line2d(e,o))}return n}for(const o of e.getWires()){const e=o.getCoedge3ds().map((e=>e.getCurve())),a=t.wireToUV(e);let c=a.loop;t instanceof r.Cylinder&&(c=i(c,t)),n.push(c),r.MathAssert.assert(e.length===a.loop.length,"getLoop2d的curve2ds数量与curve3ds不一致！");for(let t=0;t<e.length;t++){let n=a.mapping.get(e[t]);n=c[a.loop.indexOf(n)];const r=o.getCoedge3ds()[t];s.set(n,r)}}}function E(e,t,n,r){const s=[];if(!e.length)return s;if(e.some((e=>!n.get(e)&&!n.get(t.get(e)))))return s;for(const i of e){let e,o,a=n.get(i);if(a)e=a.getEdge(),o=a.getSameDirWithEdge();else{const s=t.get(i);a=n.get(s),e=a.getEdge(),o=i.getStartPt().equals(s.getStartPt(),r.lengthEps)&&i.getStartTangent().equals(s.getStartTangent(),r.angleEps)?a.getSameDirWithEdge():!a.getSameDirWithEdge()}s.push({edge:e,flag:o})}return s}function P(e,t,n,r,s){for(const i of e){const e=[];v(i,t,e,r);const o={loops:e};n.push(o),s.set(o,i)}}function y(e,t,n,r,i,c=!1,l){if(!e.loops.length)return;let d,u,h;const g=e.originFaces;if(g.length){const e=r.get(g[0]);d=e.getShell(),u=e.getSurface(),h=e.getSameDirWithSurface()}if(!d)return;const f=[];let p=[];for(let r=0;r<e.loops.length;r++){const s=E(e.loops[r],t,n,l);if(s.length)f.push(s.map((e=>e.edge))),p.push(s.map((e=>e.flag)));else if(0===r)return}let _,m=i;c&&u?(m=u,_=h):(e.bPositive||(f.forEach((e=>e.reverse())),p.forEach((e=>e.reverse())),p=p.map((e=>e.map((e=>!e))))),_=!0);const v=new s.Face(m,_),P=[];for(let e=0;e<f.length;e++){const t=[];for(let n=0;n<f[e].length;n++)t.push(new o.Coedge3d(f[e][n],p[e][n]));P.push(new a.Wire(t))}return v.setWires(P),d.addFace(v),v}function C(e,t,n){const r=e.keys();let s;for(const n of r)if(n.equals(t)){s=e.get(n);break}s||(s=[],e.set(t,s)),s.push(n)}function S(e,t){for(const n of e.values())for(const e of n){const n=t.getCurve2d(e).getRange();if(r.MathUtil.isNearlySmaller(n.min,0)&&r.MathUtil.isNearlyBigger(n.max,0)||r.MathUtil.isNearlySmaller(n.min,2*Math.PI)&&r.MathUtil.isNearlyBigger(n.max,2*Math.PI))return!1}return!0}var T;function b(e,t,n,s=!0,o,a,u){const h=u||r.Tolerance.DEFAULT,g={resultFaces:[],deleteShells:[],modifiedShellsMap:new Map,evolutionMap:new Map},_=e.filter((e=>e&&e.getShell())),m=t.filter((e=>e&&e.getShell())),v=[..._,...m];if(!v.length)return{resultFaces:v};if(n===T.kIntersect||n===T.kXor)throw new Error(f);let E=v[0].getSurface();if(E instanceof r.Cylinder&&(E=function(e,t){const n=[...e,...t],s=n.map((e=>e.getSurface())),i=new Map;for(const e of n){const t=e.getCoedge3ds().filter((e=>e.getEdge().getCurve()instanceof r.Arc3d)).map((e=>e.getCurve()));i.set(e,t)}for(const e of s){if(S(i,e))return e;const t=e.getCoord(),n=e.getA(),s=e.getB();for(let o=1;o<=3;o++){const a=t.getDx().vecRotate(t.getDz(),Math.PI*o/2),c=t.getDy().vecRotate(t.getDz(),Math.PI*o/2),l=new r.Coordinate3(t.getOrigin(),a,c);if(S(i,new r.Cylinder(l,o%2?s:n,o%2?n:s)))return e}}}(_,m),!E))throw new Error(p);const C=[],b=[];if(v.length<=1&&n===T.kSplit)C.push(...v);else{const e=[],t=[],s=new Map,i=new Map;P(_,E,e,s,i),P(m,E,t,s,i);const c=new Map,d=r.MathAlg.Bool2d.boolOperateCore(e,t,n,h.lengthEps,h.angleEps,c,o,a),u=n===T.kSplit||!!(w=v).length&&!!w.every((e=>((e,t)=>{const n=e.getSurface(),r=t.getSurface();return!(n.isPlane()&&r.isPlane()&&!n.getNorm().isSameDirection(r.getNorm()))&&e.getSameDirWithSurface()===t.getSameDirWithSurface()})(e,w[0])));for(const e of d){let t=i.get(e);if(t)C.push(t);else if(t=y(e,c,s,i,E,u,h),t&&(b.push(t),l.addShellModifyInfo(g.modifiedShellsMap,t.getShell(),[t]),e.originFaces)){const n=[];e.originFaces.forEach((e=>n.push(i.get(e)))),n.forEach((e=>l.addEvolutionInfo(g,e,t)))}}}var w;const x=new Set;_.forEach((e=>x.add(e.getShell())));v.filter((e=>-1===C.indexOf(e))).forEach((e=>{l.addShellModifyInfo(g.modifiedShellsMap,e.getShell(),void 0,[e]),c.disposeFace(e)})),g.resultFaces=C.concat(b);const M=i.mergeShells(g.resultFaces,Array.from(x));M.deleteShell.forEach((e=>{var t;(null===(t=g.modifiedShellsMap)||void 0===t?void 0:t.has(e))&&g.modifiedShellsMap.delete(e)}));for(const[e,t]of M.addFaceMap)l.addShellModifyInfo(g.modifiedShellsMap,e,t);if(g.deleteShells=M.deleteShell,s){const e=new Set;g.resultFaces.forEach((t=>t.getVertexes().forEach((t=>e.add(t))))),d.SmoothUtil.udpateSmoothVertices(e)}return g}function w(e,t,n,s=!0){const i={resultFaces:[],deleteShells:[],modifiedShellsMap:new Map},o=e.filter((e=>e&&e.getShell())),a=t.filter((e=>e&&e.getShell())),c=[...o,...a];if(!c.length||1===c.length&&(0===n||4===n))return{resultFaces:c};if(1===n||3===n)throw new Error(f);const d=[];c.forEach((e=>d.push(...e.getVertexes())));const p=new Map;for(const e of Array.from(new Set(d)))C(p,e.getPoint(),e);for(const e of p.values())g.mergeVertices(e);const v=new Set,E=[];c.forEach((e=>e.getEdges().forEach((e=>v.add(e))))),function(e,t,n){function s(e,t){const n=e.getParent();n&&!t.get(n)&&t.set(n,{addFaces:[],deleteFaces:[],modifiedFaces:[]})}const i=Array.from(e),o=new Set,a=[],c=[];i.forEach((e=>{const t=e.getCurve();a.push(t),c.push(t.getBoundingBox()),o.add(e.getStartVertex()),o.add(e.getEndVertex())}));const l=new Map,d=[];for(let e=0;e<i.length;e++)for(let t=e+1;t<i.length;t++){if(!c[e].intersectsBox(c[t]))continue;const u=r.MathAlg.CalculateIntersect.curve3ds(a[e],a[t]),h=[];let g=!1;if(u.forEach((t=>{t.isOverlap?(h.push(a[e].getPtAt(t.overlap1.min)),h.push(a[e].getPtAt(t.overlap1.max)),g=!0):h.push(t.point)})),h.length){g&&m(d,e,t),s(i[e],n),s(i[t],n);for(const n of h){let r;for(const e of o)if(e.getPoint().equals(n)){r=e;break}r||(r=i[e].getParent().createVertex(n),o.add(r)),_(l,i[e],r),_(l,i[t],r)}}}const h=new Map;for(let e=0;e<i.length;e++){const t=l.get(i[e]);if(!t){h.set(e,[i[e]]);continue}const n=u.splitEdgeByVertices(i[e],Array.from(t));n.length?h.set(e,n):h.set(e,[i[e]])}for(const e of d){const n=new Set;t.push(n),e.forEach((e=>{h.get(e).forEach((e=>n.add(e)))}))}}(v,E,i.modifiedShellsMap),E.forEach((e=>h.mergeOverlapEdges(Array.from(e))));const P=b(o,a,n,s);return l.mergeShellModelingResult(i,P),i.resultFaces=P.resultFaces,i}t.addToSetInMap=_,t.addOverlapInfo=m,function(e){e[e.kUnion=0]="kUnion",e[e.kIntersect=1]="kIntersect",e[e.kSubtract=2]="kSubtract",e[e.kXor=3]="kXor",e[e.kSplit=4]="kSplit"}(T=t.BooleanType||(t.BooleanType={})),t.facesBooleanCore=b,t.facesUnion=function(e,t,n=!0){return w(e,t,T.kUnion,n)},t.facesSubtract=function(e,t,n=!0){return w(e,t,T.kSubtract,n)},t.facesSplit=function(e,t,n=!0){return w(e,t,T.kSplit,n)}},50637:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(98106),s=n(70750),i=n(34652),o=n(78597),a=n(9548),c=n(91343),l=n(39781),d=n(85870),u=n(7261),h=n(59200),g=n(97510),f=n(14785);function p(e){if(e.getCurve()instanceof r.Line3d){const t=new r.Box3;return t.expandByPoint(e.getStartVertex().getPoint()),t.expandByPoint(e.getEndVertex().getPoint()),t}return e.getBoundingBox()}function _(e,t){const n=e.getParent();n&&!t.get(n)&&t.set(n,{addFaces:[],deleteFaces:[],modifiedFaces:[]})}function m(e,t,n=!1,g=!0,m){const v={deleteShells:[],modifiedShellsMap:new Map};if(!e.length)return v;const E=new Set(e),P=new Set,y=new Map,C=new Map,S=new r.Box3;for(const t of e){t.getEdges().forEach((e=>{let t=C.get(e);t||(t=p(e),C.set(e,t),P.add(e),S.union(t)),y.set(e.getStartVertex(),!1),y.set(e.getEndVertex(),!1)}))}const T=new r.Box3,b=new Set,w=new Set;for(const e of t)for(const t of e.getFaces()){if(E.has(t))continue;const e=new r.Box3;t.getEdges().forEach((t=>{let n=C.get(t);n||(n=p(t),C.set(t,n),w.add(t)),e.union(n),b.add(t.getStartVertex()),b.add(t.getEndVertex())})),T.union(e),C.set(t,e)}if(!n&&!T.isValid())return v;const x=Array.from(y.keys());b.forEach((e=>{y.has(e)||x.push(e)}));for(const e of C.keys())x.push(e);const M=S.clone().union(T),N=M.getSize().toArray3().sort(((e,t)=>e-t)),A=M.getCenter().subtracted(new r.Vector3(0,0,M.getSize().z/2)),O=new l.Octree(x,(e=>{if(e instanceof c.Vertex)return[e.getPoint()];const t=C.get(e);return[t.min,t.max]}),A,N[2]+100,m.lengthEps);b.clear();const I=O.getCandidateOverlaps(void 0,[S.min,S.max]).filter((e=>e instanceof s.Face&&S.intersectsBox(C.get(e),m.lengthEps)));if(!n&&!I.length)return v;for(const[e,t]of y){if(t)continue;const r=e.getPoint(),s=O.getCandidateOverlaps(e,[r]).filter((t=>{return t instanceof c.Vertex&&(s=e,i=t,!(!n&&s!==i&&y.has(i)))&&t.getPoint().equals(r,m.lengthEps);var s,i}));d.mergeVertices(s),s.forEach((e=>{y.has(e)&&y.set(e,!0)})),s.shift(),O.remove(s)}y.clear();!function(e,t,n,s,i,l,d){if(!e.size||!t.size&&!n)return;const g=r=>t.has(r)||n&&e.has(r),f=[],p=[],m=new Map,v=new Map,E=e=>{let t=v.get(e);return t||(t=e.getCurve(),v.set(e,t)),t},P=new Set;for(const t of Array.from(e)){const n=s(t),u=i.getCandidateOverlaps(t,[n.min,n.max]).filter((e=>e instanceof a.Edge&&g(e)&&e!==t&&n.intersectsBox(s(e),d.lengthEps))),h=E(t);for(const e of u){const n=r.MathAlg.CalculateIntersect.curve3ds(h,E(e),d),s=[];let a=!1;if(n.forEach((e=>{e.isOverlap?(s.push(h.getPtAt(e.overlap1.min)),s.push(h.getPtAt(e.overlap1.max)),a=!0):s.push(e.point)})),s.length){a&&o.addOverlapInfo(p,t,e),_(t,l.modifiedShellsMap),_(e,l.modifiedShellsMap);for(const n of s){let r;const s=i.getCandidateOverlaps(n,[n]).filter((e=>e instanceof c.Vertex&&e.getPoint().equals(n,d.lengthEps)));s.length&&(s.sort(((e,t)=>n.sqDistanceTo(e.getPoint())-n.sqDistanceTo(t.getPoint()))),r=s[0]),r||(r=t.getParent().createVertex(n),P.add(r),i.add(r)),r!==t.getStartVertex()&&r!==t.getEndVertex()&&o.addToSetInMap(m,t,r),r!==e.getStartVertex()&&r!==e.getEndVertex()&&o.addToSetInMap(m,e,r)}}}e.delete(t)}const y=new Map;for(const[e,t]of m){if(t){const n=u.splitEdgeByVertices(e,Array.from(t));if(n.length){y.set(e,n);continue}}y.set(e,[e])}for(const e of p){const t=new Set;f.push(t),e.forEach((e=>{const n=y.get(e);n?n.forEach((e=>t.add(e))):t.add(e)}))}f.forEach((e=>h.mergeOverlapEdges(Array.from(e),d))),P.forEach((e=>{var t;e.getEdges().length||null===(t=e.getParent())||void 0===t||t.deleteVertex(e)}))}(P,w,n,(e=>C.get(e)),O,v,m),P.clear(),w.clear();const D=new Map,L=f.ShellModelingUtil.divideFacesIntoCoplanarGroups(e,S.getCenter());for(const e of L){const t=I.filter((t=>r.MathAlg.CalculateOverlap.isSurfacesCoplaner(t.getSurface(),e[0].getSurface(),r.Tolerance.DEFAULT)));D.set(e,t)}for(const[e,t]of D){const n=o.facesBooleanCore(t,e,4,g,void 0,void 0,m);i.mergeShellModelingResult(v,n)}return v}class v extends g.default{constructor(e,t,n=!1,s=!0,i){super(t),this._faces=e,this._checkOverlap=n,this._updateSmooth=s,this._tolerance=i||r.Tolerance.DEFAULT}_executeImpl(){return m(this._faces,this._contextShells,this._checkOverlap,this._updateSmooth,this._tolerance)}}t.default=v},39781:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Octree=void 0;const r=n(98106);class s{constructor(e,t,n=1,s=r.Tolerance.LENGTH_EPS){this.origin=e,this.halfL=t,this.depth=n,this.objects=[],this.children=[],this._boundCache=[],this._lengthEps=s}getOverlaps(e,t){this._intersect(e)&&(t.push(...this.objects),this.children.forEach((n=>n.getOverlaps(e,t))))}getObjects(){return this.objects}getObjectsRecursive(){const e=this.objects.slice();return this.children.forEach((t=>t.getObjectsRecursive().forEach((t=>e.push(t))))),e}add(e,t,n,r){if(this.depth>=n)return this._add(e),[-1];if(0===this.children.length){if(this.objects.length<20)return this._add(e),this._boundCache.push(t),[-1];const s=this.objects.slice(),i=this._boundCache.slice();return this._subdivide(),s.length&&(this.objects=[],this._boundCache=[],s.forEach(((e,t)=>{const s=r.get(e);s.pop(),r.delete(e);const o=this.add(e,i[t],n,r);r.set(e,[...s,...o])}))),this.add(e,t,n,r)}let s;const i=t.map((e=>this._getQuadrant(e)));if(i.length&&i.every((e=>e===i[0]))&&(s=i[0]),void 0!==s){return[s,...this.children[s].add(e,t,n,r)]}return this._add(e),[-1]}remove(e,t){if(!this._intersect(t))return;const n=this.objects.findIndex((t=>t===e));n>-1?this.objects.splice(n,1):this.children.forEach((n=>n.remove(e,t)))}_add(e){this.objects.push(e)}_getQuadrant(e){const t=r.MathUtil.isNearlySmallerOrEqual(e.x-this.origin.x,0,this._lengthEps)?0:1,n=r.MathUtil.isNearlySmallerOrEqual(e.y-this.origin.y,0,this._lengthEps)?0:1;return 4*(r.MathUtil.isNearlySmallerOrEqual(e.z-this.origin.z,0,this._lengthEps)?0:1)+2*n+t}_containPoint(e){const t=e.x-this.origin.x,n=e.y-this.origin.y,s=e.z-this.origin.z;return r.MathUtil.isNearlySmallerOrEqual(Math.abs(t),this.halfL,this._lengthEps)&&r.MathUtil.isNearlySmallerOrEqual(Math.abs(n),this.halfL,this._lengthEps)&&r.MathUtil.isNearlySmallerOrEqual(Math.abs(s),this.halfL,this._lengthEps)}_intersect(e){if(!e.length)return!1;if(1===e.length)return this._containPoint(e[0]);const t=this.origin.added(new r.Vector3(this.halfL,this.halfL,this.halfL)),n=this.origin.added(new r.Vector3(-this.halfL,-this.halfL,-this.halfL));for(let s=0;s<e[0].data.length;s++)if(r.MathUtil.isNearlySmaller(t.data[s],e[0].data[s],this._lengthEps)||r.MathUtil.isNearlyBigger(n.data[s],e[e.length-1].data[s],this._lengthEps))return!1;return!0}_subdivide(){const e=.5*this.halfL,t=this.depth+1;for(let n=0;n<8;n++){const i=1&n?1:-1,o=2&n?1:-1,a=4&n?1:-1,c=this.origin.added(new r.Vector3(i*e,o*e,a*e));this.children.push(new s(c,e,t))}}}t.Octree=class{constructor(e,t,n=r.Vector3.O(),i=5e5,o=10){this._root=new s(n,i),this._getBound=t,this._maxDepth=o,this._objectIndexMap=new Map,e.forEach((e=>{const t=this._root.add(e,this._getBound(e),this._maxDepth,this._objectIndexMap);this._objectIndexMap.set(e,t)}))}getCandidateOverlaps(e,t){const n=this._objectIndexMap.get(e);if(n){const e=[];let t=this._root;for(const r of n){if(!(r>-1)){t.getObjectsRecursive().forEach((t=>e.push(t)));break}t.getObjects().forEach((t=>e.push(t))),t=t.children[r]}return e}const r=t||this._getBound(e),s=[];return this._root.getOverlaps(r,s),s}remove(e){e.forEach((e=>this._root.remove(e,this._getBound(e))))}add(e,t){const n=t||this._getBound(e),r=this._root.add(e,n,this._maxDepth,this._objectIndexMap);this._objectIndexMap.set(e,r)}}},91475:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(52667),s=n(91343),i=n(9548),o=n(98719),a=n(75434),c=n(97510);class l extends c.default{constructor(e,t,n=[]){super(n),this._faces=e,this._originShell=t}_executeImpl(){const e=new Map,t=new Map,n=new r.Shell;for(const r of this._faces){const a=r.getCoedge3ds();for(const r of a){const a=r.getEdge();if(t.has(a))continue;const c=a.getStartVertex();let l=e.get(c);l||(l=new s.Vertex(c.getPoint()),e.set(c,l),l.setFlags(c.getFlags()),l.setData(o.BrepUtil.loadMapObj(o.BrepUtil.dumpMapObj(c.getData()))),n.addVertex(l));const d=a.getEndVertex();let u=e.get(d);u||(u=new s.Vertex(d.getPoint()),e.set(d,u),u.setFlags(d.getFlags()),u.setData(o.BrepUtil.loadMapObj(o.BrepUtil.dumpMapObj(d.getData()))),n.addVertex(u));const h=new i.Edge(a.getCurve().clone(),l,u);t.set(a,h),h.setFlags(a.getFlags()),h.setData(o.BrepUtil.loadMapObj(o.BrepUtil.dumpMapObj(a.getData()))),n.addEdge(h)}}a.ContinuousUtil.cloneContinuousEdgeInfo(t.keys(),(e=>t.get(e)));for(const e of this._faces){for(const n of e.getCoedge3ds()){const e=n.getEdge(),r=t.get(e);e.deleteCoedge3d(n),n.setEdge(r)}this._originShell.deleteFace(e),n.addFace(e)}const c=[];for(const e of t.keys())if(e.getCoedge3ds().length<=0){e.dispose(),c.push(e.tag);(e.getParent()||this._originShell).deleteEdge(e)}for(const t of e.keys())if(t.getEdges().length<=0){(t.getParent()||this._originShell).deleteVertex(t)}const l={newShell:n,edgesDelete:c};return this._originShell.getFaces().length?(l.modifiedShellsMap=new Map,l.modifiedShellsMap.set(this._originShell,{deleteFaces:Array.from(this._faces)}),a.ContinuousUtil.removeUnusedContinuousEdgeInfo(this._originShell)):l.deleteShells=[this._originShell],l.addShells=[n],l}}t.default=l},23898:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(34652),s=n(75434),i=n(14785),o=n(29537),a=n(97510);class c extends a.default{constructor(e,t=[]){super(t),this._faces=e}_executeImpl(){const e={modifiedShellsMap:new Map},t=this._faces.filter((e=>e.getSurface().isPlane())),n=s.ContinuousUtil.getAllInteractiveFaces({getFaces:()=>t,getEdges:()=>{const e=new Set;return t.forEach((t=>t.getEdges().forEach((t=>e.add(t))))),Array.from(e)}}),a=[];Array.from(n.contFaces).filter((e=>e.isPlane())).forEach((e=>a.push(e.getFaces().slice())));const c=i.ShellModelingUtil.divideFacesIntoCoplanarGroups(n.faces);for(const e of c){i.ShellModelingUtil.divideFacesIntoConnectGroups(e,!1).forEach((e=>a.push(e)))}for(const t of a){const n=o.mergeConnectedFace(t);if(n){const s={modifiedShellsMap:new Map,evolutionMap:new Map};s.modifiedShellsMap.set(n.getShell(),{addFaces:[n],deleteFaces:t}),t.forEach((e=>r.addEvolutionInfo(s,e,n))),r.mergeShellModelingResult(e,s)}}return e}}t.default=c},38349:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(97510),s=n(7057);class i extends r.default{constructor(e){super([]),this._edges=e}_executeImpl(){const e=new Map;for(const t of this._edges){const n=t.getShell();let r=e.get(n);r||(r=[],e.set(n,r)),r.push(t)}let t;const n=new Map;for(const[r,i]of e){if(i.length<=1)continue;const e=r.getEdges().length,o=new Set(i),a=new Set;for(const e of o){const t=e.getStartVertex(),n=e.getEndVertex();if(!a.has(t)){t.getEdges().filter((e=>o.has(e))).length>1&&a.add(t)}if(!a.has(n)){n.getEdges().filter((e=>o.has(e))).length>1&&a.add(n)}}for(const e of a){const n=e.getEdges();2!==n.length||n.some((e=>!e))?t="patial fail":s.mergeConnectedEdge(n[0],n[1],e)}e!==r.getEdges().length&&n.set(r,{})}const r=this._edges.filter((e=>e.getCoedge3ds().length>0));return r.length&&(t=r.length===this._edges.length?"all fail":"patial fail"),{errorStr:t,modifiedShellsMap:n}}}t.default=i},45786:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MoveEdges=void 0;const r=n(98106),s=n(34652),i=n(40775),o=n(97510),a=n(50637),c=n(78597),l=n(95001);class d extends o.default{constructor(e,t,n=[]){super(n),this._overlapInfo=[],this._edges=new Set(e),this._shell=e[0].getShell(),this._transVect=t}preview(){const e={};try{this._previewCore()}catch(t){return e.errorStr=t,e}return e}_executeImpl(){return this._moveEdgesCore()}_moveEdgesCore(){const e={errorStr:"success"};if(this._transVect.getSqLength()<r.Tolerance.LENGTH_EPS*r.Tolerance.LENGTH_EPS||this._edges.size<1)return e;const t=this._getAllConnectElems();if(t.shells.size>1)return e.errorStr="edges not in one shell",e;let n;for(const e of t.shells)n=e;if(t.vertices.size===n.getVertexs().length){n.translate(this._transVect);const r=new Map;return s.addShellModifyInfo(r,n,void 0,void 0,Array.from(t.faces)),e.modifiedShellsMap=r,e}const i=this._getAllAdjacentEdges(t.vertices),o=this._getAllAdjacentFaces(i,t.faces),d=this._canUseTransVect(i,o,t.faces);if(""!==d)return e.errorStr=d,e;if(this._judgeSelfIntersect(this._edges,i,t.vertices,t.faces,o))return e.errorStr="self intersect!",e;this._edges.forEach((e=>{e.getCurve().translate(this._transVect)})),t.vertices.forEach((e=>{e.getPoint().translate(this._transVect)})),t.faces.forEach((e=>{const t=e.getSurface();if(t.getType()!==r.EN_GEO_ELEMENT_TYPE.EN_PLANE)throw new Error("not support non-plane surface");{const n=t,s=n.getNorm();if(this._transVect.isPerpendicular(s));else{const t=e.getWires()[0],s=t.getCoedge3ds().length;if(1===s||2===s||s>4)n.translate(this._transVect);else if(3===s){const n=t.getCoedge3ds()[0].getStartVertex().getPoint(),s=t.getCoedge3ds()[1].getStartVertex().getPoint(),i=t.getCoedge3ds()[2].getStartVertex().getPoint(),o=r.Plane.makePlaneByTreePoints(n,s,i);if(!o)throw new Error("unkonwn error");e.setSurface(o)}else if(4===s){const n=[];for(const e of t.getCoedge3ds())n.push(e.getEdge().getStartVertex().getPoint());const s=r.Plane.makePlaneByPoints(n);if(!s)throw new Error("unkonwn error");e.setSurface(s)}}}})),this._dealAdjacentCurves(i,t.vertices),this._dealAdjacentFaces(o,t.vertices);const u=new Set,h=new Set,g=new Set;this._dealDegeneratedCase(u,h);for(const e of t.faces)n.getFaces().findIndex((t=>t===e))<0?h.add(e):u.add(e);for(const e of o)n.getFaces().findIndex((t=>t===e))<0?h.add(e):u.add(e);const f=(e,t)=>{e.deleteWire(t);const n=e.getShell();for(const e of t.getCoedge3ds()){const t=e.getEdge();if(t.deleteCoedge3d(e),t.getCoedge3ds().length<1){const e=t.getStartVertex(),r=t.getEndVertex();n.deleteEdge(t),t.dispose(),e.getEdges().length<1&&n.deleteVertex(e),r.getEdges().length<1&&n.deleteVertex(r)}}},p=[];for(const e of u)if(n.getFaces().findIndex((t=>t===e))>=0){const t=e.calcPolygon(),n=t.loops[0];n.isAnticlockwise()||e.getWires()[0].reverse();for(let s=1;s<t.loops.length;s++){const i=e.getWires()[s],o=t.loops[s],a=r.MathAlg.PositionJudge.loopToLoop(n,o);a===r.MathAlg.LoopLoopPositonType.OUT?f(e,i):a===r.MathAlg.LoopLoopPositonType.INTERSECT&&(f(e,i),i.reverse())}p.push(e)}const _=new Map,m=[],v=[],E=[];u.forEach((e=>m.push(e))),h.forEach((e=>v.push(e))),g.forEach((e=>E.push(e))),s.addShellModifyInfo(_,n,E,v,m),e.modifiedShellsMap=_;const P=[];e.modifiedShellsMap.forEach((e=>{e.modifiedFaces&&P.push(...e.modifiedFaces),e.addFaces&&P.push(...e.addFaces)}));const y=[];for(const e of P){const t=e.getSurface();let n=!1;for(const s of y)if(r.MathAlg.CalculateOverlap.isSurfacesCoplaner(t,s.surf)){n=!0,s.faces.push(e);break}n||y.push({surf:t,faces:[e]})}for(const t of y){const i=[];for(const e of n.getFaces())!t.faces.find((t=>t.tag===e.tag))&&r.MathAlg.CalculateOverlap.isSurfacesCoplaner(t.surf,e.getSurface())&&i.push(e);if(i.length<1)continue;const o=c.facesSplit(t.faces,i);s.mergeShellModelingResult(e,o)}const C=[],S={addShells:[],modifiedShellsMap:new Map};for(const e of t.shells){const t=l.splitShell(e);t.map((e=>C.push(...e.getFaces())));for(let n=1;n<t.length;n++)s.addShellModifyInfo(S.modifiedShellsMap,e,void 0,t[n].getFaces().slice()),S.addShells.push(t[n])}if(s.mergeShellModelingResult(e,S),this._contextShells.length>0){const t=new a.default(C,this._contextShells,!0).execute();s.mergeShellModelingResult(e,t)}return e}_previewCore(){return this._moveEdgesCore()}_getAllConnectElems(){const e=new Set,t=new Set,n=new Set;return this._edges.forEach((r=>{r.getParent()&&n.add(r.getParent());for(const e of r.getFaces())t.add(e);e.add(r.getStartVertex()),e.add(r.getEndVertex())})),{vertices:e,faces:t,shells:n}}_getAllAdjacentEdges(e){const t=new Set;return e.forEach((e=>{for(const n of e.getEdges())this._edges.has(n)||t.add(n)})),t}_getAllAdjacentFaces(e,t){const n=new Set;return e.forEach((e=>{e.getFaces().forEach((e=>{t.has(e)||n.add(e)}))})),n}_canUseTransVect(e,t,n){for(const t of e){const e=t.getCurve().getType();if(e!==r.EN_GEO_ELEMENT_TYPE.EN_LINE_3D&&e!==r.EN_GEO_ELEMENT_TYPE.EN_ARC_3D)return"adjacent curve is not line or arc"}for(const e of n){const t=e.getSurface();if(t.getType()!==r.EN_GEO_ELEMENT_TYPE.EN_PLANE)return"surface is not plane";const n=t.getNorm();if(!this._transVect.isPerpendicular(n)){if(e.getWires().length>1)return"face has inner wire";const t=e.getWires()[0],n=new Set;for(const e of t.getCoedge3ds())n.add(e.getStartVertex());const s=[];for(const e of t.getCoedge3ds()){const t=e.getEdge();this._edges.has(t)&&s.push(e)}const i=new Set;for(const e of s)i.add(e.getStartVertex()),i.add(e.getEndVertex());if(i.size===n.size)continue;if(i.size>2)return"can't move";if(n.size>4)return"can't move";if(4===n.size){for(const e of t.getCoedge3ds()){if(e.getEdge().getCurve().getType()!==r.EN_GEO_ELEMENT_TYPE.EN_LINE_3D)return"can't move"}const e=s[0],n=e.getIndexInWire(),i=t.getCoedge3dByIndex((n+2)%4),o=e.getEdge().getCurve(),a=i.getEdge().getCurve();if(!o.isParallelTo(a))return"can't move"}if(3===n.size)for(const e of t.getCoedge3ds()){if(e.getEdge().getCurve().getType()!==r.EN_GEO_ELEMENT_TYPE.EN_LINE_3D)return"can't move"}}}for(const e of t){const t=e.getSurface();if(t.getType()!==r.EN_GEO_ELEMENT_TYPE.EN_PLANE)return"connect surface is not plane";const n=t.getNorm();if(!this._transVect.isPerpendicular(n)){if(e.getWires().length>1)return"connect face has inner wire";const t=e.getWires()[0];if(t.getCoedge3ds().length>3)return"can't move";for(const e of t.getCoedge3ds()){if(e.getEdge().getCurve().getType()!==r.EN_GEO_ELEMENT_TYPE.EN_LINE_3D)return"can't move"}}}return""}_judgeSelfIntersect(e,t,n,s,i){const o=new Map,a=new Map;e.forEach((e=>{const t=e.getCurve().clone();t.translate(this._transVect),o.set(e,t)})),n.forEach((e=>{const t=e.getPoint().clone();t.translate(this._transVect),a.set(e,t)})),t.forEach((e=>{const t=e.getCurve().clone();if(n.has(e.getStartVertex())&&n.has(e.getEndVertex()))t.translate(this._transVect),o.set(e,t);else if(t.getType()===r.EN_GEO_ELEMENT_TYPE.EN_LINE_3D){let t=a.get(e.getStartVertex());t=void 0!==t?t:e.getStartVertex().getPoint();let n,s=a.get(e.getEndVertex());s=void 0!==s?s:e.getEndVertex().getPoint(),n=t.equals(s)?new r.Line3d(t,new r.Vector3(1,0,0),[0,0]):new r.Line3d(t,s),o.set(e,n)}else{if(t.getType()!==r.EN_GEO_ELEMENT_TYPE.EN_ARC_3D)throw new Error("not support curve type");{const t=e.getCurve(),n=t.getRange().getLength(),s=Math.sin(n/2),i=t.getNormal();let c=a.get(e.getStartVertex());c=void 0!==c?c:e.getStartVertex().getPoint();let l=a.get(e.getEndVertex());l=void 0!==l?l:e.getEndVertex().getPoint();const d=c.midTo(l),u=l.subtracted(c),h=i.cross(u).normalize();n>r.CONST.PI&&h.reverse();const g=new r.Line3d(d,h,r.Interval.infinitArray()),f=d.distanceTo(c),p=f/s,_=Math.sqrt(p*p-f*f),m=g.getPtAt(_),v=p*t.getB()/t.getA(),E=u.reversed(),P=n>r.CONST.PI?h:h.reversed(),y=new r.Coordinate3(m,E,P),C=E.angleTo(c.subtracted(m),i),S=new r.Arc3d(y,p,v,[C,C+n]);o.set(e,S)}}}));for(const e of s){const t=[],n=e.getWires();for(let e=0;e<n.length;++e){const r=n[e];for(const n of r.getCoedge3ds()){let r=o.get(n.getEdge());r||(r=n.getEdge().getCurve()),t.push([r,n.getEdge(),0!==e])}}for(let e=0;e<t.length;e++){const n=t[e][0];for(let s=e+1;s<t.length;s++){const i=t[s][0],o=r.MathAlg.CalculateIntersect.curve3ds(n,i);for(const r of o)if(r.isOverlap)t[e][1]&&t[s][1]&&this._overlapInfo.push({overlap:r,curve1:t[e][1],curve2:t[s][1],crv1Inner:t[e][2],crv2Inner:t[s][2]});else if(!(r.point.equals(i.getStartPt())||r.point.equals(i.getEndPt())||r.point.equals(n.getStartPt())||r.point.equals(n.getEndPt())))return!0}}}for(const e of i){const t=[],n=e.getWires();for(let e=0;e<n.length;++e){const r=n[e];for(const n of r.getCoedge3ds()){let r=o.get(n.getEdge());r||(r=n.getEdge().getCurve()),t.push([r,n.getEdge(),0!==e])}}for(let e=0;e<t.length;e++){const n=t[e][0];for(let s=e+1;s<t.length;s++){const e=t[s][0],i=r.MathAlg.CalculateIntersect.curve3ds(n,e);for(const t of i)if(!t.point.equals(e.getStartPt())&&!t.point.equals(e.getEndPt()))return!0}}}return!1}_dealAdjacentCurves(e,t){e.forEach((e=>{if(t.has(e.getStartVertex())&&t.has(e.getEndVertex())){e.getCurve().translate(this._transVect)}else{const t=e.getCurve();if(t.isLine3d()){const t=e.getStartVertex().getPoint(),n=e.getEndVertex().getPoint();let s;s=t.equals(n)?new r.Line3d(t,new r.Vector3(1,0,0),[0,0]):new r.Line3d(t,n),e.setCurve(s)}else{if(!t.isArc3d())throw new Error("not support curve type");{const t=e.getCurve(),n=t.getRange().getLength(),s=Math.sin(n/2),i=t.getNormal(),o=e.getStartVertex().getPoint(),a=e.getEndVertex().getPoint(),c=o.midTo(a),l=a.subtracted(o),d=i.cross(l).normalize();n>r.CONST.PI&&d.reverse();const u=new r.Line3d(c,d,r.Interval.infinitArray()),h=c.distanceTo(o),g=h/s,f=Math.sqrt(g*g-h*h),p=u.getPtAt(f),_=g*t.getB()/t.getA(),m=l.reversed(),v=n>r.CONST.PI?d:d.reversed(),E=new r.Coordinate3(p,m,v),P=m.angleTo(o.subtracted(p),i),y=new r.Arc3d(E,g,_,[P,P+n]);e.setCurve(y)}}}}))}_dealAdjacentFaces(e,t){for(const t of e){const e=t.getSurface();if(e.getType()!==r.EN_GEO_ELEMENT_TYPE.EN_PLANE)throw new Error("not support non-plane surface");{const n=e.getNorm();if(this._transVect.isPerpendicular(n));else{const e=t.getWires()[0];if(3!==e.getCoedge3ds().length)throw new Error("unkonwn error");{const n=e.getCoedge3ds()[0].getStartVertex().getPoint(),s=e.getCoedge3ds()[1].getStartVertex().getPoint(),i=e.getCoedge3ds()[2].getStartVertex().getPoint(),o=r.Plane.makePlaneByTreePoints(n,s,i);if(!o)throw new Error("unkonwn error");t.setSurface(o)}}}}}_dealDegeneratedCase(e,t){if(this._overlapInfo.length<1)return;let n;r.MathError.assert(1===this._edges.size,"暂时不支持多条移动边重合情况"),this._edges.forEach((e=>{n=e}));const s=[],o=[];this._overlapInfo.forEach((e=>{e.curve1===n?s.push(e.curve2):s.push(e.curve1),o.push(e.curve1.getCurve().getStartPt()),o.push(e.curve1.getCurve().getEndPt()),o.push(e.curve2.getCurve().getStartPt()),o.push(e.curve2.getCurve().getEndPt());const t=e.overlap.overlap1;o.push(e.curve1.getCurve().getPtAt(t.min)),o.push(e.curve1.getCurve().getPtAt(t.max))}));const a=n.getCurve().getDirection();o.sort((function(e,t){return e.subtracted(t).dot(a)>0?1:e.subtracted(t).dot(a)<0?-1:0}));const c=[];c.push(o[0]);for(let e=1;e<o.length;++e)o[e-1].equals(o[e])||c.push(o[e]);r.MathError.assert(c.length>1,"重合情况出错");const l=new Set;let d=this._shell.createVertex(c[0]);l.add(d);const u=[];for(let e=1;e<c.length;++e){const t=this._shell.createVertex(c[e]),n=this._shell.createEdge(new r.Line3d(c[e-1],c[e]),d,t);d=t,l.add(d),u.push(n)}const h=new Map;s.push(n);for(const e of s){const t=[];for(const n of u)e.getCurve().containsPoint(n.getCurve().getStartPt())&&e.getCurve().containsPoint(n.getCurve().getEndPt())&&t.push(n);h.set(e,t)}for(const t of h){const n=t[0],r=t[1];if(r.length<1)continue;const s=n.getCurve().getEndTangent().isSameDirection(r[0].getCurve().getEndTangent());n.getFaces().forEach((t=>{t.getWires().forEach((o=>{const a=o.getCoedge3ds();for(let c=0;c<=a.length-1;++c){const l=a[c];if(n===l.getEdge()){const n=[],a=s?l.getSameDirWithEdge():!l.getSameDirWithEdge();r.forEach((e=>{n.push(new i.Coedge3d(e,a))})),a||n.reverse(),o.replaceCoedge3d(c,n),e.add(t);break}}}))}))}for(const e of h){const t=e[0],n=e[1];if(n.length<1)continue;const r=t.getCurve().getEndTangent().isSameDirection(n[0].getCurve().getEndTangent()),s=t.getStartVertex(),i=t.getEndVertex(),o=(e,t)=>{e.getEdges().forEach((n=>{e.getPoint().equals(n.getStartVertex().getPoint())&&n.setStartVertex(t),e.getPoint().equals(n.getEndVertex().getPoint())&&n.setEndVertex(t)})),l.has(e)||this._shell.deleteVertex(e)};r?(o(s,n[0].getStartVertex()),o(i,n[n.length-1].getEndVertex())):(o(i,n[0].getStartVertex()),o(s,n[n.length-1].getEndVertex())),t.dispose(),this._shell.deleteEdge(t)}const g=[];for(const e of this._shell.getEdges()){const t=e.getCurve();if(e.getCoedge3ds().length<1)g.push(e);else if(t.getLength()<r.Tolerance.LENGTH_EPS){const t=e.getCoedge3ds();for(const e of t){e.getWire().deleteCoedge3d(e)}this._shell.deleteEdge(e),e.dispose()}}g.forEach((e=>{e.dispose(),this._shell.deleteEdge(e)}));for(const n of e){const r=n.getWires();for(let e=0;e<r.length;++e)for(let t=e+1;t<r.length;++t){const n=r[e].getCoedge3ds(),s=r[t].getCoedge3ds();if(!(n.length<1||s.length<1))for(let i=0;i<n.length;++i){const o=s.findIndex((e=>n[i].getEdge()===e.getEdge()));if(o>-1){const a=s.slice(o+1).concat(s.slice(0,o));n[i].dispose(),r[e].replaceCoedge3d(i,a),r[t].dispose();break}}}n.setWires(n.getWires().filter((e=>e.getCoedge3ds().length>0)));for(const e of r){const t=e.getCoedge3ds(),n=new Set;for(let e=0;e<t.length;++e)if(!n.has(t[e]))for(let r=e+1;r<t.length;++r)n.has(t[r])||t[e].getEdge()===t[r].getEdge()&&(n.add(t[e]),n.add(t[r]));for(const t of n)e.deleteCoedge3d(t),t.dispose()}const s=n.getWires(),i=[];for(const e of s){if(e.getCoedge3ds().length<3){e.dispose();break}i.push(e)}n.setWires(i),n.getWires().length<1&&(t.add(n),e.delete(n),this._shell.deleteFace(n))}for(const e of this._shell.getEdges())e.getCoedge3ds().length<1&&this._shell.deleteEdge(e);for(const e of this._shell.getVertexs())e.getEdges().length<1&&this._shell.deleteVertex(e)}}t.MoveEdges=d},21554:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MoveFaces=void 0;const r=n(45786),s=n(97510);class i extends s.default{constructor(e,t,n=[]){super(n),this._faces=new Set(e),this._transVect=t}_executeImpl(){const e=new Set;for(const t of this._faces)for(const n of t.getCoedge3ds())e.add(n.getEdge());return new r.MoveEdges(Array.from(e),this._transVect).execute()}}t.MoveFaces=i},11593:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.disposeFace=void 0,t.disposeFace=function(e){if(!e||!e.getShell())return;let t=e.getShell();t&&t.deleteFace(e);for(const n of e.getCoedge3ds()){const e=n.getEdge();if(e){const r=e.getStartVertex(),s=e.getEndVertex();e.deleteCoedge3d(n),e.getCoedge3ds().length<=0&&(e.dispose(),t=e.getParent()||t,null==t||t.deleteEdge(e)),r.getEdges().length<=0&&(t=r.getParent()||t,null==t||t.deleteVertex(r)),s.getEdges().length<=0&&(t=s.getParent()||t,null==t||t.deleteVertex(s))}}}},7057:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeConnectedEdge=void 0;const r=n(98106),s=n(9548),i=n(40775);t.mergeConnectedEdge=function(e,t,n){if(!function(e,t,n){if(!e||!t)return!1;const s=e.getCoedge3ds(),i=t.getCoedge3ds();if(!s.length||!i.length||s.length!==i.length)return!1;const o=e.getCurve(),a=t.getCurve();if(!r.MathAlg.CurveCurveColinear.curve3ds(o,a)||r.MathAlg.PositionJudge.curveCurveOverlap(o,a)===r.MathAlg.CurveCuvePositonType.OVERLAP)return!1;const c=[e.getStartVertex(),e.getEndVertex()],l=[t.getStartVertex(),t.getEndVertex()];if(!c.some((e=>e===n))||!l.some((e=>e===n)))return!1;const d=n.getEdges().filter((e=>e.getCoedge3ds().length));return!(2!==d.length||d.indexOf(e)<0||d.indexOf(t)<0)}(e,t,n))return;const o=n,a=e.getStartVertex()===o?e.getEndVertex():e.getStartVertex(),c=t.getStartVertex()===o?t.getEndVertex():t.getStartVertex(),l=o.getParent();let d;const u=e.getCurve();if(u instanceof r.Line3d)d=new r.Line3d(a.getPoint(),c.getPoint());else if(u instanceof r.Arc3d)if(u.isEqualAB()){const t=e.getStartVertex()===o?u.getNormal().reversed():u.getNormal();d=r.Arc3d.makeArcByStartEndPoints(u.getCenter(),u.getRadius(),t,a.getPoint(),c.getPoint(),!0)}else{const t=u.getCenter().added(u.getCoord().getDx().multiplied(u.getA())),n=e.getStartVertex()===o?-1:1,s=u.getCenter().added(u.getCoord().getDy().multiplied(n*u.getB()));d=r.Arc3d.makeEllipseByFivePoints(u.getCenter(),t,s,a.getPoint(),c.getPoint())}else if(u instanceof r.NurbsCurve3d)if(e.getStartVertex()===o){const e=u.getRange().max,n=u.getRange().min-t.getCurve().getRange().getLength();r.MathUtil.isNearlyBiggerOrEqual(n,0)&&(d=u.clone(),d.setRange(n,e),d.reverse())}else{const e=u.getRange().min,n=u.getRange().max+t.getCurve().getRange().getLength();r.MathUtil.isNearlySmallerOrEqual(n,1)&&(d=u.clone(),d.setRange(e,n))}if(!d)return;const h=new s.Edge(d,a,c);l.addEdge(h);const g=d.getStartTangent(),f=e.getCoedge3ds().filter((e=>e.getStartVertex()===a)),p=t.getCoedge3ds().filter((e=>e.getStartVertex()===c));for(const e of f.concat(p)){const t=e.getWire(),n=e.getStartVertex()===a&&e.getCurve().getStartTangent().equals(g),r=new i.Coedge3d(h,n),s=t.getCoedge3ds(),o=s.indexOf(e),c=s[(o+1)%s.length];t.insertCoedge3d(o,r),t.deleteCoedge3d(e),t.deleteCoedge3d(c)}return e.getFlags()&&t.getFlags()&&h.setFlags(e.getFlags()&t.getFlags()),e.dispose(),t.dispose(),l.deleteEdge(e),l.deleteEdge(t),l.deleteVertex(o),h}},29537:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeConnectedFace=void 0;const r=n(40775),s=n(70750),i=n(52928),o=n(11593),a=n(14785);t.mergeConnectedFace=function(e){if(1===e.length)return e[0];const t=e.map((e=>e.getSurface()));if(!t.every((e=>e.isPlane())))return;const n=new Set,c=new Set;for(const t of e)for(const e of t.getEdges())c.has(e)?(c.delete(e),n.add(e)):c.add(e);if(!n.size)return;const l=t.length?t[0]:void 0,d=a.ShellModelingUtil.detectFacesFromEdges(Array.from(c),l);if(1!==d.length)return;let u;for(const e of d){const t=e.map((e=>{const t=e.edges.map((e=>new r.Coedge3d(e.edge,e.bSameDir)));return new i.Wire(t)}));u=new s.Face(l.clone(),!0,t)}const h=e[0].getShell();return u&&(h.addFace(u),e.forEach((e=>o.disposeFace(e)))),u}},59200:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeOverlapEdges=void 0;const r=n(98106);t.mergeOverlapEdges=function(e,t){const n=t||r.Tolerance.DEFAULT,s=Array.from(new Set(e)),i=new Map;for(const e of s){const t=e.getCurve();let s=!1;for(const[o,a]of i)if(r.MathAlg.PositionJudge.curveCurveOverlap(o,t,n.lengthEps,n.angleEps)===r.MathAlg.CurveCuvePositonType.TOTALLY_OVERLAP){a.push(e),s=!0;break}if(!s){const n=Array.from([e]);i.set(t,n)}}for(const e of i.values()){if(e.length<=1)continue;const t=e[0],r=e.every((e=>e.getSmooth()));for(let r=1;r<e.length;r++){const s=e[r],i=s.getCoedge3ds().slice();let o=!1;s.getStartVertex()===t.getStartVertex()&&s.getCurve().getStartTangent().equals(t.getCurve().getStartTangent(),n.angleEps)||(o=!0);for(const e of i)e.setEdge(t),o&&e.reverse();const a=s.getParent();a&&a.deleteEdge(s),s.dispose()}t.setSmooth(r)}}},28373:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeShells=void 0;const r=n(70455),s=n(14785);t.mergeShells=function(e,t,n){const i=function(e,t){const n=new Set(e);if(t){const t=s.ShellModelingUtil.divideFacesIntoConnectGroups(e,!0),n=[];for(const e of t){const t=new Set;e.forEach((e=>{t.add(e.getShell()),e.getVertexes().forEach((e=>{const n=e.getParent();n&&t.add(n)})),e.getEdges().forEach((e=>{const n=e.getParent();n&&t.add(n)}))})),n.push(t)}return n}let r=1;const i=new Map,o=new Map;for(const e of n){const t=new Set([e.getShell()]);e.getVertexes().forEach((e=>{e.getFaces().forEach((e=>t.add(e.getShell())));const n=e.getParent();n&&t.add(n)})),e.getEdges().forEach((e=>{const n=e.getParent();n&&t.add(n)}));let n=[];for(const e of t){const t=i.get(e);t&&n.push(t)}if(n=n.filter(((e,t)=>n.indexOf(e)===t)),n.length>=1){const e=o.get(n[0]);for(let t=1;t<n.length;t++)o.get(n[t]).forEach((t=>e.add(t))),o.delete(n[t]);t.forEach((t=>e.add(t))),e.forEach((e=>i.set(e,n[0])))}else{const e=r++;t.forEach((t=>i.set(t,e))),o.set(e,t)}}return Array.from(o.values())}(e,n),o=[],a=new Map;for(const e of i){if(e.size<=1)continue;let n;if(t){const r=Array.from(e).filter((e=>t.findIndex((t=>t===e))>0));r.length&&(n=r[0])}n||(n=Array.from(e).sort(((e,t)=>t.getVertexs().length-e.getVertexs().length))[0]);const s=[];a.set(n,s);for(const t of e){if(t===n)continue;o.push(t),s.push(...t.getFaces());const e=t.getFaces(),i=t.getEdges(),a=t.getVertexs();for(let r=e.length-1;r>=0;r--){const s=e[r];t.deleteFace(s),n.addFace(s)}for(const e of i)t.deleteEdge(e),n.addEdge(e);for(const e of a)t.deleteVertex(e),n.addVertex(e);r.ContinuousUtil.transferContinuousEdgeInfo(i,t,n)}}return{deleteShell:o,addFaceMap:a}}},85870:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mergeVertices=void 0,t.mergeVertices=function(e){if(e.length<=1)return;const t=e[0];for(let n=1;n<e.length;n++){const r=e[n],s=r.getParent();s&&s.deleteVertex(r);const i=r.getEdges();for(const e of i)e.getStartVertex()===r&&e.setStartVertex(t),e.getEndVertex()===r&&e.setEndVertex(t)}e.every((e=>e.getSmooth()))&&t.setSmooth(!0)}},7261:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitEdgeByVertices=t.splitEdgeByVertex=void 0;const r=n(9548),s=n(40775);function i(e,t){if(e.getStartVertex()===t||e.getEndVertex()===t)return[];const n=e.getCurve(),i=n.split([n.getParamAt(t.getPoint())]);if(2!==i.length)return[];const o=new r.Edge(i[0],e.getStartVertex(),t),a=new r.Edge(i[1],t,e.getEndVertex());o.setData(e.getData()),a.setData(e.getData()),o.setFlags(e.getFlags()),a.setFlags(e.getFlags());e.getCoedge3ds().forEach((e=>((e,t,n)=>{const r=new s.Coedge3d(t,e.getSameDirWithEdge()),i=new s.Coedge3d(n,e.getSameDirWithEdge()),o=e.getWire(),a=o.getCoedge3ds().indexOf(e);-1!==a&&(e.getSameDirWithEdge()?o.replaceCoedge3d(a,[r,i]):o.replaceCoedge3d(a,[i,r]))})(e,o,a)));const c=e.getParent();return c&&(c.deleteEdge(e),c.addEdge(o),c.addEdge(a),c.addVertex(t)),e.dispose(),[o,a]}t.splitEdgeByVertex=i,t.splitEdgeByVertices=function(e,t){const n=e.getCurve();t.sort(((e,t)=>n.getParamAt(e.getPoint())-n.getParamAt(t.getPoint())));const r=[e];for(const e of t){const t=r[r.length-1];if(!t)continue;const n=e.getPoint();if(!n.equals(t.getStartVertex().getPoint())&&!n.equals(t.getEndVertex().getPoint())){const n=i(t,e);n&&n.length>0&&r.splice(r.length-1,1,...n)}}return r.length>1?r:[]}},95001:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitShell=void 0;const r=n(52667),s=n(70455),i=n(14785);t.splitShell=function(e){const t=i.ShellModelingUtil.divideFacesIntoConnectGroups(e.getFaces(),!0),n=[e];for(let i=1;i<t.length;i++){const o=new r.Shell;n.push(o);const a=t[i],c=new Set,l=new Set;a.forEach((e=>{e.getEdges().forEach((e=>c.add(e))),e.getVertexes().forEach((e=>l.add(e)))}));for(const t of a)e.deleteFace(t),o.addFace(t);for(const t of c)e.deleteEdge(t),o.addEdge(t);for(const t of l)e.deleteVertex(t),o.addVertex(t);s.ContinuousUtil.transferContinuousEdgeInfo(Array.from(c),e,o)}return n}},7951:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(97510),s=n(77032);class i extends r.default{constructor(e,t,n,r,s=!0,i=!0){super(n),this._face=e,this._pullPushVec=t,this._bExtrudeBehavior=r,this._bTopFaceDeal=s,this._bBoolean=i}_executeImpl(){const e={};try{s.pullPushFaceCore(this._face,this._pullPushVec,this._contextShells,this._bExtrudeBehavior,this._bTopFaceDeal,this._bBoolean,e)}catch(t){return e.errorStr=t,e}return e}}t.default=i},77032:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pullPushFaceCore=t.checkPullPushCondition=void 0;const r=n(98106),s=n(34652),i=n(70750),o=n(40775),a=n(52928),c=n(91343),l=n(9548),d=n(11593),u=n(7057),h=n(78597),g=n(28465),f=n(75434),p=n(50637),_="推拉面不合法",m="推拉面类型不支持",v="推拉面方向不垂直",E="推拉距离为零",P="推拉距离超过最大值";function y(e,t){if(!e||!e.getShell())throw new Error(_);const n=e.getSurface();if(!n.isPlane())throw new Error(m);if(!n.getNorm().isParallel(t))throw new Error(v);const s=t.getLength();if(s<r.Tolerance.LENGTH_EPS)throw new Error(E);if(s>r.CONST.MODEL_MAX_LENGTH)throw new Error(P)}function C(e,t){function n(e){const n=new o.Coedge3d(e.getEdge(),e.getSameDirWithEdge());return t.set(n,e),n}const r=e.getWires().map((e=>function(e){const t=[];for(const r of e.getCoedge3ds()){const e=n(r);t.push(e)}return new a.Wire(t)}(e))),s=new i.Face(e.getSurface().clone(),e.getSameDirWithSurface(),r);return e.getShell().addFace(s),s}function S(e,t){const n=r.Matrix4.makeTranslate(t);return e.clone().transform(n)}function T(e,t){const n=t.getNorm();if(e instanceof r.Plane)return e.getNorm().isPerpendicular(n);if(e instanceof r.Cylinder)return e.getCenterAxis().isParallel(n);return e.getNormAt({x:0,y:0}).isPerpendicular(n)}function b(e,t,n){for(const r of t.getCoedge3ds()){const t=r.getTwins().filter((e=>e)).map((e=>e.getWire().getParent())).filter((t=>t!==e)),s=t.every((t=>T(t.getSurface(),e.getSurface()))),i={bNeedCreation:0===t.length||!s};n.has(r)||n.set(r,i)}}function w(e,t,n,s,c,d){!function(e,t){for(const n of e.getWires())b(e,n,t)}(t,d);const u=t;for(const h of u.getWires()){const u=new Map;for(const g of h.getCoedge3ds()){const h=c.get(g),f=g.getEdge(),p=g.getSameDirWithEdge(),_=g.getEndVertex(),m=h.getEndVertex();let v=u.get(_);if(!v){const t=new r.Line3d(_.getPoint(),m.getPoint());v=new l.Edge(t,_,m),e.addEdge(v),u.set(_,v)}_.getSmooth()&&v.setSmooth(!0);const E=!0,P=h.getEdge(),y=!h.getSameDirWithEdge(),C=g.getStartVertex(),S=h.getStartVertex();let T=u.get(C);if(!T){const t=new r.Line3d(C.getPoint(),S.getPoint());T=new l.Edge(t,C,S),e.addEdge(T),u.set(C,T)}C.getSmooth()&&T.setSmooth(!0);const b=!1;let w,x;const M=f.getCurve();if(M.isLine3d())w=r.Plane.makePlaneByPoints([C.getPoint(),_.getPoint(),m.getPoint(),S.getPoint()],M.getDirection()),x=!0;else if(M.isArc3d()){const e=r.Cylinder.makeCylinderByArc3d(M);x=s.isSameDirection(e.getCenterAxis())===p,w=e}else{const e=new r.Line3d(C.getPoint(),S.getPoint()),t=new r.Plane(C.getPoint(),e.getDirection()),n=g.getCurve(),s=t.getCurve2d(n);w=new r.SweepSurface(e,s,!0,t.getCoord().getDy()),x=!0}if(!w)continue;const N=new a.Wire([new o.Coedge3d(f,p),new o.Coedge3d(v,E),new o.Coedge3d(P,y),new o.Coedge3d(T,b)]);let A;x?A=new i.Face(w,!0,[N]):(N.reverse(),A=new i.Face(w,!1,[N])),t.getSameDirWithSurface()===n&&A.reverse(),d.get(g).newSideFace=A}}for(const t of d.values())t.newSideFace&&e.addFace(t.newSideFace)}function x(e,t,n,r=0){let s=[],i=-1,o=-1;for(let n=r;n<e.length;n++)if(e[n].getStartVertex().getPoint().equals(t.getPoint())){i=n;break}if(-1!==i)for(let t=i;t<e.length;t++)if(e[t].getEndVertex().getPoint().equals(n.getPoint())){o=t+1;break}return-1!==o&&(s=e.slice(i,o)),s}function M(e,t,n,s,i){const o=t.getCoedge3ds();let a=0,c=[];for(const t of n)if(c.length&&(a=o.indexOf(c[c.length-1])+1),c=x(o,t.startV,t.endV,a),c.length)for(const t of c){const n=t.getTwins().filter((t=>t.getWire().getParent()!==e)).map((e=>e.getWire().getParent()));if(!(n.length<1))if(1===n.length)i.add(n[0]);else if(n.every((e=>e===n[0]||r.MathAlg.CalculateOverlap.isSurfacesCoplaner(e.getSurface(),n[0].getSurface())))){let e=!1;for(const t of s)if(n.some((e=>t.has(e)))){n.forEach((e=>t.add(e))),e=!0;break}e||s.push(new Set(n))}}s.forEach((e=>e.forEach((e=>i.delete(e)))))}function N(e,t,n,i){const o=function(e,t,n){const s=new Set,i=[];if(t.forEach((e=>{let t=n.get(e);t||(t=e.getBoundingBox(),n.set(e,t)),i.push(t)})),!t.length||i.every((e=>!e.isValid())))return s;for(const o of e)if(o)for(const e of o.getFaces()){if(-1!==t.indexOf(e))continue;if(!e.getSurface()||!r.MathAlg.CalculateOverlap.isSurfacesCoplaner(e.getSurface(),t[0].getSurface()))continue;let o=n.get(e);o||(o=e.getBoundingBox(),n.set(e,o)),o&&o.isValid()&&!i.every((e=>!e.intersectsBox(o)))&&s.add(e)}return s}(e,[t],new Map);try{const e=t.getEdges(),r=h.facesSplit(Array.from(o),[t],!1);if(n&&r.resultFaces&&r.resultFaces.length){let t=[];r.evolutionMap&&(t=Array.from(r.evolutionMap.values()).flat());const n=e=>{const t=e.getTwins().filter((e=>{const t=e.getWire();return t.getFace().getWires().indexOf(t)>0})).map((e=>e.getFace()));return Array.from(new Set(t))};for(const i of r.resultFaces){if(t.indexOf(i.tag)<0)continue;const o=i.getEdges();if(o.length!==e.length)continue;if(e.some((e=>o.indexOf(e)<0)))continue;const a=i.getWires()[0].getCoedge3ds();if(a[0].getTwins().length<=1)continue;let c=n(a[0]);for(let e=1;e<a.length;e++){const t=n(a[e]);if(c=c.filter((e=>t.indexOf(e)>-1)),!c.length)break}if(1===c.length&&c[0]!==i){const e=new Map;e.set(i.getShell(),{deleteFaces:[i]}),s.mergeShellModelingResult(r,{modifiedShellsMap:e}),d.disposeFace(i);break}}}s.mergeShellModelingResult(i,r)}catch(e){i.errorStr=e}}function A(e,t,n,r,i){const o=t.getWires(),a=o.map((e=>function(e,t){const n=[];let r=[];for(const s of e.getCoedge3ds())t.get(s).bNeedCreation?r.length&&(n.push({startV:r[0],endV:r[r.length-1]}),r.splice(0,r.length)):0===r.length?r=[s.getStartVertex(),s.getEndVertex()]:r[r.length-1]=s.getEndVertex();return r.length&&n.push({startV:r[0],endV:r[r.length-1]}),n}(e,n))),c=Array.from(n.values()).map((e=>e.newSideFace)).filter((e=>!!e)),l=function(e){const t=new Set;return Array.from(e.keys()).forEach((e=>t.add(e.getEdge()))),t.size!==e.size}(n),u=new p.default(c,e,l,!1).execute();if(s.mergeShellModelingResult(i,u),!r)for(let e=0;e<o.length;e++){const n=[],c=new Set;if(M(t,o[e],a[e],n,c),!r)for(const e of n)try{const t=Array.from(e),n=h.facesBooleanCore([t[0]],t.slice(1,t.length),0,!1);s.mergeShellModelingResult(i,n)}catch(e){i.errorStr=e}c.forEach((e=>{const t=new Map;t.set(e.getShell(),{deleteFaces:[e]}),s.mergeShellModelingResult(i,{modifiedShellsMap:t}),d.disposeFace(e)}))}}t.checkPullPushCondition=y,t.pullPushFaceCore=function(e,t,n,i,o,a,h){y(e,t),h.deleteShells=[],h.modifiedShellsMap=new Map,h.evolutionMap=new Map;const p=e.getCenterNorm(),_=p.dot(t)<0,m=e.getShell();s.addShellModifyInfo(h.modifiedShellsMap,m);const v=new Map,E=C(e,v);s.addShellModifyInfo(h.modifiedShellsMap,E.getShell(),[E]);const P=i&&_,T=e,b=E;!function(e,t){const n=e.getShell(),s=new Map,i=e.getCoedge3ds();for(const e of i){const r=e.getStartVertex();let i;s.has(r)||(i=new c.Vertex(r.getPoint().added(t)),r.getSmooth()&&i.setSmooth(!0),s.set(r,i),n.addVertex(i))}const o=new Map;for(const e of i){let r=o.get(e.getEdge());if(!r){const i=e.getEdge().getStartVertex(),a=e.getEdge().getEndVertex(),c=s.get(i),d=s.get(a),u=S(e.getEdge().getCurve(),t);r=new l.Edge(u,c,d),n.addEdge(r),o.set(e.getEdge(),r)}e.setEdge(r)}f.ContinuousUtil.cloneContinuousEdgeInfo(o.keys(),(e=>o.get(e)),r.Matrix4.makeTranslate(t)),i.length&&e.getSurface().translate(t)}(T,t),s.addShellModifyInfo(h.modifiedShellsMap,E.getShell(),void 0,void 0,[T]);const x=new Map;w(m,b,P,t,v,x);for(const e of x.values())e.newSideFace&&s.addShellModifyInfo(h.modifiedShellsMap,m,[e.newSideFace]);a&&A(n,b,x,i,h);const M=new Set;if(b.getCoedge3ds().forEach((e=>M.add(e.getStartVertex()))),i)_?T.reverse():b.reverse();else{const e=new Map;e.set(b.getShell(),{deleteFaces:[b]}),s.mergeShellModelingResult(h,{modifiedShellsMap:e}),d.disposeFace(b)}a&&N(n,T,o,h),function(e,t){const n=[];for(const r of e){const e=r.getEdges().filter((e=>e.getCoedge3ds().length));if(2!==e.length)continue;const s=e[0].getCurve(),i=e[1].getCurve();if(!s.isLine3d()||!i.isLine3d())continue;const o=s.getDirection(),a=i.getDirection();o.isParallel(t)&&a.isParallel(t)&&n.push([e[0],e[1],r])}n.forEach((e=>u.mergeConnectedEdge(e[0],e[1],e[2])))}(M,p);for(const e of h.modifiedShellsMap.values()){const t=new Set;e.addFaces&&e.addFaces.forEach((e=>e.getVertexes().forEach((e=>t.add(e))))),e.modifiedFaces&&e.modifiedFaces.forEach((e=>e.getVertexes().forEach((e=>t.add(e))))),g.SmoothUtil.udpateSmoothVertices(t)}for(const e of h.modifiedShellsMap.keys())f.ContinuousUtil.removeUnusedContinuousEdgeInfo(e)}},84775:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(97510),s=n(67163);class i extends r.default{constructor(e,t,n){super([]),this._face=e,this._pullPushVec=t,this._bExtrudeBehavior=n}_executeImpl(){let e={};try{e=s.pullPushFacePreviewCore(this._face,this._pullPushVec,this._bExtrudeBehavior)}catch(t){return e.errorStr=t,e}return e}_validateResult(){return!1}}t.default=i},67163:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.pullPushFacePreviewCore=t.PullPushFacePreviewUtil=void 0;const r=n(98106),s=n(34652),i=n(70750),o=n(52928),a=n(91343),c=n(9548),l=n(77032),d=n(40775),u=n(77354);function h(e,t){const n=new r.Line3d(e.getPoint(),t.getPoint()),s=new c.Edge(n,e,t);return s.setSmooth(e.getSmooth()),s}function g(e){const t=e.getCoedge3ds();return t.map(((e,n)=>[e.getStartVertex(),e.getStartVertex().getPoint().clone(),e,t[(n-1+t.length)%t.length]]))}class f{constructor(e,t,n){this._face=e,this._pullPushVec=t,this._bClosedBottom=n}execute(){const e={deleteShells:[]};e.modifiedShellsMap=new Map;const t=this._face.getShell(),n=[],r=[this._face],o=[],a=this._face.getSurface().getNormAt({x:0,y:0});for(const e of this._face.getWires()){const t=this._dealVertexesAndSideEdges(e,a);this._dealSideFaces(t,a,n,r),o.push(t)}const c=this._face.getSurface(),l=this._face.getSameDirWithSurface(),d=c.clone().translate(this._pullPushVec);if(this._face.setSurface(d),this._regenerateFaceByVertexes(this._face,o),this._bClosedBottom){const e=new i.Face(c,!l);t.addFace(e),this._regenerateFaceByVertexes(e,o),n.push(e)}return s.addShellModifyInfo(e.modifiedShellsMap,t,n,void 0,r),e}_dealVertexesAndSideEdges(e,t){const n=this._face.getParent(),s=new Set;for(const t of e.getCoedge3ds())s.add(t.getEdge());const i=[],o=new Set,c=new Set,l=g(e);return l.forEach((([e,n,i,a])=>{var l;if(!o.has(e.tag)){if(i.getTwin()&&a.getTwin()){const n=e.getEdges().filter((e=>!s.has(e)));if(0===n.length){if((null===(l=i.getTwin())||void 0===l?void 0:l.getFace())&&this._isSurfacePerpendicularPlane(i.getTwin().getFace().getSurface(),t))return}else{let e=!0;for(const s of n){const n=s.getCurve();n instanceof r.Line3d&&n.getDirection().isParallel(t)||(e=!1)}if(e)return void n.map((e=>c.add(e.tag)))}}o.add(e.tag)}})),l.forEach((([e,t,s])=>{const l=t.added(this._pullPushVec);if(o.has(e.tag)){const t=new a.Vertex(l);n.addVertex(t);const r=h(e,t);n.addEdge(r),i.push({v:e,v_:t,ce:s,newEdge:r})}else{e.setPoint(l);const t=e.getEdges().filter((e=>c.has(e.tag)));for(const e of t){const t=new r.Line3d(e.getStartVertex().getPoint(),e.getEndVertex().getPoint());e.setCurve(t)}i.push({v:e,ce:s})}})),i}_dealSideFaces(e,t,n,r){for(let s=0;s<e.length;s++){const i=e[s].ce,o=e[s],a=e[(s+1)%e.length];if(!o.v_&&!a.v_){const e=i.getEdge(),t=e.getCurve().clone().translate(this._pullPushVec);e.setCurve(t);const n=i.getTwins().map((e=>e.getFace())).filter((e=>!!e));n.length&&r.push(...new Set(n));continue}if(o.v_&&a.v_){const{newFace:e,modifiedFace:s}=this._handleNewNew(i,o,a,t);e&&n.push(e),s&&r.push(s);continue}let c;c=!o.v_&&a.v_?this._handleTanslateNew(i,o,a):this._handleNewTanslate(i,o,a),c&&r.push(c)}}_newSideSurface(e,t,n,s){const i=n.subtracted(t),o=s.dot(i)>0,a=e.getCurve();if(a instanceof r.Line3d){const e=a.getDirection();return{surf:new r.Plane(t,e,i),sameDir:o}}if(a instanceof r.Arc3d){const e=a.getCoord(),t=new r.Coordinate3(e.getOrigin(),e.getDx(),i.cross(e.getDx()));return{surf:new r.Cylinder(t,a.getA(),a.getB()),sameDir:o}}const c=new r.Line3d(t,n),l=new r.Coordinate3(t,c.getDirection()),d=new r.Plane(l).getCurve2d(a);return{surf:new r.SweepSurface(c,d,!0,l.getDy()),sameDir:o}}_isSurfacePerpendicularPlane(e,t){if(e instanceof r.Plane)return e.getNorm().isPerpendicular(t);if(e instanceof r.Cylinder)return e.getCenterAxis().isParallel(t);if(e instanceof r.SweepSurface){const n=e.getPath();if(n.isLine3d())return n.getDirection().isParallel(t);if(e.getProfile().isLine2d()){return e.getIsoCurve(n.getRange().getMid(),!0).getDirection().isParallel(t)}return!1}if(e instanceof r.OffsetSurface){const n=e.getBaseSurface();return this._isSurfacePerpendicularPlane(n,t)}return!1}_handleNewNew(e,t,n,s){const a=t.ce.getShell(),l=e.getTwins();l.length;const u=e.getEdge(),h=e.getCurve().translate(this._pullPushVec),g=new c.Edge(h,t.v_,n.v_);if(a.addEdge(g),1===l.length){const i=l[0].getFace().getSurface();if(this._isSurfacePerpendicularPlane(i,s)){const s=l[0],i=s.getWire(),o=i.getCoedge3ds().findIndex((e=>e===s));if(s.getSameDirWithEdge()===e.getSameDirWithEdge()){const e=new d.Coedge3d(t.newEdge,!0),r=new d.Coedge3d(g,!0),s=new d.Coedge3d(n.newEdge,!1);i.replaceCoedge3d(o,[e,r,s])}else{const e=new d.Coedge3d(n.newEdge,!0),r=new d.Coedge3d(g,!1),s=new d.Coedge3d(t.newEdge,!1);i.replaceCoedge3d(o,[e,r,s])}const c=a.deleteEdge(u);return r.MathAssert.assert(c,"删除失败"),{modifiedFace:i.getFace()}}}const f=new o.Wire,p=this._newSideSurface(e,t.v.getPoint(),t.v_.getPoint(),s),_=new i.Face(p.surf,p.sameDir,[f]);return f.addCoedge3d(new d.Coedge3d(n.newEdge,!0)),f.addCoedge3d(new d.Coedge3d(g,!1)),f.addCoedge3d(new d.Coedge3d(t.newEdge,!1)),e.getSameDirWithEdge()?f.addCoedge3d(new d.Coedge3d(u,!0)):f.addCoedge3d(new d.Coedge3d(u,!1)),a.addFace(_),{newFace:_}}_handleTanslateNew(e,{v:t,ce:n},{v_:r,newEdge:s}){const i=n.getTwins();if(0===i.length)return;i.length;const o=n.getEdge();o.getCurve().translate(this._pullPushVec),n.getSameDirWithEdge()?o.setEndVertex(r):o.setStartVertex(r);const a=i[0],c=a.getWire(),l=c.getCoedge3ds().findIndex((e=>e===a));if(a.getSameDirWithEdge()===n.getSameDirWithEdge()){const e=new d.Coedge3d(s,!0);c.insertCoedge3d(l+1,e)}else{const e=new d.Coedge3d(s,!0);c.insertCoedge3d(l,e)}return c.getFace()}_handleNewTanslate(e,{v:t,v_:n,ce:r,newEdge:s},{v:i}){const o=r.getTwins();if(0===o.length)return;o.length;const a=r.getEdge();a.getCurve().translate(this._pullPushVec),r.getSameDirWithEdge()?a.setStartVertex(n):a.setEndVertex(n);const c=o[0],l=c.getWire(),u=l.getCoedge3ds().findIndex((e=>e===c));if(c.getSameDirWithEdge()===r.getSameDirWithEdge()){const e=new d.Coedge3d(s,!0);l.insertCoedge3d(u,e)}else{const e=new d.Coedge3d(s,!0);l.insertCoedge3d(u+1,e)}return l.getFace()}_regenerateFaceByVertexes(e,t){const n=e.getParent();e.deleteAllWires(),t.forEach(((t,s)=>{const i=new o.Wire;e.addWire(i),t.forEach(((o,a)=>{var c,l;const u=null!==(c=o.v_)&&void 0!==c?c:o.v,g=u.getEdges(),f=t[(a+1)%t.length],p=null!==(l=f.v_)&&void 0!==l?l:f.v;let _;for(const e of g)if(e.getEndVertexTag()===p.tag||e.getStartVertexTag()===p.tag){if(o.ce.getCurve().getType()!==e.getCurve().getType())continue;const t=o.ce.getCurve().getStartTangent(),n=o.ce.getCurve().getEndTangent(),r=e.getCurve().getStartTangent(),s=e.getCurve().getEndTangent();if(r.isParallel(t)&&s.isParallel(n)||r.isParallel(n)&&s.isParallel(t)){_=e;break}}if(_||(_=h(u,p),n.addEdge(_)),p.tag===u.tag){const t=e.getSurface().getCurve2d(_.getCurve()),n=new r.Loop([t]).calcArea()>0,o=0===s;i.addCoedge3d(new d.Coedge3d(_,o===n))}else i.addCoedge3d(new d.Coedge3d(_,_.getStartVertexTag()===u.tag))}))}))}}function p({v:e,v_:t,ce:n,newEdge:s},{v:a,v_:c,newEdge:l}){const u=e.getParent(),g=n.getFace().getCenterNorm(),f=n.getTwins(),p=n.getEdge(),_=h(t,c);if(u.addEdge(_),1===f.length){const t=f[0].getFace().getSurface();if(t.isPlane()&&t.getNorm().isPerpendicular(g)){const t=f[0],n=t.getWire(),i=n.getCoedge3ds().findIndex((e=>e===t));if(t.getStartVertex().tag===e.tag){const e=new d.Coedge3d(s,!0),t=new d.Coedge3d(_,!0),r=new d.Coedge3d(l,!1);n.replaceCoedge3d(i,[e,t,r])}else{const e=new d.Coedge3d(l,!0),t=new d.Coedge3d(_,!1),r=new d.Coedge3d(s,!1);n.replaceCoedge3d(i,[r,t,e])}const o=u.deleteEdge(p);return r.MathAssert.assert(o,"删除失败"),{modifiedFace:n.getFace()}}}const m=new r.Plane(e.getPoint(),new r.Vector3(e.getPoint(),a.getPoint()),new r.Vector3(e.getPoint(),t.getPoint())),v=new o.Wire,E=new i.Face(m,!0,[v]);return v.addCoedge3d(new d.Coedge3d(l,!0)),v.addCoedge3d(new d.Coedge3d(_,!1)),v.addCoedge3d(new d.Coedge3d(s,!1)),p.getStartVertex().tag===e.tag?v.addCoedge3d(new d.Coedge3d(p,!0)):v.addCoedge3d(new d.Coedge3d(p,!1)),u.addFace(E),{newFace:E}}function _({v:e,ce:t},{v_:n,newEdge:r}){const s=e.getParent(),i=t.getTwins();if(0===i.length)return;i.length;const o=i[0],a=o.getWire(),c=a.getCoedge3ds().findIndex((e=>e===o)),l=h(n,e);if(s.addEdge(l),o.getStartVertex().tag===e.tag){const e=new d.Coedge3d(l,!1),t=new d.Coedge3d(r,!1);a.replaceCoedge3d(c,[e,t])}else{const e=new d.Coedge3d(r,!0),t=new d.Coedge3d(l,!0);a.replaceCoedge3d(c,[e,t])}return s.deleteEdgeByTag(t.getEdgeTag()),a.getFace()}function m({v:e,v_:t,ce:n,newEdge:r},{v:s}){const i=e.getParent(),o=n.getTwins();if(0===o.length)return;o.length;const a=o[0],c=a.getWire(),l=c.getCoedge3ds().findIndex((e=>e===a)),u=h(t,s);if(i.addEdge(u),a.getStartVertex().tag===e.tag){const e=new d.Coedge3d(r,!0),t=new d.Coedge3d(u,!0);c.replaceCoedge3d(l,[e,t])}else{const e=new d.Coedge3d(u,!1),t=new d.Coedge3d(r,!1);c.replaceCoedge3d(l,[e,t])}return i.deleteEdgeByTag(n.getEdgeTag()),c.getFace()}function v(e,t){const n=e.getParent();e.deleteAllWires(),t.forEach((t=>{const r=new o.Wire;e.addWire(r),t.forEach(((e,s)=>{const i=e.getEdges(),o=t[(s+1)%t.length];let a;for(const e of i)if(e.getEndVertexTag()===o.tag){a=e;break}a||(a=h(e,o),n.addEdge(a)),r.addCoedge3d(new d.Coedge3d(a,a.getStartVertexTag()===e.tag))}))}))}t.PullPushFacePreviewUtil=f,t.pullPushFacePreviewCore=function(e,t,n){if(l.checkPullPushCondition(e,t),n){const n=e.getSurface().getCoord().clone(),i=e.calcPolygon(),o=new r.Polygon;i.getLoops().forEach((e=>{const t=new r.Loop;e.getAllCurves().forEach((e=>{e.isLine2d()||e.isArc2d()?t.addCurve(e):t.addCurve(new r.SmoothPoly2d(e.discrete(r.DiscreteParameter.LOW)))})),o.addLoop(t,!1)}));const a=t.normalized();let c=0,l=0;n.getDz().dot(t)>0?l=t.getLength():(c=-t.getLength(),a.reverse());const d=e.getShell(),h=u.ExtrudeBody.execute(n,o,a,c,l,!1,!1,[]);h.getFaces().forEach((e=>d.addFace(e))),h.getEdges().forEach((e=>d.addEdge(e))),h.getVertexs().forEach((e=>d.addVertex(e)));const g={};return g.modifiedShellsMap=new Map,s.addShellModifyInfo(g.modifiedShellsMap,d,h.getFaces().slice(),void 0,void 0),g}if((e=>{const t=e.getEdges();for(const e of t)if(!e.getCurve().isLine3d())return!0;return!1})(e))return new f(e,t,n).execute();const o={deleteShells:[]};o.modifiedShellsMap=new Map;const c=[],d=[e],E=[];e.getWires().forEach((e=>{const{newFaces:n,modifiedFaces:s,vertexInfos:i}=function(e,t){const n=e.getFace(),s=n.getParent(),i=g(e),o=new Set(n.getEdges()),c=n.getSurface().getNormAt({x:0,y:0}),l=[],d=new Set;i.forEach((([e,t,n,r])=>{var s,i;if(!d.has(e.tag)){if(n.getTwin()&&r.getTwin()){const t=e.getEdges().filter((e=>!o.has(e)));if(!t.length&&(null===(i=null===(s=n.getTwin())||void 0===s?void 0:s.getFace())||void 0===i?void 0:i.getSurface().getNormAt({x:0,y:0}).isPerpendicular(c)))return;if(1===t.length){const e=t[0].getCurve();if(e.isLine3d()&&e.getDirection().isParallel(c))return}}d.add(e.tag)}})),i.forEach((([e,n,r])=>{const i=n.added(t);if(d.has(e.tag)){const t=new a.Vertex(i);s.addVertex(t);const n=h(e,t);s.addEdge(n),l.push({v:e,v_:t,ce:r,newEdge:n})}else e.setPoint(i),l.push({v:e,ce:r})})),l.forEach((({v:e,v_:t})=>{t||e.getEdges().forEach((e=>{const t=new r.Line3d(e.getStartVertex().getPoint(),e.getEndVertex().getPoint());e.setCurve(t)}))}));const u=[],f=[];for(let e=0;e<l.length;e++){const t=l[e],n=l[(e+1)%l.length],{newEdge:r,ce:s}=t,{newEdge:i}=n;if(!r&&!i){const e=s.getTwins().map((e=>e.getFace())).filter((e=>!!e));e.length&&f.push(...new Set(e));continue}if(r&&i){const{newFace:e,modifiedFace:r}=p(t,n);e&&u.push(e),r&&f.push(r);continue}let o;o=!r&&i?_(t,n):m(t,n),o&&f.push(o)}return{newFaces:u,vertexInfos:l,modifiedFaces:f}}(e,t);c.push(...n),d.push(...s),E.push(i)}));const P=e.getShell(),y=e.getSurface(),C=e.getSameDirWithSurface(),S=y.clone().translate(t);if(e.setSurface(S),v(e,E.map((e=>e.map((({v:e,v_:t})=>null!=t?t:e))))),n){const e=new i.Face(y,!C);P.addFace(e);v(e,E.map((e=>e.map((({v:e})=>e))))),c.push(e)}return s.addShellModifyInfo(o.modifiedShellsMap,P,c,void 0,d),o}},30972:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rounding2D=void 0;const r=n(18382),s=n(98106),i=n(9548),o=n(40775),a=n(91343),c=n(97510),l=n(34652),d=n(7261),u=n(75434);class h extends c.default{constructor(e,t,n,r,s){super(r),this._edge1=e,this._edge2=t,this._radius=n,this._useSmooth=s}_executeImpl(){const e=this._canRounding(this._edge1,this._edge2);if(e)return{errorStr:e};const t=this._edge1.getStartVertex()===this._commonV,n=this._edge2.getStartVertex()===this._commonV,c={modifiedShellsMap:new Map},h=this._edge1.getCurve(),g=this._edge2.getCurve();let f=h.getDirection().dot(g.getDirection());if(t!==n&&(f=-f),s.MathUtil.isNearlyEqual(f,1)||s.MathUtil.isNearlyEqual(f,-1))return{errorStr:"倒圆角的边共线"};const p=Math.sqrt((1-f)/(1+f)),_=this._radius/p,m=this._edge1.getStartVertex().getPoint().distanceTo(this._edge1.getEndVertex().getPoint()),v=this._edge2.getStartVertex().getPoint().distanceTo(this._edge2.getEndVertex().getPoint());let E=_;(s.MathUtil.isNearlyBiggerOrEqual(_,m)||s.MathUtil.isNearlyBiggerOrEqual(_,v))&&(E=Math.min(m,v));let P=this._commonV.getPoint();if(!h.containsPoint(P)||!g.containsPoint(P)){const e=h.getDirection(),t=g.getDirection(),n=g.getOrigin().subtracted(h.getOrigin()),s=[[e.dot(e),-e.dot(t)],[t.dot(e),-t.dot(t)]],i=[e.dot(n),t.dot(n)],o=r.solve(s,i);P=h.getPtAt(o[0])}const y=h.getParamAt(P),C=g.getParamAt(P);let S,T;S=t?y+E:y-E,T=n?C+E:C-E;let b=t?this._edge1.getEndVertex():this._edge1.getStartVertex(),w=this._edge1;if(!h.getRange().containsPointAtStartOrEnd(S)){b=new a.Vertex(h.getPtAt(S));const e=d.splitEdgeByVertex(this._edge1,b);w=t?e[0]:e[1]}let x=n?this._edge2.getEndVertex():this._edge2.getStartVertex(),M=this._edge2;if(!g.getRange().containsPointAtStartOrEnd(T)){x=new a.Vertex(g.getPtAt(T));const e=d.splitEdgeByVertex(this._edge2,x);M=n?e[0]:e[1]}const N=this._edge1.getParent(),A=this._calRoundingArc3d(h,g,b.getPoint(),x.getPoint()),O=[];if(this._useSmooth){const e=A.discreteBySpan();e.pop(),e.shift();const t=e.map((e=>new a.Vertex(e)));t.forEach((e=>{e.setSmooth(!0),N.addVertex(e)})),t.push(x),t.unshift(b);for(let e=0;e<t.length-1;e++){const n=new i.Edge(new s.Line3d(t[e].getPoint(),t[e+1].getPoint()),t[e],t[e+1]);O.push(n),N.addEdge(n)}u.ContinuousUtil.addContinuousEdgeInfo(O,(()=>A))}else{const e=new i.Edge(A,b,x);O.push(e),N.addEdge(e)}const I=w.getCoedge3ds(),D=M.getCoedge3ds(),L=[];for(const e of I){const t=e.getNextCoedge();if(D.indexOf(t)>-1){L.push({c1:e,c2:t,sameDir:!0});continue}const n=e.getPrevCoedge();D.indexOf(n)>-1&&L.push({c1:e,c2:n,sameDir:!1})}for(const e of L)if(e.sameDir){const t=e.c1.getWire();t.deleteCoedge3d(e.c2);const n=O.map((e=>new o.Coedge3d(e,!0)));t.replaceCoedge3d(e.c1.getIndexInWire(),n),w.deleteCoedge3d(e.c1),M.deleteCoedge3d(e.c2)}else{const t=e.c1.getWire();t.deleteCoedge3d(e.c1);const n=O.map((e=>new o.Coedge3d(e,!1))).reverse();t.replaceCoedge3d(e.c2.getIndexInWire(),n),w.deleteCoedge3d(e.c1),M.deleteCoedge3d(e.c2)}if(w.getCoedge3ds().length||(w.dispose(),N.deleteEdge(w)),M.getCoedge3ds().length||(M.dispose(),N.deleteEdge(M)),!this._commonV.getEdges().length){(this._commonV.getParent()||N).deleteVertex(this._commonV)}return l.addShellModifyInfo(c.modifiedShellsMap,N,void 0,void 0,this._commonF),c}_canRounding(e,t){if(e.getCurve().getType()!==s.EN_GEO_ELEMENT_TYPE.EN_LINE_3D||t.getCurve().getType()!==s.EN_GEO_ELEMENT_TYPE.EN_LINE_3D)return"倒圆角的边不是直线边";const n=e.getFaces(),r=t.getFaces();if(!n.length||void 0===e.getParent()||!r.length||void 0===t.getParent()||e.getParent()!==t.getParent())return"倒圆角的边不共面";const i=[e.getStartVertex(),e.getEndVertex()],o=[t.getStartVertex(),t.getEndVertex()],a=i.filter((e=>o.findIndex((t=>t===e))>-1)),c=n.filter((e=>r.findIndex((t=>t===e))>-1));if(1!==a.length||!c.length)return"倒圆角的边不相邻";const l=[...n,...r].map((e=>e.getSurface()));if(!l.every((e=>e.isPlane()))||!l.every((e=>e.isCoplanar(l[0]))))return"倒圆角边关联的面不在同一平面上";this._commonV=a[0],this._commonF=c}_calRoundingArc3d(e,t,n,i){const o=e.getDirection(),a=t.getDirection(),c=o.cross(a),l=c.cross(o).normalize(),d=c.cross(a).normalize(),u=new s.Line3d(n,l,[-1e4,1e4]),h=new s.Line3d(i,d,[-1e4,1e4]).getOrigin().subtracted(u.getOrigin()),g=[[l.dot(l),-l.dot(d)],[d.dot(l),-d.dot(d)]],f=[l.dot(h),d.dot(h)],p=r.solve(g,f),_=u.getPtAt(p[0]),m=_.distanceTo(n),v=_.subtracted(n).cross(_.subtracted(i));return s.Arc3d.makeArcByStartEndPoints(_,m,v,n,i,!0)}}t.Rounding2D=h},32696:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fillet3d=void 0;const r=n(98106),s=n(34652),i=n(50637),o=n(9548),a=n(91343),c=n(70750),l=n(52928),d=n(40775),u=n(91859),h=n(78926);t.Fillet3d=class{constructor(e,t,n,s=r.Tolerance.DEFAULT){this._originEdges=e,this._radius=t,this._contextShells=n,this._tol=s}execute(){let e;try{e=this._generateFillet3d();const t=[];e.addShells&&t.push(...e.addShells),e.modifiedShellsMap&&t.push(...e.modifiedShellsMap.keys());const n=[];if(t.forEach((e=>n.push(...u.DiagnoseShell.execute(e)))),n.length)throw e.topoErrors=n,new Error(`${this.constructor.name}操作后, Brep数据不合法`)}catch(t){return e={errorStr:t},e}return e}_generateFillet3d(){this._preprocess();const e=this._canFillet();if(e)return{errorStr:e};this._initial();const t=h.Fillet3dBase.createFilletSurface(this._realFilletEdges,this._radius,this._tol,!0),n=this._createVtFilletSphere(t),r=this._calcSurfaceEdgeIntersectVts(t),s=this._mergeCoincideVertices(r),i=this._updateOldFace(t,n,s),o=new Map;this._calcFilletSurfaceIntersectEdges(s,n,i,o);const a=this._createFaceOnFilletSurfaces(i,t),c=this._createFaceAtCommonVts(o,n);this._deleteNoUseElements(),this._dealDegenerateEdges();const l=this._updateModelingResult(a,c);return this._shell.updateTolerance(),l}_preprocess(){this._allFilletEdges=new Set(this._originEdges);for(const e of this._allFilletEdges){const t=e.getFaces();if(2!==t.length)continue;if(r.MathAlg.CalculateOverlap.isSurfacesCoplaner(t[0].getSurface(),t[1].getSurface())){this._allFilletEdges.delete(e);continue}const n=e.getCurve().getStartPt(),s=e.getCurve().getEndPt(),i=e.getCurve().getMidPt();for(const r of[n,i,s]){const n=t[0].getSurface().getNormAtPoint(r),s=t[1].getSurface().getNormAtPoint(r);if(n.isParallel(s,100*this._tol.angleEps)){this._allFilletEdges.delete(e);break}}}this._colinearEdgesMap=new Map;const e=new Set(this._allFilletEdges),t=new Set(this._allFilletEdges);for(const n of e){if(this._findInColinearEdgesMap(n))continue;const e=h.findEdgeConnectColinearEdges(n);for(const n of e)this._allFilletEdges.add(n),t.delete(n);e.size>0&&this._colinearEdgesMap.set(n,[n,...e])}this._realFilletEdges=[...t]}_initial(){const e=new Set;for(const t of this._allFilletEdges)e.add(t.getStartVertex()),e.add(t.getEndVertex());const t=new Set;for(const n of e){const e=n.getEdges();for(const n of e)t.add(n)}this._allConcaveEdge=new Set,this._concaveFilletEdge=new Set;for(const e of t)this._isConcaveEdge(e)&&(this._realFilletEdges.find((t=>t===e))&&this._concaveFilletEdge.add(e),this._allConcaveEdge.add(e));const n=new Map;for(const t of e){const e=[],r=t.getEdges();for(const t of r)this._allFilletEdges.has(t)&&e.push(t);if(e.length>=3){const r={concaveEdges:[],convexEdges:[]};for(const t of e)this._concaveFilletEdge.has(t)?r.concaveEdges.push(t):r.convexEdges.push(t);n.set(t,r)}}this._complexVtEdgesMap=n,this._concaveFaceEdges=new Map;for(const t of e){const e=t.getEdges(),n=[],r=[];for(const t of e)this._allConcaveEdge.has(t)?n.push(t):r.push(t);if(1===n.length&&!n[0].getCurve().isPeriodic()&&2===r.length){const e=r[0].getFaces(),t=r[1].getFaces(),n=e[0]===t[0]||e[0]===t[1]?e[0]:e[1],s=this._concaveFaceEdges.get(n);s?s.push({edge1:r[0],edge2:r[1]}):this._concaveFaceEdges.set(n,[{edge1:r[0],edge2:r[1]}])}if(1===r.length&&2===n.length){const e=n[0].getFaces(),t=n[1].getFaces(),r=e[0]===t[0]||e[0]===t[1]?e[0]:e[1],s=this._concaveFaceEdges.get(r);s?s.push({edge1:n[0],edge2:n[1]}):this._concaveFaceEdges.set(r,[{edge1:n[0],edge2:n[1]}])}}this._edgeSameDirFacePairs=new Map;for(const e of this._allFilletEdges){const t=e.getCoedge3ds();t[0].getSameDirWithEdge()===t[1].getSameDirWithEdge()&&this._edgeSameDirFacePairs.set(e,{faces:e.getFaces(),sameDirFlag:1})}this._edgePerpendicularFaces=new Map;for(const e of this._allFilletEdges){const t=e.getFaces();let n=!1;const r=t[0].getSurface(),s=t[1].getSurface();r.isPlane()?n=h.Fillet3dBase.isSurfacePerpendicularPlane(s,r):s.isPlane()&&(n=h.Fillet3dBase.isSurfacePerpendicularPlane(r,s)),n&&this._edgePerpendicularFaces.set(e,t)}this._newXCurveAtConcaveEdge=new Map,this._eatEdgesSet=new Set,this._eatFacesSet=new Set,this._edgeOriginVtMap=new Map,this._faceEdgeNewVtInfoMap=new Map,this._shell=this._realFilletEdges[0].getShell()}_canFillet(){if(this._realFilletEdges.length<=0)return"所选择的倒角不合法！";const e=this._realFilletEdges[0].getShell();for(const t of e.getFaces())if(t.getSurface().isNurbsSurface())return"NurbsSurface暂不支持倒角！";for(const e of this._allFilletEdges){if(2!==e.getFaces().length)return"倒角边关联的face的数量不符合条件！"}for(const e of this._allFilletEdges){const t=e.getCurve(),n=t.getStartTangent(),r=t.getEndTangent();if(e.getStartVertex()===e.getEndVertex()&&!n.equals(r))return"倒角首尾位置不相切！";if(t.isNurbsCurve3d()&&!t.isPlaneCurve3d())return"空间nurbs曲线不能倒角！"}const t=new Set;for(const e of this._allFilletEdges)t.add(e.getStartVertex()),t.add(e.getEndVertex());for(const e of t){const t=[],n=e.getEdges();for(const e of n)this._allFilletEdges.has(e)&&t.push(e);if(t.length>3)return"侧边关联相的face个数太多，不支持倒角！"}}_deleteNoUseElements(){for(const e of this._eatFacesSet)e.dispose(),this._shell.deleteFace(e);const e=new Set;for(const t of this._realFilletEdges)e.add(t.getStartVertex()),e.add(t.getEndVertex()),t.dispose(),this._shell.deleteEdge(t);for(const t of this._eatEdgesSet)e.add(t.getStartVertex()),e.add(t.getEndVertex()),t.dispose(),this._shell.deleteEdge(t);for(const t of e)0===t.getEdges().length&&this._shell.deleteVertex(t)}_updateModelingResult(e,t){const n={},r=new Map,o=[...this._faceEdgeNewVtInfoMap.keys()],a=[...e,...t],c={addFaces:a,deleteFaces:[...this._eatFacesSet],modifiedFaces:o};if(r.set(this._shell,c),n.modifiedShellsMap=r,this._contextShells.length>0){const e=[...o,...a],t=new i.default(e,this._contextShells,!0).execute();s.mergeShellModelingResult(n,t)}return n}_createVtFilletSphere(e){const t=new Map;for(const n of this._complexVtEdgesMap){const s=n[1],i=[...s.convexEdges,...s.concaveEdges];if(3!==i.length)throw 4===i.length?new Error("fillet3d: 暂未实现一个顶点4条edge倒角！"):new Error("fillet3d: 不支持一个顶点4条以上edge倒角！");{if(s.concaveEdges.length>0&&s.convexEdges.length>0){let o,a;1===s.concaveEdges.length&&2===s.convexEdges.length?(o=s.concaveEdges[0],a=s.convexEdges):(o=s.convexEdges[0],a=s.concaveEdges);const c=this._findInColinearEdgesMap(o)||o,l=e.get(c),d=r.OffsetSurface.make(l,this._radius),u=n[0].getFaces(),h=o.getFaces(),g=u.find((e=>e!==h[0]&&e!==h[1])),f=a[0],p=this._getEdgeTwoOffsetSurface(f),_=g===p[0].face?p[0].surf:p[1].surf,m=r.MathAlg.CalculateIntersect.surfacesNearPoint(d,_,n[0].getPoint());if(!m)throw new Error("fiilet：计算fillet surface的中心轴线求交失败!");const v=r.Coordinate2.XOY(),E=new r.Arc2d(v,this._radius,this._radius,!0),P=m.getStartPt().equals(m.getEndPt()),y=new r.SweepSurface(m,E,!P),C=[];for(const t of i){const n=this._findInColinearEdgesMap(t)||t;C.push({edge:n,surface:e.get(n)})}const S={edgeSurfs:C,vtSurf:y};t.set(n[0],{sphereInfos:[S]});continue}const o=this._findInColinearEdgesMap(i[0])||i[0],a=e.get(o),c=h.Fillet3dBase.getFillerSurfaceAxis(a),l=this._findInColinearEdgesMap(i[1])||i[1],d=e.get(l),u=h.Fillet3dBase.getFillerSurfaceAxis(d),g=r.MathAlg.CalculateIntersect.curve3ds(c,u);if(0===g.length)throw new Error("fillet：未计算到球心位置！");let f,p,_;i[0].getStartVertex()===n[0]?f=i[0].getCurve().getStartTangent():(f=i[0].getCurve().getEndTangent(),f.reverse()),i[1].getStartVertex()===n[0]?p=i[1].getCurve().getStartTangent():(p=i[1].getCurve().getEndTangent(),p.reverse()),i[2].getStartVertex()===n[0]?_=i[2].getCurve().getStartTangent():(_=i[2].getCurve().getEndTangent(),_.reverse());const m=n[0].getPoint().added(f.added(p).added(_).multiply(this._radius));let v,E=g[0].point,P=g[0].point.sqDistanceTo(m);for(let e=1;e<g.length;e++){const t=g[e].point.sqDistanceTo(m);t<P-this._tol.edgeLengthEps2&&(E=g[e].point,P=t)}for(const e of n[0].getFaces())if(e.getSurface().isPlane()){v=e.getSurface();break}v||(v=n[0].getFaces()[0].getSurface());const y=v.getNormAtPoint(E),C=E.subtracted(n[0].getPoint()),S=y.cross(C).cross(y),T=y.cross(S),b=new r.Coordinate3(E,S,T),w=new r.Sphere(b,this._radius,this._radius,this._radius),x=[];for(const t of i){const n=this._findInColinearEdgesMap(t)||t;x.push({edge:n,surface:e.get(n)})}const M={edgeSurfs:x,vtSurf:w};t.set(n[0],{sphereInfos:[M]})}}return t}_getEdgeTwoOffsetSurface(e){const[t,n]=this._getLeftAndRightCoedge(e),s=t.getFace(),i=n.getFace(),o=e.getCurve().getMidPt(),a=s.getSurface().getNormAtPoint(o),c=i.getSurface().getNormAtPoint(o);s.getSameDirWithSurface()||a.reverse(),i.getSameDirWithSurface()||c.reverse();const l=this._concaveFilletEdge.has(e),d=l===s.getSameDirWithSurface()?this._radius:-this._radius,u=l===i.getSameDirWithSurface()?this._radius:-this._radius,h=r.OffsetSurface.make(s.getSurface(),d),g=r.OffsetSurface.make(i.getSurface(),u);return[{face:s,surf:h},{face:i,surf:g}]}_calcSurfaceEdgeIntersectVts(e){const t=[];for(const n of e){const e=n[0],r=n[1],s={edge:e,surface:r},i=this._concaveFilletEdge.has(e),o=this._getConnectConcaveEdges(e);i?this._calcFaceExtraXCurveAtConcaveFilletEdge(e,o):o.size>0&&this._calcFaceExtraXCurveAtConcaveEdge(e,o);const a=new Set,c=[],l=e.getFaces();for(const n of l){const d=[];for(const r of n.getWires()){const i=this._calcFilletSurfXWireEdges(s,r,c);if(this._dealWireEdgeXVts(s,r,i,d,t)){for(const e of r.getCoedge3ds()){a.add(e.getEdge());const t=e.getTwin();if(!t)continue;const n=t.getFace();l.find((e=>e===n))||this._eatFacesSet.has(n)||l.push(n)}n.deleteWire(r)}this._findWireEatEdgesByFilletEdge(r,e,i,a)}if(d.length<1){if(this._mainFaceIsEat(e,r,n)){this._addFacesAdjacentEatFace(n,l);continue}if(s.surface.isSphere())continue;this._addFaceEdgeNewVtInfo(n,s,d)}else{if(1===d.length){if(!e.getCurve().isPeriodic()){const t=new Set([...e.getStartVertex().getFaces(),...e.getEndVertex().getFaces()]);if(o.size>0&&!t.has(n)){d[0].setVtFlag=!0;continue}let r=!1;if(i){for(const e of o)if(this._concaveFilletEdge.has(e)){const t=e.getFaces();if(t[0]===n||t[1]===n){r=!0;break}}if(r)continue}else{let t,s;for(const n of o)e.getStartVertex()===n.getStartVertex()||e.getEndVertex()===n.getStartVertex()?(t=n.getStartVertex(),s=n):e.getStartVertex()!==n.getEndVertex()&&e.getEndVertex()!==n.getEndVertex()||(t=n.getEndVertex(),s=n);const i=t.getEdges();for(const t of i)if(t!==e&&this._allFilletEdges.has(t)&&!this._allConcaveEdge.has(t)){const e=s.getFaces();if(e[0]===n||e[1]===n){r=!0;break}}if(r)continue}}}else d.length>2&&this._filterFaceInvalidEdgeXVts(s,d,t,n);for(const e of d)if(!e.deleteFlag&&!t.find((t=>t===e))){t.push(e);const r=e.edge.getCoedge3ds();if(2!==r.length)throw new Error("fillet3d: 不支持的倒角，和倒角边相交的edge只有一条coedge！");const s=r[0].getFace()===n?r[1].getFace():r[0].getFace();l.find((e=>e===s))||this._eatFacesSet.has(s)||l.push(s),this._edgeOriginVtMap.set(e.edge,{startVertex:e.edge.getStartVertex(),endVertex:e.edge.getEndVertex()})}this._addFaceEdgeNewVtInfo(n,s,d)}}for(const e of a)this._eatEdgesSet.add(e);for(const e of a){const t=e.getFaces();for(const e of t){let t=!0;const n=e.getEdges();for(const e of n)if(!this._eatEdgesSet.has(e)){t=!1;break}t&&(this._eatFacesSet.add(e),this._faceEdgeNewVtInfoMap.delete(e))}}}for(const e of this._eatEdgesSet)for(let n=0;n<t.length;n++)t[n].edge===e&&(t.splice(n,1),n--);return t}_calcFilletSurfXWireEdges(e,t,n){const s=e.edge,i=e.surface,o=s.getCurve(),c=[];for(const l of t.getCoedge3ds()){const t=l.getEdge();if(t===s)continue;const d=n.find((e=>e.edge===t));if(d){c.push(d);continue}const u=t.getCurve().clone();if(r.MathAlg.CurveCurveColinear.curve3ds(u,o))continue;const h=new r.Tolerance(10*this._tol.lengthEps),g=r.MathAlg.CalculateIntersect.curveSurface(u,e.surface,h);let f;if(0===g.length)continue;if(g.length>1){f=g[0];let e=r.CONST.MAX_INTEGER;for(const t of g){const n=r.MathAlg.Distance.pointToCurve3d(t,o);r.MathUtil.isNearlySmaller(n,e)&&(e=n,f=t)}}else f=g[0];if(this._shouldAbandonTheNewXPt(f,l,s,i))continue;const p=new a.Vertex(f),_=t.getStartVertex(),m=t.getEndVertex(),v=r.MathAlg.Distance.pointToCurve3d(_.getPoint(),o),E=r.MathAlg.Distance.pointToCurve3d(m.getPoint(),o),P={fsInfo:e,edge:t,originVt:v<E?_:m,newVt:p};c.push(P),n.push(P)}return c}_dealWireEdgeXVts(e,t,n,r,s){const i=t.getFace();if(0===n.length&&r.length>0){return this._innerWireIsEat(e,i,t,r)}n.length>2&&this._filterWireInvalidEdgeXVts(e,t,n,r,s);for(const e of n){if(e.deleteFlag)continue;r.find((t=>t===e))||r.push(e)}return!1}_filterWireInvalidEdgeXVts(e,t,n,s,i){const o=e.edge,a=e.surface;if(o.getCurve().isPeriodic()&&o.getStartVertex()!==o.getEndVertex())for(let e=0;e<n.length;e++){const t=n[e];if(t.originVt===o.getStartVertex()||t.originVt===o.getEndVertex())continue;const a=r.MathAlg.CalculateDistance.pointToCurve3dInfo(t.newVt.getPoint(),o.getCurve()),c=o.getFaces(),l=c[0].getSurface().getNormAtPoint(a.foot);c[0].getSameDirWithSurface()&&l.reverse();const d=c[1].getSurface().getNormAtPoint(a.foot);c[1].getSameDirWithSurface()&&d.reverse();const u=l.angle(d)/2,h=Math.tan(u),g=this._radius*h;if(a.distance>g+.001){t.deleteFlag=!0,n.splice(e,1);const r=s.findIndex((e=>e.newVt===t.newVt));r>-1&&s.splice(r,1);const o=i.findIndex((e=>e.newVt===t.newVt));r>-1&&i.splice(o,1)}}if(n.length>2){const e=h.Fillet3dBase.getFillerSurfaceAxis(a);this._sortEdgeNewVts(n,e);const r=o.getCoedge3ds().find((e=>e.getWire()===t));let c,l;if(r)c=r.getPrevCoedge(),l=r.getNextCoedge();else for(const e of t.getCoedge3ds())e.getEndVertex()!==o.getStartVertex()&&e.getEndVertex()!==o.getEndVertex()||(c=e),e.getStartVertex()!==o.getStartVertex()&&e.getStartVertex()!==o.getEndVertex()||(l=e);if(c&&l){const e=this._getIntersectCoedge(c,!0,n),t=this._getIntersectCoedge(l,!0,n),r=n.findIndex((t=>t===e)),o=n.findIndex((e=>e===t));if(o<n.length-1&&o>-1){const e=n.length-1-o,t=n.splice(o+1,e);for(const e of t){e.deleteFlag=!0;const t=s.findIndex((t=>t===e));t>-1&&s.splice(t,1);const n=i.findIndex((t=>t===e));n>-1&&i.splice(n,1)}}if(r>0){const e=n.splice(0,r);for(const t of e){t.deleteFlag=!0;const e=s.findIndex((e=>e===t));e>-1&&s.splice(e,1);const n=i.findIndex((e=>e===t));n>-1&&i.splice(n,1)}}}}}_filterFaceInvalidEdgeXVts(e,t,n,s){const i=e.edge,o=e.surface,a=i.getStartVertex(),c=i.getEndVertex(),l=h.Fillet3dBase.getFillerSurfaceAxis(o),d=this._sortEdgeNewVts(t,l);if(i.getCoedge3ds().find((e=>e.getFace()===s))){const e=l.getParamAt(a.getPoint()),s=l.getParamAt(c.getPoint());if(l.isPeriodic())return void r.MathError.warn("");const i=new r.Interval(e,s);if(t.length%2==0)for(let e=0;e<t.length;e+=2){if(new r.Interval(d[e],d[e+1]).intersected(i,this._tol.lengthEps).length>0)continue;const s=t.splice(e,2);d.splice(e,2);for(const e of s){e.deleteFlag=!0;const t=n.findIndex((t=>t===e));t>-1&&n.splice(t,1)}e-=2}return}let u,g;const f=s.getCoedge3ds();for(const e of f)e.getEndVertex()!==a&&e.getEndVertex()!==c||(u=e),e.getStartVertex()!==a&&e.getStartVertex()!==c||(g=e);if(u&&g){const e=this._getIntersectCoedge(u,!0,t),r=this._getIntersectCoedge(g,!0,t);if(e&&r){const s=t.findIndex((t=>t===e)),i=t.findIndex((e=>e===r));if(i<t.length-1&&i>-1){const e=t.length-1-i,r=t.splice(i+1,e);for(const e of r){e.deleteFlag=!0;const t=n.findIndex((t=>t===e));t>-1&&n.splice(t,1)}}if(s>0){const e=t.splice(0,s);for(const t of e){t.deleteFlag=!0;const e=n.findIndex((e=>e===t));e>-1&&n.splice(e,1)}}}}}_findWireEatEdgesByFilletEdge(e,t,n,r){if(n.length<2)return;const s=e.getFace(),i=new Set;t.getStartVertex().getEdges().map((e=>i.add(e)));t.getEndVertex().getEdges().map((e=>i.add(e)));const o=e.getCoedge3ds().map((e=>e.getEdge())),a=o.filter((e=>i.has(e)));for(const e of a){if(e===t||r.has(e))continue;const i=this._concaveFaceEdges.get(s);if(i){if(i.find((n=>n.edge1===t&&n.edge2===e||n.edge2===t&&n.edge1===e)))continue}n.find((t=>t.edge===e))||r.add(e)}const c=new Set;for(const e of r){e.getStartVertex().getEdges().map((e=>c.add(e)));e.getEndVertex().getEdges().map((e=>c.add(e)))}const l=o.filter((e=>c.has(e)));for(const e of l){if(e===t||r.has(e))continue;if(!n.find((t=>t.edge===e))){r.add(e);const t=e.getStartVertex(),n=e.getEndVertex();for(const e of o)r.has(e)||e.getStartVertex()!==t&&e.getStartVertex()!==n&&e.getEndVertex()!==t&&e.getEndVertex()!==n||l.push(e)}}}_innerWireIsEat(e,t,n,s){const i=e.edge,o=e.surface,a=i.getCurve(),c=i.getCoedge3ds().find((e=>e.getFace()===t));if(c){if(c.getWire()!==t.getWires()[0])return!1;const e=s[0].newVt.getPoint();for(const t of n.getCoedge3ds()){const n=t.getStartVertex().getPoint(),s=a.getProjectedPtBy(n).sqDistanceTo(n),i=a.getProjectedPtBy(e).sqDistanceTo(e);if(r.MathUtil.isNearlyBigger(i,s,this._tol.edgeLengthEps2))return!0}return!1}for(const e of n.getCoedge3ds()){const t=e.getStartVertex().getPoint(),n=a.getProjectedPtBy(t),s=h.Fillet3dBase.getFillerSurfaceAxis(o).getProjectedPtBy(t),i=t.sqDistanceTo(s),c=s.subtracted(t),l=n.subtracted(t),d=c.angle(l);if(i>this._radius*this._radius&&d>r.CONST.PI_2)return!0}return!1}_mainFaceIsEat(e,t,n){if(e.getCurve().isLine3d())return!0;if(e.getStartVertex()===e.getEndVertex())return!1;const s=n.calcPolygon(),i=h.Fillet3dBase.getFillerSurfaceAxis(t),o=i.getRange(),a=[i.getStartPt(),i.getPtAt((o.getMid()+o.min)/2),i.getMidPt(),i.getPtAt((o.getMid()+o.max)/2),i.getEndPt()];for(const e of a){const t=n.getSurface().getUVAt(e);if(r.MathAlg.PositionJudge.ptToPolygon(t,s)===r.MathAlg.PtLoopPositonType.IN)return!1}return!0}_addFacesAdjacentEatFace(e,t){for(const n of e.getCoedge3ds()){this._eatEdgesSet.add(n.getEdge());const e=n.getTwin();if(!e)continue;const r=e.getFace();t.find((e=>e===r))||this._eatFacesSet.has(r)||t.push(r)}this._eatFacesSet.add(e),this._faceEdgeNewVtInfoMap.delete(e)}_calcFaceExtraXCurveAtConcaveFilletEdge(e,t){const n=e.getFaces(),s=[e.getStartVertex(),e.getEndVertex()];for(const i of s){const s=i.getFaces().filter((e=>e!==n[0]&&e!==n[1]));if(1!==s.length){if(2===s.length){const t=e.getCoedge3ds(),n=t[0].getStartVertex()===i?t[0].getPrevCoedge():t[0].getNextCoedge(),o=t[1].getStartVertex()===i?t[1].getPrevCoedge():t[1].getNextCoedge();let a;const c=i.getEdges();for(const t of c)if(t!==e&&t!==n.getEdge()&&t!==o.getEdge()){a=t;break}const l=s[0].getSurface(),d=s[1].getSurface(),u=r.MathAlg.CalculateOverlap.isSurfacesCoplaner(l,d),h=a.getCurve(),g=n.getEdge().getCurve(),f=o.getEdge().getCurve(),p=r.MathAlg.CurveCurveColinear.curve3ds(h,g),_=r.MathAlg.CurveCurveColinear.curve3ds(h,f);if(!u&&!p&&!_)throw new Error("fillet3d: 不支持的情况");let m;m=p?g.clone():f.clone();const v={faces:a.getFaces(),xCv:m,newVt1:i},E=this._newXCurveAtConcaveEdge.get(e);if(E){0===E.filter((e=>e.newVt1===i)).length&&E.push(v)}else this._newXCurveAtConcaveEdge.set(e,[v])}else if(s.length>2){const t=e.getCoedge3ds(),n=t[0].getStartVertex()===i?t[0].getPrevCoedge():t[0].getNextCoedge(),s=n.getTwin();if(!s)throw new Error;const o=s.getFace(),a=(t[1].getStartVertex()===i?t[1].getPrevCoedge():t[1].getNextCoedge()).getTwin();if(!a)throw new Error;const c=a.getFace();if(r.MathAlg.CalculateOverlap.isSurfacesCoplaner(o.getSurface(),c.getSurface())){const t=n.getEdge(),r=t.getCurve().clone();t.getStartVertex()===i?r.setRange(r.getDomain().min,r.getStartParam()):r.setRange(r.getEndParam(),r.getDomain().max);const s={faces:[o,c],xCv:r,newVt1:i},a=this._newXCurveAtConcaveEdge.get(e);if(a){0===a.filter((e=>e.newVt1===i)).length&&a.push(s)}else this._newXCurveAtConcaveEdge.set(e,[s])}else{const t=r.MathAlg.CalculateIntersect.surfacesNearPoint(o.getSurface(),c.getSurface(),i.getPoint());if(!t)throw new Error;const n={faces:[o,c],xCv:t,newVt1:i},s=this._newXCurveAtConcaveEdge.get(e);if(s){0===s.filter((e=>e.newVt1===i)).length&&s.push(n)}else this._newXCurveAtConcaveEdge.set(e,[n])}}}else{const n=[];for(const e of t)e.getStartVertex()!==i&&e.getEndVertex()!==i||n.push(e);if(1!==n.length||this._allFilletEdges.has(n[0]))n.length;else{const t=n[0],r=t.getCurve().clone();t.getStartVertex()===i?r.setRange(r.getDomain().min,r.getStartParam()):r.setRange(r.getEndParam(),r.getDomain().max);const s={faces:t.getFaces(),xCv:r,newVt1:i},o=this._newXCurveAtConcaveEdge.get(e);if(o){0===o.filter((e=>e.newVt1===i)).length&&o.push(s)}else this._newXCurveAtConcaveEdge.set(e,[s])}}}}_calcFaceExtraXCurveAtConcaveEdge(e,t){const n=e.getFaces(),s=[e.getStartVertex(),e.getEndVertex()];for(const i of s){const s=i.getEdges().filter((e=>t.has(e)));if(0===s.length)continue;if(2===s.length)continue;if(s.length>2)throw new Error("fillet3d: 不支持的情况，顶点关联的边太多");let o=!1;const a=i.getEdges();for(const t of a)t!==e&&t!==s[0]&&this._allFilletEdges.has(t)&&(o=!0);if(o)continue;const c=s[0].getFaces(),l=i.getFaces().filter((e=>e!==n[0]&&e!==n[1]));if(0===l.length)throw new Error("");let d,u;c[0]===n[0]||c[0]===n[1]?(d=c[0],u=c[1]):(d=c[1],u=c[0]);const h=n[0]===d?n[1]:n[0];if(1!==l.length){if(2===l.length){const t=r.MathAlg.CalculateIntersect.surfacesNearPoint(h.getSurface(),u.getSurface(),i.getPoint());if(!t)throw new Error;const n={faces:[h,u],xCv:t,newVt1:i},s=this._newXCurveAtConcaveEdge.get(e);if(s){0===s.filter((e=>e.newVt1===i)).length&&s.push(n)}else this._newXCurveAtConcaveEdge.set(e,[n])}}else{const t=i.getEdges();for(const n of t){const t=n.getFaces();if(t[0]===h&&t[1]===u||t[1]===h&&t[0]===u){const t=n.getCurve().clone();n.getStartVertex()===i?t.setRange(t.getDomain().min,t.getStartParam()):t.setRange(t.getEndParam(),t.getDomain().max);const r={faces:n.getFaces(),xCv:t,newVt1:i},s=this._newXCurveAtConcaveEdge.get(e);if(s){0===s.filter((e=>e.newVt1===i)).length&&s.push(r)}else this._newXCurveAtConcaveEdge.set(e,[r]);break}}}}}_shouldAbandonTheNewXPt(e,t,n,s){const i=n.getCurve(),o=t.getStartVertex().getPoint(),a=t.getEndVertex().getPoint();if(e.sqDistanceTo(o)<this._tol.edgeLengthEps2){const e=r.MathAlg.CalculateDistance.pointToCurve3d(a,i),n=t.getPrevCoedge().getStartVertex().getPoint();if(e>r.MathAlg.CalculateDistance.pointToCurve3d(n,i))return!0}else if(e.sqDistanceTo(a)<this._tol.edgeLengthEps2){const e=r.MathAlg.CalculateDistance.pointToCurve3d(o,i),n=t.getNextCoedge().getEndVertex().getPoint();if(e>r.MathAlg.CalculateDistance.pointToCurve3d(n,i))return!0}const c=h.Fillet3dBase.getFillerSurfaceAxis(s);if(c instanceof r.Arc3d&&c.getRadius()<this._tol.lengthEps)return!1;const l=c.getParamAt(e),d=c.getPtAt(l),u=i.getProjectedPtBy(d),g=n.getFaces(),f=g[0].getSurface().getProjectedPtBy(d),p=g[1].getSurface().getProjectedPtBy(d),_=f.subtracted(d).angle(p.subtracted(d)),m=f.subtracted(d).angle(u.subtracted(d)),v=_-m,E=Math.max(m,v);return e.subtracted(d).angle(u.subtracted(d))>E+.001}_updateOldFace(e,t,n){var r,s,i;const a=new Set,c=new Map;for(const t of this._faceEdgeNewVtInfoMap){const l=t[0],d=t[1],u=[],h=new Map,g=[],f=[];d.map((e=>f.push(...e.newVtInfos)));for(const e of d){const t=e.fsInfo,r=t.edge,s=e.newVtInfos;if(r.getStartVertex()===r.getEndVertex()){if(0===s.length){this._updatePeriodicFilletEdgeTopFace(l,t,n,c);continue}if(1===s.length){this._calcXCurveOfFaceWithPeriodicFilletSurface(l,s[0],h);continue}throw new Error("fillet：filletSurface与侧面求交失败!")}const i=this._newXCurveAtConcaveEdge.get(r);if(i){const e=i.filter((e=>e.faces[0]===l||e.faces[1]===l));if(e.length>=1){const n=this._calcXCurveAtConcaveEdgeSideFace(l,t,s,e,a,u,h);g.push(...n);continue}}this._calcXCurveOfFaceWithFilletSurface(l,t,s,f,u,h)}const p=[];for(const e of h)p.push(...e[1]);p.push(...u);const _=[];for(let e=0;e<p.length;e++){const t=p[e],n=t.filletSurfInfo.edge;for(let r=e+1;r<p.length;r++){const e=p[r],s=e.filletSurfInfo.edge;n.getStartVertex()===s.getStartVertex()||n.getStartVertex()===s.getEndVertex()||n.getEndVertex()===s.getStartVertex()||n.getEndVertex()===s.getEndVertex()?_.splice(0,0,[t,e]):_.push([t,e])}}for(const t of _)this._updateFaceXCurveVertex(l,t[0],t[1],n,e);const m=this._updateCoedgesAtFilletEdge(h,c,a);for(const e of u){const t=e.newXVt1||(null===(r=e.xVtInfo1)||void 0===r?void 0:r.newVt);e.newXVt1?this._shell.addVertex(e.newXVt1):e.xVtInfo1&&this._updateEdgeNewVt(e.xVtInfo1,a);const n=e.newXVt2||(null===(s=e.xVtInfo2)||void 0===s?void 0:s.newVt);if(e.newXVt2?this._shell.addVertex(e.newXVt2):e.xVtInfo2&&this._updateEdgeNewVt(e.xVtInfo2,a),!t||!n)throw new Error("");const i=new o.Edge(e.xCv,t,n);this._shell.addEdge(i),t.addEdge(i),n.addEdge(i),g.push(i),this._addEdgeToFENewEdgesMap(i,e.filletSurfInfo.edge,c)}let v=!0;for(const e of l.getWires())for(const t of e.getCoedge3ds())if(t.getEndVertex()!==(null===(i=t.getNextCoedge())||void 0===i?void 0:i.getStartVertex())){v=!1;break}v||this._updateFaceWires(l,m,g,c)}return c}_calcXCurveOfFaceWithPeriodicFilletSurface(e,t,n){const r=t.fsInfo,s=r.edge;let i;const o=this._edgePerpendicularFaces.get(s);if(!o||o[0]!==e&&o[1]!==e)i=this._calcIntersectCurveForFillet(e,r,!0,t.newVt,t.newVt);else{const t=h.Fillet3dBase.getFillerSurfaceAxis(r.surface);i=h.Fillet3dBase.calcIntersectCurveForEdgePerpendicularFaces(r,t,e,o,this._radius)}const a=s.getCoedge3ds().find((t=>t.getFace()===e));if(!a)throw new Error("");{this._adjustXCurveSameDirWithOriginCoedge(i,a,t.newVt.getPoint());const e=i.getParamAt(t.newVt.getPoint()),s=e+i.getRange().period;i.setRange(e,s);const o={ce:a,xCv:i,xVtInfo1:t,xVtInfo2:t,filletSurfInfo:r};n.set(a,[o])}}_calcXCurveOfFaceWithFilletSurface(e,t,n,r,s,i){const o=t.edge;if(0===n.length){const n=o.getCoedge3ds().find((t=>t.getFace()===e));if(n){const r=this._calcFilletSurfXTopFace(e,n,t);this._adjustXCurveSameDirWithOriginCoedge(r,n,n.getEndVertex().getPoint());const s={ce:n,xCv:r,filletSurfInfo:t};return void i.set(n,[s])}throw new Error("倒角: 不支持的情况")}if(1===n.length)return;if(2===n.length){const a=n[0],c=n[1],l=o.getCoedge3ds().find((t=>t.getFace()===e));if(l){const n=this._calcIntersectCurveForFillet(e,t,!0,a.newVt,c.newVt);this._adjustXCurveSameDirWithOriginCoedge(n,l,a.newVt.getPoint());const r={ce:l,xCv:n,xVtInfo1:a,xVtInfo2:c,filletSurfInfo:t};return h.Fillet3dBase.setRangeForXCurve(t.edge,n,a.newVt.getPoint(),c.newVt.getPoint(),!0)&&this._swapXCurveVtInfos(r),void i.set(l,[r])}if(this._needToCalcFilletSurfaceXFace(a,c,r)){const n=this._calcIntersectCurveForFillet(e,t,!1,a.newVt,c.newVt);let r;a.originVt===c.originVt&&(r=a.originVt.getPoint());const i={xCv:n,xVtInfo1:a,xVtInfo2:c,filletSurfInfo:t};h.Fillet3dBase.setRangeForXCurve(t.edge,n,a.newVt.getPoint(),c.newVt.getPoint(),!1,r)&&this._swapXCurveVtInfos(i),s.push(i)}return}if(n.length%2==1)throw new Error("fillet3d: 同一face交点个数为奇数");const a=n[0],c=n[1],l=o.getCoedge3ds().find((t=>t.getFace()===e));if(!l)throw new Error("fillet3d: fillet edge与侧面face 有多个交点");{const r=this._calcFilletSurfaceXFace(t,e,a,c);if(!r)throw new Error("fillet3d: 同一face交点个数为奇数");this._adjustXCurveSameDirWithOriginCoedge(r,l,a.newVt.getPoint()),this._sortEdgeNewVts(n,r);const s=[];for(let e=0;e<n.length;e+=2){const i=r.clone(),o={ce:l,xCv:i,xVtInfo1:n[e],xVtInfo2:n[e+1],filletSurfInfo:t};h.Fillet3dBase.setRangeForXCurve(t.edge,i,n[e].newVt.getPoint(),n[e+1].newVt.getPoint(),!0)&&this._swapXCurveVtInfos(o),s.push(o)}i.set(l,s)}}_calcXCurveAtConcaveEdgeSideFace(e,t,n,s,i,o,a){var c,l;const d=[];if(1===n.length&&1===s.length){const e=n[0],t=s[0],o=t.xCv;if(e&&r.MathAlg.CurveCurveColinear.curve3ds(o,e.edge.getCurve())){if(t.newEdge)return d.push(t.newEdge),d;t.newVt2=e.newVt,i.has(e)||(this._shell.addVertex(e.newVt),this._setEdgeNewVt(e.edge,e.originVt,e.newVt),i.add(e));const[n,r]=[t.newVt1,e.newVt],s=this._createNewEdge(o,n,r,n.getPoint());return t.newEdge=s,d.push(s),d}}if(s.length>2)throw new Error("fillet3d: 算法可能存在错误");const u=e.getSurface(),g=n[0].fsInfo,f=g.edge,p=g.surface,_=n[0].newVt.getPoint();let m;m=n.length>1?n[1].newVt.getPoint().subtracted(_):void 0;const v=r.MathAlg.CalculateIntersect.surfacesNearPoint(u,p,_,m,this._tol,!0);if(!v)throw new Error("fillet：filletSurface与侧面求交失败!");if(0===n.length)throw new Error("fillet3d: 暂不支持的情况");if(n.length>2)throw new Error("fillet3d: 暂不支持的情况");let E;const P=f.getCoedge3ds().find((t=>t.getFace()===e));if(P){if(1===n.length)throw new Error("fillet3d: 暂不支持的情况");this._adjustXCurveSameDirWithOriginCoedge(v,P,P.getStartVertex().getPoint()),E={ce:P,xCv:v,xVtInfo1:n[0],xVtInfo2:n[1],filletSurfInfo:t},n[0].setVtFlag||(E.newXVt1=n[0].newVt),n[1].setVtFlag||(E.newXVt2=n[1].newVt);h.Fillet3dBase.setRangeForXCurve(t.edge,v,n[0].newVt.getPoint(),n[1].newVt.getPoint(),!0)&&this._swapXCurveVtInfos(E),a.set(P,[E])}else 1===n.length?(E={xCv:v,xVtInfo1:n[0],filletSurfInfo:t},n[0].setVtFlag||(E.newXVt1=n[0].newVt)):(E={xCv:v,xVtInfo1:n[0],xVtInfo2:n[1],filletSurfInfo:t},n[0].setVtFlag||(E.newXVt1=n[0].newVt),n[1].setVtFlag||(E.newXVt2=n[1].newVt)),o.push(E);const y=(e,t)=>{if(P)if(e.ce.getStartVertex()===t.newVt1)e.newXVt1=t.newVt2;else{if(e.ce.getEndVertex()!==t.newVt1)throw new Error;e.newXVt2=t.newVt2}else if(e.newXVt1){if(e.newXVt2)throw new Error("fillet3d");e.newXVt2=t.newVt2}else e.newXVt1=t.newVt2};for(const t of s){if(t.newVt2&&t.newEdge){d.push(t.newEdge),y(E,t);continue}const n=this._calcXVtForXCurveIntersectFaceAddCurve(e,f,v,t,i);t.newVt2=n,y(E,t);const[r,s]=[t.newVt1,t.newVt2],o=this._createNewEdge(t.xCv,r,s,r.getPoint());t.newEdge=o,d.push(o)}const C=E.newXVt1||(null===(c=E.xVtInfo1)||void 0===c?void 0:c.newVt),S=E.newXVt2||(null===(l=E.xVtInfo2)||void 0===l?void 0:l.newVt);if(E.xVtInfo1&&this._updateEdgeNewVt(E.xVtInfo1,i),E.xVtInfo2&&this._updateEdgeNewVt(E.xVtInfo2,i),!C||!S)return d;let T;const b=void 0!==P;if(!b){const n=t.edge.getStartVertex(),r=t.edge.getEndVertex();n.getFaces().find((t=>t===e))?T=n.getPoint():r.getFaces().find((t=>t===e))&&(T=r.getPoint())}return h.Fillet3dBase.setRangeForXCurve(t.edge,v,C.getPoint(),S.getPoint(),b,T)&&this._swapXCurveVtInfos(E),d}_calcXVtForXCurveIntersectFaceAddCurve(e,t,n,s,i){const o=s.faces[0]===e?s.faces[1]:s.faces[0],c=this._faceEdgeNewVtInfoMap.get(o).find((e=>e.fsInfo.edge===t));if(!c)throw new Error("fillet：concave edge filletSurface失败!");for(const e of c.newVtInfos)if(!0!==e.setVtFlag&&r.MathAlg.CurveCurveColinear.curve3ds(s.xCv,e.edge.getCurve()))return s.newVt2=e.newVt,e.setVtFlag||i.has(e)||(this._shell.addVertex(e.newVt),this._setEdgeNewVt(e.edge,e.originVt,e.newVt),i.add(e)),e.newVt;let l;const d=r.MathAlg.CalculateIntersect.curve3ds(n,s.xCv);if(0===d.length)throw new Error("fillet：求交失败!");if(1===d.length)l=d[0];else{let e=d[0],t=d[0].point.sqDistanceTo(s.newVt1.getPoint());for(let n=1;n<d.length;n++){const r=d[n].point.sqDistanceTo(s.newVt1.getPoint());r<t&&(e=d[n],t=r)}l=e}const u=new a.Vertex(l.point);return this._shell.addVertex(u),u}_updateCoedgesAtFilletEdge(e,t,n){var r,s,i,a;let c;for(const l of e){const e=l[0],u=l[1];if(1===u.length){const i=u[0],a=i.newXVt1||(null===(r=i.xVtInfo1)||void 0===r?void 0:r.newVt);i.newXVt1?this._shell.addVertex(i.newXVt1):i.xVtInfo1&&this._updateEdgeNewVt(i.xVtInfo1,n);const l=i.newXVt2||(null===(s=i.xVtInfo2)||void 0===s?void 0:s.newVt);if(i.newXVt2?this._shell.addVertex(i.newXVt2):i.xVtInfo2&&this._updateEdgeNewVt(i.xVtInfo2,n),!a||!l)throw new Error("");const d=new o.Edge(i.xCv,a,l);this._shell.addEdge(d),a.addEdge(d),l.addEdge(d),e.setEdge(d),e.setSameDirWithEdge(!0),c=c||e,this._addEdgeToFENewEdgesMap(d,i.filletSurfInfo.edge,t);continue}const h=e.getWire(),g=e.getIndexInWire();h.deleteCoedge3dAt(g);for(let r=0;r<u.length;r++){const s=u[r],l=s.newXVt1||(null===(i=s.xVtInfo1)||void 0===i?void 0:i.newVt);s.newXVt1?this._shell.addVertex(s.newXVt1):s.xVtInfo1&&this._updateEdgeNewVt(s.xVtInfo1,n);const f=s.newXVt2||(null===(a=s.xVtInfo2)||void 0===a?void 0:a.newVt);if(s.newXVt2?this._shell.addVertex(s.newXVt2):s.xVtInfo2&&this._updateEdgeNewVt(s.xVtInfo2,n),!l||!f)throw new Error("");const p=new o.Edge(s.xCv,l,f);if(this._shell.addEdge(p),l.addEdge(p),f.addEdge(p),0===r)e.setEdge(p),e.setSameDirWithEdge(!0),c=c||e;else{const e=new d.Coedge3d(p,!0);h.insertCoedge3d(g+r,e)}this._addEdgeToFENewEdgesMap(p,s.filletSurfInfo.edge,t)}}return c}_sortEdgeNewVts(e,t){t.isPeriodic()&&r.MathError.warn("fillet3d: xcurve是周期性曲线，小心反求参数位置错误");const n=[];for(const r of e){const e=t.getParamAt(r.newVt.getPoint());n.push({newXVt:r,param:e})}n.sort(((e,t)=>e.param-t.param));const s=n.map((e=>e.newXVt));return e.splice(0,e.length,...s),n.map((e=>e.param))}_isEdgeMaxDistVt(e,t){const n=e.edge;if(this._allFilletEdges.has(n))return 0;const r=e.originVt,s=t.filter((e=>e.edge===n&&e.originVt===r));if(1===s.length)return 1;const i=e.fsInfo.edge,o=e.newVt.getPoint().sqDistanceTo(r.getPoint());for(const e of s){if(e.fsInfo.edge===i)continue;if(o-e.newVt.getPoint().sqDistanceTo(r.getPoint())<=this._tol.edgeLengthEps2)return-1}return 2}_needToCalcFilletSurfaceXFace(e,t,n){const r=this._isEdgeMaxDistVt(e,n),s=this._isEdgeMaxDistVt(t,n);return r>0||s>0}_adjustXCurveSameDirWithOriginCoedge(e,t,n){const r=e.getParamAt(n),s=e.getTangentAt(r),i=t.getEdge().getCurve(),o=i.getParamAt(n),a=i.getTangentAt(o);t.getSameDirWithEdge()||a.reverse(),a.dot(s)<0&&e.reverse()}_updateFaceXCurveVertex(e,t,n,s,i){const o=t.filletSurfInfo.edge,c=n.filletSurfInfo.edge;if(o===c)return;if(t.ce&&n.ce){if(t.ce.getWire()!==n.ce.getWire())return}if(r.MathAlg.CurveCurveColinear.curve3ds(o.getCurve(),c.getCurve(),this._tol))return;const l=this._findTwoFilletEdgesConnectEdge(o,c);let d;if(l&&(d=i.get(l),d&&!d.isSphere()))return;const u=r.MathAlg.CalculateIntersect.curve3ds(t.xCv,n.xCv);if(0===u.length)return;let g;if(1===u.length)g=u[0];else{const e=this._findTwoFilletEdgesCommonVt(o,c);if(!e)throw new Error("");let t=u[0],n=u[0].point.sqDistanceTo(e.getPoint());for(let r=1;r<u.length;r++){const s=u[r].point.sqDistanceTo(e.getPoint());s<n&&(n=s,t=u[r])}g=t}if(!this._isValidXPt(g.point,t,n))return;const f=new a.Vertex(g.point);if(d&&d.isSphere()){const e={edge:l,surface:d};this._gatherFilletSurfacesXVtInfos(t.filletSurfInfo,e,f,s),this._gatherFilletSurfacesXVtInfos(e,n.filletSurfInfo,f,s)}else this._gatherFilletSurfacesXVtInfos(t.filletSurfInfo,n.filletSurfInfo,f,s);let p,_,m;const v=this._findTwoFilletEdgesCommonVt(o,c);if(v)p=v.getPoint(),_=o.getStartVertex()===v?o.getEndVertex():o.getStartVertex(),m=c.getStartVertex()===v?c.getEndVertex():c.getStartVertex();else{const e=o.getCurve().clone().setRange(o.getCurve().getDomain()),t=c.getCurve().clone().setRange(c.getCurve().getDomain()),n=r.MathAlg.CalculateIntersect.curve3ds(e,t);if(1!==n.length)throw new Error("");p=n[0].point}let E=!1;for(const e of this._concaveFaceEdges){if(e[1].find((e=>e.edge1===o&&e.edge2===c||e.edge1===c&&e.edge2===o))){E=!0;break}}const P=(t,n,s)=>{if(t.xVtInfo1||t.xVtInfo2){if(!t.xVtInfo1)throw new Error;if(!t.xVtInfo2)throw new Error;if(t.ce){if(t.ce.getWire()!==e.getWires()[0]){if(t.ce.getStartVertex().getPoint().sqDistanceTo(f.getPoint())<t.ce.getEndVertex().getPoint().sqDistanceTo(f.getPoint())){const e=t.newXVt1||t.xVtInfo1.newVt;this._setXCurveRange1(t,e,f),t.newXVt1=f}else{const e=t.newXVt2||t.xVtInfo2.newVt;this._setXCurveRange1(t,e,f),t.newXVt2=f}return}}if(E){if(t.xVtInfo1.newVt.getPoint().sqDistanceTo(s.getPoint())>t.xVtInfo2.newVt.getPoint().sqDistanceTo(s.getPoint())){const e=t.newXVt1||t.xVtInfo1.newVt;this._setXCurveRange1(t,e,f),t.newXVt1=f}else{const e=t.newXVt2||t.xVtInfo2.newVt;this._setXCurveRange1(t,e,f),t.newXVt2=f}}else if(t.xVtInfo1.edge===n){const e=t.newXVt1||t.xVtInfo1.newVt;this._setXCurveRange1(t,e,f),t.newXVt1=f}else if(t.xVtInfo2.edge===n){const e=t.newXVt2||t.xVtInfo2.newVt;this._setXCurveRange1(t,e,f),t.newXVt2=f}else if(t.ce){const e=t.xVtInfo1.newVt.getPoint().sqDistanceTo(p),n=t.xVtInfo2.newVt.getPoint().sqDistanceTo(p);if(e<n-this._tol.edgeLengthEps2){const e=t.newXVt1||t.xVtInfo1.newVt;this._setXCurveRange1(t,e,f),t.newXVt1=f}else if(n<e-this._tol.edgeLengthEps2){const e=t.newXVt2||t.xVtInfo2.newVt;this._setXCurveRange1(t,e,f),t.newXVt2=f}}else{const e=n.getCurve();e.setRangeInfinit();const s=t.xVtInfo1.newVt.getPoint(),i=r.MathAlg.CalculateDistance.pointToCurve3d(s,e),o=t.xVtInfo2.newVt.getPoint();if(i<r.MathAlg.CalculateDistance.pointToCurve3d(o,e)){const e=t.newXVt1||t.xVtInfo1.newVt;this._setXCurveRange1(t,e,f),t.newXVt1=f}else{const e=t.newXVt2||t.xVtInfo2.newVt;this._setXCurveRange1(t,e,f),t.newXVt2=f}}}else if(t.newXVt1){if(h.Fillet3dBase.setRangeForXCurve(t.filletSurfInfo.edge,t.xCv,t.newXVt1.getPoint(),f.getPoint(),!0)){const e=t.newXVt1;t.newXVt1=f,t.newXVt2=e}else t.newXVt2=f}else t.newXVt1=f};P(t,c,_),P(n,o,m)}_updateFaceWires(e,t,n,s){let i=t;const o=e.getCoedge3ds();if(!i){for(let e=0;e<n.length;e++){const t=n[e],r=t.getStartVertex(),s=t.getEndVertex();for(const a of o){if(a.getStartVertex()===r||a.getEndVertex()===s){i=new d.Coedge3d(t,!1),n.splice(e,1);break}if(a.getEndVertex()===r||a.getStartVertex()===s){i=new d.Coedge3d(t,!0),n.splice(e,1);break}}if(i)break}if(!i)throw new Error("")}const a=new Set,c=[];c.push(i);const u=i.getStartVertex();let h=i;const g=i.getParent();g&&a.add(g);let f=i.getEndVertex();for(;u!==f;){const e=h.getNextCoedge();if(e&&e.getStartVertex()===f)h=e;else{const e=n.findIndex((e=>e.getStartVertex()===f||e.getEndVertex()===f));if(e>-1){const t=n[e],r=t.getStartVertex()===f;h=new d.Coedge3d(t,r),n.splice(e,1)}else{const e=o.find((e=>e.getStartVertex()===f));if(!e)throw new Error("");h=e,a.add(e.getParent())}}f=h.getEndVertex(),c.push(h)}for(const e of a)for(const t of e.getCoedge3ds())c.find((e=>e===t))||this._eatEdgesSet.add(t.getEdge());if(n.length>0){r.MathError.warn("");for(const e of n){for(const t of s){const n=t[1],r=n.findIndex((t=>t===e));r>-1&&n.splice(r,1)}e.dispose(),this._shell.deleteEdge(e)}}const p=new l.Wire;c.map((e=>p.addCoedge3d(e)));let _=!1;for(const t of a)t.isFaceOutWire()&&(_=!0),e.deleteWire(t);e.insertWire(_?0:1,p)}_addNewEdgeToConcaveFace(e,t,n,r){let s;const i=r[0].getCoedge3ds();if(1===i.length)s=i[0];else{if(!(i.length>1))throw new Error("");s=i[0].getFace()===e?i[0]:i[1]}let o;const a=r[1].getCoedge3ds();if(1===a.length)o=a[0];else{if(!(a.length>1))throw new Error("");o=a[0].getFace()===e?a[0]:a[1]}const c=s.getNextCoedge()===o?s:o,l=s.getWire(),u=c.getIndexInWire(),h=c.getEndVertex()===t.getStartVertex(),g=new d.Coedge3d(t,h);l.insertCoedge3d(u+1,g),this._shell.deleteVertex(n)}_calcFilletSurfaceIntersectEdges(e,t,n,s){for(const i of t){const t=i[0],a=i[1];for(const i of a.sphereInfos){const o=i.vtSurf;if(o.isSphere())for(const r of i.edgeSurfs)this._createEdgeSphereXFilletSurface(t,o,r,e,n,s);else{const a=this._complexVtEdgesMap.get(t);if(3===t.getEdges().length&&a.concaveEdges.length>0&&a.convexEdges.length>0){let c,l,d;1===a.concaveEdges.length&&2===a.convexEdges.length?(c=a.concaveEdges[0],l=a.convexEdges):(c=a.convexEdges[0],l=a.concaveEdges);const u=[];for(const e of i.edgeSurfs)if(e.edge===c)d=e;else{if(e.edge!==l[0]&&e.edge!==l[1])throw new Error("fillet3d: 不支持的情况");u.push(e)}this._createEdgeSphereXFilletSurface(t,o,d,e,n,s);const h=e.find((e=>e.commonVt===t&&e.fsInfo1.edge!==d.edge&&e.fsInfo2.edge!==d.edge));if(!h||!h.vt1)throw new Error("_calcCommonVtNewCurves：球与两个fillet surface的交点找不全");const g=h.vt1.getEdges();if(2!==g.length)throw new Error("");const f=g[0].getFaces(),p=g[1].getFaces(),_=f[0]===p[0]||f[0]===p[1]?f[0]:f[1],m=[];for(const r of u){const i=d.edge,a=e.find((e=>e.commonVt===t&&(e.fsInfo1.edge===i&&e.fsInfo2.edge===r.edge||e.fsInfo1.edge===r.edge&&e.fsInfo2.edge===i)));if(!a||!a.vt1)throw new Error("_calcCommonVtNewCurves：球与两个fillet surface的交点找不全");const c=n.get(r.edge);if(!c)throw new Error;const l=c.find((e=>e===g[0]||e===g[1]));if(!l)throw new Error;const u=this._createEdgeForVtSurfaceXFilletSurface(t,o,r,a,h,l,n,s);m.push(u)}if(2!==m.length)throw new Error("fillet3d: 不支持的情况");const v=m[0].getPoint(),E=h.vt1.getPoint().subtracted(v),P=r.MathAlg.CalculateIntersect.surfacesNearPoint(_.getSurface(),o,v,E,this._tol,!0);if(!P)throw new Error("fillet：filletSurface与侧面求交失败!");const y=h.vt1.getPoint(),C=this._createNewEdge(P,m[0],m[1],y);this._addNewEdgeToConcaveFace(_,C,h.vt1,g),this._addEdgeToCommonVtNewEdgesMap(C,t,c,s)}}}if(a.transitedSurf){const n=a.transitedSurf;for(const i of a.sphereInfos){const a=i.vtSurf,c=i.edgeSurfs;if(2!==c.length)throw new Error("暂不支持的情况！");const l=e.filter((e=>e.commonVt===t&&(e.fsInfo1.edge===c[0].edge||e.fsInfo2.edge===c[0].edge))),d=l[0].vt1,u=l[1].vt1,h=e.filter((e=>e.commonVt===t&&(e.fsInfo1.edge===c[1].edge||e.fsInfo2.edge===c[1].edge))),g=h[0].vt1,f=h[1].vt1;let p,_;if(d===g)p=u,_=f;else if(d===f)p=u,_=g;else if(u===g)p=d,_=f;else{if(u!==f)throw new Error("unexpected case");p=d,_=g}const m=p.getPoint(),v=_.getPoint().subtracted(m),E=r.MathAlg.CalculateIntersect.surfacesNearPoint(a,n,m,v,this._tol,!0);if(!E)throw new Error("");const P=this._createNewEdge(E,p,_,t.getPoint()),y=new o.Edge;this._addEdgeToCommonVtNewEdgesMap(P,t,y,s)}}}for(const r of e)r.commonVt&&t.get(r.commonVt)||this._createEdgeFilletSurfacesX(r,n,r.commonVt)}_createEdgeFilletSurfacesX(e,t,n){if(!e.vt1||!e.vt2)throw new Error("");if(e.fsInfo1.edge===e.fsInfo2.edge){const s=e.vt1,i=e.vt2,o=e.fsInfo1.surface,a=o.getPath();let c;if(a.isExtendCurve3d()){const l=o.getUVAt(s.getPoint()),d=o.getUVAt(i.getPoint());if(c=(l.y+d.y)/2,Math.abs(l.y-d.y)>this._tol.numberEps){const u=o.getPtAt({x:l.x,y:c}),h=o.getPtAt({x:d.x,y:c});if(!u.equals(s.getPoint(),this._tol.edgeLengthEps)||!h.equals(i.getPoint(),this._tol.edgeLengthEps)){const c=a.getBaseCurve().getRange(),d=new r.Vector2(l.x,c.min),u=new r.Vector2(l.x,c.max),h=i.getPoint().subtracted(s.getPoint()),g=r.MathAlg.CalculateIntersect.surfacesNearParams(o,o,d,u,h,this._tol,!0);if(!g)throw new Error("");let f;if(n)f=n.getPoint();else{f=e.fsInfo1.edge.getCurve().getProjectedPtBy(s.getPoint())}const p=this._createNewEdge(g,s,i,f);return void this._addEdgeToFENewEdgesMap(p,e.fsInfo1.edge,t)}}}else c=a.getParamAt(s.getPoint());const l=o.getIsoCurve(c,!0);let d;if(n)d=n.getPoint();else{d=e.fsInfo1.edge.getCurve().getProjectedPtBy(s.getPoint())}const u=this._createNewEdge(l,s,i,d);return void this._addEdgeToFENewEdgesMap(u,e.fsInfo1.edge,t)}const s=e.fsInfo1.surface,i=e.fsInfo2.surface,o=e.vt1,a=e.vt2,c=o.getPoint(),l=(n||a).getPoint().subtracted(c),d=r.MathAlg.CalculateIntersect.surfacesNearPoint(s,i,c,l,this._tol,!0);if(!d)throw new Error("");let u;if(n)u=n.getPoint();else{const t=e.fsInfo1.edge,n=e.fsInfo2.edge,s=[t.getStartVertex().getPoint(),t.getEndVertex().getPoint()],i=[n.getStartVertex().getPoint(),n.getEndVertex().getPoint()];let o=0,a=0,c=r.CONST.MAX_INTEGER;for(let e=0;e<s.length;e++)for(let t=0;t<i.length;t++){const n=s[e].sqDistanceTo(i[t]);n<c-this._tol.lengthEps2&&(o=e,a=t,c=n)}u=s[o].midTo(i[a])}const h=this._createNewEdge(d,o,a,u);this._addEdgeToFENewEdgesMap(h,e.fsInfo1.edge,t),this._addEdgeToFENewEdgesMap(h,e.fsInfo2.edge,t)}_createEdgeSphereXFilletSurface(e,t,n,s,i,o){const a=n.edge,c=n.surface,l=s.filter((t=>t.commonVt===e&&(t.fsInfo1.edge===a||t.fsInfo2.edge===a)));if(!l||l.length<2||!l[0].vt1||!l[1].vt1)throw new Error("_calcCommonVtNewCurves：球与两个fillet surface的交点找不全");const d=l[0].vt1,u=l[1].vt1,h=d.getPoint(),g=u.getPoint().subtracted(h),f=r.MathAlg.CalculateIntersect.surfacesNearPoint(t,c,h,g,this._tol,!0);f||r.MathError.assert("fillet3d: Sphere与FilletSurface求交失败！");const p=n.edge.getCurve().clone();p.setRange(p.getDomain());const _=d.getPoint().midTo(u.getPoint()),m=p.getProjectedPtBy(_),v=this._createNewEdge(f,d,u,m);this._addEdgeToFENewEdgesMap(v,a,i),this._addEdgeToCommonVtNewEdgesMap(v,e,a,o)}_createEdgeForVtSurfaceXFilletSurface(e,t,n,s,i,o,c,l){const d=n.edge,u=s.vt1,h=i.vt1,g=u.getPoint(),f=n.surface,p=r.MathAlg.CalculateIntersect.surfacesNearPoint(t,f,g,void 0,this._tol,!0);if(!p)throw new Error("fillet3d: Sphere与FilletSurface求交失败！");const _=r.MathAlg.CalculateIntersect.curve3ds(o.getCurve(),p,this._tol);if(1!==_.length)throw new Error;const m=_[0].point,v=new a.Vertex(m);this._shell.addVertex(v);((e,t,n)=>{const r=e.getCurve();let s=r.getParamAt(n.getPoint());if(e.getStartVertex()===t){if(s>r.getEndParam()){if(!r.isPeriodic())throw new Error("fillet: edge的curve非周期性且反求参数错误！");s-=r.getRange().period}r.getRange().min=s,e.setStartVertex(n)}else{if(s<r.getStartParam()){if(!r.isPeriodic())throw new Error("fillet: edge的curve非周期性且反求参数错误！");s+=r.getRange().period}r.getRange().max=s,e.setEndVertex(n)}})(o,h,v);const E=n.edge.getCurve().clone();E.setRange(E.getDomain());const P=u.getPoint().midTo(h.getPoint()),y=E.getProjectedPtBy(P),C=this._createNewEdge(p,u,v,y);return this._addEdgeToFENewEdgesMap(C,d,c),this._addEdgeToCommonVtNewEdgesMap(C,e,d,l),v}_getNextEdge(e,t,n){for(const r of n)if(r!==e){if(r.getStartVertex()===t)return{e:r,sameDir:!0};if(r.getEndVertex()===t)return{e:r,sameDir:!1}}throw new Error("fillet3d: 搜环失败，没找到相连的edge")}_createWireFromEdges(e,t){const n=new Set,s=t=>{const s=new l.Wire,i=[];let o,a,c;for(const e of t){if(n.has(e))continue;const t=e.getCoedge3ds();if(!(t.length<=0)){c=e,t[0].getSameDirWithEdge()?(i.push({e:e,sameDir:!1}),o=e.getEndVertex(),a=e.getStartVertex()):(i.push({e:e,sameDir:!0}),o=e.getStartVertex(),a=e.getEndVertex());break}}c&&o&&a||(r.MathError.warn("fillet3d: 没有找到一条已有coedge的edge"),c=t[0],i.push({e:t[0],sameDir:!0}),o=c.getStartVertex(),a=c.getEndVertex()),n.add(c);let u=0,h=c;for(;a!==o||h===c;){const r=this._getNextEdge(h,a,t);if(n.add(r.e),r.e.getStartVertex()===r.e.getEndVertex()){const t=r.e.getCoedge3ds();if(t.length<1)throw new Error("fillet3d: 失败");const n=t[0].getSameDirWithEdge(),s=this._edgeSameDirFacePairs.has(e);r.sameDir=s?n:!n}if(i.push(r),h=r.e,a=r.sameDir?r.e.getEndVertex():r.e.getStartVertex(),u++>100)throw new Error("fillet3d: 死循环，edges可能不封闭")}for(const e of i){const t=new d.Coedge3d(e.e,e.sameDir);s.addCoedge3d(t)}return s};let i=0;const o=[];for(;t.length>n.size;){const e=s(t);if(o.push(e),i++>100)break}return o}_createFaceOnFilletSurfaces(e,t){const n=[];for(const s of t){const t=s[0],i=s[1],o=e.get(t);r.MathError.assert(o,"fillet3d: 没找到fillet edge对应的edges");const a=!this._concaveFilletEdge.has(t),l=this._createWireFromEdges(t,o);if(l.length<=1){const e=new c.Face(i,a,l);l[0].calcLoop().calcArea()>-this._tol.lengthEps||l[0].reverse(),this._shell.addFace(e),n.push(e);continue}const d=[];for(let e=0;e<l.length;e++){const e=new Array(l.length);e.fill(!1),d.push(e)}const u=[];for(let e=0;e<l.length;e++){const t=l[e].getCoedge3ds().map((e=>e.getCurve())),n=i.wireToUV(t),s=new r.Loop(n.loop),o=s.calcArea()>0;u.push(o),d[e][e]=!0;for(let t=e+1;t<l.length;t++){const n=l[t].getCoedge3ds().map((e=>e.getCurve())),o=i.wireToUV(n),a=new r.Loop(o.loop),c=r.MathAlg.PositionJudge.loopToLoop(s,a);d[e][t]=c===r.MathAlg.LoopLoopPositonType.CONTAIN}}let h=0;for(let e=0;e<d.length;e++){let t=!0;const n=d[e];for(const e of n)if(!1===e){t=!1;break}if(t){h=e;break}}0!==h&&([l[0],l[h]]=[l[h],l[0]],[u[0],u[h]]=[u[h],u[0]]);for(let e=0;e<l.length;e++)0!==e?u[e]&&l[e].reverse():u[e]||l[e].reverse();const g=new c.Face(i,a,l);this._shell.addFace(g),n.push(g)}return n}_createFaceAtCommonVts(e,t){const n=[];for(const s of t){const t=s[0],i=e.get(t),a=s[1].sphereInfos;for(const e of a){const s=e.vtSurf,a=new l.Wire,u=new c.Face(s,!0,[a]);this._shell.addFace(u);const h=[],g=[];i.map((e=>g.push(e.newEg)));let f=g[0],p=f.getStartVertex(),_=f.getEndVertex();const m=f.getCoedge3ds();if(m.length>0){const e=m[0].getSameDirWithEdge();e?(_=f.getStartVertex(),p=f.getEndVertex()):(p=f.getStartVertex(),_=f.getEndVertex()),h.push({e:f,sameDir:!e})}else r.MathError.warn("fillet3d: edge缺少一条coedge!"),p=f.getStartVertex(),_=f.getEndVertex(),h.push({e:f,sameDir:!0});for(;_!==p;){const e=this._getNextEdge(f,_,g);h.push(e),f=e.e,_=e.sameDir?e.e.getEndVertex():e.e.getStartVertex()}const v=h[0],E=v.e.getCoedge3ds();if(1!==E.length)throw new Error("拓扑可能有误！");if(E[0].getSameDirWithEdge()===v.sameDir){h.reverse();for(const e of h)e.sameDir=!e.sameDir}for(const e of h){const t=new d.Coedge3d(e.e,e.sameDir);a.addCoedge3d(t)}if(!s.isSphere()){const e=i[0].fe,n=this._complexVtEdgesMap.get(t);1===n.concaveEdges.length&&n.convexEdges.length>1?e===n.concaveEdges[0]&&a.reverse():n.concaveEdges.length>1&&1===n.convexEdges.length&&e===n.convexEdges[0]&&(a.reverse(),u.setSameDirWithSurface(!1))}if(s instanceof r.Sphere){const e=s.getPoles(),t=a.getCoedge3ds();for(let n=0;n<t.length;n++){const i=t[n],c=i.getEndVertex();if(c.getPoint().equals(e[0])||c.getPoint().equals(e[1])){const t=new r.Line3d(c.getPoint(),r.Vector3.X(),[0,0]),l=new o.Edge(t,c,c);l.setDegenerateFlag(!0),this._shell.addEdge(l),c.addEdge(l);const u=i.getNextCoedge(),h=i.getStartVertex(),g=u.getEndVertex(),f=s.getUVAt(h.getPoint()),p=s.getUVAt(g.getPoint()),_=(f.x+p.x)/2,m=c.getPoint().equals(e[0])?1:-1,v=new r.Line2d(new r.Vector2(f.x,r.CONST.PI_2*m),new r.Vector2(_,r.CONST.PI_2*m)),E=new r.Line2d(new r.Vector2(_,r.CONST.PI_2*m),new r.Vector2(p.x,r.CONST.PI_2*m)),P=new d.Coedge3d(l,!0,v),y=new d.Coedge3d(l,!1,E);a.insertCoedge3d(n+1,P,y),n+=2}}}n.push(u)}if(s[1].transitedSurf)throw new Error("未实现的情况！")}return n}_calcFilletSurfXTopFace(e,t,n){const s=this._edgePerpendicularFaces.get(n.edge);if(s&&(s[0]===e||s[1]===e)){const t=h.Fillet3dBase.getFillerSurfaceAxis(n.surface);return h.Fillet3dBase.calcIntersectCurveForEdgePerpendicularFaces(n,t,e,s,this._radius)}const i=n.edge,o=n.surface,a=e.getSurface(),c=i.getCurve(),l=c.getEndTangent();t.getSameDirWithEdge()||l.reverse();const d=a.getNormAtPoint(c.getEndPt()).cross(l).normalize().multiplied(this._radius),u=r.MathAlg.CalculateIntersect.surfacesNearPoint(a,o,d,void 0,this._tol,!0);if(!u)throw new Error("fillet：filletSurface与侧面求交失败!");return u}_updatePeriodicFilletEdgeTopFace(e,t,n,s=new Map){const i=t.edge,c=t.surface,l=e.getSurface(),d=e.getWires();for(const u of d){if(!i.getCoedge3ds().find((e=>e.getWire()===u)))continue;let d;const g=u.getCoedge3ds()[0],f=this._edgePerpendicularFaces.get(t.edge);if(!f||f[0]!==e&&f[1]!==e){const e=g.getEdge().getStartVertex().getPoint(),t=r.MathAlg.CalculateIntersect.surfacesNearPoint(l,c,e,void 0,this._tol,!0);if(!t)throw new Error("fillet：filletSurface与侧面求交失败!");d=t}else{const n=h.Fillet3dBase.getFillerSurfaceAxis(t.surface);d=h.Fillet3dBase.calcIntersectCurveForEdgePerpendicularFaces(t,n,e,f,this._radius)}let p;if(this._adjustXCurveSameDirWithOriginCoedge(d,g,d.getStartPt()),!d.isPeriodic()){const e=r.MathAlg.CalculateIntersect.curve3dSelfIntersect(d,this._tol);if(0===e.length)throw new Error("fillet：曲面自交点计算失败，不支持倒的倒角!");{if(u.getCoedge3ds().length>1)throw new Error("fillet：曲面自交点且分多段，不支持倒的倒角!");let t=e[0];if(e.length>1){r.MathError.warn("fillet：曲面多个自交点!");const n=i.getStartVertex().getPoint();let s=e[0].point.sqDistanceTo(n);for(let r=1;r<e.length;r++){const i=e[r].point.sqDistanceTo(n);i<s&&(s=i,t=e[r])}}const l=[t.param1,t.param2];l[0]>l[1]&&([l[0],l[1]]=[l[1],l[0]]),d.setRange(l[0],l[1]);const h=t.point,g=new a.Vertex(h);this._shell.addVertex(g);const f=new o.Edge(d,g,g);this._shell.addEdge(f),g.addEdge(f);const p=u.getCoedge3ds()[0];return p.setEdge(f),p.setSameDirWithEdge(!0),this._addEdgeToFENewEdgesMap(f,i,s),void this._gatherFilletSurfacesXVtInfos({edge:i,surface:c},{edge:i,surface:c},g,n)}}p=d.getDomain().period;const _=[];for(const e of u.getCoedge3ds()){const t=e.getEndVertex().getPoint(),n=d.getParamAt(t);_.push(n)}const m=d.getPtAt(_[_.length-1]),v=new a.Vertex(m);this._shell.addVertex(v);let E=v;for(let e=0;e<_.length;e++){let t,r;if(e===_.length-1)t=v;else{const n=d.getPtAt(_[e+1]);t=new a.Vertex(n),this._shell.addVertex(t)}r=e===_.length-1?(_[e]+_[0]+p)/2:(_[e]+_[e+1])/2;const o=d.getPtAt(r),l=this._createNewEdge(d,E,t,o),h=u.getCoedge3ds()[e];h.setEdge(l),h.setSameDirWithEdge(!0),this._addEdgeToFENewEdgesMap(l,i,s),this._gatherFilletSurfacesXVtInfos({edge:i,surface:c},{edge:i,surface:c},E,n),E=t}}}_calcFilletSurfaceXFace(e,t,n,s){const i=t.getSurface(),o=n.newVt,a=s.newVt,c=o.getPoint(),l=a.getPoint().subtracted(o.getPoint()),d=r.MathAlg.CalculateIntersect.surfacesNearPoint(i,e.surface,c,l,this._tol,!0);if(d){const e=d.getStartPt().sqDistanceTo(d.getEndPt()),t=o.getPoint().sqDistanceTo(a.getPoint());if(e>t-this._tol.edgeLengthEps2)return d;const n=d.getMidPt(),r=d.getStartPt().sqDistanceTo(n),s=d.getEndPt().sqDistanceTo(n);if(r>t-this._tol.edgeLengthEps2||s>t-this._tol.edgeLengthEps2)return d}}_calcIntersectCurveForFillet(e,t,n,s,i,o){const a=e.getSurface(),c=t.edge,l=t.surface,d=s.getPoint();let u;if(u=o||i.getPoint().subtracted(d),c.getCurve().isNurbsCurve3d()){if(n){return this._calcAxisProjectAsXCurve(e,t,s,i)}const o=r.MathAlg.CalculateIntersect.surfacesNearPointSimple(a,l,d,u,this._tol,!0);if(!o)throw new Error("nurbs倒角：求交失败！");return o}const h=r.MathAlg.CalculateIntersect.surfacesNearPoint(a,l,d,u,this._tol,!0);if(h)return h;if(n){return this._calcAxisProjectAsXCurve(e,t,s,i)}throw new Error("倒角：求交失败！")}_calcAxisProjectAsXCurve(e,t,n,s){const i=t.edge,o=t.surface,a=e.getSurface(),c=[n.getPoint(),s.getPoint()],l=h.Fillet3dBase.getFillerSurfaceAxis(o);if(!l.isPeriodic()){const e=i.getStartVertex().getPoint(),t=i.getEndVertex().getPoint(),n=e.sqDistanceTo(c[0]),r=e.sqDistanceTo(c[1]),s=t.sqDistanceTo(c[0]),o=t.sqDistanceTo(c[1]),a=l.getParamAt(c[0]),d=l.getParamAt(c[1]);let u,h;if(n<r&&o<s)u=a,h=d;else{if(!(r<n&&s<o))throw new Error("");u=d,h=a,[c[0],c[1]]=[c[1],c[0]]}l.setRange(u,h)}const d=[],u=this._radius*this._radius,g=.001*u,f=l.discrete(r.DiscreteParameter.HIGH);for(const e of f){const t=a.getProjectedPtBy(e);if(t.sqDistanceTo(e)>u+g)throw new Error("");d.push(t)}const p=.04*u;d[0].sqDistanceTo(c[0])<p?d[0]=c[0]:d.splice(0,1,c[0]);if(d[d.length-1].sqDistanceTo(c[1])<p?d[d.length-1]=c[1]:d.push(c[1]),a.isPlane()){return r.NurbsCurve3d.makeByInterpolationPointsInPlane(d,a.getCoord(),3)}return r.NurbsCurve3d.makeByInterpolationPoints(d,3)}_createNewEdge(e,t,n,r){const s=h.Fillet3dBase.setCurveRange(e,t.getPoint(),n.getPoint(),r),[i,a]=s?[n,t]:[t,n],c=new o.Edge(e,i,a);return c.updateTolerance(),this._shell.addEdge(c),i.addEdge(c),a.addEdge(c),c}_setXCurveRange1(e,t,n){const r=e.xCv,s=r.getRange(),i=r.getParamAt(n.getPoint());if(r.getStartPt().equals(t.getPoint(),this._tol.edgeLengthEps)?s.min=i:s.max=i,s.min>s.max){if(!r.isPeriodic())throw new Error("fillet: edge的curve非周期性且反求参数错误！");{const e=r.getRange().period;s.max+=e,r.isNurbsCurve3d()&&s.max>r.getDomain().max&&(s.min-=e,s.max-=e)}}}_setEdgeNewVt(e,t,n){const r=e.getCurve();let s=r.getParamAt(n.getPoint());if(this._getEdgeOriginStartVt(e)===t){if(s>r.getEndParam()){if(!r.isPeriodic())throw new Error("fillet: edge的curve非周期性且反求参数错误！");s-=r.getRange().period}r.getRange().min=s,e.setStartVertex(n)}else{if(s<r.getStartParam()){if(!r.isPeriodic())throw new Error("fillet: edge的curve非周期性且反求参数错误！");s+=r.getRange().period}r.getRange().max=s,e.setEndVertex(n)}}_mergeCoincideVertices(e){const t=[],n=new Set;e.map((e=>n.add(e.edge)));for(const s of n){const n=s;if(this._allFilletEdges.has(n))continue;const i=e.filter((e=>e.edge===n)),o=[],a=[];for(const e of i)e.originVt===n.getStartVertex()?o.push(e):a.push(e);if(o.length>2)for(let e=0;e<o.length;e++){const t=o[e],s=t.fsInfo.edge;for(let i=e+1;i<o.length;i++){const a=o[i],c=a.fsInfo.edge;if(r.MathAlg.CurveCurveColinear.curve3ds(s.getCurve(),c.getCurve(),this._tol))if(s.getStartVertex()===n.getStartVertex()||s.getEndVertex()===n.getStartVertex())a.newVt=t.newVt,o.splice(i,1),i--;else if(c.getStartVertex()===n.getStartVertex()||c.getEndVertex()===n.getStartVertex()){t.newVt=a.newVt,o.splice(e,1),e--;break}}}for(let e=0;e<o.length;e++){const n=o[e];n.fsInfo.edge.getStartVertex()===n.fsInfo.edge.getEndVertex()&&this._gatherFilletSurfacesXVtInfos(n.fsInfo,n.fsInfo,n.newVt,t);for(let s=e+1;s<o.length;s++){const e=o[s];e.newVt.getPoint().sqDistanceTo(n.newVt.getPoint())<r.Tolerance.EDGE_LENGTH_EPS2&&(e.newVt=n.newVt,n.setVtFlag||e.setVtFlag||this._gatherFilletSurfacesXVtInfos(n.fsInfo,e.fsInfo,n.newVt,t))}}if(a.length>2)for(let e=0;e<a.length;e++){const t=a[e],s=t.fsInfo.edge;for(let i=e+1;i<a.length;i++){const o=a[i],c=o.fsInfo.edge;if(r.MathAlg.CurveCurveColinear.curve3ds(s.getCurve(),c.getCurve(),this._tol))if(s.getStartVertex()===n.getEndVertex()||s.getEndVertex()===n.getEndVertex())o.newVt=t.newVt,a.splice(i,1),i--;else if(c.getStartVertex()===n.getEndVertex()||c.getEndVertex()===n.getEndVertex()){t.newVt=o.newVt,a.splice(e,1),e--;break}}}for(let e=0;e<a.length;e++){const n=a[e];n.fsInfo.edge.getStartVertex()===n.fsInfo.edge.getEndVertex()&&this._gatherFilletSurfacesXVtInfos(n.fsInfo,n.fsInfo,n.newVt,t);for(let s=e+1;s<a.length;s++){const e=a[s];e.newVt.getPoint().sqDistanceTo(n.newVt.getPoint())<r.Tolerance.EDGE_LENGTH_EPS2&&(e.newVt=n.newVt,n.setVtFlag||e.setVtFlag||this._gatherFilletSurfacesXVtInfos(n.fsInfo,e.fsInfo,n.newVt,t))}}}return t}_dealDegenerateEdges(){const e=[],t=this._shell.getEdges();for(const n of t){if(n.getCurve().getRange().getLength()<r.Tolerance.NUMBER_EPS){const t=n.getCoedge3ds();if(t.length>0&&t[0].getPCurve())continue;e.push(n)}}for(const t of e){const e=t.getStartVertex(),n=t.getEndVertex(),r=n.getEdges();for(const s of r)s.tag!==t.tag&&(s.getStartVertexTag()===n.tag?s.setStartVertex(e):s.setEndVertex(e));const s=t.getCoedge3ds();for(const e of s){e.getParent().deleteCoedge3d(e)}t.dispose(),this._shell.deleteVertex(n),this._shell.deleteEdge(t)}const n=[],s=this._shell.getEdges();for(let e=0;e<s.length;e++){const t=s[e];for(let i=e+1;i<s.length;i++){const e=s[i];if(t.getStartVertexTag()===e.getStartVertexTag()&&t.getEndVertexTag()===e.getEndVertexTag()||t.getStartVertexTag()===e.getEndVertexTag()&&t.getEndVertexTag()===e.getStartVertexTag()){r.MathAlg.CurveCurveColinear.curve3ds(t.getCurve(),e.getCurve())&&t.getCurve().getMidPt().equals(e.getCurve().getMidPt())&&n.push({e1:t,e2:e})}}}}_gatherFilletSurfacesXVtInfos(e,t,n,s){const i=e.edge,o=t.edge,a=s.find((e=>e.fsInfo1.edge===i&&e.fsInfo2.edge===o||e.fsInfo2.edge===i&&e.fsInfo1.edge===o)),c=this._findTwoFilletEdgesCommonVt(i,o);a&&n!==a.vt1?(n===a.vt2&&r.MathError.assert("fillet3d：两个fillet surface对应了多个不同的交点"),a.vt2=n,a.commonVt=c):s.push({fsInfo1:e,fsInfo2:t,vt1:n,commonVt:c})}_getEdgeOriginStartVt(e){const t=this._edgeOriginVtMap.get(e);return r.MathAssert.assert(t,"failed: getEdgeOriginStartVt!"),t.startVertex}_addEdgeToFENewEdgesMap(e,t,n){const r=n.get(t);r?r.push(e):n.set(t,[e])}_addEdgeToCommonVtNewEdgesMap(e,t,n,r){const s={fe:n,newEg:e},i=r.get(t);i?i.push(s):r.set(t,[s])}_findInColinearEdgesMap(e){for(const t of this._colinearEdgesMap)if(t[1].find((t=>t===e)))return t[0]}_findTwoFilletEdgesCommonVt(e,t){let n=this._colinearEdgesMap.get(e),r=this._colinearEdgesMap.get(t);n||(n=[e]),r||(r=[t]);for(const e of n)for(const t of r){if(e.getStartVertex()===t.getStartVertex()||e.getStartVertex()===t.getEndVertex())return e.getStartVertex();if(e.getEndVertex()===t.getStartVertex()||e.getEndVertex()===t.getEndVertex())return e.getEndVertex()}}_findTwoFilletEdgesConnectEdge(e,t){if(e===t)return;const n=e.getStartVertex().getEdges(),r=e.getEndVertex().getEdges(),s=new Set;for(const t of[...n,...r])t!==e&&s.add(t);if(s.has(t))return;const i=t.getStartVertex().getEdges(),o=t.getEndVertex().getEdges(),a=new Set;for(const e of[...i,...o])e!==t&&a.add(e);if(!a.has(e))for(const e of s)for(const t of a)if(e===t)return e}_getLeftAndRightCoedge(e){const t=e.getCoedge3ds();let n=t[0].getSameDirWithEdge(),r=t[1].getSameDirWithEdge();const s=e.getFaces();let i,o;if(s[0].getSameDirWithSurface()||(n=!n),s[1].getSameDirWithSurface()||(r=!r),n)i=t[0],o=t[1];else{if(!r)throw new Error("filled3d：倒角体的数据存在拓扑错误！");i=t[1],o=t[0]}return[i,o]}_isConcaveEdge(e){const[t,n]=this._getLeftAndRightCoedge(e),r=t.getFace(),s=n.getFace(),i=e.getCurve().getMidPt(),o=r.getSurface().getUVAt(i),a=s.getSurface().getUVAt(i);let c=r.getSurface().getNormAt(o),l=s.getSurface().getNormAt(a);if(r.getSameDirWithSurface()||c.reverse(),s.getSameDirWithSurface()||l.reverse(),c.isParallel(l,this._tol.angleEps)&&r.getSurface().getType()!==s.getSurface().getType()){if(r.getSurface().isCylinder()||r.getSurface().isCone()){c=r.getSurface().getDerivatives(o,2)[3].normalized()}if(s.getSurface().isCylinder()||s.getSurface().isCone()){l=s.getSurface().getDerivatives(a,2)[3].normalized()}return c.dot(l)>this._tol.angleEps}const d=c.cross(l),u=e.getCurve().getMidTangent();return d.dot(u)<-this._tol.angleEps}_getConnectConcaveEdges(e){const t=new Set,n=e.getStartVertex().getEdges(),r=e.getEndVertex().getEdges(),s=new Set([...n,...r]);for(const n of s)n!==e&&this._allConcaveEdge.has(n)&&t.add(n);return t}_updateEdgeNewVt(e,t){if(!e.setVtFlag&&!t.has(e)&&!this._allFilletEdges.has(e.edge)){const n=e.edge;this._shell.addVertex(e.newVt),this._setEdgeNewVt(n,e.originVt,e.newVt),t.add(e)}}_addFaceEdgeNewVtInfo(e,t,n){const r={fsInfo:t,newVtInfos:n},s=this._faceEdgeNewVtInfoMap.get(e);s?s.push(r):this._faceEdgeNewVtInfoMap.set(e,[r])}_isValidXPt(e,t,n){var r,s;const i=t.filletSurfInfo.edge,o=n.filletSurfInfo.edge;if(this._findTwoFilletEdgesCommonVt(i,o))return!0;for(const i of[t,n])if(i.xVtInfo1&&i.xVtInfo1.setVtFlag||i.xVtInfo2&&i.xVtInfo2.setVtFlag){const t=i.newXVt1||(null===(r=i.xVtInfo1)||void 0===r?void 0:r.newVt),n=i.newXVt2||(null===(s=i.xVtInfo2)||void 0===s?void 0:s.newVt);if(!t||!n)continue;const o=e.sqDistanceTo(t.getPoint()),a=e.sqDistanceTo(n.getPoint());if(i.xVtInfo1&&i.xVtInfo1.setVtFlag&&o<a)return!1;if(i.xVtInfo2&&i.xVtInfo2.setVtFlag&&a<o)return!1}return!0}_getIntersectCoedge(e,t,n){let s=0;const i=e.getWire();let o=e;do{const e=n.find((e=>e.edge===o.getEdge()));if(e)return e;const r=t?o.getPrevCoedge():o.getNextCoedge();o=r,s++}while(s<i.getCoedge3ds().length-1);r.MathError.warn("Fillet3d Preview: 当前coedge的整个wire与fillet surface没有找到交点！")}_swapXCurveVtInfos(e){const t=e.xVtInfo1;e.xVtInfo1=e.xVtInfo2,e.xVtInfo2=t;const n=e.newXVt1;e.newXVt1=e.newXVt2,e.newXVt2=n}}},46511:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fillet3dPreview=void 0;const r=n(98106),s=n(78926),i=n(37632);t.Fillet3dPreview=class{constructor(e,t,n=r.Tolerance.DEFAULT){this._originEdges=e,this._radius=t,this._tol=n}execute(){let e=[];try{e=this.preview()}catch(e){r.MathError.warn(e)}return e}preview(){var e,t;this._preprocess();const n=this._edges[0].getShell();i.BodyUtil.unifyFaceDirectOutside(n),this._initial();const r=s.Fillet3dBase.createFilletSurface(this._edges,this._radius,this._tol),o=[],a=[];for(const n of r){const r=n[0],s=n[1],i={edge:r,surface:s},c=new Map;if(r.getStartVertex()===r.getEndVertex()){const e=this._calcMainXCurveAtPeriodicFilletEdge(r,s,c);o.push(...e);continue}const l=n[0].getStartVertex(),d=n[0].getEndVertex(),u=this._endVertexFaces.get(l);if(u)for(const e of u){const t=this._calcSideNewCurves(i,l,e,c);t&&o.push(t)}const h=this._endVertexFaces.get(d);if(h)for(const e of h){const t=this._calcSideNewCurves(i,d,e,c);t&&o.push(t)}const g=r.getCoedge3ds(),f=this._calcMainXCurve(g[0],i,c);if(f)a.push(f);else{const t=l.getFaces(),n=d.getFaces(),r=new Set([...t,...n]),i=new Set;for(const t of g[0].getWire().getCoedge3ds()){if(t===g[0]||t===g[0].getPrevCoedge()||t===g[0].getNextCoedge())continue;const n=null===(e=t.getTwin())||void 0===e?void 0:e.getFace();n&&!r.has(n)&&i.add(n)}for(const e of i){const t=this._calFaceXFilletSurface(g[0],e,s,c);t&&a.push(t)}}const p=this._calcMainXCurve(g[1],i,c);if(p)a.push(p);else{const e=l.getFaces(),n=d.getFaces(),r=new Set([...e,...n]),i=new Set;for(const e of g[0].getWire().getCoedge3ds()){if(e===g[0]||e===g[0].getPrevCoedge()||e===g[0].getNextCoedge())continue;const n=null===(t=e.getTwin())||void 0===t?void 0:t.getFace();n&&!r.has(n)&&i.add(n)}for(const e of i){const t=this._calFaceXFilletSurface(g[1],e,s,c);t&&a.push(t)}}}const c=new Map;for(const e of a){const t=e.ce.getFace(),n=c.get(t);n?n.push(e):c.set(t,[e])}const l=this._updateFaceXCurves(c);return o.push(...l),o}_preprocess(){this._edges=this._originEdges;for(let e=0;e<this._edges.length;e++){const t=this._edges[e],n=t.getFaces();if(2!==n.length)continue;if(r.MathAlg.CalculateOverlap.isSurfacesCoplaner(n[0].getSurface(),n[1].getSurface())){this._edges.splice(e,1);continue}const s=t.getCurve().getStartPt(),i=t.getCurve().getEndPt(),o=t.getCurve().getMidPt();for(const t of[s,o,i]){const r=n[0].getSurface().getNormAtPoint(t),s=n[1].getSurface().getNormAtPoint(t);if(r.isParallel(s,100*this._tol.angleEps)){this._edges.splice(e,1);break}}}const e=new Set;for(const t of this._edges){const n=t.getStartVertex(),s=t.getEndVertex();for(const i of[n,s]){let n=i,s=t,o=!1;do{o=!1;const i=n.getEdges();for(const a of i)if(a!==s&&!this._edges.find((e=>e===a))&&!e.has(a)&&r.MathAlg.CurveCurveColinear.curve3ds(a.getCurve(),t.getCurve(),this._tol)){a.getStartVertex()===n?(e.add(a),n=a.getEndVertex()):(e.add(a),n=a.getStartVertex()),s=a,o=!0;break}}while(o)}}for(const t of e)this._edges.push(t)}_initial(){const e=new Set,t=new Set;for(const n of this._edges)n.getFaces().map((e=>t.add(e))),e.add(n.getStartVertex()),e.add(n.getEndVertex());this._edgeFaces=t;const n=new Map,r=new Set(this._edges);for(const t of e){const e=t.getEdges(),s=[],i=[];for(const t of e)r.has(t)?s.push(t):i.push(t);if(1===s.length&&s[0].getStartVertex()!==s[0].getEndVertex()){const e=[];for(const n of t.getFaces())this._edgeFaces.has(n)||e.push(n);n.set(t,e)}}this._endVertexFaces=n,this._edgePerpendicularFaces=new Map;for(const e of this._edges){const t=e.getFaces();let n=!1;const r=t[0].getSurface(),i=t[1].getSurface();r.isPlane()?n=s.Fillet3dBase.isSurfacePerpendicularPlane(i,r):i.isPlane()&&(n=s.Fillet3dBase.isSurfacePerpendicularPlane(r,i)),n&&this._edgePerpendicularFaces.set(e,t)}}_calcMainXCurve(e,t,n){const i=t.edge,o=t.surface,a=e.getFace(),c=a.getSurface(),l=e.getPrevCoedge();let d=this._getIntersectCoedge(l,!0,i,o,n);const u=e.getNextCoedge();let h,g,f=this._getIntersectCoedge(u,!1,i,o,n);if(!d&&!f){const t=e.getWire(),r=t.getFace().getWires()[0];if(r!==t){const t=e.getStartVertex().getPoint(),s=r.getCoedge3ds();let a=s[0].getStartVertex(),c=a.getPoint().sqDistanceTo(t),l=s[s.length-1],u=s[0];for(let e=1;e<s.length;e++){const n=s[e].getStartVertex().getPoint().sqDistanceTo(t);n<c&&(c=n,a=s[e].getStartVertex(),l=s[e-1],u=s[e])}f=this._getIntersectCoedge(l,!0,i,o,n),d=this._getIntersectCoedge(u,!1,i,o,n)}}h=void 0!==d?d:void 0!==f?f:i.getStartVertex().getPoint();const p=this._edgePerpendicularFaces.get(e.getEdge());if(!p||p[0]!==a&&p[1]!==a){const e=r.MathAlg.CalculateIntersect.surfacesNearPointSimple(c,o,h);if(!e)throw new Error("fillet preview：filletSurface与主面求交失败!");g=e}else{const e=s.Fillet3dBase.getFillerSurfaceAxis(o);g=s.Fillet3dBase.calcIntersectCurveForEdgePerpendicularFaces(t,e,a,p,this._radius)}if(this._adjustXCurveSameDirWithCoedge(g,e),!d||!f){return{ce:e,newCurve:g}}this._setCoedgeNewXCurveRange(g,d,f,e.getEdge());return{ce:e,newCurve:g,stVt:d,endVt:f}}_getCoedgeXPt(e,t,n,s,i){const o=e.getEdge(),a=s.get(o);if(a){if(0===a.length)return;if(1===a.length)return a[0];if(a.length>1){if(!i)return a[0];let e=a[0].sqDistanceTo(i),t=a[0];for(let n=1;n<a.length;n++){const r=a[n].sqDistanceTo(i);r<e&&(e=r,t=a[n])}return t}}const c=o.getCurve();if(r.MathAlg.CurveCurveColinear.curve3ds(c,t.getCurve()))return void s.set(o,[]);let l=i;if(!l){const e=t.getStartVertex().getPoint(),n=t.getEndVertex().getPoint(),r=c.getStartPt(),s=c.getStartPt();l=Math.min(e.sqDistanceTo(r),e.sqDistanceTo(s))<Math.min(n.sqDistanceTo(r),n.sqDistanceTo(s))?e:n}const d=r.MathAlg.CalculateIntersect.curveSurfaceNearPoint(c,n,l,this._tol);return d?(s.set(o,[d]),d):void 0}_getIntersectCoedge(e,t,n,s,i){const o=t?e.getEndVertex().getPoint():e.getStartVertex().getPoint(),a=t?e.getCurve().getEndTangent().reverse():e.getCurve().getStartTangent(),c=s.getNormAtPoint(o),l=o.added(c.added(a).multiplied(this._radius));let d=0;const u=e.getWire();let h=e;do{const e=this._getCoedgeXPt(h,n,s,i,l);if(e)return e;const r=t?h.getPrevCoedge():h.getNextCoedge();h=r,d++}while(d<u.getCoedge3ds().length-1);r.MathError.warn("Fillet3d Preview: 当前coedge的整个wire与fillet surface没有找到交点！")}_adjustXCurveSameDirWithCoedge(e,t){const n=e.getMidPt(),r=e.getMidTangent(),s=t.getCurve(),i=s.getParamAt(n);s.getTangentAt(i).dot(r)<0&&e.reverse()}_calcSideNewCurves(e,t,n,i){const o=e.edge,a=e.surface;let c,l;for(const e of n.getWires())for(const n of e.getCoedge3ds())if(n.getEndVertex()===t&&(c=n),n.getStartVertex()===t&&(l=n),c&&l)break;if(!c||!l)return void r.MathError.warn("fillet3d preview: face与fillet edge不相连");const d=this._getIntersectCoedge(c,!0,o,a,i),u=this._getIntersectCoedge(l,!1,o,a,i);if(!d||!u)return;const h=d,g=u.subtracted(d),f=n.getSurface(),p=r.MathAlg.CalculateIntersect.surfacesNearPointSimple(f,a,h,g);if(!p)throw new Error("fillet：filletSurface与侧面求交失败!");return s.Fillet3dBase.setRangeForXCurve(o,p,d,u,!1,t.getPoint()),p}_calFaceXFilletSurface(e,t,n,s){const i=e.getEdge(),o=t.getWires()[0],a=[];for(const e of o.getCoedge3ds()){const t=this._getCoedgeXPt(e,i,n,s);t&&a.push(t)}if(0===a.length)return;if(1===a.length)return void r.MathError.warn("fillet3d preview: 与其他面交于一个点");const c=a[0],l=t.getSurface(),d=r.MathAlg.CalculateIntersect.surfacesNearPointSimple(l,n,c);if(!d)throw new Error("fillet preview：filletSurface与主面求交失败!");this._setCoedgeNewXCurveRange(d,a[0],a[1],e.getEdge());return{ce:e,newCurve:d,stVt:a[0],endVt:a[1]}}_calcMainXCurveAtPeriodicFilletEdge(e,t,n){const s=[],i=e.getCoedge3ds();let o,a;i[0].getNextCoedge()===i[0]?(o=i[0],a=i[1]):(o=i[1],a=i[0]);const c=o.getStartVertex().getPoint(),l=o.getFace(),d=a.getFace(),u=this._edgePerpendicularFaces.get(e);if(u&&(u[0]===l&&u[1]===d||u[1]===l&&u[0]===d)){const t=e.getCurve(),n=r.CurveUtil.getDzByCurve(t);let i=-this._radius;l.getWires()[0]!==o.getWire()&&(i=-i);const c=r.OffsetCurve3d.makeByOffset(t,n,i,0);s.push(c);const d=a.getPrevCoedge().getEdge().getCurve().getMidPt().subtracted(a.getStartVertex().getPoint()).dot(n)>0?1:-1,u=t.clone().translate(n.multiplied(d*this._radius));s.push(u)}else{const i=r.MathAlg.CalculateIntersect.surfacesNearPointSimple(l.getSurface(),t,c);i?s.push(i):r.MathError.warn("fillet3d preview: 周期性交线计算失败");const o=a.getPrevCoedge();let u=this._getIntersectCoedge(o,!0,e,t,n);u||(r.MathError.warn("fillet3d preview: 交线交点计算失败"),u=c);const h=r.MathAlg.CalculateIntersect.surfacesNearPointSimple(d.getSurface(),t,u);h?s.push(h):r.MathError.warn("fillet3d preview: 周期性交线计算失败")}return s}_updateFaceXCurves(e){const t=[];for(const n of e){const e=n[1];if(n[1].length>1)for(let t=0;t<e.length;t++){const n=e[t];for(let s=t+1;s<e.length;s++){const t=e[s];let i;if(n.ce.getEndVertex()===t.ce.getStartVertex()?i=n.ce.getEndVertex():n.ce.getStartVertex()===t.ce.getEndVertex()&&(i=n.ce.getStartVertex()),i){let e;if(r.MathAlg.CurveCurveColinear.curve3ds(n.ce.getCurve(),t.ce.getCurve(),this._tol))e=n.newCurve.getProjectedPtBy(i.getPoint());else{const s=r.MathAlg.CalculateIntersect.curve3dsNearPoint(n.newCurve,t.newCurve,i.getPoint());if(!s)throw new Error("xCurve1与xCurve2无交点！");e=s.point}n.ce.getStartVertex()===i?n.stVt=e:n.endVt=e,t.ce.getStartVertex()===i?t.stVt=e:t.endVt=e}}}for(const n of e){const e=n.newCurve;if(!n.stVt||!n.endVt)throw new Error;this._setCoedgeNewXCurveRange(e,n.stVt,n.endVt,n.ce.getEdge()),t.push(e)}}return t}_setCoedgeNewXCurveRange(e,t,n,r){if(!e.isPeriodic()){const r=e.getParamAt(t),s=e.getParamAt(n);return void(r>s?e.setRange(s,r):e.setRange(r,s))}if(t===n||t.equals(n)){const n=e.getParamAt(t),r=n+e.getRange().period;e.setRange(n,r)}let s=e.getParamAt(t),i=e.getParamAt(n);const o=(s+i)/2,a=e.getPtAt(o),c=e.getRange().period,l=e.getPtAt(o+c/2),d=r.getCurve().getMidPt();let u=!1;const h=a.sqDistanceTo(d),g=l.sqDistanceTo(d);s<i?h>g&&(s+=c,u=!0):h<g?u=!0:i+=c,u?e.setRange(i,s):e.setRange(s,i)}}},78926:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fillet3dBase=t.findEdgeConnectColinearEdges=t.isConcaveEdge=void 0;const r=n(98106),s=n(45813),i=n(53265);t.isConcaveEdge=function(e,t=r.Tolerance.DEFAULT){const[n,s]=i.getLeftAndRightCoedge(e),o=n.getFace(),a=s.getFace(),c=e.getCurve().getMidPt(),l=o.getSurface().getUVAt(c),d=a.getSurface().getUVAt(c);let u=o.getSurface().getNormAt(l),h=a.getSurface().getNormAt(d);if(o.getSameDirWithSurface()||u.reverse(),a.getSameDirWithSurface()||h.reverse(),u.isParallel(h,t.angleEps)&&o.getSurface().getType()!==a.getSurface().getType()){if(o.getSurface().isCylinder()||o.getSurface().isCone()){u=o.getSurface().getDerivatives(l,2)[3].normalized()}if(a.getSurface().isCylinder()||a.getSurface().isCone()){h=a.getSurface().getDerivatives(d,2)[3].normalized()}return u.dot(h)>t.angleEps}const g=u.cross(h),f=e.getCurve().getMidTangent();return g.dot(f)<-t.angleEps},t.findEdgeConnectColinearEdges=function(e,t=r.Tolerance.DEFAULT){const n=new Set,s=(e,s,i)=>{let o=s,a=e,c=!0;for(;c&&o!==i;){c=!1;const s=o.getEdges();for(const i of s)if(i!==a&&r.MathAlg.CurveCurveColinear.curve3ds(i.getCurve(),e.getCurve(),t)){a=i,o=i.getStartVertex()===o?i.getEndVertex():i.getStartVertex(),c=!0,n.add(i);break}}},i=e.getStartVertex(),o=e.getEndVertex();return s(e,o,i),i!==o&&s(e,i,o),n};t.Fillet3dBase=class{static isSurfacePerpendicularPlane(e,t){const n=t.getNorm();if(e instanceof r.Plane)return e.getNorm().isPerpendicular(n);if(e instanceof r.Cylinder)return e.getCenterAxis().isParallel(n);if(e instanceof r.SweepSurface){const t=e.getPath();if(t.isLine3d())return t.getDirection().isParallel(n);if(e.getProfile().isLine2d()){return e.getIsoCurve(t.getRange().getMid(),!0).getDirection().isParallel(n)}return!1}if(e instanceof r.OffsetSurface){const n=e.getBaseSurface();return this.isSurfacePerpendicularPlane(n,t)}return!1}static createFilletSurface(e,t,n=r.Tolerance.DEFAULT,o=!1){const a=new Map;for(const c of e){const[e,l]=i.getLeftAndRightCoedge(c),d=e.getFace(),u=l.getFace(),h=c.getCurve().getMidPt(),g=d.getSurface().getNormAtPoint(h),f=u.getSurface().getNormAtPoint(h);d.getSameDirWithSurface()||g.reverse(),u.getSameDirWithSurface()||f.reverse();const p=g.cross(f),_=c.getCurve().getMidTangent(),m=p.dot(_)<-n.angleEps,v=m===d.getSameDirWithSurface()?t:-t,E=m===u.getSameDirWithSurface()?t:-t,P=r.OffsetSurface.make(d.getSurface(),v),y=r.OffsetSurface.make(u.getSurface(),E),C=h.add(g.multiplied(E)).add(f.multiplied(E)),S=r.MathAlg.CalculateIntersect.surfacesNearPoint(P,y,C,void 0,n,!0);if(!S)throw new Error("fiilet：计算fillet surface的中心轴线求交失败!");if(o){let e=!1;if((S.isNurbsCurve3d()||S.isOffsetCurve3d()&&S.getBaseCurve().isNurbsCurve3d())&&(e=!0),e){if(r.MathAlg.CalculateIntersect.curve3dSelfIntersect(S).length>0)throw new Error(s.FilletErrorCode.FilletSelfIntersect)}}const T=S.getParamAt(h),b=S.getTangentAt(T),w=c.getCurve().getMidTangent();let x;if(b.dot(w)<0&&S.reverse(),S instanceof r.Line3d){const e=new r.Coordinate3(S.getMidPt(),S.getDirection());x=new r.Cylinder(e,t,t)}else{if(S instanceof r.Arc3d&&S.isEqualAB()){const e=S.getRadius();if(e<-n.lengthEps)throw new Error("fillet3d: arc曲线的倒角过大");if(Math.abs(e)<=n.lengthEps){const e=S.getCoord();x=new r.Sphere(e,t),a.set(c,x);continue}}const e=r.Coordinate2.XOY(),s=new r.Arc2d(e,t,t,!0),i=S.getStartPt().equals(S.getEndPt()),o=i&&S.getStartTangent().equals(S.getEndTangent());x=new r.SweepSurface(S,s,!o);const l=x.getPath();if(i&&l.isExtendCurve3d()){const e=l.getBaseCurve(),t=c.getCurve().getRange();e.getRange().getLength()<t.getLength()+n.numberEps&&e.setRange(t.min,t.max)}}a.set(c,x)}return a}static getFillerSurfaceAxis(e){if(e instanceof r.Cylinder){const t=e.getCoord();return new r.Line3d(t.getOrigin(),t.getDz(),r.Interval.infinitArray())}if(e instanceof r.Sphere){const t=e.getCoord();return new r.Arc3d(t,0,0)}if(e instanceof r.SweepSurface){const t=e.getProfile();if(t instanceof r.Arc2d){const n=t.getCenter();if(!n.equals(r.Vector2.O())){const t=n.subtracted(r.Vector2.O()),s=-t.x,i=t.y,o=e.getPathDz();return r.OffsetCurve3d.makeByOffset(e.getPath(),o,s,i)}}return e.getPath().clone()}throw new Error("fillet3d: surface type error")}static calcIntersectCurveForEdgePerpendicularFaces(e,t,n,s,i){const o=e.edge.getCurve(),a=s[0]===n?s[1]:s[0];if(a.getSurface().isPlane()){const e=a.getSurface().getNorm();a.getSameDirWithSurface()||e.reverse();const n=e.reversed().multiplied(i),r=o.clone().translate(n);let s;if(r.setRangeInfinit(),t.isOffsetCurve3d()||t.isExtendCurve3d()){const e=t.getBaseCurve();if(e.isExtendCurve3d()){s=e.getBaseCurve().getMidPt()}else s=e.getMidPt()}else s=t.getMidPt();return r.getProjectedPtBy(s).sqDistanceTo(s)>i*i*1.21&&r.translate(n.multiplied(-2)),r}const c=n.getSurface().getNorm();let l=r.OffsetCurve3d.makeByOffset(o,c,-i,0);const d=l.getStartPt();if(t.getProjectedPtBy(d).sqDistanceTo(d)>i*i*1.21&&(l=r.OffsetCurve3d.makeByOffset(o,c,i,0)),t.isPeriodic())return l.setRangeInfinit(),l;return new r.ExtendCurve3d(l)}static setCurveRange(e,t,n,s){let i=e.getParamAt(t),o=e.getParamAt(n);if(!e.isPeriodic())return i>o?(e.setRange(o,i),!0):(e.setRange(i,o),!1);const a=e.getRange().period;if(t.equals(n,r.Tolerance.EDGE_LENGTH_EPS))return e.setRange(i,i+a),!1;let c=!1;const l=(i+o)/2,d=e.getPtAt(l),u=e.getPtAt(l+a/2);return i<o?d.sqDistanceTo(s)>u.sqDistanceTo(s)&&(i+=a,c=!0):d.sqDistanceTo(s)<u.sqDistanceTo(s)?c=!0:o+=a,c?(e.setRange(o,i),!0):(e.setRange(i,o),!1)}static setRangeForXCurve(e,t,n,s,i,o){if(!t.isPeriodic()){const e=t.getParamAt(n),r=t.getParamAt(s);return e>r?(t.setRange(r,e),!0):(t.setRange(e,r),!1)}if(n.equals(s,r.Tolerance.EDGE_LENGTH_EPS)){const e=t.getParamAt(n),r=t.getParamAt(s),i=t.getRange().period;return e<r?(t.setRange(e,e+i),!1):(t.setRange(r,r+i),!0)}if(t.isNurbsCurve3d())return this._setNurbsCurveRange(e,t,n,s,i,o);const a=t.getParamAt(n),c=t.getParamAt(s);return this._setPeriodicCurveRange(e,t,a,c,i,o)}static _setNurbsCurveRange(e,t,n,s,i,o){const a=t.getRange().period,c=t.getAllFootParams(n).filter((e=>t.getPtAt(e).sqDistanceTo(n)<r.Tolerance.EDGE_LENGTH_EPS)),l=t.getAllFootParams(s).filter((e=>t.getPtAt(e).sqDistanceTo(s)<r.Tolerance.EDGE_LENGTH_EPS));if(0===c.length||0===l.length){if(r.MathError.warn("fillet3d: 反求参数、计算垂足失败"),0===c.length){const e=t.getParamAt(n);c.splice(0,c.length,e)}if(0===l.length){const e=t.getParamAt(s);l.splice(0,l.length,e)}}if(1===c.length&&1===l.length)return Math.abs(c[0]-a)<r.Tolerance.NUMBER_EPS&&(c[0]=0),Math.abs(l[0]-a)<r.Tolerance.NUMBER_EPS&&(l[0]=0),this._setPeriodicCurveRange(e,t,c[0],l[0],i,o);const d=[];let u,h;c.map((e=>d.push({param:e,pt:n}))),l.map((e=>d.push({param:e,pt:s}))),d.sort(((e,t)=>e.param-t.param));let g=t.getRange().getLength();for(let e=0;e<d.length-1;e++){const t=d[e],n=d[e+1];if(t.pt!==n.pt){const e=n.param-t.param;e<g&&(g=e,u=t,h=n)}}u&&h||r.MathError.assert("fillet3d: xCurve设置参数域失败失败"),t.setRange(u.param,h.param);return n.sqDistanceTo(u.pt)>s.sqDistanceTo(u.pt)}static _setPeriodicCurveRange(e,t,n,s,i,o){const a=t.getRange().period;if(!e.getCurve().isPeriodic()){if(n<=s){return s-n<n+a-s?(t.setRange(n,s),!1):(t.setRange(s,n+a),!0)}return n-s<s+a-n?(t.setRange(s,n),!0):(t.setRange(n,s+a),!1)}let c=!1;const l=(n+s)/2,d=t.getPtAt(l),u=t.getPtAt(l+a/2);let h,g;if(i&&e.getCurve().isPeriodic()){const t=e.getCurve().getMidPt();h=d.sqDistanceTo(t),g=u.sqDistanceTo(t)}else!i&&o?(h=d.sqDistanceTo(o),g=u.sqDistanceTo(o)):(h=r.MathAlg.CalculateDistance.pointToCurve3d(d,e.getCurve()),g=r.MathAlg.CalculateDistance.pointToCurve3d(u,e.getCurve()));let f=n,p=s;return f<p?h>g&&(f+=a,c=!0):h<g?c=!0:p+=a,c?(t.setRange(p,f),!0):(t.setRange(f,p),!1)}}},97510:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(91859);t.default=class{constructor(e){this._contextShells=e}getContextShells(){return this._contextShells}execute(){const e=this._executeImpl(),{addShells:t,modifiedShellsMap:n}=e,s=[];if(t&&s.push(...t),n&&s.push(...n.keys()),this._validateResult()){const t=[];if(s.forEach((e=>t.push(...r.DiagnoseShell.execute(e)))),t.length)throw e.topoErrors=t,new Error(`${this.constructor.name}操作后, Brep数据不合法`)}return e}_validateResult(){return!0}}},34652:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addEvolutionInfo=t.mergeShellModelingResult=t.addShellModifyInfo=void 0,t.addShellModifyInfo=function(e,t,n,r,s){let i=e.get(t);i||(i={addFaces:[],deleteFaces:[],modifiedFaces:[]},e.set(t,i)),n&&i.addFaces.push(...n),r&&i.deleteFaces.push(...r),s&&i.modifiedFaces.push(...s)},t.mergeShellModelingResult=function(e,t){if(!e.errorStr&&t.errorStr&&(e.errorStr=t.errorStr),t.addShells&&(e.addShells?e.addShells.push(...t.addShells):e.addShells=t.addShells),t.deleteShells){e.deleteShells=e.deleteShells||[];for(const n of t.deleteShells){if(e.addShells){const t=e.addShells.indexOf(n);if(t>-1){e.addShells.splice(t,1);continue}}e.deleteShells.push(n),e.modifiedShellsMap&&e.modifiedShellsMap.delete(n)}}if(t.modifiedShellsMap){e.modifiedShellsMap=e.modifiedShellsMap||new Map;for(const[n,r]of t.modifiedShellsMap){if(e.addShells){if(e.addShells.indexOf(n)>-1)continue}const t=e.modifiedShellsMap.get(n);if(t){if(r.addFaces&&(t.addFaces?t.addFaces.push(...r.addFaces):t.addFaces=r.addFaces),r.deleteFaces){t.deleteFaces=t.deleteFaces||[];for(const e of r.deleteFaces){if(t.addFaces){const n=t.addFaces.indexOf(e);if(n>-1){t.addFaces.splice(n,1);continue}}if(t.deleteFaces.push(e),t.modifiedFaces){const n=t.modifiedFaces.indexOf(e);n>-1&&t.modifiedFaces.splice(n,1)}}}if(r.modifiedFaces){t.modifiedFaces=t.modifiedFaces||[];for(const e of r.modifiedFaces){if(t.addFaces){const n=t.addFaces.indexOf(e);if(n>-1){t.addFaces.splice(n,1);continue}}t.modifiedFaces.indexOf(e)<0&&t.modifiedFaces.push(e)}}}else e.modifiedShellsMap.set(n,r)}}if(t.evolutionMap)if(e.evolutionMap){const n=new Map,r=new Set;for(const[s,i]of e.evolutionMap){const e=new Set;for(const n of i){let s=t.evolutionMap.get(n);s?r.add(n):s=[n],s.forEach((t=>e.add(t)))}n.set(s,Array.from(e))}for(const[e,s]of t.evolutionMap)if(!r.has(e)){const t=n.get(e);t?t.push(...s):n.set(e,s)}e.evolutionMap=n}else e.evolutionMap=new Map(t.evolutionMap)},t.addEvolutionInfo=function(e,t,n){const r=t.tag||t;e.evolutionMap=e.evolutionMap||new Map;let s=e.evolutionMap.get(r);s||(s=[],e.evolutionMap.set(r,s)),s.push(n.tag)}},90471:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.virtualLoopsToFaces=t.detectLoopFromEdges=t.VirtualFace=t.VirtualLoop=void 0;const r=n(98106);function s(e,t=!0){return e.sameDir===t?e.edge.getEndVertex():e.edge.getStartVertex()}function i(e,t){if(!e||!t)return!1;if(s(t,!1)===s(e)&&s(t)===s(e,!1)){if(r.MathAlg.PositionJudge.curveCurveOverlap(e.edge.getCurve(),t.edge.getCurve())===r.MathAlg.CurveCuvePositonType.TOTALLY_OVERLAP)return!0}return!1}function o(e,t,n){let s,i;const o=e.edge.getCurve(),a=o.getRange();if(!n||n<r.Tolerance.LENGTH_EPS){const n=e.sameDir===t?a.min:a.max;s=!0===e.sameDir?o.getTangentAt(n):o.getTangentAt(n).reversed()}else{const r=e.sameDir===t?e.edge.getStartVertex().getPoint():e.edge.getEndVertex().getPoint(),c=e.sameDir===t?a.min+n:a.max-n;i=o.getPtAt(c),s=!0===t?i.subtracted(r):r.subtracted(i)}return s}function a(e,t,n,i){if(!t.length)return;const a=s(e),c=[];for(const e of t)e.getStartVertex()===a&&c.push({edge:e,sameDir:!0}),e.getEndVertex()===a&&c.push({edge:e,sameDir:!1});let l,d=-10;const u=o(e,!1,0).reversed(),h=n.getNormAtPoint(a.getPoint()),g=i?1:-1;for(const t of c){let n=g*u.angleTo(o(t,!0,0),h);if(r.MathUtil.isNearlyZero(n)||r.MathUtil.isNearlyEqual(n,2*Math.PI)||r.MathUtil.isNearlyEqual(n,-2*Math.PI))if(t.edge===e.edge)n=i?0:-2*Math.PI;else{const r=.1,s=o(t,!0,r);n=o(e,!1,r).reversed().angleTo(s,h)>Math.PI?2*Math.PI*g:0}if(r.MathUtil.isNearlyBigger(n,d))l=t,d=n;else if(r.MathUtil.isNearlyEqual(n,d)){const n=.1,r=o(t,!0,n),s=o(l,!0,n),i=o(e,!1,n).reversed();g*i.angleTo(r,h)>g*i.angleTo(s,h)&&(l=t)}}return l}class c{constructor(){this.edges=[],this.bc3ds=[]}add(e,t){this.edges.push({edge:e,bSameDir:t});const n=e.getCurve().clone();t||n.reverse(),this.bc3ds.push(n)}getArea(e){if(void 0===this._area){this.bc2ds=[];for(const t of this.bc3ds)this.bc2ds.push(e.getCurve2d(t));this._area=r.MathAlg.LoopArea.areaOfLoop(this.bc2ds)}return this._area}prepareData(e){this.bc2ds=[],this.box=new r.Box3,this.approxPts=[];for(const t of this.bc3ds)this.bc2ds.push(e.getCurve2d(t)),this.approxPts.push(e.getUVAt(t.getStartPt())),this.approxPts.push(e.getUVAt(t.getEndPt())),this.box.union(t.getBoundingBox())}reverse(){this.edges.forEach((e=>{e.bSameDir=!e.bSameDir})),this.edges.reverse(),this.bc3ds.forEach((e=>{e.reverse()})),this.bc3ds.reverse()}}t.VirtualLoop=c;class l{constructor(e,t){this.loops=e,this.plane=t}outerLoop(){return this.loops[0]}addInnerLoop(e){this.loops.push(e)}}t.VirtualFace=l,t.detectLoopFromEdges=function(e,t,n,r,o){const l=function(e,t,n,r,o){let c={edge:e,sameDir:t};const l=[],d=[];for(;c;){d.push(c),i(l.length?l[l.length-1]:void 0,c)?l.pop():l.push(c);const e=o(s(c));if(!e)break;if(c=a(c,e,n,r),!c)break;if(d.some((e=>e.edge===c.edge&&e.sameDir===c.sameDir)))break}let u=[];for(;l.length>=1;){if(s(l[0],!1)===s(l[l.length-1])){for(;l.length>=2&&i(l[0],l[l.length-1]);)l.splice(0,1),l.pop();u=l.slice();break}l.shift()}if(!u.every((t=>t.edge!==e)))return u}(e,t,n,r,(e=>e.getEdges().filter((e=>o?o.has(e)&&n.containsCurve(e.getCurve()):n.containsCurve(e.getCurve())))));if(l&&l.length)return function(e){const t=new c;for(const n of e)t.add(n.edge,n.sameDir);return t}(l)},t.virtualLoopsToFaces=function(e,t,n=!1){const s=t,i=[];class o{constructor(e){this.loop=e,this.nesting=[],this.level=0}}function a(e,t,n){const r=e.loop.getArea(t)>0,s=r?t:function(e){return e.clone().reverse()}(t),o=e.loop,c=new l([o],s);i.push(c),n.set(o,!0);let d=-1,u=0;for(const s of e.nesting)if(s.level>d&&(d=s.level,u++),!n.get(s.loop))if(2===u)a(s,t,n);else if(1===u){s.loop.getArea(t)>0!==r?(c.addInnerLoop(s.loop),n.set(s.loop,!0)):a(s,t,n)}}let c=function(t,n){e.forEach((e=>e.prepareData(t)));const s=n.map((e=>new o(e)));function i(e,t){for(const n of t.approxPts)if(r.MathAlg.PositionJudge.ptToLoop(n,new r.Loop(e.bc2ds)).type!==r.MathAlg.PtLoopPositonType.IN)return!1;return!0}for(let e=0;e<s.length;++e){const t=s[e];for(let n=0;n<s.length;++n){if(e===n)continue;const r=s[n];i(t.loop,r.loop)&&(t.nesting.push(r),r.level++)}}for(const e of s)e.nesting.sort(((e,t)=>e.level-t.level));return s.filter((e=>0===e.level))}(t,e);if(n){const e=[];c.forEach((t=>{t.loop.getArea(s)>0?e.push(t):t.nesting.forEach((t=>{t.level--,e.push(t)}))})),c=e.filter((e=>0===e.level))}const d=new Map;e.forEach((e=>d.set(e,!1)));for(const e of c)0===e.level&&a(e,s,d);return i}},14785:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShellModelingUtil=void 0;const r=n(98106),s=n(90471);t.ShellModelingUtil=class{static divideFacesIntoCoplanarGroups(e,t=new r.Vector3){const n=(e,t)=>{if(0===t.length)return!1;const n=e.getSurface();for(const s of t){const t=s[0].getSurface();if(r.MathAlg.CalculateOverlap.isSurfacesCoplaner(n,t,r.Tolerance.DEFAULT))return s.push(e),!0}return!1},s=e=>{const n=t.subtracted(e.getOrigin()).dot(e.getNorm());return`${Math.round(1e5*Math.abs(n))}`},i=[],o=new Map;for(const t of e){let e=i;const r=t.getSurface();if(r.isPlane()){const t=s(r);e=o.get(t),e||(e=[],o.set(t,e))}n(t,e)||e.push([t])}return i.push(...Array.from(o.values()).flat()),i}static divideFacesIntoConnectGroups(e,t=!0){let n;n=t?e=>{const t=new Set;return e.getVertexes().forEach((e=>e.getFaces().forEach((e=>t.add(e))))),Array.from(t)}:e=>{const t=new Set;for(const n of e.getWires())n.getCoedge3ds().forEach((e=>e.getTwins().forEach((e=>t.add(e.getFace())))));return Array.from(t)};const r=new Set(e),s=[],i=new Set;for(const t of e){if(i.has(t))continue;const e=this._getFaceGroup(t,n,r);e.forEach((e=>i.add(e))),s.push(Array.from(e))}return s}static detectFacesFromEdges(e,t){const n=new Set(e),i=[],o=new Map;n.forEach((e=>o.set(e,!0)));for(const[e,r]of o)if(r){const r=s.detectLoopFromEdges(e,!0,t,!0,n);if(r&&r.edges.every((e=>o.get(e.edge)))){i.push(r);for(const e of r.edges)o.get(e.edge)&&o.set(e.edge,!1),n.delete(e.edge)}}return r.MathAlg.ILoopsToPolygonExes.execute(i,!0,!1,(e=>{const n=e.bc3ds.map((e=>t.getCurve2d(e)));return new r.Loop(n)}))}static getCoplanarPlane(e){let t;const n=[];for(const t of e)if(t instanceof r.Arc3d){const e=t;n.push(new r.Plane(e.getCoord()))}else t instanceof r.OffsetCurve3d&&t.getBaseCurve()instanceof r.Arc3d&&n.push(new r.Plane(t.getBaseCurve().getCoord()));if(n.length){t=n[0];for(let e=1;e<n.length;e++){if(!n[e].isCoplanar(t))return{plane:void 0,state:-1}}}const s=[];for(const t of e){let e=[];e=t.isNurbsCurve3d()?t.getControlPoints().slice():t.discrete(),e.forEach((e=>{s.every((t=>!t.equals(e)))&&s.push(e)}))}if(t||(t=r.Plane.makePlaneByPoints(s)),t){return s.every((e=>t.containsPoint(e)))?{plane:t,state:1}:{plane:void 0,state:-1}}return{plane:void 0,state:0}}static _getFaceGroup(e,t,n){const r=[],s=new Set;let i=0;for(r.push(e),s.add(e);i<r.length;){const e=r[i];for(const i of t(e))!s.has(i)&&n.has(i)&&(r.push(i),s.add(i));i++}return s}}},28465:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SmoothUtil=void 0;const r=n(98106),s="smooth_poly";t.SmoothUtil=class{static decomposeSmoothPoly(e){const t=[];for(const n of e)if(n instanceof r.SmoothPoly2d||n instanceof r.SmoothPoly3d){n.getSegments().forEach((e=>{e.userData=e.userData||{},e.userData[s]=n,t.push(e)}))}else t.push(n);return t}static hasSmoothInfo(e){return!(!e.userData||void 0===e.userData[s])}static getSmoothInfo(e){if(e.userData&&void 0!==e.userData[s])return e.userData[s]}static clearSmoothInfo(e){e.userData&&(e.userData[s]=void 0)}static isSameSmoothPoly(e,t){return!(!e.userData||void 0===e.userData[s]||!t.userData||void 0===t.userData[s])&&e.userData[s]===t.userData[s]}static copySmoothInfo(e,t){e.userData&&void 0!==e.userData[s]&&(t.userData=t.userData||{},t.userData[s]=e.userData[s])}static updateSmoothVertex(e){if(!e.getSmooth())return;const t=e.getEdges();let n=0;for(let e=0,r=t.length;e<r;e++){t[e].getSmooth()||(n+=1)}2!==n&&0!==n&&e.setSmooth(!1)}static udpateSmoothVertices(e){for(const t of e)this.updateSmoothVertex(t)}}},45759:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(7261),s=n(97510);class i extends s.default{constructor(e,t){super([]),this._edge=e,this._pts=t}_executeImpl(){const e=this._edge.getParent(),t=this._pts.map((t=>e.createVertex(t)));return r.splitEdgeByVertices(this._edge,t),{}}}t.default=i},86067:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BRepVertexEdgeError=t.BRepVertexParentError=t.BRepCurveVertexError=t.BRepCurveNullError=t.BRepEdgeParentError=t.BRepCoedgeEdgeError=t.BRepCoedgeNotConnectedError=t.BRepCoedgePCurveError=t.BRepCoedgeParentError=t.BRepEmptyWireError=t.BRepWireParentError=t.BRepFaceNoSurfaceError=t.BRepEmptyFaceError=t.BRepFaceParentError=t.BRepShellVertexError=t.BRepShellVertexSizeError=t.BRepShellEdgeError=t.BRepShellEdgeSizeError=t.BaseBRepTopoError=t.EN_BREP_INVALID_TYPE=void 0;const r=n(98106),s=n(82742),i=n(70750),o=n(52667),a=n(52928),c=n(40775),l=n(9548),d=n(91343);var u;!function(e){e[e.EN_NULL=0]="EN_NULL",e[e.EN_SHELL_VERTEX_SIZE_ERROR=1]="EN_SHELL_VERTEX_SIZE_ERROR",e[e.EN_SHELL_EDGE_SIZE_ERROR=2]="EN_SHELL_EDGE_SIZE_ERROR",e[e.EN_SHELL_EDGE_ERROR=3]="EN_SHELL_EDGE_ERROR",e[e.EN_SHELL_VERTEX_ERROR=4]="EN_SHELL_VERTEX_ERROR",e[e.EN_FACE_PARENT_ERROR=5]="EN_FACE_PARENT_ERROR",e[e.EN_FACE_NO_WIRE_ERROR=6]="EN_FACE_NO_WIRE_ERROR",e[e.EN_FACE_NO_SURFACE_ERROR=7]="EN_FACE_NO_SURFACE_ERROR",e[e.EN_WIRE_PARENT_ERROR=8]="EN_WIRE_PARENT_ERROR",e[e.EN_WIRE_NO_COEDGE_ERROR=9]="EN_WIRE_NO_COEDGE_ERROR",e[e.EN_COEDGE_PARENT_ERROR=10]="EN_COEDGE_PARENT_ERROR",e[e.EN_COEDGE_CONNECT_ERROR=11]="EN_COEDGE_CONNECT_ERROR",e[e.EN_COEDGE_EDGE_ERROR=12]="EN_COEDGE_EDGE_ERROR",e[e.EN_COEDGE_PCURVE_ERROR=13]="EN_COEDGE_PCURVE_ERROR",e[e.EN_EDGE_PARENT_ERROR=14]="EN_EDGE_PARENT_ERROR",e[e.EN_CURVE_NULL_ERROR=15]="EN_CURVE_NULL_ERROR",e[e.EN_CURVE_VERTEX_ERROR=16]="EN_CURVE_VERTEX_ERROR",e[e.EN_VERTEX_PARENT_ERROR=17]="EN_VERTEX_PARENT_ERROR",e[e.EN_VERTEX_EDGE_ERROR=18]="EN_VERTEX_EDGE_ERROR"}(u=t.EN_BREP_INVALID_TYPE||(t.EN_BREP_INVALID_TYPE={}));class h{constructor(e,t){this._shell=e,this._topoObj=t}getType(){return u.EN_NULL}canFix(){return!0}fix(){}message(){var e,t,n;let u=`${this.constructor.name} - `;for(const h of Object.keys(this)){const g=this[h];if(g instanceof o.Shell);else if(g instanceof s.TopoObject){let r="";g instanceof i.Face?r=g.getSurface().constructor.name:g instanceof l.Edge?r=g.getCurve().constructor.name:g instanceof d.Vertex?r=JSON.stringify(g.getPoint().data.map((e=>Math.round(100*e)/100))):g instanceof c.Coedge3d?r=`F_${null===(e=g.getFace())||void 0===e?void 0:e.getDebugTag()} E_${null===(t=g.getEdge())||void 0===t?void 0:t.getDebugTag()}`:g instanceof a.Wire&&(r=`F_${null===(n=g.getFace())||void 0===n?void 0:n.getDebugTag()}`),u+=`${g.constructor.name} ${g.getDebugTag()} ${r}; `}else g instanceof r.GeoElement&&(u+=`${JSON.stringify(g.dump())}; `)}return u}toString(){return this.message()}}t.BaseBRepTopoError=h;t.BRepShellEdgeSizeError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_SHELL_EDGE_SIZE_ERROR}canFix(){return!1}};t.BRepShellEdgeError=class extends h{constructor(e,t,n){super(e,t),this._shell=e,this._topoObj=t,this._edge=n}getType(){return u.EN_SHELL_EDGE_ERROR}canFix(){return!1}};t.BRepShellVertexSizeError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_SHELL_VERTEX_SIZE_ERROR}canFix(){return!1}};t.BRepShellVertexError=class extends h{constructor(e,t,n){super(e,t),this._shell=e,this._topoObj=t,this._vertex=n}getType(){return u.EN_SHELL_VERTEX_ERROR}canFix(){return!1}};t.BRepFaceParentError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_FACE_PARENT_ERROR}fix(){this._topoObj.setParent(this._shell)}};t.BRepEmptyFaceError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_FACE_NO_WIRE_ERROR}canFix(){return!1}};t.BRepFaceNoSurfaceError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_FACE_NO_SURFACE_ERROR}canFix(){return!1}};t.BRepWireParentError=class extends h{constructor(e,t,n){super(e,t),this._shell=e,this._topoObj=t,this._face=n}getType(){return u.EN_WIRE_PARENT_ERROR}fix(){this._topoObj.setParent(this._face)}};t.BRepEmptyWireError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_WIRE_NO_COEDGE_ERROR}canFix(){return!1}};t.BRepCoedgeParentError=class extends h{constructor(e,t,n){super(e,t),this._shell=e,this._topoObj=t,this._wire=n}getType(){return u.EN_COEDGE_PARENT_ERROR}fix(){this._topoObj.setParent(this._wire)}};t.BRepCoedgePCurveError=class extends h{constructor(e,t,n){super(e,t),this._shell=e,this._topoObj=t,this._pCurve=n}getType(){return u.EN_COEDGE_PCURVE_ERROR}canFix(){return!1}};t.BRepCoedgeNotConnectedError=class extends h{constructor(e,t,n,r){super(e,t),this._shell=e,this._topoObj=t,this._curCoedge=n,this._nxtCoedge=r}getType(){return u.EN_COEDGE_CONNECT_ERROR}canFix(){return!1}};t.BRepCoedgeEdgeError=class extends h{constructor(e,t,n){super(e,t),this._shell=e,this._topoObj=t,this._edge=n}getType(){return u.EN_COEDGE_EDGE_ERROR}canFix(){return!1}};t.BRepEdgeParentError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_EDGE_PARENT_ERROR}fix(){this._topoObj.setParent(this._shell)}};t.BRepCurveNullError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_CURVE_NULL_ERROR}canFix(){return 2===this._topoObj.getFaces().length&&!!this._topoObj.getStartVertex()&&!!this._topoObj.getEndVertex()}fix(){const e=this._topoObj.getFaces().filter((e=>e));if(e.length<2)return;const t=this._topoObj.getStartVertex().getPoint(),n=this._topoObj.getEndVertex().getPoint(),s=r.MathAlg.CalculateIntersect.surfacesNearPoint(e[0].getSurface(),e[1].getSurface(),t,n.subtracted(t));if(!s)return;const i=s.getParamAt(t),o=s.getParamAt(n);i<o?s.setRange(i,o):(s.setRange(o,i),s.reverse()),this._topoObj.setCurve(s)}};t.BRepCurveVertexError=class extends h{constructor(e,t,n){super(e,t),this._shell=e,this._topoObj=t,this._vertex=n}getType(){return u.EN_CURVE_VERTEX_ERROR}canFix(){return!1}};t.BRepVertexParentError=class extends h{constructor(e,t){super(e,t),this._shell=e,this._topoObj=t}getType(){return u.EN_VERTEX_PARENT_ERROR}fix(){this._topoObj.setParent(this._shell)}};t.BRepVertexEdgeError=class extends h{constructor(e,t,n){super(e,t),this._shell=e,this._topoObj=t,this._edge=n}getType(){return u.EN_VERTEX_EDGE_ERROR}canFix(){return!1}}},91859:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DiagnoseShell=void 0;const r=n(98106),s=n(86067);t.DiagnoseShell=class{static execute(e){const t=[],n=new Set,r=new Set;for(const s of e.getFaces())t.push(...this._validateFace(e,s)),s.getEdges().forEach((e=>{n.add(e),r.add(e.getStartVertex()),r.add(e.getEndVertex())}));return n.size!==e.getEdges().length&&t.push(new s.BRepShellEdgeSizeError(e,e)),n.forEach((n=>{e.getEdgeByTag(n.tag)||t.push(new s.BRepShellEdgeError(e,e,n)),t.push(...this._validateEdge(e,n))})),r.size!==e.getVertexs().length&&t.push(new s.BRepShellVertexSizeError(e,e)),r.forEach((n=>{e.getVertexByTag(n.tag)||t.push(new s.BRepShellVertexError(e,e,n)),t.push(...this._validateVertex(e,n))})),t}static validate(e){}static _validateFace(e,t){const n=[];t.getParent()!==e&&n.push(new s.BRepFaceParentError(e,t)),t.getSurface()||n.push(new s.BRepFaceNoSurfaceError(e,t));const r=t.getWires();return r.length||n.push(new s.BRepEmptyFaceError(e,t)),r.forEach((r=>n.push(...this._validateWire(e,t,r)))),n}static _validateWire(e,t,n){const r=[];n.getParent()!==t&&r.push(new s.BRepWireParentError(e,n,t));const i=n.getCoedge3ds();i.length||r.push(new s.BRepEmptyWireError(e,n));for(let o=0;o<i.length;o++){const a=(o+1)%i.length,c=i[o],l=i[a];c.getWire()!==n&&r.push(new s.BRepCoedgeParentError(e,c,n)),c.getEndVertex()!==l.getStartVertex()&&r.push(new s.BRepCoedgeNotConnectedError(e,n,c,l));const d=c.getEdge();d&&1===d.getCoedge3ds().filter((e=>e===c)).length||r.push(new s.BRepCoedgeEdgeError(e,c,d));const u=c.getPCurve();if(u){const n=t.getSurface(),i=n.getPtAt(u.getStartPt()),o=n.getPtAt(u.getEndPt());i.equals(c.getStartVertex().getPoint())&&o.equals(c.getEndVertex().getPoint())||r.push(new s.BRepCoedgePCurveError(e,c,u))}}return r}static _validateEdge(e,t){const n=e.tolerance?e.tolerance+r.Tolerance.EDGE_LENGTH_EPS:r.Tolerance.EDGE_LENGTH_EPS,i=[];t.getParent()!==e&&i.push(new s.BRepEdgeParentError(e,t));const o=t.getStartVertex();1!==o.getEdges().filter((e=>e===t)).length&&i.push(new s.BRepVertexEdgeError(e,o,t));const a=t.getEndVertex();1!==a.getEdges().filter((e=>e===t)).length&&i.push(new s.BRepVertexEdgeError(e,a,t));const c=t.getCurve();return c?(c.getStartPt().equals(o.getPoint(),n)||i.push(new s.BRepCurveVertexError(e,t,o)),c.getEndPt().equals(a.getPoint(),n)||i.push(new s.BRepCurveVertexError(e,t,a))):i.push(new s.BRepCurveNullError(e,t)),i}static _validateVertex(e,t){const n=[];return t.getParent()!==e&&n.push(new s.BRepVertexParentError(e,t)),n}}},50010:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Body=void 0;const r=n(82742);class s extends r.TopoObject{}t.Body=s},11953:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.BrepBody=void 0;const s=n(98106),i=n(52667);let o=class extends i.Shell{isTopoValid(){for(const e of this.getFaces()){if(0===e.getWires().length)return!1;for(const t of e.getWires()){if(0===t.getCoedge3ds().length)return!1;for(const n of t.getCoedge3ds()){if(n.getShell()!==this)return!1;if(n.getWire()!==t)return!1;if(n.getFace()!==e)return!1;if(!n.getEdge())return!1;if(n.getTwins().length<1)return!1;for(const e of n.getTwins())if(-1===e.getTwins().findIndex((e=>e.tag===n.tag)))return!1}}}for(const e of this.getEdges()){if(e.getParent()!==this)return!1;if(e.getCoedge3ds().length<2)return!1;for(const t of e.getCoedge3ds())if(t.getShell()!==this)return!1;if(!e.getStartVertex())return!1;if(!e.getEndVertex())return!1}for(const e of this.getVertexs()){if(e.getParent()!==this)return!1;if(e.getEdges().length<2&&!e.getEdges()[0].getCurve().isPeriodic())return!1}return!0}clone(){return super.clone()}getType(){return s.EN_GEO_ELEMENT_TYPE.EN_BREP_BODY}};o=r([s.registerLoader],o),t.BrepBody=o},40775:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Coedge3d=void 0;const i=n(98106),o=n(82742),a=n(9548);let c=class extends o.TopoObject{constructor(e,t,n){super(),void 0!==e&&void 0!==t&&(this.setEdge(e),this._sameDirWithEdge=t,this._pCurve=n)}getEdgeTag(){return this._edge?this._edge.tag:this._edgeTag}getSameDirWithEdge(){return this._sameDirWithEdge}setSameDirWithEdge(e){this._sameDirWithEdge=e}setEdge(e){this._edge&&this._edge.deleteCoedge3d(this),this._edge=e,this._edgeTag=e.tag,this._edge&&this._edge.addCoedge3d(this)}getStartVertex(){return this._sameDirWithEdge?this._edge.getStartVertex():this._edge.getEndVertex()}getEndVertex(){return this._sameDirWithEdge?this._edge.getEndVertex():this._edge.getStartVertex()}getCurve(){const e=this.getEdge().getCurve().clone();return this._sameDirWithEdge?e:e.reverse()}getPCurve(){return this._pCurve}setPCurve(e){this._pCurve=e}reverse(){this._sameDirWithEdge=!this._sameDirWithEdge}getWire(){return this.getParent()}getFace(){const e=this.getWire();if(e&&e.getParent())return e.getParent()}getShell(){const e=this.getFace();if(e&&e.getParent())return e.getParent()}getEdge(){return this._edge}dispose(){this._edge&&(this._edge.deleteCoedge3d(this),this._edge.getCoedge3ds().length||this._edge.dispose())}isEdgeInfoValid(){return!!this._edge}getIndexInWire(){const e=this.getWire();return e?e.getCoedge3ds().findIndex((e=>e===this)):-1}getPrevCoedge(){const e=this.getWire();if(!e)return;const t=e.getCoedge3ds().findIndex((e=>e===this));return 0===t?e.getCoedge3dByIndex(e.getCoedge3ds().length-1):e.getCoedge3dByIndex(t-1)}getNextCoedge(){const e=this.getWire();if(!e)return;const t=e.getCoedge3ds().findIndex((e=>e===this));return t===e.getCoedge3ds().length-1?e.getCoedge3dByIndex(0):e.getCoedge3dByIndex(t+1)}getStartTangent(){let e;return this.getSameDirWithEdge()?e=this.getEdge().getCurve().getStartTangent():(e=this.getEdge().getCurve().getEndTangent(),e.reverse()),e}getEndTangent(){let e;return this.getSameDirWithEdge()?e=this.getEdge().getCurve().getEndTangent():(e=this.getEdge().getCurve().getStartTangent(),e.reverse()),e}getTwin(){const e=this.getEdge();if(!e)return;const t=e.getOtherCoedge3ds(this);return 0!==t.length?(i.MathAssert.warn(1===t.length,"Multiple twins found"),t[0]):void 0}getTwins(){const e=this.getEdge();return e?e.getOtherCoedge3ds(this):[]}getBoundingBox(){return this.getEdge().getBoundingBox()}getType(){return i.EN_GEO_ELEMENT_TYPE.EN_BREP_COEDGE}dump(){const e=super.dump();return e.eTag=this.getEdgeTag(),e.dir=this._sameDirWithEdge?1:0,this._pCurve&&(e.pCrv=this._pCurve.dump()),e.tag=void 0,e}load({tag:e,flag:t,data:n,eTag:r,dir:s,pCrv:o}){return super.load({tag:e,flag:t,data:n}),this._edgeTag=r,this._sameDirWithEdge=s>0,this._pCurve=o?i.Loader.load(o):void 0,this}tessellate(e,t=i.DiscreteParameter.NORMAL){var n;return{debugInfo:e?{id:this.refId,name:`${this._sameDirWithEdge?"+":"-"}Edge_${null===(n=this.getEdge())||void 0===n?void 0:n.getDebugTag()}`,visible:!0,selectedId:this.getEdge().refId}:void 0}}};c=r([i.registerLoader,s("design:paramtypes",[a.Edge,Boolean,i.Curve2d])],c),t.Coedge3d=c},9548:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Edge=void 0;const i=n(98106),o=n(91343),a=n(82742);let c=class extends a.TopoObject{constructor(e,t,n){super(),this._coedges=[],e&&(this._curve=e),t&&this.setStartVertex(t),n&&this.setEndVertex(n)}getShell(){return this.getParent()}getCurve(){return this._curve}get tolerance(){return this._tol}setCurve(e){this._curve=e}getSmooth(){return void 0!==this._flags&&0!=(1&this._flags)}setSmooth(e){this._flags=this._flags||0,e?this._flags|=1:this._flags&=-2}isDegenerate(){return void 0!==this._flags&&0!=(2&this._flags)}setDegenerateFlag(e=!1){this._flags=this._flags||0,e?this._flags|=2:this._flags&=-3}addCoedge3d(e){this._coedges.push(e)}deleteCoedge3d(e){const t=this._coedges.indexOf(e);t>=0&&this._coedges.splice(t,1)}deleteAllCoedge3ds(){this._coedges=[]}getBoundedCurve(){const e=this._curve.clone(),t=e.getParamAt(this._startVertex.getPoint()),n=e.getParamAt(this._endVertex.getPoint());if(Math.abs(t-n)<i.Tolerance.NUMBER_EPS&&this._curve.isPeriodic()){const n=this._curve.getRange();e.setRange(t,t+n.period)}else e.setRange(t,n);return e}getStartVertexTag(){return this._startVertex?this._startVertex.tag:""}getEndVertexTag(){return this._endVertex?this._endVertex.tag:""}setStartVertex(e){if(this._startVertex){if(this._startVertex===e)return;this._endVertex&&this._startVertex!==this._endVertex&&this._startVertex.deleteEdge(this)}this._startVertex=e,this._startVertex&&this._startVertex.addEdge(this)}setEndVertex(e){if(this._endVertex){if(this._endVertex===e)return;this._startVertex&&this._startVertex!==this._endVertex&&this._endVertex.deleteEdge(this)}this._endVertex=e,this._endVertex&&this._endVertex.addEdge(this)}getAnotherVertex(e){return i.MathAssert.assert(void 0!==e&&(this._startVertex&&this._startVertex.tag===e.tag||this._endVertex&&this._endVertex.tag===e.tag),"Edge.getAnotherVertex: unknown vertex"),this._startVertex&&this._startVertex.tag===e.tag?this._endVertex:this._startVertex}getOtherCoedge3ds(e){return this.getCoedge3ds().filter((t=>t.tag!==e.tag))}getCoedge3ds(){return this._coedges}getFaces(){const e=[];for(const t of this._coedges){const n=t.getFace();n&&e.push(n)}return e}getStartVertex(){return this._startVertex}getEndVertex(){return this._endVertex}dispose(){this.deleteAllCoedge3ds(),this._startVertex&&this._startVertex.deleteEdge(this),this._endVertex&&this._endVertex.deleteEdge(this)}getBoundingBox(){return this._curve.isLine3d()?new i.Box3([this.getStartVertex().getPoint(),this.getEndVertex().getPoint()]):this._curve.getBoundingBox()}updateTolerance(){if(this._startVertex&&this._endVertex){const e=this._curve.getStartPt().sqDistanceTo(this.getStartVertex().getPoint()),t=this._curve.getEndPt().sqDistanceTo(this.getEndVertex().getPoint()),n=e>t?e:t;n>i.Tolerance.LENGTH_EPS2&&(this._tol=Math.sqrt(n))}}discrete(e=i.DiscreteParameter.NORMAL){const t=this._curve.discrete(e);return this._startVertex&&(t[0]=this._startVertex.getPoint().clone()),this._endVertex&&(t[t.length-1]=this._endVertex.getPoint().clone()),t}tessellate(e,t=i.DiscreteParameter.NORMAL){var n,r,s,o;const a=this._curve.tessellate(e,t);return a.debugInfo&&(a.debugInfo.color="#000000"),e?{debugInfo:{id:this.refId,name:`Edge_${this.getDebugTag()}`,visible:!0},children:[a,{debugInfo:{id:-this.refId-1e3,name:`Start_${null===(n=this._startVertex)||void 0===n?void 0:n.getDebugTag()}`,visible:!0,selectedId:null===(r=this.getStartVertex())||void 0===r?void 0:r.refId}},{debugInfo:{id:-this.refId-2e3,name:`End_${null===(s=this._endVertex)||void 0===s?void 0:s.getDebugTag()}`,visible:!0,selectedId:null===(o=this.getEndVertex())||void 0===o?void 0:o.refId}},...this.getFaces().map(((e,t)=>({debugInfo:{id:-this.refId-1e4-t,name:`Face_${null==e?void 0:e.getDebugTag()}`,visible:!0,selectedId:null==e?void 0:e.refId}})))]}:{debugInfo:void 0,children:[a]}}dump(){const e=super.dump();return e.c=this._curve.isLine3d()?void 0:this._curve.dump(),e.sVTag=this._startVertex?this._startVertex.tag:"",e.eVTag=this._endVertex?this._endVertex.tag:"",e}load({tag:e,flag:t,data:n,c:r}){if(super.load({tag:e,flag:t,data:n}),r){const e=i.Loader.load(r);this._curve=e}return this}getType(){return i.EN_GEO_ELEMENT_TYPE.EN_BREP_EDGE}};c=r([i.registerLoader,s("design:paramtypes",[i.Curve3d,o.Vertex,o.Vertex])],c),t.Edge=c},70750:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Face=void 0;const o=n(98106),a=n(52667),c=n(52928),l=n(40775),d=n(82742),u=n(98719);let h=r=class extends d.TopoObject{constructor(e,t,n){super(),this._wireList=[],this._surface=e,this._sameDirWithSurface=t,n&&n.forEach((e=>this.addWire(e)))}static createPlane(e,t,n){const s=[[-1,-1],[1,-1],[1,1],[-1,1]],i=[];for(let e=0;e<s.length;e++){const n=s[e],r=s[(e+1)%s.length];i.push(new o.Line2d({x:n[0]*t,y:n[1]*t},{x:r[0]*t,y:r[1]*t}))}const a=new o.Plane(e);return r.createByBoundary2d(a,[i],!0,n)}static createByBoundary2d(e,t,n,s){const i=t.map((t=>t.map((t=>e.getCurve3d(t)))));return r.createByBoundary(e,t,i,n,s)}static createByBoundary3d(e,t,n,s){const i=t.map((e=>new Array(e.length)));return r.createByBoundary(e,i,t,n,s)}static createByBoundary(e,t,n,r,s){o.MathAssert.assert(t.length===n.length,"loop length should equal");const i=s||new a.Shell,d=[];for(let e=0;e<n.length;e++){const r=new c.Wire,s=n[e],o=t[e],a=s.length,u=new Array(a);for(let e=0;e<a;e++){const t=s[(e+a-1)%a].getEndPt(),n=s[e].getStartPt();u[e]=i.createVertex(t.midTo(n))}for(let t=0;t<n[e].length;t++){const e=i.createEdge(s[t],u[t],u[(t+1)%a]),n=new l.Coedge3d(e,!0);n.setPCurve(o[t]),r.addCoedge3d(n)}d.push(r)}return i.createFace(e,r,d)}setSurface(e){this._surface=e.clone()}getSurface(){return this._surface}setSameDirWithSurface(e){this._sameDirWithSurface=e}getSameDirWithSurface(){return this._sameDirWithSurface}reverse(){this._sameDirWithSurface=!this._sameDirWithSurface}getWires(){return this._wireList}setWires(e){this._wireList.forEach((e=>{e.setParent(void 0)})),this._wireList=e.slice(),this._wireList.forEach((e=>{e.setParent(this)}))}getNormAt(e){const t=this.getSurface().getNormAt(e);return this._sameDirWithSurface?t:t.reverse()}getCenterNorm(){if(this.getSurface().isPlane())return this.getNormAt(o.Vector2.O());const e=this.calcPolygon();return e.isEmpty()?(o.MathAssert.assert(!1,"计算Face的中心点法向失败！"),new o.Vector3):this.getNormAt(e.getCentroidPoint())}getCentroidPoint(){const e=this.calcPolygon();return e.isEmpty()?(o.MathAssert.assert(!1,"计算Face的中心点失败！"),new o.Vector3):this._surface.getPtAt(e.getCentroidPoint())}addWire(e){e.tag||(e.tag=u.BrepUtil.generateShortUUID());const t=e.getFace();t&&t.deleteWire(e),e.setParent(this),this._wireList.push(e)}insertWire(e,...t){t.forEach((e=>{e.tag||(e.tag=u.BrepUtil.generateShortUUID());const t=e.getFace();t&&t.deleteWire(e),e.setParent(this)})),this._wireList.splice(e,0,...t)}deleteWire(e){const t=this._wireList.findIndex((t=>e.tag===t.tag));t>-1&&(this._wireList[t].setParent(void 0),this._wireList.splice(t,1))}deleteAllWires(){this._wireList=[]}getWireByTag(e){if(!this._wireList)return;const t=this._wireList.findIndex((t=>t.tag===e));return t>-1?this._wireList[t]:void 0}deleteWireByTag(e){const t=this._wireList.findIndex((t=>t.tag===e));t>-1&&(this._wireList[t].setParent(void 0),this._wireList.splice(t,1))}getCoedge3ds(){if(this._wireList.length<1)return[];const e=[];for(const t of this._wireList)e.push(...t.getCoedge3ds());return e}getEdges(){const e=new Set;return this.getCoedge3ds().forEach((t=>{const n=t.getEdge();n?e.add(n):o.MathAssert.assert(!1,"Coedge3d对应的Edge为空 !")})),Array.from(e)}getVertexes(){const e=this.getEdges(),t=new Set;for(const n of e){const e=n.getStartVertex(),r=n.getEndVertex();e&&t.add(e),r&&t.add(r)}return[...t.values()]}getTwinFaces(e=!1){const t=new Set;let n=[];return n=e&&this._wireList.length?this._wireList[0].getCoedge3ds().slice():this.getCoedge3ds(),n.forEach((e=>{const n=e.getTwins();for(const e of n){const n=e.getFace();n&&t.add(n)}})),[...t]}getShell(){return this.getParent()}dispose(){this._wireList.forEach((e=>e.dispose())),this.deleteAllWires()}getType(){return o.EN_GEO_ELEMENT_TYPE.EN_BREP_FACE}isEdgeInfoValid(){for(const e of this._wireList)if(!e.isEdgeInfoValid())return!1;return!0}getBoundingBox(e=o.DiscreteParameter.NORMAL,t=o.Tolerance.DEFAULT){const n=this._surface;if(n instanceof o.Plane||n instanceof o.Cone||n instanceof o.Cylinder)return this._wireList[0].getBoundingBox();if(n instanceof o.SweepSurface){const e=n.getPath(),t=n.getProfile();if(e.isLine3d()||t.isLine2d())return this._wireList[0].getBoundingBox()}if(n instanceof o.NurbsSurface){const e=new o.Box3;return n.getControlPoints().forEach((t=>e.expandByPoint(...t))),e}const r=this._getDirectedLoops(),s=o.MathAlg.DiscreteUtil.discreteSurfaceIntoPoints(this._surface,r,e,t);return new o.Box3(s)}discrete(e=o.DiscreteParameter.NORMAL,t=o.Tolerance.DEFAULT){const n=this._getDirectedLoops(),r=o.MathAlg.DiscreteUtil.discreteSurface(this._surface,n,this._sameDirWithSurface,e,t);return r.uvs=o.UvUtil.parseUvInArcLength(r.uvs,this._surface,!1),r}tessellate(e,t=o.DiscreteParameter.NORMAL,n=o.Tolerance.DEFAULT){const r=this.discrete(t,n),s=[{debugInfo:{id:-this.refId,name:"wireList",visible:!0},children:this._wireList.map((t=>t.tessellate(e)))},{debugInfo:{name:this.getSurface().constructor.name,visible:!0}},{debugInfo:{name:this.getSameDirWithSurface()?"同向":"反向",visible:!0}}];return{debugInfo:{id:this.refId,name:`Face_${this.getDebugTag()}`,visible:!0},mesh:r,children:e?s:[]}}calcPolygon(){if(this._wireList.length<1)return new o.Polygon;if(!this.isEdgeInfoValid())return o.MathAssert.assert(!1,"面上有Coedge3d未关联Edge，计算Polygon失败!"),new o.Polygon;const e=new o.Polygon;for(const t of this._wireList)e.addLoop(t.calcLoop(),!1);return e}calcArea(){const e=this.calcPolygon();let t=0;const n=this.getSurface();for(const r of e.getLoops())for(const e of r.getAllCurves()){const r=t=>{const r=e.getPtAt(t),s=e.getDerivatives(t,1)[1];return o.gaussIntegration((e=>{const t=n.firstFundamentalForm({x:r.x,y:e}),s=t[0]*t[2]-t[1]*t[1];return Math.sqrt(s)}),0,r.y,1e-6,1e-6)*s.x},s=e.getRange();t+=o.gaussIntegration(r,s.min,s.max,1e-6,1e-6)}return-t}calcAreaForOutWire(){if(this.getWires().length<1)return 0;const e=this.getWires()[0].calcLoop();let t=0;const n=this.getSurface();for(const r of e.getAllCurves()){const e=e=>{const t=r.getPtAt(e),s=r.getDerivatives(e,1)[1];return o.gaussIntegration((e=>{const r=n.firstFundamentalForm({x:t.x,y:e}),s=r[0]*r[2]-r[1]*r[1];return Math.sqrt(s)}),0,t.y,1e-6,1e-6)*s.x},s=r.getRange();t+=o.gaussIntegration(e,s.min,s.max,1e-6,1e-6)}return-t}dump(){const e=super.dump();return e.dir=this._sameDirWithSurface?1:0,e.s=this._surface.dump(),e.ws=this._wireList.map((e=>{const t=e.dump();return t.type=void 0,t})),e}load({tag:e,flag:t,data:n,dir:r,s:s,ws:i}){return super.load({tag:e,flag:t,data:n}),this.setSameDirWithSurface(r>0),this._surface=o.Loader.load(s),this._wireList=[],i.forEach((e=>{e.type=o.EN_GEO_ELEMENT_TYPE.EN_BREP_WIRE,this.addWire(o.Loader.load(e))})),this}_getDirectedLoops(){return this._wireList.map((e=>e.getCoedge3ds().map((e=>({curve:e.getEdge().getCurve(),pCurve:e.getPCurve(),isSameDirection:e.getSameDirWithEdge(),startPoint:e.getStartVertex().getPoint(),endPoint:e.getEndVertex().getPoint()})))))}};h=r=s([o.registerLoader,i("design:paramtypes",[o.Surface,Boolean,Array])],h),t.Face=h},52667:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.Shell=void 0;const s=n(98106),i=n(82742),o=n(91343),a=n(9548),c=n(70750),l=n(98719);let d=class extends i.TopoObject{constructor(){super(...arguments),this._vTagToVertexMap=new Map,this._eTagToEdgeMap=new Map,this._faceList=[]}isEmpty(){return!this._faceList.length&&!this._eTagToEdgeMap.size}isOnlyPlane(){return this._faceList.every((e=>e.getSurface().isPlane()))}clear(){this._faceList.splice(0),this._vTagToVertexMap.clear(),this._eTagToEdgeMap.clear()}getFaces(){return this._faceList}getEdges(){return[...this._eTagToEdgeMap.values()]}getVertexs(){return[...this._vTagToVertexMap.values()]}get tolerance(){return this._tol}createFace(e,t,n,r){const s=new c.Face(e,t,n);return r&&(s.tag=r),this.addFace(s),s}addFace(e){e.tag||(e.tag=l.BrepUtil.generateShortUUID()),e.setParent(this),this._faceList.push(e)}deleteFace(e){const t=this._faceList.findIndex((t=>t.tag===e.tag));t<0||(e.setParent(void 0),this._faceList.splice(t,1))}deleteFaceByTag(e){const t=this._faceList.findIndex((t=>e===t.tag));t<0||(this._faceList[t].setParent(void 0),this._faceList.splice(t,1))}getFaceByTag(e){return this._faceList.find((t=>e===t.tag))}createLineEdge(e,t){let n;s.MathAssert.assert(e&&t,"Shell createLineEdge()失败，Vertex为空！"),n=e===t?new s.Line3d(e.getPoint(),s.Vector3.X(),[0,0]):new s.Line3d(e.getPoint(),t.getPoint());const r=new a.Edge(n,e,t);return this.addEdge(r),r}createEdge(e,t,n,r){const s=new a.Edge(e,t,n);return r&&(s.tag=r),this.addEdge(s),s}addEdge(e){e.tag||(e.tag=l.BrepUtil.generateShortUUID()),e.setParent(this),this._eTagToEdgeMap.set(e.tag,e)}deleteEdge(e){return this._eTagToEdgeMap.delete(e.tag)}getEdgeByTag(e){return this._eTagToEdgeMap.get(e)}deleteEdgeByTag(e){return this._eTagToEdgeMap.delete(e)}createVertex(e,t){const n=new o.Vertex(e);return t&&(n.tag=t),this.addVertex(n),n}addVertex(e){e.tag||(e.tag=l.BrepUtil.generateShortUUID()),e.setParent(this),this._vTagToVertexMap.set(e.tag,e)}deleteVertex(e){this._vTagToVertexMap.delete(e.tag)}getVertexByTag(e){return this._vTagToVertexMap.get(e)}deleteVertexByTag(e){return this._vTagToVertexMap.delete(e)}updateTolerance(){for(const e of this._eTagToEdgeMap)e[1].tolerance&&e[1].tolerance>0&&(void 0===this._tol||e[1].tolerance>this._tol)&&(this._tol=e[1].tolerance)}isTopoValid(){for(const e of this.getFaces())for(const t of e.getWires())for(const n of t.getCoedge3ds()){if(n.getShell()!==this)return!1;if(n.getWire()!==t)return!1;if(n.getFace()!==e)return!1;if(!n.getEdge())return!1}for(const e of this.getEdges()){if(!e.getCoedge3ds())return!1;if(!e.getCoedge3ds().length)return!1;for(const t of e.getCoedge3ds()){const e=t.getFace();if(this._faceList.findIndex((t=>t===e))<0)return!1}}return!0}isTopoValidBrepBody(){for(const e of this.getFaces()){if(0===e.getWires().length)return!1;for(const t of e.getWires()){if(0===t.getCoedge3ds().length)return!1;for(const n of t.getCoedge3ds()){if(n.getShell()!==this)return!1;if(n.getWire()!==t)return!1;if(n.getFace()!==e)return!1;if(!n.getEdge())return!1;if(n.getTwins().length<1)return!1;for(const e of n.getTwins())if(-1===e.getTwins().findIndex((e=>e.tag===n.tag)))return!1}}}for(const e of this.getEdges()){if(e.getParent()!==this)return!1;if(e.getCoedge3ds().length%2>0)return!1;if(!e.getStartVertex())return!1;if(!e.getEndVertex())return!1}for(const e of this.getVertexs()){if(e.getParent()!==this)return!1;if(e.getEdges().length<2&&!e.getEdges()[0].getCurve().isPeriodic())return!1}return!0}transform(e,t){const n=t||s.Matrix4.make(e,!1).decompose(),r=s.Matrix4.isSvdMirror(n),i=s.Matrix4.isScaleEqual(n.scale);this._vTagToVertexMap.forEach((t=>{t.getPoint().transform(e)}));const o=(e,t,n)=>{const r=e.getPCurve();if(!r)return;if(t.isSphere()&&n.isSphere())return;const i=t.getDomainU(),o=t.getDomainV(),a=n.getDomainU(),c=n.getDomainV(),l=r,d=l.getStartPt(),u=a.getLength()/i.getLength(),h=c.getLength()/o.getLength(),g=(d.x-i.min)*u+a.min;if(t.isCone()){const e=new s.Vector2(g,c.max);l.setOrigin(e);const t=l.getRange().getLength()*u;l.setRange(0,t)}else if(t.isSphere()){let e;Math.abs(d.y-o.max)<s.Tolerance.NUMBER_EPS?e=c.max:Math.abs(d.y-o.min)<s.Tolerance.NUMBER_EPS?e=c.min:(s.MathError.warn(!0,"对于球面，退化点不可能在其他位置"),e=(d.y-o.min)*h+c.min);const t=new s.Vector2(g,e);l.setOrigin(t);const n=l.getRange().getLength()*u;l.setRange(0,n)}else if(t.isSweepSurface()){const e=(d.y-o.min)*h+c.min,t=new s.Vector2(g,e);l.setOrigin(t);const n=l.getRange().getLength()*u;l.setRange(0,n)}};if(!i){for(const t of this._eTagToEdgeMap){const r=t[1].getCurve().transformed(e,n);t[1].setCurve(r)}for(const t of this._faceList){const s=t.getSurface(),i=s.transformed(e,n);t.setSurface(i);for(const e of t.getWires())for(const t of e.getCoedge3ds())o(t,s,i);r&&t.getWires().forEach((e=>e.reverse()))}return this}this._eTagToEdgeMap.forEach((t=>t.getCurve().transform(e,n)));for(const t of this._faceList){const i=t.getSurface(),a=i.clone();if(i.transform(e,n),!s.Matrix4.isOnlyTranslateAndRotate(n.scale)){if(i.isCone()){const e=i.getH();for(const n of t.getWires())for(const t of n.getCoedge3ds()){const n=t.getPCurve();if(!n)continue;const r=n;r.setOrigin({x:r.getOrigin().x,y:e})}}else if(i.isSweepSurface())for(const e of t.getWires())for(const t of e.getCoedge3ds())o(t,a,i);r&&t.getWires().forEach((e=>e.reverse()))}}return this}translate(e){const t=s.Matrix4.makeTranslate({x:e.x,y:e.y,z:e.z||0});return this.transform(t)}rotate(e,t,n){const r=n||{x:0,y:0,z:1},i={x:t.x,y:t.y,z:t.z||0},o=s.Matrix4.makeRotate(i,r,e);return this.transform(o)}scale(e,t={x:0,y:0,z:0}){const n={x:t.x,y:t.y,z:t.z||0},r=s.Matrix4.makeScale(n,e);return this.transform(r)}getBoundingBox(){const e=new s.Box3;return this._faceList.forEach((t=>{e.union(t.getBoundingBox())})),e}tessellate(e,t=s.DiscreteParameter.NORMAL,n=s.Tolerance.DEFAULT){return{debugInfo:e?{id:this.refId,name:this.getType()===s.EN_GEO_ELEMENT_TYPE.EN_BREP_SHELL?"Shell_":`BrepBody_${this.getDebugTag()}`,visible:!0}:void 0,children:[{debugInfo:e?{id:-this.refId-1,name:"vertexList",visible:!0}:void 0,children:this.getVertexs().map((n=>n.tessellate(e,t)))},{debugInfo:e?{id:-this.refId-2,name:"edgeList",visible:!0}:void 0,children:this.getEdges().filter((e=>!e.getSmooth())).map((n=>n.tessellate(e,t)))},{debugInfo:e?{id:-this.refId-3,name:"faceList",visible:!0}:void 0,children:this._faceList.map((r=>r.tessellate(e,t,n)))}]}}clone(){return(new this.constructor).load(this.dump())}getType(){return s.EN_GEO_ELEMENT_TYPE.EN_BREP_SHELL}replaceFaceTag(e,t){const n=this.getFaceByTag(e);n&&(n.tag=t)}replaceEdgeTag(e,t){const n=this.getEdgeByTag(e);n&&(this._eTagToEdgeMap.delete(e),n.tag=t,this._eTagToEdgeMap.set(t,n))}replaceVertexTag(e,t){const n=this.getVertexByTag(e);n&&(this._vTagToVertexMap.delete(e),n.tag=t,this._vTagToVertexMap.set(t,n))}dump(){const e=super.dump();return e.fs=this._faceList.map((e=>{const t=e.dump();return t.type=void 0,t})),e.es=this.getEdges().map((e=>{const t=e.dump();return t.type=void 0,t})),e.vs=this.getVertexs().map((e=>{const t=e.dump();return t.type=void 0,t})),e}load({tag:e,flag:t,data:n,fs:r,es:i,vs:o}){super.load({tag:e,flag:t,data:n});const a=new Map;for(const e of o)e.type=s.EN_GEO_ELEMENT_TYPE.EN_BREP_VERTEX,this.addVertex(s.Loader.load(e));for(const e of i)e.type=s.EN_GEO_ELEMENT_TYPE.EN_BREP_EDGE,this.addEdge(s.Loader.load(e)),a[e.tag]=[e.sVTag,e.eVTag];for(const e of r)e.type=s.EN_GEO_ELEMENT_TYPE.EN_BREP_FACE,this.addFace(s.Loader.load(e));return this._buildTopoRelation(a),this}_buildTopoRelation(e){for(const e of this._faceList)e.getCoedge3ds().forEach((e=>{const t=e.getEdgeTag(),n=this.getEdgeByTag(t);n||s.MathError.assert(n,"Edge not found.",s.MathErrorType.Input,t),e.setEdge(n)}));for(const t of this.getEdges()){const n=e[t.tag],r=this.getVertexByTag(n[0]);s.MathError.assert(r,"Start vertex not found.",s.MathErrorType.Input,n[0]),t.setStartVertex(r);const i=this.getVertexByTag(n[1]);s.MathError.assert(i,"End Vertex not found.",s.MathErrorType.Input,n[1]),t.setEndVertex(i),t.getCurve()||t.setCurve(new s.Line3d(r.getPoint(),i.getPoint()))}}};d=r([s.registerLoader],d),t.Shell=d},82742:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TopoObject=void 0;const r=n(98106),s=n(98719);class i extends r.GeoElement{constructor(){super(),this.refId=i._idGenerator++,this.tag=s.BrepUtil.generateShortUUID()}setParent(e){this._parent=e}getParent(){return this._parent}getFlags(){return this._flags}setFlags(e){this._flags=e}getData(){return this._data}setData(e){this._data=e}getDebugTag(){var e;return(null===(e=this.userData)||void 0===e?void 0:e.debugTag)||this._simpleUUID()}clone(){throw new Error("除了shell和body能clone外，其余topoObject均不可clone")}dump(){return{tag:this.tag,flag:this._flags,data:s.BrepUtil.dumpMapObj(this._data),type:this.getType()}}load({tag:e,flag:t,data:n}){return this.tag=e,this._flags=t,this._data=s.BrepUtil.loadMapObj(n),this}_simpleUUID(e){return e?e.substr(0,8):`${this.tag}`.substr(0,8)}}t.TopoObject=i,i._idGenerator=1},91343:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Vertex=void 0;const i=n(98106),o=n(82742);let a=class extends o.TopoObject{constructor(e){super(),this._point=i.Vector3.O(),this._edges=new Set,e&&(this._point=new i.Vector3(e))}getPoint(){return this._point}setPoint(e){this._point=e}getSmooth(){return void 0!==this._flags&&0!=(1&this._flags)}setSmooth(e){this._flags=this._flags||0,e?this._flags|=1:this._flags&=-2}addEdge(e){this._edges.add(e)}deleteEdge(e){this._edges.delete(e)}getShell(){return this.getParent()}getEdges(){return Array.from(this._edges)}getFaces(){const e=this.getEdges(),t=new Set;for(const n of e)n.getFaces().forEach((e=>{t.add(e)}));return[...t.values()]}getBoundingBox(){return new i.Box3([this._point.toXYZ()])}tessellate(e,t=i.DiscreteParameter.NORMAL){const n={points:[this._point.toArray3()]};return e&&(n.debugInfo={id:this.refId,name:`Vertex_${this.getDebugTag()}`,visible:!1}),n.children=[],n}dump(){const e=super.dump();return e.p=this._point.toArray3(),e}load({p:e,tag:t,flag:n,data:r}){return super.load({tag:t,flag:n,data:r}),this._point=new i.Vector3(e),this}getType(){return i.EN_GEO_ELEMENT_TYPE.EN_BREP_VERTEX}};a=r([i.registerLoader,s("design:paramtypes",[Object])],a),t.Vertex=a},52928:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Wire=void 0;const i=n(98106),o=n(98719),a=n(82742);let c=class extends a.TopoObject{constructor(e){super(),this._coedge3dList=[],e&&e.forEach((e=>this.addCoedge3d(e)))}getFace(){return this.getParent()}deleteCoedge3dAt(e,t=1){const n=Math.min(this._coedge3dList.length-e,t);if(!(n<0)){for(let t=e;t<e+n;t++)this._coedge3dList[t].setParent(void 0);this._coedge3dList.splice(e,n)}}deleteCoedge3d(e){const t=this._coedge3dList.findIndex((t=>t===e));t>-1&&(this._coedge3dList[t].setParent(void 0),this._coedge3dList.splice(t,1))}deleteCoedge3dByTag(e){const t=this._coedge3dList.findIndex((t=>t.tag===e));t>-1&&(this._coedge3dList[t].setParent(void 0),this._coedge3dList.splice(t,1))}addCoedge3d(e){e.tag||(e.tag=o.BrepUtil.generateShortUUID());const t=e.getWire();t&&t.deleteCoedge3d(e),e.setParent(this),this._coedge3dList.push(e)}insertCoedge3d(e,...t){t.forEach((e=>{e.tag||(e.tag=o.BrepUtil.generateShortUUID());const t=e.getWire();t&&t.deleteCoedge3d(e),e.setParent(this)})),this._coedge3dList.splice(e,0,...t)}replaceCoedge3d(e,t){if(!(e<0||e>=this._coedge3dList.length)){this._coedge3dList[e].setParent(void 0);for(const e of t)e.tag||(e.tag=o.BrepUtil.generateShortUUID()),e.setParent(this);this._coedge3dList.splice(e,1,...t)}}getCoedge3ds(){return this._coedge3dList}getCoedge3dByTag(e){if(!this.getCoedge3ds())return;const t=this.getCoedge3ds().findIndex((t=>t.tag===e));return t>-1?this.getCoedge3ds()[t]:void 0}getCoedge3dByIndex(e){if(!(e<0||e>this.getCoedge3ds().length-1))return this.getCoedge3ds()[e];i.MathAssert.assert(!1,"Wire getCoedge3dByIndex(): Out of Range!")}dispose(){for(const e of this._coedge3dList)e.getWire()===this&&e.dispose();this._coedge3dList=[]}isEdgeInfoValid(){for(const e of this._coedge3dList)if(!e.isEdgeInfoValid())return!1;return!0}isValid(){for(let e=0;e<this._coedge3dList.length;e++){const t=this._coedge3dList[e],n=this._coedge3dList[(e+1)%this._coedge3dList.length];if(t.getEndVertex()!==n.getStartVertex())return!1}return!0}reverse(){this._coedge3dList.reverse(),this._coedge3dList.forEach((e=>e.reverse()))}toPath(){return this.getCoedge3ds().map((e=>e.getCurve()))}getBoundingBox(){const e=new i.Box3;return this._coedge3dList.forEach((t=>{e.union(t.getBoundingBox())})),e}isFaceOutWire(){if(!this.getParent())return;return this===this.getParent().getWires()[0]}calcLoop(){const e=this.getParent();i.MathAssert.assert(e);const t=e.getSurface(),n=[],r=new Map;for(const e of this.getCoedge3ds()){const s=e.getPCurve();if(s){n.push(s);continue}if(t.isSweepSurface()&&(t.getPath().isExtendCurve3d()||t.getProfile().isExtendCurve2d())){const s=t.getCurve2ds(e.getCurve());s.length>1&&r.set(s[0],s),n.push(s[0]);continue}const i=t.getCurve2d(e.getCurve());n.push(i)}if(r.size>0)for(let e=0;e<n.length;e++){const t=n[(e-1+n.length)%n.length].getEndPt();if(t.equals(n[e].getStartPt()))continue;const s=r.get(n[e]);if(s)for(const r of s)t.sqDistanceTo(r.getStartPt())<t.sqDistanceTo(n[e].getStartPt())&&n.splice(e,1,r)}const s=this.getCoedge3ds().map((e=>e.getCurve()));return i.SurfaceUtil.unifyCurve2dUVBetweenCurves(s,t,n),new i.Loop(n)}tessellate(e,t=i.DiscreteParameter.NORMAL){return{debugInfo:e?{id:this.refId,name:"wire",visible:!0}:void 0,children:this._coedge3dList.map((n=>n.tessellate(e,t)))}}getType(){return i.EN_GEO_ELEMENT_TYPE.EN_BREP_WIRE}dump(){const e=super.dump();return e.ces=this._coedge3dList.map((e=>{const t=e.dump();return t.type=void 0,t})),e.tag=void 0,e}load({tag:e,flag:t,data:n,ces:r}){return super.load({tag:e,flag:t,data:n}),this._coedge3dList=[],r.forEach((e=>{e.type=i.EN_GEO_ELEMENT_TYPE.EN_BREP_COEDGE,this.addCoedge3d(i.Loader.load(e))})),this}};c=r([i.registerLoader,s("design:paramtypes",[Array])],c),t.Wire=c},96013:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContinuousEdge=void 0;const r=n(98106);t.ContinuousEdge=class{constructor(e,t,n){this._edges=e,this._flags=t,this._refCurve=n}getEdges(){return this._edges}getFlags(){return this._flags}getRefCurve(){return this._refCurve}isClose(){const e=this._edges.length;if(e<=1)return!1;const t=this._flags[0]?this._edges[0].getStartVertex().getPoint():this._edges[0].getEndVertex().getPoint(),n=this._flags[e-1]?this._edges[e-1].getEndVertex().getPoint():this._edges[e-1].getStartVertex().getPoint();return t.equals(n)}getBoundingBox(){const e=new r.Box3;return this._edges.forEach((t=>{e.union(t.getBoundingBox())})),e}getSmoothPoly(){if(!this._edges.length)return;const e=[];e.push(this._flags[0]?this._edges[0].getStartVertex().getPoint():this._edges[0].getEndVertex().getPoint());for(let t=0;t<this._edges.length;t++)e.push(this._flags[t]?this._edges[t].getEndVertex().getPoint():this._edges[t].getStartVertex().getPoint());return new r.SmoothPoly3d(e)}}},36080:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContinuousFace=void 0;t.ContinuousFace=class{constructor(e){this._faces=e}getFaces(){return this._faces}isPlane(){if(!this._faces.length)return!1;const e=this._faces.map((e=>e.getSurface()));return!!e.every((t=>t.isCoplanar(e[0])))}}},70455:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContinuousUtil=void 0;const r=n(96013),s=n(36080),i="$CE_ID",o="$CE_";t.ContinuousUtil=class{static getAllInteractiveEdges(e){const t=e.getEdges().filter((e=>!this.isValidSmoothEdge(e))),n=new Set,r=new Set,s=new Set;for(const e of t){if(s.has(e))continue;const t=this._getContinuousEdges(e);t?(r.add(t),t.getEdges().forEach((e=>s.add(e)))):n.add(e)}return{edges:n,contEdges:r}}static getSmoothCurvesFromWire(e){const t=new Set;e.getCoedge3ds().forEach((e=>t.add(e.getEdge())));const n={getEdges:()=>Array.from(t)},r=this.getAllInteractiveEdges(n),s=[],i=new Set;for(const t of e.getCoedge3ds()){const e=t.getEdge();if(r.edges.has(e))s.push(t.getCurve());else for(const n of r.contEdges){if(i.has(n))continue;const r=n.getEdges().indexOf(e);if(r>-1){const e=n.getSmoothPoly();e&&s.push(n.getFlags()[r]===t.getSameDirWithEdge()?e:e.reverse()),i.add(n);break}}}return s}static isValidSmoothEdge(e){if(!e.getSmooth())return!1;let t=0;for(const n of e.getCoedge3ds())n.getWire()&&n.getFace()&&(t+=1);return 2===t}static getAllInteractiveFaces(e){const t=e.getEdges().filter((e=>this.isValidSmoothEdge(e))),n=new Set;for(const e of t)e.getFaces().filter((e=>e)).forEach((e=>n.add(e)));const r=new Set,s=new Set,i=new Set;for(const e of n){if(i.has(e))continue;const t=this._getContinuousFaces(e);t&&(s.add(t),t.getFaces().forEach((e=>i.add(e))))}for(const t of e.getFaces())i.has(t)||r.add(t);return{faces:r,contFaces:s}}static addContinuousEdgeInfo(e,t){const n=new Map;for(const r of e){const e=t(r);if(!e)continue;let s=n.get(e);if(!s){const t=r.getParent();if(!t)continue;s=this._addContinuousEdge(t,e),n.set(e,s)}this._setContinuousEdgeId(r,s)}}static cloneContinuousEdgeInfo(e,t,n){var r;const s=this._groupEdgesByContinuousEdgeId(e);for(const[e,i]of s){const s=i[0].getParent(),o=null===(r=t(i[0]))||void 0===r?void 0:r.getParent();if(!s||!s.getData()||!o)continue;let a=s.getData()[e];if(!a)continue;a=a.clone(),n&&a.transform(n);const c=this._addContinuousEdge(o,a);i.forEach((e=>{const n=t(e);n&&this._setContinuousEdgeId(n,c)}))}}static transformContinuousEdgeInfo(e,t){const n=this._groupEdgesByContinuousEdgeId(e);for(const[e,r]of n){const n=r[0].getParent();if(!n||!n.getData())continue;const s=n.getData()[e];s&&(n.getData()[e]=s.clone().transform(t))}}static transferContinuousEdgeInfo(e,t,n,r=!0){if(t===n||!t.getData())return;const s=this._groupEdgesByContinuousEdgeId(e);for(const[e,i]of s){const s=t.getData()[e];if(!s)continue;const o=this._addContinuousEdge(n,s.clone());i.forEach((e=>this._setContinuousEdgeId(e,o))),r&&this._removeContinuousEdgeInfo(t,e)}}static removeContinuousEdgeInfo(e){const t=this._groupEdgesByContinuousEdgeId(e);for(const[e,n]of t){const t=n[0].getParent();t&&t.getData()&&(this._removeContinuousEdgeInfo(t,e),n.forEach((e=>this._removeContinuousEdgeId(e))))}}static removeUnusedContinuousEdgeInfo(e){const t=e.getData();if(!t)return;const n=new Map;for(const e in t)e.startsWith(o)&&n.set(e,0);if(n.size<=0)return;const r=e.getEdges();for(const e of r){const t=this._getContinuousEdgeId(e);t&&n.set(t,1)}for(const[e,r]of n)0===r&&delete t[e]}static getContinuousEdgeInfo(e){const t=this._getContinuousEdgeId(e),n=e.getParent();if(t&&n&&n.getData())return n.getData()[t]}static _addContinuousEdge(e,t){const n=this._createContinuousEdgeInfoId(e);let r=e.getData();return r||(r={},e.setData(r)),r[n]=t,n}static _createContinuousEdgeInfoId(e){const t=e.getData();if(!t)return`${o}0`;let n=-1;for(const e in t){if(!e.startsWith(o))continue;const t=parseInt(e.slice(o.length),void 0);!Number.isNaN(t)&&t>n&&(n=t)}return o+(n+1).toString()}static _removeContinuousEdgeInfo(e,t){const n=e.getData();n&&delete n[t]}static _setContinuousEdgeId(e,t){let n=e.getData();n||(n={},e.setData(n)),n[i]=t}static _getContinuousEdgeId(e){const t=e.getData();if(t)return t[i]}static _removeContinuousEdgeId(e){const t=e.getData();t&&t[i]&&delete t[i]}static _groupEdgesByContinuousEdgeId(e){const t=new Map;for(const n of e){const e=this._getContinuousEdgeId(n);if(!e)continue;let r=t.get(e);r||(r=[],t.set(e,r)),r.push(n)}return t}static _getNextContinuousEdge(e,t){const n=t?e.getEndVertex():e.getStartVertex();if(!n.getSmooth())return;const r=n.getEdges().filter((t=>t!==e&&!t.getSmooth()));return 1===r.length?r[0]:void 0}static _getConnectedContinuousEdges(e,t,n){const r=[],s=[];let i=e,o=t;do{const t=this._getNextContinuousEdge(i,o);if(!t||n.has(t)||t===e)break;n.add(t);o=(o?i.getEndVertex():i.getStartVertex())===t.getStartVertex(),r.push(t),s.push(o),i=t}while(i);return{edges:r,flags:s}}static _getContinuousEdges(e){const t=new Set,n=this._getConnectedContinuousEdges(e,!0,t),s=this._getConnectedContinuousEdges(e,!1,t);if(0===n.edges.length&&0===s.edges.length)return;s.edges.reverse(),s.flags=s.flags.map((e=>!e)),s.edges.push(e),s.flags.push(!0);const i=s.edges.concat(n.edges),o=s.flags.concat(n.flags);return new r.ContinuousEdge(i,o,this.getContinuousEdgeInfo(e))}static _getContinuousFaces(e){if(!this._hasSmoothEdgeInFace(e))return;let t=[e];const n=new Set(t),r=new Set;for(;t.length>0;){const e=[];for(let s=0,i=t.length;s<i;s++){const i=t[s],o=this._getNextContinuousFaces(i,n,r);e.push(...o)}t=e}if(0===n.size)return;const i=Array.from(n);return new s.ContinuousFace(i)}static _hasSmoothEdgeInFace(e){return e.getEdges().some((e=>this.isValidSmoothEdge(e)))}static _getNextContinuousFaces(e,t,n){const r=[],s=e.getEdges();for(let i=0,o=s.length;i<o;i++){const o=s[i];if(n.has(o))continue;n.add(o);const a=this._getNextContinuousFace(e,o);a&&!t.has(a)&&(t.add(a),r.push(a))}return r}static _getNextContinuousFace(e,t){if(!t.getSmooth())return;const n=t.getFaces().filter((t=>t&&t!==e));return 1===n.length?n[0]:void 0}}},24099:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContinuousUVComputor=void 0;const r=n(98106),s={x:0,y:0};t.ContinuousUVComputor=class{static tessellateFaces(e,t=!0){if(e.length<=0)return;if(1===e.length)return e[0].tessellate().mesh;let n;t&&(n=this._computeFacesUVMapping(e));const r=[];for(const s of e){const e=this._tesslateFace(s);if(e&&(r.push(e),t)){const t=n.faceUVMapping.get(s);if(!t)continue;this._recalculateMeshUV(s,e,t,n.linear)}}return this._mergeMesh(r)}static _ptToKey(e){return e.map((e=>Math.round(1e6*e).toFixed(0))).join("_")}static _tesslateFace(e){const t=e.tessellate().mesh;if(!t)return;const n=new Map;e.getEdges().filter((e=>e.getSmooth())).forEach((e=>{const t=e.getStartVertex().getPoint().toArray3(),r=e.getEndVertex().getPoint().toArray3(),i=e.getFaces();if(2!==i.length)return;const o=i[0].getNormAt(s),a=i[1].getNormAt(s),c=o.add(a).normalize().toArray3();n.set(this._ptToKey(t),c),n.set(this._ptToKey(r),c)}));for(let e=0;e<t.vertices.length;e++){const r=this._ptToKey(t.vertices[e]),s=n.get(r);s&&(t.normals[e]=s)}return t}static _computeFacesUVMapping(e){const t=new Set;e.slice(0,2).forEach((e=>e.getVertexes().forEach((e=>t.add(e)))));let n=e[0].getEdges().filter((e=>e.getSmooth()));n.push(...e[1].getEdges().filter((e=>e.getSmooth()))),e.length>2&&(n.push(...e[2].getEdges().filter((e=>e.getSmooth()))),e[2].getVertexes().forEach((e=>t.add(e)))),n=Array.from(new Set(n));let r=!1,s=!1,i=!1;if(Array.from(t).every((e=>e.getEdges().filter((e=>e.getSmooth())).length<=2))){const e=n.map((e=>e.getCurve().getDirection()));e.every((t=>t.isParallel(e[0])))?r=!0:s=!0}else i=!0;const o=new Map;return r?this._calCylinderUVRange(e,o):s?this._calConeUVRange(e,o):i&&this._calTorusUVRange(e,o),{faceUVMapping:o,linear:r}}static _calCompressUVRange(e,t,n){let r=t.getCurve().getDirection(),s=!0;const i=e.getSurface(),o=r.dot(i.getCoord().getDx()),a=r.dot(i.getCoord().getDy());Math.abs(o)>Math.abs(a)?o<0&&(r=r.reversed(),s=!1):a<0&&(r=r.reversed(),s=!1);const c=[],l=(e,t,n)=>{let r=t?e.getStartVertex().getEdges():e.getEndVertex().getEdges();return r=r.filter((t=>t!==e&&(t.getStartVertex().getSmooth()||t.getEndVertex().getSmooth())&&t.getFaces().indexOf(n)>-1)),r.length?r[0]:void 0},d=l(t,s,e),u=l(t,!s,e),h=e.getSurface().getNorm(),g=r.cross(h),f=e.getVertexes().some((e=>this._onRefSide(e.getPoint(),t.getStartVertex().getPoint(),g))),p=[];p.push({face:e,refV:r,refN:h,v0:s?t.getStartVertex():t.getEndVertex(),v1:s?t.getEndVertex():t.getStartVertex(),uEdge0:d,uEdge1:u,refVEdge:t,right:f});const _=(e,t,n,r,s,i,o)=>{for(;n&&t&&t.getSmooth();){const a=r===i?n.getEndVertex():n.getStartVertex(),c=t.getFaces().filter((t=>t&&t!==e));if(n=void 0,c.length){e=c[0];const r=a.getEdges().filter((n=>n!==t&&e.getEdges().indexOf(n)>-1));r.length&&o.findIndex((t=>t.face===e))<0&&(n=r[0])}if(n){let c=n.getCurve().getDirection();r=!0,i===(n.getEndVertex()===a)&&(c=c.reversed(),r=!1);const d=l(n,r,e),u=l(n,!r,e);t=i?u:d;const h={face:e,refV:c,refN:e.getSurface().getNorm(),v0:r?n.getStartVertex():n.getEndVertex(),v1:r?n.getEndVertex():n.getStartVertex(),uEdge0:d,uEdge1:u,refVEdge:n,right:s};i?o.push(h):o.unshift(h)}}};_(p[0].face,p[0].uEdge1,t,s,p[0].right,!0,p),_(p[0].face,p[0].uEdge0,t,s,p[0].right,!1,p);let m=0,v=p[m].uEdge0?p[m].uEdge0.getCurve().getLength():0;for(let e=1;e<p.length;e++){const t=p[e].uEdge0?p[e].uEdge0.getCurve().getLength():0;t>v&&(m=e,v=t)}const E=p[m].v0.getPoint().distanceTo(p[m].v1.getPoint());if(p[0].v0===p[p.length-1].v1)for(;m;){const e=p.shift();p.push(e),m--}c.push(p);const P=(e,t,n,r,s,i)=>{do{const o=[];let a=t.getStartVertex().getPoint();const d=i?n.cross(s):s.cross(n),u=e.getEdges().filter((e=>e.getSmooth()&&e!==t)).filter((e=>this._onRefSide(e.getStartVertex().getPoint(),a,d)));if(u.length){t=u[0],a=t.getStartVertex().getPoint();const e=t.getCurve().getDirection();r=!0,e.dot(n)<0?(n=e.reversed(),r=!1):n=e}const h=t.getFaces().filter((e=>e)).filter((t=>t!==e)).filter((e=>e.getVertexes().some((e=>this._onRefSide(e.getPoint(),a,d)))));if(e=h.length&&c.findIndex((e=>e[m].face===h[0]))<0?h[0]:void 0){s=e.getSurface().getNorm();const a=l(t,r,e),d=l(t,!r,e),u={face:e,refV:n,refN:s,v0:r?t.getStartVertex():t.getEndVertex(),v1:r?t.getEndVertex():t.getStartVertex(),uEdge0:a,uEdge1:d,refVEdge:t,right:i};o.push(u),_(o[0].face,o[0].uEdge1,t,r,o[0].right,!0,o),_(o[0].face,o[0].uEdge0,t,r,o[0].right,!1,o),i?c.push(o):c.unshift(o)}}while(e)},y=p[m].refVEdge.getStartVertex()===p[m].v0;P(p[m].face,p[m].refVEdge,p[m].refV,y,p[m].refN,!0),P(p[m].face,p[m].refVEdge,p[m].refV,y,p[m].refN,!1);let C=0;for(const e of c){let t=0;if(1===e.length){const t=e[0].uEdge1?e[0].uEdge1.getCurve().getLength():0;v=Math.max(v,t)}for(const r of e){let e=r.v0,s=r.uEdge0?r.uEdge0.getAnotherVertex(e):e,i=r.v1,o=r.uEdge1?r.uEdge1.getAnotherVertex(i):i;r.right||(s=r.v0,e=r.uEdge0?r.uEdge0.getAnotherVertex(s):s,o=r.v1,i=r.uEdge1?r.uEdge1.getAnotherVertex(o):o);const a=C,c=C+v,l=t,d=t+E,u=[e.getPoint(),s.getPoint(),o.getPoint(),i.getPoint()],h=[[a,l],[c,l],[c,d],[a,d]];n.set(r.face,{pts:u,uvs:h}),t=d}C+=v}}static _calTorusUVRange(e,t){let n;for(const t of e){const e=t.getEdges();if(4===e.length&&e.every((e=>e.getSmooth()))){n=t;break}}if(!n)return;const r=n.getWires()[0].getCoedge3ds(),s=r[0].getEdge(),i=r[1].getEdge(),o=r[2].getEdge(),a=r[3].getEdge(),c=s.getCurve().getLength()-o.getCurve().getLength(),l=i.getCurve().getLength()-a.getCurve().getLength();let d;d=Math.abs(l)<Math.abs(c)?i:s,this._calCompressUVRange(n,d,t)}static _calConeUVRange(e,t){const n=e[0],r=n.getEdges().filter((e=>e.getSmooth()))[0];this._calCompressUVRange(n,r,t)}static _calCylinderUVRange(e,t){const n=e[0],s=n.getEdges().filter((e=>e.getSmooth()))[0];let i=s.getCurve(),o=i.getDirection();const a=n.getSurface(),c=o.dot(a.getCoord().getDx()),l=o.dot(a.getCoord().getDy());Math.abs(c)>Math.abs(l)?c<0&&(o=o.reversed(),i=i.reversed()):l<0&&(o=o.reversed(),i=i.reversed());const d=new Map;let u,h;const g=e=>{let t=d.get(e);return t||(t=o.dot(e.getPoint()),d.set(e,t)),(void 0===h||t<h)&&(h=t),t},f=(e,t,n,s)=>{const i=t.getClosestPoint(e.getPoint()),o=e.getPoint().subtracted(i);let a=o.getLength();r.MathUtil.isNearlyZero(a)||t.getDirection().cross(n).dot(o)<0&&(a=-a);const c=s+a;return(void 0===u||c<u)&&(u=c),c},p=(e,n,s,i,a,c)=>{do{const l=s.getOrigin(),d=c?o.cross(a):a.cross(o),u=e.getEdges().filter((e=>e.getSmooth()&&e!==n)).filter((e=>this._onRefSide(e.getStartVertex().getPoint(),l,d)));if(u.length){n=u[0];const e=r.MathAlg.Distance.pointToCurve3d(n.getStartVertex().getPoint(),s);c?i+=e:i-=e,(s=n.getCurve()).getDirection().isSameDirection(o)||(s=s.reversed())}const h=n.getFaces().filter((e=>e)).filter((t=>t!==e)).filter((e=>e.getVertexes().some((e=>this._onRefSide(e.getPoint(),l,d))))),p=e;if(e=h.length&&!t.get(h[0])?h[0]:void 0){a=e.getSurface().getNorm();const n=this._getTriangleVertexFromFace(e);if(n){const r=n.map((e=>[f(e,s,a,i),g(e)]));t.set(e,{pts:n.map((e=>e.getPoint())),uvs:r})}}else c||p.getVertexes().map((e=>f(e,s,a,i)))}while(e)},_=n.getSurface().getNorm(),m=this._getTriangleVertexFromFace(n),v=m.map((e=>[f(e,i,_,0),g(e)]));if(t.set(n,{pts:m.map((e=>e.getPoint())),uvs:v}),p(n,s,i,0,_,!0),p(n,s,i,0,_,!1),void 0!==u&&void 0!==h)for(const e of t.values())for(const t of e.uvs)t[0]-=u,t[1]-=h}static _recalculateMeshUV(e,t,n,s){if(!s)return this._recalculateMeshUVByInvBilinear(e,t,n);{const e=n.pts,s=n.uvs;if(e.length<3||s.length<3)return!1;const i=e[1].subtracted(e[0]),o=e[2].subtracted(e[0]),a=new r.Vector2(s[0][0],s[0][1]),c=new r.Vector2(s[1][0]-s[0][0],s[1][1]-s[0][1]),l=new r.Vector2(s[2][0]-s[0][0],s[2][1]-s[0][1]),d=i.x*o.y-o.x*i.y,u=i.x*o.z-o.x*i.z,h=i.y*o.z-o.y*i.z;let g;if(r.MathUtil.isNearlyZero(d))if(r.MathUtil.isNearlyZero(u)){if(r.MathUtil.isNearlyZero(h))return!1;g=3}else g=2;else g=1;const f=t=>{const n=t.subtracted(e[0]);let r=1,s=1;return 1===g?(r=(n.x*o.y-o.x*n.y)/d,s=(i.x*n.y-n.x*i.y)/d):2===g?(r=(n.x*o.z-o.x*n.z)/u,s=(i.x*n.z-n.x*i.z)/u):3===g&&(r=(n.y*o.z-o.y*n.z)/h,s=(i.y*n.z-n.y*i.z)/h),a.added(c.multiplied(r).add(l.multiplied(s)))};for(let e=0;e<t.uvs.length;e++){const n=new r.Vector3(t.vertices[e]);t.uvs[e]=f(n).toArray2()}}return!0}static _recalculateMeshUVByInvBilinear(e,t,n){const s=e.getSurface(),i=n.pts,o=n.uvs;if(4!==i.length||4!==o.length)return!1;const a=s.getUVAt(i[0]),c=s.getUVAt(i[1]),l=s.getUVAt(i[3]),d=s.getUVAt(i[2]),u=new r.Vector2(a.x,a.y),h=new r.Vector2(c.x,c.y),g=new r.Vector2(l.x,l.y),f=new r.Vector2(d.x,d.y),p=1e-4,_=new r.InvBilinear(o[0][0],o[1][0],o[0][1],o[2][1],u,h,g,f);for(let e=0;e<t.uvs.length;e++){const n=t.uvs[e],s=new r.Vector2(n[0],n[1]);let i;i=s.equals(u,p)?o[0]:s.equals(h,p)?o[1]:s.equals(g,p)?o[3]:s.equals(f,p)?o[2]:_.solve(s),i&&(t.uvs[e]=i)}return!0}static _mergeMesh(e){if(!e.length)return;const t=e[0];for(let n=1;n<e.length;n++){const r=e[n],s=t.vertices.length;r.vertices.forEach((e=>t.vertices.push(e))),r.normals.forEach((e=>t.normals.push(e))),r.uvs.forEach((e=>t.uvs.push(e))),r.faces.forEach((e=>{t.faces.push([e[0]+s,e[1]+s,e[2]+s])}))}return t}static _getTriangleVertexFromFace(e){const t=e.getVertexes();if(t.length<3)return;const n=[];n.push(t[0]);const s=t[1].getPoint().subtracted(t[0].getPoint());r.MathUtil.isNearlyZero(s.getLength())||n.push(t[1]);for(let e=2;e<t.length;e++){const r=t[e].getPoint().subtracted(t[0].getPoint());if(!s.isParallel(r)){n.push(t[e]);break}}return n}static _onRefSide(e,t,n){return r.MathUtil.isNearlyBigger(n.dot(e.subtracted(t)),0)}}},75434:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContinuousUVComputor=t.ContinuousUtil=t.ContinuousFace=t.ContinuousEdge=void 0;var r=n(96013);Object.defineProperty(t,"ContinuousEdge",{enumerable:!0,get:function(){return r.ContinuousEdge}});var s=n(36080);Object.defineProperty(t,"ContinuousFace",{enumerable:!0,get:function(){return s.ContinuousFace}});var i=n(70455);Object.defineProperty(t,"ContinuousUtil",{enumerable:!0,get:function(){return i.ContinuousUtil}});var o=n(24099);Object.defineProperty(t,"ContinuousUVComputor",{enumerable:!0,get:function(){return o.ContinuousUVComputor}})},3319:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Continuous=t.alg=t.BrepUtil=t.Body=t.BrepBody=t.Shell=t.Wire=t.Face=t.Coedge3d=t.Edge=t.Vertex=void 0;const r=n(74276);t.alg=r;const s=n(75434);t.Continuous=s;var i=n(91343);Object.defineProperty(t,"Vertex",{enumerable:!0,get:function(){return i.Vertex}});var o=n(9548);Object.defineProperty(t,"Edge",{enumerable:!0,get:function(){return o.Edge}});var a=n(40775);Object.defineProperty(t,"Coedge3d",{enumerable:!0,get:function(){return a.Coedge3d}});var c=n(70750);Object.defineProperty(t,"Face",{enumerable:!0,get:function(){return c.Face}});var l=n(52928);Object.defineProperty(t,"Wire",{enumerable:!0,get:function(){return l.Wire}});var d=n(52667);Object.defineProperty(t,"Shell",{enumerable:!0,get:function(){return d.Shell}});var u=n(11953);Object.defineProperty(t,"BrepBody",{enumerable:!0,get:function(){return u.BrepBody}});var h=n(50010);Object.defineProperty(t,"Body",{enumerable:!0,get:function(){return h.Body}});var g=n(98719);Object.defineProperty(t,"BrepUtil",{enumerable:!0,get:function(){return g.BrepUtil}})},98719:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BrepUtil=void 0;const r=n(98106);function s(){return(65536*(1+Math.random())|0).toString(16).substring(1)}const i="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_",{length:o}=i;t.BrepUtil=class{static generateUUID(){return`${s()+s()}-${s()}-${s()}-${s()}-${s()}${s()}${s()}`}static generateShortUUID(){const e=[];for(let t=0;t<8;t++)e.push(i.charAt(Math.floor(Math.random()*o)));return e.join("")}static dumpMapObj(e){let t;if(e){t={};for(const n in e){let r=e[n];try{r=r.dump()}catch(e){}t[n]=r}}return t}static loadMapObj(e){let t;if(e){t={};for(const n in e){let s=e[n];try{s=r.Loader.load(s)}catch(e){}t[n]=s}}return t}}},43035:function(e,t,n){"use strict";n.r(t)},11166:function(e,t,n){"use strict";n.r(t)},76752:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.App=void 0;const a=i(n(16088)),c=n(31667),l=n(16088),d=n(86425),u=n(24540),h=n(22044),g=n(32273),f="view_3d";t.App=class{start(e){this._root=e.root;const t=document.createElement("div");t.classList.add("fullsize"),this._root.appendChild(t);const n=document.createElement("div");n.classList.add("fullsize"),n.id="canvas",t.appendChild(n),n.addEventListener("wheel",(e=>e.preventDefault())),l.app.config("app.common.isGlobal",!1),l.app.config("app.common.color_background",13882323),l.app.config("app.common.color_selection",691438),l.app.config("app.common.color_active",691438),l.app.config("app.common.active_group_is_overlay",!0),l.app.config("app.common.selection_group_is_overlay",!0),l.app.start().then((()=>{const e=a.createIRender(n),t=l.app.createView(f,e,n);l.app.setCurrentView(f);const r=a.app.getMainDoc().create(c.ModelView).modelViewInit(u.createModelViewGrep);t.resetModelView(r)})).then((()=>{a.eventManager.addEventListener(a.EN_EVENT_TYPE.DEBUG_WARN,(({isAssert:e,msg:t})=>{if(e){const e=c.EN_EVENT_TYPE.MESSAGE_NOTICE,t=new c.MessageEvent(e,"system_error");c.eventManager.dispatchEventDelay(t,50)}}))})).then((()=>{setTimeout((()=>{window.coolMethod&&window.coolMethod("获取地图",(e=>{a.app.sendCmd(g.CmdIds.CMD_IMPORT_SCANNER_FILE,e)}),(()=>{alert("获取地图失败")}))}),3e3)})).then((()=>o(this,void 0,void 0,(function*(){a.LogRecorder.customedAdjust.push((e=>{const t=e[e.length-1];t.tp===l.EN_RECORD_TYPE.KEY&&"shift+o"===t.k&&e.pop()}))})))).catch((e=>{}));const r=document.createElement("div");t.appendChild(r),window.location.href.includes("debug=true")&&h.DevGui.getInstance(),d.initUI(r),function(){const e=[{key:"del",func:g.CmdIds.CMD_DELETE_Wall}];a.HotkeyManager.register(e)}()}}},48517:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appConfig=void 0,t.appConfig={common:{click_tolerance:4,dbl_click_interval:300,color_capture:13981141,color_selection:33023,opacity_selection:.4,color_active:59391,opacity_active:.5,color_frozen:11184810,color_edge_frozen:13421772,color_background:15724527,color_grid:15263976,pick_length:15,default_render_zoom_ratio:50,default_style_opacity:1,default_style_text_size:.32,default_style_text_color:0,default_style_point_size:10,default_style_point_color:0,default_style_line_width:1,default_style_line_color:0,default_style_face_color:8421504,default_finish_surface_offset:.002,default_style_ctrlpoint_size:18,default_style_ctrlpoint_color:17596,default_style_ctrlpoint_hover:59391,default_style_snappoint_color:34559,default_style_snappoint_hover:34559,default_style_room_finishsurface_outline:34559,default_style_measure_line:3355443,default_style_rect_model_line:34559,default_style_snap_line_style:{lineColor:43775,lineDotted:!0}},wall:{default_hight:2800,default_thickness:240,allow_translate_reverse:!0,auto_add_wall_when_trans_paralell:!0,auto_generate_floor_on_finish:!0,auto_fresh_floor_on_change:!0,layer2d_z:.15,min_wall_length:.05,min_wall_width:.05,max_wall_width:10,default_low_wall_height:.2,orthogonalTolerance:Math.PI/36},FirstPersonCamera:{height:1.2,fov:60,near:.05,middleDis:1,max_near:5,min_near:.05},OrthogonalCamera:{near:-1e4,far:1e4,orbitRadius:1e3},CommonCamera:{layer2d_z:9e3},joint:{isShow:!1,isCheck:!1}}},67347:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.JointPosCalculator=t.JointTipsCalculator=t.JointEleIdsCalculator=void 0;const s=n(98106),i=n(31667),o=n(66857),a=n(52018),c=n(40948);class l extends i.BaseCalculator{init(e){i.DebugWarn.assert(e instanceof o.DBJoint,"只能计算Joint","",""),this.db=e}getInputPropertyIds(){return[]}getOutputProperty(){return""}execute(){return r(this,void 0,void 0,(function*(){return!0}))}}t.JointEleIdsCalculator=class extends l{getInputPropertyIds(){return[this.db.genPropertyId("markConnect")]}getOutputProperty(){return"CALC_JointEleIds"}execute(){return r(this,void 0,void 0,(function*(){return!!this.db.markConnect&&(this.db.CALC_JointEleIds=this.db.markConnect.split(">").map((e=>parseInt(e))),!0)}))}};t.JointTipsCalculator=class extends l{getInputPropertyIds(){const e=[this.db.genPropertyId("CALC_JointEleIds")];if(this.db.CALC_JointEleIds.length>=2){const t=this.db.getDoc();this.db.CALC_JointEleIds.forEach((n=>{i.PropertyIdUtil.addIdToArrIfExist(t,new i.ElementId(n),"width",e),i.PropertyIdUtil.addIdToArrIfExist(t,new i.ElementId(n),"centerCurve",e)}))}return e}getOutputProperty(){return"CALC_JointTips"}execute(){return r(this,void 0,void 0,(function*(){if(this.db.CALC_JointEleIds.length<2)return!1;const e=this.db.getDoc().getElementById(this.db.id).relativeElementsConnectTypeMap,t=this.db.CALC_JointEleIds.map((e=>this.db.getDoc().getElementById(e))).filter((e=>e));if(t.length<2)return!0;const n=t.map((t=>{const n=e.get(t.id.asInt());return{id:t.id.asInt(),centerCurve:t.getCenterCurve(),width:t.width,connectType:n,startTip:t.startTipCache,endTip:t.endTipCache}})),r=new Map;return c.CalJointedInstanceGRep.excute(n),n.forEach((e=>{r.set(e.id,[e.startTip,e.endTip])})),this.db.CALC_JointTips=r,!0}))}};t.JointPosCalculator=class extends l{getInputPropertyIds(){const e=[this.db.genPropertyId("markConnect")];if(this.db.CALC_JointEleIds.length){const t=this.db.getDoc();this.db.CALC_JointEleIds.forEach((n=>{i.PropertyIdUtil.addIdToArrIfExist(t,new i.ElementId(n),"width",e),i.PropertyIdUtil.addIdToArrIfExist(t,new i.ElementId(n),"centerCurve",e)}))}return e}getOutputProperty(){return"CALC_JointPos"}execute(){return r(this,void 0,void 0,(function*(){const e=this.db.getDoc().getElementById(this.db.id),t=e.getJointNodes().find((t=>t.ele?!t.isMiddle():(i.UniqueElementUtil.getOrCreateUniqueElement(this.db.getDoc(),a.JointMgr).deleteEleInJoint(e,t.id),!1))),n=s.Vector2.O();if(!t)return this.db.CALC_JointPos=n,!0;const{ele:r}=t;if(!r)return this.db.CALC_JointPos=n,!0;const o=r.getCenterCurve();return t.isStart()?this.db.CALC_JointPos=o.getStartPt():t.isEnd()&&(this.db.CALC_JointPos=o.getEndPt()),!0}))}}},28261:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.JEleLoop2dCalculator=t.JEleEndTipCalculator=t.JEleStartTipCalculator=void 0;const s=n(98106),i=n(31667);class o extends i.BaseCalculator{init(e){this.db=e}getInputPropertyIds(){return[]}getOutputProperty(){return""}execute(){return r(this,void 0,void 0,(function*(){return!0}))}}t.JEleStartTipCalculator=class extends o{getInputPropertyIds(){const e=this.db.getDoc(),t=super.getInputPropertyIds();return t.push(this.db.genPropertyId("centerCurve")),t.push(this.db.genPropertyId("width")),i.PropertyIdUtil.addIdToArrIfExist(e,this.db.id,"startJointId",t),this.db.startJointId.isValid()&&(i.PropertyIdUtil.addIdToArrIfExist(e,this.db.startJointId,"CALC_JointEleIds",t),i.PropertyIdUtil.addIdToArrIfExist(e,this.db.startJointId,"CALC_JointTips",t)),t}getOutputProperty(){return"CALC_StartTip"}execute(){return r(this,void 0,void 0,(function*(){const e=this.db.getDoc().getElementById(this.db.startJointId),t=()=>{const e=new s.Line2d(this.db.centerCurve.getStartPt(),this.db.centerCurve.getStartPt().add(this.db.centerCurve.getStartTangent().vecRotated(-s.CONST.PI_2).multiplied(this.db.width/2)));return e.extend(this.db.width/2,!1),this.db.startJointId=i.ElementId.INVALID,new s.PolyCurve([e])};if(e){const n=e.db.CALC_JointEleIds.findIndex((e=>e===this.db.id.asInt())),r=e.db.CALC_JointTips.get(this.db.id.asInt());-1!==n&&r?[this.db.CALC_StartTip]=r:this.db.CALC_StartTip=t()}else this.db.CALC_StartTip=t();return this.db.CALC_StartTip.getAllCurves().length||(this.db.CALC_StartTip=t()),!0}))}};t.JEleEndTipCalculator=class extends o{getInputPropertyIds(){const e=this.db.getDoc(),t=super.getInputPropertyIds();return t.push(this.db.genPropertyId("centerCurve")),t.push(this.db.genPropertyId("width")),i.PropertyIdUtil.addIdToArrIfExist(e,this.db.id,"endJointId",t),this.db.endJointId.isValid()&&(i.PropertyIdUtil.addIdToArrIfExist(e,this.db.endJointId,"CALC_JointEleIds",t),i.PropertyIdUtil.addIdToArrIfExist(e,this.db.endJointId,"CALC_JointTips",t)),t}getOutputProperty(){return"CALC_EndTip"}execute(){return r(this,void 0,void 0,(function*(){const e=this.db.getDoc().getElementById(this.db.endJointId),t=()=>{const{centerCurve:e,width:t}=this.db,n=new s.Line2d(e.getEndPt(),e.getEndPt().add(e.getEndTangent().vecRotated(s.CONST.PI_2).multiplied(t/2)));return n.extend(t/2,!1),this.db.endJointId=i.ElementId.INVALID,new s.PolyCurve([n])};if(e){const n=e.db.CALC_JointEleIds.findIndex((e=>e===this.db.id.asInt())),r=e.db.CALC_JointTips.get(this.db.id.asInt());-1!==n&&r?[,this.db.CALC_EndTip]=r:this.db.CALC_EndTip=t()}else this.db.CALC_EndTip=t();return this.db.CALC_EndTip.getAllCurves().length||(this.db.CALC_EndTip=t()),!0}))}};t.JEleLoop2dCalculator=class extends o{getOutputProperty(){return"CALC_Loop2d"}getInputPropertyIds(){return[this.db.genPropertyId("CALC_StartTip"),this.db.genPropertyId("CALC_EndTip")]}execute(){return r(this,void 0,void 0,(function*(){let e=new s.Loop([...this.db.CALC_StartTip.toPath(),...this.db.CALC_EndTip.toPath()]);return e.isValid()||(e=new s.Loop([...this.db.CALC_StartTip.toPath().reverse(),...this.db.CALC_EndTip.toPath()])),i.DebugWarn.warn(e.isValid(),`连接element loop出现异常!${e.dump()}`,"",""),e.isAnticlockwise()||e.reverse(),this.db.CALC_Loop2d=e,!0}))}}},2907:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.WallGrep3dCalculator=t.WallPoly2dCalculator=t.WallEndTipCalculator=t.WallStartTipCalculator=void 0;const s=n(31667),i=n(28261),o=n(51280),a=n(98106),c=n(3319);class l extends s.BaseCalculator{init(e){s.DebugWarn.assert(e instanceof o.DBWall,"只能计算墙体","",""),this.db=e}getInputPropertyIds(){return[]}getOutputProperty(){return""}execute(){return r(this,void 0,void 0,(function*(){return!0}))}}class d extends i.JEleStartTipCalculator{execute(){const e=Object.create(null,{execute:{get:()=>super.execute}});return r(this,void 0,void 0,(function*(){s.DebugWarn.assert(this.db.centerCurve,"输入参数不合法","","");return yield e.execute.call(this)}))}}t.WallStartTipCalculator=d;class u extends i.JEleEndTipCalculator{execute(){const e=Object.create(null,{execute:{get:()=>super.execute}});return r(this,void 0,void 0,(function*(){s.DebugWarn.assert(this.db.centerCurve,"墙体centerCurve输入参数不合法","","");return yield e.execute.call(this)}))}}t.WallEndTipCalculator=u;class h extends i.JEleLoop2dCalculator{execute(){const e=Object.create(null,{execute:{get:()=>super.execute}});return r(this,void 0,void 0,(function*(){return yield e.execute.call(this)}))}}t.WallPoly2dCalculator=h;t.WallGrep3dCalculator=class extends l{getOutputProperty(){return"CALC_GRep"}getInputPropertyIds(){return[this.db.genPropertyId("centerCurve"),this.db.genPropertyId("CALC_Loop2d")]}execute(){return r(this,void 0,void 0,(function*(){const e=new s.GRep;try{const t=a.Coordinate3.XOY(this.db.bottom),n=new a.Polygon(this.db.CALC_Loop2d.clone());new Map;if(n.calcArea()<1e-4)return!0;const r=c.alg.BodyBuilder.extrude(t,n,a.Vector3.Z(),this.db.bottom,this.db.height),i=new s.GBody(r);return i.edgeList.forEach((e=>{e.canSnap=!0})),e.addNode(i),this.db.CALC_GRep=e,!0}catch(e){return this.db.CALC_GRep=s.GRep.empty,!1}}))}}},45840:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryWall=t.CategoryWall=void 0;const r=n(31667);class s extends r.Category{constructor(){super(...arguments),this._defaultStyle={line:{width:1,color:5263453},face:{color:16777215,polygonOffsetFactor:2,polygonOffset:!0,polygonOffsetUnits:4,materialType:"MeshPhongMaterial"}}}}t.CategoryWall=s,t.categoryWall=new s},52543:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteWallCmd=void 0;const i=n(31667),o=n(34678),a=n(32273);let c=class extends i.Cmd{clearSelection(){return!1}execute(e){return s(this,void 0,void 0,(function*(){if(void 0===e)yield this._deleteSelection();else{const t=this.getCurrentDoc();yield i.transact(t,"delete element",(()=>{t.deleteElementsById(e)}))}}))}_deleteSelection(){return s(this,void 0,void 0,(function*(){const e=i.Selection.getInstance().getSelectedElementIds();if(!e.length)return;const t=this.getCurrentDoc(),n=[];let r=!0;t.getElementsByIds(e).forEach((e=>{e.canBeDeleted()?n.push(e.id):r=!1})),n.length&&(i.Selection.getInstance().clear(),i.HighLight.getInstance().clear(),yield i.transact(t,"删除",(()=>{t.getElementsByIds(e).forEach((e=>{if(e.canBeDeleted()){if(e instanceof o.Wall){const r=t.getElementById(e.startJointId);r&&r.relativeElements.forEach((e=>{e.startJointId.equals(r.id)&&(e.startJointId=i.ElementId.INVALID),e.endJointId.equals(r.id)&&(e.endJointId=i.ElementId.INVALID)}));const s=t.getElementById(e.endJointId);s&&s.relativeElements.forEach((e=>{e.startJointId.equals(s.id)&&(e.startJointId=i.ElementId.INVALID),e.endJointId.equals(s.id)&&(e.endJointId=i.ElementId.INVALID)})),n.push(e.startJointId),n.push(e.endJointId)}}else r=!1})),this.getCurrentDoc().deleteElementsById(...n)})))}))}};c=r([i.registerCmd(a.CmdIds.CMD_DELETE_Wall)],c),t.DeleteWallCmd=c},13289:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DrawWallCmd=t.DrawWallAction=void 0;const i=n(98106),o=n(31667),a=n(16088),c=n(84566),l=n(52018),d=n(95070),u=n(47819),h=n(34678),g=n(32273);class f extends a.DrawLinearElementAction{constructor(e){super(),this.defaultWidth=e,this.width=this.defaultWidth||h.Wall.defaultWidth,this._continuity=!0}getClassName(){return"DrawWallAction"}_onLineFinished(e,t){return s(this,void 0,void 0,(function*(){const{point:n}=e,{point:r}=t,s=this.getIView().getWorkPlane(),{plane:g}=s,f=new i.Line2d(g.getUVAt(n),g.getUVAt(r));return o.transact(a.app.getMainDoc(),"draw wall",(()=>{a.app.getMainDoc().create(h.Wall).init(f,this.width,2800,0);d.JointScheduler.startBatch("recognize_all_joint");const e=o.UniqueElementUtil.getOrCreateUniqueElement(a.app.getMainDoc(),l.JointMgr),t=u.JointUtil.getAllJointElements(c.EN_JOINT_MEMBER.WALL),n=t.length;for(let r=0;r<n;r++){const s=t[r];for(let i=r+1;i<n;i++){const n=t[i];e.fitAddJointEleCurves(c.EN_JOINT_MEMBER.WALL,s,n,{isScale:!1})}}d.JointScheduler.endBatch("recognize_all_joint")})),!0}))}_movePt(e,t){const n=this.getIView(),{plane:r}=n.getWorkPlane(),{point:s}=e,{point:o}=t,a=r.getUVAt(s),c=r.getUVAt(o);if(a.equals(c))return;const l=new i.Line2d(a,c),d=h.Wall.generateTmpGRep(this.width,l,r);this.drawTmpGRep(d,1735416),this._updateView()}}t.DrawWallAction=f,f.MIN_ANGLE=i.MathUtil.degreeToRadius(20);let p=class extends a.Cmd{execute(e){return s(this,void 0,void 0,(function*(){yield this._runAction(new f(e))}))}};p=r([o.registerCmd(g.CmdIds.CMD_DRAW_WALL)],p),t.DrawWallCmd=p},32273:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CmdIds=void 0;const r=n(31667);class s{}s.CMD_IMPORT_SCANNER_FILE="cmd.import.scanner.file",s.CMD_DRAW_WALL="cmd.draw.wall",s.CMD_DELETE_Wall="cmd.delete.wall",s.CMD_SWITCH_VIEW="cmd.switch.view",s.CMD_OPEN_FILE_TEST="cmd.open.new.file.test",s.CMD_ATTACH_MATRIAL="cmd.attach.material",t.CmdIds=Object.assign(Object.assign({},s),r.ModelCmdIds)},66834:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ImportScannerFileCmd=void 0;const i=n(98106),o=n(31667),a=n(16088),c=n(84566),l=n(34678),d=n(52018),u=n(95070),h=n(47819),g=n(297),f=n(32273);let p=class extends a.Cmd{execute(e){return s(this,void 0,void 0,(function*(){let t;if(e)t=JSON.parse(e);else{const e=yield this._runAction(new a.PickFileAction(".txt"));if(e.isCanceled)return;t=o.JsonUtil.parse(e.data.data)}t&&function(e){const t=g.roomBuild2d(e);if(!t)return void alert("当前户型为空");const n=[];for(const e of t.line2d){const t=new i.Line2d;t.load(e),n.push(t)}_(n)}(t)}))}};function _(e){o.transact(a.app.getMainDoc(),"import room",(()=>{for(const t of e)a.app.getMainDoc().create(l.Wall).init(t,l.Wall.defaultWidth,2800,0);u.JointScheduler.startBatch("recognize_all_joint");const t=o.UniqueElementUtil.getOrCreateUniqueElement(a.app.getMainDoc(),d.JointMgr),n=h.JointUtil.getAllJointElements(c.EN_JOINT_MEMBER.WALL),r=n.length;for(let e=0;e<r;e++){const s=n[e];for(let i=e+1;i<r;i++){const e=n[i];t.fitAddJointEleCurves(c.EN_JOINT_MEMBER.WALL,s,e,{isScale:!1})}}u.JointScheduler.endBatch("recognize_all_joint")}))}p=r([o.registerCmd(f.CmdIds.CMD_IMPORT_SCANNER_FILE)],p),t.ImportScannerFileCmd=p},92108:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SwitchViewCmd=void 0;const i=n(31667),o=n(16088),a=n(32273);let c=class extends i.Cmd{execute(){return s(this,void 0,void 0,(function*(){o.app.getCurrentView().getCurrentCamera().getOrbitControllerLockRotation()?o.app.getCurrentView().getCurrentCamera().setOrbitControllerLockRotation(!1):(o.app.getCurrentView().getCurrentCamera().setNamedViewDirection("top"),o.app.getCurrentView().getCurrentCamera().setOrbitControllerLockRotation(!0))}))}};c=r([i.registerCmd(a.CmdIds.CMD_SWITCH_VIEW)],c),t.SwitchViewCmd=c},86425:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.initUI=void 0;const s=r(n(67294)),i=n(73935),o=n(94803);class a extends s.default.Component{componentWillMount(){}render(){return s.default.createElement(s.default.Fragment,null,s.default.createElement(o.SideBar,null))}}t.initUI=function(e){i.render(s.default.createElement(a,null),e)}},94803:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SideBar=void 0;const s=n(16088),i=r(n(67294)),o=(n(52543),n(13289),n(32273));n(66834),n(92108),r(n(24334));n(43035),window.location.href.includes("debug=true");class a extends i.default.Component{render(){return i.default.createElement("div",{className:"sidebar"},this.getCmdItems().map(this.renderItem))}renderItem(e){return i.default.createElement("div",{key:e.cmdId,className:"cmd-item",onClick:e.onClick},e.name)}getCmdItems(){return[{cmdId:o.CmdIds.CMD_IMPORT_SCANNER_FILE,name:"导入扫描文件",onClick:e=>{s.app.sendCmd(o.CmdIds.CMD_IMPORT_SCANNER_FILE)}},{cmdId:o.CmdIds.CMD_DRAW_WALL,name:"画墙",onClick:e=>{s.app.sendCmd(o.CmdIds.CMD_DRAW_WALL,120)}},{cmdId:o.CmdIds.CMD_DELETE_Wall,name:"删除选中墙体",onClick:e=>{s.app.sendCmd(o.CmdIds.CMD_DELETE_Wall)}},{cmdId:o.CmdIds.CMD_SWITCH_VIEW,name:"切换视图",onClick:e=>{s.app.sendCmd(o.CmdIds.CMD_SWITCH_VIEW)}},{cmdId:o.CmdIds.CMD_UNDO,name:"撤销",onClick:e=>{s.app.sendCmd(o.CmdIds.CMD_UNDO)}},{cmdId:o.CmdIds.CMD_REDO,name:"恢复",onClick:e=>{s.app.sendCmd(o.CmdIds.CMD_REDO)}}]}}t.SideBar=a},24540:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createModelViewGrep=t.addGrid=void 0;const r=n(31667);t.addGrid=function(e){const t=100,n=5e4,s=[];for(let e=-100;e<=t;e++){const t=new r.math.Vector3(500*e,0,0),i=new r.math.Line3d(t,r.math.Vector3.Y(),[-5e4,n]);s.push(i)}for(let e=-100;e<=t;e++){const t=new r.math.Vector3(0,500*e,0),i=new r.math.Line3d(t,r.math.Vector3.X(),[-5e4,n]);s.push(i)}s.forEach((t=>{const n=new r.GCurve3d(t).setStyle({line:{color:14803687}});n.canGpuPick=!1,e.addNode(n)}))},t.createModelViewGrep=function(e,t,n,s=r.math.Vector3.O()){!function(e,t,n,s,i){if(!t)return;const o=i||r.math.Vector3.O(),a=[],c=500,l=n?n.getPtAt(o.clone()):o.clone(),d=n?n.getPtAt(o.translated({x:c,y:0,z:0})):o.translated({x:c,y:0,z:0}),u=new r.math.Line3d(l,d),h=n?n.getPtAt(o.translated({x:0,y:c,z:0})):o.translated({x:0,y:c,z:0}),g=new r.math.Line3d(l,h),f=n?n.getPtAt(o.translated({x:0,y:0,z:c})):o.translated({x:0,y:0,z:c}),p=new r.math.Line3d(l,f);if(a.push(new r.GCurve3d(u).setStyle({line:{color:16711680,depthWrite:!1}})),a.push(new r.GCurve3d(g).setStyle({line:{color:65280,depthWrite:!1}})),a.push(new r.GCurve3d(p).setStyle({line:{color:255,depthWrite:!1}})),a.push(new r.GText3d("X",d.added(new r.math.Vector3(50,0,0))).setStyle({text:{color:16711680,nostroke:!0,size:.2}})),a.push(new r.GText3d("Y",h.added(new r.math.Vector3(0,50,0))).setStyle({text:{color:65280,nostroke:!0,size:.2}})),a.push(new r.GText3d("Z",f.added(new r.math.Vector3(0,0,50))).setStyle({text:{color:255,nostroke:!0,size:.2}})),!s){const e=new r.math.Line3d(new r.math.Vector3,new r.math.Vector3(-500,0,0));a.push(new r.GCurve3d(e).setStyle({line:{color:16711680,dotted:!0,depthWrite:!1}}));const t=new r.math.Line3d(new r.math.Vector3,new r.math.Vector3(0,-500,0));a.push(new r.GCurve3d(t).setStyle({line:{color:65280,dotted:!0,depthWrite:!1}}));const n=new r.math.Line3d(new r.math.Vector3,new r.math.Vector3(0,0,-500));a.push(new r.GCurve3d(n).setStyle({line:{color:255,dotted:!0,depthWrite:!1}}))}for(const t of a)t.canGpuPick=!1,e.addNode(t)}(e,n,void 0,!0,s)}},66857:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBJoint=void 0;const r=n(98106),s=n(31667);class i extends s.DBElement{constructor(){super(...arguments),this.type=0,this.markConnect="",this.isShow=!1,this.CALC_JointEleIds=[-1],this.CALC_JointTips=new Map,this.CALC_JointPos=r.Vector2.make({x:0,y:0})}}t.DBJoint=i},51280:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBWall=void 0;const r=n(31667),s=n(98106);class i extends r.DBElement{constructor(){super(...arguments),this.centerCurve=new s.Line2d({x:0,y:0},{x:1,y:0},[0,0]),this.width=120,this.height=2800,this.bottom=0,this.startJointId=r.ElementId.INVALID,this.endJointId=r.ElementId.INVALID,this.CALC_Loop2d=new s.Loop,this.CALC_StartTip=new s.PolyCurve,this.CALC_EndTip=new s.PolyCurve}}t.DBWall=i},22044:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.DevGui=void 0;const o=i(n(84376)),a=i(n(16088)),c=(n(31667),n(58844)),l=n(44988),d=n(32273),u=n(92960);class h{static getInstance(){return this._instance||(this._gui=this.createGUI(),h._init(this._gui)),this._instance}static createGUI(e){this._guiWrapper||(this._guiWrapper=document.createElement("div"),Object.assign(this._guiWrapper.style,{position:"absolute",width:"320px",zIndex:9999,right:0}),document.body.appendChild(this._guiWrapper),l.makeDomDraggable(this._guiWrapper));const t=new o.GUI({width:300});e&&t.addFolder(e);const{style:n}=t.domElement;return Object.assign(n,{userSelect:"none",position:"absolute"}),t.domElement.parentElement&&(t.domElement.parentElement.style.zIndex="100"),this._guiStack.forEach((e=>e.domElement.style.display="none")),this._guiWrapper.appendChild(t.domElement),this._guiStack.push(t),t}static destroyGUI(e){if(e){const t=this._guiStack.findIndex((t=>t===e));t>=0&&(this._guiStack.splice(t,1),e.domElement.remove())}this._guiStack.forEach(((e,t)=>{t===this._guiStack.length-1?e.domElement.style.display="":e.domElement.style.display="none"}))}static _init(e){!function(e){const t=e.addFolder("文件");l.addCmdButton(t,"保存到磁盘",a.PlatformCmdIds.CMD_SAVE_FILE_TO_LOCAL,"",!0),l.addCmdButton(t,"从磁盘打开",d.CmdIds.CMD_OPEN_FILE_TEST,""),l.addCmdButton(t,"测试导入str",d.CmdIds.CMD_IMPORT_SCANNER_FILE,"",'{"origin":{"x":0,"y":0,"z":0},"pointcloud":[{"x":-2,"y":0},{"x":-1.9,"y":0},{"x":-1.85,"y":-0.05},{"x":-1.8,"y":0},{"x":-1.75,"y":0},{"x":-1.75,"y":-0.05},{"x":-1.65,"y":-0.05},{"x":-1.6,"y":0},{"x":-1.55,"y":0},{"x":-1.5,"y":0},{"x":-1.45,"y":0},{"x":-1.3499999999999999,"y":-0.05},{"x":-1.35,"y":0},{"x":-1.3499999999999999,"y":0},{"x":-1.2,"y":0},{"x":-1.0499999999999998,"y":0},{"x":-1.1,"y":0},{"x":-1.0499999999999998,"y":0},{"x":-1,"y":0},{"x":-0.95,"y":0},{"x":-0.8999999999999999,"y":0},{"x":-0.8499999999999999,"y":0},{"x":-0.7999999999999998,"y":0},{"x":-0.75,"y":0},{"x":-0.7,"y":0},{"x":-0.6499999999999999,"y":0},{"x":-0.44999999999999996,"y":0},{"x":-0.3999999999999999,"y":0},{"x":-0.34999999999999987,"y":0},{"x":-0.2999999999999998,"y":0},{"x":-0.25,"y":0},{"x":-0.1499999999999999,"y":0},{"x":-0.09999999999999987,"y":0},{"x":-0.04999999999999982,"y":0},{"x":-0.05,"y":-0.15000000000000002},{"x":0,"y":0},{"x":0,"y":0.05},{"x":-0.05,"y":0.1},{"x":0,"y":0.15000000000000002},{"x":0,"y":0.2},{"x":0,"y":0.25},{"x":0,"y":0.30000000000000004},{"x":0,"y":0.35000000000000003},{"x":0,"y":0.4},{"x":0,"y":0.45},{"x":0,"y":0.5},{"x":0,"y":0.55},{"x":0,"y":0.6000000000000001},{"x":0,"y":0.8},{"x":-0.05,"y":0.9000000000000001},{"x":0,"y":0.9},{"x":0,"y":0.9500000000000001},{"x":0,"y":1.05},{"x":0,"y":1.1},{"x":0,"y":1.1500000000000001},{"x":0.05,"y":1.2},{"x":0,"y":1.3},{"x":0,"y":1.35},{"x":0.05,"y":1.4500000000000002},{"x":0,"y":1.55},{"x":0.05,"y":1.6},{"x":0,"y":1.6500000000000001},{"x":0,"y":1.7000000000000002},{"x":0,"y":1.75},{"x":0,"y":1.8},{"x":0,"y":1.85},{"x":0,"y":1.9500000000000002},{"x":0,"y":2},{"x":0,"y":2.1},{"x":0,"y":2.1},{"x":0,"y":2.15},{"x":0,"y":2.2},{"x":0,"y":2.25},{"x":-0.05,"y":2.35},{"x":0,"y":2.35},{"x":0,"y":2.45},{"x":0,"y":2.55},{"x":0,"y":2.6500000000000004},{"x":0,"y":2.7},{"x":0,"y":2.75},{"x":0.05,"y":2.85},{"x":0.05,"y":2.85},{"x":0,"y":2.9000000000000004},{"x":0,"y":2.95},{"x":0.05,"y":3},{"x":-0.05,"y":3.1},{"x":0,"y":3.1500000000000004},{"x":0,"y":3.2},{"x":0.05,"y":3.2},{"x":-0.05,"y":3.3000000000000003},{"x":0,"y":3.35},{"x":0,"y":3.4000000000000004},{"x":0.05,"y":3.45},{"x":0,"y":3.5},{"x":0,"y":3.5000000000000004},{"x":-0.05,"y":3.5500000000000003},{"x":0,"y":3.6500000000000004},{"x":-0.05,"y":3.7},{"x":0,"y":3.85},{"x":0,"y":3.85},{"x":0,"y":3.9000000000000004},{"x":0,"y":3.95},{"x":-0.05,"y":4.05},{"x":0,"y":4.1},{"x":0,"y":4.1000000000000005},{"x":0,"y":4.2},{"x":0,"y":4.25},{"x":0,"y":4.3},{"x":-0.05,"y":4.300000000000001},{"x":0,"y":4.4},{"x":0,"y":4.45},{"x":0,"y":4.55},{"x":0,"y":4.6000000000000005},{"x":0,"y":4.65},{"x":0,"y":4.75},{"x":0,"y":4.800000000000001},{"x":0,"y":4.8500000000000005},{"x":0,"y":4.9},{"x":0,"y":4.95},{"x":0,"y":5},{"x":0,"y":5.05},{"x":-0.05,"y":5},{"x":-0.1,"y":5},{"x":-0.15000000000000002,"y":5},{"x":-0.2,"y":5},{"x":-0.25,"y":5},{"x":-0.30000000000000004,"y":5},{"x":-0.35000000000000003,"y":5},{"x":-0.35000000000000003,"y":4.95},{"x":-0.45,"y":5},{"x":-0.5,"y":5},{"x":-0.55,"y":5},{"x":-0.7000000000000001,"y":5},{"x":-0.75,"y":5},{"x":-0.8500000000000001,"y":5},{"x":-0.75,"y":5},{"x":-0.9,"y":5},{"x":-1,"y":4.95},{"x":-1,"y":5},{"x":-1.05,"y":5},{"x":-1.1,"y":5},{"x":-1.1500000000000001,"y":5},{"x":-1.2000000000000002,"y":5},{"x":-1.35,"y":5},{"x":-1.25,"y":4.9},{"x":-1.4000000000000001,"y":5},{"x":-1.4500000000000002,"y":5},{"x":-1.5,"y":5},{"x":-1.6,"y":5},{"x":-1.6,"y":5},{"x":-1.6500000000000001,"y":5},{"x":-1.7000000000000002,"y":5},{"x":-1.75,"y":5},{"x":-1.8,"y":5},{"x":-1.85,"y":5},{"x":-1.85,"y":4.95},{"x":-1.9500000000000002,"y":5},{"x":-2,"y":5},{"x":-2.0500000000000003,"y":4.95},{"x":-2.1,"y":5},{"x":-2.1999999999999997,"y":5.05},{"x":-2.2,"y":5.05},{"x":-2.35,"y":5},{"x":-2.4000000000000004,"y":4.95},{"x":-2.45,"y":5},{"x":-2.5,"y":5},{"x":-2.5000000000000004,"y":5.05},{"x":-2.65,"y":4.95},{"x":-2.75,"y":4.95},{"x":-2.7,"y":5},{"x":-2.8000000000000003,"y":5},{"x":-2.85,"y":5},{"x":-2.95,"y":5},{"x":-3.05,"y":5},{"x":-3.0500000000000003,"y":5},{"x":-3.1500000000000004,"y":5},{"x":-3.3,"y":5},{"x":-3.3000000000000003,"y":4.95},{"x":-3.4000000000000004,"y":5.05},{"x":-3.5,"y":5},{"x":-3.55,"y":4.95},{"x":-3.6,"y":5},{"x":-3.6500000000000004,"y":5},{"x":-3.7,"y":5},{"x":-3.8,"y":5},{"x":-3.85,"y":5},{"x":-3.9000000000000004,"y":5},{"x":-3.9000000000000004,"y":5.05},{"x":-4,"y":5},{"x":-4,"y":5},{"x":-4,"y":4.95},{"x":-4,"y":4.9},{"x":-3.95,"y":4.85},{"x":-4,"y":4.8},{"x":-4,"y":4.75},{"x":-4,"y":4.7},{"x":-4,"y":4.6},{"x":-4,"y":4.55},{"x":-4,"y":4.5},{"x":-4.05,"y":4.5},{"x":-4,"y":4.4},{"x":-4.05,"y":4.35},{"x":-4,"y":4.25},{"x":-4,"y":4.2},{"x":-4,"y":4.2},{"x":-4.05,"y":4.05},{"x":-4,"y":4.05},{"x":-4,"y":4},{"x":-4,"y":4},{"x":-4.2,"y":4},{"x":-4.25,"y":4},{"x":-4.3,"y":4},{"x":-4.3999999999999995,"y":4.05},{"x":-4.4,"y":4},{"x":-4.45,"y":4},{"x":-4.5,"y":4},{"x":-4.55,"y":4},{"x":-4.55,"y":3.95},{"x":-4.7,"y":4},{"x":-4.75,"y":4},{"x":-4.85,"y":4},{"x":-4.9,"y":4},{"x":-4.9,"y":4.05},{"x":-5,"y":4},{"x":-5,"y":4},{"x":-5,"y":4},{"x":-5,"y":3.9},{"x":-5,"y":3.85},{"x":-5,"y":3.7},{"x":-5,"y":3.65},{"x":-5,"y":3.6},{"x":-5.05,"y":3.55},{"x":-5,"y":3.5},{"x":-5,"y":3.45},{"x":-5,"y":3.4},{"x":-5,"y":3.35},{"x":-5,"y":3.3},{"x":-4.95,"y":3.2},{"x":-5,"y":3.15},{"x":-5,"y":3.1},{"x":-5,"y":3.05},{"x":-5.05,"y":2.95},{"x":-5,"y":2.95},{"x":-5,"y":2.9},{"x":-5,"y":2.8499999999999996},{"x":-5,"y":2.75},{"x":-5,"y":2.75},{"x":-5.1,"y":2.6999999999999997},{"x":-5,"y":2.55},{"x":-5,"y":2.5},{"x":-4.95,"y":2.45},{"x":-5,"y":2.3499999999999996},{"x":-5,"y":2.3},{"x":-4.95,"y":2.1500000000000004},{"x":-5,"y":2.1999999999999997},{"x":-5,"y":2.0999999999999996},{"x":-5,"y":2.05},{"x":-5,"y":2},{"x":-5,"y":1.8999999999999997},{"x":-5.05,"y":1.8499999999999999},{"x":-5,"y":1.85},{"x":-5,"y":1.7999999999999998},{"x":-5,"y":1.75},{"x":-5,"y":1.6999999999999997},{"x":-5,"y":1.65},{"x":-4.95,"y":1.6499999999999997},{"x":-5,"y":1.65},{"x":-5,"y":1.5},{"x":-5,"y":1.4499999999999997},{"x":-4.95,"y":1.3999999999999997},{"x":-5.05,"y":1.2999999999999998},{"x":-5,"y":1.3},{"x":-5,"y":1.1999999999999997},{"x":-5.05,"y":1.0999999999999999},{"x":-5,"y":1.0499999999999996},{"x":-5,"y":1.0499999999999998},{"x":-5.05,"y":1},{"x":-5,"y":1},{"x":-5.05,"y":1},{"x":-5.1,"y":1},{"x":-5.15,"y":1},{"x":-5.25,"y":1},{"x":-5.3,"y":1},{"x":-5.3999999999999995,"y":1},{"x":-5.4,"y":1},{"x":-5.4,"y":1},{"x":-5.5,"y":1},{"x":-5.55,"y":1},{"x":-5.6,"y":1},{"x":-5.6000000000000005,"y":1},{"x":-5.7,"y":1},{"x":-5.75,"y":1},{"x":-5.7,"y":0.95},{"x":-5.75,"y":0.95},{"x":-5.75,"y":0.9},{"x":-5.75,"y":0.8},{"x":-5.7,"y":0.75},{"x":-5.75,"y":0.7},{"x":-5.75,"y":0.6499999999999999},{"x":-5.75,"y":0.6},{"x":-5.8,"y":0.55},{"x":-5.75,"y":0.44999999999999996},{"x":-5.8,"y":0.35},{"x":-5.7,"y":0.4499999999999999},{"x":-5.75,"y":0.2},{"x":-5.8,"y":0.19999999999999996},{"x":-5.75,"y":0.1499999999999999},{"x":-5.75,"y":0.09999999999999998},{"x":-5.75,"y":0.04999999999999993},{"x":-5.75,"y":0},{"x":-5.8,"y":-0.15000000000000008},{"x":-5.8,"y":-0.15000000000000013},{"x":-5.75,"y":-0.20000000000000018},{"x":-5.8,"y":-0.3},{"x":-5.7,"y":-0.35000000000000003},{"x":-5.7,"y":-0.3000000000000001},{"x":-5.75,"y":-0.40000000000000013},{"x":-5.8,"y":-0.5},{"x":-5.75,"y":-0.5},{"x":-5.7,"y":-0.5},{"x":-5.65,"y":-0.45},{"x":-5.55,"y":-0.55},{"x":-5.4,"y":-0.45},{"x":-5.35,"y":-0.55},{"x":-5.3,"y":-0.5},{"x":-5.25,"y":-0.5},{"x":-5.2,"y":-0.5},{"x":-5.1000000000000005,"y":-0.45},{"x":-5.1,"y":-0.5},{"x":-5.05,"y":-0.5},{"x":-5,"y":-0.5},{"x":-4.95,"y":-0.5},{"x":-4.95,"y":-0.5},{"x":-4.85,"y":-0.5},{"x":-4.8,"y":-0.5},{"x":-4.75,"y":-0.5},{"x":-4.7,"y":-0.5},{"x":-4.625,"y":-0.5},{"x":-4.625,"y":-0.45},{"x":-4.625,"y":-0.35},{"x":-4.625,"y":-0.3},{"x":-4.625,"y":-0.25},{"x":-4.625,"y":-0.19999999999999996},{"x":-4.525,"y":2.7755575615628914e-17},{"x":-4.625,"y":-0.04999999999999999},{"x":-4.625,"y":0},{"x":-4.625,"y":0},{"x":-4.575,"y":0},{"x":-4.525,"y":0},{"x":-4.475,"y":0},{"x":-4.425,"y":0},{"x":-4.375,"y":0},{"x":-4.325,"y":0},{"x":-4.2250000000000005,"y":0},{"x":-4.225,"y":0},{"x":-4.175,"y":0},{"x":-3.975,"y":0},{"x":-3.875,"y":0},{"x":-3.825,"y":0},{"x":-3.775,"y":0},{"x":-4,"y":0.75},{"x":-3.9000000000000004,"y":0.75},{"x":-3.9,"y":0.75},{"x":-3.8000000000000003,"y":0.8},{"x":-3.75,"y":0.75},{"x":-3.65,"y":0.75},{"x":-3.6,"y":0.75},{"x":-3.55,"y":0.75},{"x":-3.5,"y":0.75},{"x":-3.45,"y":0.75},{"x":-3.35,"y":0.75},{"x":-3.35,"y":0.75},{"x":-3.3,"y":0.75},{"x":-3.25,"y":0.75},{"x":-3.2,"y":0.75},{"x":-3.1,"y":0.8},{"x":-3.1,"y":0.75},{"x":-3.05,"y":0.8},{"x":-3,"y":0.75},{"x":-2.9000000000000004,"y":0.7},{"x":-2.8499999999999996,"y":0.75},{"x":-2.8,"y":0.75},{"x":-2.75,"y":0.75},{"x":-2.6500000000000004,"y":0.8},{"x":-2.65,"y":0.7},{"x":-2.55,"y":0.75},{"x":-2.45,"y":0.7},{"x":-2.45,"y":0.75},{"x":-2.4,"y":0.75},{"x":-2.3499999999999996,"y":0.75},{"x":-2.3,"y":0.75},{"x":-2.25,"y":0.8500000000000001},{"x":-2.25,"y":0.7},{"x":-2.0999999999999996,"y":0.8},{"x":-1.9999999999999998,"y":0.75},{"x":-2,"y":0.75},{"x":-1.9499999999999997,"y":0.75},{"x":-1.95,"y":0.7},{"x":-1.85,"y":0.8},{"x":-1.7999999999999998,"y":0.75},{"x":-1.75,"y":0.75},{"x":-1.7499999999999998,"y":0.8},{"x":-1.5999999999999999,"y":0.8},{"x":-1.5999999999999996,"y":0.75},{"x":-1.5499999999999998,"y":0.75},{"x":-1.5,"y":0.75},{"x":-1.55,"y":0.8},{"x":-1.5,"y":0.8},{"x":-1.5,"y":0.85},{"x":-1.5,"y":0.9},{"x":-1.5,"y":1},{"x":-1.5,"y":1.05},{"x":-1.5,"y":1.1},{"x":-1.5,"y":1.15},{"x":-1.5,"y":1.2},{"x":-1.45,"y":1.2},{"x":-1.5,"y":1.3},{"x":-1.55,"y":1.4000000000000001},{"x":-1.5,"y":1.4},{"x":-1.5,"y":1.5},{"x":-1.5,"y":1.5},{"x":-1.45,"y":1.6},{"x":-1.45,"y":1.65},{"x":-1.5,"y":1.75},{"x":-1.55,"y":1.75},{"x":-1.65,"y":1.7},{"x":-1.7,"y":1.75},{"x":-1.75,"y":1.75},{"x":-1.85,"y":1.75},{"x":-1.9,"y":1.75},{"x":-2,"y":1.75},{"x":-2.05,"y":1.75},{"x":-2.1,"y":1.75},{"x":-2.15,"y":1.75},{"x":-2.2,"y":1.75},{"x":-2.2,"y":1.8},{"x":-2.3,"y":1.75},{"x":-2.4,"y":1.8},{"x":-2.4,"y":1.75},{"x":-2.45,"y":1.7},{"x":-2.5,"y":1.75},{"x":-2.55,"y":1.75},{"x":-2.5500000000000003,"y":1.65},{"x":-2.6500000000000004,"y":1.7},{"x":-2.7,"y":1.75},{"x":-2.75,"y":1.75},{"x":-2.8,"y":1.75},{"x":-2.9,"y":1.8},{"x":-3,"y":1.75},{"x":-3.05,"y":1.75},{"x":-3.1500000000000004,"y":1.75},{"x":-3.2,"y":1.8},{"x":-3.3,"y":1.75},{"x":-3.25,"y":1.8},{"x":-3.3,"y":1.9},{"x":-3.25,"y":1.95},{"x":-3.25,"y":2},{"x":-3.3,"y":2.05},{"x":-3.25,"y":2.15},{"x":-3.25,"y":2.1500000000000004},{"x":-3.25,"y":2.25},{"x":-3.25,"y":2.3},{"x":-3.3499999999999996,"y":2.4},{"x":-3.25,"y":2.4499999999999997},{"x":-3.3,"y":2.5},{"x":-3.25,"y":2.5},{"x":-3.25,"y":2.5},{"x":-3.25,"y":2.45},{"x":-3.35,"y":2.45},{"x":-3.4,"y":2.5},{"x":-3.4000000000000004,"y":2.55},{"x":-3.5,"y":2.5},{"x":-3.55,"y":2.5},{"x":-3.6,"y":2.5},{"x":-3.6999999999999997,"y":2.5},{"x":-3.7,"y":2.5},{"x":-3.75,"y":2.5},{"x":-3.75,"y":2.45},{"x":-3.85,"y":2.5},{"x":-3.9,"y":2.5},{"x":-3.9000000000000004,"y":2.55},{"x":-4.1,"y":2.55},{"x":-3.95,"y":2.55},{"x":-4,"y":2.45},{"x":-4.05,"y":2.4499999999999997},{"x":-4,"y":2.35},{"x":-4,"y":2.3499999999999996},{"x":-3.95,"y":2.2},{"x":-4,"y":2.2},{"x":-3.95,"y":2.1999999999999997},{"x":-4,"y":2.1},{"x":-4.05,"y":2.05},{"x":-4.05,"y":1.9},{"x":-4,"y":1.9},{"x":-4,"y":1.85},{"x":-4,"y":1.7999999999999998},{"x":-4,"y":1.75},{"x":-4,"y":1.65},{"x":-4,"y":1.6},{"x":-4,"y":1.5},{"x":-4,"y":1.45},{"x":-4.05,"y":1.3499999999999999},{"x":-4,"y":1.3499999999999999},{"x":-4,"y":1.2999999999999998},{"x":-4,"y":1.3},{"x":-4,"y":1.2},{"x":-4,"y":1.15},{"x":-4,"y":1.0999999999999999},{"x":-4,"y":1.0499999999999998},{"x":-4,"y":1},{"x":-4,"y":0.8499999999999999},{"x":-4,"y":0.8999999999999999},{"x":-4,"y":0.8499999999999999},{"x":-4,"y":0.75},{"x":-1.5,"y":3.05},{"x":-1.55,"y":3.0000000000000004},{"x":-1.55,"y":3.15},{"x":-1.5,"y":3.2},{"x":-1.5,"y":3.25},{"x":-1.5,"y":3.3499999999999996},{"x":-1.5,"y":3.35},{"x":-1.5,"y":3.4},{"x":-1.5,"y":3.45},{"x":-1.5,"y":3.55},{"x":-1.55,"y":3.65},{"x":-1.5,"y":3.65},{"x":-1.5,"y":3.7},{"x":-1.5,"y":3.75},{"x":-1.45,"y":3.8},{"x":-1.5,"y":3.8},{"x":-1.6,"y":3.75},{"x":-1.5499999999999998,"y":3.8},{"x":-1.7,"y":3.75},{"x":-1.75,"y":3.7},{"x":-1.85,"y":3.7},{"x":-1.85,"y":3.75},{"x":-1.95,"y":3.75},{"x":-2,"y":3.75},{"x":-2.05,"y":3.8},{"x":-2.1,"y":3.7},{"x":-2.15,"y":3.75},{"x":-2.2,"y":3.75},{"x":-2.25,"y":3.75},{"x":-2.25,"y":3.65},{"x":-2.25,"y":3.6},{"x":-2.25,"y":3.55},{"x":-2.25,"y":3.4499999999999997},{"x":-2.25,"y":3.35},{"x":-2.25,"y":3.3},{"x":-2.25,"y":3.25},{"x":-2.3,"y":3.1999999999999997},{"x":-2.25,"y":3.1},{"x":-2.25,"y":3.05},{"x":-2.25,"y":3},{"x":-2.25,"y":3},{"x":-2.2,"y":2.95},{"x":-2.15,"y":3},{"x":-2.1,"y":3},{"x":-2.05,"y":3},{"x":-2,"y":3},{"x":-1.95,"y":3},{"x":-1.9,"y":3.05},{"x":-1.85,"y":3},{"x":-1.8,"y":3},{"x":-1.75,"y":3},{"x":-1.7,"y":3},{"x":-1.6,"y":3},{"x":-1.5999999999999999,"y":3.05},{"x":-1.45,"y":3}],"resolution":{"x":0.05,"y":0.05},"size":{"x":0,"y":0},"spacepointcloud":[]}')}(this._gui),function(e){const t=e.addFolder("材质");[{id:"24de2fc1-3db2-488c-adb5-36c06b913e60",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/f15bf03a-479c-4861-be06-2d4c216774ca/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/f15bf03a-479c-4861-be06-2d4c216774ca/resized/iso_w160_h160.jpg",name:"铺贴1",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"铺贴"},{id:"1ef27f19-ae38-4089-b871-1317251a68da",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/f15bf03a-479c-4861-be06-2d4c216774ca/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/f15bf03a-479c-4861-be06-2d4c216774ca/resized/iso_w160_h160.jpg",name:"铺贴2",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"铺贴"},{id:"70aac26f-961b-4779-a055-9cbf7a7ba349",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/70aac26f-961b-4779-a055-9cbf7a7ba349/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/70aac26f-961b-4779-a055-9cbf7a7ba349/resized/iso_w160_h160.jpg",name:"得高Par-ky实木复合地板恬适系列拉绒象牙白橡木",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"406d60b8-bf80-434d-9a8b-d764a480d6ca",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/406d60b8-bf80-434d-9a8b-d764a480d6ca/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/406d60b8-bf80-434d-9a8b-d764a480d6ca/resized/iso_w160_h160.jpg",name:"湖畔橡木",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"2ae8365d-3502-4f0a-9a53-612fc6c6e179",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/2ae8365d-3502-4f0a-9a53-612fc6c6e179/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/2ae8365d-3502-4f0a-9a53-612fc6c6e179/resized/iso_w160_h160.jpg",name:"巴多利诺橡木",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"2b1495b2-8c57-48cb-bc1e-9f076581c18d",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/2b1495b2-8c57-48cb-bc1e-9f076581c18d/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/2b1495b2-8c57-48cb-bc1e-9f076581c18d/resized/iso_w160_h160.jpg",name:"07 鱼骨拼",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"c09d47c4-1ff2-49e1-a2ed-50247e17e8f7",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/c09d47c4-1ff2-49e1-a2ed-50247e17e8f7/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/c09d47c4-1ff2-49e1-a2ed-50247e17e8f7/resized/iso_w160_h160.jpg",name:"重复产品实木复合地板  （SS15XA）",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"e09cf760-b2c0-4a00-b9fb-2566959dcf9f",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/e09cf760-b2c0-4a00-b9fb-2566959dcf9f/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/e09cf760-b2c0-4a00-b9fb-2566959dcf9f/resized/iso_w160_h160.jpg",name:"至尊玛宝",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"199b3e89-29c2-47c4-bfbf-352ad98fcd15",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/199b3e89-29c2-47c4-bfbf-352ad98fcd15/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/199b3e89-29c2-47c4-bfbf-352ad98fcd15/resized/iso_w160_h160.jpg",name:"东方巴黎",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"a9634fe7-7ddd-4199-b77f-c4271b50d560",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/a9634fe7-7ddd-4199-b77f-c4271b50d560/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/a9634fe7-7ddd-4199-b77f-c4271b50d560/resized/iso_w160_h160.jpg",name:"水洗白橡",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"26dea189-7c9a-4dfd-814f-6cf0e375f145",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/26dea189-7c9a-4dfd-814f-6cf0e375f145/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/26dea189-7c9a-4dfd-814f-6cf0e375f145/resized/iso_w160_h160.jpg",name:"卡布奇诺三部曲",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"94db0491-c5cd-49ce-864e-30e721d8ad12",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/94db0491-c5cd-49ce-864e-30e721d8ad12/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/94db0491-c5cd-49ce-864e-30e721d8ad12/resized/iso_w160_h160.jpg",name:"内华达高山橡木",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"f9b19c62-02fb-48af-9341-3a16d4f31e23",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/f9b19c62-02fb-48af-9341-3a16d4f31e23/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/f9b19c62-02fb-48af-9341-3a16d4f31e23/resized/iso_w160_h160.jpg",name:"得高Quick-Step LVT地板原木系列BACL40030",modelId:1111,modelType:"TYPE_3D",tileSize:{x:240.6,y:240.6},vendor:"得高"},{id:"fdff6975-7680-4223-9c46-e309c5dbdfed",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/fdff6975-7680-4223-9c46-e309c5dbdfed/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/fdff6975-7680-4223-9c46-e309c5dbdfed/resized/iso_w160_h160.jpg",name:"布-白色",modelId:1111,modelType:"TYPE_3D",tileSize:{x:100,y:100},vendor:"通配"},{id:"e3a9b798-fac6-485a-ab55-d16a42620f98",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/e3a9b798-fac6-485a-ab55-d16a42620f98/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/e3a9b798-fac6-485a-ab55-d16a42620f98/resized/iso_w160_h160.jpg",name:"布-碎花",modelId:1111,modelType:"TYPE_3D",tileSize:{x:100,y:100},vendor:"通配"},{id:"e4cee254-3943-4ce7-a7ca-67ba4a3f3177",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/e4cee254-3943-4ce7-a7ca-67ba4a3f3177/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/e4cee254-3943-4ce7-a7ca-67ba4a3f3177/resized/iso_w160_h160.jpg",name:"花纹布料",modelId:1111,modelType:"TYPE_3D",tileSize:{x:100,y:100},vendor:"通配"},{id:"d60c6a6d-e91d-4f3e-9f3d-430e19fde9b0",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/d60c6a6d-e91d-4f3e-9f3d-430e19fde9b0/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/d60c6a6d-e91d-4f3e-9f3d-430e19fde9b0/resized/iso_w160_h160.jpg",name:"wallfloor (11)-QA-CENTER",modelId:1111,modelType:"TYPE_3D",tileSize:{x:100,y:100},vendor:"通配"},{id:"1e73ae78-9de5-4476-a9a9-95f4a53006e5",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/1e73ae78-9de5-4476-a9a9-95f4a53006e5/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/1e73ae78-9de5-4476-a9a9-95f4a53006e5/resized/iso_w160_h160.jpg",name:"山水画",modelId:1111,modelType:"TYPE_3D",tileSize:{x:100,y:100},vendor:"通配"},{id:"ff0b1048-0d5b-4d82-87f5-08d989ec3756",image:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/ff0b1048-0d5b-4d82-87f5-08d989ec3756/iso.jpg",imageResized:"https://jr-prod-pim-products.oss-cn-beijing.aliyuncs.com/i/ff0b1048-0d5b-4d82-87f5-08d989ec3756/resized/iso_w160_h160.jpg",name:"白色木",modelId:1111,modelType:"TYPE_3D",tileSize:{x:100,y:100},vendor:"通配"}].forEach((e=>{l.addCmdButton(t,e.name,d.CmdIds.CMD_ATTACH_MATRIAL,void 0,{id:e.id,icon:e.image})}))}(this._gui),u.initRenderFeature(this._gui),c.initRecordsUI(this._gui,a.app.getMainDoc()),setTimeout((()=>{c.replayLogByURL()}),500)}}t.DevGui=h,h._guiStack=[]},68812:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.openwin=t.resizeWindowAsURL=t.resizeViewPort=t.getUrlParamAsNumber=t.getUrlParam=void 0;const r=n(31667);function s(e){const t=new RegExp(`(^|&)${e}=([^&]*)(&|$)`),n=window.location.search.substr(1).match(t);if(null!=n)return unescape(n[2])}function i(e){const t=s(e);if(t)try{const e=Number.parseInt(t,10);if(!Number.isNaN(e)&&e>0)return e}catch(e){}return-1}function o(e,t){r.DebugWarn.assert(window.outerWidth,"浏览器兼容问题?"," ","2020-05-11"),window.outerWidth&&window.resizeTo(e+(window.outerWidth-window.innerWidth),t+(window.outerHeight-window.innerHeight))}t.getUrlParam=s,t.getUrlParamAsNumber=i,t.resizeViewPort=o,t.resizeWindowAsURL=function(){window.focus();const e=i("width"),t=i("height");e>0&&t>0&&o(e,t)},t.openwin=function(e){return window.open(e,e+Math.random(),"top=0, left=0,toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no")}},44988:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.makeDomDraggable=t.addColor=t.addSwitch=t.addSelect=t.addInput=t.addCmdButton=t.addButton=void 0;const o=i(n(16088));t.addButton=function(e,t,n,r){n&&Mousetrap.bind(n,t);const s={};let i=r||t.name;return i+=n?` (${n})`.italics():"",s[i]=t,e.add(s,i)},t.addCmdButton=function(e,t,n,r,s){const i=n?()=>o.app.sendCmd(n,s):()=>{};r&&Mousetrap.bind(r,i);const a={},c=t+(r?` (${r})`.italics():"");return a[c]=i,e.add(a,c)},t.addInput=function(e,t="",n,r){let s;const i=e.add({[t]:`${n}`},t).onFinishChange((e=>{r&&e!==s&&(r(e),s=e)})).__input;i.addEventListener("keydown",(e=>e.stopPropagation())),i.addEventListener("keyup",(e=>e.stopPropagation())),i.addEventListener("mousedown",(e=>e.stopPropagation())),i.addEventListener("mouseup",(e=>e.stopPropagation())),i.addEventListener("click",(e=>e.stopPropagation()))},t.addSelect=function(e,t="",n,r,s){let i;if(Array.isArray(n))i=n.length&&n[0]instanceof Object?n.reduce(((e,t)=>(e[t.label]=t.value,e)),{}):n.reduce(((e,t)=>(e[t]=t,e)),{});else{if(!(n instanceof Object))throw new Error("Unsupported options.");i=n}e.add({[t]:r},t,i).listen().onChange(s)},t.addSwitch=function(e,t="",n=!1,r){e.add({[t]:n},t).onFinishChange(r)},t.addColor=function(e,t="",n="#FFFFFF",r){e.addColor({[t]:n},t).onFinishChange(r)},t.makeDomDraggable=function(e){e.style.position="fixed";let t=0,n=0,r=0,s=0,i=!1;function o(o){!i&&Math.hypot(o.x-t,o.y-n)>4&&(i=!0),i&&Object.assign(e.style,{left:r+o.x-t+"px",top:s+o.y-n+"px",right:"auto",bottom:"auto"})}function a(e){window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",a)}const c=document.createElement("div");c.innerText="MOVE",Object.assign(c.style,{position:"absolute",display:"inline-block",top:0,left:"200px",width:"100px",height:"20px",background:"gray",opacity:.5,cursor:"move",textAlign:"center",color:"white",fontSize:"12px",lineHeight:"20px",zIndex:1}),e.append(c),c.addEventListener("mousedown",(function(c){i=!1,t=c.x,n=c.y;const l=e.getBoundingClientRect();r=l.left,s=l.top,window.addEventListener("mousemove",o),window.addEventListener("mouseup",a)}))}},58844:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.replayLogByURL=t.initRecordsUI=void 0;const a=i(n(16088)),c=n(44988),l=n(68812);t.initRecordsUI=function(e,t){const n=e.addFolder("脚本录制/回放");c.addButton(n,(()=>o(this,void 0,void 0,(function*(){const e=prompt("请输入一句脚本","");if(e)try{let n=JSON.parse(e);Array.isArray(n)||(n=[n]),yield(new a.LogReplayer).replay(t,"脚本片段",n)}catch(e){}}))),void 0,"执行脚本片段"),c.addCmdButton(n,">>>导出到磁盘",a.PlatformCmdIds.CMD_SAVE_RECORDS_TO_LOCAL,void 0),c.addButton(n,(()=>{const e=JSON.stringify(a.app.logRecorder.dump());window.localStorage.setItem("log",e)}),void 0,">>>导出到浏览器"),c.addCmdButton(n,"磁盘导入",a.PlatformCmdIds.CMD_REPLAY_RECORDS,void 0,{logURL:"disk"}),c.addCmdButton(n,"浏览器导入 ",a.PlatformCmdIds.CMD_REPLAY_RECORDS,void 0,{logURL:"localStorage"}),c.addButton(n,(()=>{const e=`/?debug=true&log.speed=${l.getUrlParamAsNumber("log.speed")}&log.url=localStorage`;l.openwin(e)}),void 0,"新窗口回放localStorage"),c.addButton(n,(()=>o(this,void 0,void 0,(function*(){const e=window.open(window.location.href,`${Math.random()}`,"width=800, height=600, top=0, left=0");null!==e&&e.moveTo(0,0)}))),void 0,"打开新窗口"),c.addButton(n,(()=>{alert("\n        不压缩脚本\n        log.compress=false\n        回放速度\n        log.speed=100\n        跑完关闭浏览器窗口\n        log.close=false\n        刷新网页时自动跑脚本\n        log.url = localStorage url")}),void 0,"参数说明"),c.addButton(n,(()=>{window.open("/logs/test.html","_blank")}),void 0,"跳转到自动化测试网页")},t.replayLogByURL=function(){l.getUrlParam("log.url")&&a.app.sendCmd(a.PlatformCmdIds.CMD_REPLAY_RECORDS)}},92960:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initRenderFeature=void 0;const r=n(16088),s={geometry:"white"};t.initRenderFeature=function(e){const t=e.addFolder("render feature");s.name="渲染特性",t.add(s,"geometry",["real","wireframe","white","wire-only","face-only"]).listen().onChange((e=>{var t;null===(t=r.app.getCurrentView())||void 0===t||t.setRenderFeature({geometry:e})}))}},24334:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(98106),s=n(31667),i=n(16088),o=n(84566),a=n(52018),c=n(95070),l=n(47819),d=n(34678);class u extends i.IElementDragStrategy{constructor(){super(...arguments),this._ctrlDragStartPt=new r.Vector3,this._doc=i.app.getMainDoc()}static handleElement(e){return e instanceof s.CtrlPoint}onDragStart(e,t,n,r){const s=e;return this._ctrlDragStartPt=s.worldPos,this._dragCtrlPoint=s,this._snapHelpManager=i.SnapHelperManager.getInstance(),!0}onDragMove(e,t,n){if(void 0===this._dragCtrlPoint)return!1;let r=e.screenToWorkPlane(t).clone().subtract(this._ctrlDragStartPt);return r=this._handleSnap(e,t).point.clone().subtracted(this._ctrlDragStartPt),this._dragCtrlPoint.performTranslate(this._ctrlDragStartPt,r),this._doc.updateView(),!0}_handleSnap(e,t){if(!this._snapHelpManager)throw new Error("snap manager 没有初始化");const n=new s.SnapContext;n.addSnapHelpers(s.EN_SNAP_HELPER_OBJECT.POINT,i.SnapHelperManager.getInstance().getAllSnapHelperPoints());const r=new i.PickObserver(void 0);return i.RunSnapUtil.snapPoint(t,n,e,r)}onDragEnd(e,t,n){if(void 0===this._dragCtrlPoint)return!1;let r=this._handleSnap(e,t).point.clone().subtract(this._ctrlDragStartPt);return s.transact(this._doc,"拖动夹点",(()=>{this._dragCtrlPoint.confirmTranslate(this._ctrlDragStartPt,r),c.JointScheduler.startBatch("recognize_all_joint");const e=s.UniqueElementUtil.getOrCreateUniqueElement(i.app.getMainDoc(),a.JointMgr),t=this._dragCtrlPoint.getMaster();if(t&&t instanceof d.Wall){e.searchJointElementConnectJoint(t).getAll().forEach((n=>{e.deleteEleInJoint(n,t)}))}const n=l.JointUtil.getAllJointElements(o.EN_JOINT_MEMBER.WALL),u=n.length;for(let t=0;t<u;t++){const r=n[t];for(let s=t+1;s<u;s++){const t=n[s];e.fitAddJointEleCurves(o.EN_JOINT_MEMBER.WALL,r,t,{isScale:!1})}}c.JointScheduler.endBatch("recognize_all_joint"),this._doc.updateView()})),!0}onMouseLeave(e,t){return this._dragCtrlPoint.performTranslate(this._ctrlDragStartPt,r.Vector3.O()),this._doc.updateView(),!0}onKeyDown(e){return!1}canBeDraggedWhenNotSelected(){return!1}getSpecifiedElement(e){return e}}t.default=u,i.MouseCallbackToDrag.registerDragStrategy(u)},34678:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Wall=void 0;const o=n(98106),a=n(31667),c=n(2907),l=n(51280),d=n(3319),u=n(45840),h=n(16088);let g=r=class extends a.GrepKeepElement{constructor(){super(...arguments),this._startCtrlPointID=a.ElementId.INVALID,this._endCtrlPointID=a.ElementId.INVALID,this._dimensionID=a.ElementId.INVALID}init(e,t,n,r,s){return e instanceof o.Curve2d&&void 0!==t&&void 0!==n&&void 0!==r?(super.init(s),this._db.centerCurve=e,this._db.width=t,this._db.height=n,this._db.bottom=r,this.setCanDeleted(!0)):e instanceof a.ElementCustomizedBase&&super.init(e),this}get category(){return u.categoryWall}static generateTmpGRep(e,t,n,s){a.DebugWarn.assert(t,"输入参数不合法","",""),a.DebugWarn.assert(n,"coordinate不能为空","","");const i=o.Loop.createByOffset(t,e/2,e/2),c=new o.Polygon(i),l=n.getCoord(),u=d.alg.BodyBuilder.extrude(l,c,o.Vector3.Z(),0,s||r.defaultHeight),h=new a.GRep;return h.addNode(new a.GBody(u)),h}get startJointId(){return this._db.startJointId}set startJointId(e){this._db.startJointId=e}get endJointId(){return this._db.endJointId}set endJointId(e){this._db.endJointId=e}get centerCurve(){return this._db.centerCurve}set centerCurve(e){this._db.centerCurve=e}get width(){return this._db.width}set width(e){a.DebugWarn.assert(e<1&&e>.01,"厚度不合法","",""),this._db.width=e}get startTipCache(){return this._db.CALC_StartTip}get endTipCache(){return this._db.CALC_EndTip}setCenterCurve(e){this._db.centerCurve=e}getCenterCurve(){return this._db.centerCurve.clone()}reportDependency(){const e=[];return this._db.startJointId.isValid()&&e.push(this._db.startJointId),this._db.endJointId.isValid()&&e.push(this._db.endJointId),[[],e]}updateForWeakParentDeletion(e){this.startJointId&&e.id.equals(this.startJointId)?this.startJointId=a.ElementId.INVALID:this.endJointId&&e.id.equals(this.endJointId)&&(this.endJointId=a.ElementId.INVALID)}getStartCtrlPointID(){return this._startCtrlPointID||a.ElementId.INVALID}getEndCtrlPointID(){return this._endCtrlPointID||a.ElementId.INVALID}getDimensionID(){return this._dimensionID||a.ElementId.INVALID}createAuxElements(){this._createAuxCtrlPoints(),this._createAuxDimensions()}clearAuxElements(){h.app.getMainDoc().deleteElementsById(this.getStartCtrlPointID(),this.getEndCtrlPointID(),this.getDimensionID()),this.setStartCtrlPointID(a.ElementId.INVALID),this.setEndCtrlPointID(a.ElementId.INVALID),this.setDimensionID(a.ElementId.INVALID)}_createAuxDimensions(){const e=this.centerCurve.getStartPt(),t=new o.Vector3(e.x,e.y,this._db.bottom),n=(this.centerCurve.getStartPt(),new o.Vector3(e.x,e.y,this._db.bottom)),r=new o.Line3d(t,n).getStartTangent(),s=t.clone(),c=n.clone(),l=new o.Vector3(-r.y,r.x,0),d=h.app.getMainDoc().create(a.Dimension).dimensionInit(s,c,l,this.id);d.onChange=e=>i(this,void 0,void 0,(function*(){if(e<o.Tolerance.LENGTH_EPS||e>o.CONST.MODEL_MAX_LENGTH)return;const r=n.clone().subtracted(t);r.normalize();const s=t.clone().add(r.multiplied(e));yield a.transact(h.app.getMainDoc(),"change wall length",(()=>{const e=new o.Line2d(t,s);this.setCenterCurve(e)}))})),this.setDimensionID(d.id)}_createAuxCtrlPoints(){const e=this.centerCurve.getStartPt(),t=new o.Vector3(e.x,e.y,this._db.bottom),n=h.app.getMainDoc().create(a.CtrlPoint).ctrlPtInit(this.id,t);this.setStartCtrlPointID(n.id),n.bindTranslation(((e,n,r)=>{const i=t;i.add(r);const a=s,c=new o.Line2d(i,a);this.setCenterCurve(c)}));const r=this.centerCurve.getEndPt(),s=new o.Vector3(r.x,r.y,this._db.bottom),i=h.app.getMainDoc().create(a.CtrlPoint).ctrlPtInit(this.id,s);this.setEndCtrlPointID(i.id),i.bindTranslation(((e,n,r)=>{const i=t,a=s;a.add(r);const c=new o.Line2d(i,a);this.setCenterCurve(c)}))}setStartCtrlPointID(e){this._startCtrlPointID=e}setEndCtrlPointID(e){this._endCtrlPointID=e}setDimensionID(e){this._dimensionID=e}};g.defaultWidth=120,g.defaultHeight=2800,g=r=s([a.elementMeta("Wall",l.DBWall,!0)],g),t.Wall=g,a.CalculatorMgr.getInstance().registerElementCalculator(g,new c.WallStartTipCalculator),a.CalculatorMgr.getInstance().registerElementCalculator(g,new c.WallEndTipCalculator),a.CalculatorMgr.getInstance().registerElementCalculator(g,new c.WallPoly2dCalculator),a.CalculatorMgr.getInstance().registerElementCalculator(g,new c.WallGrep3dCalculator)},84566:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_JOINT_MEMBER=void 0,function(e){e[e.WALL=0]="WALL",e[e.BEAM=1]="BEAM"}(t.EN_JOINT_MEMBER||(t.EN_JOINT_MEMBER={}))},79790:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jointGlobalState=void 0;const n=new class{constructor(){this.inBatch=0,this.isRunningRefresh=!1,this.pendingDeleteJoints=[],this.pendingDeleteJointEles=[]}};t.jointGlobalState=n},76625:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.InstanceJoint=void 0;const s=n(98106),i=n(16088),o=n(67347),a=n(66857),c=n(40948),l=n(33298),d=n(47819),u=n(79790),h=n(52018),g=n(95070);let f=class extends i.Element{instanceJointInit(e,t){return e&&"[object Number]"===Object.prototype.toString.call(t)&&(this._db.markConnect=e,this._db.type=t,this.updateRelativeJointEles()),this}get mark(){return this._db.markConnect||i.DebugWarn.warn(!1,"cant get joint mark!","",""),this._db.markConnect||""}get isShow(){return this._db.isShow}set isShow(e){this._db.isShow=e}get position(){const e=this.mark.split(">").find((e=>!e.includes("$"))),t=parseInt(e),n=d.JointUtil.getJointConnectTypeBySign(e),r=i.app.getMainDoc().getElementById(t),o=s.Vector2.O();if(!r)return o;const a=r.getCenterCurve();return n===c.EN_JOINT_TYPE.START?a.getStartPt():n===c.EN_JOINT_TYPE.END?a.getEndPt():o}get jointType(){return this._db.type}get relativeIDs(){return this._db.markConnect.split(">").map((e=>parseInt(e)))}get relativeElements(){return i.app.getMainDoc().getElementsByIds(this.relativeIDs)}get nonMiddleElements(){const e=this._db.markConnect.split(">").filter((e=>!e.includes("$"))).map((e=>parseInt(e)));return i.app.getMainDoc().getElementsByIds(e)}get relativeElementsConnectTypeMap(){const e=new Map;return this.mark.split(">").forEach((t=>{const n=parseInt(t);e.set(n,d.JointUtil.getJointConnectTypeBySign(t))})),e}isInJoint(e){const t=new RegExp(`${e}[*|#|$]>?`);return!!this.mark.match(t)}isMarkInJoint(e){if(e===this.mark||this.mark.includes(e))return!0;const t=e.split(">"),n=this.mark.split(">"),r=t.length,s=n.length;for(let e=0;e<r;e++){const r=t[e];for(let e=0;e<s;e++){if(r===n[e]&&!r.includes("$"))return!0}}return!1}unionJointMark(e){if(e===this.mark)return;const t=e.split(">"),n=this.mark.split(">"),r=[...new Set([...t,...n]).values()].sort(((e,t)=>parseInt(e)-parseInt(t))).join(">");this._db.markConnect=d.JointUtil.fitMark(r),this.updateRelativeJointEles()}reverseJointMark(e){const t=this.mark.split(">"),n=t.findIndex((t=>parseInt(t)===e));if(-1!==n&&!t[n].includes("$")){const r=t[n].includes("*")?"#":"*";t.splice(n,1,`${e}${r}`),this._db.markConnect=t.join(">"),this.updateRelativeJointEles()}}reportDependency(){const e=[];return this._db.CALC_JointEleIds.length&&e.push(...this._db.CALC_JointEleIds.map((e=>{const t=i.app.getMainDoc().getElementById(e);return t?t.id:i.ElementId.INVALID})).filter((e=>e.isValid()))),[[],e]}deleteJointEleInMarkById(e){const t=this.mark.split(">"),n=t.map((e=>parseInt(e))).findIndex((t=>t===e));if(-1===n)return;const r=t.splice(n,1)[0],s=i.app.getMainDoc().getElementById(parseInt(r));if(s&&(r.includes("#")?s.startJointId=i.ElementId.INVALID:r.includes("*")&&(s.endJointId=i.ElementId.INVALID)),this._db.markConnect=t.join(">"),t.length<2)return g.JointScheduler.startBatch("deleteJointEleInMarkById"),u.jointGlobalState.pendingDeleteJoints.push(this),void g.JointScheduler.endBatch("deleteJointEleInMarkById");this.updateRelativeJointEles()}updateForWeakParentDeletion(e){this.relativeIDs.length<=2?(g.JointScheduler.startBatch("updateForWeakParentDeletion"),u.jointGlobalState.pendingDeleteJoints.push(this),g.JointScheduler.endBatch("updateForWeakParentDeletion")):this.relativeIDs.length>2&&i.UniqueElementUtil.getOrCreateUniqueElement(i.app.getMainDoc(),h.JointMgr).deleteEleInJoint(this,e)}isValid(){return this.relativeIDs.length>=2}updateRelativeJointEles(){this.mark.split(">").forEach((e=>{const t=i.app.getMainDoc().getElementById(parseInt(e));t&&(e.includes("#")?t.startJointId=this.id:e.includes("*")&&(t.endJointId=this.id))}))}getJointNodes(){const e=this._db.markConnect.split(">");return e.length&&e[0]?e.map((e=>new l.JointAssitNode(e))):[]}};f=r([i.elementMeta("InstanceJoint",a.DBJoint,!0)],f),t.InstanceJoint=f,i.CalculatorMgr.getInstance().registerElementCalculator(f,new o.JointPosCalculator),i.CalculatorMgr.getInstance().registerElementCalculator(f,new o.JointEleIdsCalculator),i.CalculatorMgr.getInstance().registerElementCalculator(f,new o.JointTipsCalculator)},52018:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.JointMgr=void 0;const i=n(34678),o=n(84566),a=n(83448),c=n(17281),l=n(47819),d=n(3158),u=n(79790),h=n(76625),g=n(95070),f=n(31667),p=n(16088),_=n(98106),m=n(40948);let v=class extends f.UniqueElement{constructor(){super(),this._JointMems=new Map,this._JointCons=new Map,this._JointMemsSub=new Map,this.init()}init(){f.eventManager.addEventListener(f.EN_EVENT_TYPE.ELEMENT_DID_DELETE,(e=>{e.forEach((e=>{e instanceof h.InstanceJoint&&this.deleteJointInMap(e)}))})),f.eventManager.addEventListener(f.EN_EVENT_TYPE.DOCUMENT_OPENED,(e=>{e.forEach((e=>{if(e instanceof h.InstanceJoint){const{mark:t}=e,n=e.jointType;this._JointMems.get(n).set(t,e)}}))})),this.utilMgr=new a.JointElementUtilMgr,this.registerJointMember({type:o.EN_JOINT_MEMBER.WALL,clazz:i.Wall,memberUtil:new d.JointWallUtil})}isEleSameType(e,t,n){const r=this._JointCons.get(e),s=this._JointMemsSub.get(e);let i=!0;if(s){const e=s.get("default");e&&(i=e(t)===e(n))}return!!(r&&t instanceof r&&n instanceof r)&&i}isExistInMems(){}getRefByType(e){return this._JointMems.get(e)}getclazzByType(e){return this._JointCons.get(e)}isJointClazz(e){return!!Object.values(this._JointCons).find((t=>t===e))}getTypeByJointElement(e){let t;return[...this._JointCons.entries()].forEach((([n,r])=>{e instanceof r&&(t=n)})),t}registerJointMember(e){const{type:t,clazz:n}=e,r=`$$canJoint${t}`;return n.prototype[r]=!0,this._JointMems.set(t,new Map),this._JointCons.set(t,n),this._JointMemsSub.set(t,e.subTypeJudge),this.utilMgr.registerUtil(t,e.memberUtil),!0}addJoint(e,t,n){if(!this.isEleSameType(e,t,n))return!1;const r=t.getCenterCurve(),s=n.getCenterCurve(),i=[s.getStartPt(),s.getEndPt()],o=.01;let a="";[r.getStartPt(),r.getEndPt()].forEach(((e,c)=>{if(_.MathUtil.isNearlyZero(e.distanceTo(i[0]),o)?a=0===c?`${a}${t.id.asInt()}#>${n.id.asInt()}#`:`${a}${t.id.asInt()}*>${n.id.asInt()}#`:_.MathUtil.isNearlyZero(e.distanceTo(i[1]),o)?a=0===c?`${a}${t.id.asInt()}#>${n.id.asInt()}*`:`${a}${t.id.asInt()}*>${n.id.asInt()}*`:_.MathUtil.isNearlyZero(_.MathAlg.CalculateDistance.pointToCurve2d(e,s),o)&&(a=0===c?`${a}${n.id.asInt()}$>${t.id.asInt()}#`:`${a}${n.id.asInt()}$>${t.id.asInt()}*`),!a){const e=r.getProjectedPtBy(i[0]),s=_.MathAlg.CalculateDistance.pointToCurve2d(i[0],r),c=r.getProjectedPtBy(i[1]),l=_.MathAlg.CalculateDistance.pointToCurve2d(i[1],r);_.MathUtil.isNearlyZero(s,o)&&!r.getRange().containsPointAtStartOrEnd(r.getParamAt(e),.01)?a=`${a}${t.id.asInt()}$>${n.id.asInt()}#`:_.MathUtil.isNearlyZero(l,o)&&!r.getRange().containsPointAtStartOrEnd(r.getParamAt(c),.01)&&(a=`${a}${t.id.asInt()}$>${n.id.asInt()}*`)}}));const c=a.match(/>/g);if(1!==(c?c.length:0))return f.DebugWarn.warn(!1,"joint same line?","",""),!1;return this.addJointByMark(e,a)}addJointByMark(e,t){let n=t;l.JointUtil.isMarkValid(t)||(n=l.JointUtil.fitMark(t));const r=this.getRefByType(e);if(!r)return!1;const s=[...r.values()].find((e=>e.relativeElements.length>1&&e.isMarkInJoint(n)));if(!s){g.JointScheduler.startBatch("addJointByMark");const t=p.app.getMainDoc().create(h.InstanceJoint).instanceJointInit(n,e);return r.set(n,t),g.JointScheduler.endBatch("addJointByMark"),t.updateRelativeJointEles(),!0}if(s.unionJointMark){g.JointScheduler.startBatch("addJointByMark"),r.delete(s.mark),s.unionJointMark(n),r.set(s.mark,s),u.jointGlobalState.pendingDeleteJoints=Array.from(new Set(u.jointGlobalState.pendingDeleteJoints));const e=u.jointGlobalState.pendingDeleteJoints.indexOf(s);return-1!==e&&u.jointGlobalState.pendingDeleteJoints.splice(e,1),g.JointScheduler.endBatch("addJointByMark"),!0}return!1}searchJointElementConnectJoint(e){const t=this.getTypeByJointElement(e),n={start:!1,end:!1,middles:[]};if("[object Number]"!==Object.prototype.toString.call(t))return f.DebugWarn.warn(!1,"joint type is not registered?","",""),new c.JointSearchResult(n);const r=p.app.getMainDoc().getAllElementsByCtor(h.InstanceJoint).filter((e=>e.jointType===t)),s=e.id.asInt();return r.forEach((e=>{e.isInJoint(s)&&e.relativeElementsConnectTypeMap.forEach(((t,r)=>{s===r&&(t===m.EN_JOINT_TYPE.START?n.start=e:t===m.EN_JOINT_TYPE.END?n.end=e:t===m.EN_JOINT_TYPE.MIDDLE&&n.middles.push(e))}))})),new c.JointSearchResult(n)}searchRelativeJointElements(e){const t={starts:[],ends:[],middles:[]},n=this.searchJointElementConnectJoint(e);return n.isStartEmpty()||(t.starts=t.starts.concat(n.start.relativeElements.filter((t=>t!==e)))),n.isEndEmpty()||(t.ends=t.starts.concat(n.end.relativeElements.filter((t=>t!==e)))),n.middles.forEach((n=>{const r=n.relativeElements.filter((t=>t!==e));t.middles=t.middles.concat(r)})),t}collectCalculators(){return[]}fitAddJointEleCurves(e,t,n,r={isScale:!0},s=.01){let i,o;if(t.id.asInt()>n.id.asInt()?(i=n,o=t):(i=t,o=n),i===o||!this.isEleSameType(e,i,o))return;const a=i.getCenterCurve(),c=o.getCenterCurve(),l=a.getRange(),d=a.getParamAt(c.getStartPt()),u=a.getParamAt(c.getEndPt()),h=new _.Interval(Math.min(d,u),Math.max(d,u)),g=(e,t)=>e<t||_.MathUtil.isNearlyEqual(e,t,.001),f=_.MathAlg.CalculateDistance.pointToCurve2d(a.getStartPt(),c),p=g(f,i.width/2+o.width/2-.01),m=e=>{r.isScale&&o.setCenterCurve(e)};if(a.isParallelTo(c,s)){if(p){const t=_.MathUtil.isNearlyZero(f,.01),n=l.intersected(h);if(n.length>0&&_.MathUtil.isNearlyZero(n[0].getLength(),s)){const n=a.getMidPt().distanceTo(c.getStartPt())<a.getMidPt().distanceTo(c.getEndPt()),r=n?c.getStartPt():c.getEndPt(),l=(n?a.getStartPt().distanceTo(c.getStartPt())<a.getEndPt().distanceTo(c.getStartPt()):a.getStartPt().distanceTo(c.getEndPt())<a.getEndPt().distanceTo(c.getEndPt()))?a.getStartPt():a.getEndPt(),d=r.distanceTo(l);if(g(d,s)&&_.MathUtil.isNearlyEqual(i.width,o.width,s)&&t){m(c.clone().extend(d,n)),this.addJoint(e,i,o)}}else if(l.containsInterval(h));else if(h.containsInterval(l));else if(n.length>0&&n[0].getLength()>.5);else{const t=a.getParamAt(c.getStartPt()),n=a.getParamAt(c.getEndPt()),r=l.getMid();let s=new _.Line2d;if(l.containsPoint(t))if(t>r){const e=c.getProjectedPtBy(a.getEndPt());s=new _.Line2d(e,c.getEndPt())}else{const e=c.getProjectedPtBy(a.getStartPt());s=new _.Line2d(e,c.getEndPt())}else if(l.containsPoint(n))if(n>r){const e=c.getProjectedPtBy(a.getEndPt());s=new _.Line2d(c.getStartPt(),e)}else{const e=c.getProjectedPtBy(a.getStartPt());s=new _.Line2d(c.getStartPt(),e)}m(s),this.addJoint(e,i,o)}}}else{const t=a.clone().extendDouble(_.CONST.MODEL_MAX_LENGTH),n=c.clone().extendDouble(_.CONST.MODEL_MAX_LENGTH),d=_.MathAlg.CalculateIntersect.curve2ds(t,n);if(d&&d.length){const t=d[0],n=t.point,u=_.MathAlg.CalculateDistance.pointToCurve2d(n,a),h=_.MathAlg.CalculateDistance.pointToCurve2d(n,c);if(u<s&&h<s){if(!a.getRange().containsPoint(d[0].param1)){let{min:e}=l,{max:n}=l;t.param1>l.max?n=t.param1:t.param1<l.min&&(e=t.param1),v=a.clone().setRange(e,n),r.isScale&&i.setCenterCurve(v)}if(!c.getRange().containsPoint(d[0].param2)){let{min:e}=c.getRange(),{max:n}=c.getRange();t.param2>c.getRange().max?n=t.param2:t.param2<c.getRange().min&&(e=t.param2),m(c.clone().setRange(e,n))}this.addJoint(e,i,o)}}}var v}addJointElement(e){const t=this.getTypeByJointElement(e),n=e.id.asInt();if(void 0!==t){const r=e.getCenterCurve().clone().getBoundingBox(),s={x:.1,y:.1};r.min.subtract(s),r.max.add(s),this.utilMgr.setUtilState(t);const i=this.utilMgr.getCandidateJoinEles(r);i&&i.filter((t=>t!==e&&!u.jointGlobalState.pendingDeleteJointEles.includes(t))).forEach((r=>{const s=r.id.asInt()>n,i=s?e:r,o=s?r:e;this.fitAddJointEleCurves(t,i,o)})),this.utilMgr.reset()}}deleteEleInJoint(e,t){g.JointScheduler.startBatch("deleteEleInJoint");const n=f.isNumber(t)?t:t.id.asInt();e.deleteJointEleInMarkById(n),this.refreshJointInMap(e),g.JointScheduler.endBatch("deleteEleInJoint")}deleteJointInMap(e){const{mark:t}=e,n=e.jointType;this._JointMems.get(n).delete(t)}refreshJointInMap(e){const t=e.jointType,n=this._JointMems.get(t);Array.from(n.entries()).forEach((([t,r])=>{r.relativeElements.length<2?n.delete(t):r===e&&(n.delete(t),n.set(e.mark,e))}))}};v=r([f.elementMeta("JointMgr",f.DBElement,!1),s("design:paramtypes",[])],v),t.JointMgr=v},95070:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JointScheduler=void 0;const r=n(16088),s=n(79790);t.JointScheduler=class{static startBatch(e){s.jointGlobalState.inBatch++}static endBatch(e){0==--s.jointGlobalState.inBatch&&this.runSchedule()}static runSchedule(){if(!s.jointGlobalState.isRunningRefresh){s.jointGlobalState.isRunningRefresh=!0,s.jointGlobalState.pendingDeleteJoints=Array.from(new Set(s.jointGlobalState.pendingDeleteJoints));for(let e=0,t=s.jointGlobalState.pendingDeleteJoints.length;e<t;e++){const t=s.jointGlobalState.pendingDeleteJoints[e];t.getJointNodes().forEach((e=>{e.ele&&(e.isStart()&&e.ele.startJointId===t.id?e.ele.startJointId=r.ElementId.INVALID:e.isEnd()&&e.ele.endJointId===t.id&&(e.ele.endJointId=r.ElementId.INVALID))})),r.app.getMainDoc().deleteElementsById(t.id)}s.jointGlobalState.pendingDeleteJointEles=Array.from(new Set(s.jointGlobalState.pendingDeleteJointEles));for(let e=0,t=s.jointGlobalState.pendingDeleteJointEles.length;e<t;e++){const t=s.jointGlobalState.pendingDeleteJointEles[e];t.startJointId=r.ElementId.INVALID,t.endJointId=r.ElementId.INVALID,r.app.getMainDoc().deleteElementsById(t.id)}this._resetState(),r.app.getMainDoc().updateView()}}static _resetState(){s.jointGlobalState.pendingDeleteJoints=[],s.jointGlobalState.pendingDeleteJointEles=[],s.jointGlobalState.isRunningRefresh=!1}}},33298:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JointAssitNode=void 0;const r=n(16088),s=n(40948),i=n(47819);t.JointAssitNode=class{constructor(e){e?(this._sign=e.match(/\*|#|\$/gi)[0],this._id=parseInt(e)):r.DebugWarn.warn(!1,"joint node cant accept empty string","","")}get id(){return this._id}get ele(){return r.app.getMainDoc().getElementById(this._id)}get jointType(){return i.JointUtil.getJointConnectTypeBySign(this._sign)}get cnType(){return this.jointType===s.EN_JOINT_TYPE.MIDDLE?"middle":this.jointType===s.EN_JOINT_TYPE.START?"start":this.jointType===s.EN_JOINT_TYPE.END?"end":"unknow"}isMiddle(){return"middle"===this.cnType}isStart(){return"start"===this.cnType}isEnd(){return"end"===this.cnType}}},81316:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JointCheck=void 0;const r=n(16088);t.JointCheck=class{static getNonJointInfo(e){const t=r.app.getMainDoc().getAllElementsByCtor(e),n=[];return t.forEach((e=>{e.startJointId&&e.startJointId.isValid()||n.push({id:`${e.id.asInt()}-s`}),e.endJointId&&e.endJointId.isValid()||n.push({id:`${e.id.asInt()}-e`})})),n}}},83448:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JointElementUtilMgr=t.JointElementUtil=void 0;const r=n(16088);class s{doJointCheck(e=!0){r.DebugWarn.warn(!1,"apply doJointCheck required to override in element_joint_util","","")}}t.JointElementUtil=s;t.JointElementUtilMgr=class extends s{constructor(){super(...arguments),this._utilMap=new Map}registerUtil(e,t){this._utilMap.set(e,t)}getCurrentState(){return this._currentState}reset(){this._currentState=void 0}setUtilState(e){const t=this._utilMap.get(e);t?this._currentState=t:r.DebugWarn.warn(!1,`${e} is not register!`,"","")}getCandidateJoinEles(e){if(this._checkStateValid())return this._currentState.getCandidateJoinEles(e)}doJointCheck(e=!0){if(this._checkStateValid())return this._currentState.doJointCheck(e)}_checkStateValid(){const e=!!this._currentState;return r.DebugWarn.warn(e,"pls setCurrent JointUtil first!","",""),e}}},17281:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JointSearchResult=void 0;t.JointSearchResult=class{constructor(e){this.middles=[],this.start=e.start,this.end=e.end,this.middles=e.middles}isStartEmpty(){return!this.start}isEndEmpty(){return!this.end}isMiddlesEmpty(){return!this.middles.length}isEmpty(){return this.isStartEmpty()&&this.isEndEmpty()&&this.isMiddlesEmpty()}isStartEndConnect(){return this.start&&this.end}getAll(){const e=[];return this.start&&e.push(this.start),this.end&&e.push(this.end),e.concat(this.middles)}}},47819:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.JointUtil=void 0;const s=n(98106),i=n(16088),o=n(48517),a=n(40948),c=n(76625),l=n(52018);t.JointUtil=class{static getInstanceJointData(e){const t=e.relativeElementsConnectTypeMap;return e.relativeElements.filter((e=>e.startTipCache&&e.endTipCache)).map((e=>{const n=t.get(e.id.asInt());return{id:e.id.asInt(),centerCurve:e.getCenterCurve(),width:e.width,connectType:n,startTip:e.startTipCache,endTip:e.endTipCache}}))}static getJointConnectTypeBySign(e){let t=a.EN_JOINT_TYPE.UNKOWN;return e.includes("#")?t=a.EN_JOINT_TYPE.START:e.includes("*")?t=a.EN_JOINT_TYPE.END:e.includes("$")&&(t=a.EN_JOINT_TYPE.MIDDLE),t}static getAllJointElements(e){const t=i.UniqueElementUtil.getOrCreateUniqueElement(i.app.getMainDoc(),l.JointMgr).getclazzByType(e);return t?i.app.getMainDoc().getAllElementsByCtor(t):[]}static setJointPos(e,t){if(!e.isValid())return!1;const n=e.getJointNodes(),r=(e,t)=>!e.getStartTangent().isSameDirection(t.getStartTangent());return n.forEach((e=>{const{ele:n}=e;if(!n)return;const o=n.getCenterCurve().clone();if(e.isStart()){const e=new s.Line2d(t,o.getEndPt());r(o,e)&&i.DebugWarn.warn(!1,"wall dir is reversed!","",""),n.setCenterCurve(e)}else if(e.isEnd()){const e=new s.Line2d(o.getStartPt(),t);r(o,e)&&i.DebugWarn.warn(!1,"wall dir is reversed!","",""),n.setCenterCurve(e)}})),!0}static fitMark(e){let t=e.split(">"),n=t.length;for(;t[t.length-1].includes("$")&&n;){const e=t.pop();t.unshift(e),n--}const r=t.filter((e=>e.includes("$"))),o=[];if(r.length>1){const e=r.map((e=>i.app.getMainDoc().getElementById(parseInt(e)))).filter((e=>e)),t=e.length;for(let n=0;n<t-1;n++){const r=e[n],i=r.getCenterCurve();for(let a=n+1;a<t;a++){const t=e[a],n=t.getCenterCurve();if(i.isParallelTo(n,.01)){const e=i.getRange().expandByPt(i.getParamAt(n.getStartPt())).expandByPt(i.getParamAt(n.getEndPt()));r.setCenterCurve(new s.Line2d(i.getPtAt(e.min),i.getPtAt(e.max))),o.push(t.id.asInt())}}}}t=t.filter((e=>!o.includes(parseInt(e))));const a=[];for(let e=0;e<t.length-1;e++){const n=t[e],r=parseInt(n);if(a.find((e=>parseInt(e)===r)))continue;let s=!1;for(let i=e+1;i<t.length;i++){const e=parseInt(t[i]);r===e&&n.includes("$")&&(s=!0)}s||a.push(n)}return a.push(t.pop()),a.join(">")}static isMarkValid(e){if("[object String]"!==Object.prototype.toString.call(e))return i.DebugWarn.warn(!1,"joint mark must be type string!","",""),!1;const t=e.split(">"),n=t.length;if(n<2)return i.DebugWarn.warn(!1,"joint mark elements must larger than 1!","",""),!1;if(t[n-1].includes("$"))return i.DebugWarn.warn(!1,"joint mark last sign is not middle connect!","",""),!1;const r=t.map((e=>parseInt(e)));return new Set(r).size===n||(i.DebugWarn.warn(!1,"joint mark same element no more once!","",""),!1)}static findParalJointsEleWithJoint(e,t){const n=e.id.asInt();if(!t.isInJoint(n))return i.DebugWarn.warn(!1,"ele is not in joint","",""),[];const r=e.getCenterCurve();return t.relativeElements.filter((t=>{if(t!==e){if(t.getCenterCurve().isParallelTo(r,.1))return!0}return!1}))}static showAllJoints(){o.appConfig.joint.isShow=!0,(()=>{r(this,void 0,void 0,(function*(){yield i.transact(i.app.getMainDoc(),"showAllJoints",(()=>{i.app.getMainDoc().getAllElementsByCtor(c.InstanceJoint).forEach((e=>e.isShow=!0))}))}))})()}static hideAllJoints(){o.appConfig.joint.isShow=!1,(()=>{r(this,void 0,void 0,(function*(){yield i.transact(i.app.getMainDoc(),"showAllJoints",(()=>{i.app.getMainDoc().getAllElementsByCtor(c.InstanceJoint).forEach((e=>e.isShow=!1))}))}))})()}static getOtherJoint(e,t){const n=i.UniqueElementUtil.getOrCreateUniqueElement(i.app.getMainDoc(),l.JointMgr).searchJointElementConnectJoint(e);return n.isStartEmpty()||n.start!==t?!n.isEndEmpty()&&n.end===t&&n.start:n.end}}},3158:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JointWallUtil=void 0;const r=n(83448),s=n(81316),i=n(49688),o=n(16088);class a extends r.JointElementUtil{getCandidateJoinEles(e){return o.app.getMainDoc().getAllElementsByCtor(i.Wall)}doJointCheck(e=!0){if(!e)return void o.app.getMainDoc().updateView();s.JointCheck.getNonJointInfo(i.Wall).forEach((({id:e})=>{this._createPtById(e)})),o.app.getMainDoc().updateView()}_createPtById(e){const[t,n]=e.split("-"),r=o.app.getMainDoc().getElementById(parseInt(t)).centerCurve;let s;s="s"===n?r.getStartPt():r.getEndPt()}}t.JointWallUtil=a},49688:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Wall=void 0;const o=n(98106),a=n(31667),c=n(2907),l=n(51280),d=n(3319),u=n(45840),h=n(16088);let g=r=class extends a.GrepKeepElement{constructor(){super(...arguments),this._startCtrlPointID=a.ElementId.INVALID,this._endCtrlPointID=a.ElementId.INVALID,this._dimensionID=a.ElementId.INVALID}init(e,t,n,r,s){return e instanceof o.Curve2d&&void 0!==t&&void 0!==n&&void 0!==r?(super.init(s),this._db.centerCurve=e,this._db.width=t,this._db.height=n,this._db.bottom=r,this.setCanDeleted(!0)):e instanceof a.ElementCustomizedBase&&super.init(e),this}get category(){return u.categoryWall}static generateTmpGRep(e,t,n,s){a.DebugWarn.assert(t,"输入参数不合法","",""),a.DebugWarn.assert(n,"coordinate不能为空","","");const i=o.Loop.createByOffset(t,e/2,e/2),c=new o.Polygon(i),l=n.getCoord(),u=d.alg.BodyBuilder.extrude(l,c,o.Vector3.Z(),0,s||r.defaultHeight),h=new a.GRep;return h.addNode(new a.GBody(u)),h}get startJointId(){return this._db.startJointId}set startJointId(e){this._db.startJointId=e}get endJointId(){return this._db.endJointId}set endJointId(e){this._db.endJointId=e}get centerCurve(){return this._db.centerCurve}set centerCurve(e){this._db.centerCurve=e}get width(){return this._db.width}set width(e){a.DebugWarn.assert(e<1&&e>.01,"厚度不合法","",""),this._db.width=e}get startTipCache(){return this._db.CALC_StartTip}get endTipCache(){return this._db.CALC_EndTip}setCenterCurve(e){this._db.centerCurve=e}getCenterCurve(){return this._db.centerCurve.clone()}reportDependency(){const e=[];return this._db.startJointId.isValid()&&e.push(this._db.startJointId),this._db.endJointId.isValid()&&e.push(this._db.endJointId),[[],e]}updateForWeakParentDeletion(e){this.startJointId&&e.id.equals(this.startJointId)?this.startJointId=a.ElementId.INVALID:this.endJointId&&e.id.equals(this.endJointId)&&(this.endJointId=a.ElementId.INVALID)}getStartCtrlPointID(){return this._startCtrlPointID||a.ElementId.INVALID}getEndCtrlPointID(){return this._endCtrlPointID||a.ElementId.INVALID}getDimensionID(){return this._dimensionID||a.ElementId.INVALID}createAuxElements(){this._createAuxCtrlPoints(),this._createAuxDimensions()}clearAuxElements(){h.app.getMainDoc().deleteElementsById(this.getStartCtrlPointID(),this.getEndCtrlPointID(),this.getDimensionID()),this.setStartCtrlPointID(a.ElementId.INVALID),this.setEndCtrlPointID(a.ElementId.INVALID),this.setDimensionID(a.ElementId.INVALID)}_createAuxDimensions(){const e=this.centerCurve.getStartPt(),t=new o.Vector3(e.x,e.y,this._db.bottom),n=(this.centerCurve.getStartPt(),new o.Vector3(e.x,e.y,this._db.bottom)),r=new o.Line3d(t,n).getStartTangent(),s=t.clone(),c=n.clone(),l=new o.Vector3(-r.y,r.x,0),d=h.app.getMainDoc().create(a.Dimension).dimensionInit(s,c,l,this.id);d.onChange=e=>i(this,void 0,void 0,(function*(){if(e<o.Tolerance.LENGTH_EPS||e>o.CONST.MODEL_MAX_LENGTH)return;const r=n.clone().subtracted(t);r.normalize();const s=t.clone().add(r.multiplied(e));yield a.transact(h.app.getMainDoc(),"change wall length",(()=>{const e=new o.Line2d(t,s);this.setCenterCurve(e)}))})),this.setDimensionID(d.id)}_createAuxCtrlPoints(){const e=this.centerCurve.getStartPt(),t=new o.Vector3(e.x,e.y,this._db.bottom),n=h.app.getMainDoc().create(a.CtrlPoint).ctrlPtInit(this.id,t);this.setStartCtrlPointID(n.id),n.bindTranslation(((e,n,r)=>{const i=t;i.add(r);const a=s,c=new o.Line2d(i,a);this.setCenterCurve(c)}));const r=this.centerCurve.getEndPt(),s=new o.Vector3(r.x,r.y,this._db.bottom),i=h.app.getMainDoc().create(a.CtrlPoint).ctrlPtInit(this.id,s);this.setEndCtrlPointID(i.id),i.bindTranslation(((e,n,r)=>{const i=t,a=s;a.add(r);const c=new o.Line2d(i,a);this.setCenterCurve(c)}))}setStartCtrlPointID(e){this._startCtrlPointID=e}setEndCtrlPointID(e){this._endCtrlPointID=e}setDimensionID(e){this._dimensionID=e}};g.defaultWidth=120,g.defaultHeight=2800,g=r=s([a.elementMeta("Wall",l.DBWall,!0)],g),t.Wall=g,a.CalculatorMgr.getInstance().registerElementCalculator(g,new c.WallStartTipCalculator),a.CalculatorMgr.getInstance().registerElementCalculator(g,new c.WallEndTipCalculator),a.CalculatorMgr.getInstance().registerElementCalculator(g,new c.WallPoly2dCalculator),a.CalculatorMgr.getInstance().registerElementCalculator(g,new c.WallGrep3dCalculator)},31416:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HoughAnalyser=t.HoughAnalyserType=void 0;const r=n(11221);var s;!function(e){e[e.line=0]="line",e[e.circle=1]="circle"}(s=t.HoughAnalyserType||(t.HoughAnalyserType={}));class i{constructor(e,t,n,r){this._pts=e,this._disStep=t,this._angleStep=n,this._threshold=r}start(){const e={min:[Number.MAX_VALUE,Number.MAX_VALUE],max:[-Number.MAX_VALUE,-Number.MAX_VALUE]};this._pts.forEach((t=>{r.addPtToBox(e,[t.x,t.y])}));const t=4*this._disStep;e.min=[e.min[0]-t,e.min[1]-t],e.max=[e.max[0]+t,e.max[1]+t];const n=e.max[0]-e.min[0],s=e.max[1]-e.min[1],i=e.min[0]+.5*n,o=e.min[1]+.5*s,a=Math.sqrt(n*n+s*s),c=.5*a,l=Math.floor(a/this._disStep),d=[],u=[],h=[];for(let e=0,t=0;e<Math.PI;e+=this._angleStep,t++)d[t]=e,u[t]=Math.sin(e),h[t]=Math.cos(e);const g=[];for(var f=0;f<d.length;f++){g[f]=[];for(var p=0;p<l;p++)g[f][p]={value:0,indices:[]}}for(let e=0;e<this._pts.length;e++){const t=this._pts[e],n=t.x-i,r=t.y-o;for(var _=0;_<d.length;_++){var m=n*h[_]+r*u[_]+c;const e=Math.floor(m/this._disStep);g[_][e].value+=1,g[_][e].indices.push(t.index)}}let v=-1;for(f=0;f<g.length;f++)for(p=0;p<g[0].length;p++)g[f][p].value>v&&(v=g[f][p].value);v=.8*v>this._threshold?.8*v:this._threshold;for(f=0;f<g.length;f++)for(p=0;p<g[0].length;p++)g[f][p].value<v&&(g[f][p].value=0);var E=new Array;for(f=0;f<g.length;f++){E[f]=[];for(p=0;p<g[0].length;p++)E[f][p]={value:g[f][p].value,indices:g[f][p].indices}}for(f=0;f<g.length;f++)for(p=0;p<g[0].length;p++){let e=!1;for(var P=f-2;P<f+3;P++)if(!(P<0||P>g.length-1)){for(var y=p-2;y<p+3;y++)if(!(y<0||y>g[0].length-1)&&g[P][y].value>g[f][p].value){E[f][p].value=0,e=!0;break}if(e)break}}for(f=0;f<g.length;f++)for(p=0;p<g[0].length;p++)g[f][p]=E[f][p];const C=[],S=.5*n,T=.5*s,b=[],w=Math.cos(4*this._angleStep),x=(e,t,n)=>{for(const r of b){const s=r[0]*e+t*r[1];if(Math.abs(s)>w){const e=(s>0?r[2]:-r[2])-n;if(Math.abs(e)<4*this._disStep)return!1}}return b.push([e,t,n]),!0};for(f=0;f<g.length;f++)for(p=0;p<l;p++)if(g[f][p].value>0){var M=d[f],N=p*this._disStep-c;if(!x(h[f],u[f],N))continue;const e=new Set(g[f][p].indices);for(P=f-2;P<f+3;P++)if(!(P<0||P>g.length-1))for(y=p-2;y<p+3;y++)y<0||y>g[0].length-1||g[P][y].indices.forEach((t=>e.add(t)));var A,O,I,D;M>Math.PI/4&&M<2*Math.PI/3?(A=(N-(I=-S)*h[f])/u[f],O=(N-(D=S)*h[f])/u[f]):(I=(N-(A=-T)*u[f])/h[f],D=(N-(O=T)*u[f])/h[f]);const t={st:{x:I+i,y:A+o},et:{x:D+i,y:O+o},indices:Array.from(e)};C.push(t)}return C}}t.HoughAnalyser=class{static run(e,t,n,r,o){switch(t){case s.line:return new i(e,n,r,o).start();case s.circle:}return[]}}},297:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.roomBuild2d=void 0;const o=i(n(88441)),a=n(31416),c=n(11221),l=.05,d=1;function u(e,t,n,r=!1){e.sort(((e,n)=>c.getLineParam(new o.Vector2,t,e)-c.getLineParam(new o.Vector2,t,n)));let s=[],i=-1;for(let t=0;t<e.length;t++)i<0?i=t:c.pointDistance(e[t],e[t-1])>d&&(s.push(e.slice(i,t)),i=-1);i>=0&&s.push(e.slice(i,e.length)),s=s.filter((e=>e.length>=4));const a=[];for(const e of s){const n=[];for(let t=0;t<e.length-1;t++){const r=(new o.Vector2).subVectors(e[t],e[t+1]).normalize();let s=!1;for(let e=0;e<n.length;e++)if(n[e][0].dot(r)>Math.cos(Math.PI/36)){n[e].push(r),s=!0;break}s||n.push([r])}if(n.sort(((e,t)=>t.length-e.length)),n[0].length/(e.length-1)>.5||r){let s=new o.Vector2;r?s=t:(n[0].forEach((e=>s.add(e))),s.divideScalar(n[0].length));const i=new o.Vector2;e.forEach((e=>i.add(e))),i.divideScalar(e.length);const l=c.getLinePt(i,s,c.getLineParam(i,s,e[0])),d=c.getLinePt(i,s,c.getLineParam(i,s,e[e.length-1]));a.push({line:{st:l,et:d},dir:(new o.Vector2).subVectors(d,l).normalize(),pts:e});continue}const s=c.ransac(e,2*l);s&&c.pointDistance(s.line.st,s.line.et)>4*l&&a.push({line:s.line,dir:(new o.Vector2).subVectors(s.line.et,s.line.st).normalize(),pts:e})}return a.filter((e=>{const n=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize();return Math.abs(n.dot(t))>Math.cos(Math.PI/6)}))}function h(e,t=40){for(let t=0;t<e.length;t++)e[t].index=t;let n=[],r=0,s=!1,i=e.slice();const d=Math.PI/180;do{const h=a.HoughAnalyser.run(i,a.HoughAnalyserType.line,l,d,t);for(let e=h.length-1;e>0;e--){const t=h[e].indices;for(let n=e-1;n>=0;n--){const r=t.filter((e=>h[n].indices.indexOf(e)>-1));if(r.length/t.length>.7||r.length/h[n].indices.length>.7){const r=new Set;t.forEach((e=>r.add(e))),h[n].indices.forEach((e=>r.add(e))),h[n].indices=Array.from(r),h.splice(e,1);break}}}const g=new Set;s=!1;for(let t=0;t<h.length;t++){const r=h[t].indices.map((t=>e[t])),i=(new o.Vector2).subVectors(h[t].et,h[t].st).normalize();u(r.slice(0,r.length),i).forEach((e=>{if(c.pointDistance(e.line.et,e.line.st)<1)return;s=!0;const t=[],r=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize();e.pts.forEach((n=>{c.getLineDistance(e.line.st,r,n)<4*l&&(g.add(n),t.push(n))})),n.push({line:e.line,dir:r,pts:t})}))}i=i.filter((e=>!g.has(e))),r++}while(s&&r<5);return{mainLines:n,leftPoints:i}}function g(e,t,n,r){const s=[],i=new Set;function a(e,t){const n=[];return u(e,t,0,!0).forEach((e=>{c.pointDistance(e.line.et,e.line.st)<4*l||(n.push(e),e.pts.forEach((e=>i.add(e))))})),n}function d(e,n,i){const l={st:r.getCenter(new o.Vector2),dir:n},d=function(e,t){const n=e.map((e=>{const n=c.getLineParam(t.st,t.dir,e);return Math.round(n/.05)})),r=Math.min(...n),s=Math.max(...n),i=[];for(let e=0;e<s-r+1;e++)i.push([]);for(let t=0;t<n.length;t++)i[n[t]-r].push(e[t]);const o=[];let a=-1;for(let e=0;e<i.length;e++){const t=i[e];if(a<0){if(t.length<=5)continue;if(0===e){a=0;continue}(0===i[e-1].length||t.length/i[e-1].length>2||t.length/i[e-1].length<.3)&&(a=e)}else(t.length<=5||t.length/i[e-1].length<.3)&&(o.push(i.slice(a,e+1).flat()),a=-1)}return a>=0&&o.push(i.slice(a,i.length).flat()),o}(e,l).map((e=>{const t=new o.Vector2;e.forEach((e=>t.add(e))),t.divideScalar(e.length);return{param:c.getLineParam(l.st,l.dir,t),tts:e}})),u=t.filter((e=>{const t=(new o.Vector2).subVectors(e.et,e.st);return Math.abs(t.dot(n))>Math.abs(t.dot(i))}));for(const e of u){const t=c.getLineParam(l.st,l.dir,e.st);if(d.sort(((e,n)=>Math.abs(e.param-t)-Math.abs(n.param-t))),d.length&&Math.abs(d[0].param-t)<.2){const e=a(d[0].tts,i);e.length&&(s.push(...e),d.shift())}const n=c.getLineParam(l.st,l.dir,e.et);if(d.sort(((e,t)=>Math.abs(e.param-n)-Math.abs(t.param-n))),d.length&&Math.abs(d[0].param-n)<.2){const e=a(d[0].tts,i);e.length&&(s.push(...e),d.shift())}}return d}const h=d(e,n.dx,n.dy),g=d(e.filter((e=>!i.has(e))),n.dy,n.dx);return h.forEach((e=>{if(e.tts.length<10)return;const t=a(e.tts,n.dy);t.length&&s.push(...t)})),g.forEach((e=>{if(e.tts.length<10)return;const t=a(e.tts,n.dx);t.length&&s.push(...t)})),{shortLines:s,leftPoints:e.filter((e=>!i.has(e)))}}function f(e,t,n){const r=new Map;let s=e.slice();for(const e of t)if(e.overlap_line){let t=r.get(e.overlap_line);t||(t=[],r.set(e.overlap_line,t)),t.push(e)}else s.push(e);s=function(e,t){function n(e,t){const n=c.pointDistance(e.st,t),r=c.pointDistance(e.et,t);return Math.min(n,r)}const r=(e,t,n,r,s)=>{let i=c.lineIntersect(e.line.st,e.line.et,n.line.st,n.line.et);const a=1===t?e.line.st:e.line.et,d=1===r?n.line.st:n.line.et,u=c.pointDistance(i,a),h=c.pointDistance(i,d);if(i&&u<8*l&&h<8*l){const s=(e,t)=>{const n=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize();c.getLineParam(e.line.st,n,e.line.et),c.getLineParam(e.line.st,n,i),1===t?(e.line.st=i,e.done1=!0):2===t&&(e.line.et=i,e.done2=!0)};s(e,t),s(n,r)}},s=(e,t,n,r)=>{const s=1===t?e.line.st:e.line.et,i=1===r?n.line.st:n.line.et,a=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize(),d=((new o.Vector2).subVectors(n.line.et,n.line.st).normalize(),(new o.Vector2).subVectors(i,s));if(Math.abs(a.dot(d))<4*l){const l=new o.Vector2(-a.y,a.x),d=(new o.Vector2).addVectors(i,s).multiplyScalar(.5),u={line:{st:c.getLinePt(d,l,-5),et:c.getLinePt(d,l,5)},done1:!0,done2:!0,pts:[]};let h=c.lineIntersect(e.line.st,e.line.et,u.line.st,u.line.et);return h&&(1===t?(e.line.st=h,e.done1=!0):2===t&&(e.line.et=h,e.done2=!0),u.line.st=h),h=c.lineIntersect(n.line.st,n.line.et,u.line.st,u.line.et),h&&(1===r?(n.line.st=h,n.done1=!0):2===r&&(n.line.et=h,n.done2=!0),u.line.et=h),u}},i=(e,t,n,r,s)=>{let i=c.lineIntersect(e.line.st,e.line.et,n.line.st,n.line.et);const a=1===t?e.line.st:e.line.et,d=1===r?n.line.st:n.line.et;if(i&&c.pointDistance(i,a)<s+.01&&c.pointDistance(i,d)<s+.01){const s=(e,t)=>{const n=.5,r=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize();let s=c.getLineParam(e.line.st,r,e.line.et),a=c.getLineParam(e.line.st,r,i);1===t?a<=n*s&&a>=-.5*s&&(e.line.st=i,e.done1=!0):2===t&&a>=.5*s&&a<=1.5*s&&(e.line.et=i,e.done2=!0)};s(e,t),s(n,r)}else{const s=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize(),u=(new o.Vector2).subVectors(n.line.et,n.line.st).normalize();if(Math.abs(s.dot(u))>Math.cos(Math.PI/18)){const u=(new o.Vector2).subVectors(d,a);if(Math.abs(s.dot(u))<4*l){const l=new o.Vector2(-s.y,s.x),u=(new o.Vector2).addVectors(d,a).multiplyScalar(.5),h={line:{st:c.getLinePt(u,l,-5),et:c.getLinePt(u,l,5)},done1:!0,done2:!0,pts:[]};return i=c.lineIntersect(e.line.st,e.line.et,h.line.st,h.line.et),i&&(1===t?(e.line.st=i,e.done1=!0):2===t&&(e.line.et=i,e.done2=!0),h.line.st=i),i=c.lineIntersect(n.line.st,n.line.et,h.line.st,h.line.et),i&&(1===r?(n.line.st=i,n.done1=!0):2===r&&(n.line.et=i,n.done2=!0),h.line.et=i),h}}}},a=e;for(const e of a){const t=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize(),r=a.filter((n=>{if(n===e)return!1;const r=(new o.Vector2).subVectors(n.line.et,n.line.st).normalize();return!(Math.abs(t.dot(r))>Math.cos(Math.PI/18))}));if(!r.length)continue;const s=r.slice();s.sort(((t,r)=>n(t.line,e.line.st)-n(r.line,e.line.st)));const i=n(s[0].line,e.line.st),d=r.slice();d.sort(((t,r)=>n(t.line,e.line.et)-n(r.line,e.line.et)));const u=n(d[0].line,e.line.et);if(d[0]!=s[0]){if(i<4*l){const t=c.lineIntersect(e.line.st,e.line.et,s[0].line.st,s[0].line.et);t&&c.pointDistance(e.line.st,t)<1.5&&(e.line.st=t,e.done1=!0)}if(u<4*l){const t=c.lineIntersect(e.line.st,e.line.et,d[0].line.st,d[0].line.et);t&&c.pointDistance(e.line.et,t)<1.5&&(e.line.et=t,e.done2=!0)}}}let d=a.filter((e=>!(e.done1&&e.done2)));if(d.length<=1)return a;for(const e of d){if(e.done1&&e.done2)continue;const t=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize(),n=d.filter((n=>{if(n===e)return!1;const r=(new o.Vector2).subVectors(n.line.et,n.line.st).normalize();return!(Math.abs(t.dot(r))>Math.cos(Math.PI/18))}));if(n.length){if(!e.done1){let t,s=1e10,i=-1;for(const r of n){if(!r.done1){const n=c.pointDistance(e.line.st,r.line.st);n<s&&(s=n,t=r,i=1)}if(!r.done2){const n=c.pointDistance(e.line.st,r.line.et);n<s&&(s=n,t=r,i=2)}}i>0&&t&&r(e,1,t,i)}if(!e.done2){let t,s=1e10,i=-1;for(const r of n){if(!r.done1){const n=c.pointDistance(e.line.et,r.line.st);n<s&&(s=n,t=r,i=1)}if(!r.done2){const n=c.pointDistance(e.line.et,r.line.et);n<s&&(s=n,t=r,i=2)}}i>0&&t&&r(e,2,t,i)}}}if(d=a.filter((e=>!(e.done1&&e.done2))),d.length<=1)return a;for(const e of d){if(e.done1&&e.done2)continue;const t=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize(),n=a.filter((n=>{if(n===e)return!1;const r=(new o.Vector2).subVectors(n.line.et,n.line.st).normalize();return!(Math.abs(t.dot(r))>Math.cos(Math.PI/18))}));if(n.length){if(!e.done1){const r=n.slice();let s,i=1e10;for(const n of r){let r=Math.abs(c.getLineParam(e.line.st,t,n.line.st)),a=(new o.Vector2).subVectors(n.line.et,n.line.st),l=a.length(),d=c.getLineParam(n.line.st,a.normalize(),e.line.st);d>=0&&d<l&&i>r&&(i=r,s=n)}if(s){const n=c.getLineParam(e.line.st,t,s.line.st);Math.abs(n)<8*l&&(e.line.st=c.getLinePt(e.line.st,t,n),e.done1=!0)}}if(!e.done2){const r=n.slice(),s=c.getLineParam(e.line.st,t,e.line.et);let i,a=1e10;for(const n of r){let r=Math.abs(c.getLineParam(e.line.st,t,n.line.st)-s),l=(new o.Vector2).subVectors(n.line.et,n.line.st),d=l.length(),u=c.getLineParam(n.line.st,l.normalize(),e.line.st);u>=0&&u<d&&a>r&&(a=r,i=n)}if(i){const n=c.getLineParam(e.line.st,t,i.line.st)-s;Math.abs(n)<8*l&&(e.line.et=c.getLinePt(e.line.st,t,n+s),e.done2=!0)}}}}if(d=a.filter((e=>!(e.done1&&e.done2))),d.length<=1)return a;function u(e,t,n){if(t){let t,r=1e10,s=-1;for(const i of n)if(e!==i){if(!i.done1){const n=c.pointDistance(e.line.st,i.line.st);n<r&&(r=n,t=i,s=1)}if(!i.done2){const n=c.pointDistance(e.line.st,i.line.et);n<r&&(r=n,t=i,s=2)}}if(s>0&&t)return{minLine:t,minStart:s,minDis:r}}else{let t,r=1e10,s=-1;for(const i of n)if(e!==i){if(!i.done1){const n=c.pointDistance(e.line.et,i.line.st);n<r&&(r=n,t=i,s=1)}if(!i.done2){const n=c.pointDistance(e.line.et,i.line.et);n<r&&(r=n,t=i,s=2)}}if(s>0&&t)return{minLine:t,minStart:s,minDis:r}}}for(const e of d){if(e.done1&&e.done2)continue;const t=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize(),n=d.filter((n=>{if(n===e)return!1;const r=(new o.Vector2).subVectors(n.line.et,n.line.st).normalize();return Math.abs(t.dot(r))>Math.cos(Math.PI/18)}));if(n.length){if(!e.done1){const t=u(e,!0,n);if(t&&t.minDis<8*l){const n=u(t.minLine,1===t.minStart,d);if(n&&n.minLine===e&&1===n.minStart){let n=s(e,1,t.minLine,t.minStart);n&&a.push(n)}}}if(!e.done2){const t=u(e,!1,n);if(t&&t.minDis<8*l){const n=u(t.minLine,1===t.minStart,d);if(n&&n.minLine===e&&2===n.minStart){let n=s(e,2,t.minLine,t.minStart);n&&a.push(n)}}}}}if(d=a.filter((e=>!(e.done1&&e.done2))),d.length<=1)return a;for(const e of d){if(e.done1&&e.done2)continue;(new o.Vector2).subVectors(e.line.et,e.line.st).normalize();const t=d.filter((t=>t!==e));if(t.length){if(!e.done1){const n=u(e,!0,t);if(n){const t=u(n.minLine,1===n.minStart,d);if(t&&t.minLine===e&&1===t.minStart){let t=i(e,1,n.minLine,n.minStart,n.minDis);t&&a.push(t)}}}if(!e.done2){const n=u(e,!1,t);if(n){const t=u(n.minLine,1===n.minStart,d);if(t&&t.minLine===e&&2===t.minStart){let t=i(e,2,n.minLine,n.minStart,n.minDis);t&&a.push(t)}}}}}if(d=a.filter((e=>!(e.done1&&e.done2))),d.length<1)return a;function h(e,n){let r=t.filter((t=>c.getLineDistance(e,n,t)<4*l)),s=r.map((t=>c.getLineParam(e,n,t))),i=s.filter((e=>e<0)),d=s.filter((e=>e>0));i.sort(((e,t)=>t-e)),d.sort(((e,t)=>e-t));let u=0,h=0;for(const e of i)Math.abs(e-u)<8*l&&(u=e);for(const e of d)Math.abs(e-h)<8*l&&(h=e);if(h-u>10*l&&r.length&&!a.filter((t=>{const r=(new o.Vector2).subVectors(t.line.et,t.line.st).normalize();if(Math.abs(n.dot(r))>Math.cos(Math.PI/18)){const r=(new o.Vector2).subVectors(t.line.st,e);if(Math.abs(r.cross(n))<10*l){let r=c.getLineParam(e,n,t.line.st),s=c.getLineParam(e,n,t.line.et);if(r>s){let e=r;r=s,s=e}return!(s<u||r>h)}}return!1})).length)return{line:{st:c.getLinePt(e,n,u),et:c.getLinePt(e,n,h)},done1:!0,done2:!0,pts:r}}for(const e of d){if(e.done1&&e.done2)continue;const t=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize();if(!e.done1){let n=h(e.line.st,new o.Vector2(-t.y,t.x));n&&a.push(n),e.done1=!0}if(!e.done2){let n=h(e.line.st,new o.Vector2(-t.y,t.x));n&&a.push(n),e.done2=!0}}return a}(s,n);const i=(e,t,n)=>{const r=n.sort(((e,t)=>e[0]-t[0]));let s=e;const i=[],o=e=>{s<e-1e-6&&i.push([s,e])};for(const e of r)o(e[0]),e[1]>s&&(s=e[1]);return o(t),i},a=[];for(const[e,t]of r){const n=e.line,r=(new o.Vector2).subVectors(n.et,n.st).normalize(),d=c.getLineParam(n.st,r,n.et),u=e,h=t.map((e=>{let t=c.getLineParam(n.st,r,e.line.st),s=c.getLineParam(n.st,r,e.line.et);if(t>s){const n=t;t=s,s=n;const r=e.line.st;e.line.st=e.line.et,e.line.et=r}return Math.abs(t)<4*l&&(t=0),Math.abs(s-d)<4*l&&(s=d),{range:[t,s],line:e}})),g=i(0,d,h.map((e=>e.range))),f=s.indexOf(u);s.splice(f,1);for(const t of g){const s=c.getLinePt(n.st,r,t[0]),i=c.getLinePt(n.st,r,t[1]);a.push({line:{st:s,et:i},pts:e.pts})}for(const e of h)e.range[0]>0&&e.range[0]<d&&a.push({line:{st:e.line.line.st,et:c.getLinePt(n.st,r,e.range[0])},pts:[]}),e.range[1]>0&&e.range[1]<d&&a.push({line:{st:e.line.line.et,et:c.getLinePt(n.st,r,e.range[1])},pts:[]});s=s.concat(t)}return s=s.concat(a),s}t.roomBuild2d=function(e){const t=e.pointcloud,n=new o.Box2;n.setFromPoints(t);let r=h(t,30);if(r.mainLines.length||(r=h(t,20)),!r.mainLines.length)return;let s=function(e){const t=[];for(const n of e){const e=n.line,r=(new o.Vector2).subVectors(e.et,e.st).normalize(),s=n.pts[0];n.pts.sort(((e,t)=>c.getLineParam(s,r,e)-c.getLineParam(s,r,t)));let i=0,a=0;for(let e=2;e<n.pts.length;e++){const r=(new o.Vector2).subVectors(n.pts[e],n.pts[e-1]).normalize(),s=(new o.Vector2).subVectors(n.pts[e-1],n.pts[e-2]).normalize();i===a?Math.abs(Math.abs(r.dot(s))-1)<1e-4&&(i=e-2,a=e):(Math.abs(Math.abs(r.dot(s))-1)<1e-4||(a-i>10&&t.push({v:s,len:(new o.Vector2).subVectors(n.pts[a],n.pts[i]).length}),i=e),a=e)}if(a-i>10){let e=(new o.Vector2).subVectors(n.pts[a],n.pts[i]),r=e.length;t.push({v:e.normalize(),len:r})}}if(0===t.length)return;const n=[];for(const e of t){let t=!1;for(const r of n)if(Math.abs(e.v.dot(r[0].v))>Math.cos(Math.PI/12)){r.push(e),t=!0;break}t||n.push([e])}n.sort(((e,t)=>t.length-e.length)),1===n[0].length&&n.sort(((e,t)=>t[0].len-e[0].len));let r=n[0][0].v;return{dx:r,dy:new o.Vector2(-r.y,r.x)}}(r.mainLines);s||(s=function(e){const t=e.map((e=>{const t=e.line,n=(new o.Vector2).subVectors(t.et,t.st),r=n.length;return{v:n.normalize(),len:r}})),n=[];for(const e of t){let t=!1;for(const r of n)if(Math.abs(e.v.dot(r[0].v))>Math.cos(Math.PI/12)){r.push(e),t=!0;break}t||n.push([e])}n.sort(((e,t)=>t.length-e.length)),1===n[0].length&&n.sort(((e,t)=>t[0].len-e[0].len));let r=n[0][0].v;for(let e=1;e<n[0].length;e++){const t=n[0][e].v;r.dot(t)<0?r.add(t.negate()):r.add(t)}return r=new o.Vector2(r.x/n[0].length,r.y/n[0].length),{dx:r,dy:new o.Vector2(-r.y,r.x)}}(r.mainLines)),r.mainLines=function(e,t,n){for(const r of e){let e,s;if(Math.abs(r.dir.dot(t))>Math.cos(Math.PI/18))e=t,s=n;else{if(!(Math.abs(r.dir.dot(n))>Math.cos(Math.PI/18)))continue;e=n,s=t}let i=new o.Vector2;r.pts.forEach((e=>i.add(e))),i.divideScalar(r.pts.length);const a=new Map;for(const e of r.pts){let t=!1;const n=(new o.Vector2).subVectors(new o.Vector2(e.x,e.y),i).dot(s);for(let[r,s]of a)if(Math.abs(r-n)<.01){t=!0,s.push(e);break}t||a.set(n,[e])}const l=Array.from(a.values());l.sort(((e,t)=>t.length-e.length)),l.length&&l[0].length>.5*r.pts.length&&(i=new o.Vector2(l[0][0].x,l[0][0].y)),r.line.st=c.getLinePt(i,e,c.getLineParam(i,e,r.line.st)),r.line.et=c.getLinePt(i,e,c.getLineParam(i,e,r.line.et))}return e}(r.mainLines,s.dx,s.dy);const{shortLines:i,leftPoints:a}=g(r.leftPoints,r.mainLines.map((e=>e.line)),s,n);!function(e,t){function n(e,t){const n=[],r=new Set;for(let s=0;s<e.length;s++){const i=e[s];if(r.has(i))continue;const a=(new o.Vector2).subVectors(i.line.et,i.line.st).normalize(),l=c.getLineParam(i.line.st,a,i.line.et),u=[];for(let e=0;e<t.length;e++){const n=t[e];if(r.has(n)||n===i)continue;const s=(new o.Vector2).subVectors(n.line.et,n.line.st).normalize();if(Math.abs(a.dot(s))<Math.cos(Math.PI/18))continue;if(c.getLineDistance(i.line.st,a,n.line.et)>.5*d)continue;const h=.5*(c.getLineParam(i.line.st,a,n.line.st)+c.getLineParam(i.line.st,a,n.line.et));h<=l&&h>=0&&(u.push(n),r.add(n))}u.length&&(r.add(i),u.unshift(i),n.push(u))}return n}function r(e,t){let n=1e10,r=e[0];for(const s of e){const e=(new o.Vector2).subVectors(s.line.et,s.line.st),i=e.length(),a=e.normalize();let l=c.getLineDistance(s.line.st,a,t);const d=c.getLineParam(s.line.st,a,t);d<0?l=(new o.Vector2).subVectors(s.line.st,t).length():d>i&&(l=(new o.Vector2).subVectors(s.line.et,t).length()),l<n&&(n=l,r=s)}return r}function s(e,t){if(!t||t.length<2)return!1;const n=(new o.Vector2).subVectors(e.line.et,e.line.st).normalize(),r=t.map((t=>c.getLineParam(e.line.st,n,t)));r.sort(((e,t)=>e-t));const s=r[r.length-1]-r[0];for(let e=0;e<r.length-1;e++)if(r[e+1]-r[e]>.68*s)return!1;return!0}function i(e,t){const n=new Set;for(const t of e)t.pts.forEach((e=>n.add(e)));for(const s of n){const n=r(e,s);let i=t.get(n);i||(i=[],t.set(n,i)),i.push(s)}}const a=n(t,t);for(const e of a){const n=new Map;i(e,n),e.sort(((e,t)=>{const n=c.pointDistance(e.line.st,e.line.et);return c.pointDistance(t.line.st,t.line.et)-n}));for(let r=e.length-1;r>=0;r--){const i=e[r];s(i,n.get(i))||(e.splice(r,1),t.splice(t.indexOf(i),1))}if(e.length>1){const n=e[0],r=(new o.Vector2).subVectors(n.line.et,n.line.st).length(),s=(new o.Vector2).subVectors(n.line.et,n.line.st).normalize();for(let i=e.length-1;i>0;i--){const a=e[i];if((new o.Vector2).subVectors(a.line.et,a.line.st).length()<.1*r&&a.pts.length<=6){t.splice(t.indexOf(a),1);continue}let l=a.pts.sort(((e,t)=>c.getLineParam(n.line.st,s,e)-c.getLineParam(n.line.st,s,t))),d=0;for(let e=1;e<l.length;e++){const t=(new o.Vector2).subVectors(l[e],l[e-1]).normalize();Math.abs(Math.abs(t.dot(s))-1)<1e-4&&(d+=1)}d<.7*l.length&&t.splice(t.indexOf(a),1)}}}const l=n(e,t);for(const e of l){const n=new Map;i(e,n);const r=e[0],a=(new o.Vector2).subVectors(r.line.et,r.line.st).length(),l=(new o.Vector2).subVectors(r.line.et,r.line.st).normalize();for(let r=e.length-1;r>0;r--){const i=e[r],c=(new o.Vector2).subVectors(i.line.et,i.line.st).length(),l=n.get(i);s(i,l)||(e.splice(r,1),t.splice(t.indexOf(i),1)),c<.15*a&&l.length<=8&&(e.splice(r,1),t.splice(t.indexOf(i),1))}for(let t=e.length-1;t>0;t--){const s=e[t],i=n.get(s);let o=c.getLineParam(r.line.st,l,s.line.st),a=c.getLineParam(r.line.st,l,s.line.et);if(o>a){const e=a;a=o,o=e}n.get(r).filter((e=>{let t=c.getLineParam(r.line.st,l,e);return t>=o&&t<=a})).length<.3*i.length&&(s.overlap_line=r)}}}(r.mainLines,i);let l=f(r.mainLines,i,t);return{line2d:l.map((e=>{const t=e.line;let n=(new o.Vector2).subVectors(t.et,t.st);const r=n.length();return n=n.normalize(),{type:"ln2",data:[[1e3*t.st.x,1e3*t.st.y],[n.x,n.y],[0,1e3*r]]}})),resultLines:l.map((e=>e.line)),leftPoints:a}}},11221:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.lineIntersect=t.lineIntersectHull=t.vecAngle=t.linearRegression=t.ransac=t.getLineDistance=t.getLinePt=t.getLineParam=t.pointDistance=t.pointInPolygon2D=t.minDistanceToPts=t.PtInLoopType=t.addPtToBox=t.centroidOfPts=void 0;const o=i(n(88441)),a=i(n(34032));function c(e,t,n=.001){return e===t||Math.abs(e-t)<=n}function l(e,t,n=.001){return e-t<-n}function d(e,t,n=.001){return e-t>n}function u(e,t,n=.001){return e-t>=-n}function h(e,t){return Array.isArray(e)?Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])):Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}function g(e,t,n){const r=n.x-e.x,s=n.y-e.y;return r*t.x+s*t.y}function f(e,t,n){return{x:e.x+t.x*n,y:e.y+t.y*n}}function p(e,t,n){const r=n.x-e.x,s=n.y-e.y;return Math.abs(r*t.y-s*t.x)}t.centroidOfPts=function(e,t){let n=0,r=0;for(let s=0;s<e.length;s++)n+=e[s][0]-t[0],r+=e[s][1]-t[1];return[n/e.length+t[0],r/e.length+t[1]]},t.addPtToBox=function(e,t){const n=Math.min(t[0],e.min[0]),r=Math.min(t[1],e.min[1]),s=Math.max(t[0],e.max[0]),i=Math.max(t[1],e.max[1]);e.min=[n,r],e.max=[s,i]},function(e){e[e.Inside=1]="Inside",e[e.Outside=0]="Outside",e[e.OnEdge=-1]="OnEdge",e[e.OnVertex=-2]="OnVertex"}(t.PtInLoopType||(t.PtInLoopType={})),t.minDistanceToPts=function(e,t){let n=Number.MAX_VALUE;return e.forEach((e=>{const r=e[0]-t[0],s=e[1]-t[1],i=r*r+s*s;i<n&&(n=i)})),Math.sqrt(n)},t.pointInPolygon2D=function(e,t,n=.001){let r=0;const s=t.length;if(s<3)return 0;let i=t[0];for(let o=1;o<=s;++o){const a=o===s?t[0]:t[o];if(c(a.y,e.y,n)&&(c(a.x,e.x,n)||c(i.y,e.y,n)&&d(a.x,e.x,n)===l(i.x,e.x,n)))return-1;if(l(i.y,e.y,n)!==l(a.y,e.y,n))if(u(i.x,e.x,n))if(d(a.x,e.x,n))r=1-r;else{const t=i.x-e.x,s=i.y-e.y,o=a.x-e.x,c=a.y-e.y,l=a.x-i.x,u=a.y-i.y,h=t*c-o*s;if(h*h<=n*n*(l*l+u*u))return-1;h>0===d(a.y,i.y,n)&&(r=1-r)}else if(d(a.x,e.x,n)){const t=i.x-e.x,s=i.y-e.y,o=a.x-e.x,c=a.y-e.y,l=a.x-i.x,u=a.y-i.y,h=t*c-o*s;if(h*h<=n*n*(l*l+u*u))return-1;h>0===d(a.y,i.y,n)&&(r=1-r)}i=a}return r},t.pointDistance=h,t.getLineParam=g,t.getLinePt=f,t.getLineDistance=p,t.ransac=function(e,t){if(e.length<2)return;if(2===e.length){if(h(e[0],e[1])<.001)return;return{line:{st:e[0],et:e[1]},innerPts:[e[0],e[1]]}}const n=Math.ceil(e.length/2),r=[];for(let s=0;s<n;s++){const n=Math.floor(Math.random()*e.length),s=Math.floor(Math.random()*e.length);if(n===s||h(e[n],e[s])<.001)continue;const i={st:e[n],et:e[s]},a=(new o.Vector2).subVectors(i.et,i.st).normalize(),c=e.filter((r=>p(e[n],a,r)<t));r.push({line:i,lineDir:a,innerPts:c})}if(!r.length)return;r.sort(((e,t)=>e.innerPts.length-t.innerPts.length));const s=r.pop();if(s.innerPts.length<2)return;const i=s.innerPts.map((e=>g(s.line.st,s.lineDir,e)));return i.sort(((e,t)=>e-t)),{line:{st:f(s.line.st,s.lineDir,i[0]),et:f(s.line.st,s.lineDir,i[i.length-1])},innerPts:s.innerPts}},t.linearRegression=function(e){if(e.length<2)return;if(2===e.length&&h(e[0],e[1])<.001)return;let t=0,n=0;for(let r=0;r<e.length;r++)t+=e[r].x,n+=e[r].y;let r=t/e.length,s=n/e.length,i=0,o=0,c=0;for(let t=0;t<e.length;t++){const n=e[t].x-r,a=e[t].y-s;i+=n*n,o+=n*a,c+=a*a}const l=a.eig([[i,o],[o,c]]);if(l.E.x.length>0){let t={x:r,y:s},n={x:l.E.x[0][0],y:l.E.x[0][1]};const i=e.slice().sort(((e,r)=>g(t,n,e)-g(t,n,r)));return{st:f(t,n,g(t,n,i[0])),et:f(t,n,g(t,n,i[i.length-1]))}}},t.vecAngle=function(e,t){const n=Math.sqrt(e[0]*e[0]+e[1]*e[1]),r=Math.sqrt(t[0]*t[0]+t[1]*t[1]);return Math.acos((e[0]*t[0]+e[1]*t[1])/n/r)},t.lineIntersectHull=function(e,t,n,r){const s=[];for(let i=0;i<e.length-1;i++){if(e[i].y<=t&&e[i+1].y<=t)continue;if(e[i].y>=n&&e[i+1].y>=n)continue;const o=e[i+1].y-e[i].y;Math.abs(o)<=1e-4&&(s.push(Math.floor(e[i].x/r)),s.push(Math.floor(e[i+1].x/r)));const a=(e[i+1].x-e[i].x)*(t-e[i].y)/o+e[i].x,c=(e[i+1].x-e[i].x)*(n-e[i].y)/o+e[i].x;s.push(Math.floor(a/r)),s.push(Math.floor(c/r))}return s.sort(((e,t)=>e-t)),s.length?{start:s[0],end:s[s.length-1]}:{start:0,end:0}},t.lineIntersect=function(e,t,n,r){const s=(new o.Vector2).subVectors(t,e).normalize(),i=(new o.Vector2).subVectors(r,n).normalize();if(Math.abs(s.dot(i))>Math.cos(Math.PI/36))return;const c=[[s.x,-i.x],[s.y,-i.y]],l=[n.x-e.x,n.y-e.y];return f(e,s,a.solve(c,l)[0])}},63607:function(e,t,n){"use strict";n(11166);const r=n(76752);(()=>{const e=document.createElement("div");Object.assign(e.style,{position:"fixed",left:0,top:0,right:0,bottom:0,zIndex:1,background:"white"}),document.body.appendChild(e),document.body.ondragstart=null;(new r.App).start({root:e})})()},40948:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CalJointedInstanceGRep=t.EN_JOINT_TYPE=void 0;const r=n(98106),s=n(16472),i=n(31667),o=n(77087);var a;!function(e){e[e.UNKOWN=0]="UNKOWN",e[e.START=1]="START",e[e.END=2]="END",e[e.MIDDLE=3]="MIDDLE"}(a=t.EN_JOINT_TYPE||(t.EN_JOINT_TYPE={}));t.CalJointedInstanceGRep=class{static excute(e){if(e.length<2)return i.DebugWarn.assert(!1,"连接中构件数量小于2，不更新构件GRep！","",""),!1;const t=[];for(let n=0;n<e.length;n++)e[n].connectType===a.MIDDLE&&t.push(n);if(t.length>1)return i.DebugWarn.assert(!1,"单个构件连接节点中，禁止存在两个Middle类型！","",""),!1;if(1===t.length&&0!==t[0]){const n=e[t[0]];e.splice(t[0],1),e.splice(0,0,n)}for(let t=0;t<e.length;t++){if(e[t].connectType===a.UNKOWN||!e[t].startTip||!e[t].endTip||!e[t].centerCurve||0!==t&&e[t].connectType===a.MIDDLE)return i.DebugWarn.assert(!1,"连接中构件数据不合法，不更新构件GRep！","",""),!1;if(e[t].centerCurve.getType()!==r.EN_GEO_ELEMENT_TYPE.EN_LINE_2D)return i.DebugWarn.assert(!1,"墙连接暂时只支持直线！","",""),!1}for(const t of e)if(!this._initEmptySectionTip(t))return i.DebugWarn.assert(!1,"初始化空的端头轮廓失败，不更新构件GRep！","",""),!1;for(const t of e)if(!this._rollBackSectionTip(t))return i.DebugWarn.assert(!1,"回滚连接端失败，不更新构件GRep！","",""),!1;this._showInstanceSection(e,"回滚后");const n=e[0],c=e[1],l=n.centerCurve.clone();l.offset(n.width/2);const d=n.centerCurve.clone();d.reverse(),d.offset(n.width/2);const u=c.centerCurve.clone();u.offset(c.width/2);const h=c.centerCurve.clone();if(h.reverse(),h.offset(c.width/2),n.connectType===a.MIDDLE);else{const e=n.connectType===a.START?n.centerCurve.getEndPt():n.centerCurve.getStartPt();let t;t=r.MathAlg.CalculateDistance.pointToCurve2dSigned(e,c.centerCurve)<0?u:h,o.FitJointTipToTargetCurve.excute(n,t)}const g=c.connectType===a.START?c.centerCurve.getEndPt():c.centerCurve.getStartPt();let f;if(f=r.MathAlg.CalculateDistance.pointToCurve2dSigned(g,n.centerCurve)>0?l:d,o.FitJointTipToTargetCurve.excute(c,f),e.length>2){const t=this._getInstanceSection(e[0]),n=this._getInstanceSection(e[1]);let o=r.MathAlg.BoolOperate2d.union([t,n]);for(let t=2;t<e.length;t++){const n=this._getInstanceSection(e[t]);let c=r.MathAlg.BoolOperate2d.difference(n,[o]),l=-1,d=-1;if(!c.isOnlyLines())return i.DebugWarn.assert(!1,"墙连接暂时只支持直线！","",""),!1;const u=.001;c=s.PolygonOffset.execute(c,-u).offsetPolygon,c=s.PolygonOffset.execute(c,u).offsetPolygon,c=s.PolygonOffset.execute(c,u).offsetPolygon,c=s.PolygonOffset.execute(c,-u).offsetPolygon;const h=c.getAllCurves();for(let n=0;n<h.length;n++){const s=h[n];s.getDirection().reverse().isSameDirection(e[t].centerCurve.getStartTangent())&&r.MathUtil.isNearlyEqual(r.MathAlg.CalculateDistance.pointToCurve2dSigned(e[t].centerCurve.getMidPt(),s),-e[t].width/2,r.Tolerance.LENGTH_EPS)?l=n:s.getDirection().isSameDirection(e[t].centerCurve.getStartTangent())&&r.MathUtil.isNearlyEqual(r.MathAlg.CalculateDistance.pointToCurve2dSigned(e[t].centerCurve.getMidPt(),s),-e[t].width/2,r.Tolerance.LENGTH_EPS)&&(d=n)}if(-1===l||-1===d)return i.DebugWarn.warn(!1,"连接时查找端头多段线出错，不更新构件GRep！","",""),!1;if(e[t].connectType===a.START){let n=0;n=d>l?d-l-1:d+h.length-l-1;const s=[];let i=0;for(;i<n;)i++,s.push(h[(l+i)%h.length]);e[t].startTip=new r.PolyCurve(s)}else{if(e[t].connectType!==a.END)return i.DebugWarn.warn(!1,"连接时修改构件轮廓出错，不更新构件GRep！","",""),!1;{let n=0;n=l>d?l-d-1:l+h.length-d-1;const s=[];let i=0;for(;i<n;)i++,s.push(h[(d+i)%h.length]);e[t].endTip=new r.PolyCurve(s)}}t!==e.length-1&&(o=r.MathAlg.BoolOperate2d.union([o,n]))}}return this._isInstanceDataValid(e)?(this._showInstanceSection(e,"连接后"),!0):(i.DebugWarn.warn(!1,"连接时修改得到的构件轮廓不合法，不更新构件GRep！","",""),!1)}static _initEmptySectionTip(e){if(e.startTip.getAllCurves().length<1){const t=new r.Line2d(e.centerCurve.getStartPt(),e.centerCurve.getStartPt().add(e.centerCurve.getStartTangent().vecRotated(-r.CONST.PI_2).multiplied(e.width/2)));t.extend(e.width/2,!1),e.startTip=new r.PolyCurve([t])}if(e.endTip.getAllCurves().length<1){const t=new r.Line2d(e.centerCurve.getEndPt(),e.centerCurve.getEndPt().add(e.centerCurve.getEndTangent().vecRotated(r.CONST.PI_2).multiplied(e.width/2)));t.extend(e.width/2,!1),e.endTip=new r.PolyCurve([t])}return!0}static _rollBackSectionTip(e){if(e.connectType===a.MIDDLE)return!0;if(e.connectType===a.START){const t=new r.Line2d(e.centerCurve.getStartPt(),e.centerCurve.getStartPt().add(e.centerCurve.getStartTangent().vecRotated(-r.CONST.PI_2).multiplied(e.width/2)));return t.extend(e.width/2,!1),e.startTip=new r.PolyCurve([t]),!0}if(e.connectType===a.END){const t=new r.Line2d(e.centerCurve.getEndPt(),e.centerCurve.getEndPt().add(e.centerCurve.getEndTangent().vecRotated(r.CONST.PI_2).multiplied(e.width/2)));return t.extend(e.width/2,!1),e.endTip=new r.PolyCurve([t]),!0}return i.DebugWarn.assert(!1,"构件连接类型错误！","",""),!1}static _isInstanceDataValid(e){for(const t of e){const e=t.centerCurve.clone();e.offset(t.width/2),e.extendDouble(r.CONST.MODEL_MAX_LENGTH);const n=t.centerCurve.clone();n.reverse(),n.offset(t.width/2),n.extendDouble(r.CONST.MODEL_MAX_LENGTH);const s=new r.Loop([e,...t.endTip.getAllCurves(),n,...t.startTip.getAllCurves()]);if(s.makeStartEndConnected(),!s.isValid()||!s.isAnticlockwise())return!1}return!0}static _getInstanceSection(e){const t=e.centerCurve.clone();t.offset(e.width/2),t.extendDouble(r.CONST.MODEL_MAX_LENGTH);const n=e.centerCurve.clone();n.reverse(),n.offset(e.width/2),n.extendDouble(r.CONST.MODEL_MAX_LENGTH);const s=new r.Loop([t,...e.endTip.getAllCurves(),n,...e.startTip.getAllCurves()]);return s.makeStartEndConnected(),s}static _showInstanceSection(e,t){}}},77087:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FitJointTipToTargetCurve=void 0;const r=n(98106),s=n(31667),i=n(40948);t.FitJointTipToTargetCurve=class{static excute(e,t){if(e.connectType!==i.EN_JOINT_TYPE.START&&e.connectType!==i.EN_JOINT_TYPE.END)return s.DebugWarn.assert(!1,"贴合算法中连接类型只能是端头连接！","",""),!1;if(e.centerCurve.getType()===r.EN_GEO_ELEMENT_TYPE.EN_LINE_2D&&t.getType()===r.EN_GEO_ELEMENT_TYPE.EN_LINE_2D&&e.centerCurve.isParallelTo(t))return!1;const n=e.centerCurve.clone();n.reverse(),n.offset(e.width/2);const o=e.centerCurve.clone();o.offset(e.width/2),n.extendDouble(r.CONST.MODEL_MAX_LENGTH),o.extendDouble(r.CONST.MODEL_MAX_LENGTH);const a=t.clone();a.extendDouble(r.CONST.MODEL_MAX_LENGTH);const c=r.MathAlg.CalculateIntersect.curve2ds(n,a),l=r.MathAlg.CalculateIntersect.curve2ds(o,a);if(1!==c.length||1!==l.length||!c[0].point||!l[0].point)return s.DebugWarn.assert(!1,"直线与直线求交，交点为空或不唯一！","",""),!1;const d=e.centerCurve.clone().getDirection().normalize().multiplied(1e-6);return e.connectType===i.EN_JOINT_TYPE.START?e.startTip=new r.PolyCurve([new r.Line2d(c[0].point.add(d.clone().multiplied(-1)),l[0].point.add(d.clone().multiplied(-1)))]):e.endTip=new r.PolyCurve([new r.Line2d(l[0].point.add(d),c[0].point.add(d))]),!0}}},45449:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Bool2d=t.Bool2dType=void 0;const r=n(16178),s=n(44210),i=n(95307),o=n(25814),a=n(46663),c=n(56973),l=n(59605),d=n(83467);var u;!function(e){e[e.union=0]="union",e[e.intersect=1]="intersect",e[e.difference=2]="difference",e[e.xor=3]="xor",e[e.split=4]="split"}(u=t.Bool2dType||(t.Bool2dType={}));t.Bool2d=class{static boolOperate(e,t,n,i=c.Tolerance.LENGTH_EPS,o=c.Tolerance.ANGLE_EPS){const l=e.map((e=>this._toFace2d(e))),d=t.map((e=>this._toFace2d(e)));a.intersectFaces(l,d,i,o);return this.boolOperateCore(l,d,n,i,o).map((e=>{const t=e.loops.map((e=>new r.Loop(e))),n=new s.Polygon;return t.forEach((e=>n.addLoop(e,!1))),n}))}static boolOperateCore(e,t,n,r=c.Tolerance.LENGTH_EPS,s=c.Tolerance.ANGLE_EPS,a,h,g){if(n===u.difference){let n=e;h||(n=o.faces2DUnion(e,[],r,s,a));let c=t;return g||(c=o.faces2DUnion([],t,r,s,a)),i.faces2DDifference(n,c,r,s,a)}if(n===u.union)return o.faces2DUnion(e,t,r,s,a);if(n===u.intersect){let n=e;h||(n=o.faces2DUnion(e,[],r,s,a));let i=t;return g||(i=o.faces2DUnion([],t,r,s,a)),l.faces2DIntersect(n,i,r,s,a)}if(n===u.split)return d.faces2DSplit(e,t,r,s,a);throw new Error("二维布尔运算类型：暂未支持")}static _toFace2d(e){return e instanceof r.Loop?{loops:[e.getAllCurves().map((e=>e.clone()))]}:{loops:e.getLoops().map((e=>e.getAllCurves().map((e=>e.clone()))))}}}},95307:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.faces2DDifference=void 0;const r=n(46663),s=n(16178),i=n(56973);function o(e,t=i.Tolerance.LENGTH_EPS){e.insideFaces&&e.insideFaces.length?e.face.bBlankFace?e.bValid=!1:e.bValid=!0:e.onFaces&&e.onFaces.length?e.face.bBlankFace?r.validateOverlapCurveGroup(e,t,!0):e.bValid=!1:e.bValid=!!e.face.bBlankFace}function a(e,t){const n=new Set;for(const r of e)t.has(r)&&n.add(r);return n}function c(e,t){e.box||r.calculateFaceBBox(e);let n=Array.from(t).filter((e=>e.bBlankFace));if(!n.length){let e;for(const n of t){const t=new Set;for(const e of n.bcGroups)e.insideFaces&&e.insideFaces.filter((e=>e.bBlankFace)).forEach((e=>t.add(e)));e=e?a(e,t):t}e&&(n=Array.from(e))}const s=new Set;for(const t of n)t.originFaces.forEach((t=>{t.box.intersectsBox(e.box)&&s.add(t)}));return Array.from(s).sort(((e,t)=>(e.bBlankFace?0:1)-(t.bBlankFace?0:1)))}t.faces2DDifference=function(e,t,n,i,a){const l=[];e.forEach((e=>{e.bBlankFace=!0})),t.forEach((e=>{e.bBlankFace=!1})),r.splitLoopsIntoGroup(e,t,n);const d=[...e,...t];d.forEach((e=>r.calculateFaceBBox(e)));const u=new Map;e.forEach((e=>r.calculatePositionInfo(e,t,n,i,u))),t.forEach((t=>r.calculatePositionInfo(t,e,n,i,u)));for(const e of d)e.loops.length&&void 0===e.bPositive&&(e.bPositive=new s.Loop(e.loops[0]).isAnticlockwise());for(const e of d)if(void 0!==e.bPositive)for(const t of e.bcGroups)o(t,n);const h=[];for(const t of e)t.bcGroups.length&&(t.bcGroups.every((e=>e.bValid))&&!u.get(t)?(t.originFaces=c(t,new Set([t])),l.push(t)):h.push(t));return h.length?(r.generateResult([...h,...t],l,2,c,n,i,a),l.forEach((e=>{if(e.originFaces&&1===e.originFaces.length&&e.originFaces[0].bPositive!==e.bPositive){const t=e.loops.map((e=>(e.reverse(),e.forEach((e=>e.reverse())),e)));e.loops=t}})),l):l}},59605:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.faces2DIntersect=void 0;const r=n(46663),s=n(16178),i=n(56973);function o(e,t=i.Tolerance.LENGTH_EPS){e.insideFaces&&e.insideFaces.length?e.bValid=!0:e.onFaces&&e.onFaces.length&&e.face.bBlankFace?r.validateOverlapCurveGroup(e,t):e.bValid=!1}function a(e,t){e.box||r.calculateFaceBBox(e);const n=new Set;for(const r of t)r.originFaces.forEach((t=>{t.box.intersectsBox(e.box)&&n.add(t)}));const s=Array.from(n);return s.sort(((e,t)=>(e.bBlankFace?0:1)-(t.bBlankFace?0:1))),s}t.faces2DIntersect=function(e,t,n,i,c){const l=[];e.forEach((e=>{e.bBlankFace=!0})),t.forEach((e=>{e.bBlankFace=!1})),r.splitLoopsIntoGroup(e,t,n);const d=[...e,...t];d.forEach((e=>r.calculateFaceBBox(e))),e.forEach((e=>r.calculatePositionInfo(e,t,n,i))),t.forEach((t=>r.calculatePositionInfo(t,e,n,i)));for(const e of d)e.loops.length&&void 0===e.bPositive&&(e.bPositive=new s.Loop(e.loops[0]).isAnticlockwise());for(const e of d)if(void 0!==e.bPositive)for(const t of e.bcGroups)o(t,n);return r.generateResult(d,l,1,a,n,i,c),l}},83467:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.faces2DSplit=void 0;const r=n(81726),s=n(46663),i=n(68990),o=n(16178),a=n(90361),c=n(58074),l=n(41454),d=n(90676),u=n(50265),h=n(44210),g=n(55654),f=n(85232);class p{constructor(e){this.curve=e,this.validP=!0,this.validN=!0}}function _(e){let t;return t=e instanceof i.Curve2d?e.getMidPt():c.LoopCentroid.centroidOfLoop(e.loops[0]),`${Math.round(1e3*t.x)}/${Math.round(1e3*t.y)}`}function m(e){let t,n=[e];for(;n&&n.length&&n!==t;)t=n,n=n[0].originFaces;return t}function v(e,t){return t===e.dir>0?e.uCurve.validP:e.uCurve.validN}function E(e,t){e&&(t===e.dir>0?e.uCurve.validP=!1:e.uCurve.validN=!1)}t.faces2DSplit=function(e,t,n,c,P){const y=[];e.forEach((e=>{e.bBlankFace=!0}));const C=new a.Box2,S=new Map;for(const n of[...e,...t]){const e=new a.Box2;for(const t of n.loops)for(const n of t){const t=n.getBoundingBox();S.set(n,t),e.union(t)}S.set(n,e),C.union(e),n.loops.length&&(n.bPositive=new o.Loop(n.loops[0]).isAnticlockwise())}const T=[];for(const[e,t]of S){const n=t.getSize();T.push({x:Math.round(t.min.x),y:Math.round(t.min.y),width:n.x+2,height:n.y+2,obj:e})}const b=new r({x:Math.round(C.min.x)-50,y:Math.round(C.min.y)-50,width:C.getSize().x+100,height:C.getSize().y+100,maxElements:20});b.pushAll(T);const w=[],x=new Map;!function(e,t,n,r,o){const a=new Map;for(const t of e.keys()){const e=_(t);let n=a.get(e);n||(n=[],a.set(e,n)),n.push(t)}for(const e of a.values()){const a=e.filter((e=>e instanceof i.Curve2d)),c=[];a.forEach((e=>{let n,s=1;for(const t of c)if(l.CurveCurveOverlapJudge.execute(t.curve,e,r,o)===d.CurveCuvePositonType.TOTALLY_OVERLAP){n=t,t.curve.getStartPt().equals(e.getStartPt())&&t.curve.getStartTangent().equals(e.getStartTangent())||(s=0);break}n||(n=new p(e),c.push(n)),t.set(e,{uCurve:n,dir:s})}));const u=e.filter((e=>!(e instanceof i.Curve2d))),h=[];u.forEach((e=>{let t=!0;for(const n of h)if(s.areFacesTotallyOverlap(e,n,r,o)){t=!1;break}t&&e.loops.length&&h.push(e)})),n.push(...h)}}(S,x,w,n,c),w.sort(((e,t)=>(e.bBlankFace?0:1)-(t.bBlankFace?0:1)));for(const e of w){const t=S.get(e),r=t.getSize(),s=new Set;e.loops.forEach((e=>e.forEach((e=>s.add(e)))));let a=b.colliding({x:Math.round(t.min.x)-2,y:Math.round(t.min.y)-2,width:r.x+4,height:r.y+4});a=a.filter((e=>e.obj instanceof i.Curve2d&&!s.has(e.obj)));const c=[],l=e.loops.map((e=>new o.Loop(e))),p=new h.Polygon;l.forEach((e=>p.addLoop(e,!1))),a.forEach((e=>{u.PtPolygonPositionJudge.execute(e.obj.getMidPt(),p,n)===d.PtLoopPositonType.IN&&c.push(e.obj)}));const _=new Map,C=new Set;if(c.forEach((t=>{const n=x.get(t);if(!C.has(n.uCurve)){if(v(n,e.bPositive)&&_.set(t,n),v(n,!e.bPositive)){const e=t.clone();e.reverse(),_.set(e,{uCurve:n.uCurve,dir:n.dir?0:1})}C.add(n.uCurve)}})),s.forEach((t=>{const n=x.get(t);v(n,e.bPositive)&&_.set(t,n)})),!c.length&&s.size&&s.size===_.size){e.originFaces=m(e),y.push(e),e.loops.forEach((t=>t.forEach((t=>{const n=_.get(t);n&&E(n,e.bPositive)}))));continue}const T=g.SearchLoop2D.execute(Array.from(_.keys()),e.bPositive,n);f.ILoopsToPolygonExes.execute(T,!1,!0).map((e=>({loops:e.map((e=>e.getAllCurves())),bPositive:e[0].isAnticlockwise()}))).forEach((t=>{t.originFaces=m(e),y.push(t),t.loops.forEach((e=>e.forEach((e=>{const n=_.get(e);n&&(E(n,t.bPositive),null==P||P.set(e,n.uCurve.curve))}))))}))}return y}},25814:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.faces2DUnion=void 0;const r=n(46663),s=n(16178),i=n(56973);function o(e,t){const n=Array.from(t);for(;n.length;){const e=n.pop();let r=[];for(const t of e.bcGroups)t.onFaces&&(r=r.concat(t.onFaces)),t.insideFaces&&(r=r.concat(t.insideFaces));r=r.filter((e=>e&&!t.has(e))),r.forEach((e=>{n.push(e),t.add(e)}))}const r=Array.from(t);return r.sort(((e,t)=>(e.bBlankFace?0:1)-(t.bBlankFace?0:1))),r}function a(e,t=i.Tolerance.LENGTH_EPS){e.insideFaces&&e.insideFaces.length?e.bValid=!1:e.onFaces&&e.onFaces.length?r.validateOverlapCurveGroup(e,t):e.bValid=!0}t.faces2DUnion=function(e,t,n,i,c){const l=[];e.forEach((e=>{e.bBlankFace=!0})),t.forEach((e=>{e.bBlankFace=!1})),r.splitLoopsIntoGroup(e,t,n);const d=[...e,...t];d.forEach((e=>r.calculateFaceBBox(e))),d.forEach((e=>r.calculatePositionInfo(e,d,n,i)));for(const e of d)e.loops.length&&void 0===e.bPositive&&(e.bPositive=new s.Loop(e.loops[0]).isAnticlockwise());for(const e of d)if(void 0!==e.bPositive)for(const t of e.bcGroups)a(t,n);const u=[];for(const e of d)e.bcGroups.length&&(e.bcGroups.every((e=>e.bValid&&(!e.onFaces||!e.onFaces.length)))?(e.originFaces=o(0,new Set([e])),l.push(e)):u.push(e));return u.length?(r.generateResult(u,l,0,o,n,i,c),l):l}},46663:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateResult=t.areFacesTotallyOverlap=t.validateOverlapCurveGroup=t.calculatePositionInfo=t.calculateFaceBBox=t.splitLoopsIntoGroup=t.splitLoopByPoints=t.intersectFaces=t.Curve2dGroup=void 0;const r=n(90361),s=n(50265),i=n(16178),o=n(44210),a=n(90676),c=n(41454),l=n(45449),d=n(55654),u=n(85232),h=n(56973),g=n(17980);class f{constructor(e,t){this.face=e,this.curves=t}static curvesEqual(e,t,n,r){if(e.curves.length!==t.curves.length)return!1;for(const s of e.curves)if(t.curves.every((e=>c.CurveCurveOverlapJudge.execute(s,e,n,r)!==a.CurveCuvePositonType.TOTALLY_OVERLAP)))return!1;return!0}addInsideFace(e){this.insideFaces||(this.insideFaces=[]),this.insideFaces.push(e)}addOnFace(e){this.onFaces||(this.onFaces=[]),this.onFaces.push(e)}getReversedCurves(e){const t=[];for(const n of this.curves){const r=n.clone();if(r.reverse(),t.push(r),e){const t=e.get(n);t?e.set(r,t):e.set(r,n)}}return t}cloneCurves(e){const t=[];for(const n of this.curves){const r=n.clone();if(t.push(r),e){const t=e.get(n);t?e.set(r,t):e.set(r,n)}}return t}}function p(e,t,n,r,s){let i;if(r){for(const n of e.keys())if(r(n,t)){i=e.get(n);break}}else i=e.get(t);i||(i=[],e.set(t,i)),s?i.every((e=>!s(e,n)))&&i.push(n):i.push(n)}function _(e,t,n,r){const s=e.split(t,r);s.length||s.push(e),n.push(...s)}function m(e,t,n,r){const s=t.map((t=>e.findIndex((e=>e.getStartPt().equals(t,r)))));s.sort(((e,t)=>e-t));for(let t=0;t<s.length-1;t++)n.push(e.slice(s[t],s[t+1]));n.push(e.slice(s[s.length-1],e.length).concat(e.slice(0,s[0])))}t.Curve2dGroup=f,t.intersectFaces=function(e,t,n,r){const s=[...e,...t],i=[];for(const e of s)e.loops.forEach((e=>i.push(...e)));const o=i.map((e=>e.getBoundingBox())),a=new Map,c=new h.Tolerance(n,r);for(let e=0;e<i.length;e++)for(let t=e+1;t<i.length;t++)if(o[e].intersectsBox(o[t])){const n=g.CurveCurveIntersect.curve2ds(i[e],i[t],c);for(const r of n)r.isOverlap?(p(a,i[e],r.overlap1.min),p(a,i[e],r.overlap1.max),p(a,i[t],r.overlap2.min),p(a,i[t],r.overlap2.max)):(p(a,i[e],r.param1),p(a,i[t],r.param2))}for(const e of s){const t=[];for(const r of e.loops){const e=[];for(const t of r){const r=a.get(t);r?_(t,r,e,n):e.push(t)}t.push(e)}e.loops.splice(0,e.loops.length),t.forEach((t=>e.loops.push(t)))}},t.splitLoopByPoints=m,t.splitLoopsIntoGroup=function(e,t,n){const r=[...e,...t],s=new Map;for(const e of r)for(const t of e.loops)for(const e of t)p(s,e.getStartPt(),t,((e,t)=>e.equals(t,n)),((e,t)=>e===t));const i=new Map,o=[];for(const[e,t]of s)t.length>1&&(o.push(e),t.forEach((t=>p(i,t,e))));for(const e of r){e.bcGroups=[];for(const t of e.loops){const r=[],s=i.get(t);s&&s.length>1?m(t,s,r,n):r.push(t),r.forEach((t=>e.bcGroups.push(new f(e,t))))}}},t.calculateFaceBBox=function(e){if(e.box=new r.Box2,e.bcGroups)for(const t of e.bcGroups){t.box=new r.Box2;for(const e of t.curves)t.box.union(e.getBoundingBox());e.box.union(t.box)}else for(const t of e.loops)for(const n of t)e.box.union(n.getBoundingBox())},t.calculatePositionInfo=function(e,t,n,r,c){for(const l of t)if(e!==l&&e.box&&l.box&&e.box.intersectsBox(l.box))for(const t of e.bcGroups){if(!t.curves.length)continue;if(!t.box.intersectsBox(l.box))continue;const e=t.curves[0],d=l.loops.map((e=>new i.Loop(e))),u=s.PtPolygonPositionJudge.execute(e.getMidPt(),new o.Polygon(d),n);u===a.PtLoopPositonType.IN?(t.addInsideFace(l),c&&p(c,l,t,void 0,((e,t)=>f.curvesEqual(e,t,n,r)))):u!==a.PtLoopPositonType.ONEDGE&&u!==a.PtLoopPositonType.ONVERTEX||t.addOnFace(l)}},t.validateOverlapCurveGroup=function(e,t=h.Tolerance.LENGTH_EPS,n=!1){if(!1===e.bValid)return;const r=e.curves,s=r[0].getStartPt(),i=r[0].getMidPt(),o=r[r.length-1].getMidPt(),a=r[r.length-1].getEndPt();e.bValid=!0;for(const c of e.onFaces){if(void 0===c.bPositive)continue;const l=e.face.bPositive!==c.bPositive!==n;for(const n of c.bcGroups){let c=!1,d=!1;const u=n.curves;if(u.length===r.length&&(!c&&u[0].getStartPt().equals(s,t)&&u[u.length-1].getEndPt().equals(a,t)?u[0].containsPoint(i,t)&&u[u.length-1].containsPoint(o,t)&&(c=!0):!d&&u[0].getStartPt().equals(a,t)&&u[u.length-1].getEndPt().equals(s,t)&&u[0].containsPoint(o,t)&&u[u.length-1].containsPoint(i,t)&&(d=!0),!l&&d||l&&c)){e.bValid=!1,n.bValid=!1;break}}}},t.areFacesTotallyOverlap=function(e,t,n,r){if(!e.loops.length||!t.loops.length||e.loops.length!==t.loops.length)return!1;if(e.loops[0].length!==t.loops[0].length)return!1;const s=e.loops.flat(),i=t.loops.flat();for(const e of s){let t=!1;for(const s of i)if(c.CurveCurveOverlapJudge.execute(e,s,n,r)===a.CurveCuvePositonType.TOTALLY_OVERLAP){t=!0;break}if(!t)return!1}return!0},t.generateResult=function(e,t,n,r,s,i,o){const a=function(e){const t=e.filter((e=>e.bPositive)).length;return e.length-t<=t}(e),c=new Map;for(const t of e)void 0!==t.bPositive&&(t.bPositive!==a?c.set(t,!0):c.set(t,!1));const h="overlap",g=new Map,_=new Map;for(const t of e){let e;e=n===l.Bool2dType.difference?c.get(t)===t.bBlankFace:c.get(t);for(const n of t.bcGroups)n.bValid&&(n.onFaces&&n.onFaces.length?p(g,h,n,void 0,((e,t)=>f.curvesEqual(e,t,s,i))):e?n.getReversedCurves(o).forEach((e=>_.set(e,[t]))):n.curves.forEach((e=>_.set(e,[t]))))}const m=g.get(h);if(m)for(const e of m){let t;t=n===l.Bool2dType.difference?c.get(e.face)===e.face.bBlankFace:c.get(e.face),t?e.getReversedCurves(o).forEach((t=>_.set(t,[e.face,...e.onFaces]))):e.curves.forEach((t=>_.set(t,[e.face,...e.onFaces])))}const v=Array.from(_.keys()),E=d.SearchLoop2D.execute(v,a,s);u.ILoopsToPolygonExes.execute(E,!1,!0).map((e=>({loops:e.map((e=>e.getAllCurves())),bPositive:e[0].isAnticlockwise()}))).forEach((e=>{const n=function(e,t){const n=new Set;for(const r of e.loops)for(const e of r){const r=t.get(e);r&&r.forEach((e=>n.add(e)))}return n}(e,_);e.originFaces=r(e,n),t.push(e)}))}},70737:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoolOperateClipper=void 0;const r=n(20666),s=n(45987),i=n(63814),o=n(37543),a=n(50265),c=n(59683),l=n(90676),d=n(44210),u=n(32858),h=n(97505),g=n(56973);t.BoolOperateClipper=class{static curvePolygon(e,t,n){const r=[];if(t.forEach((e=>{r.push(...e.copyAllCurves())})),!r.length)return n?[]:[[e.getStartPt(),e.getEndPt()]];let s=[e];for(const e of r){const t=[];for(const n of s){const r=o.LineLineIntersect.line2dAndLine2d(n,e);r.length?r.forEach((({point:e,isOverlap:r})=>{r||(t.push(new u.Line2d(n.getStartPt(),e)),t.push(new u.Line2d(e,n.getEndPt())))})):t.push(n)}s=t}const i=[],h=[];for(const e of s){t.find((t=>t instanceof d.Polygon?a.PtPolygonPositionJudge.execute(e.getMidPt(),t)===l.PtLoopPositonType.IN:c.PtLoopPositionJudge.execute(e.getMidPt(),t,g.Tolerance.LENGTH_EPS).type===l.PtLoopPositonType.IN))?i.push(e):h.push(e)}return n?i.map((e=>[e.getStartPt(),e.getEndPt()])):h.map((e=>[e.getStartPt(),e.getEndPt()]))}static boolOperate(e,t,n){return d.Polygon.fromPolygonEx(this.boolOperateEx(e,t,n))}static boolOperateEx(e,t,n){const o=new r.Clipper,a=g.Tolerance.CLIPPER_SCALE;let c=!0;for(const t of e){if(t.getType()===h.EN_GEO_ELEMENT_TYPE.EN_LOOP){const e=[s.ClipperFormatConverter.loopToPath(t)];if(!e.length)continue;r.JS.ScaleUpPaths(e,a),o.AddPaths(e,r.PolyType.ptSubject,!0)}else{if(t.getType()!==h.EN_GEO_ELEMENT_TYPE.EN_POLYGON)throw new Error("not support this type");{const e=s.ClipperFormatConverter.polygonToPaths(t);if(!e.length)continue;r.JS.ScaleUpPaths(e,a),o.AddPaths(e,r.PolyType.ptSubject,!0)}}c=!1}if(n)for(const e of n)if(e.getType()===h.EN_GEO_ELEMENT_TYPE.EN_LOOP){const t=[s.ClipperFormatConverter.loopToPath(e)];if(!t.length)continue;r.JS.ScaleUpPaths(t,a),o.AddPaths(t,r.PolyType.ptClip,!0)}else{if(e.getType()!==h.EN_GEO_ELEMENT_TYPE.EN_POLYGON)throw new Error("not support this type");{const t=s.ClipperFormatConverter.polygonToPaths(e);if(!t.length)continue;r.JS.ScaleUpPaths(t,a),o.AddPaths(t,r.PolyType.ptClip,!0)}}let l=-1;if(0===t)l=r.ClipType.ctUnion;else if(1===t){if(l=r.ClipType.ctIntersection,c)return[new d.Polygon]}else if(2===t&&(l=r.ClipType.ctDifference,c))return[new d.Polygon];const u=new r.PolyTree;o.Execute(l,u,r.PolyFillType.pftNonZero,r.PolyFillType.pftNonZero)||i.Log.e([...e,...n],"clipper运算失败");const f=[],p=u.Childs(),_=e=>(r.JS.ScaleDownPath(e,a),s.ClipperFormatConverter.pathToLoop(e));for(;p.length>0;){const e=p.pop(),t=[_(e.Contour())];for(const n of e.Childs())t.push(_(n.Contour())),p.push(...n.Childs());f.push(new d.Polygon(t))}return f}}},91465:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PolylinePolygonBool=void 0;const r=n(72179),s=n(44210),i=n(17980),o=n(50265),a=n(90676),c=n(59683);t.PolylinePolygonBool=class{static execute(e,t,n,l,d){const u=d,h=l?[a.PtLoopPositonType.IN,a.PtLoopPositonType.ONEDGE,a.PtLoopPositonType.ONVERTEX]:[a.PtLoopPositonType.IN],g=l?[a.PtLoopPositonType.IN]:[a.PtLoopPositonType.IN,a.PtLoopPositonType.ONEDGE,a.PtLoopPositonType.ONVERTEX],f=e.copyAllCurves(),p=f.map((e=>e.getBoundingBox())),_=t.map((e=>e.getBoundingBox())),m=[];return f.forEach(((e,r)=>{const a=[],l=(e,t)=>{t.some((t=>t.equals(e,u)))||t.push(e)},d=[];t.forEach(((t,n)=>{if(p[r].intersectsBox(_[n])){d.push(t);for(const n of t.getAllCurves()){i.CurveCurveIntersect.curve2ds(e,n).forEach((t=>{t.isOverlap?(l(e.getPtAt(t.overlap1.min),a),l(e.getPtAt(t.overlap1.max),a)):l(t.point,a)}))}}}));let f=e.split(a.map((t=>e.getParamAt(t))));f.length||(f=[e]);for(const e of f){let t=!1;t=n?d.some((t=>{let n;return n=t instanceof s.Polygon?o.PtPolygonPositionJudge.execute(e.getMidPt(),t,u):c.PtLoopPositionJudge.execute(e.getMidPt(),t,u).type,h.some((e=>e===n))})):d.every((t=>{let n;return n=t instanceof s.Polygon?o.PtPolygonPositionJudge.execute(e.getMidPt(),t,u):c.PtLoopPositionJudge.execute(e.getMidPt(),t,u).type,g.every((e=>e!==n))})),t&&m.push(e)}})),r.SearchSimpleLoop.execute(m,u)}}},47035:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BoolOperate2d=void 0;const r=n(70737),s=n(91465),i=n(44210),o=n(97505),a=n(45449),c=n(56973);t.BoolOperate2d=class{static union(e){return e.length?r.BoolOperateClipper.boolOperate(e,0,[]):new i.Polygon}static intersect(e){if(!e.length)return new i.Polygon;let t=e[0];t.getType()===o.EN_GEO_ELEMENT_TYPE.EN_LOOP&&(t=new i.Polygon(t.clone()));for(let n=1;n<e.length;n++)t=r.BoolOperateClipper.boolOperate([t],1,[e[n]]);return t}static difference(e,t){return e.isEmpty()?new i.Polygon:t.length?r.BoolOperateClipper.boolOperate([e],2,t):e instanceof i.Polygon?e.clone():new i.Polygon(e.clone())}static polygonExUnion(e,t=c.Tolerance.LENGTH_EPS,n=c.Tolerance.ANGLE_EPS){if(!e.length)return[];const r=Math.ceil(e.length/2);return a.Bool2d.boolOperate(e.slice(0,r),e.slice(r,e.length),0,t,n)}static polygonExIntersect(e,t,n=c.Tolerance.LENGTH_EPS,r=c.Tolerance.ANGLE_EPS){return e.length?a.Bool2d.boolOperate(e,t,1,n,r):[]}static polygonExDifference(e,t,n=c.Tolerance.LENGTH_EPS,r=c.Tolerance.ANGLE_EPS){return e.length?a.Bool2d.boolOperate(e,t,2,n,r):[]}static polylineIntersect(e,t,n,r=c.Tolerance.NUMBER_EPS){return!t.length||e.isEmpty()?[]:s.PolylinePolygonBool.execute(e,t,!0,n,r)}static polylineDifference(e,t,n,r=c.Tolerance.NUMBER_EPS){return e.isEmpty()?[]:t.length?s.PolylinePolygonBool.execute(e,t,!1,n,r):[e]}}},68238:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Distance=t.CalculateDistance=void 0;const r=n(89009),s=n(68956),i=n(1281),o=n(87642),a=n(87279),c=n(56973);class l{static pointToCurve2d(e,t,n){const s=r.PointToCurve2dDistance.execute(e,t,!1);return n&&n.copy(s.foot),s.distance}static pointToCurve2dSigned(e,t,n){const s=r.PointToCurve2dDistance.execute(e,t,!0);return n&&n.copy(s.foot),s.distance}static pointToCurve2dSignedInfo(e,t){return r.PointToCurve2dDistance.execute(e,t,!0)}static pointToCurve3d(e,t,n){const r=s.PointToCurve3dDistance.execute(e,t);return n&&n.copy(r.foot),r.distance}static pointToCurve3dInfo(e,t){return s.PointToCurve3dDistance.execute(e,t)}static pointToCurve3dsInfos(e,t,n=c.Tolerance.LENGTH_EPS){return s.PointToCurve3dDistance.curves(e,t,n)}static pointToSurface(e,t,n){return Math.abs(i.PointToSurfaceDistance.execute(e,t,n))}static pointToSurfaceSigned(e,t,n){return i.PointToSurfaceDistance.execute(e,t,n)}static curve2dToCurve2d(e,t,n,r){return o.Curve2dToCurve2dDistance.execute(e,t,n,r)}static curve3dToCurve3d(e,t,n,r){return a.Curve3dToCurve3dDistance.execute(e,t,n,r)}}t.CalculateDistance=l,t.Distance=l},16522:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fit=t.CalculateFit=void 0;const r=n(56973),s=n(48448),i=n(93145),o=n(60229),a=n(44757);class c{static ParameterWith({eps:e=this.DefaultParameter.eps,hintSegmentCount:t=this.DefaultParameter.hintSegmentCount,maxSegmentCount:n=this.DefaultParameter.maxSegmentCount,endRatio:r=this.DefaultParameter.endRatio,degree:s=this.DefaultParameter.degree,nurbsPointCount:i=this.DefaultParameter.nurbsPointCount}){return{eps:e,hintSegmentCount:t,maxSegmentCount:n,endRatio:r,degree:s,nurbsPointCount:i}}static Curve2d(e,t,n=c.DefaultParameter){const r=n.hintSegmentCount,i=(t[1]-t[0])/r;let l=[];{const s=[];s.push(t[0]);for(let e=n.degree-1;e>0;e--)s.push(i*Math.pow(n.endRatio,e)+t[0]);for(let e=1;e<r;e++)s.push(i*e);for(let e=1;e<n.degree;e++)s.push(t[1]-i*Math.pow(n.endRatio,e));s.push(t[1]),l=s.map((t=>({t:t,pt:e(t)})))}let d=new Array(l.length-1);for(let e=0;e<d.length;e++)d[e]=e;let u=o.CONST.MODEL_MAX_LENGTH;for(;d.length>0;){const t=c._getNurbCurve2ds(l,d,n),r=[],s=[];let i=0,o=0;for(const a of d){const c=l[a],d=l[a+1],u=(c.t+d.t)/2,h=e(u),g=Math.floor(a/n.nurbsPointCount),f=t[g<t.length?g:t.length-1],p=f.getPtAt(f.getParamAt(h)).distanceTo(h);if(p>o&&(o=p),!(p<n.eps)&&(s.push(...l.slice(i,a+1)),s.push({t:u,pt:h}),i=a+1,r.push(s.length-2),r.push(s.length-1),s.length+l.length-i>=n.maxSegmentCount)){r.length=0;break}}s.push(...l.slice(i)),d=r,l=s,u=o}return a.MathAssert.warn(u<n.eps,`maxD is still large ${u}`),s.NurbsCurve2d.makeByInterpolationPoints(l.map((e=>e.pt)),n.degree)}static Curve3d(e,t,n=c.DefaultParameter){const r=n.hintSegmentCount,s=(t[1]-t[0])/r;let l=[];{const i=[];i.push(t[0]);for(let e=n.degree-1;e>0;e--)i.push(s*Math.pow(n.endRatio,e)+t[0]);for(let e=1;e<r;e++)i.push(s*e);for(let e=1;e<n.degree;e++)i.push(t[1]-s*Math.pow(n.endRatio,e));i.push(t[1]),l=i.map((t=>({t:t,pt:e(t)})))}let d=new Array(l.length-1);for(let e=0;e<d.length;e++)d[e]=e;let u=o.CONST.MODEL_MAX_LENGTH;for(;d.length>0;){const t=c._getNurbCurve3ds(l,d,n),r=[],s=[];let i=0,o=0;for(const a of d){const c=l[a],d=l[a+1],u=(c.t+d.t)/2,h=e(u),g=Math.floor(a/n.nurbsPointCount),f=t[g<t.length?g:t.length-1],p=f.getPtAt(f.getParamAt(h)).distanceTo(h);if(p>o&&(o=p),!(p<n.eps)&&(s.push(...l.slice(i,a+1)),s.push({t:u,pt:h}),i=a+1,r.push(s.length-2),r.push(s.length-1),s.length+l.length-i>=n.maxSegmentCount)){r.length=0;break}}s.push(...l.slice(i)),d=r,l=s,u=o}return a.MathAssert.warn(u<n.eps,`maxD is still large ${u}`),i.NurbsCurve3d.makeByInterpolationPoints(l.map((e=>e.pt)),n.degree)}static _getNurbCurve2ds(e,t,n){const r=e.map((e=>e.pt));if(r.length<1.6*n.nurbsPointCount)return[s.NurbsCurve2d.makeByInterpolationPoints(r)];const i=n.nurbsPointCount,o=Math.round(r.length/i),a=new Array(o+1).fill(!1);for(const e of t){a[Math.floor(e/n.nurbsPointCount)]=!0}a[o-1]=a[o]||a[o-1];const c=new Array(o);a[0]&&(c[0]=s.NurbsCurve2d.makeByInterpolationPoints(r.slice(0,i+n.degree+1)));for(let e=1;e<o-1;e++)if(a[e]){const t=r.slice(e*i-n.degree,(e+1)*i+n.degree+1);c[e]=s.NurbsCurve2d.makeByInterpolationPoints(t)}return a[o-1]&&(c[o-1]=s.NurbsCurve2d.makeByInterpolationPoints(r.slice((o-1)*i-n.degree,r.length))),c}static _getNurbCurve3ds(e,t,n){const r=e.map((e=>e.pt));if(r.length<1.6*n.nurbsPointCount)return[i.NurbsCurve3d.makeByInterpolationPoints(r)];const s=n.nurbsPointCount,o=Math.round(r.length/s),a=new Array(o+1).fill(!1);for(const e of t){a[Math.floor(e/n.nurbsPointCount)]=!0}a[o-1]=a[o]||a[o-1];const c=new Array(o);a[0]&&(c[0]=i.NurbsCurve3d.makeByInterpolationPoints(r.slice(0,s+n.degree+1)));for(let e=1;e<o-1;e++)if(a[e]){const t=r.slice(e*s-n.degree,(e+1)*s+n.degree+1);c[e]=i.NurbsCurve3d.makeByInterpolationPoints(t)}return a[o-1]&&(c[o-1]=i.NurbsCurve3d.makeByInterpolationPoints(r.slice((o-1)*s-n.degree,r.length))),c}}t.CalculateFit=c,t.Fit=c,c.DefaultParameter={eps:r.Tolerance.LENGTH_EPS,hintSegmentCount:10,maxSegmentCount:1e3,endRatio:.25,degree:3,nurbsPointCount:32}},61077:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Intersect=t.CalculateIntersect=void 0;const i=n(68990),o=n(2111),a=n(97935),c=n(17980),l=n(19516),d=n(73337),u=n(56973),h=n(6688),g=n(31109),f=n(61226),p=n(33218),_=n(56698),m=n(2237),v=n(63814),E=n(36737),P=n(274),y=n(44210);class C{static curve2ds(e,t,n=u.Tolerance.DEFAULT){return c.CurveCurveIntersect.curve2ds(e,t,n)}static curve3ds(e,t,n=u.Tolerance.DEFAULT){return c.CurveCurveIntersect.curve3ds(e,t,n)}static curve2dsNearPoint(e,t,n,r=u.Tolerance.DEFAULT){const s=c.CurveCurveIntersect.curve2ds(e,t,r);return s.sort(((e,t)=>e.point.sqDistanceTo(n)-t.point.sqDistanceTo(n))),s[0]}static curve2dsNearParams(e,t,n,r,s=u.Tolerance.DEFAULT){return g.CurveCurveIntersectUtil.curve2dsSingleIntersect(e,t,[n,r],s)}static curve3dsNearPoint(e,t,n,r=u.Tolerance.DEFAULT){return c.CurveCurveIntersect.curve3dsNearPoint(e,t,n,r)}static curve3dsNearParams(e,t,n,r,s=u.Tolerance.DEFAULT){return g.CurveCurveIntersectUtil.curve3dsSingleIntersect(e,t,[n,r],s)}static curve2dsOverlap(e,t,n=u.Tolerance.DEFAULT){return _.CurveCurveOverlap.curve2ds(e,t,n).map((r=>m.IntersectInfoUtil.curvesFromOverlap(r,e,t,n)))}static curve3dsOverlap(e,t,n=u.Tolerance.DEFAULT){return _.CurveCurveOverlap.curve3ds(e,t,n).map((r=>m.IntersectInfoUtil.curvesFromOverlap(r,e,t,n)))}static curve2dSelfIntersect(e,t=u.Tolerance.DEFAULT){return E.CurveSelfIntersect.curve2dSelfIntersect(e,t)}static isCurve2dSelfIntersect(e,t=u.Tolerance.DEFAULT){return E.CurveSelfIntersect.isCurve2dSelfIntersect(e,t)}static curve3dSelfIntersect(e,t=u.Tolerance.DEFAULT){return E.CurveSelfIntersect.curve3dSelfIntersect(e,t)}static curveSurface(e,t,n=u.Tolerance.DEFAULT,r){return l.CurveSurfaceIntersect.allPoints(e,t,n,r)}static curveSurfaceAll(e,t,n=u.Tolerance.DEFAULT,r){return l.CurveSurfaceIntersect.execute(e,t,n,r)}static curveSurfaceNearPoint(e,t,n,r=u.Tolerance.DEFAULT){var s;return null===(s=l.CurveSurfaceIntersect.nearPoint(e,t,n,r))||void 0===s?void 0:s.point}static curveSurfaceNearParams(e,t,n,r,s=u.Tolerance.DEFAULT){var i;return null===(i=l.CurveSurfaceIntersect.nearParam(e,t,n,r,s))||void 0===i?void 0:i.point}static isIntersectCurveSurface(e,t,n,r=u.Tolerance.DEFAULT){return l.CurveSurfaceIntersect.hasIntersect(e,t,n,r)}static surfaces(e,t,n,r,s,i,o=u.Tolerance.DEFAULT){return d.SurfaceSurfaceIntersect.allIntersections(e,t,n,r,s,i,o)}static surfacesSimplified(e,t,n,r,s,i,o=u.Tolerance.DEFAULT,a=!1,c=!1){const l=d.SurfaceSurfaceIntersect.allIntersections(e,t,n,r,s,i,o,a),h=[];for(const e of l)if(e.curve){const t=e.curve;if(t instanceof P.IntersectCurve3d&&c){const e=t.toSimpleCurve3d(3);h.push(e)}else h.push(e.curve)}return h}static surfacesNearPointSimple(e,t,n,r,s=u.Tolerance.DEFAULT,i=!1){let o;try{o=d.SurfaceSurfaceIntersect.singleCurveNearPointSimple(e,t,n,r,s,i)}catch(e){return}return o}static surfacesBetweenTwoPoints(e,t,n,r,s,i=u.Tolerance.DEFAULT,o=!1){let a;try{a=d.SurfaceSurfaceIntersect.singleCurveBetweenTwoPoints(e,t,n,r,s,i,o)}catch(e){return}return a}static surfacesNearPoint(e,t,n,r,s=u.Tolerance.DEFAULT,i=!1,o=!0){let a;try{a=d.SurfaceSurfaceIntersect.singleCurveNearPoint(e,t,n,r,s,i,o)}catch(e){return}return a}static surfacesNearParams(e,t,n,r,s,i=new u.Tolerance,o=!1){let a;try{a=d.SurfaceSurfaceIntersect.singleCurveNearParam(e,t,n,r,s,i,o)}catch(e){return}return a}static surfacesSelfIntersect(e,t,n,r,s=new u.Tolerance,i=!1){let o;try{o=d.SurfaceSurfaceIntersect.selfIntersectCurve(e,t,n,r,s,i)}catch(e){return}return o}}r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Curve2d,i.Curve2d,u.Tolerance]),s("design:returntype",Array)],C,"curve2ds",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,o.Curve3d,u.Tolerance]),s("design:returntype",Array)],C,"curve3ds",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Curve2d,i.Curve2d,p.Vector2,u.Tolerance]),s("design:returntype",Object)],C,"curve2dsNearPoint",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Curve2d,i.Curve2d,Number,Number,u.Tolerance]),s("design:returntype",Object)],C,"curve2dsNearParams",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,o.Curve3d,f.Vector3,u.Tolerance]),s("design:returntype",Object)],C,"curve3dsNearPoint",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,o.Curve3d,Number,Number,u.Tolerance]),s("design:returntype",Object)],C,"curve3dsNearParams",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Curve2d,i.Curve2d,u.Tolerance]),s("design:returntype",Array)],C,"curve2dsOverlap",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,o.Curve3d,Object]),s("design:returntype",Array)],C,"curve3dsOverlap",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Curve2d,Object]),s("design:returntype",Array)],C,"curve2dSelfIntersect",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[i.Curve2d,Object]),s("design:returntype",Boolean)],C,"isCurve2dSelfIntersect",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,Object]),s("design:returntype",Array)],C,"curve3dSelfIntersect",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,a.Surface,Object,Array]),s("design:returntype",Array)],C,"curveSurface",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,a.Surface,Object,Array]),s("design:returntype",Array)],C,"curveSurfaceAll",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,a.Surface,f.Vector3,Object]),s("design:returntype",f.Vector3)],C,"curveSurfaceNearPoint",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,a.Surface,Number,Object,Object]),s("design:returntype",f.Vector3)],C,"curveSurfaceNearParams",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve3d,a.Surface,y.Polygon,Object]),s("design:returntype",Boolean)],C,"isIntersectCurveSurface",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Surface,a.Surface,h.Interval,h.Interval,h.Interval,h.Interval,u.Tolerance]),s("design:returntype",Array)],C,"surfaces",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Surface,a.Surface,h.Interval,h.Interval,h.Interval,h.Interval,u.Tolerance,Object,Object]),s("design:returntype",Array)],C,"surfacesSimplified",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Surface,a.Surface,f.Vector3,f.Vector3,u.Tolerance,Object]),s("design:returntype",o.Curve3d)],C,"surfacesNearPointSimple",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Surface,a.Surface,f.Vector3,f.Vector3,f.Vector3,u.Tolerance,Object]),s("design:returntype",o.Curve3d)],C,"surfacesBetweenTwoPoints",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Surface,a.Surface,f.Vector3,f.Vector3,u.Tolerance,Object,Object]),s("design:returntype",o.Curve3d)],C,"surfacesNearPoint",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Surface,a.Surface,Object,Object,f.Vector3,u.Tolerance,Object]),s("design:returntype",o.Curve3d)],C,"surfacesNearParams",null),r([v.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Surface,Object,Object,f.Vector3,u.Tolerance,Object]),s("design:returntype",o.Curve3d)],C,"surfacesSelfIntersect",null),t.CalculateIntersect=C,t.Intersect=C},46:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Offset=t.CalculateOffset=void 0;const i=n(61226),o=n(53487),a=n(61077),c=n(56973),l=n(87222),d=n(60229),u=n(37543),h=n(46302),g=n(68956),f=n(94954),p=n(17980),_=n(4097),m=n(26773),v=n(34410),E=n(94665),P=n(63814),y=n(83015);class C{static curve3dsByPoint(e,t,n=c.Tolerance.DEFAULT){const r=e.length,s=v.CurveUtil.getDzByCurves(e),o=e.map((e=>g.PointToCurve3dDistance.execute(t,e)));let a=0;for(let e=1;e<r;e++)o[e].distance<o[a].distance&&(a=e);const l=o[a],d=e[a],u=d.getRange();let h=-1;l.param===u.min?h=a:l.param===u.max&&(h=(a+1)%r);const f=new i.Vector3(t).subtract(l.foot),p=f.dot(s);let _;if(h<0){const e=d.getTangentAt(l.param).cross(s);_=f.dot(e)}else{const t=e[(h+r-1)%r],n=e[h],i=t.getEndTangent(),o=n.getStartTangent(),a=i.cross(s).dot(f),c=o.cross(s).dot(f);_=Math.max(a,c)}return C.curve3dsByOffsets(e,_,p,s,n)}static curve3dsByOffsets(e,t,n,r,s=c.Tolerance.DEFAULT){const i=r||v.CurveUtil.getDzByCurves(e),{curves:a,evolution:l}=v.CurveUtil.simplifyCurves3d(e,{smoothPolyToNurbs:!0}),d=a.map((e=>o.OffsetCurve3d.makeByOffset(e,i,t,n))),u=new Map;for(let e=0;e<d.length;e++)this._isDegeneratedCurve(d[e])?(d.splice(e,1),e--):u.set(d[e],a[e]);let h;try{h=C._connectCurves(d,i,t,!0,s)}catch(e){return{loops:[],evolution:new E.EvolutionMap}}const g=Array.from(h.keys()),f=C._makeJoints(g,s),p=C._findLoops(g,f,i,t>0),_=new E.EvolutionMap,m=p.map((e=>{const t=[];for(let n=0;n<e.length;n++){const r=e[n];for(;n+1<e.length&&e[n+1].curveId===r.curveId;)n++;const s=f[r.curveId][e[n].jointId+1].param,i=g[r.curveId],o=i.clone().setRange(r.param,s);t.push(o),_.set(o,[i])}return t})),P=_.connectValueMap(h);for(const e of P.values())for(let t=0;t<e.length;t++)e[t]=l.get(u.get(e[t]))[0];return{loops:m,evolution:P}}static offsetCurve3dList(e,t,n){const r=n;if(e[0].getStartPt().equals(e[e.length-1].getEndPt())){const r=C.curve3dsByOffsets(e,t,0,n),s=[];return r.loops.map((e=>s.push(...e))),{curveList:s,evolution:r.evolution}}const{curves:s}=v.CurveUtil.simplifyCurves3d(e,{smoothPolyToNurbs:!0}),i=s.map((e=>o.OffsetCurve3d.makeByOffset(e,r,t))),a=new Map;for(let e=0;e<i.length;e++)this._isDegeneratedCurve(i[e])?(i.splice(e,1),e--):a.set(i[e],s[e]);let l;try{l=C._connectCurves(i,r,t,!1,c.Tolerance.DEFAULT)}catch(e){return{curveList:[],evolution:new E.EvolutionMap}}return{curveList:Array.from(l.keys()),evolution:l}}static offsetLoop2d(e,t,n=c.Tolerance.DEFAULT){return y.Loop2dOffset.execute(e,t,n)}static offsetCurve2dList(e,t){return y.Loop2dOffset.offsetCurve2dList(e,t)}static _isDegeneratedCurve(e){if(e.getRange().getLength()<c.Tolerance.NUMBER_EPS)return!0;if(e.isArc3d())return e.getA()<c.Tolerance.LENGTH_EPS&&e.getB()<c.Tolerance.LENGTH_EPS;if(e.isNurbsCurve3d()){const t=e.getControlPoints();let n=0;for(let e=1;e<t.length;e++){n+=t[e].sqDistanceTo(t[e-1])}return n<c.Tolerance.LENGTH_EPS2}return!1}static _connectCurves(e,t,n,r,s){const i=new E.EvolutionMap;for(let h=0;h<e.length;h++){if(!r&&0===h){i.set(e[0],[e[0]]);continue}const g=(h+e.length-1)%e.length,m=e[g],v=e[h],E=m instanceof o.OffsetCurve3d?m.getBaseCurve().getEndTangent():m.getEndTangent(),P=v instanceof o.OffsetCurve3d?v.getBaseCurve().getStartTangent():v.getStartTangent(),y=E.cross(P).dot(t);if(m.getEndPt().sqDistanceTo(v.getStartPt())>c.Tolerance.LENGTH_EPS2)if(n>0?y>s.angleEps:y<-s.angleEps){let r,s;if(m instanceof l.Line3d)r=m,r.getRange().max=d.CONST.MODEL_MAX_LENGTH;else{const s=m instanceof o.OffsetCurve3d?m.getParamMapper().getParamInfo(m.getBaseCurve().getEndParam(),!0).type:f.ParamType.Normal;if(s===f.ParamType.Normal)r=new l.Line3d(m.getEndPt(),E,[0,d.CONST.MODEL_MAX_LENGTH]);else{const e=E.cross(t),i=m.getBaseCurve().getEndPt().add(e.multiply(n));if(r=new l.Line3d(i,E,[-d.CONST.MODEL_MAX_LENGTH,d.CONST.MODEL_MAX_LENGTH]),s===f.ParamType.EndGap||s===f.ParamType.Reversed){const e=p.CurveCurveIntersect.curve3ds(m,r);_.MathError.assert(e.length>0,"No Intersect when tirm OffsetCurve end");let t=e[0];for(let n=1;n<e.length;n++)e[n].param2>t.param2&&(t=e[n]);r.getRange().min=t.param2,m.getRange().max=t.param1}else r.getRange().min=0}i.set(r,[e[g]])}if(v instanceof l.Line3d)s=v,s.getRange().min=-d.CONST.MODEL_MAX_LENGTH;else{const r=v instanceof o.OffsetCurve3d?v.getParamMapper().getParamInfo(v.getBaseCurve().getStartParam(),!1).type:f.ParamType.Normal;if(r===f.ParamType.Normal)s=new l.Line3d(v.getStartPt(),P,[-d.CONST.MODEL_MAX_LENGTH,0]);else{const e=P.cross(t),i=v.getBaseCurve().getStartPt().add(e.multiply(n));if(s=new l.Line3d(i,P,[-d.CONST.MODEL_MAX_LENGTH,d.CONST.MODEL_MAX_LENGTH]),r===f.ParamType.StartGap||r===f.ParamType.Reversed){const e=p.CurveCurveIntersect.curve3ds(v,s);_.MathError.assert(e.length>0,"No Intersect when trim OffsetCurve start");let t=e[0];for(let n=1;n<e.length;n++)e[n].param2<t.param2&&(t=e[n]);s.getRange().max=t.param2,v.getRange().min=t.param1}else s.getRange().max=0}i.set(s,[e[h]])}const a=u.LineLineIntersect.line3dAndLine3d(r,s);_.MathError.assert(a.length>0,"No Intersection found between preline & curline");const c=a[0];r.getRange().max=c.param1,s.getRange().min=c.param2}else{const r=e=>{if(e instanceof o.OffsetCurve3d&&e.isPeriodic()){const t=e.getBaseCurve(),n=t.getDomain().getLength()-e.getDomain().getLength();if(t.isNurbsCurve3d()&&e.getRange().max-e.getDomain().max<n)return!0}return!1},s=a.CalculateIntersect.curve3dsNearParams(m,v,m.getEndParam(),v.getStartParam());if(s)m.getRange().max=s.param1,v.getRange().min=s.param2;else{let s,o;if(r(m)){const r=m.getEndPt(),o=E.cross(t),a=m.getBaseCurve().getEndPt().add(o.multiply(n));s=new l.Line3d(r,a),i.set(s,[e[g]])}if(r(v)){const r=P.cross(t),s=v.getBaseCurve().getStartPt().add(r.multiply(n)),a=v.getStartPt();o=new l.Line3d(s,a),i.set(o,[e[h]])}if(s&&o){const e=u.LineLineIntersect.line3dAndLine3d(s,o);_.MathError.assert(e.length>0,"No Intersection found between preline & curline");const t=e[0];s.getRange().max=t.param1,o.getRange().min=t.param2}else if(s){const e=a.CalculateIntersect.curve3dsNearParams(s,v,s.getStartParam(),v.getStartParam());e?(s.getRange().max=e.param1,v.getRange().min=e.param2):_.MathError.assert(e,"No Intersection found between preline & curline")}else if(o){const e=a.CalculateIntersect.curve3dsNearParams(m,o,m.getEndParam(),o.getEndParam());e?(m.getRange().max=e.param1,o.getRange().min=e.param2):_.MathError.assert(e,"No Intersection found between preline & curline")}}}i.set(v,[e[h]])}const g=Array.from(i.keys());e:for(let e=0;e<g.length;){for(let t=e+1;t<g.length;t++){const n=h.CurveCurveMerge.curve3dsEvolution(g[e],g[t],h.MergeReverseMode.remove,s);if(n){i.appendKey(n,[g[e],g[t]]),g.splice(t,1),g.splice(e,1),g.push(...n.keys());continue e}}e++}return i}static _makeJoints(e,t){const n=e.map((()=>[])),r=e.length;function s(e,t,r,s,i){const o={curveId:e,jointId:-1,done:!1,point:r,param:s,thats:[]},a={curveId:t,jointId:-1,done:!1,point:r,param:i,thats:[o]};o.thats.push(a),n[e].push(o),n[t].push(a)}for(let n=0;n<r;n++){const r=e[n];if(r.getRange()instanceof m.PeriodInterval){const e=r.getStartPt(),i=r.getEndPt();e.equals(i,t.lengthEps)&&s(n,n,r.getStartPt(),r.getStartParam(),r.getEndParam())}else if(r instanceof o.OffsetCurve3d){if(r.getBaseCurve().getRange()instanceof m.PeriodInterval){const e=r.getStartPt(),i=r.getEndPt();e.equals(i,t.lengthEps)&&s(n,n,r.getStartPt(),r.getStartParam(),r.getEndParam())}else{const e=r.getBaseCurve(),t=r.getParamMapper(),i=r.getStartTangent(),o=r.getEndTangent(),c=e.getPtAt(t.getBaseParam(r.getStartParam(),!0)),l=e.getPtAt(t.getBaseParam(r.getEndParam(),!1)).subtracted(c);if(l.dot(i)>0&&l.dot(o)>0)continue;const d=r.getEndPt().subtract(r.getStartPt());if(!(d.dot(i)>0&&d.dot(o)>0))continue;const u=a.CalculateIntersect.curve3dsNearParams(r,r,r.getStartParam(),r.getEndParam());if(!u)continue;s(n,n,u.point,u.param1,u.param2)}}}for(let t=0;t<r;t++)for(let n=t+1;n<r;n++){const r=a.CalculateIntersect.curve3ds(e[t],e[n]);for(const e of r)e.isOverlap||s(t,n,e.point,e.param1,e.param2)}for(const r of n){if(0===r.length)continue;{const t=e[r[0].curveId].getRange();if(t instanceof m.PeriodInterval){const e=r.some((e=>Math.abs(e.param-t.min)<c.Tolerance.NUMBER_EPS));for(const n of r){const r=Math.abs(n.param-t.max)<c.Tolerance.NUMBER_EPS;n.param=e&&r?n.param:t.getRegularParam(n.param)}}}r.sort(((e,t)=>{const n=e.overlap?e.overlap.getMid():e.param,r=t.overlap?t.overlap.getMid():t.param;return n===r?e.jointId-t.jointId:n-r}));for(let e=0;e<r.length;e++){const n=r[e];n.jointId=e;let s=e+1;for(;s<r.length&&!(Math.abs(n.param-r[s].param)>t.numberEps);s++);if(s>e+1){const t=n.point;let i=n.param;for(let o=e+1;o<s;o++){const e=r[o];t.add(e.point),i+=e.param,n.thats.push(...e.thats);for(const t of e.thats){const r=t.thats.findIndex((t=>t===e));t.thats[r]=n}}n.point=t.multiply(1/(s-e)),n.param=i/(s-e),r.splice(e+1,s-e-1)}}if(r.length<2)continue;const n=r[0],s=r[r.length-1];if(n.point.equals(s.point)){for(const e of n.thats)e===s||s.thats.includes(e)||(s.thats.push(e),e.thats.push(s));for(const e of s.thats)e===n||n.thats.includes(e)||(n.thats.push(e),e.thats.push(n))}}return n}static _findLoops(e,t,n,r){const s=[],i=e.length;for(let o=0;o<i;o++){const i=t[o];for(let o=0;o<i.length-1;o++){const a=i[o];if(a.done)continue;let c={joint:a,direction:!0};const l=[];let d=!0;do{c.direction?c.joint.done=!0:d=!1;const s=c.joint;l.push(s);const i=t[s.curveId],o=i[s.jointId+(c.direction?1:-1)],a=e[s.curveId].getTangentAt(o.param);let u;c.direction&&a.reverse();const h=e=>{u&&u.angle>e.angle!==r||(u=e)};c.direction?o.jointId+1<i.length&&h({joint:o,angle:Math.PI,direction:!0}):o.jointId>0&&h({joint:o,angle:Math.PI,direction:!1});for(const r of o.thats){const s=e[r.curveId].getTangentAt(r.param);if(r.jointId<t[r.curveId].length-1){h({angle:a.angleTo(s,n),joint:r,direction:!0})}if(r.jointId>0){h({angle:a.angleTo(s.reverse(),n),joint:r,direction:!1})}}if(!u){d=!1;break}c=u}while(c.joint!==a);d&&s.push(l)}}return s}}r([P.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Object,c.Tolerance]),s("design:returntype",Object)],C,"curve3dsByPoint",null),r([P.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Number,Number,i.Vector3,c.Tolerance]),s("design:returntype",Object)],C,"curve3dsByOffsets",null),r([P.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Number,i.Vector3]),s("design:returntype",Object)],C,"offsetCurve3dList",null),r([P.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Number,c.Tolerance]),s("design:returntype",Object)],C,"offsetLoop2d",null),r([P.LogCall(),s("design:type",Function),s("design:paramtypes",[Array,Number]),s("design:returntype",Object)],C,"offsetCurve2dList",null),t.CalculateOffset=C,t.Offset=C},11652:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Overlap=t.CalculateOverlap=void 0;const i=n(56973),o=n(68990),a=n(2111),c=n(97935),l=n(63814),d=n(56698),u=n(40616),h=n(79034),g=n(2648);class f{static curve2dsColinear(e,t,n=i.Tolerance.DEFAULT){return h.CurveCurveColinear.curve2ds(e,t,n)}static curve2ds(e,t,n=i.Tolerance.DEFAULT){return d.CurveCurveOverlap.curve2ds(e,t,n)}static curve3dsColinear(e,t,n=i.Tolerance.DEFAULT){return h.CurveCurveColinear.curve3ds(e,t,n)}static curve3ds(e,t,n=i.Tolerance.DEFAULT){return d.CurveCurveOverlap.curve3ds(e,t,n)}static isSurfacesCoplaner(e,t,n=i.Tolerance.DEFAULT){return u.SurfaceSurfaceCoplaner.simple(e,t,n)}static isCurveSurfaceOverlap(e,t,n=i.Tolerance.DEFAULT){return g.CurveSurfaceCoincide.execute(e,t,n)}}r([l.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve2d,o.Curve2d,Object]),s("design:returntype",Boolean)],f,"curve2dsColinear",null),r([l.LogCall(),s("design:type",Function),s("design:paramtypes",[o.Curve2d,o.Curve2d,Object]),s("design:returntype",Array)],f,"curve2ds",null),r([l.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Curve3d,a.Curve3d,Object]),s("design:returntype",Boolean)],f,"curve3dsColinear",null),r([l.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Curve3d,a.Curve3d,Object]),s("design:returntype",Array)],f,"curve3ds",null),r([l.LogCall(),s("design:type",Function),s("design:paramtypes",[c.Surface,c.Surface,Object]),s("design:returntype",Boolean)],f,"isSurfacesCoplaner",null),r([l.LogCall(),s("design:type",Function),s("design:paramtypes",[a.Curve3d,c.Surface,Object]),s("design:returntype",Boolean)],f,"isCurveSurfaceOverlap",null),t.CalculateOverlap=f,t.Overlap=f},28041:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Project=t.CalculateProject=void 0;const r=n(38666),s=n(5804),i=n(46172);class o{static curve3dTo2d(e,t){return new s.Plane(t).getCurve2d(e)}static curve3dToPlane(e,t){return new i.Curve3dProjectToPlane(e,t).execute()}static line1ToLine2(e,t){return r.CurveCurveProject.lines(e,t)}static curve2dTo3d(e,t){return new s.Plane(t).getCurve3d(e)}}t.CalculateProject=o,t.Project=o},81658:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurfacePatch=t.Curve3dSegmentPair=t.Curve2dSegmentPair=t.CurveSegmentPair=t.Curve3dSegment=t.Curve2dSegment=t.CurveSegment=void 0;const r=n(6688),s=n(67996),i=n(60229),o=n(32858),a=n(90361),c=n(56973),l=n(97602),d=n(10909),u=n(87222);class h{static getEndPoints(e){const t=[];t.push(e[0].curve.getStartPt()),t.push(e[0].curve.getEndPt());for(let n=1;n<e.length;n++){const r=e[n].curve,s=r.getStartPt(),i=r.getEndPt();s.equals(t[t.length-1])||t.push(s),t.push(i)}return t}static subdivideCurveSegment(e,t){const n=t[0],s=t[1];if(e.curve.isNurbsCurve()){const t=e.curve,i=t.getControlPoints(),o=t.getDegree()%2?(t.getDegree()+1)/2:t.getDegree()/2;if(e.depth>3&&i.length<Math.pow(2,e.depth-o))return;const a=e.range.getMid();n.curve=e.curve,n.range=new r.Interval(e.range.min,a),s.curve=e.curve,s.range=new r.Interval(a,e.range.max)}else if(e.curve.isArc()){if(e.range.getLength()<i.CONST.PI_16-c.Tolerance.ANGLE_EPS)return;const t=e.range.getMid();n.curve=e.curve,n.range=new r.Interval(e.range.min,t),s.curve=e.curve,s.range=new r.Interval(t,e.range.max)}else if(e.curve.isLine()){if(e.depth>5)return;const t=e.range.getMid();n.curve=e.curve,n.range=new r.Interval(e.range.min,t),s.curve=e.curve,s.range=new r.Interval(t,e.range.max)}else{if(!(e.curve.isOffsetCurve3d()||e.curve.isExtendCurve3d()||e.curve.isOffsetCurve2d()||e.curve.isExtendCurve2d()))throw new Error("unexpected curve type");{if(e.depth>5)return;const t=e.range.getMid();n.curve=e.curve,n.range=new r.Interval(e.range.min,t),s.curve=e.curve,s.range=new r.Interval(t,e.range.max)}}n.depth=e.depth+1,s.depth=e.depth+1,e.child.push(n),e.child.push(s)}}t.CurveSegment=h;t.Curve2dSegment=class extends h{constructor(e){super(),this.curve=e,this.child=[]}getSegBox(){return this._box||(this._box=this.curve.getBoundingBox(this.range)),this._box}};t.Curve3dSegment=class extends h{constructor(e){super(),this.curve=e,this.child=[]}getSegBox(){return this._box||(this._box=this.curve.getBox(this.range)),this._box}};class g{constructor(e,t){this.segment1=e,this.segment2=t}static combineCurveSegmentPairs(e,t){let n=!1;for(const r of e)if(0!==r.segment1.child.length||0!==r.segment2.child.length){if(r.segment1.child.length>1)for(const e of r.segment1.child)if(r.segment2.child.length>1)for(const n of r.segment2.child){const r=new g(e,n);t.push(r)}else{const n=new g(e,r.segment2);t.push(n)}else for(const e of r.segment2.child){const n=new g(r.segment1,e);t.push(n)}n=!0}else t.push(r);return n}static refreshCurveSegments(e,t,n){const r=new Set,s=new Set;for(const t of e)r.add(t.segment1),s.add(t.segment2);t.splice(0),t.push(...r),n.splice(0),n.push(...s)}getTwoBoxsMinDistance(){if(void 0===this._boxMinDist){const e=this.segment1.getSegBox(),t=this.segment2.getSegBox();if(e instanceof s.Box3&&t instanceof s.Box3)this._boxMinDist=Math.sqrt(e.getSquareDistanceTo(t));else{if(!(e instanceof a.Box2&&t instanceof a.Box2))throw new Error("包围盒计算距离：不可能出现的类型！");this._boxMinDist=Math.sqrt(e.getSquareDistanceTo(t))}}return this._boxMinDist}}t.CurveSegmentPair=g;t.Curve2dSegmentPair=class extends g{};t.Curve3dSegmentPair=class extends g{};class f{constructor(e,t){this.surface=e,this.child=[],t&&(this.rangeU=t[0],this.rangeV=t[1])}static subdivideSurfacePatch(e,t=3){const n=[];if(e.surface.isNurbsSurface()){const s=e.surface.getKnotsU().length-2*e.surface.getDegreeU(),i=e.surface.getKnotsV().length-2*e.surface.getDegreeV(),o=Math.min(t,Math.round(Math.log2(s))),a=Math.min(t,Math.round(Math.log2(i)));if(e.depth>o&&e.depth>a||e.getPatchBox3d().getSize().getSqLength()<1e4)return n;const c=[];if(e.depth>o)c.push(e.rangeU);else{const t=e.rangeU.getMid(),n=new r.Interval(e.rangeU.min,t),s=new r.Interval(t,e.rangeU.max);c.push(n),c.push(s)}const l=[];if(e.depth>a)l.push(e.rangeV);else{const t=e.rangeV.getMid(),n=new r.Interval(e.rangeV.min,t),s=new r.Interval(t,e.rangeV.max);l.push(n),l.push(s)}for(const t of c)for(const r of l){const s=new f(e.surface);s.rangeU=t,s.rangeV=r,n.push(s)}}else if(e.surface.isCylinder()||e.surface.isCone()){if(e.depth>t||e.rangeU.getLength()<i.CONST.PI_6)return n;const s=[],o=e.surface,a=o.getA()>o.getB()?o.getA():o.getB();if(e.rangeV.getLength()>a){const t=e.rangeV.getMid(),n=new r.Interval(e.rangeV.min,t),i=new r.Interval(t,e.rangeV.max);s.push(n),s.push(i)}else s.push(e.rangeV);const c=[],l=e.rangeU.getMid();c.push(new r.Interval(e.rangeU.min,l)),c.push(new r.Interval(l,e.rangeU.max));for(const t of c)for(const r of s){const s=new f(e.surface);s.rangeU=t,s.rangeV=r,n.push(s)}}else if(e.surface.isSphere()){if(e.depth>t||e.rangeU.getLength()<i.CONST.PI_6&&e.rangeV.getLength()<i.CONST.PI_6)return n;const s=[];if(e.rangeV.getLength()>i.CONST.PI_6){const t=e.rangeV.getMid();s.push(new r.Interval(e.rangeV.min,t)),s.push(new r.Interval(t,e.rangeV.max))}else s.push(e.rangeV);const o=[];if(e.rangeU.getLength()>i.CONST.PI_6){const t=e.rangeU.getMid();o.push(new r.Interval(e.rangeU.min,t)),o.push(new r.Interval(t,e.rangeU.max))}else o.push(e.rangeU);for(const t of o)for(const r of s){const s=new f(e.surface);s.rangeU=t,s.rangeV=r,n.push(s)}}else if(e.surface.isPlane()){if(e.depth>t||e.rangeU.getLength()<=10&&e.rangeV.getLength()<=10)return n;const s=[];if(e.rangeU.getLength()>1){const t=e.rangeU.getMid(),n=new r.Interval(e.rangeU.min,t),i=new r.Interval(t,e.rangeU.max);s.push(n),s.push(i)}const i=[];if(e.rangeV.getLength()>1){const t=e.rangeV.getMid(),n=new r.Interval(e.rangeV.min,t),s=new r.Interval(t,e.rangeV.max);i.push(n),i.push(s)}for(const t of s)for(const r of i){const s=new f(e.surface);s.rangeU=t,s.rangeV=r,n.push(s)}}else if(e.surface.isSweepSurface()){if(e.depth>t/2)return n;const s=e.surface,a=s.getPath(),c=s.getProfile(),h=[];if(a instanceof u.Line3d)h.push(e.rangeV);else if(a instanceof l.Arc3d&&e.rangeV.getLength()<i.CONST.PI_12)h.push(e.rangeV);else{const t=e.rangeV.getMid(),n=new r.Interval(e.rangeV.min,t),s=new r.Interval(t,e.rangeV.max);h.push(n),h.push(s)}const g=[];if(c instanceof o.Line2d)g.push(e.rangeU);else if(c instanceof d.Arc2d&&e.rangeU.getLength()<i.CONST.PI_12)g.push(e.rangeU);else{const t=e.rangeU.getMid(),n=new r.Interval(e.rangeU.min,t),s=new r.Interval(t,e.rangeU.max);g.push(n),g.push(s)}if(1===g.length&&1===h.length)return n;for(const t of g)for(const r of h){const s=new f(e.surface);s.rangeU=t,s.rangeV=r,n.push(s)}}for(const t of n)t.depth=e.depth+1,e.child.push(t);return n}getPatchBox3d(){return this._box||(this._box=this.surface.getBox(this.rangeU,this.rangeV)),this._box}}t.SurfacePatch=f},11042:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.threeSurfacesIteration=t.surfaceSurfaceIteration=t.calcNextIterationThreeSurfaces=t.calcNextIterationCurveSurface=t.calcNextSurfaceSurfaceIteration=t.calcNextSurfaceSurfaceIterationSimple=t.curveCurveIteration=t.calcNextCurveCurveIteration=t.estimateRootMultiplicity=t.calSurfaceFootParamIteratively=void 0;const r=n(72564),s=n(56973),i=n(33218),o=n(97700),a=n(60229);function c(e){const t=e.length;return t<3?1:Math.abs(e[t-1]-e[t-2])<.01&&Math.abs(e[t-2]-e[t-3])<.01?2:1}function l(e,t,n){const r=e.getDerivatives(n[0],2),i=t.getDerivatives(n[1],2),a=r[0].subtracted(i[0]),c=[a.dot(r[1]),a.dot(i[1])],l=[r[1].dot(r[1])+a.dot(r[2]),-i[1].dot(r[1])],d=[r[1].dot(i[1]),-i[1].dot(i[1])+a.dot(i[2])];if(Math.abs(l[0]*d[1]-l[1]*d[0])<s.Tolerance.CALCULATE_EPS)return[];const u=o.LinearSystem.execute([l,d],c);return void 0===u?[]:u}function d(e,t,n){const r=e.getDerivatives(n[0],2),s=t.getDerivatives(n[1],2),i=1/r[1].getLength(),a=1/r[2].getLength(),c=1/s[1].getLength(),l=1/s[2].getLength();r[1]=r[1].multiply(i),r[2]=r[2].multiply(a),s[1]=s[1].multiply(c),s[2]=s[2].multiply(l);const d=r[0].subtracted(s[0]),u=[d.dot(r[1]),d.dot(r[2]),d.dot(s[1]),d.dot(s[2])],h=[r[1].dot(r[1]),r[2].dot(r[1]),-s[1].dot(r[1]),-s[2].dot(r[1])],g=[r[1].dot(r[2]),r[2].dot(r[2]),-s[1].dot(r[2]),-s[2].dot(r[2])],f=[r[1].dot(s[1]),r[2].dot(s[1]),-s[1].dot(s[1]),-s[2].dot(s[1])],p=[r[1].dot(s[2]),r[2].dot(s[2]),-s[1].dot(s[2]),-s[2].dot(s[2])],_=o.LinearSystem.execute([h,g,f,p],u);return void 0===_?[]:(_[0]*=i,_[1]*=a,_[2]*=c,_[3]*=l,_)}function u(e,t,n){const i=e.getDerivatives(n[0],2),a=t.getDerivatives(n[1],2),c=i[0].subtracted(a[0]),l=[c.dot(i[1]),c.dot(i[2]),c.dot(a[1]),c.dot(a[2])],u=s.Tolerance.CALCULATE_EPS;if(Math.abs(l[0])<u&&Math.abs(l[2])<u&&Math.abs(l[1])>u&&Math.abs(l[3])>u){const e=[i[2].dot(i[2])+c.dot(i[5]),-a[2].dot(i[2])],t=[i[2].dot(a[2]),-a[2].dot(a[2])+c.dot(a[5])],n=o.LinearSystem.execute([e,t],[l[1],l[3]]);if(void 0===n)return[];return[0,n[0],0,n[1]]}if(Math.abs(l[1])<u&&Math.abs(l[3])<u&&Math.abs(l[0])>u&&Math.abs(l[2])>u){const e=[i[1].dot(i[1])+c.dot(i[3]),-a[1].dot(i[1])],t=[i[1].dot(a[1]),-a[1].dot(a[1])+c.dot(a[3])],n=o.LinearSystem.execute([e,t],[l[0],l[2]]);if(void 0===n)return[];return[n[0],0,n[1],0]}const h=[i[1].dot(i[1])+c.dot(i[3]),i[2].dot(i[1])+c.dot(i[4]),-a[1].dot(i[1]),-a[2].dot(i[1])],g=[i[1].dot(i[2])+c.dot(i[4]),i[2].dot(i[2])+c.dot(i[5]),-a[1].dot(i[2]),-a[2].dot(i[2])],f=[i[1].dot(a[1]),i[2].dot(a[1]),-a[1].dot(a[1])+c.dot(a[3]),-a[2].dot(a[1])+c.dot(a[4])],p=[i[1].dot(a[2]),i[2].dot(a[2]),-a[1].dot(a[2])+c.dot(a[4]),-a[2].dot(a[2])+c.dot(a[5])],_=r.det([h,g,f,p]);if(Math.abs(_)<s.Tolerance.CALCULATE_EPS)return d(e,t,n);const m=o.LinearSystem.execute([h,g,f,p],l);return void 0===m?[]:m}function h(e,t,n,i){const a=e.getDerivatives(i[0],1),c=t.getDerivatives(i[1],1),l=n.getDerivatives(i[2],1),d=[a[0].x-c[0].x,a[0].y-c[0].y,a[0].z-c[0].z,c[0].x-l[0].x,c[0].y-l[0].y,c[0].z-l[0].z],u=[a[1].x,a[2].x,-c[1].x,-c[2].x,0,0],h=[a[1].y,a[2].y,-c[1].y,-c[2].y,0,0],g=[a[1].z,a[2].z,-c[1].z,-c[2].z,0,0],f=[0,0,c[1].x,c[2].x,-l[1].x,-l[2].x],p=[0,0,c[1].y,c[2].y,-l[1].y,-l[2].y],_=[0,0,c[1].z,c[2].z,-l[1].z,-l[2].z],m=r.det([u,h,g,f,p,_]);if(Math.abs(m)<s.Tolerance.CALCULATE_EPS)return[];const v=o.LinearSystem.execute([u,h,g,f,p,_],d);return void 0===v?[]:v}t.calSurfaceFootParamIteratively=function(e,t,n,r=s.Tolerance.length){},t.estimateRootMultiplicity=c,t.calcNextCurveCurveIteration=l,t.curveCurveIteration=function(e,t,n,r=s.Tolerance.DEFAULT){const i=r.lengthEps*r.lengthEps,o=1e-4*i;let d=e.getPtAt(n[0]),u=t.getPtAt(n[1]),h=d.sqDistanceTo(u);if(h<s.Tolerance.CALCULATE_EPS2)return!0;let g=0,f=1;const p=[];let _=!0;for(;g<a.CONST.NORMAL_ITER_NUM||_;g++){f=f>1?f:c(p);const r=l(e,t,n);if(0===r.length)return h<i;const m=[n[0]-r[0],n[1]-r[1]];m[0]=e.getDomain().clamp(m[0]),m[1]=t.getDomain().clamp(m[1]);let v=e.getPtAt(m[0]),E=t.getPtAt(m[1]),P=v.sqDistanceTo(E),y=P/h;if(y>.9&&(m[0]=n[0]-.5*r[0],m[1]=n[1]-.5*r[1],m[0]=e.getDomain().clamp(m[0]),m[1]=t.getDomain().clamp(m[1]),v=e.getPtAt(m[0]),E=t.getPtAt(m[1]),P=v.sqDistanceTo(E),y=P/h),y>1&&P<s.Tolerance.CALCULATE_EPS2)return!0;if(n[0]=m[0],n[1]=m[1],P<s.Tolerance.ZERO_JUDGE_EPS2)return!0;if(d.sqDistanceTo(v)<o&&u.sqDistanceTo(E)<o||g>a.CONST.MAX_ITER_NUM)return P<i;g>=a.CONST.NORMAL_ITER_NUM&&(_=P<h),d=v,u=E,h=P,p.push(y)}return h<i},t.calcNextSurfaceSurfaceIterationSimple=d,t.calcNextSurfaceSurfaceIteration=u,t.calcNextIterationCurveSurface=function(e,t,n,a){const c=e.getDerivatives(n[0],2),l=t.getDerivatives(new i.Vector2(n[1],n[2]),2),d=c[0].subtracted(l[0]),u=[d.dot(c[1]),d.dot(l[1]),d.dot(l[2])],h=[c[1].dot(c[1])+d.dot(c[2]),-l[1].dot(c[1]),-l[2].dot(c[1])],g=[c[1].dot(l[1]),-l[1].dot(l[1])+d.dot(l[3]),-l[2].dot(l[1])+d.dot(l[4])],f=[c[1].dot(l[2]),-l[1].dot(l[2])+d.dot(l[4]),-l[2].dot(l[2])+d.dot(l[5])],p=r.det([h,g,f]);if(Math.abs(p)>s.Tolerance.CALCULATE_EPS){const e=o.LinearSystem.execute([h,g,f],u);return void 0!==e&&(a[0]=n[0]-e[0],a[1]=n[1]-e[1],a[2]=n[2]-e[2],!0)}const _=1/c[1].getLength(),m=1/l[1].getLength(),v=1/l[2].getLength();c[1]=c[1].multiply(_),l[1]=l[1].multiply(m),l[2]=l[2].multiply(v);const E=c[0].subtracted(l[0]),P=[E.dot(c[1]),E.dot(l[1]),E.dot(l[2])],y=[c[1].dot(c[1]),-l[1].dot(c[1]),-l[2].dot(c[1])],C=[c[1].dot(l[1]),-l[1].dot(l[1]),-l[2].dot(l[1])],S=[c[1].dot(l[2]),-l[1].dot(l[2]),-l[2].dot(l[2])],T=o.LinearSystem.execute([y,C,S],P);return void 0!==T&&(T[0]*=_,T[1]*=m,T[2]*=v,a[0]=n[0]-T[0],a[1]=n[1]-T[1],a[2]=n[2]-T[2],!0)},t.calcNextIterationThreeSurfaces=h,t.surfaceSurfaceIteration=function(e,t,n,r=s.Tolerance.LENGTH_EPS,i=!0){const o=r*r,l=.01*o;let h=e.getPtAt(n[0]),g=t.getPtAt(n[1]),f=h.sqDistanceTo(g);if(f<l)return!0;let p=0,_=1;const m=[];let v=!0;for(;p<a.CONST.NORMAL_ITER_NUM||v;p++){let r;if(_=_>1?_:c(m),i&&p>1){if(r=u(e,t,n),0===r.length)return f<o}else if(r=d(e,t,n),0===r.length)return f<o;const E=[{x:n[0].x-r[0],y:n[0].y-r[1]},{x:n[1].x-r[2],y:n[1].y-r[3]}];e.clampInDomain(E[0]),t.clampInDomain(E[1]);let P=e.getPtAt(E[0]),y=t.getPtAt(E[1]),C=P.sqDistanceTo(y),S=C/f;if(S>.9&&(E[0].x=n[0].x-.5*r[0],E[0].y=n[0].y-.5*r[1],E[1].x=n[1].x-.5*r[2],E[1].y=n[1].y-.5*r[3],e.clampInDomain(E[0]),t.clampInDomain(E[1]),P=e.getPtAt(E[0]),y=t.getPtAt(E[1]),C=P.sqDistanceTo(y),S=C/f),S>1&&C<s.Tolerance.CALCULATE_EPS2)return!0;if(n[0]=E[0],n[1]=E[1],C<s.Tolerance.ZERO_JUDGE_EPS2)return!0;if(h.sqDistanceTo(P)<l&&g.sqDistanceTo(y)<l||p>a.CONST.MAX_ITER_NUM)return C<o;p>=a.CONST.NORMAL_ITER_NUM&&(v=C<f-s.Tolerance.CALCULATE_EPS2),h=P,g=y,f=C,m.push(S)}return f<1e4*o},t.threeSurfacesIteration=function(e,t,n,r,i=s.Tolerance.LENGTH_EPS){const o=i*i,c=.01*o;let l=e.getPtAt(r[0]),d=t.getPtAt(r[1]),u=n.getPtAt(r[2]),g=l.sqDistanceTo(d),f=l.sqDistanceTo(u),p=d.sqDistanceTo(u);if(g<s.Tolerance.CALCULATE_EPS2&&f<s.Tolerance.CALCULATE_EPS2&&p<s.Tolerance.CALCULATE_EPS2)return!0;let _=0,m=!0;for(;_<a.CONST.NORMAL_ITER_NUM||m;_++){const i=h(e,t,n,r);if(0===i.length)return g<o&&f<o&&p<o;const v=[{x:r[0].x-i[0],y:r[0].y-i[1]},{x:r[1].x-i[2],y:r[1].y-i[3]},{x:r[2].x-i[4],y:r[2].y-i[5]}];e.clampInDomain(v[0]),t.clampInDomain(v[1]),n.clampInDomain(v[2]);const E=e.getPtAt(v[0]),P=t.getPtAt(v[1]),y=n.getPtAt(v[2]),C=E.sqDistanceTo(P),S=E.sqDistanceTo(y),T=P.sqDistanceTo(y);if(r[0]=v[0],r[1]=v[1],r[2]=v[2],l.sqDistanceTo(E)<c&&d.sqDistanceTo(P)<c&&u.sqDistanceTo(y)<c||_>a.CONST.MAX_ITER_NUM)return C<o&&S<o&&T<o;_>=a.CONST.NORMAL_ITER_NUM&&(m=C<g-s.Tolerance.CALCULATE_EPS2&&S<f-s.Tolerance.CALCULATE_EPS2&&T<p-s.Tolerance.CALCULATE_EPS2),l=E,d=P,u=y,g=C,f=S,p=T}return g<o&&f<o&&p<o}},27316:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DiscreteCurve=void 0;const r=n(56973),s=n(33218),i=n(61226);class o{static execute(e,t){if(e.isNurbsCurve()){const n=e.getRange(),r=o._getNurbsHintSegment(e,t),s=(n.max-n.min)/r,i=[];for(let o=0;o<r;++o){const a=this.nurbsDiscrete(e,n.min+o*s,n.min+(o+1)*s,t);o!==r-1&&a.pop(),i.push(...a)}return i}const n=e.getSingularities(),r=o.getSpecificParams(e,t);return o.general((t=>e.getPtAt(t)),(t=>e.getTangentAt(t)),e.getRange().toArray(),n,r)}static nurbsDiscrete(e,t,n,r){const o=e.getPtAt(t),a=e.getPtAt(n),c=t+(n-t)*(.5+.2*Math.random()),l=e.getPtAt(c),d=o.subtracted(a),u=o.subtracted(l);if(d.dot(d)<r.tolerance.lengthEps&&u.dot(u)>r.tolerance.lengthEps||!function(e,t,n,r,o){const a=t.subtracted(e),c=n.subtracted(t);let l,d;if(a instanceof s.Vector2&&c instanceof s.Vector2){const e=a.cross(c);d=a.angle(c),l=e*e}else if(a instanceof i.Vector3&&c instanceof i.Vector3){const e=a.cross(c);d=a.angle(c),l=e.dot(e)}return void 0!==l&&l<r&&void 0!==d&&d<o}(o,l,a,6*r.crossEps,r.tolerance.angleEps/2)){const s=t+.5*(n-t),i=this.nurbsDiscrete(e,t,s,r),o=this.nurbsDiscrete(e,s,n,r);return i.slice(0,-1).concat(o)}return[{point:o,param:t},{point:a,param:n}]}static general(e,t,n,s=[],i){const o=i.tolerance,a=(n[1]-n[0])/Math.ceil(i.hintSegmentCount/2),c=[],l=[];let d=0,u=s.length;s.length>0&&(s[0]-n[0]<r.Tolerance.NUMBER_EPS&&d++,n[1]-s[s.length-1]<r.Tolerance.NUMBER_EPS&&u--);const h=[n[0],...s.slice(d,u),n[1]];for(let n=1;n<h.length;n++){const r=h[n]-h[n-1],s=Math.ceil(r/a),i=r/s;for(let r=0;r<s;r++){const s=l.length;l.push(s);const o=i*r+h[n-1];c.push({t:o,point:e(o),tangent:t(o),next:s+1})}}c.push({t:n[1],point:e(n[1]),tangent:t(n[1]),next:-1});for(let n=0;n<l.length&&c.length<i.maxSegmentCount;n++){const r=l[n],s=c[r],i=c[s.next],a=(s.t+i.t)/2,d=e(a),u=t(a),h={t:a,point:d,tangent:u,next:s.next};c.push(h),s.next=c.length-1;const g=s.point.midTo(i.point).subtracted(d);if(o.isSquareLengthZero(g.getSqLength())){let e=d.subtracted(s.point).isParallel(i.point.subtracted(d),o.angleEps);if(e=e&&u.isParallel(s.tangent,o.angleEps),e)continue}l.push(r),l.push(s.next)}const g=[];let f=0;for(;f>=0;){const e=c[f];g.push({point:e.point,param:e.t}),f=e.next}return g}static getSpecificParams(e,t){let n=t.hintSegmentCount;if(e.isArc())n=o._getArcHintSegment(e,t);else if(e.isNurbsCurve())n=o._getNurbsHintSegment(e,t);else if(e.isOffsetCurve()){const r=e.getBaseCurve();r.isArc()?n=o._getArcHintSegment(r,t):r.isNurbsCurve()&&(n=o._getNurbsHintSegment(r,t))}return n===t.hintSegmentCount?t:t.clone({hintSegmentCount:n})}static _getArcHintSegment(e,t){const n=e.getRange();return Math.max(t.hintSegmentCount/2,Math.ceil(n.getLength()/t.tolerance.angleEps/2))}static _getNurbsHintSegment(e,t){const n=e.getControlPoints().length;return Math.max(t.hintSegmentCount,Math.floor(n/2))}}t.DiscreteCurve=o},78860:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DiscreteRefiner=void 0;const r=n(9297),s=n(43640),i=n(33218),o=n(90361),a=n(66313);class c{constructor(e,t,n=s.DiscreteParameter.NORMAL){this.surface=e,this.uvs=t.vertices,this.faces=t.faces,this.params=n,this.pts=this.uvs.map((t=>e.getPtAt(t)))}static refine(e,t,n=s.DiscreteParameter.NORMAL){return new c(e,t,n)._execute()}_execute(){this._init(),this._remesh(this.faces.map(((e,t)=>t)));for(let e=0;e<this.faces.length;e++)this._enQueue(e);for(;this._queue.size()>0&&this.faces.length<3*this.params.maxFaceletCount;)this._dequeue();const e=this.faces,t=new Array(e.length/3);for(let n=0;n<e.length;n+=3)t[n/3]=[e[n],e[n+1],e[n+2]];return{vertices:this.pts.map((e=>e.data)),faces:t,uvs:this.uvs.map((e=>[e.x,e.y])),normals:this.uvs.map((e=>this.surface.getNormAt(e).data))}}_init(){this._twinMap=a.MeshAssist.getEdgeNeighbourMap(this.faces),this._nodeMap=new Map,this._queue=new r(((e,t)=>e.priority===t.priority?e.index-t.index:e.priority-t.priority))}_getNodeIndex(e){const t=this._twinMap.get(e);return void 0!==t&&t<e?t:e}_remesh(e){const t=new Set,n=e=>{const n=this._twinMap.get(e);void 0!==n&&t.add(Math.min(e,n))};for(const t of e)n(t);let r;{const e=this.surface,t=new o.Box2(this.uvs),n=[e.getDerivatives(t.min,1),e.getDerivatives({x:t.min.x,y:t.max.y},1),e.getDerivatives(t.max,1),e.getDerivatives({x:t.max.x,y:t.min.y},1)],s=e.getDerivatives(t.getCenter(),1);let i=0,a=0;for(const e of n)i+=e[1].getLength(),a+=e[2].getLength();i+=4*s[1].getLength(),a+=4*s[2].getLength(),r=a/i}for(;t.size>0;){const e=t.keys().next().value;t.delete(e);const s=e%3,o=e-s,a=o+(s+1)%3,c=o+(s+2)%3,l=this._twinMap.get(e),d=l%3,u=l-d+(d+1)%3,h=l-d+(d+2)%3,g=this.faces[e],f=this.faces[a],p=this.faces[c],_=this.faces[h],m=[g,_,f,p].map((e=>{const t=this.uvs[e];return{x:t.x,y:t.y*r}})),v=new Array(4);for(let e=0;e<4;e++)v[e]=new i.Vector2(m[e],m[(e+1)%4]).normalize();const E=new i.Vector2(m[0],m[2]).normalize(),P=new i.Vector2(m[1],m[3]).normalize(),y={x:-P.y,y:P.x};if(!(v[0].dot(y)*v[2].dot(y)<0))continue;const C=Math.min(...v.map((e=>Math.abs(e.cross(E)))))/Math.min(...v.map((e=>Math.abs(e.cross(P))))),S=(e,t)=>{const n=new i.Vector2(this.uvs[e]).midTo(this.uvs[t]),r=this.surface.getPtAt(n).subtracted(this.pts[e]),s=this.pts[t].subtracted(this.pts[e]).normalize();return r.cross(s).getLength()},T=S(g,f),b=C*(S(p,_)/T)<1,w=this._twinMap.get(a),x=this._twinMap.get(c);if(b||void 0===w&&void 0===x){this.faces[e]=_,this.faces[l]=p,void 0!==x?(this._twinMap.set(x,l),this._twinMap.set(l,x)):this._twinMap.delete(l);const r=this._twinMap.get(h);void 0!==r?(this._twinMap.set(r,e),this._twinMap.set(e,r)):this._twinMap.delete(e),this._twinMap.set(c,h),this._twinMap.set(h,c),void 0!==x&&(t.delete(Math.min(c,x)),t.add(Math.min(l,x))),void 0!==r&&(t.delete(Math.min(h,r)),t.add(Math.min(e,r))),n(a),n(u)}}}_enQueue(e){const t=this._getNodeIndex(e);if(this._nodeMap.has(t))return;const n=e%3,r=e-n+(n+1)%3,s=this.faces[e],o=this.faces[r],a=new i.Vector2(this.uvs[s]).midTo(this.uvs[o]),c=this.surface.getPtAt(a),l=this.surface.getNormAt(a),d=c.subtracted(this.pts[s]),u=this.pts[o].subtracted(c),h=d.cross(u).cross(l).getSqLength()/(this.params.crossEps*this.params.crossEps),g=this.surface.getNormAt(this.uvs[s]),f=this.surface.getNormAt(this.uvs[o]),p=g.angle(f)/this.params.tolerance.angleEps/2,_=Math.max(h,p);if(_>1){const e={priority:_,index:t,uv:a,pt:c};this._nodeMap.set(t,e),this._queue.enq(e)}}_dequeue(){const e=this._queue.deq();this._nodeMap.delete(e.index);const t=e.index,n=this._twinMap.get(t);this.uvs.push(e.uv),this.pts.push(e.pt);const r=[],s=this._splitCoedge(t,this.uvs.length-1,r);if(void 0!==n){const e=this._splitCoedge(n,this.uvs.length-1,r);this._twinMap.set(s,n),this._twinMap.set(n,s),this._twinMap.set(e,t),this._twinMap.set(t,e)}r.forEach((e=>this._enQueue(e)))}_splitCoedge(e,t,n){const r=e%3,s=e-r,i=s+(r+1)%3,o=s+(r+2)%3,a=this.faces[i],c=this.faces[o];this.faces[i]=t,this.faces.push(t,a,c);const l=this.faces.length-3,d=this._nodeMap.get(i);if(d){this._nodeMap.delete(i);const e=this._twinMap.get(i),t=void 0!==e?e:l+1;d.index=t,this._nodeMap.set(t,d)}const u=this._twinMap.get(i);return void 0!==u?(this._twinMap.set(l+1,u),this._twinMap.set(u,l+1)):this._twinMap.delete(l+1),this._twinMap.set(i,l+2),this._twinMap.set(l+2,i),n.push(e,i,l),l}}t.DiscreteRefiner=c},78862:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DiscreteSurface=void 0;const r=n(90361),s=n(74729),i=n(43640),o=n(6688),a=n(26773),c=n(56973),l=n(33218),d=n(32858),u=n(10909),h=n(9327),g=n(93145),f=n(60229),p=n(52463),_=n(18664),m=n(90676),v=n(78860),E=n(17165),P=n(27316),y=n(32334),C=n(53487),S=n(24533),T=n(57249);function b(e){return!!e.pCurve}class w{static execute(e,t,n=!0,r=i.DiscreteParameter.NORMAL,s=c.Tolerance.DEFAULT,o=[]){if(e.isNurbsSurface()&&this._isLoftNurbs(e,t))return this.NurbsSurfaceDiscrete(e,t[0],n,r);if(o.length>0&&!b(t[0][0]))for(const e of t){const t=e;for(let e=0;e<t.length;e++){const n=t[e],r=[];for(const e of o)e.equals(n.startPoint,s.lengthEps)||e.equals(n.endPoint,s.lengthEps)||!n.curve.containsPoint(e,s.lengthEps)||r.push(e);const i=r.map((e=>n.curve.getParamAt(e)));i.sort();const a=n.curve.split(i),c=[];a.map((e=>c.push({curve:e,isSameDirection:n.isSameDirection,startPoint:e.getStartPt(),endPoint:e.getEndPt()}))),t.splice(e,1,...c)}}const a=p.UvUtil.getSurfaceUvEps(e,s),l=w._discreteSurfaceLoops(e,t,r,a);return this.dircreteFromLoopPts(e,l,n,r,a)}static dircreteFromLoopPts(e,t,n=!0,r=i.DiscreteParameter.NORMAL,s){if(0===t.length||t[0].length<3)return{vertices:[],faces:[],normals:[],uvs:[]};let o;const a=e.isOffsetSurface()?e.getBaseSurface():e;try{if(a.isPlane()||a.isCylinder()||a.isCone()||a.isSweepSurface()&&a.getPath().isLineLike()){const n=E.DiscreteUtil.tessVector2(t);o=w.mesh2dto3d(e,n)}else if(e.isSweepSurface()&&e.getProfile().isLineLike()){for(const e of t)for(const t of e)[t.x,t.y]=[t.y,t.x];const n=E.DiscreteUtil.tessVector2(t);for(const e of n.vertices)[e.x,e.y]=[e.y,e.x];o=w.mesh2dto3d(e,n),o.faces.forEach((e=>{[e[0],e[1]]=[e[1],e[0]]}))}else{if(!e.isSweepSurface())throw Error("暂时不支持的类型");{const n=w._getInnerPointHint(e,t,r,!1),{xRadio:s,yRadio:i}=this._getRadio(e.getProfile(),e.getPath()),a=[];for(const e of t){const t=[];for(const n of e)t.push(new l.Vector2(n.x*s,n.y*i));a.push(t)}n.us=n.us.map((e=>e*s)),n.vs=n.vs.map((e=>e*i));const c=y.GridDiscrete.gridDiscrete(a,n.us,n.vs);for(const e of c.vertices)[e.x,e.y]=[e.x/s,e.y/i];o=w.mesh2dto3d(e,c)}}}catch(n){const i=w._getInnerPointHint(e,t,r),a=w._getPointsInside(t,i,s);try{const n=E.DiscreteUtil.tessByPoly2tri(t,a);o=v.DiscreteRefiner.refine(e,n,r)}catch(n){const r=E.DiscreteUtil.tessVector2(t);o=w.mesh2dto3d(e,r)}}return o.faces&&!n&&(o.faces.forEach((e=>{[e[0],e[1]]=[e[1],e[0]]})),o.normals.forEach((e=>{[e[0],e[1],e[2]]=[-e[0],-e[1],-e[2]]}))),o}static simplePoints(e,t,n=i.DiscreteParameter.NORMAL,r=c.Tolerance.DEFAULT){const s=p.UvUtil.getSurfaceUvEps(e,r),o=w._discreteSurfaceLoops(e,t,n,s),a=o.flat();if(!(e.isPlane()||e.isCylinder()||e.isCone())){const t=w._getInnerPointHint(e,o,n),r=w._getPointsInside(o,t,s);a.push(...r)}return a.map((t=>e.getPtAt(t)))}static NurbsSurfaceDiscrete(e,t,n=!0,r=i.DiscreteParameter.NORMAL){const{uTessParams:s,vTessParams:o}=this._getNurbsUVHint(e,r);let a;try{const n=this._getNurbsSurfaceLoopPts(t,e,r),i=this._tryDiscreteSimpleLoop([n],{us:s,vs:o});a=this.mesh2dto3d(e,i)}catch(t){a=e.discrete()}return a.faces&&!n&&(a.faces.forEach((e=>{[e[0],e[1]]=[e[1],e[0]]})),a.normals.forEach((e=>{[e[0],e[1],e[2]]=[-e[0],-e[1],-e[2]]}))),a}static mesh2dto3d(e,t){const n=[];for(let e=0;e<t.faces.length;e+=3)n.push([t.faces[e],t.faces[e+1],t.faces[e+2]]);return{vertices:t.vertices.map((t=>e.getPtAt(t).toArray3())),faces:n,normals:t.vertices.map((t=>e.getNormAt(t).toArray3())),uvs:t.vertices.map((e=>[e.x,e.y]))}}static _isLoftNurbs(e,t){if(1!==t.length||4!==t[0].length)return!1;const n=[],r=e.getControlPoints();n.push(r[0][0]),n.push(r[0][r[0].length-1]),n.push(r[r.length-1][0]),n.push(r[r.length-1][r[r.length-1].length-1]);for(const e of n){let n=!1;for(const r of t[0])if(e.equals(r.startPoint)||e.equals(r.endPoint)){n=!0;break}if(!n)return!1}return!0}static _getNurbsUVHint(e,t=i.DiscreteParameter.NORMAL){const n=[],r=[],s=e.getControlPoints();for(let e=0;e<s.length;++e)for(let t=0;t<s[e].length;++t){if(t+1<s[e].length){const n=s[e][t].distanceTo(s[e][t+1]);r[e]?r[e]+=n:r.push(n)}if(e+1<s.length){const r=s[e][t].distanceTo(s[e+1][t]);n[t]?n[t]+=r:n.push(r)}}const o=e=>{let t=-f.CONST.MAX_INTEGER,n=0;for(let r=0;r<e.length;++r)e[r]>t&&(n=r,t=e[r]);return n},a=g.NurbsCurve3d.makeByControlPoints(s[o(r)].map((e=>e)),e.getDegreeV());let c=E.DiscreteUtil.discreteCurve(a,t).map((e=>e.param));const l=o(n),d=s.map((e=>e[l])),u=g.NurbsCurve3d.makeByControlPoints(d,e.getDegreeU());let h=E.DiscreteUtil.discreteCurve(u,t).map((e=>e.param));const p=e.getKnotsU()[0],_=e.getKnotsV()[0],m=e.getKnotsU()[e.getKnotsU().length-1],v=e.getKnotsV()[e.getKnotsV().length-1];return h=h.map((e=>e/h[h.length-1]*(m-p)+p)),c=c.map((e=>e/c[c.length-1]*(v-_)+_)),h.pop(),c.pop(),h.shift(),c.shift(),{uTessParams:h,vTessParams:c}}static _getRadio(e,t){let n=e instanceof h.ExtendCurve3d?e.getBaseCurve():e,r=n instanceof C.OffsetCurve3d?n.getBaseCurve():n;n=e instanceof S.ExtendCurve2d?e.getBaseCurve():e,r=n instanceof T.OffsetCurve2d?n.getBaseCurve():n;const s=t instanceof h.ExtendCurve3d?t.getBaseCurve():t,i=s instanceof C.OffsetCurve3d?s.getBaseCurve():s;let o=r.getLength()>1?r.getLength()/r.getRange().getLength():1,a=i.getLength()>1?i.getLength()/i.getRange().getLength():1;for(;o/a>10;)a*=2;for(;a/o>10;)o*=2;return{xRadio:o,yRadio:a}}static _getNurbsSurfaceLoopPts(e,t,n=i.DiscreteParameter.NORMAL){const r=[],s=t.getKnotsU()[0],o=t.getKnotsU()[t.getKnotsU().length-1],a=e[0].curve;let c=E.DiscreteUtil.discreteCurve(e[0].isSameDirection?a:a.reversed(),n).map((e=>e.param));c=c.map((e=>(e-c[0])/(c[c.length-1]-c[0])*(o-s)+s)),c.forEach((e=>r.push({x:e,y:t.getKnotsV()[0]}))),r.pop();const l=e[1].curve;let d=E.DiscreteUtil.discreteCurve(e[1].isSameDirection?l:l.reversed(),n).map((e=>e.param));d=d.map((e=>(e-d[0])/(d[d.length-1]-d[0]))),d.forEach((e=>r.push({x:c[c.length-1],y:e}))),r.pop();const u=e[2].curve;let h=E.DiscreteUtil.discreteCurve(e[2].isSameDirection?u:u.reversed(),n).map((e=>e.param));h=h.map((e=>(e-h[0])/(h[h.length-1]-h[0])*(o-s)+s)),h.reverse(),h.forEach((e=>r.push({x:e,y:d[d.length-1]}))),r.pop();const g=e[3].curve;let f=E.DiscreteUtil.discreteCurve(e[3].isSameDirection?g:g.reversed(),n).map((e=>e.param));return f=f.map((e=>(e-f[0])/(f[f.length-1]-f[0]))),f.reverse(),f.forEach((e=>r.push({x:0,y:e}))),r.pop(),r}static _tryDiscreteSimpleLoop(e,t){if(e.length>1||0===t.us.length||0===t.vs.length)return;if(1===t.us.length&&1===t.vs.length)return;const n=e[0],r=t.us[0],s=t.vs[0],i=t.us[t.us.length-1],o=t.vs[t.vs.length-1];if(n.find((e=>r<=e.x&&e.x<=i&&s<=e.y&&e.y<=o)))return;let a=0;{let e=f.CONST.MODEL_MAX_LENGTH;for(let t=0;t<n.length;t++){const r=n[t],s=r.x+r.y;s<e&&(e=s,a=t)}}const c=n.slice(a).concat(n.slice(0,a)),l=[];for(const e of t.vs)for(const n of t.us)l.push({x:n,y:e});for(const e of c)l.push(e);const d=t.us.length,u=t.vs.length,h=[];{const e=d*u;let n=1;for(let r=1;r<d;r++){const s=(t.us[r-1]+t.us[r])/2,i=r-1,o=r;for(;c[n].x<s;n++)h.push(e+n-1,e+n,i);(c[n-1].x+c[n].x)/2<s?(h.push(e+n-1,e+n,i),h.push(i,e+n,o),n++):h.push(i,e+n-1,o)}for(let r=1;r<u;r++){const s=(t.vs[r-1]+t.vs[r])/2,i=r*d-1,o=i+d;for(;c[n].y<s;n++)h.push(e+n-1,e+n,i);(c[n-1].y+c[n].y)/2<s?(h.push(e+n-1,e+n,i),h.push(i,e+n,o),n++):h.push(i,e+n-1,o)}for(let r=d-2;r>=0;r--){const s=(t.us[r+1]+t.us[r])/2,i=e-d+r+1,o=i-1;for(;c[n].x>s;n++)h.push(e+n-1,e+n,i);(c[n-1].x+c[n].x)/2>s?(h.push(e+n-1,e+n,i),h.push(i,e+n,o),n++):h.push(i,e+n-1,o)}const r=c.length;for(let s=u-2;s>=0;s--){const i=(t.vs[s]+t.vs[s+1])/2,o=(s+1)*d,a=o-d;for(;c[n%r].y>i;n++)h.push(n%r+e-1,n%r+e,o);(c[(n-1)%r].y+c[n%r].y)/2>i?(h.push(e+(n-1)%r,e+n%r,o),h.push(o,e+n%r,a),n++):h.push(o,e+(n-1)%r,a)}for(n--;n<r;n++)h.push(e+n,e+(n+1)%r,0)}for(let e=1;e<u;e++)for(let t=1;t<d;t++){const n=(e-1)*d+(t-1);h.push(n,n+1,n+1+d),h.push(n,n+1+d,n+d)}return{faces:h,vertices:l}}static _discreteSurfaceLoops(e,t,n,r){const s=t.map((t=>w._getPCurvePoints(e,t,n,r))),i=w._getPoleDiscreteHint(e,s,r);let o;if(i.length>0){const e=[...i,...i.slice(1).map((e=>e+f.CONST.PI2))];o=(t,n)=>w._getPoleDiscreteUvs(t,n,e,r.x)}p.UvUtil.unifyUvBetweenCurves(e,s,r,o);const a=p.UvUtil.connectUvCurves(s,r);return p.UvUtil.unifyUvBetweenLoops(e,a,r),a}static _getPCurvePoints(e,t,n,r){const s=new Map,i=[];e.isCone()?i.push(e.getH()):e.isSphere()&&i.push(-f.CONST.PI_2,f.CONST.PI_2);const o=t.map((t=>{if(b(t))return E.DiscreteUtil.discreteCurve2dOnSurface(t.pCurve,e,n).uvs;const o=w._getSimplePCurve(e,t,c.Tolerance.DEFAULT);if(o){const r=P.DiscreteCurve.getSpecificParams(t.curve,n);return E.DiscreteUtil.discreteCurve2dOnSurface(o,e,r).uvs}const a=t;let l;if(a.curve.isLine3d()||a.curve.isNurbsCurve()&&2===a.curve.getControlPoints().length)l=[a.startPoint,a.endPoint];else{if(l=E.DiscreteUtil.discreteCurve3d(a.curve,n),!l||l.length<=1)return[];a.isSameDirection||l.reverse()}let d=[];if(e.isSweepSurface()){const r=e.getAllUVsForCurvePts(l,n,1e-4,1e-4);r.length>1&&s.set(t,r),d=r[0]}else if(e.isNurbsSurface()){d=e.getAllUVsForCurvePts(l);const t=e.getSingularPointInfos();if(t.length>0){const e=a.isSameDirection?a.startPoint:a.endPoint,n=a.isSameDirection?a.endPoint:a.startPoint;for(const r of t)e.equals(r.pt)?1===r.uvSign?d[0].x=d[1].x:0===r.uvSign&&(d[0].y=d[1].y):n.equals(r.pt)&&(1===r.uvSign?d[d.length-1].x=d[d.length-2].x:0===r.uvSign&&(d[d.length-1].y=d[d.length-2].y))}}else d=l.map((t=>e.getUVAt(t))),i.length>0&&(void 0!==i.find((e=>Math.abs(d[0].y-e)<r.y))&&(d[0].x=d[1].x),void 0!==i.find((e=>Math.abs(d[d.length-1].y-e)<r.y))&&(d[d.length-1].x=d[d.length-2].x));return d}));if(s.size>0)for(let e=0;e<t.length;e++){const n=o[(e+1)%t.length][0],r=o[e];let i=r[r.length-1].sqDistanceTo(n);if(i>1e-8){const r=s.get(t[e]);if(!r)continue;for(let t=1;t<r.length;t++){const s=r[t],a=s[s.length-1].sqDistanceTo(n);a<i&&(i=a,o[e]=r[t])}}}return o}static _getSimplePCurve(e,t,n){const r=t.curve;if(e.isSweepSurface()){const s=e.getPath().isExtendCurve()?e.getPath().getBaseCurve():e.getPath();if(s.getStartPt().equals(s.getEndPt()))return;const i=e.getUVAt(r.getMidPt()),o=e.getDerivatives(i,1),a=n.edgeLengthEps2/o[1].getSqLength(),c=e.getUVsAt(r.getStartPt()),l=e.getUVsAt(r.getEndPt()),u=r.getMidTangent().dot(o[2])>0,h=c.filter((e=>{const t=i.x-e.x;return t*t<a&&u===e.y<i.y}))[0];if(void 0===h)return;const g=l.filter((e=>{const t=i.x-e.x;return t*t<a&&u===i.y<e.y}))[0];if(void 0===g)return;const f=u?new d.Line2d(h,{x:0,y:1},[0,g.y-h.y]):new d.Line2d(h,{x:0,y:-1},[0,h.y-g.y]);return t.isSameDirection||f.reverse(),f}}static _getPoleDiscreteHint(e,t,n){if(e.isCone()){const n=e,r=n.getH();let o=0;for(const e of t)for(const t of e)for(const e of t){const t=Math.abs(r-e.y);t>o&&(o=t)}const a=o/r,c=n.getA()*a,l=n.getB()*a,d=new u.Arc2d(s.Coordinate2.XOY(),c,l,!0);return E.DiscreteUtil.discreteCurve(d,i.DiscreteParameter.LOW).map((e=>e.param))}if(e.isSphere()){const t=e,n=new u.Arc2d(s.Coordinate2.XOY(),t.getA(),t.getB(),!0);return E.DiscreteUtil.discreteCurve(n,i.DiscreteParameter.LOW).map((e=>e.param))}return[]}static _getPoleDiscreteUvs(e,t,n,r){const s=(e.y+t.y)/2,i=(n[n.length-1]-n[0])/2,[o,a]=e.x<t.x?[e.x,t.x]:[t.x,e.x],c=Math.floor(o/i)*i,l=o-c,d=a-c;let u=0;for(;l>n[u]-r&&u<n.length;)u++;let h=u;for(;d>n[h]+r&&h<n.length;)h++;const g=n.slice(u,h);return e.x>t.x&&g.reverse(),g.map((e=>({x:e,y:s})))}static _getInnerPointHint(e,t,n,c=!1){const l=n.enableSurfaceRefiner?n.ratioed(2):n;if(e.isPlane()||e.isCone())return{us:[],vs:[]};const d=new r.Box2;for(const e of t)d.expandByPoint(...e);const h=new o.Interval(d.min.x,d.max.x),g=new o.Interval(d.min.y,d.max.y);let p=[],_=[];function m(e,t){const n=e.isExtendCurve()?e.getBaseCurve():e,r=E.DiscreteUtil.discreteCurve(n,l).map((e=>e.param));if(!c){const e=r.shift();r.unshift(e+(r[0]-e)*i.DiscreteParameter.BorderScale);const t=r.pop();r.push(t-(t-r[r.length-1])*i.DiscreteParameter.BorderScale)}return r}if(e.isSphere()){const t=e,n=new u.Arc2d(s.Coordinate2.XOY(),t.getA(),t.getB(),!0,h.toArray()),r=new u.Arc2d(s.Coordinate2.XOY(),Math.max(t.getA(),t.getB()),t.getC(),!0,g.toArray());p=m(n).map((e=>a.PeriodInterval.RegularizeParam(e,f.CONST.PI2,h.min))),_=m(r).map((e=>a.PeriodInterval.RegularizeParam(e,f.CONST.PI2,g.min)))}else if(e.isSweepSurface()){const t=e,n=t.getPath(),r=t.getProfile();if(!n.isLine3d()&&!r.isLine2d()){if(p=m(r),_=m(n),r.isPeriodic()){const e=r.getRange().period;p=p.map((t=>a.PeriodInterval.RegularizeParam(t,e,h.min)))}if(n.isPeriodic()){const e=n.getRange().period;_=_.map((t=>a.PeriodInterval.RegularizeParam(t,e,g.min)))}}}else if(e.isNurbsSurface()){const{uTessParams:t,vTessParams:n}=this._getNurbsUVHint(e,l);p=t,_=n}else if(e.isOffsetSurface())return w._getInnerPointHint(e.getBaseSurface(),t,n,c);return{us:p,vs:_}}static _getPointsInside(e,t,n){const r=new _.PointPolygonPositionJudger(e),s=[];for(const e of t.us)for(const i of t.vs){const t={x:e,y:i};r.judge(t,Math.max(n.x,n.y))===m.PtLoopPositonType.IN&&s.push(t)}return s}}t.DiscreteSurface=w},23863:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DiscreteTopology=void 0;const r=n(16472),s=n(98106),i=n(43640),o=n(44210),a=n(17165);class c{static tessPolygonEx(e,t=i.DiscreteParameter.NORMAL,n=0){if(e.getAllCurves().length<1)return{vertices:[],faces:[]};const r=e.getLoops().map((e=>c.discretePolyline(e,t)));return a.DiscreteUtil.tessVector2(r)}static tessPolygon(e,t=i.DiscreteParameter.NORMAL,n=!0){const s={vertices:[],faces:[]};if(e.getLoops().length<1)return s;let a;a=e.isOnlyLines()?e:new o.Polygon(c.discretePolygon(e,t));let l=[a];n&&(l=r.SearchGraph.loopsToPolygonExes(a.getLoops())),a.getLoops().length>0&&l.length<1&&1===e.getLoops().length&&(l=[a]);let d=0;for(const e of l){d=s.vertices.length;const n=c.tessPolygonEx(e,t,d);s.vertices.push(...n.vertices),s.faces.push(...n.faces)}return s}static discretePolyline(e,t=i.DiscreteParameter.NORMAL){const n=e.getAllCurves(),r=[];for(let i=0;i<n.length;i++){const o=n[i].discrete(t);i===n.length-1&&e.getType()!==s.EN_GEO_ELEMENT_TYPE.EN_LOOP||o.pop(),r.push(...o)}return r}static discretePolygon(e,t=i.DiscreteParameter.NORMAL){const n=[];return e.getLoops().forEach((e=>{const r=c.discretePolyline(e,t);n.push(r)})),n}}t.DiscreteTopology=c},17165:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DiscreteUtil=void 0;const r=n(46768),s=n(83540),i=n(33218),o=n(56973),a=n(43640),c=n(32858),l=n(49246),d=n(44757),u=n(78860),h=n(78862),g=n(27316);class f{static tessVector2(e){const t={vertices:[],faces:[]},n=e.map((e=>e.map((e=>{const n=new s.LibtessVertex(e,t.vertices.length);return t.vertices.push(e),n}))));let r;try{r=s.tessTriangulate(n,[0,0,1])}catch(n){return d.MathAssert.warn(!0,"离散化错误",e),t}return t.faces=r.map((e=>{return void 0!==(n=e).index?n.index:(t.vertices.push(new i.Vector2(n)),t.vertices.length-1);var n})),t}static tessByPoly2tri(e,t=[]){for(const t of e){let e=0;for(;e<t.length-2;){let n=e+1;for(let r=e+2;r<t.length;r++){const s=new i.Vector2(t[r-1]).subtract(t[e]),o=new i.Vector2(t[r]).subtract(t[e]),a=s.angle(o);if(!(Math.abs(a)<f._POLY2TRI_ANGLE_EPS))break;n=r}if(n>e+1){const r=new i.Vector2(t[n]).subtract(t[e]).normalize(),s=new i.Vector2(-r.y,r.x);for(let r=e+1;r<n;r++){const n=new i.Vector2(t[r]).subtract(t[e]);t[r]=new i.Vector2(t[r]).subtract(s.multiplied(n.dot(s)))}}e=n}}let n=0;const s=[],a=o.Tolerance.NUMBER_EPS,c=1/a,l=e.map((e=>e.map((e=>{const t={x:Math.round(e.x*c)*a,y:Math.round(e.y*c)*a,id:n++};return s.push(t),t})))),d=t.map((e=>{const t={x:e.x,y:e.y,id:n++};return s.push(t),t})),u=new r.SweepContext(l[0]);u.addHoles(l.slice(1)),u.addPoints(d),u.triangulate();const h=u.getTriangles(),g=[];return h.forEach((e=>e.getPoints().forEach((e=>g.push(e.id))))),{vertices:s,faces:g}}static discreteLine2d(e,t){const n=[],r=e.getRange(),s=Math.floor(r.getLength()/t);let i=e.getStartPt();for(let o=1;o<=s;o++){const s=e.getPtAt(r.min+t*o);n.push(new c.Line2d(i,s)),i=s}return i.equals(e.getEndPt(),o.Tolerance.LENGTH_EPS)||n.push(new c.Line2d(i,e.getEndPt())),n}static discreteCurve2d(e,t=a.DiscreteParameter.NORMAL){return g.DiscreteCurve.execute(e,t).map((e=>e.point))}static discreteCurve3d(e,t=a.DiscreteParameter.NORMAL){return g.DiscreteCurve.execute(e,t).map((e=>e.point))}static discreteCurve(e,t){return g.DiscreteCurve.execute(e,t)}static discreteCurve2dOnSurface(e,t,n=a.DiscreteParameter.NORMAL){const r=new Map,s=t.getDomainU(),i=t.getDomainV();if(e.isLine2d()){const n=e.getStartPt(),r=e.getEndPt(),s={points:[t.getPtAt(n),t.getPtAt(r)],uvs:[n,r]};if(t.isPlane())return s;if(t.isCone()){const e=t.getH();if(l.Util.isNearlyEqual(n.y,e)&&l.Util.isNearlyEqual(r.y,e))return s;if(l.Util.isNearlyEqual(n.x,r.x))return s}if(t.isCylinder()&&l.Util.isNearlyEqual(n.x,r.x))return s;if(t.isSweepSurface()){const e=t,i=e.getProfile(),o=e.getPath(),a=o.isExtendCurve3d()?o.getBaseCurve():o;if(i.isLine2d()&&l.Util.isNearlyEqual(n.y,r.y)||a.isLine3d()&&l.Util.isNearlyEqual(n.x,r.x))return s}}const o=e.getSingularities(),c=f.discreteGeneralCurve((n=>{const s=e.getPtAt(n),i=t.getPtAt(s);return r.set(i,s),i}),(n=>{const r=e.getPtAt(n),o=t.getPtAt(r),a=e.getPtAt(n+1e-5);if(s.containsPoint(a.x)&&i.containsPoint(a.y)){return t.getPtAt(a).subtracted(o).multiplied(1e5)}const c=e.getPtAt(n-1e-5);return t.getPtAt(c).subtracted(o).multiplied(-1e5)}),e.getRange().toArray(),o,n),d=[],u=[];for(const e of c)d.push(e.point),u.push(r.get(e.point));return{points:d,uvs:u}}static discreteGeneralCurve(e,t,n,r=[],s){return g.DiscreteCurve.general(e,t,n,r,s)}static discreteSurface(e,t,n=!0,r=a.DiscreteParameter.NORMAL,s=o.Tolerance.DEFAULT,i=[]){return h.DiscreteSurface.execute(e,t,n,r,s,i)}static discreteSurfaceIntoPoints(e,t,n=a.DiscreteParameter.NORMAL,r=o.Tolerance.DEFAULT){return h.DiscreteSurface.simplePoints(e,t,n,r)}static refineMesh3d(e,t,n=a.DiscreteParameter.NORMAL){return u.DiscreteRefiner.refine(e,t,n)}}t.DiscreteUtil=f,f._POLY2TRI_ANGLE_EPS=1e-10},32334:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GridDiscrete=void 0;const r=n(16472),s=n(49986),i=.001;var o;function a(e,t){return Math.abs(e-t)<i}!function(e){e[e.COLLINEAR=0]="COLLINEAR",e[e.CW=1]="CW",e[e.CCW=2]="CCW"}(o||(o={}));class c{constructor(e,t,n){this._ptLoops=[],this._edges=[],this._pointEdges=new Map,this._triangles=[],this._resTriangles=[],this._edgeEvetRight=!1,this._loopPointFlags=[0];let r=0;for(const t of e){const e=[];for(const n of t)e.push({x:n.x,y:n.y,id:r}),r++;this._ptLoops.push(e),this._loopPointFlags.push(r)}this._xGrid=t,this._yGrid=n,this._points=this._ptLoops.flat(),this._loopPointFlag=this._points.length,this._basin={leftNode:void 0,bottomNode:void 0,rightNode:void 0,width:0,leftHighest:!1}}static gridDiscrete(e,t,n){return new c(e,t,n)._execute()}_execute(){if(this._resMesh2d={vertices:[],faces:[]},this._ptLoops.length<1||this._ptLoops[0].length<3)return this._resMesh2d;this._fixData(),this._addInnerPoints(),this._resMesh2d.vertices.push(...this._points),this._initData(),this._initTriangulation(),this._sweepPoint(),this._finalization();const e=[],t=[];return this._resTriangles.forEach((n=>{const r=n.pts;-1!==r[0].id&&-1!==r[1].id&&-1!==r[2].id?this._judgeTriangle(n)||(e.push(n),n.pts.forEach((e=>this._resMesh2d.faces.push(e.id)))):t.push(n)})),this._resMesh2d}_fixData(){const e=[];for(let t=0;t<this._ptLoops.length;++t){const n=this._ptLoops[t],r=[];for(let e=0;e<n.length;++e)a(n[e].x,n[(e+1)%n.length].x)&&a(n[e].y,n[(e+1)%n.length].y)||(a(n[e].x,n[(e+1)%n.length].x)&&(n[(e+1)%n.length].x=n[e].x),a(n[e].y,n[(e+1)%n.length].y)&&(n[(e+1)%n.length].y=n[e].y),r.push(n[e]));e.push(r)}this._ptLoops=e}_judgeTriangle(e){for(let t=1;t<this._loopPointFlags.length-1;++t)if(e.pts[0].id>=this._loopPointFlags[t]&&e.pts[0].id<=this._loopPointFlags[t+1]&&e.pts[1].id>=this._loopPointFlags[t]&&e.pts[1].id<=this._loopPointFlags[t+1]&&e.pts[2].id>=this._loopPointFlags[t]&&e.pts[2].id<=this._loopPointFlags[t+1])return!0;return!1}_finalization(){let e=this._advancingFront.head.next.triangle;const t=this._advancingFront.head.next.pt,n=function(e){for(const t of e.pts)if(-1===t.id)return!0;return!1};for(;e&&!e.getConstrainedEdgeCW(t)&&n(e);)e=e.neighborCCW(t);const r=[];let s=e;for(;s;){if(!s.visit){s.visit=!0,this._resTriangles.push(s);for(let e=0;e<3;e++)s.neighbors[e]&&!s.constrainedEdge[e]&&r.push(s.neighbors[e])}s=r.pop()}}_sweepPoint(){for(let e=1;e<this._points.length;++e){const t=this._pointEvent(this._points[e],this._points[e-1],this._points[e+1]?this._points[e+1]:void 0);if(!t)continue;const n=this._pointEdges.get(this._points[e]);if(n)for(const e of n)this._edgeEventByEdge(e,t)}}_addTriangle(e){this._triangles.push(e)}_edgeEventByEdge(e,t){this._curConstrainedEdge=e,this._edgeEvetRight=e.pt1.x>e.pt2.x,t.triangle&&!this._isEdgeSideOfTriangle(t.triangle,e.pt1,e.pt2)&&(this._fillEdgeEvent(e,t),this._edgeEventByPoints(e.pt1,e.pt2,t.triangle,e.pt2))}_fillEdgeEvent(e,t){this._edgeEvetRight?this._fillRightAboveEdgeEvent(e,t):this._fillLeftAboveEdgeEvent(e,t)}_edgeEventByPoints(e,t,n,r){if(!n||this._isEdgeSideOfTriangle(n,e,t))return;const s=n.pointCCW(r);if(!s)return;const i=this._orient(t,s,e);if(i===o.COLLINEAR)return;const a=n.pointCW(r);if(!a)return;const c=this._orient(t,a,e);if(c===o.COLLINEAR)return;let l=n;i===c?(l=i===o.CW?l.neighborCCW(r):l.neighborCW(r),this._edgeEventByPoints(e,t,l,r)):this._flipEdgeEvent(e,t,l,r)}_flipEdgeEvent(e,t,n,r){const s=n.neighborAcross(r);if(!s)return;if(n.getConstrainedEdgeAcross(r))throw new Error("Intersecting Constraints");const i=s.oppositePoint(n,r);if(i)if(this._inScanArea(r,n.pointCCW(r),n.pointCW(r),i))if(this._rotateTrianglePair(n,r,s,i),this._mapTriangleToNodes(n),this._mapTriangleToNodes(s),r===t&&i===e)e===this._curConstrainedEdge.pt1&&t===this._curConstrainedEdge.pt2&&(n.markConstrainedEdgeByPoints(e,t),s.markConstrainedEdgeByPoints(e,t),this._legalize(n),this._legalize(s));else{const o=this._orient(t,i,e),a=this._nextFlipTriangle(o,n,s,r,i);this._flipEdgeEvent(e,t,a,r)}else{const o=this._nextFlipPoint(e,t,s,i);this._flipScanEdgeEvent(e,t,n,s,o),this._edgeEventByPoints(e,t,n,r)}}_nextFlipTriangle(e,t,n,r,s){let i;return e===o.CCW?(i=n.edgeIndex(r,s),n.delaunayEdge[i]=!0,this._legalize(n),n.clearDelaunayEdges(),t):(i=t.edgeIndex(r,s),t.delaunayEdge[i]=!0,this._legalize(t),t.clearDelaunayEdges(),n)}_flipScanEdgeEvent(e,t,n,r,s){const i=r.neighborAcross(s),o=i.oppositePoint(r,s);if(this._inScanArea(t,n.pointCCW(t),n.pointCW(t),o))this._flipEdgeEvent(t,o,i,o);else{const r=this._nextFlipPoint(e,t,i,o);this._flipScanEdgeEvent(e,t,n,i,r)}}_nextFlipPoint(e,t,n,r){const s=this._orient(t,r,e);if(s===o.CW)return n.pointCCW(r);if(s===o.CCW)return n.pointCW(r);throw new Error("[Unsupported] nextFlipPoint: opposing point on constrained edge!")}_rotateTrianglePair(e,t,n,r){const s=e.neighborCCW(t),i=e.neighborCW(t),o=n.neighborCCW(r),a=n.neighborCW(r),c=e.getConstrainedEdgeCCW(t),l=e.getConstrainedEdgeCW(t),d=n.getConstrainedEdgeCCW(r),u=n.getConstrainedEdgeCW(r),h=e.getDelaunayEdgeCCW(t),g=e.getDelaunayEdgeCW(t),f=n.getDelaunayEdgeCCW(r),p=n.getDelaunayEdgeCW(r);e.legalize(t,r),n.legalize(r,t),n.setDelaunayEdgeCCW(t,h),e.setDelaunayEdgeCW(t,g),e.setDelaunayEdgeCCW(r,f),n.setDelaunayEdgeCW(r,p),n.setConstrainedEdgeCCW(t,c),e.setConstrainedEdgeCW(t,l),e.setConstrainedEdgeCCW(r,d),n.setConstrainedEdgeCW(r,u),e.clearNeighbors(),n.clearNeighbors(),s&&n.markNeighbor(s),i&&e.markNeighbor(i),o&&e.markNeighbor(o),a&&n.markNeighbor(a),e.markNeighbor(n)}_fillRightAboveEdgeEvent(e,t){let n=t;for(;n.next.pt.x<e.pt1.x;)this._orient(e.pt2,n.next.pt,e.pt1)===o.CCW?this._fillRightBelowEdgeEvent(e,n):n=n.next}_fillLeftAboveEdgeEvent(e,t){let n=t;for(;n.prev.pt.x>e.pt1.x;)this._orient(e.pt2,n.prev.pt,e.pt1)===o.CW?this._fillLeftBelowEdgeEvent(e,n):n=n.prev}_fillLeftBelowEdgeEvent(e,t){t.pt.x>e.pt1.x&&(this._orient(t.pt,t.prev.pt,t.prev.prev.pt)===o.CW?this._fillLeftConcaveEdgeEvent(e,t):(this._fillLeftConvexEdgeEvent(e,t),this._fillLeftBelowEdgeEvent(e,t)))}_fillLeftConcaveEdgeEvent(e,t){this._fillHole(t.prev),t.prev.pt!==e.pt1&&this._orient(e.pt2,t.prev.pt,e.pt1)===o.CW&&this._orient(t.pt,t.prev.pt,t.prev.prev.pt)===o.CW&&this._fillLeftConcaveEdgeEvent(e,t)}_fillLeftConvexEdgeEvent(e,t){this._orient(t.prev.pt,t.prev.prev.pt,t.prev.prev.prev.pt)===o.CW?this._fillLeftConcaveEdgeEvent(e,t.prev):this._orient(e.pt2,t.prev.prev.pt,e.pt1)===o.CW&&this._fillLeftConvexEdgeEvent(e,t.prev)}_fillRightBelowEdgeEvent(e,t){t.pt.x<e.pt1.x&&(this._orient(t.pt,t.next.pt,t.next.next.pt)===o.CCW?this._fillRightConcaveEdgeEvent(e,t):(this._fillRightConvexEdgeEvent(e,t),this._fillRightBelowEdgeEvent(e,t)))}_fillRightConcaveEdgeEvent(e,t){this._fillHole(t.next),t.next.pt!==e.pt1&&this._orient(e.pt2,t.next.pt,e.pt1)===o.CCW&&this._orient(t.pt,t.next.pt,t.next.next.pt)===o.CCW&&this._fillRightConcaveEdgeEvent(e,t)}_fillRightConvexEdgeEvent(e,t){this._orient(t.next.pt,t.next.next.pt,t.next.next.next.pt)===o.CCW?this._fillRightConcaveEdgeEvent(e,t.next):this._orient(e.pt2,t.next.next.pt,e.pt1)===o.CCW&&this._fillRightConvexEdgeEvent(e,t.next)}_pointEvent(e,t,n){const r=this._locateNode(e.x);if(!r)return;const s=this._newFrontTriangle(e,r);var o,a;return o=e.x,a=r.pt.x,o-a<i&&this._fillHole(r),this._fillEdge2Side(s,t,n),s}_fillEdge2Side(e,t,n){let r,s;n&&a(n.y,e.pt.y)&&a(t.y,e.pt.y)&&n.x>e.pt.x&&(r=(n.x+e.pt.x)/2),n&&a(n.y,e.pt.y)&&a(t.y,e.pt.y)&&t.x<e.pt.x&&(s=(t.x+e.pt.x)/2);let i=e.next,o=0;for(;i.next&&o<3&&i.pt.id<this._loopPointFlag;)if(o++,r&&i.pt.x<r)this._fillHole(i),i=i.next;else{if(this._isAngleObtuse(i.pt,i.next.pt,i.prev.pt))break;this._fillHole(i),i=i.next}for(i=e.prev,o=0;i.prev&&o<3&&i.pt.id<this._loopPointFlag;)if(o++,s&&i.pt.x>s)this._fillHole(i),i=i.prev;else{if(this._isAngleObtuse(i.pt,i.next.pt,i.prev.pt))break;this._fillHole(i),i=i.prev}e.next&&e.next.next&&this._isBasinAngxleRight(e)&&this._fillBasin(e)}_isBasinAngxleRight(e){const t=e.pt.x-e.next.next.pt.x,n=e.pt.y-e.next.next.pt.y;return t>=0||Math.abs(t)<n}_fillBasin(e){for(this._orient(e.pt,e.next.pt,e.next.next.pt)===o.CCW?this._basin.leftNode=e.next.next:this._basin.leftNode=e.next,this._basin.bottomNode=this._basin.leftNode;this._basin.bottomNode.next&&this._basin.bottomNode.pt.y>=this._basin.bottomNode.next.pt.y;)this._basin.bottomNode=this._basin.bottomNode.next;if(this._basin.bottomNode!==this._basin.leftNode){for(this._basin.rightNode=this._basin.bottomNode;this._basin.rightNode.next&&this._basin.rightNode.pt.y<this._basin.rightNode.next.pt.y;)this._basin.rightNode=this._basin.rightNode.next;this._basin.rightNode!==this._basin.bottomNode&&(this._basin.width=this._basin.rightNode.pt.x-this._basin.leftNode.pt.x,this._basin.leftHighest=this._basin.leftNode.pt.y>this._basin.rightNode.pt.y,this._fillBasinReq(this._basin.bottomNode))}}_fillBasinReq(e){if(this._isShallow(e))return;let t;this._fillHole(e);let n=e;if(e.prev!==this._basin.leftNode||e.next!==this._basin.rightNode){if(e.prev===this._basin.leftNode){if(t=this._orient(e.pt,e.next.pt,e.next.next.pt),t===o.CW)return;n=e.next}else if(e.next===this._basin.rightNode){if(t=this._orient(e.pt,e.prev.pt,e.prev.prev.pt),t===o.CCW)return;n=e.prev}else n=e.prev.pt.y<e.next.pt.y?e.prev:e.next;this._fillBasinReq(n)}}_isShallow(e){let t;return t=this._basin.leftHighest?this._basin.leftNode.pt.y-e.pt.y:this._basin.rightNode.pt.y-e.pt.y,this._basin.width>t}_fillHole(e){const t=new s.Triangle(e.prev.pt,e.pt,e.next.pt);t.markNeighbor(e.prev.triangle),t.markNeighbor(e.triangle),this._addTriangle(t),e.prev.next=e.next,e.next.prev=e.prev,this._legalize(t)||this._mapTriangleToNodes(t)}_newFrontTriangle(e,t){const n=new s.Triangle(e,t.pt,t.next.pt);n.markNeighbor(t.triangle),this._addTriangle(n);const r={pt:e,value:e.x,prev:t,next:t.next};return t.next.prev=r,t.next=r,this._legalize(n)||this._mapTriangleToNodes(n),r}_initTriangulation(){let e=this._points[0].x,t=this._points[0].x,n=this._points[0].y,r=this._points[0].y;const i=this._points.length;for(let s=1;s<i;s++){const i=this._points[s];i.x>e&&(e=i.x),i.x<t&&(t=i.x),i.y>n&&(n=i.y),i.y<r&&(r=i.y)}const o=.3*(e-t),c=.3*(n-r),l={pt:{x:e+o,y:r-c,id:-1},value:e+o},d={pt:{x:t-o,y:r-c,id:-1},value:t-o};this._points.sort(((e,t)=>a(e.y,t.y)?e.x-t.x:e.y-t.y));const u=new s.Triangle(this._points[0],d.pt,l.pt);this._addTriangle(u),d.triangle=u;const h={pt:this._points[0],value:this._points[0].x,prev:d,next:l,triangle:u};d.next=h,l.prev=h,this._advancingFront={head:d,tail:l,searchNode:d}}_initData(){for(let e=0;e<this._ptLoops.length;++e){const t=this._ptLoops[e];for(let e=0;e<t.length;++e){const n=t[e],r=t[(e+1)%t.length],s={pt1:n,pt2:r};if(n.y>r.y)s.pt1=r,s.pt2=n;else if(n.y===r.y)if(n.x>r.x)s.pt1=r,s.pt2=n;else if(n.x===r.x)throw Error("grid discrete error: repeat point!");this._edges.push(s);const i=this._pointEdges.get(s.pt2);i?i.push(s):this._pointEdges.set(s.pt2,[s])}}}_addInnerPoints(){let e=this._points.length;const t=new r.PointPolygonPositionJudger(this._ptLoops);for(const n of this._xGrid)for(const s of this._yGrid){const i={x:n,y:s};t.judge(i)===r.PtLoopPositonType.IN&&(this._points.push({x:n,y:s,id:e}),++e)}}_locateNode(e){let t=this._advancingFront.searchNode;if(e<t.value){for(;t.prev;)if(t=t.prev,e>=t.value)return this._advancingFront.searchNode=t,t}else for(;t.next;)if(t=t.next,e<t.value)return this._advancingFront.searchNode=t.prev,t.prev}_legalize(e){for(let t=0;t<3;++t){if(e.delaunayEdge[t])continue;const n=e.neighbors[t];if(n){const r=e.pts[t],s=n.oppositePoint(e,r),i=n.index(s);if(n.constrainedEdge[i]||n.delaunayEdge[i]){e.constrainedEdge[t]=n.constrainedEdge[i];continue}if(this._inCircle(r,e.pointCCW(r),e.pointCW(r),s)){e.delaunayEdge[t]=!0,n.delaunayEdge[i]=!0,this._rotateTrianglePair(e,r,n,s);let o=!this._legalize(e);return o&&this._mapTriangleToNodes(e),o=!this._legalize(n),o&&this._mapTriangleToNodes(n),e.delaunayEdge[t]=!1,n.delaunayEdge[i]=!1,!0}}}return!1}_isAngleObtuse(e,t,n){const r=t.x-e.x,s=t.y-e.y;return r*(n.x-e.x)+s*(n.y-e.y)<0}_isEdgeSideOfTriangle(e,t,n){const r=e.edgeIndex(t,n);if(-1!==r){e.constrainedEdge[r]=!0;const s=e.neighbors[r];return s&&s.markConstrainedEdgeByPoints(t,n),!0}return!1}_orient(e,t,n){const r=(e.x-n.x)*(t.y-n.y)-(e.y-n.y)*(t.x-n.x);return r>-i&&r<i?o.COLLINEAR:r>0?o.CCW:o.CW}_mapTriangleToNodes(e){for(let t=0;t<3;++t)if(!e.neighbors[t]){const n=e.pointCW(e.pts[t]);if(n){const t=this._locatePoint(n);t&&(t.triangle=e)}}}_locatePoint(e){const t=e.x;let n=this._advancingFront.searchNode;const r=n.pt.x;if(t===r){if(e!==n.pt)if(e===n.prev.pt)n=n.prev;else{if(e!==n.next.pt)throw new Error("Invalid AdvancingFront.locatePoint() call");n=n.next}}else if(t<r)for(;n.prev&&(n=n.prev,e!==n.pt););else for(;n.next&&(n=n.next,e!==n.pt););return n&&(this._advancingFront.searchNode=n),n}_inScanArea(e,t,n,r){if((e.x-t.x)*(r.y-t.y)-(r.x-t.x)*(e.y-t.y)>=-i)return!1;return!((e.x-n.x)*(r.y-n.y)-(r.x-n.x)*(e.y-n.y)<=i)}_inCircle(e,t,n,r){const s=e.x-r.x,i=e.y-r.y,o=t.x-r.x,a=t.y-r.y,c=s*a-o*i;if(c<=0)return!1;const l=n.x-r.x,d=n.y-r.y,u=l*i-s*d;if(u<=0)return!1;return(s*s+i*i)*(o*d-l*a)+(o*o+a*a)*u+(l*l+d*d)*c>0}}t.GridDiscrete=c},49986:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Triangle=void 0;t.Triangle=class{constructor(e,t,n){this.visit=!1,this.pts=[e,t,n],this.neighbors=[void 0,void 0,void 0],this.constrainedEdge=[!1,!1,!1],this.delaunayEdge=[!1,!1,!1]}containsPoint(e){const t=this.pts;return e===t[0]||e===t[1]||e===t[2]}containsEdge(e){return this.containsPoint(e.pt1)&&this.containsPoint(e.pt2)}containsPoints(e,t){return this.containsPoint(e)&&this.containsPoint(t)}markNeighborPointers(e,t,n){const r=this.pts;if(e===r[2]&&t===r[1]||e===r[1]&&t===r[2])this.neighbors[0]=n;else if(e===r[0]&&t===r[2]||e===r[2]&&t===r[0])this.neighbors[1]=n;else{if(!(e===r[0]&&t===r[1]||e===r[1]&&t===r[0]))throw new Error("Invalid Triangle.markNeighborPointers() call");this.neighbors[2]=n}}markNeighbor(e){const t=this.pts;e.containsPoints(t[1],t[2])?(this.neighbors[0]=e,e.markNeighborPointers(t[1],t[2],this)):e.containsPoints(t[0],t[2])?(this.neighbors[1]=e,e.markNeighborPointers(t[0],t[2],this)):e.containsPoints(t[0],t[1])&&(this.neighbors[2]=e,e.markNeighborPointers(t[0],t[1],this))}clearNeighbors(){this.neighbors[0]=void 0,this.neighbors[1]=void 0,this.neighbors[2]=void 0}clearDelaunayEdges(){this.delaunayEdge[0]=!1,this.delaunayEdge[1]=!1,this.delaunayEdge[2]=!1}pointCW(e){const t=this.pts;return e===t[0]?t[2]:e===t[1]?t[0]:e===t[2]?t[1]:null}pointCCW(e){const t=this.pts;return e===t[0]?t[1]:e===t[1]?t[2]:e===t[2]?t[0]:void 0}neighborCW(e){return e===this.pts[0]?this.neighbors[1]:e===this.pts[1]?this.neighbors[2]:this.neighbors[0]}neighborCCW(e){return e===this.pts[0]?this.neighbors[2]:e===this.pts[1]?this.neighbors[0]:this.neighbors[1]}getConstrainedEdgeCW(e){return e===this.pts[0]?this.constrainedEdge[1]:e===this.pts[1]?this.constrainedEdge[2]:this.constrainedEdge[0]}getConstrainedEdgeCCW(e){return e===this.pts[0]?this.constrainedEdge[2]:e===this.pts[1]?this.constrainedEdge[0]:this.constrainedEdge[1]}getConstrainedEdgeAcross(e){return e===this.pts[0]?this.constrainedEdge[0]:e===this.pts[1]?this.constrainedEdge[1]:this.constrainedEdge[2]}setConstrainedEdgeCW(e,t){e===this.pts[0]?this.constrainedEdge[1]=t:e===this.pts[1]?this.constrainedEdge[2]=t:this.constrainedEdge[0]=t}setConstrainedEdgeCCW(e,t){e===this.pts[0]?this.constrainedEdge[2]=t:e===this.pts[1]?this.constrainedEdge[0]=t:this.constrainedEdge[1]=t}getDelaunayEdgeCW(e){return e===this.pts[0]?this.delaunayEdge[1]:e===this.pts[1]?this.delaunayEdge[2]:this.delaunayEdge[0]}getDelaunayEdgeCCW(e){return e===this.pts[0]?this.delaunayEdge[2]:e===this.pts[1]?this.delaunayEdge[0]:this.delaunayEdge[1]}setDelaunayEdgeCW(e,t){e===this.pts[0]?this.delaunayEdge[1]=t:e===this.pts[1]?this.delaunayEdge[2]=t:this.delaunayEdge[0]=t}setDelaunayEdgeCCW(e,t){e===this.pts[0]?this.delaunayEdge[2]=t:e===this.pts[1]?this.delaunayEdge[0]=t:this.delaunayEdge[1]=t}neighborAcross(e){return e===this.pts[0]?this.neighbors[0]:e===this.pts[1]?this.neighbors[1]:this.neighbors[2]}oppositePoint(e,t){const n=e.pointCW(t);return this.pointCW(n)}legalize(e,t){const n=this.pts;if(e===n[0])n[1]=n[0],n[0]=n[2],n[2]=t;else if(e===n[1])n[2]=n[1],n[1]=n[0],n[0]=t;else{if(e!==n[2])throw new Error("Invalid Triangle.legalize() call");n[0]=n[2],n[2]=n[1],n[1]=t}}index(e){const t=this.pts;if(e===t[0])return 0;if(e===t[1])return 1;if(e===t[2])return 2;throw new Error("Invalid Triangle.index() call")}edgeIndex(e,t){const n=this.pts;if(e===n[0]){if(t===n[1])return 2;if(t===n[2])return 1}else if(e===n[1]){if(t===n[2])return 0;if(t===n[0])return 2}else if(e===n[2]){if(t===n[0])return 1;if(t===n[1])return 0}return-1}markConstrainedEdgeByEdge(e){this.markConstrainedEdgeByPoints(e.pt1,e.pt2)}markConstrainedEdgeByPoints(e,t){const n=this.pts;t===n[0]&&e===n[1]||t===n[1]&&e===n[0]?this.constrainedEdge[2]=!0:t===n[0]&&e===n[2]||t===n[2]&&e===n[0]?this.constrainedEdge[1]=!0:(t===n[1]&&e===n[2]||t===n[2]&&e===n[1])&&(this.constrainedEdge[0]=!0)}}},83540:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LibtessVertex=t.tessTriangulate=void 0;const r=n(28856);function s(e){r.primitiveType.GL_TRIANGLES}function i(e){}t.tessTriangulate=function(e,t){const n=function(){const e=new r.GluTesselator;return e.gluTessCallback(r.gluEnum.GLU_TESS_VERTEX_DATA,(function(e,t){t.push(e)})),e.gluTessCallback(r.gluEnum.GLU_TESS_BEGIN,s),e.gluTessCallback(r.gluEnum.GLU_TESS_ERROR,i),e.gluTessCallback(r.gluEnum.GLU_TESS_COMBINE,(function(e,t,n){return[e[0],e[1],e[2]]})),e.gluTessCallback(r.gluEnum.GLU_TESS_EDGE_FLAG,(function(e){})),e}();n.gluTessNormal(t[0],t[1],t[2]);const o=[];n.gluTessBeginPolygon(o);for(const t of e){n.gluTessBeginContour();for(const e of t)n.gluTessVertex(e,e);n.gluTessEndContour()}return n.gluTessEndPolygon(),o};t.LibtessVertex=class extends Array{constructor(e,t){super(),this.push(e.x),this.push(e.y),this.push(e.z?e.z:0),this.index=t}}},51097:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveToCurveDistanceUtil=void 0;const r=n(61226),s=n(60229),i=n(56973),o=n(87279),a=n(81658),c=n(11042),l=n(68238),d=n(33218),u=n(49246);t.CurveToCurveDistanceUtil=class{static minAtEnds2d(e,t,n,r){const s=[e.getStartPt(),e.getEndPt(),new d.Vector2,new d.Vector2],o=[new d.Vector2,new d.Vector2,t.getStartPt(),t.getEndPt()],a=new Array(4);a[0]=l.Distance.pointToCurve2d(s[0],t,o[0]),a[1]=l.Distance.pointToCurve2d(s[1],t,o[1]),a[2]=l.Distance.pointToCurve2d(o[2],e,s[2]),a[3]=l.Distance.pointToCurve2d(o[3],e,s[3]);let c=a[0],u=0;for(let e=1;e<4;e++)a[e]<c-i.Tolerance.PROCESS_LENGTH_EPS&&(c=a[e],u=e);return n&&n.copy(s[u]),r&&r.copy(o[u]),c}static minAtEnds3d(e,t,n,s){const o=[e.getStartPt(),e.getEndPt(),new r.Vector3,new r.Vector3],a=[new r.Vector3,new r.Vector3,t.getStartPt(),t.getEndPt()],c=new Array(4);c[0]=l.Distance.pointToCurve3d(o[0],t,a[0]),c[1]=l.Distance.pointToCurve3d(o[1],t,a[1]),c[2]=l.Distance.pointToCurve3d(a[2],e,o[2]),c[3]=l.Distance.pointToCurve3d(a[3],e,o[3]);let d=c[0],u=0;for(let e=1;e<4;e++)c[e]<d-i.Tolerance.PROCESS_LENGTH_EPS&&(d=c[e],u=e);return n&&n.copy(o[u]),s&&s.copy(a[u]),d}static execute(e,t,n,r,o,c=s.CONST.MAX_INTEGER){let l=[],d=c+1;const u=[];let h=0;for(;h<s.CONST.MAX_SUBDEVIDE_DEPTH;){if(d<i.Tolerance.LENGTH_EPS)return d;for(const t of e){const e=[],n=new a.Curve3dSegment(t.curve),r=new a.Curve3dSegment(t.curve);e.push(n),e.push(r),a.CurveSegment.subdivideCurveSegment(t,e)}for(const e of t){const t=[],n=new a.Curve3dSegment(e.curve),r=new a.Curve3dSegment(e.curve);t.push(n),t.push(r),a.CurveSegment.subdivideCurveSegment(e,t)}const s=a.Curve3dSegmentPair.combineCurveSegmentPairs(n,l);if(h>0&&!s)break;const c=this._calCurvSegmentPairsDist(l,u,r,o,d);if(l=l.filter((e=>e.getTwoBoxsMinDistance()<=c)),0===l.length||h>3&&0===u.length)break;if(Math.abs(c-d)<100*i.Tolerance.LENGTH_EPS&&0!==u.length)break;a.Curve3dSegmentPair.refreshCurveSegments(l,e,t),n.splice(0),n.push(...l),d=c,l=[],h++}return d}static _calCurvSegmentPairsDist(e,t,n,a,c=s.CONST.MAX_INTEGER){let l=c;const d=[];for(const s of e){if(s.getTwoBoxsMinDistance()>l)continue;const e=s.segment1,c=s.segment2,u=e.curve,h=c.curve;if(u.isLine3d()&&h.isLine3d()){const e=new r.Vector3,t=new r.Vector3,s=o.Curve3dToCurve3dDistance.execute(u,h,e,t);s<l&&(l=s,n.copy(e),a.copy(t));continue}const g=[e.range.getMid(),c.range.getMid()];if(this._calcCurvCurvIteration(u,h,g,l)&&e.range.containsPoint(g[0])&&c.range.containsPoint(g[1])){const e=u.getPtAt(g[0]),r=h.getPtAt(g[1]),s=e.sqDistanceTo(r);if(s<l*l-i.Tolerance.LENGTH_EPS2){const i={point1:e,point2:r,sqrDistance:s};t.push(i),l=Math.sqrt(s),n.copy(i.point1),a.copy(i.point2)}}d.push(s)}return e.splice(0),e.push(...d),l}static _calcCurvCurvIteration(e,t,n,r){const o=i.Tolerance.LENGTH_EPS2,a=1e-4*o;let l=e.getPtAt(n[0]),d=t.getPtAt(n[1]),h=s.CONST.MAX_INTEGER,g=d.sqDistanceTo(d);if(h<a)return!0;let f=0,p=!0;for(;(f<s.CONST.NORMAL_ITER_NUM||p)&&!(f>s.CONST.MAX_ITER_NUM);f++){h=g;const r=c.calcNextCurveCurveIteration(e,t,n);if(0===r.length)return!0;const i=[n[0]-r[0],n[1]-r[1]];n[0]=e.getRange().clamp(i[0]),n[1]=t.getRange().clamp(i[1]);const a=e.getPtAt(n[0]),_=t.getPtAt(n[1]);if(g=a.sqDistanceTo(_),l.sqDistanceTo(a)<o&&d.sqDistanceTo(_)<o)return!(u.Util.isNearlyEqual(i[0],e.getStartParam())||u.Util.isNearlyEqual(i[0],e.getEndParam())||u.Util.isNearlyEqual(i[1],t.getStartParam())||u.Util.isNearlyEqual(i[1],e.getEndParam()));f>=s.CONST.NORMAL_ITER_NUM&&(p=g<h),l=a,d=_}return Math.abs(g-h)<o&&Math.sqrt(g)<r}}},87642:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Curve2dToCurve2dDistance=void 0;const r=n(10909),s=n(32858),i=n(53756),o=n(21255),a=n(50869);t.Curve2dToCurve2dDistance=class{static execute(e,t,n,c){if(e instanceof s.Line2d&&t instanceof s.Line2d)return i.Line2dToLine2dDistance.execute(e,t,n,c);if(e instanceof s.Line2d&&t instanceof r.Arc2d)return o.Line2dToArc2dDistance.execute(e,t,n,c);if(e instanceof r.Arc2d&&e.isEqualAB()&&t instanceof s.Line2d)return o.Line2dToArc2dDistance.execute(t,e,c,n);if(e instanceof r.Arc2d&&e.isEqualAB()&&t instanceof r.Arc2d&&t.isEqualAB())return a.Arc2dToArc2dDistance.execute(e,t,n,c);throw new Error(`请实现点到曲线距离${e.getType()}${t.getType()}`)}}},50869:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Arc2dToArc2dDistance=void 0;const r=n(49246),s=n(60229),i=n(56973),o=n(33218),a=n(51097);t.Arc2dToArc2dDistance=class{static execute(e,t,n,r){const s=e.getCenter(),c=t.getCenter(),l=e.getRadius(),d=t.getRadius(),u=s.distanceTo(c);if(u<i.Tolerance.LENGTH_EPS)return a.CurveToCurveDistanceUtil.minAtEnds2d(e,t,n,r);let h,g;l>d?(h=e.getParamAt(c),g=l*l-d*d>u*u?t.getParamAt(e.getPtAt(h)):t.getParamAt(s)):(g=t.getParamAt(s),h=d*d-l*l>u*u?e.getParamAt(t.getPtAt(g)):e.getParamAt(c));const f=new o.Vector2;if(this._IsIntsectTwoArc2d(e,t,h,g,f))return n&&n.copy(f),r&&r.copy(f),0;if(u>l+d){if(e.getRange().containsPoint(h)&&t.getRange().containsPoint(g)){const s=Math.abs(u-(l+d));return n&&n.copy(e.getPtAt(h)),r&&r.copy(t.getPtAt(g)),s}}else if(Math.abs(l-d)>u&&e.getRange().containsPoint(h)&&t.getRange().containsPoint(g)){const s=Math.abs(l-d)-u;return n&&n.copy(e.getPtAt(h)),r&&r.copy(t.getPtAt(g)),s}return a.CurveToCurveDistanceUtil.minAtEnds2d(e,t,n,r)}static _IsIntsectTwoArc2d(e,t,n,s,a){const c=e.getCenter(),l=t.getCenter(),d=e.getRadius(),u=t.getRadius(),h=c.distanceTo(l);if(r.Util.isNearlySmallerOrEqual(h,d+u,i.Tolerance.LENGTH_EPS)&&r.Util.isNearlyBiggerOrEqual(h,Math.abs(d-u),i.Tolerance.LENGTH_EPS))if(r.Util.isNearlyEqual(h,d+u,i.Tolerance.LENGTH_EPS)||r.Util.isNearlyEqual(h,Math.abs(d-u),i.Tolerance.LENGTH_EPS)){if(e.getRange().containsPoint(n)&&t.getRange().containsPoint(s))return a.copy(e.getPtAt(n)),!0}else{const r=Math.abs(d*d-u*u+h*h)/(2*h),s=Math.acos(r/d),i=n-s,c=n+s,l=new o.Vector2;if(this._IsIntPtInRange(e,t,i,l)||this._IsIntPtInRange(e,t,c,l))return a.copy(l),!0}return!1}static _IsIntPtInRange(e,t,n,o){let a=n;for(;r.Util.isNearlySmaller(a,e.getRange().min,i.Tolerance.LENGTH_EPS);)a+=s.CONST.PI2;for(;r.Util.isNearlyBigger(a,e.getRange().max,i.Tolerance.LENGTH_EPS);)a-=s.CONST.PI2;const c=e.getPtAt(a),l=t.getParamAt(c);return!(!e.getRange().containsPoint(a)||!t.getRange().containsPoint(l))&&(o.copy(c),!0)}}},21255:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Line2dToArc2dDistance=void 0;const r=n(49246),s=n(56973),i=n(33218),o=n(51097);t.Line2dToArc2dDistance=class{static execute(e,t,n,a){const c=t.getCenter(),l=t.getRadius(),d=e.getDirection(),u=new i.Vector2(d.y,-d.x),h=e.getStartPt().subtract(c),g=Math.abs(h.dot(u)),f=e.getParamAt(c),p=e.getPtAt(f),_=t.getParamAt(p);if(r.Util.isNearlySmallerOrEqual(g,t.getRadius(),s.Tolerance.LENGTH_EPS)){const r=Math.sqrt(l*l-g*g),s=f-r,o=f+r,c=new i.Vector2;if(this._IsIntPtInRange(e,t,s,c)||this._IsIntPtInRange(e,t,o,c))return n&&n.copy(c),a&&a.copy(c),0}if(g>t.getRadius()&&e.getRange().containsPoint(f)&&t.getRange().containsPoint(_)){const r=g-l;return n&&n.copy(e.getPtAt(f)),a&&a.copy(t.getPtAt(_)),r}return o.CurveToCurveDistanceUtil.minAtEnds2d(e,t,n,a)}static _IsIntPtInRange(e,t,n,r){if(e.getRange().containsPoint(n)){const s=e.getPtAt(n),i=t.getParamAt(s);return!!t.getRange().containsPoint(i)&&(r.copy(s),!0)}return!1}}},53756:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Line2dToLine2dDistance=void 0;const r=n(72564),s=n(51097);t.Line2dToLine2dDistance=class{static execute(e,t,n,i){if(!e.isParallelTo(t)){const s=e.getDirection(),o=t.getDirection(),a=t.getOrigin().subtracted(e.getOrigin()),c=[[s.x,-o.x],[s.y,-o.y]],l=[a.x,a.y],d=r.solve(c,l);if(e.getRange().containsPoint(d[0])&&t.getRange().containsPoint(d[1]))return n&&n.copy(e.getPtAt(d[0])),i&&i.copy(t.getPtAt(d[1])),0}return s.CurveToCurveDistanceUtil.minAtEnds2d(e,t,n,i)}}},87279:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Curve3dToCurve3dDistance=void 0;const r=n(61226),s=n(60229),i=n(56973),o=n(69119),a=n(75305),c=n(51097),l=n(81658),d=n(6148);t.Curve3dToCurve3dDistance=class{static execute(e,t,n,r){return e.isLine3d()&&t.isLine3d()?this._Line3dToLine3dDistance(e,t,n,r):this._Curve3dToCurve3dDistance(e,t,n,r)}static _Line3dToLine3dDistance(e,t,n,r){if(!e.isParallelTo(t)){const s=d.Line3dToLine3dDistanceParamed.execute(e.getOrigin(),t.getOrigin(),e.getDirection(),t.getDirection());if(e.getRange().containsPoint(s[0])&&t.getRange().containsPoint(s[1])){const i=e.getPtAt(s[0]),o=t.getPtAt(s[1]);return n&&n.copy(i),r&&r.copy(o),i.distanceTo(o)}}return c.CurveToCurveDistanceUtil.minAtEnds3d(e,t,n,r)}static _Curve3dToCurve3dDistance(e,t,n,d){let u=s.CONST.MAX_INTEGER;const h=[],g=[],f=new l.Curve3dSegment(e);f.range=e.getRange(),f.depth=0;const p=new l.Curve3dSegment(t);p.range=t.getRange(),p.depth=0,h.push(f),g.push(p);const _=l.Curve3dSegment.getEndPoints(h),m=l.Curve3dSegment.getEndPoints(g),v=new r.Vector3,E=new r.Vector3;let P=o.PointsToPointsDistance.execute(_,m,v,E);if(P<u&&(u=P,n&&n.copy(v),d&&d.copy(E),u<i.Tolerance.LENGTH_EPS))return u;const y=[t];if(P=a.PointsToCurvesDistance.execute(_,y,v,E,u),P<u&&(u=P,n&&n.copy(v),d&&d.copy(E),u<i.Tolerance.LENGTH_EPS))return u;const C=[e];if(P=a.PointsToCurvesDistance.execute(m,C,E,v,u),P<u&&(u=P,n&&n.copy(v),d&&d.copy(E),u<i.Tolerance.LENGTH_EPS))return u;const S=[],T=new l.Curve3dSegmentPair(f,p);return S.push(T),P=c.CurveToCurveDistanceUtil.execute(h,g,S,v,E,u),P<u&&(u=P,n&&n.copy(v),d&&d.copy(E)),u}}},6148:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Line3dToLine3dDistanceParamed=void 0;const r=n(72564),s=n(61226);t.Line3dToLine3dDistanceParamed=class{static execute(e,t,n,i){const o=new s.Vector3(e,t),a=s.Vector3.make(n),c=s.Vector3.make(i),l=[[a.dot(n),-a.dot(i)],[c.dot(n),-c.dot(i)]],d=[a.dot(o),c.dot(o)];return r.solve(l,d)}}},89009:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointToCurve2dDistance=void 0;const r=n(32858),s=n(94399),i=n(10909),o=n(56973),a=n(60229);t.PointToCurve2dDistance=class{static execute(e,t,n=!1){if(t instanceof r.Line2d||t instanceof s.Circle2d||t instanceof i.Arc2d&&t.isEqualAB())return this.simple(e,t,n);const c=t.getRange(),l=t.getAllFootParams(e).filter((e=>c.containsPoint(e)));let d=c.min,u=a.CONST.MAX_INTEGER;for(const r of l){const s=t.getPtAt(r),i=t.getTangentAt(r),o=-s.subtracted(e).cross(i);Math.abs(o)<Math.abs(u)&&(d=r,u=n?o:Math.abs(o))}return l.length>0?{param:d,distance:u,foot:t.getPtAt(d)}:this._toCurveEnd(e,t,u>-o.Tolerance.PROCESS_LENGTH_EPS,n)}static simple(e,t,n=!1){const r=t.getParamAt(e),s=t.getPtAt(r),i=t.getTangentAt(r),a=-s.subtracted(e).cross(i);return t.getRange().containsPoint(r)?{param:r,distance:n?a:Math.abs(a),foot:s}:this._toCurveEnd(e,t,a>-o.Tolerance.PROCESS_LENGTH_EPS,n)}static _toCurveEnd(e,t,n,r=!1){const s=t.getStartPt(),i=t.getEndPt(),a=s.distanceTo(e),c=i.distanceTo(e),l=t.getRange();return a<c+o.Tolerance.PROCESS_LENGTH_EPS?{param:l.min,foot:s,distance:r&&!n?-a:a}:{param:l.max,foot:i,distance:r&&!n?-c:c}}}},68956:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointToCurve3dDistance=void 0;const r=n(87222),s=n(29540),i=n(97602),o=n(93145),a=n(53487),c=n(56973),l=n(26773),d=n(60229);class u{static execute(e,t){return t instanceof r.Line3d||t instanceof s.Circle3d||t instanceof i.Arc3d&&t.isEqualAB()?this.simple(e,t):this.general(e,t)}static simple(e,t){const n=t.getParamAt(e);if(t.getRange().containsPoint(n)){const r=t.getPtAt(n);return{param:n,foot:r,distance:r.distanceTo(e)}}const r=u._sqDistanceToCurveEndAndSingularities(e,t);return r.distance=Math.sqrt(r.distance),r}static general(e,t){const n=u._sqDistanceToCurveEndAndSingularities(e,t),r=this._getMinDistFootParamInRange(e,t);if(void 0!==r){const s=t.getPtAt(r),i=s.sqDistanceTo(e);if(i<n.distance)return{param:r,foot:s,distance:Math.sqrt(i)}}return n.distance=Math.sqrt(n.distance),n}static curves(e,t,n=c.Tolerance.LENGTH_EPS){let r=d.CONST.MODEL_MAX_LENGTH;const s=[];for(const i of t){const t=u.execute(e,i);t.distance<r-n?(s.length=0,s.push(t),r=t.distance):t.distance<r+n&&(s.push(t),t.distance<r&&(r=t.distance))}return s}static _sqDistanceToCurveEndAndSingularities(e,t){const n=t.getStartPt(),r={param:t.getStartParam(),foot:n,distance:n.sqDistanceTo(e)},s=[t.getRange().max].concat(t.getSingularities()),i=c.Tolerance.PROCESS_LENGTH_EPS;for(const n of s){const s=t.getPtAt(n),o=s.sqDistanceTo(e);o<r.distance+i&&(r.param=n,r.foot=s,r.distance=o)}return r}static _getMinDistFootParamInRange(e,t){if(t instanceof i.Arc3d){const n=t.getAllFootParams(e).filter((e=>t.getRange().containsPoint(e)));if(n.length<1)return;const r=t.getPtAt(n[0]),s={t:n[0],pt:r};let i=r.sqDistanceTo(e);for(let r=1;r<n.length;r++){const o=t.getPtAt(n[r]),a=o.sqDistanceTo(e);a<i&&(i=a,s.pt=o,s.t=n[r])}return l.PeriodInterval.RegularizeParam(s.t,d.CONST.PI2,t.getRange().min)}if(t instanceof o.NurbsCurve3d)return t.getParamAt(e);if(t instanceof a.OffsetCurve3d){const n=t.getParamMapper(),r=t.getRange(),s=n.getBaseParam(r.min,!1),i=n.getBaseParam(r.max,!0),o=l.PeriodInterval.make(s,i,n.getBasePeriod()),a=t.getBaseCurve(),c=a.getRange().clone();a.setRange(o);const d=s-a.getRange().min,u=this._getMinDistFootParamInRange(e,a);if(a.setRange(c),void 0===u)return;return n.getParam(u+d)}}}t.PointToCurve3dDistance=u},1281:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointToSurfaceDistance=void 0;const r=n(5804),s=n(29453),i=n(61226),o=n(33218),a=n(26773);class c{static execute(e,t,n){if(t instanceof r.Plane)return c._PtToPlaneDistance(e,t,n);if(t instanceof s.Cylinder)return c._PtToCylinderDistance(e,t,n);const i=t.getUVAt(e),o=t.getPtAt(i),a=t.getNormAt(i),l=o.distanceTo(e);return n&&n.copy(o),a.dot(e.subtracted(o).normalize())<0?-l:l}static _PtToPlaneDistance(e,t,n){const r=new i.Vector3(t.getOrigin(),e),s=t.getNorm(),o=r.dot(s);if(n){const r=e.subtracted(t.getNorm().multiply(o));n.copy(r)}return o}static _PtToCylinderDistance(e,t,n){const r=t.getCoord().getLocalPtAt(e),s=r.x/t.getA(),i=r.y/t.getB(),c=Math.atan2(i,s),l=new o.Vector2(a.PeriodInterval.RegularizeParam(c),r.z),d=t.getPtAt(l),u=d.distanceTo(e);return n&&n.copy(d),s*s+i*i<1?-u:u}}t.PointToSurfaceDistance=c},75305:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointsToCurvesDistance=void 0;const r=n(60229),s=n(56973),i=n(68956);t.PointsToCurvesDistance=class{static execute(e,t,n,o,a=r.CONST.MAX_INTEGER){let c=a;for(const r of e)for(const e of t){const t=i.PointToCurve3dDistance.execute(r,e);if(t.distance<c&&(c=t.distance,n.copy(r),o.copy(t.foot)),c<s.Tolerance.LENGTH_EPS)return c}return c}}},69119:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointsToPointsDistance=void 0;const r=n(60229),s=n(56973);t.PointsToPointsDistance=class{static execute(e,t,n,i){let o=r.CONST.MAX_INTEGER;for(const r of e)for(const e of t){const t=r.sqDistanceTo(e);if(t<o&&(o=t,n.copy(r),i.copy(e),o<s.Tolerance.LENGTH_EPS))return Math.sqrt(o)}return Math.sqrt(o)}}},8366:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Fitting=void 0;const r=n(56973),s=n(48448),i=n(93145),o=n(737);t.Fitting=class{static nurbs2dFitting(e,t=3,n=r.Tolerance.LENGTH_EPS){if(e.isNurbsCurve2d())return e;if(e.isLine2d()||e.isArc2d()||e.isOffsetCurve2d()||e.isExtendCurve2d())return e.toNurbs(t,n);const i=e.discrete();return s.NurbsCurve2d.makeByInterpolationPoints(i,t)}static nurbs3dFitting(e,t=3,n=r.Tolerance.LENGTH_EPS){if(e.isNurbsCurve3d())return e;if(e.isLine3d()||e.isArc3d()||e.isOffsetCurve3d()||e.isExtendCurve3d())return e.toNurbs(t,n);const s=e.discrete();return i.NurbsCurve3d.makeByInterpolationPoints(s,t)}static nurbsSurfaceFitting(e,t,n=3,s=3,i=r.Tolerance.LENGTH_EPS){return e.isNurbsSurface()?e:e.isPlane()||e.isCylinder()||e.isCone()||e.isSphere()||e.isOffsetSurface()||e.isSweepSurface()?e.toNurbs(t,n,s,i):new o.NurbsSurface}}},30384:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GeometryMerge=void 0;const r=n(25050),s=n(56973),i=n(3),o=n(46302);t.GeometryMerge=class{static mergeCurve2ds(e,t=s.Tolerance.LENGTH_EPS){return r.MergeCurve.mergeCurve2d(e,t)}static mergeCurve2dsEx(e,t=s.Tolerance.LENGTH_EPS){return r.MergeCurve.mergeCurve2dEx(e,t)}static mergePoints(e,t=s.Tolerance.LENGTH_EPS){return(new i.MergePoint).merge(e,t)}static mergeTwoCurve2ds(e,t,n=o.MergeReverseMode.merge,r=s.Tolerance.DEFAULT){return o.CurveCurveMerge.curve2ds(e,t,n,r)}static mergeTwoCurve3ds(e,t,n=o.MergeReverseMode.merge,r=s.Tolerance.DEFAULT){return o.CurveCurveMerge.curve3ds(e,t,n,r)}}},16472:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GridDiscrete=t.boxToTrimmedSurfaces=t.boxCutLine=t.DiscreteTopology=t.DiscreteUtil=t.MeshUtil=t.ClipMesh=t.ILoopsToPolygonExes=t.LoopLoopPositonType=t.PtLoopPositonType=t.CurveCuvePositonType=t.PointPolygonPositionJudger=t.PositionJudge=t.LoopCentroid=t.LoopArea=t.TopologyEdit=t.BoolOperateClipper=t.SearchGraph=t.PolygonOffset=t.BoolType=t.Bool2dType=t.Bool2d=t.BoolOperate2d=t.Overlap=t.CalculateOverlap=t.Fit=t.CalculateFit=t.Offset=t.CalculateOffset=t.Project=t.CalculateProject=t.GeometryMerge=t.CurveCurveMerge=t.CurveCurveColinear=t.Intersect=t.CalculateIntersect=t.Distance=t.CalculateDistance=void 0;var r=n(68238);Object.defineProperty(t,"CalculateDistance",{enumerable:!0,get:function(){return r.CalculateDistance}}),Object.defineProperty(t,"Distance",{enumerable:!0,get:function(){return r.Distance}});var s=n(61077);Object.defineProperty(t,"CalculateIntersect",{enumerable:!0,get:function(){return s.CalculateIntersect}}),Object.defineProperty(t,"Intersect",{enumerable:!0,get:function(){return s.Intersect}});var i=n(79034);Object.defineProperty(t,"CurveCurveColinear",{enumerable:!0,get:function(){return i.CurveCurveColinear}});var o=n(46302);Object.defineProperty(t,"CurveCurveMerge",{enumerable:!0,get:function(){return o.CurveCurveMerge}});var a=n(30384);Object.defineProperty(t,"GeometryMerge",{enumerable:!0,get:function(){return a.GeometryMerge}});var c=n(28041);Object.defineProperty(t,"CalculateProject",{enumerable:!0,get:function(){return c.CalculateProject}}),Object.defineProperty(t,"Project",{enumerable:!0,get:function(){return c.Project}});var l=n(46);Object.defineProperty(t,"CalculateOffset",{enumerable:!0,get:function(){return l.CalculateOffset}}),Object.defineProperty(t,"Offset",{enumerable:!0,get:function(){return l.Offset}});var d=n(16522);Object.defineProperty(t,"CalculateFit",{enumerable:!0,get:function(){return d.CalculateFit}}),Object.defineProperty(t,"Fit",{enumerable:!0,get:function(){return d.Fit}});var u=n(11652);Object.defineProperty(t,"CalculateOverlap",{enumerable:!0,get:function(){return u.CalculateOverlap}}),Object.defineProperty(t,"Overlap",{enumerable:!0,get:function(){return u.Overlap}});var h=n(47035);Object.defineProperty(t,"BoolOperate2d",{enumerable:!0,get:function(){return h.BoolOperate2d}});var g=n(45449);Object.defineProperty(t,"Bool2d",{enumerable:!0,get:function(){return g.Bool2d}}),Object.defineProperty(t,"Bool2dType",{enumerable:!0,get:function(){return g.Bool2dType}}),Object.defineProperty(t,"BoolType",{enumerable:!0,get:function(){return g.Bool2dType}});var f=n(20227);Object.defineProperty(t,"PolygonOffset",{enumerable:!0,get:function(){return f.PolygonOffset}});var p=n(1760);Object.defineProperty(t,"SearchGraph",{enumerable:!0,get:function(){return p.SearchGraph}});var _=n(70737);Object.defineProperty(t,"BoolOperateClipper",{enumerable:!0,get:function(){return _.BoolOperateClipper}});var m=n(99138);Object.defineProperty(t,"TopologyEdit",{enumerable:!0,get:function(){return m.TopologyEdit}});var v=n(49172);Object.defineProperty(t,"LoopArea",{enumerable:!0,get:function(){return v.LoopArea}});var E=n(58074);Object.defineProperty(t,"LoopCentroid",{enumerable:!0,get:function(){return E.LoopCentroid}});var P=n(46989);Object.defineProperty(t,"PositionJudge",{enumerable:!0,get:function(){return P.PositionJudge}});var y=n(18664);Object.defineProperty(t,"PointPolygonPositionJudger",{enumerable:!0,get:function(){return y.PointPolygonPositionJudger}});var C=n(90676);Object.defineProperty(t,"CurveCuvePositonType",{enumerable:!0,get:function(){return C.CurveCuvePositonType}}),Object.defineProperty(t,"PtLoopPositonType",{enumerable:!0,get:function(){return C.PtLoopPositonType}}),Object.defineProperty(t,"LoopLoopPositonType",{enumerable:!0,get:function(){return C.LoopLoopPositonType}});var S=n(85232);Object.defineProperty(t,"ILoopsToPolygonExes",{enumerable:!0,get:function(){return S.ILoopsToPolygonExes}});var T=n(42984);Object.defineProperty(t,"ClipMesh",{enumerable:!0,get:function(){return T.ClipMesh}});var b=n(62293);Object.defineProperty(t,"MeshUtil",{enumerable:!0,get:function(){return b.MeshUtil}});var w=n(17165);Object.defineProperty(t,"DiscreteUtil",{enumerable:!0,get:function(){return w.DiscreteUtil}});var x=n(23863);Object.defineProperty(t,"DiscreteTopology",{enumerable:!0,get:function(){return x.DiscreteTopology}});var M=n(76068);Object.defineProperty(t,"boxCutLine",{enumerable:!0,get:function(){return M.boxCutLine}}),Object.defineProperty(t,"boxToTrimmedSurfaces",{enumerable:!0,get:function(){return M.boxToTrimmedSurfaces}});var N=n(32334);Object.defineProperty(t,"GridDiscrete",{enumerable:!0,get:function(){return N.GridDiscrete}})},76068:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.boxCutLine=t.boxToTrimmedSurfaces=void 0;const r=n(67996),s=n(6688),i=n(61226),o=n(89494),a=n(75105),c=n(56973),l=n(43255);function d(e){const t=(e.max.x-e.min.x)/2,n=(e.max.y-e.min.y)/2,r=(e.max.z-e.min.z)/2,s=e.getCenter(),c=s.translated(i.Vector3.Z().multiplied(r)),d=new o.Coordinate3(c,i.Vector3.X(),i.Vector3.Y()),u=a.TrimmedSurface.createPlane(d,t,n),h=s.translated(i.Vector3.Z().multiplied(-r)),g=new o.Coordinate3(h,i.Vector3.X(),i.Vector3.Y().reversed()),f=a.TrimmedSurface.createPlane(g,t,n),p=s.translated(i.Vector3.X().multiplied(t)),_=new o.Coordinate3(p,i.Vector3.Y(),i.Vector3.Z()),m=a.TrimmedSurface.createPlane(_,n,r),v=s.translated(i.Vector3.X().multiplied(-t)),E=new o.Coordinate3(v,i.Vector3.Y().reversed(),i.Vector3.Z()),P=a.TrimmedSurface.createPlane(E,n,r),y=s.translated(i.Vector3.Y().multiplied(n)),C=new o.Coordinate3(y,i.Vector3.X().reversed(),i.Vector3.Z()),S=a.TrimmedSurface.createPlane(C,t,r),T=s.translated(i.Vector3.Y().multiplied(-n)),b=new o.Coordinate3(T,i.Vector3.X(),i.Vector3.Z()),w=[u,f,m,P,S,a.TrimmedSurface.createPlane(b,t,r)];if(e instanceof l.TiltBox3){const t=e.getCoord().getLocalToWorldMatrix();for(const e of w)e.transform(t)}return w}t.boxToTrimmedSurfaces=d,t.boxCutLine=function(e,t){const n=e.clone();if(n.setRange(-1e7,1e7),t instanceof l.TiltBox3){const e=t.getCoord().getWorldToLocalMatrix();n.transform(e)}const o=n.getDirection(),a=e=>{const t=e.getSurface(),r=e.getUVPolygon().getLoops()[0].getAllCurves(),a=new s.Interval(r[0].getStartPt().x,r[0].getEndPt().x),l=new s.Interval(r[1].getStartPt().y,r[1].getEndPt().y),d=new i.Vector3(n.getOrigin(),t.getOrigin());if(Math.abs(o.dot(t.getNorm()))<c.Tolerance.ANGLE_EPS)return;const u=d.dot(t.getNorm())/o.dot(t.getNorm()),h=n.getPtAt(u),g=t.getUVAt(h);return a.containsPoint(g.x,c.Tolerance.NUMBER_EPS)&&l.containsPoint(g.y,c.Tolerance.NUMBER_EPS)?u:void 0},u=[],h=d(new r.Box3([t.min,t.max]));for(const e of h){const t=a(e);void 0!==t&&u.push(t)}if(0===u.length)return;let g;g=1===u.length?new s.Interval(u[0]-c.Tolerance.LENGTH_EPS,u[0]+c.Tolerance.LENGTH_EPS):new s.Interval(u[0],u[1],!0);const f=e.getRange().intersected(g);return 0!==f.length?f[0]:void 0}},17980:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveCurveIntersect=void 0;const r=n(37543),s=n(32858),i=n(82954),o=n(52642),a=n(87222),c=n(97602),l=n(56973),d=n(31109),u=n(10909),h=n(9327),g=n(2237),f=n(56698),p=n(61226);class _{static curve2ds(e,t,n=l.Tolerance.DEFAULT){if(e instanceof s.Line2d){if(t instanceof s.Line2d)return r.LineLineIntersect.line2dAndLine2d(e,t,n);if(t instanceof u.Arc2d){const r=i.LinearCircularIntersect.line2dAndArc2d(e,t,n);return r.length>0?r:d.CurveCurveIntersectUtil.getEndPtIntersect(e,t,n)}}else if(e instanceof u.Arc2d){if(t instanceof s.Line2d){const r=i.LinearCircularIntersect.line2dAndArc2d(t,e,n),s=_._swapParams(r);return s.length>0?s:d.CurveCurveIntersectUtil.getEndPtIntersect(e,t,n)}if(t instanceof u.Arc2d){const r=o.CircularCircularIntersect.arc2dAndArc2d(e,t,n);return r.length>0?r:d.CurveCurveIntersectUtil.getEndPtIntersect(e,t,n)}}const a=f.CurveCurveOverlap.curve2ds(e,t,n);if(a.length>0){return a.map((r=>g.IntersectInfoUtil.curvesFromOverlap(r,e,t,n)))}return d.CurveCurveIntersectUtil.curve2dCurve2d(e,t,n)}static curve3ds(e,t,n=l.Tolerance.DEFAULT){return e instanceof h.ExtendCurve3d||t instanceof h.ExtendCurve3d?_._curve3dAndExtendCurve3d(e,t,n):_._curve3dsSimple(e,t,n)}static curve3dsNearPoint(e,t,n,r=l.Tolerance.DEFAULT){let s;return e.isLine3d()?s=t.isLine3d()||t.isArc3d()?this._byGeometricOrAnalyticMethod(e,t,r):t.isExtendCurve3d()&&t.getBaseCurve().isArc3d()?this._curve3dAndExtendCurve3d(e,t,r):void 0:t.isLine3d()&&(s=e.isLine3d()||e.isArc3d()?this._byGeometricOrAnalyticMethod(e,t,r):e.isExtendCurve3d()&&e.getBaseCurve().isArc3d()?this._curve3dAndExtendCurve3d(e,t,r):void 0),void 0!==s?(s.sort(((e,t)=>e.point.sqDistanceTo(n)-t.point.sqDistanceTo(n))),s[0]):d.CurveCurveIntersectUtil.curve3dsSingleIntersect(e,t,n,r)}static _curve3dsSimple(e,t,n=l.Tolerance.DEFAULT){const r=this._byGeometricOrAnalyticMethod(e,t,n);if(r){if(1===r.length&&!1===r[0].isOverlap&&e.getTangentAt(r[0].param1).isParallel(t.getTangentAt(r[0].param2),n.angleEps)){const s=n.lengthEps/100;if(e.getStartPt().equals(t.getStartPt(),s)){const s=e.getStartPt().midTo(t.getStartPt());if(s.equals(r[0].point,n.edgeLengthEps))return[{point:s,param1:e.getStartParam(),param2:t.getStartParam(),isOverlap:!1}]}else if(e.getStartPt().equals(t.getEndPt(),s)){const s=e.getStartPt().midTo(t.getEndPt());if(s.equals(r[0].point,n.edgeLengthEps))return[{point:s,param1:e.getStartParam(),param2:t.getEndParam(),isOverlap:!1}]}else if(e.getEndPt().equals(t.getEndPt(),s)){const s=e.getEndPt().midTo(t.getEndPt());if(s.equals(r[0].point,n.edgeLengthEps))return[{point:s,param1:e.getEndParam(),param2:t.getEndParam(),isOverlap:!1}]}else if(e.getEndPt().equals(t.getStartPt(),s)){const s=e.getEndPt().midTo(t.getStartPt());if(s.equals(r[0].point,n.edgeLengthEps))return[{point:s,param1:e.getEndParam(),param2:t.getStartParam(),isOverlap:!1}]}}return r}const s=f.CurveCurveOverlap.curve3ds(e,t,n);if(s.length>0){return s.map((r=>g.IntersectInfoUtil.curvesFromOverlap(r,e,t,n)))}return d.CurveCurveIntersectUtil.curve3dCurve3d(e,t,n)}static _byGeometricOrAnalyticMethod(e,t,n=l.Tolerance.DEFAULT){if(e instanceof a.Line3d){if(t instanceof a.Line3d)return r.LineLineIntersect.line3dAndLine3d(e,t,n);if(t instanceof c.Arc3d){const r=i.LinearCircularIntersect.line3dAndArc3d(e,t,n);return r.length>0?r:d.CurveCurveIntersectUtil.getEndPtIntersect(e,t,n)}}else if(e instanceof c.Arc3d){if(t instanceof a.Line3d){const r=i.LinearCircularIntersect.line3dAndArc3d(t,e,n),s=_._swapParams(r);return s.length>0?s:d.CurveCurveIntersectUtil.getEndPtIntersect(e,t,n)}if(t instanceof c.Arc3d){const r=o.CircularCircularIntersect.arc3dAndArc3d(e,t,n);return r.length>0?r:d.CurveCurveIntersectUtil.getEndPtIntersect(e,t,n)}}return this._isTwoPlaneCurve3dsCoplane(e,t,n)}static _isLineXPlaneCurve3d(e,t,n){let r;e.isLine3d()?r=e.getDirection():(r=e.getEndPt().subtracted(e.getStartPt()),r.equals(p.Vector3.O())&&(r=e.getEndPt().subtracted(e.getMidPt())),r.normalize());const s=t.isPlaneCurve3d();if(s instanceof p.Vector3){if(!s.isPerpendicular(r,n.angleEps))return;const i=t.getStartPt().subtracted(e.getStartPt());if(i.getSqLength()>n.lengthEps2){if(i.normalize(),Math.abs(i.dot(s))<n.angleEps)return;return[]}}}static _isTwoPlaneCurve3dsCoplane(e,t,n){const r=e.isPlaneCurve3d(),s=t.isPlaneCurve3d();if(r instanceof p.Vector3&&s instanceof p.Vector3){if(!r.isParallel(s,n.angleEps))return;const i=t.getStartPt().subtracted(e.getStartPt());if(i.getSqLength()>n.lengthEps2){if(i.normalize(),Math.abs(i.dot(r))<n.angleEps)return;return[]}}else{if(r&&s instanceof p.Vector3)return this._isLineXPlaneCurve3d(e,t,n);if(r instanceof p.Vector3&&s)return this._isLineXPlaneCurve3d(t,e,n)}}static _curve3dAndExtendCurve3d(e,t,n=l.Tolerance.DEFAULT){const r=[];e instanceof h.ExtendCurve3d?r.push(...e.toSimpleCurves()):r.push(e);const s=[];t instanceof h.ExtendCurve3d?s.push(...t.toSimpleCurves()):s.push(t);const i=(e,t)=>{for(const n of t)if(n.point.equals(e.point))return!0;return!1},o=[];for(const a of r)for(const r of s){const s=_._curve3dsSimple(a,r,n);for(const n of s)i(n,o)||(e.isExtendCurve3d()&&(n.param1=this._getOriginParamForExtendCurve(n.point,n.param1,a,e)),t.isExtendCurve3d()&&(n.param2=this._getOriginParamForExtendCurve(n.point,n.param2,r,t)),o.push(n))}return o}static _getOriginParamForExtendCurve(e,t,n,r){if(n.isLine()){const n=r.getBaseCurve().getRange();let s;if(t<-l.Tolerance.EDGE_LENGTH_EPS)s=!0;else if(t>l.Tolerance.EDGE_LENGTH_EPS)s=!1;else{s=e.sqDistanceTo(r.getPtAt(n.min))<e.sqDistanceTo(r.getPtAt(n.max))}if(s){const e=r.getHeadScale();return n.min+t/e}if(!s){const e=r.getTailScale();return n.max+t/e}}return t}static _swapParams(e){return e.forEach((e=>{[e.param1,e.param2]=[e.param2,e.param1],e.isOverlap&&([e.overlap1,e.overlap2]=[e.overlap2,e.overlap1])})),e}}t.CurveCurveIntersect=_},52642:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CircularCircularIntersect=void 0;const r=n(33218),s=n(49246),i=n(10909),o=n(5804),a=n(73337),c=n(82954),l=n(56973),d=n(56698),u=n(31109),h=n(74729),g=n(32858),f=n(6688),p=n(2237);t.CircularCircularIntersect=class{static arc2dAndArc2d(e,t,n=l.Tolerance.DEFAULT){const r=d.CurveCurveOverlap.arcs(e,t,n);if(r.length>0){return r.map((r=>p.IntersectInfoUtil.curvesFromOverlap(r,e,t,n)))}return e.isEqualAB()&&t.isEqualAB()?this._circle2dAndCircle2d(e,t,n.lengthEps):this._Ellipse2dAndEllipse2d(e,t,n)}static arc3dAndArc3d(e,t,n=l.Tolerance.DEFAULT){const r=d.CurveCurveOverlap.arcs(e,t,n);if(r.length>0){return r.map((r=>p.IntersectInfoUtil.curvesFromOverlap(r,e,t,n)))}const u=[],_=new o.Plane(e.getCenter(),e.getCoord().getDx(),e.getCoord().getDy()),m=new o.Plane(t.getCenter(),t.getCoord().getDx(),t.getCoord().getDy());if(_.getNorm().isParallel(m.getNorm(),n.angleEps)){const r=e.getCenter().subtract(t.getCenter()).dot(_.getNorm());if(!s.Util.isNearlyZero(r,n.lengthEps))return[];{const r=new i.Arc2d(h.Coordinate2.XOY(),e.getA(),e.getB(),!0,e.getRange().toArray()),s=e.getCoord(),o=t.getCoord(),a=new h.Coordinate2(s.getLocalPtAt(o.getOrigin()),s.getLocalVectorAt(o.getDx())),c=_.getNorm().dot(m.getNorm())>0,l=new i.Arc2d(a,t.getA(),t.getB(),c,t.getRange().toArray());let d;d=r.isEqualAB()&&l.isEqualAB()?this._circle2dAndCircle2d(r,l,n.lengthEps):this._Ellipse2dAndEllipse2d(r,l,n);for(const e of d)u.push({point:s.getWorldPtAt(e.point),param1:e.param1,param2:e.param2,isOverlap:!1})}}else{const r=a.SurfaceSurfaceIntersect.allIntersections(_,m);if(r.length<1||void 0===r[0].curve)return[];const s=new i.Arc2d(h.Coordinate2.XOY(),e.getA(),e.getB(),!0,e.getRange().toArray()),o=r[0].curve,d=e.getCoord().getLocalPtAt(o.getOrigin()),p=e.getCoord().getLocalVectorAt(o.getDirection()),v=new g.Line2d(d,p,f.Interval.infinitArray()),E=c.LinearCircularIntersect.line2dAndArc2d(v,s,l.Tolerance.DEFAULT),P=[];for(const t of E){const n=e.getCoord().getWorldPtAt(t.point);P.push({intersectPt:n,param:t.param2})}for(const e of P){const r=t.getParamAt(e.intersectPt);if(t.getPtAt(r).distanceTo(e.intersectPt)>n.lengthEps)continue;const s=n.lengthEps/(t.getA()+t.getB());t.getRange().containsPoint(r,s)&&u.push({point:e.intersectPt,param1:e.param,param2:r,isOverlap:!1})}}return u}static _Ellipse2dAndEllipse2d(e,t,n=l.Tolerance.DEFAULT){return u.CurveCurveIntersectUtil.curve2dCurve2d(e,t,n)}static _circle2dAndCircle2d(e,t,n=l.Tolerance.LENGTH_EPS){const i=e.getCenter(),o=t.getCenter(),a=(e.getA()+e.getB())/2,c=(t.getA()+t.getB())/2,d=o.subtracted(i),u=d.clone().normalize(),h=d.getLength(),g=a+c,f=Math.abs(a-c);if(d.isZero(n)){if(!s.Util.isNearlyEqual(a,c,n))return[];if(s.Util.isNearlyEqual(a,c,n)){const r=e.getParamAt(t.getStartPt());if(e.getRange().containsPoint(r,n))return[{point:t.getStartPt(),param1:r,param2:t.getRange().min,isOverlap:!1}];const s=e.getParamAt(t.getEndPt());if(e.getRange().containsPoint(s,n))return[{point:t.getEndPt(),param1:s,param2:t.getRange().max,isOverlap:!1}];const i=t.getParamAt(e.getStartPt());if(t.getRange().containsPoint(i,n))return[{point:e.getStartPt(),param1:e.getRange().min,param2:i,isOverlap:!1}];const o=t.getParamAt(e.getEndPt());return t.getRange().containsPoint(o,n)?[{point:e.getEndPt(),param1:e.getRange().max,param2:o,isOverlap:!1}]:[]}}if(h>g+n||h<f-n)return[];const p=[],_=Math.min(l.Tolerance.LENGTH_EPS,n);if(s.Util.isNearlyBiggerOrEqual(h,g,_)&&s.Util.isNearlyEqual(h,g,n)){const n=i.clone().add(u.multiply(a)),r=e.getParamAt(n),s=t.getParamAt(n);p.push({point:n,param1:r,param2:s,isOverlap:!1})}else if(s.Util.isNearlySmallerOrEqual(h,f,_)&&s.Util.isNearlyEqual(h,f,n)){let n;n=c>=a?i.add(u.multiply(-a)):o.add(u.multiply(c));const r=e.getParamAt(n),s=t.getParamAt(n);p.push({point:n,param1:r,param2:s,isOverlap:!1})}else{const s=new r.Vector2(-u.y,u.x),o=h*h+a*a-c*c,l=.5*o/h,d=.5*Math.sqrt(4*h*h*a*a-o*o)/h,g=i.clone().add(u.multiplied(l)).add(s.multiplied(d)),f=i.clone().add(u.multiplied(l)).add(s.multiplied(-d));if(g.equals(f,n)){const n=g.interpolate(f,.5);p.push({point:n,param1:e.getParamAt(n),param2:t.getParamAt(n),isOverlap:!1})}else{let n=e.getParamAt(g),r=t.getParamAt(g);p.push({point:g,param1:n,param2:r,isOverlap:!1}),n=e.getParamAt(f),r=t.getParamAt(f),p.push({point:f,param1:n,param2:r,isOverlap:!1})}}const m=n/e.getA(),v=n/t.getA();return p.filter((n=>e.getRange().containsPoint(n.param1,m)&&t.getRange().containsPoint(n.param2,v)))}}},37543:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LineLineIntersect=void 0;const r=n(56973),s=n(49246),i=n(56698),o=n(2237),a=n(77160);t.LineLineIntersect=class{static line2dAndLine2d(e,t,n=r.Tolerance.DEFAULT){const s=i.CurveCurveOverlap.lines(e,t,n);if(s.length>0){return s.map((r=>o.IntersectInfoUtil.curvesFromOverlap(r,e,t,n)))}const c=a.LineLineIntersectUtil.line2dsParamed(e.getOrigin(),t.getOrigin(),e.getDirection(),t.getDirection());if(!e.getRange().containsPoint(c[0],n.lengthEps)||!t.getRange().containsPoint(c[1],n.lengthEps))return[];return[{point:e.getPtAt(c[0]),param1:c[0],param2:c[1],isOverlap:!1}]}static line3dAndLine3d(e,t,n=r.Tolerance.DEFAULT){const a=i.CurveCurveOverlap.lines(e,t,n);if(a.length>0){return a.map((r=>o.IntersectInfoUtil.curvesFromOverlap(r,e,t,n)))}const c=e.getDirection(),l=t.getDirection(),d=c.cross(l),u=t.getOrigin().subtracted(e.getOrigin());if(!s.Util.isNearlyZero(u.dot(d),n.lengthEps))return[];const h=d.multiplied(-1),g=l.cross(u);let f=g.getLength()/h.getLength();h.dot(g)<0&&(f=-f);const p=e.getPtAt(f);return e.containsPoint(p,n.lengthEps)&&t.containsPoint(p,n.lengthEps)?[{point:p,param1:f,param2:t.getParamAt(p),isOverlap:!1}]:[]}}},77160:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LineLineIntersectUtil=void 0;const r=n(72564);t.LineLineIntersectUtil=class{static line2dsParamed(e,t,n,s){const i=[[n.x,-s.x],[n.y,-s.y]],o=[t.x-e.x,t.y-e.y];return r.solve(i,o)}}},82954:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LinearCircularIntersect=void 0;const r=n(60229),s=n(32858),i=n(10909),o=n(5804),a=n(49246),c=n(56973),l=n(86059),d=n(74729);t.LinearCircularIntersect=class{static line2dAndArc2d(e,t,n=c.Tolerance.DEFAULT){if(!t.isEqualAB())return this._line2dAndEllipse2d(e,t,n);const r=t.getCenter(),s=e.getParamAt(r),i=e.getPtAt(s),o=r.distanceTo(i),a=o*o,l=(t.getA()+t.getB())/2,d=n.lengthEps/t.getRadius();if(Math.abs(o-l)<c.Tolerance.LENGTH_EPS){const r=t.getParamAt(i);if(e.getRange().containsPoint(s,n.lengthEps)&&t.getRange().containsPoint(r,d)){return[{point:i,param1:s,param2:r,isOverlap:!1}]}return[]}if(o>l)return[];const u=n=>{const r=e.getPtAt(n),s=t.getParamAt(r);if(t.getRange().containsPoint(s,d)){return{point:r,param1:n,param2:s,isOverlap:!1}}},h=[],g=Math.sqrt(l*l-a),f=s-g;if(e.getRange().containsPoint(f)){const e=u(f);e&&h.push(e)}const p=s+g;if(e.getRange().containsPoint(p)){const e=u(p);e&&h.push(e)}return h}static line3dAndArc3d(e,t,n=c.Tolerance.DEFAULT){if(!t.isEqualAB())return this._line3dAndEllipse3d(e,t,n);const s=t.clone();s.setRange(0,r.CONST.PI2);const i=this.line3dAndCircle3d(e,s,n),o=n.lengthEps/t.getRadius(),a=i.filter((r=>e.getRange().containsPoint(r.param1,n.lengthEps)&&t.getRange().containsPoint(r.param2,o)));for(const e of a)e.param2=t.getRange().getRegularParam(e.param2);return a}static line3dAndCircle3d(e,t,n=c.Tolerance.DEFAULT){const r=new o.Plane(t.getCoord()),s=t.getNormal().dot(e.getDirection()),i=r.getProjectedPtBy(e.getOrigin()).distanceTo(e.getOrigin());if(a.Util.isNearlyZero(s,n.lengthEps)&&!a.Util.isNearlyZero(i,n.lengthEps))return[];if(!a.Util.isNearlyZero(s,n.lengthEps)){const o=(e.getOrigin().subtracted(r.getOrigin()).dot(r.getNorm())<0?1:-1)*i/s,a=e.getPtAt(o);if(t.containsPoint(a,n.lengthEps)){return[{point:a,param1:o,param2:t.getParamAt(a),isOverlap:!1}]}return[]}const l=[],d=e.getDirection().dot(e.getDirection()),u=e.getOrigin().subtracted(t.getCenter()),h=2*e.getDirection().dot(u),g=u.dot(u)-t.getRadius()*t.getRadius(),f=h*h-4*d*g;if(a.Util.isNearlyZero(f)){const n=-1*h/(2*d),r=e.getPtAt(n),s=t.getParamAt(r);l.push({point:r,param1:n,param2:s,isOverlap:!1})}else{if(f<0)return l;{let n=(-1*h+Math.sqrt(h*h-4*d*g))/(2*d);const r=e.getPtAt(n);let s=t.getParamAt(r);l.push({point:r,param1:n,param2:s,isOverlap:!1}),n=(-1*h-Math.sqrt(h*h-4*d*g))/(2*d);const i=e.getPtAt(n);s=t.getParamAt(i),l.push({point:i,param1:n,param2:s,isOverlap:!1})}}return l}static _line2dAndEllipse2d(e,t,n){const i=t.getCenter();if(e.containsPoint(i)){const n=n=>{const r=t.getPtAt(n),s=e.getParamAt(r);if(e.getRange().containsPoint(s)){return{point:r,param1:s,param2:n,isOverlap:!1}}},s=t.getCoord().getDx().angleTo(e.getDirection()),i=Math.atan2(Math.sin(s)/t.getB(),Math.cos(s)/t.getA());let o=t.isCCW()?i:r.CONST.PI2-i;o=t.getRange().getRegularParam(o);const a=[];if(t.getRange().containsPoint(o)){const e=n(o);e&&a.push(e)}const c=o+r.CONST.PI;if(t.getRange().containsPoint(c)){const e=n(c);e&&a.push(e)}return a}const o=t.getCoord(),a=e.getOrigin(),c=e.getDirection(),d=new s.Line2d(o.getLocalPtAt(a),o.getLocalVectorAt(c),e.getRange().toArray()),u=d.getOrigin(),h=d.getDirection(),g=t.getA()*t.getA(),f=t.getB()*t.getB(),p=h.x*h.x*f+h.y*h.y*g,_=2*h.x*u.x*f+2*h.y*u.y*g,m=u.x*u.x*f+u.y*u.y*g-g*f;let v=l.QuadraticEquation.solve(p,_,m);if(v.length<1)return[];if(v=v.filter((e=>d.getRange().containsPoint(e))),v.length<1)return[];const E=[];for(const e of v){const n=d.getPtAt(e),r=o.getWorldPtAt(n),s=t.getParamAt(r);if(!t.getRange().containsPoint(s))continue;const i={point:r,param1:e,param2:s,isOverlap:!1};E.push(i)}if(E.length>1){const r=E[0],s=e.getPtAt(r.param1),i=E[1],o=e.getPtAt(i.param1);if(o.sqDistanceTo(s)<n.lengthEps*n.lengthEps){const a=t.getTangentAt(r.param2),c=t.getTangentAt(i.param2);if(a.isSameDirection(c,n.angleEps)){const t=(r.param2+i.param2)/2,n=o.midTo(s);return[{point:n,param1:e.getParamAt(n),param2:t,isOverlap:!1}]}}}return E}static _line3dAndEllipse3d(e,t,n){const r=t.getCoord(),o=new s.Line2d(r.getLocalPtAt(e.getOrigin()),r.getLocalVectorAt(e.getDirection()),e.getRange().toArray()),a=[],c=new i.Arc2d(d.Coordinate2.XOY(),t.getA(),t.getB(),!0,t.getRange().toArray()),l=this._line2dAndEllipse2d(o,c,n);for(const t of l){const s=r.getWorldPtAt(t.point);e.containsPoint(s,n.lengthEps)&&a.push({point:s,param1:e.getParamAt(s),param2:t.param2,isOverlap:!1})}for(const e of a)e.param2=t.getRange().getRegularParam(e.param2);return a}}},31109:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveCurveIntersectUtil=void 0;const r=n(56973),s=n(68990),i=n(81658),o=n(61226),a=n(60229),c=n(53487),l=n(57249),d=n(11042),u=n(46891),h=n(90361),g=n(67996),f=n(33218),p=n(32858),_=n(68238),m=n(26773);t.CurveCurveIntersectUtil=class{static curve2dCurve2d(e,t,n=r.Tolerance.DEFAULT){if(!e||!t)return[];const s=e.getBoundingBox(),o=t.getBoundingBox();if(!s.intersectsBox(o,n.lengthEps))return[];const a=new i.Curve2dSegment(e);a.range=e.getRange(),a.depth=0;const c=new i.Curve2dSegment(t);c.range=t.getRange(),c.depth=0;const l=[],d=[];l.push(a),d.push(c);const u=[],h=new i.Curve2dSegmentPair(a,c);u.push(h);const g=this.getEndPtIntersect(e,t,n);return this._dealSingularityIntersect(e,t,g,n),this._calCurve2dSegmentsIntersect(l,d,u,g,n),g}static curve3dCurve3d(e,t,n=r.Tolerance.DEFAULT){if(!e||!t)return[];const s=e.getBoundingBox(),o=t.getBoundingBox();if(!s.intersectsBox(o,n.lengthEps))return[];let a,c;e.isNurbsCurve3d()&&e.getControlPoints().length<10?(a=e.clone(),a.knotRefinement()):a=e,t.isNurbsCurve3d()&&t.getControlPoints().length<10?(c=t.clone(),c.knotRefinement()):c=t;const l=new i.Curve3dSegment(a);l.range=a.getRange(),l.depth=0;const d=new i.Curve3dSegment(c);d.range=c.getRange(),d.depth=0;const u=[],h=[];u.push(l),h.push(d);const g=[],f=new i.Curve3dSegmentPair(l,d);g.push(f);const p=this.getEndPtIntersect(a,c,n);return this._dealSingularityIntersect(a,c,p,n),this._calCurve3dSegmentsIntersect(u,h,g,p,n),p}static curve2dsSingleIntersect(e,t,n,s=r.Tolerance.DEFAULT){const o=new i.Curve2dSegment(e),a=new i.Curve2dSegment(t);o.range=e.getRange(),a.range=t.getRange();const c=new i.Curve2dSegmentPair(o,a),l=this._calCurveSegmentPairIntersect(c,s,n);return l||this._getNearestSingularityIntersect(e,t,n)}static curve3dsSingleIntersect(e,t,n,s=r.Tolerance.DEFAULT){const o=new i.Curve3dSegment(e),a=new i.Curve3dSegment(t);o.range=e.getRange(),a.range=t.getRange();const c=new i.Curve3dSegmentPair(o,a),l=this._calCurveSegmentPairIntersect(c,s,n);return l||this._getNearestSingularityIntersect(e,t,n)}static getEndPtIntersect(e,t,n){const r=[],s=[e.getStartPt(),e.getEndPt()];for(let i=0;i<s.length;i++){if(this._isRedundantPt(s[i],r,n))continue;const o=t.getParamAt(s[i]);if(t.getPtAt(o).sqDistanceTo(s[i])<n.lengthEps2&&t.getRange().containsPoint(o,n.lengthEps)){const t={point:s[i],param1:0===i?e.getStartParam():e.getEndParam(),param2:o,isOverlap:!1};r.push(t)}}const i=[t.getStartPt(),t.getEndPt()];for(let s=0;s<i.length;s++){if(this._isRedundantPt(i[s],r,n))continue;const o=e.getParamAt(i[s]);if(e.getPtAt(o).sqDistanceTo(i[s])<n.lengthEps2&&e.getRange().containsPoint(o,n.lengthEps)){const e={point:i[s],param1:o,param2:0===s?t.getStartParam():t.getEndParam(),isOverlap:!1};r.push(e)}}return r}static _getNearestSingularityIntersect(e,t,n,s=r.Tolerance.DEFAULT){const i=this._dealSingularityIntersect(e,t,[],s);if(0===i.length)return;let a=i[0];if(n instanceof o.Vector3){let e=a.point.sqDistanceTo(n);for(let t=1;t<i.length;t++){const r=i[t].point.sqDistanceTo(n);r<e&&(e=r,a=i[t])}}else{const r=e.getPtAt(n[0]),s=t.getPtAt(n[1]);let o=r.sqDistanceTo(a.point)+s.sqDistanceTo(a.point);for(let e=1;e<i.length;e++){const t=i[e].point,n=t.sqDistanceTo(r)+t.sqDistanceTo(s);n<o&&(o=n,a=i[e])}}return a}static _calCurve2dSegmentsIntersect(e,t,n,s,o=r.Tolerance.DEFAULT){let c=[],l=0;for(;l<a.CONST.MAX_SUBDEVIDE_DEPTH;){for(const t of e){const e=[],n=new i.Curve2dSegment(t.curve),r=new i.Curve2dSegment(t.curve);e.push(n),e.push(r),i.CurveSegment.subdivideCurveSegment(t,e)}for(const e of t){const t=[],n=new i.Curve2dSegment(e.curve),r=new i.Curve2dSegment(e.curve);t.push(n),t.push(r),i.CurveSegment.subdivideCurveSegment(e,t)}if(!i.CurveSegmentPair.combineCurveSegmentPairs(n,c))break;if(this._FilterCurvSegmentPairs(c,o.lengthEps),0===c.length){n.splice(0);break}i.Curve3dSegmentPair.refreshCurveSegments(c,e,t),n.splice(0),n.push(...c),c=[],l++}for(const e of n){const t=this._calCurveSegmentPairIntersect(e,o);t&&!this._dealRedundantIntersect(e,t,s,o)&&s.push(t)}}static _calCurve3dSegmentsIntersect(e,t,n,s,o=r.Tolerance.DEFAULT){let c=[],l=0;for(;l<a.CONST.MAX_SUBDEVIDE_DEPTH;){for(const t of e){const e=[],n=new i.Curve3dSegment(t.curve),r=new i.Curve3dSegment(t.curve);e.push(n),e.push(r),i.CurveSegment.subdivideCurveSegment(t,e)}for(const e of t){const t=[],n=new i.Curve3dSegment(e.curve),r=new i.Curve3dSegment(e.curve);t.push(n),t.push(r),i.CurveSegment.subdivideCurveSegment(e,t)}if(!i.CurveSegmentPair.combineCurveSegmentPairs(n,c))break;if(this._FilterCurvSegmentPairs(c,o.lengthEps),0===c.length){n.splice(0);break}i.Curve3dSegmentPair.refreshCurveSegments(c,e,t),n.splice(0),n.push(...c),c=[],l++}for(const e of n){const t=this._calCurveSegmentPairIntersect(e,o);t&&!this._dealRedundantIntersect(e,t,s,o)&&s.push(t)}}static _dealSingularityIntersect(e,t,n,s=r.Tolerance.DEFAULT){const i=s.lengthEps*s.lengthEps*.01,o=[],a=(e,t,r)=>{let a=[];(e instanceof c.OffsetCurve3d||e instanceof l.OffsetCurve2d)&&(a=e.getSingularities());for(const c of a){const a=e.getPtAt(c);if(this._isRedundantPt(a,n,s))continue;const l=r.getParamAt(a);r.getPtAt(l).sqDistanceTo(a)<i&&r.getRange().containsPoint(l,s.lengthEps)&&(t?o.push({point:a,param1:c,param2:l,isOverlap:!1}):o.push({point:a,param1:l,param2:c,isOverlap:!1}))}};return a(e,!0,t),a(t,!1,e),o}static _isRedundantPt(e,t,n){for(const r of t)if(e.equals(r.point,n.lengthEps))return!0;return!1}static _dealRedundantIntersect(e,t,n,s=r.Tolerance.DEFAULT){const i=100*s.angleEps;for(let o=0;o<n.length;o++){const c=e.segment1.curve,l=e.segment2.curve,d=t.point.sqDistanceTo(n[o].point);if(d<=s.lengthEps2){const e=c.getPtAt(n[o].param1).sqDistanceTo(l.getPtAt(n[o].param2));return c.getPtAt(t.param1).sqDistanceTo(l.getPtAt(t.param2))<e&&n.splice(o,1,t),!0}if(d<=s.edgeLengthEps2){const e=c.getPtAt(n[o].param1).sqDistanceTo(l.getPtAt(n[o].param2)),s=c.getPtAt(t.param1).sqDistanceTo(l.getPtAt(t.param2)),d=Math.sqrt(Math.min(e,s));if(d>r.Tolerance.PROCESS_LENGTH_EPS/100){const i=Math.min(d/10,r.Tolerance.PROCESS_LENGTH_EPS),u=t.point.midTo(n[o].point),h=c.getFootByIterate(u,t.param1,i),g=l.getFootByIterate(u,t.param2,i),f=void 0!==h&&void 0!==g?c.getPtAt(h).sqDistanceTo(l.getPtAt(g)):a.CONST.MODEL_MAX_LENGTH;if(f<e&&f<s){const e={point:c.getPtAt(h),param1:h,param2:g,isOverlap:!1};return n.splice(o,1,e),!0}}const u=e=>{const t=c.getTangentAt(e.param1,!0),n=c.getTangentAt(e.param1,!1),r=l.getTangentAt(e.param2,!0),s=l.getTangentAt(e.param2,!1);return t.isParallel(r,i)||t.isParallel(s,i)||n.isParallel(r,i)||n.isParallel(s,i)};if(e>r.Tolerance.CALCULATE_EPS2&&s<e){if(u(t))return n.splice(o,1,t),!0}else if(u(n[o]))return!0}}return!1}static _FilterCurvSegmentPairs(e,t=r.Tolerance.LENGTH_EPS){for(let n=0;n<e.length;n++){const r=e[n],s=r.segment1,i=r.segment2,o=s.getSegBox(),a=i.getSegBox();if(o instanceof h.Box2&&a instanceof h.Box2)o.intersectsBox(a,t)||(e.splice(n,1),n--);else{if(!(o instanceof g.Box3&&a instanceof g.Box3))throw new Error("curve求交：curve3d和curve2d混合搭配!");o.intersectsBox(a,t)||(e.splice(n,1),n--)}}}static _calCurveSegmentPairIntersect(e,t=r.Tolerance.DEFAULT,n){const i=e.segment1,o=e.segment2,a=i.curve,c=o.curve;let l;if(n)n instanceof u.Vector?(l=[a.getParamAt(n),c.getParamAt(n)],l[0]=a.getDomain().clamp(l[0]),l[1]=c.getDomain().clamp(l[1])):l=n;else if(a instanceof s.Curve2d&&c instanceof s.Curve2d){const e=a.getPtAt(i.range.min),n=a.getPtAt(i.range.max),r=c.getPtAt(o.range.min),s=c.getPtAt(o.range.max),d=new p.Line2d(e,n),u=new p.Line2d(r,s),h=new f.Vector2,g=new f.Vector2;if(_.CalculateDistance.curve2dToCurve2d(d,u,h,g)<100*t.lengthEps){const e=a.getParamAt(h),t=c.getParamAt(g);l=[e,t],l[0]=a.getDomain().clamp(l[0]),l[1]=c.getDomain().clamp(l[1])}else l=[i.range.getMid(),o.range.getMid()],a.isLine2d()&&(l[0]=a.getParamAt(o.getSegBox().getCenter())),c.isLine2d()&&(l[1]=c.getParamAt(i.getSegBox().getCenter()))}else l=[i.range.getMid(),o.range.getMid()],a.isLine3d()&&(l[0]=a.getParamAt(o.getSegBox().getCenter())),c.isLine3d()&&(l[1]=c.getParamAt(i.getSegBox().getCenter()));if(!d.curveCurveIteration(i.curve,o.curve,l,t))return;if(i.curve.getRange().containsPoint(l[0],t.lengthEps)&&o.curve.getRange().containsPoint(l[1],t.lengthEps)){const e=i.curve.getPtAt(l[0]),n=i.curve.getRange();n instanceof m.PeriodInterval&&(l[0]=n.getRegularParam(l[0],t.lengthEps));const r=o.curve.getRange();r instanceof m.PeriodInterval&&(l[1]=r.getRegularParam(l[1],t.lengthEps));return{point:e,param1:l[0],param2:l[1],isOverlap:!1}}const h=i.curve.getDerivatives(l[0],1)[1],g=o.curve.getDerivatives(l[1],1)[1];if(!h.isParallel(g,100*t.angleEps))return;const v=h.getLength(),E=g.getLength(),P=Math.sign(h.dot(g));function y(e,n){let r,s,a,c,d;n?(r=o,s=i,a=l[1],c=l[0],d=E/v*P):(r=i,s=o,a=l[0],c=l[1],d=v/E*P);const u=c+(e-a)*d;if(!s.range.containsPoint(u))return;const h=r.curve.getPtAt(e),g=s.curve.getPtAt(u);return h.sqDistanceTo(g)<t.lengthEps*t.lengthEps?{point:h.add(g).multiply(.5),param1:n?u:e,param2:n?e:u,isOverlap:!1}:void 0}return l[0]<i.range.min?y(i.range.min,!1):l[0]>i.range.max?y(i.range.max,!1):l[1]<o.range.min?y(o.range.min,!0):l[1]>i.range.max?y(o.range.max,!0):void 0}}},36737:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveSelfIntersect=void 0;const r=n(56973),s=n(24533),i=n(9327),o=n(17980),a=n(37543),c=n(87222),l=n(32858),d=n(11042),u=n(26773);class h{static isCurve2dSelfIntersect(e,t=r.Tolerance.DEFAULT){if(e.isLine2d()||e.isArc2d())return!1;return h.curve2dSelfIntersect(e,t).length>0}static curve2dSelfIntersect(e,t=r.Tolerance.DEFAULT){return e instanceof s.ExtendCurve2d?h._selfIntersectExtendCurve2d(e,t):h._selfIntersectSimple(e,t)}static curve3dSelfIntersect(e,t=r.Tolerance.DEFAULT){return e instanceof i.ExtendCurve3d?h._selfIntersectExtendCurve3d(e,t):h._selfIntersectSimple(e,t)}static _selfIntersectExtendCurve2d(e,t){const n=e.toSimpleCurves(),r=[];for(let s=0;s<n.length;s++)for(let i=s;i<n.length;i++){let a;if(s===i)a=h._selfIntersectSimple(n[s],t);else{a=o.CurveCurveIntersect.curve2ds(n[s],n[i],t);const r=e.getBaseCurve().getRange();for(const t of a)0===s?t.param1=r.min+t.param1/e.getHeadScale():2===s&&(t.param1=r.max+t.param1/e.getTailScale()),0===i?t.param2=r.min+t.param2/e.getHeadScale():2===i&&(t.param2=r.max+t.param2/e.getTailScale());a=a.filter((e=>Math.abs(e.param1-e.param2)>t.numberEps))}for(const n of a)this._dealRedundant(e,n,r,t)}return r}static _selfIntersectExtendCurve3d(e,t){const n=e.toSimpleCurves(),r=[];for(let s=0;s<n.length;s++)for(let i=s;i<n.length;i++){let a;if(s===i)a=h._selfIntersectSimple(n[s],t);else{a=o.CurveCurveIntersect.curve3ds(n[s],n[i],t);const r=e.getBaseCurve().getRange();for(const t of a)0===s?t.param1=r.min+t.param1/e.getHeadScale():2===s&&(t.param1=r.max+t.param1/e.getTailScale()),0===i?t.param2=r.min+t.param2/e.getHeadScale():2===i&&(t.param2=r.max+t.param2/e.getTailScale());a=a.filter((e=>Math.abs(e.param1-e.param2)>t.numberEps))}for(const n of a)this._dealRedundant(e,n,r,t)}return r}static _dealRedundant(e,t,n,r){let s=!1;const i=e.getPtAt(t.param1).sqDistanceTo(e.getPtAt(t.param2));for(const o of n)if(o.point.sqDistanceTo(t.point)<r.lengthEps2){s=!0;e.getPtAt(o.param1).sqDistanceTo(e.getPtAt(o.param2))<i&&(t.point=o.point,t.param1=o.param1,t.param2=o.param2);break}s||n.push(t)}static _selfIntersectSimple(e,t){if(e.isLine()||e.isArc())return[];if(e.isNurbsCurve3d()&&!this._isNurbs3dCtrlPtsIsIntersect(e,t)||e.isNurbsCurve2d()&&!this._isNurbs2dCtrlPtsIsIntersect(e,t))return[];const n=[],r=e.getRange(),s=r.min,i=r.getLength()/15;for(let o=0;o<15;o++){const a=s+o*i;for(let c=15;c>o;c--){const o=[a,s+c*i];if(d.curveCurveIteration(e,e,o,t)){if(r instanceof u.PeriodInterval){o[1]=r.clamp(o[1]),o[1]=r.clamp(o[1]);const e=r.period;if(Math.abs(Math.abs(o[1]-o[0])-e)<t.numberEps)continue}if(Math.abs(o[1]-o[0])<t.numberEps||!r.containsPoint(o[0],t.numberEps)||!r.containsPoint(o[1],t.numberEps))continue;const s={point:e.getPtAt(o[0]),param1:o[0],param2:o[1],isOverlap:!1};this._dealRedundant(e,s,n,t)}}}return n}static _isNurbs3dCtrlPtsIsIntersect(e,t){const n=e.getControlPoints();for(let e=1;e<n.length;e++){const r=new c.Line3d(n[e],n[e-1]);for(let s=e+1;s<n.length;s++){const e=new c.Line3d(n[s],n[s-1]);if(a.LineLineIntersect.line3dAndLine3d(r,e,t).length>0)return!0}}return!1}static _isNurbs2dCtrlPtsIsIntersect(e,t){const n=e.getControlPoints();for(let e=1;e<n.length;e++){const r=new l.Line2d(n[e],n[e-1]);for(let s=e+1;s<n.length;s++){const e=new l.Line2d(n[s],n[s-1]);if(a.LineLineIntersect.line2dAndLine2d(r,e,t).length>0)return!0}}return!1}}t.CurveSelfIntersect=h},19516:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveSurfaceIntersect=void 0;const r=n(61226),s=n(87222),i=n(5804),o=n(49246),a=n(97602),c=n(73337),l=n(56973),d=n(95618),u=n(47423),h=n(60229),g=n(9327),f=n(6688),p=n(17980),_=n(2648),m=n(44757),v=n(89494),E=n(33218),P=n(46182),y=n(34410),C=n(46989),S=n(90676);t.CurveSurfaceIntersect=class{static execute(e,t,n=l.Tolerance.DEFAULT,r){let s=this._preciseMethod(e,t,n);if(s)return r&&(s=s.filter((e=>r[0].containsPoint(e.surfaceUV.x,n.numberEps)&&r[1].containsPoint(e.surfaceUV.y,n.numberEps)))),s;if(_.CurveSurfaceCoincide.execute(e,t,n)){const n=e.getStartPt();return[{point:n,curveT:e.getStartParam(),surfaceUV:t.getUVAt(n),overlapRange:e.getRange()}]}return this._complexMethod(e,t,n,r)}static allPoints(e,t,n=l.Tolerance.DEFAULT,r){let s=this._preciseMethod(e,t,n);if(s)return r&&(s=s.filter((e=>r[0].containsPoint(e.surfaceUV.x,n.numberEps)&&r[1].containsPoint(e.surfaceUV.y,n.numberEps)))),s.map((e=>e.point));if(_.CurveSurfaceCoincide.execute(e,t,n))return[];return this._complexMethod(e,t,n,r).map((e=>e.point))}static hasIntersect(e,t,n,r=l.Tolerance.DEFAULT){const s=this._preciseMethod(e,t,r);if(s){if(void 0===n)return s.length>0;for(const e of s){if(C.PositionJudge.ptToPolygon(new E.Vector2(e.surfaceUV),n,r.lengthEps)!==S.PtLoopPositonType.OUT)return!0}return!1}if(void 0===n){return new d.CurveSurfaceIntersectUtil(e,t,r).hasIntersect(n)}const i=e=>{const n=t.getDomainU(),r=t.getDomainV();return n.set(e.min.x,e.max.x),r.set(e.min.y,e.max.y),[n,r]},o=(e=>{if(e.getLoops().length>1)return[];for(const t of e.getAllCurves()){if(t.isLine2d()||t.isNurbsCurve2d()&&t.isLineLike()){const e=t.getStartTangent();if(e.isPerpendicular(E.Vector2.X(),r.angleEps)||e.isPerpendicular(E.Vector2.Y(),r.angleEps))continue;return[]}return[]}const t=n.getBoundingBox();return i(t)})(n);if(o.length>0){return new d.CurveSurfaceIntersectUtil(e,t,r).hasIntersect(o)}const a=n.getBoundingBox(),c=i(a),u=this._complexMethod(e,t,r,c);for(const e of u){if(C.PositionJudge.ptToPolygon(new E.Vector2(e.surfaceUV),n,r.lengthEps)!==S.PtLoopPositonType.OUT)return!0}return!1}static nearPoint(e,t,n,s=l.Tolerance.DEFAULT){const i=n instanceof r.Vector3?n:n.point;let o,a=h.CONST.MAX_INTEGER;const c=this._preciseMethod(e,t,s);if(c){for(const e of c){const t=i.sqDistanceTo(e.point);t<a&&(o=e,a=t)}return o}const f=e instanceof g.ExtendCurve3d?e.toSimpleCurves():[e],p=t instanceof u.SweepSurface?t.toSimpleSurfacePatchs():[{surface:t}];for(const e of f)for(const t of p){const r=this._preciseMethod(e,t.surface,s,t.rangeUV);if(r){for(const e of r){const t=i.sqDistanceTo(e.point);t<a&&(o=e,a=t)}continue}const c=new d.CurveSurfaceIntersectUtil(e,t.surface,s).calSingleIntersect(n,t.rangeUV);if(c){const e=i.sqDistanceTo(c.point);e<a&&(o=c,a=e)}}return o}static nearParam(e,t,n,r,s=l.Tolerance.DEFAULT){const i=e.getPtAt(n).midTo(t.getPtAt(r));let o,a=h.CONST.MAX_INTEGER;const c=this._preciseMethod(e,t,s);if(c){for(const e of c){const t=i.sqDistanceTo(e.point);t<a&&(o=e,a=t)}return o}const u={point:i,curveT:n,uvPara:r};return new d.CurveSurfaceIntersectUtil(e,t,s).calSingleIntersect(u)}static _complexMethod(e,t,n,s){const i=e instanceof g.ExtendCurve3d?e.toSimpleCurves():[e],o=[];t instanceof u.SweepSurface?o.push(...t.toSimpleSurfacePatchs(s)):o.push({surface:t,rangeUV:s});const a=this._getCurveEndPtIntersects(e,t,n,s);for(const s of i)for(const i of o){const o=this._preciseMethod(s,i.surface,n,i.rangeUV);if(o){for(const r of o)d.CurveSurfaceIntersectUtil.dealRedundantIntersect(e,t,r,a,n),r.surfaceUV=t.getUVAt(r.point);continue}const c=this._getSurfaceLocalCoord(i.surface);if(!c||c.getDz().isParallel(r.Vector3.X())||c.getDz().isParallel(r.Vector3.Y())||c.getDz().isParallel(r.Vector3.Z())){new d.CurveSurfaceIntersectUtil(e,i.surface,n).calAllIntersects(i.rangeUV).map((r=>d.CurveSurfaceIntersectUtil.dealRedundantIntersect(e,t,r,a,n)));continue}const l=c.getWorldToLocalMatrix(),u=i.surface.transformed(l),h=e.transformed(l),g=new d.CurveSurfaceIntersectUtil(h,u,n).calAllIntersects(i.rangeUV);for(const e of g)e.point=c.getWorldPtAt(e.point);g.map((r=>d.CurveSurfaceIntersectUtil.dealRedundantIntersect(e,t,r,a,n)))}return a}static _getSurfaceLocalCoord(e){if(e instanceof P.CoordinateBasedSurface)return e.getCoord();if(e.isSweepSurface()){let t;const n=e.getPath();if(n.isLine3d()){const r=n.getDirection(),s=e.getPathDz(),i=s.cross(r),o=n.getOrigin();t=new v.Coordinate3(o,i,s)}else if(n.isArc3d())t=n.getCoord().clone();else if((n.isExtendCurve3d()||n.isOffsetCurve3d())&&n.getBaseCurve().isArc3d()){t=n.getBaseCurve().getCoord().clone()}else{const e=y.CurveUtil.getDzByCurve(n);t=new v.Coordinate3(n.getMidPt(),e)}return t}}static _getCurveEndPtIntersects(e,t,n,r){const s=[],i=[];if(i.push({pt:e.getStartPt(),param:e.getStartParam()}),e instanceof g.ExtendCurve3d){const t=e.getBaseCurve();i.push({pt:t.getStartPt(),param:t.getStartParam()}),i.push({pt:t.getEndPt(),param:t.getEndParam()})}i.push({pt:e.getEndPt(),param:e.getEndParam()});for(const o of i){const i=t.getUVAt(o.pt);if((!r||r[0].containsPoint(i.x,n.numberEps)&&r[1].containsPoint(i.y,n.numberEps))&&t.getPtAt(i).sqDistanceTo(o.pt)<n.lengthEps2){const n={point:o.pt,curveT:o.param,surfaceUV:i};d.CurveSurfaceIntersectUtil.dealRedundantIntersect(e,t,n,s)}}return s}static _preciseMethod(e,t,n=l.Tolerance.DEFAULT,r){let s=[];if(e.isLine3d()){const r=e;if(t.isPlane()){const e=t;s=this._line3dPlane(r,e,n)}else if(t.isCylinder()){const e=t;s=this._line3dCylinder(r,e,n)}else if(t.isCone()){const e=t;s=this._line3dCone(r,e,n)}else if(t.isSphere()){const e=t;s=this._line3dSphere(r,e,n)}else{if(!t.isSweepSurface())return;{const e=t,i=this._line3dSweepSurface(r,e,n);if(!i)return;s=i}}}else{if(!(e instanceof a.Arc3d&&t.isPlane()))return;s=this._circle3dPlane(e,t,n).filter((t=>e.getRange().containsPoint(t.curveT)))}if(r){return s.filter((e=>r[0].containsPoint(e.surfaceUV.x)&&r[1].containsPoint(e.surfaceUV.y)))}return s}static _line3dPlane(e,t,n){const s=e.getDirection();if(o.Util.isNearlyZero(s.dot(t.getNorm())))return[];const i=new r.Vector3(e.getOrigin(),t.getOrigin()).dot(t.getNorm())/s.dot(t.getNorm());if(!e.getRange().containsPoint(i))return[];const a=e.getPtAt(i);return[{point:a,curveT:e.getParamAt(a),surfaceUV:t.getUVAt(a)}]}static _circle3dPlane(e,t,n){const r=new i.Plane(e.getCoord()),s=c.SurfaceSurfaceIntersect.allIntersections(t,r);if(0===s.length)return[];const o=[],a=s[0].curve,l=p.CurveCurveIntersect.curve3ds(e,a);for(const e of l){const n={point:e.point,curveT:e.param1,surfaceUV:t.getUVAt(e.point)};o.push(n)}return o}static _line3dCylinder(e,t,n){const r=t.getCoord(),s=t.getA(),i=t.getB(),o=r.getLocalToWorldMatrix(),a=o.inversed();if(!a)return m.MathAssert.warn("transform matrix error!"),[];const c=e.clone().transform(a),l=c.getDirection(),d=c.getOrigin(),u=s*s,h=i*i,g=h*l.x*l.x+u*l.y*l.y,f=2*(h*l.x*d.x+u*l.y*d.y),p=h*d.x*d.x+u*d.y*d.y-u*h,_=[];if(g<n.lengthEps){if(Math.abs(p)<n.lengthEps){const n=e.getStartPt(),r={point:n,curveT:e.getStartParam(),surfaceUV:t.getUVAt(n),overlapRange:e.getRange()};return _.push(r),_}return[]}const v=n.lengthEps*n.lengthEps,E=f*f-4*g*p,P=(Math.abs(g*p)+f*f)/2;if(E/P>v){const e=[NaN,NaN];e[0]=(-f+Math.sqrt(E))/(2*g),e[1]=(-f-Math.sqrt(E))/(2*g);const r=(s+i)/2;if(Math.abs(e[0]-e[1])/r<n.numberEps){const e=-f/(2*g);if(c.getRange().containsPoint(e)){const n=c.getPtAt(e).transformed(o),r={point:n,curveT:e,surfaceUV:t.getUVAt(n)};return _.push(r),_}}if(c.getRange().containsPoint(e[0])){const n=c.getPtAt(e[0]).transformed(o),r={point:n,curveT:e[0],surfaceUV:t.getUVAt(n)};_.push(r)}if(c.getRange().containsPoint(e[1])){const n=c.getPtAt(e[1]).transformed(o),r={point:n,curveT:e[1],surfaceUV:t.getUVAt(n)};_.push(r)}return _}if(Math.abs(E/P)<=v){const e=-f/(2*g);if(c.getRange().containsPoint(e)){const n=c.getPtAt(e).transformed(o),r={point:n,curveT:e,surfaceUV:t.getUVAt(n)};_.push(r)}return _}return[]}static _line3dCone(e,t,n){const r=t.getCoord(),s=t.getA(),i=t.getB(),o=t.getH(),a=r.getLocalToWorldMatrix(),c=a.inversed();if(!c)return m.MathAssert.warn("transform matrix error!"),[];const l=e.clone().transform(c),d=l.getDirection(),u=l.getOrigin(),h=s*s,g=i*i,f=h*g,p=f/(o*o),_=g*d.x*d.x+h*d.y*d.y-p*d.z*d.z,v=2*(p*d.z*u.z-f*d.z/o),E=2*(g*d.x*u.x+h*d.y*u.y)-v,P=p*u.z*u.z-2*f*u.z/o+f,y=g*u.x*u.x+h*u.y*u.y-P,C=[];if(Math.abs(_)<n.lengthEps){if(Math.abs(E)>n.lengthEps){const n=-y/E,r=e.getPtAt(n),s={point:r,curveT:n,surfaceUV:t.getUVAt(r)};return C.push(s),C}if(Math.abs(y)<n.lengthEps){const r=e.getStartPt(),s=e.getParamAt(t.getApexPoint()),i=d.z>0,o=e.getRange().clone();if(o.containsPoint(s)&&(i?o.max=s:o.min=s),o.min>o.max+n.lengthEps)return[];const a={point:r,curveT:e.getStartParam(),surfaceUV:t.getUVAt(r),overlapRange:o};return C.push(a),C}return[]}const S=n.lengthEps*n.lengthEps,T=E*E-4*_*y;if(T>S){const e=[NaN,NaN];if(e[0]=(-E+Math.sqrt(T))/(2*_),e[1]=(-E-Math.sqrt(T))/(2*_),l.getRange().containsPoint(e[0])){const n=l.getPtAt(e[0]);if(n.z<o){const r=n.transformed(a),s={point:r,curveT:e[0],surfaceUV:t.getUVAt(r)};C.push(s)}}if(l.getRange().containsPoint(e[1])){const n=l.getPtAt(e[1]);if(n.z<o){const r=n.transformed(a),s={point:r,curveT:e[1],surfaceUV:t.getUVAt(r)};C.push(s)}}return C}if(Math.abs(T)<=S){const e=-E/(2*_);if(l.getRange().containsPoint(e)){const r=l.getPtAt(e);if(r.z<=o+n.lengthEps){const n=r.transformed(a),s={point:n,curveT:e,surfaceUV:t.getUVAt(n)};C.push(s)}}return C}return[]}static _line3dSphere(e,t,n){if(t.isEqualABC()){const n=t.getCenter(),r=e.getParamAt(n),s=e.getPtAt(r),i=n.sqDistanceTo(s),o=t.getRadius();if(Math.abs(i-o*o)<l.Tolerance.LENGTH_EPS2){const n=t.getUVAt(s);if(e.getRange().containsPoint(r)){return[{point:s,curveT:r,surfaceUV:n}]}return[]}if(i>o*o)return[];const a=n=>{const r=e.getPtAt(n);return{point:r,curveT:n,surfaceUV:t.getUVAt(r)}},c=[],d=Math.sqrt(o*o-i),u=r-d;if(e.getRange().containsPoint(u)){const e=a(u);e&&c.push(e)}const h=r+d;if(e.getRange().containsPoint(h)){const e=a(h);e&&c.push(e)}return c}throw new Error("椭球求交，暂未实现！")}static _line3dSweepSurface(e,t,n){const r=t.getPath(),i=t.getProfile();if(r instanceof s.Line3d){const o=t.getPathDz().cross(r.getDirection()),a=r.getDirection().cross(t.getPathDz()),c=new v.Coordinate3(r.getStartPt(),o,a);if(r.getDirection().isParallel(e.getDirection(),n.angleEps)){const o=c.getLocalPtAt(e.getOrigin()),a=new E.Vector2(o);if(!i.containsPoint(a,n.lengthEps))return[];const l=new s.Line3d(e.getOrigin(),e.getDirection(),f.Interval.infinitArray()),d=new f.Interval(l.getParamAt(r.getStartPt()),l.getParamAt(r.getEndPt()),!0).intersected(e.getRange());if(0===d.length)return[];return[{point:e.getOrigin(),curveT:0,surfaceUV:t.getUVAt(e.getOrigin()),overlapRange:d[0]}]}}else if(r instanceof a.Arc3d){if(r.getNormal().isParallel(e.getDirection(),n.angleEps)){const s=[],i=r.getParamAt(e.getOrigin()),o=t.getIsoCurve(i,!0),a=p.CurveCurveIntersect.curve3ds(e,o,n);for(const e of a){const t={point:e.point,curveT:e.param1,surfaceUV:{x:e.param2,y:i}};s.push(t)}return s}}else;}}},95618:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveSurfaceIntersectUtil=void 0;const r=n(72564),s=n(6688),i=n(56973),o=n(33218),a=n(61226),c=n(87222),l=n(60229),d=n(81658),u=n(26773),h=n(97700),g=n(11042),f=n(76068);class p{constructor(e,t,n=new i.Tolerance){this._curve=e,this._surface=t,this._tol=n}static dealRedundantIntersect(e,t,n,r,s=i.Tolerance.DEFAULT){const a=1e6*s.lengthEps2;for(let c=0;c<r.length;c++){const l=n.point.sqDistanceTo(r[c].point);if(l<=s.lengthEps2){const s=e.getPtAt(r[c].curveT).sqDistanceTo(t.getPtAt(r[c].surfaceUV));return e.getPtAt(n.curveT).sqDistanceTo(t.getPtAt(n.surfaceUV))<s&&r.splice(c,1,n),!0}if(l<=a){const s=e.getPtAt(r[c].curveT).sqDistanceTo(t.getPtAt(r[c].surfaceUV)),a=e.getPtAt(n.curveT).sqDistanceTo(t.getPtAt(n.surfaceUV)),l=(r[c].curveT+n.curveT)/2,d=new o.Vector2((r[c].surfaceUV.x+n.surfaceUV.x)/2,(r[c].surfaceUV.y+n.surfaceUV.y)/2),u=e.getPtAt(l).sqDistanceTo(t.getPtAt(d));if(u<s&&u<a){const t={point:e.getPtAt(l),curveT:l,surfaceUV:d};return r.splice(c,1,t),!0}return s>i.Tolerance.CALCULATE_EPS&&a<s&&r.splice(c,1,n),!0}}return r.push(n),!1}calAllIntersects(e){const t=new d.Curve3dSegment(this._curve);t.range=this._curve.getRange(),t.depth=0;const n=new d.SurfacePatch(this._surface);this._surfaceRangeUV=e||[this._surface.getDomainU(),this._surface.getDomainV()],n.depth=0;if(!this._shrinkCurveRange(t,n))return[];if(this._shrinkSurfacePatchRanges(n,t),e){if(!e[0].containsInterval(s.Interval.infinit())){const t=n.rangeU.intersected(e[0]);if(0===t.length)return[];n.rangeU=t[0]}if(!e[1].containsInterval(s.Interval.infinit())){const t=n.rangeV.intersected(e[1]);if(0===t.length)return[];n.rangeV=t[0]}}const r=[t],i=[n],o=[],a={segment:t,patch:n};o.push(a);return this._calCurveSurfacePairsIntersect(r,i,o)}calSingleIntersect(e,t){const n=new d.Curve3dSegment(this._curve);n.range=this._curve.getRange(),this._surfaceRangeUV=t||[this._surface.getDomainU(),this._surface.getDomainV()];const r=this._surfaceRangeUV,s={segment:n,patch:new d.SurfacePatch(this._surface,r)};return this._curveSurfacePairIntersect(s,e)}hasIntersect(e,t=i.Tolerance.DEFAULT){const n=new d.Curve3dSegment(this._curve);n.range=this._curve.getRange(),n.depth=0;const r=new d.SurfacePatch(this._surface);this._surfaceRangeUV=e||[this._surface.getDomainU(),this._surface.getDomainV()],r.depth=0;if(!this._shrinkCurveRange(n,r))return!1;if(this._shrinkSurfacePatchRanges(r,n),e){if(!e[0].containsInterval(s.Interval.infinit())){const t=r.rangeU.intersected(e[0]);if(0===t.length)return!1;r.rangeU=t[0]}if(!e[1].containsInterval(s.Interval.infinit())){const t=r.rangeV.intersected(e[1]);if(0===t.length)return!1;r.rangeV=t[0]}}const o=[n],a=[r],c=[],l={segment:n,patch:r};return c.push(l),this._findCurveSurfacePairsIntersect(o,a,c)}_shrinkCurveRange(e,t){if(!e.curve.isLine3d())return!0;const n=t.surface;let r;if(r=n.isSweepSurface()?n.getTiltBox(this._surfaceRangeUV[0],this._surfaceRangeUV[1]):n.getBox(),!r)return!0;const s=f.boxCutLine(e.curve,r);return!!s&&(e.range=s,!0)}_shrinkSurfacePatchRanges(e,t){const n=t.getSegBox();if(e.surface.isPlane()){const t=e.surface,r=[l.CONST.MODEL_MAX_LENGTH,-l.CONST.MODEL_MAX_LENGTH],i=[l.CONST.MODEL_MAX_LENGTH,-l.CONST.MODEL_MAX_LENGTH];for(const e of n.getCornerPts()){const n=t.getUVAt(e);n.x>r[1]&&(r[1]=n.x),n.x<r[0]&&(r[0]=n.x),n.y>i[1]&&(i[1]=n.y),n.y<i[0]&&(i[0]=n.y)}e.rangeU=new s.Interval(r[0],r[1]),e.rangeV=new s.Interval(i[0],i[1])}else if(e.surface.isCylinder()||e.surface.isCone()){const t=e.surface.getCoord(),r=new c.Line3d(t.getOrigin(),t.getDz(),s.Interval.infinitArray()),i=[l.CONST.MODEL_MAX_LENGTH,-l.CONST.MODEL_MAX_LENGTH];for(const e of n.getCornerPts()){const t=r.getParamAt(e);t>i[1]&&(i[1]=t),t<i[0]&&(i[0]=t)}e.rangeV=new s.Interval(i[0],i[1]),e.rangeU=new u.PeriodInterval(0,l.CONST.PI2)}else if(e.surface.isSphere())e.rangeU=new u.PeriodInterval(0,l.CONST.PI2),e.rangeV=new s.Interval(-l.CONST.PI_2,l.CONST.PI_2);else if(e.surface.isSweepSurface()){const t=e.surface,r=t.getPath();if(r.isLine3d()){const r=[l.CONST.MODEL_MAX_LENGTH,-l.CONST.MODEL_MAX_LENGTH];for(const e of n.getCornerPts()){const n=t.getUVAt(e);n.y>r[1]&&(r[1]=n.y),n.y<r[0]&&(r[0]=n.y)}e.rangeV=new s.Interval(r[0],r[1])}else{if(!(r.isArc3d()||r.isNurbsCurve3d()||r.isOffsetCurve3d()))throw new Error("暂未支持的曲面类型！");e.rangeV=r.getRange()}const i=t.getProfile();if(i.isLine2d()){const r=[l.CONST.MODEL_MAX_LENGTH,-l.CONST.MODEL_MAX_LENGTH];for(const e of n.getCornerPts()){const n=t.getUVAt(e);n.x>r[1]&&(r[1]=n.x),n.x<r[0]&&(r[0]=n.x)}e.rangeU=new s.Interval(r[0],r[1])}else{if(!(i.isArc2d()||i.isNurbsCurve2d()||i.isOffsetCurve2d()))throw new Error("暂未支持的曲面类型！");e.rangeU=i.getRange()}}else{if(!e.surface.isNurbsSurface())throw new Error("暂未支持的曲面类型！");{const t=e.surface;e.rangeU=t.getDomainU(),e.rangeV=t.getDomainV()}}}_calCurveSurfacePairsIntersect(e,t,n){let r=[],s=0;for(;s<l.CONST.MAX_SUBDEVIDE_DEPTH;){for(const t of e){const e=[],n=new d.Curve3dSegment(t.curve),r=new d.Curve3dSegment(t.curve);e.push(n),e.push(r),d.CurveSegment.subdivideCurveSegment(t,e)}t.map((e=>d.SurfacePatch.subdivideSurfacePatch(e,8)));if(!this._combineCurveSurfacePairs(n,r))break;const i=this._FilterCurveSurfacePairs(r);if(0===i.length){n.splice(0);break}this._refreshSegmentPatchs(i,e,t),n.splice(0),n.push(...i),r=[],s++}const i=[];for(const e of n){const t=this._curveSurfacePairIntersect(e);t&&p.dealRedundantIntersect(e.segment.curve,e.patch.surface,t,i)}return i}_findCurveSurfacePairsIntersect(e,t,n){let r=[],s=0;for(;s<l.CONST.MAX_SUBDEVIDE_DEPTH;){for(const t of e){const e=[],n=new d.Curve3dSegment(t.curve),r=new d.Curve3dSegment(t.curve);e.push(n),e.push(r),d.CurveSegment.subdivideCurveSegment(t,e)}t.map((e=>d.SurfacePatch.subdivideSurfacePatch(e,8)));if(!this._combineCurveSurfacePairs(n,r))break;const i=this._FilterCurveSurfacePairs(r);if(0===i.length){n.splice(0);break}this._refreshSegmentPatchs(i,e,t),n.splice(0),n.push(...i),r=[],s++}for(const e of n){if(this._curveSurfacePairIntersect(e))return!0}return!1}_curveSurfacePairIntersect(e,t){const n=e.segment,r=e.patch;let s=[];if(t){let e,i;t instanceof a.Vector3?(e=this._curve.getParamAt(t),i=this._surface.getUVAt(t)):(e=t.curveT,i=t.uvPara),e=n.curve.getRange().clamp(e),r.surface.clampInDomain(i),s.push(e,i.x,i.y)}else s=[n.range.getMid(),r.rangeU.getMid(),r.rangeV.getMid()],n.curve.isLine3d()&&(s[0]=n.curve.getParamAt(r.getPatchBox3d().getCenter()));const i=(e,t)=>{if(e instanceof u.PeriodInterval){const n=u.PeriodInterval.RegularizeParam(t,e.period);return n<e.min-this._tol.numberEps||n>e.max+this._tol.numberEps?n+e.period:n}return t};if(this._curveSurfaceIteration(n.curve,r.surface,s,this._tol.lengthEps)&&n.curve.getRange().containsPoint(s[0])&&this._surfaceRangeUV[0].containsPoint(s[1])&&this._surfaceRangeUV[1].containsPoint(s[2])){const e=n.curve.getPtAt(s[0]);return s[0]=i(n.curve.getRange(),s[0]),s[1]=i(this._surfaceRangeUV[0],s[1]),s[2]=i(this._surfaceRangeUV[1],s[2]),{point:e,curveT:s[0],surfaceUV:{x:s[1],y:s[2]}}}}_calcCurveSurfaceDeltaParams(e,t,n,s){const a=e.getDerivatives(n[0],1),c=t.getDerivatives(new o.Vector2(n[1],n[2]),1),l=[a[0].x-c[0].x,a[0].y-c[0].y,a[0].z-c[0].z],d=[a[1].x,-c[1].x,-c[2].x],u=[a[1].y,-c[1].y,-c[2].y],g=[a[1].z,-c[1].z,-c[2].z],f=r.det([d,u,g]);if(Math.abs(f)>i.Tolerance.CALCULATE_EPS){const e=h.LinearSystem.execute([d,u,g],l);return void 0===e?[]:(e[0]*=s,e[1]*=s,e[2]*=s,e)}if(Math.abs(l[0])>i.Tolerance.CALCULATE_EPS&&Math.abs(l[1])>i.Tolerance.CALCULATE_EPS&&Math.abs(l[2])>i.Tolerance.CALCULATE_EPS)return[];const p=[d,u,g],_=[...l];for(let e=0;e<p.length;e++)Math.abs(p[e][0])+Math.abs(p[e][1])+Math.abs(p[e][2])<i.Tolerance.CALCULATE_EPS&&(p.splice(e,1),_.splice(e,1),e--);if(2===p.length){let e=0,t=Math.abs(p[0][0])+Math.abs(p[1][0]);for(let n=1;n<p[0].length;n++){const r=Math.abs(p[0][n])+Math.abs(p[1][n]);r>t&&(t=r,e=n)}for(const t of p)t.splice(e,1);const n=h.LinearSystem.execute(p,_);return void 0===n?[]:(n.splice(e,0,0),n[0]*=s,n[1]*=s,n[2]*=s,n)}if(a[1].getSqLength()<i.Tolerance.CALCULATE_EPS2||c[1].getSqLength()<i.Tolerance.CALCULATE_EPS2||c[2].getSqLength()<i.Tolerance.CALCULATE_EPS2)return[];const m=1/a[1].getLength(),v=1/c[1].getLength(),E=1/c[2].getLength();a[1]=a[1].multiply(m),c[1]=c[1].multiply(v),c[2]=c[2].multiply(E);const P=[a[1].x,-c[1].x,-c[2].x],y=[a[1].y,-c[1].y,-c[2].y],C=[a[1].z,-c[1].z,-c[2].z],S=h.LinearSystem.execute([P,y,C],l);return void 0===S?[]:(S[0]*=m*s,S[1]*=v*s,S[2]*=E*s,S)}_curveSurfaceIteration(e,t,n,r=i.Tolerance.LENGTH_EPS){const s=r*r*.01;let a=e.getPtAt(n[0]),c=t.getPtAt(new o.Vector2(n[1],n[2])),d=a.sqDistanceTo(c);if(d<s)return!0;let u=0,h=1;const f=[];let p=!0;for(;u<l.CONST.NORMAL_ITER_NUM||p;u++){h=h>1?h:g.estimateRootMultiplicity(f);const r=this._calcCurveSurfaceDeltaParams(e,t,n,h);if(0===r.length)return d<s;const _=[n[0]-r[0],n[1]-r[1],n[2]-r[2]];_[0]=e.getRange().clamp(_[0]);const m=new o.Vector2(_[1],_[2]);t.clampInDomain(m),_[1]=m.x,_[2]=m.y;let v=e.getPtAt(_[0]),E=t.getPtAt(m),P=v.sqDistanceTo(E),y=P/d;if(y>.9){_[0]=n[0]-.5*r[0],_[1]=n[1]-.5*r[1],_[2]=n[2]-.5*r[2],_[0]=e.getRange().clamp(_[0]);const s=new o.Vector2(_[1],_[2]);t.clampInDomain(s),_[1]=s.x,_[2]=s.y,v=e.getPtAt(_[0]),E=t.getPtAt(s),P=v.sqDistanceTo(E),y=P/d}if(y>1&&P<i.Tolerance.CALCULATE_EPS2)return!0;if(n[0]=_[0],n[1]=_[1],n[2]=_[2],P<i.Tolerance.ZERO_JUDGE_EPS2)return!0;if(a.sqDistanceTo(v)<s&&c.sqDistanceTo(E)<s||u>l.CONST.MAX_ITER_NUM)return P<s;u>=l.CONST.NORMAL_ITER_NUM&&(p=P<d-i.Tolerance.CALCULATE_EPS2),a=v,c=E,d=P,f.push(y)}return d<r}_combineCurveSurfacePairs(e,t){let n=!1;for(const r of e){if(0===r.segment.child.length&&0===r.patch.child.length){t.push(r);continue}const e=r.segment.child.length>1?r.segment.child:[r.segment],s=r.patch.child.length>1?r.patch.child:[r.patch];for(const n of e)for(const e of s){const r={segment:n,patch:e};t.push(r)}n=!0}return n}_FilterCurveSurfacePairs(e){const t=[];for(const n of e){const e=n.segment,r=n.patch,s=e.getSegBox(),i=r.getPatchBox3d();s.intersectsBox(i)&&t.push(n)}return t}_refreshSegmentPatchs(e,t,n){const r=new Set,s=new Set;for(const t of e)r.add(t.segment),s.add(t.patch);t.splice(0),t.push(...r),n.splice(0),n.push(...s)}}t.CurveSurfaceIntersectUtil=p},2237:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IntersectInfoUtil=void 0;t.IntersectInfoUtil=class{static curvesFromOverlap(e,t,n,r){const s=e.range1.getMid(),i=t.getPtAt(s),o=n.getParamAt(i),a=e.range1.getLength()>r.numberEps,c={point:i,param1:s,param2:o,isOverlap:a};return a&&(c.overlap1=e.range1,c.overlap2=e.range2,c.overlapSameDirection=e.isSameDirection),c}}},63936:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurfaceSelfIntersect=void 0;const r=n(56973),s=n(44757),i=n(49246),o=n(31109),a=n(43640),c=n(93145),l=n(32858),d=n(33218),u=n(6688),h=n(17980);t.SurfaceSelfIntersect=class{static singleIntersectCurve(e,t,n,g,f=r.Tolerance.DEFAULT,p=!1){if(e.isSweepSurface()){const r=e.getPath(),g=e.getProfile();r.isOffsetCurve3d()&&s.MathAssert.warn("SweepSurface path is offsetCurve3d!");const _=p?a.DiscreteParameter.NORMAL:a.DiscreteParameter.LOW;if((r.isExtendCurve3d()||r.isNurbsCurve3d())&&!i.Util.isNearlyEqual(t.y,n.y)){const r=[],s=g.discrete(_).map((e=>g.getParamAt(e))),i=new l.Line2d(d.Vector2.O(),d.Vector2.Y(),u.Interval.infinitArray()),a=h.CurveCurveIntersect.curve2ds(i,g);if(a.length>0)for(const e of a)for(let t=1;t<s.length;t++){if((s[t]-e.param2)*(s[t-1]-e.param2)<f.numberEps){s.splice(t,0,e.param2);break}}2===s.length&&s.splice(1,0,g.getRange().getMid());const p=[t.y,n.y];for(const t of s){const n=e.getIsoCurve(t,!1),s=o.CurveCurveIntersectUtil.curve3dsSingleIntersect(n,n,p,f);if(!s)return;p[0]=s.param1,p[1]=s.param2,r.push(s.point)}return c.NurbsCurve3d.makeByInterpolationPoints(r,3)}if((g.isExtendCurve2d()||r.isNurbsCurve2d())&&!i.Util.isNearlyEqual(t.x,n.x)){const s=[],i=r.discrete(_).map((e=>r.getParamAt(e))),a=[t.x,n.x];for(const t of i){const n=e.getIsoCurve(t,!0),r=o.CurveCurveIntersectUtil.curve3dsSingleIntersect(n,n,a,f);if(!r)return;a[0]=r.param1,a[1]=r.param2,s.push(r.point)}return c.NurbsCurve3d.makeByInterpolationPoints(s,3)}}}}},73337:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurfaceSurfaceIntersect=void 0;const r=n(68238),s=n(56973),i=n(60229),o=n(33789),a=n(47423),c=n(45303),l=n(53487),d=n(57249),u=n(89039),h=n(40616),g=n(44757),f=n(49246),p=n(63936);t.SurfaceSurfaceIntersect=class{static allIntersections(e,t,n,r,i,a,l=s.Tolerance.DEFAULT,d=!1){if(this._isComplexSurface(e)||this._isComplexSurface(t))return new u.SurfaceSurfaceIntersectComplex(e,t,l).allIntersects();const h=c.SurfaceSurfaceIntersectSpecial.execute(e,t,l);if(void 0!==h)return h;return new o.SurfaceSurfaceIntersectUtil(e,t,l).calAllIntersects(n,r,i,a,d)}static singleCurveBetweenTwoPoints(e,t,n,r,i,a=s.Tolerance.DEFAULT,l=!1){const d=c.SurfaceSurfaceIntersectSpecial.execute(e,t,a);if(void 0!==d){const e=[];for(const t of d)t.curve&&e.push(t.curve);const t=this.getNearstCurve(e,n,i);if(!t)return;const s=t.getParamAt(n),o=t.getTangentAt(s);i&&o.dot(i)<0&&t.reverse();let c=t.getParamAt(r);if(!t.isPeriodic())return s>c?t.setRange(c,s):t.setRange(s,c),t;const l=t.getRange().period;return f.Util.isNearlySmallerOrEqual(c,s,a.numberEps)&&(c+=l),t.setRange(s,c),t}if(h.SurfaceSurfaceCoplaner.simple(e,t,a))return void g.MathAssert.warn("简单曲面重合，没有单条交线！");const u=new o.SurfaceSurfaceIntersectUtil(e,t,a).calSingleIntersect(n,i,l);if(void 0===u||void 0===u.curve)return;const p=l?3:2;return u.curve.toNurbsBetweenPoints(p,n,r,i)}static singleCurveNearPointSimple(e,t,n,r,i=s.Tolerance.DEFAULT,o=!1){const a=c.SurfaceSurfaceIntersectSpecial.execute(e,t,i);if(void 0!==a){const e=[];for(const t of a)t.curve&&e.push(t.curve);return this.getNearstCurve(e,n,r)}if(!h.SurfaceSurfaceCoplaner.simple(e,t,i))return this._singleCurveNearPoint(e,t,n,r,i,o);g.MathAssert.warn("简单曲面重合，没有单条交线！")}static singleCurveNearPoint(e,t,n,r,i=s.Tolerance.DEFAULT,o=!1,a=!0){const l=c.SurfaceSurfaceIntersectSpecial.execute(e,t,i);if(void 0!==l){const e=[];for(const t of l)t.curve&&e.push(t.curve);return this.getNearstCurve(e,n,r)}if(this._isComplexSurface(e)||this._isComplexSurface(t)){const s=new u.SurfaceSurfaceIntersectComplex(e,t,i).singleIntersectCurve(n,r,o);return s||this._singleCurveNearPoint(e,t,n,r,i,o,a)}if(!h.SurfaceSurfaceCoplaner.simple(e,t,i))return this._singleCurveNearPoint(e,t,n,r,i,o,a);g.MathAssert.warn("简单曲面重合，没有单条交线！")}static selfIntersectCurve(e,t,n,r,i=s.Tolerance.DEFAULT,o=!1){const a=p.SurfaceSelfIntersect.singleIntersectCurve(e,t,n,r,i,o);return a||this.singleCurveNearParam(e,e,t,n,r,i,o)}static singleCurveNearParam(e,t,n,r,i,a=s.Tolerance.DEFAULT,c=!1){const l=new o.SurfaceSurfaceIntersectUtil(e,t,a).calSingleSelfIntersect(n,r,i,c);if(l){const e=3;return l.curve.toSimpleCurve3d(e)}}static getNearstCurve(e,t,n){if(e.length<1)return;if(1===e.length)return e[0];let o=[],a=i.CONST.MODEL_MAX_LENGTH;for(let n=0;n<e.length;n++){const s=r.CalculateDistance.pointToCurve3d(t,e[n]);f.Util.isNearlySmaller(s,a)?(o=[n],a=s):f.Util.isNearlyEqual(s,a)&&o.push(n)}if(1===o.length||void 0===n)return e[o[0]];let c=o[0],l=i.CONST.PI;for(const r of o){const o=e[r].getParamAt(t),a=e[r].getTangentAt(o);let d=n.angle(a);d=d>i.CONST.PI_2-s.Tolerance.ANGLE_EPS?i.CONST.PI-d:d,d<l&&(c=r,l=d)}return e[c]}static _isComplexSurface(e){if(e instanceof a.SweepSurface){const t=e.getPath(),n=e.getProfile();if(t.isExtendCurve3d()||n.isExtendCurve2d())return!0;if(t instanceof l.OffsetCurve3d&&t.getSingularities().length>0||n instanceof d.OffsetCurve2d&&n.getSingularities().length>0)return!0}return!1}static _singleCurveNearPoint(e,t,n,r,s,i,a=!0){const c=new o.SurfaceSurfaceIntersectUtil(e,t,s).calSingleIntersect(n,r,i);if(c){if(!a)return c.curve;const e=i?3:2;return c.curve.toSimpleCurve3d(e)}}}},89039:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurfaceSurfaceIntersectComplex=void 0;const r=n(47423),s=n(9327),i=n(93145),o=n(44757),a=n(61077),c=n(49246),l=n(68956),d=n(40616),u=n(56973),h=n(33789),g=n(45303),f=n(274);t.SurfaceSurfaceIntersectComplex=class{constructor(e,t,n=new u.Tolerance){this._surfacePatchs1=[],this._surfacePatchs2=[],this._singularCurvePatchs1=[],this._singularCurvePatchs2=[],this._surface1=e,this._surface2=t,this._tol=n,this._splitSurface(e,t)}allIntersects(){const e=[];for(const t of this._surfacePatchs1)for(const n of this._surfacePatchs2){const r=g.SurfaceSurfaceIntersectSpecial.execute(t.surface,n.surface,this._tol);if(void 0!==r){e.push(...r);continue}const s=new h.SurfaceSurfaceIntersectUtil(t.surface,n.surface,this._tol,t.rangeUV,n.rangeUV);e.push(...s.calAllIntersects())}return e}singleIntersectCurve(e,t,n=!1,i=!0){const a=new h.SurfaceSurfaceIntersectUtil(this._surface1,this._surface2,this._tol).findSurfaceIntersectPoint(e);if(void 0===a)return;const c=this._getOverlapSurfaceIntersection(a.point);if(c)return c;let l,d;if(this._surface1 instanceof r.SweepSurface){const e=this._surface1.getPath();if(e instanceof s.ExtendCurve3d){const t=e.getBaseCurve().getRange();l=a.uvPara1.y<t.min?this._surfacePatchs1[0]:a.uvPara1.y>t.max?this._surfacePatchs1[2]:this._surfacePatchs1[1]}else l=this._surfacePatchs1[0]}else l=this._surfacePatchs1[0];if(this._surface2 instanceof r.SweepSurface){const e=this._surface2.getPath();if(e instanceof s.ExtendCurve3d){const t=e.getBaseCurve().getRange();d=a.uvPara2.y<t.min?this._surfacePatchs2[0]:a.uvPara2.y>t.max?this._surfacePatchs2[2]:this._surfacePatchs2[1]}else d=this._surfacePatchs2[0]}else d=this._surfacePatchs2[0];const u={patch1:l,patch2:d,points:[a.point],dir:t,isUsed:!1},g=[];g.push(u);const f=[],p=[],_=1e3*this._tol.lengthEps;for(const e of g){if(e.isUsed)continue;e.isUsed=!0;const t=new h.SurfaceSurfaceIntersectUtil(e.patch1.surface,e.patch2.surface,this._tol,e.patch1.rangeUV,e.patch2.rangeUV).calSingleIntersect(e.points[0],e.dir,n);if(void 0===t){o.MathAssert.warn(!0,"谨慎核查：一段交线计算失败！！");continue}const r=t.curve,s=r.getIntersectPtsChart();if(2===s.length){const e=r.insertPt(0,.5);o.MathAssert.warn(e,"交线插点失败！！")}let i=0;for(let e=1;e<s.length;e++){i+=s[e].point.sqDistanceTo(s[e-1].point)}Math.sqrt(i)<10*_?this._getNextPatchPairForOnePtCurve(e,r,e.dir,p,g,_):(f.push(r),e.points=[s[0].point,s[s.length-1].point],this._updateConnectPatchPairs(e,r,g,_),this._getNextPatchPair(e,r,p,g,_))}const m=n?3:2;if(f.length<2){if(0===f.length)return;if(!i)return f[0];return f[0].toSimpleCurve3d(m)}return this._spliceIntersectCurves(f,a.point,m,_)}_splitSurface(e,t){if(e instanceof r.SweepSurface)if(e.getPath().isExtendCurve3d()){this._surfacePatchs1=e.toSimpleSurfacePatchs();const t=e.getPath().getBaseCurve().getRange(),n=e.getIsoCurve(t.min,!0);this._singularCurvePatchs1.push({curve:n,surfPatchs:[this._surfacePatchs1[0],this._surfacePatchs1[1]]});const r=e.getIsoCurve(t.max,!0);this._singularCurvePatchs1.push({curve:r,surfPatchs:[this._surfacePatchs1[1],this._surfacePatchs1[2]]})}else this._surfacePatchs1=[{surface:e}];else this._surfacePatchs1=[{surface:e}];if(t instanceof r.SweepSurface)if(t.getPath().isExtendCurve3d()){this._surfacePatchs2=t.toSimpleSurfacePatchs();const e=t.getPath().getBaseCurve().getRange(),n=t.getIsoCurve(e.min,!0);this._singularCurvePatchs2.push({curve:n,surfPatchs:[this._surfacePatchs2[0],this._surfacePatchs2[1]]});const r=t.getIsoCurve(e.max,!0);this._singularCurvePatchs2.push({curve:r,surfPatchs:[this._surfacePatchs2[1],this._surfacePatchs2[2]]})}else this._surfacePatchs2=[{surface:t}];else this._surfacePatchs2=[{surface:t}]}_getNextPatchPairForOnePtCurve(e,t,n,r,s,i){const o=t.getIntersectPtsChart()[0];let a=!1;for(const e of r)if(e.equals(o.point,i)){a=!0;break}if(a)return;r.push(o.point);const c=[];for(const e of this._singularCurvePatchs1)e.curve.containsPoint(o.point,i)&&c.push(...e.surfPatchs);const l=[];for(const e of this._singularCurvePatchs2)e.curve.containsPoint(o.point,i)&&l.push(...e.surfPatchs);if(2===c.length&&0===l.length){const t=e.patch1===c[0]?c[1]:c[0];s.push({patch1:t,patch2:e.patch2,points:[o.point],dir:n,isUsed:!1})}else if(0===c.length&&2===l.length){const t=e.patch2===l[0]?l[1]:l[0];s.push({patch1:e.patch1,patch2:t,points:[o.point],dir:n,isUsed:!1})}else if(2===c.length&&2===l.length){const e=(e,t,n)=>{for(const r of s)if(r.patch1===e&&r.patch2===t){for(const e of r.points)if(e.equals(n,i))return!0;return!1}return!1};for(const t of c)for(const r of l)e(t,r,o.point)||s.push({patch1:t,patch2:r,points:[o.point],dir:n,isUsed:!1})}}_updateConnectPatchPairs(e,t,n,r){const s=t.getIntersectPtsChart(),i=[s[0].point,s[s.length-1].point];for(const t of n)t.isUsed||t.patch1===e.patch1&&t.patch2===e.patch2&&(t.points[0].equals(i[0],r)||t.points[0].equals(i[1],r))&&(t.isUsed=!0)}_getNextPatchPair(e,t,n,r,s){const i=t.getIntersectPtsChart(),o=[i[0],i[i.length-1]];for(let t=0;t<o.length;t++){const a=o[t];let l=!1;for(const e of n)if(e.equals(a.point,s)){l=!0;break}if(l)continue;n.push(a.point);const d=[];for(const t of this._singularCurvePatchs1)if(t.curve.containsPoint(a.point,s)){let n=!0;const r=e.patch1===t.surfPatchs[0]?t.surfPatchs[0]:t.surfPatchs[1],o=r.surface.getUVAt(t.curve.getStartPt()),a=r.surface.getUVAt(t.curve.getMidPt()),l=c.Util.isNearlyEqual(o.x,a.x),u=c.Util.isNearlyEqual(o.y,a.y),h=r.surface.getDerivatives(o,1);if(l&&u)throw new Error("");if(l){const e=o.x,t=s/h[1].getLength();for(const r of i)if(!c.Util.isNearlyEqual(r.uvPara1.x,e,t)){n=!1;break}}else if(u){const e=o.y,t=s/h[2].getLength();for(const r of i)if(!c.Util.isNearlyEqual(r.uvPara1.y,e,t)){n=!1;break}}if(n)return;d.push(...t.surfPatchs)}const u=[];for(const t of this._singularCurvePatchs2)if(t.curve.containsPoint(a.point,s)){let n=!0;const r=e.patch2===t.surfPatchs[0]?t.surfPatchs[0]:t.surfPatchs[1],o=r.surface.getUVAt(t.curve.getStartPt()),a=r.surface.getUVAt(t.curve.getMidPt()),l=c.Util.isNearlyEqual(o.x,a.x),d=c.Util.isNearlyEqual(o.y,a.y),h=r.surface.getDerivatives(o,1);if(l&&d)throw new Error("");if(l){const e=o.x,t=s/h[1].getLength();for(const r of i)if(!c.Util.isNearlyEqual(r.uvPara2.x,e,t)){n=!1;break}}else if(d){const e=o.y,t=s/h[2].getLength();for(const r of i)if(!c.Util.isNearlyEqual(r.uvPara2.y,e,t)){n=!1;break}}if(n)return;u.push(...t.surfPatchs)}let h;if(h=0===t?i[0].point.subtracted(i[1].point):i[i.length-1].point.subtracted(i[i.length-2].point),2===d.length&&0===u.length){const t=e.patch1===d[0]?d[1]:d[0];r.push({patch1:t,patch2:e.patch2,points:[a.point],dir:h,isUsed:!1})}else if(0===d.length&&2===u.length){const t=e.patch2===u[0]?u[1]:u[0];r.push({patch1:e.patch1,patch2:t,points:[a.point],dir:h,isUsed:!1})}else if(2===d.length&&2===u.length){const t=e.patch1.surface.getDerivatives(a.uvPara1,1)[2],n=e.patch1.rangeUV[1];Math.abs(a.uvPara1.y-n.min)<Math.abs(a.uvPara1.y-n.max)&&t.reverse();const s=e.patch1===d[0]?d[1]:d[0],i=h.dot(t)>0?s:e.patch1,o=e.patch2.surface.getDerivatives(a.uvPara2,1)[2],c=e.patch2.rangeUV[1];Math.abs(a.uvPara2.y-c.min)<Math.abs(a.uvPara2.y-c.max)&&o.reverse();const l=e.patch2===u[0]?u[1]:u[0],g=h.dot(o)>0?l:e.patch2;r.push({patch1:i,patch2:g,points:[a.point],dir:h,isUsed:!1})}}}_spliceIntersectCurves(e,t,n,r){for(const t of e){const e=t.getIntersectPtsChart();if(e.length>3){let t=1;for(;t<e.length-1;t++){e[t].point.sqDistanceTo(e[t-1].point)<e[t+1].point.sqDistanceTo(e[t-1].point)/1e4&&e.splice(t,1)}if(e.length>3){const t=e.length-1;e[t].point.sqDistanceTo(e[t-1].point)<e[t].point.sqDistanceTo(e[t-2].point)/1e4&&e.splice(t-1,1)}}}const s=[];for(let t=1;t<e.length;t++){let n=e[t];if(1===t){const t=e[0],r=e[1];let i=t;if(t.getIntersectPtsChart().length<r.getIntersectPtsChart().length&&(i=r,n=t),i.getIntersectPtsChart().map((e=>s.push(e.point))),2===s.length){const e=i.getInsertPt(0,.5);s.splice(1,0,e)}}this._spliceCurve(s,n,r)}if(s[0].equals(s[s.length-1],r)&&!s[0].equals(t,r)){const e=s.findIndex((e=>e.equals(t,r)));if(e>0){s.pop();const t=s.slice(0,e);s.splice(0,e),s.push(...t),s.push(s[0])}}return i.NurbsCurve3d.makeByInterpolationPoints(s,n)}_spliceCurve(e,t,n){const r=e[0],s=e[e.length-1];if(r.sqDistanceTo(s)<n*n)return void o.MathAssert.warn(!0,"未实现：周期性交线拼接曲线！");const i=t.getStartPt(),a=t.getEndPt(),c=[];c.push(r.sqDistanceTo(i)),c.push(r.sqDistanceTo(a)),c.push(s.sqDistanceTo(i)),c.push(s.sqDistanceTo(a));let l=0,d=c[0];for(let e=1;e<4;e++)c[e]<d&&(l=e,d=c[e]);if(d>n)throw new Error("曲线不相连！");const u=[.05,.1];if(t.isLine3d()){if(t.getLength()<n)return;if(0===l||1===l){0===l&&t.reverse();const n=t.getStartPt(),r=t.getEndPt(),s=n.multiplied(u[1]).add(r.multiplied(1-u[1])),i=n.multiplied(u[0]).add(r.multiplied(1-u[0]));e.splice(0,0,n,s,i)}else{3===l&&t.reverse();const n=t.getStartPt(),r=t.getEndPt(),s=n.multiplied(1-u[0]).add(r.multiplied(u[0])),i=n.multiplied(1-u[1]).add(r.multiplied(u[1]));e.push(s,i,r)}}else{if(!(t instanceof f.IntersectCurve3d))throw new Error("");{const n=t.getIntersectPtsChart(),r=[];if(n.map((e=>r.push(e.point))),0===l||2===l){if(2===r.length){const e=t.getInsertPt(0,u[0]),n=t.getInsertPt(0,u[1]);r.splice(0,1,e,n)}else if(3===r.length){const e=t.getInsertPt(0,u[0]);r.splice(0,1,e)}else r.splice(0,1);0===l?(r.reverse(),e.splice(0,0,...r)):e.push(...r)}else{if(2===r.length){const e=t.getInsertPt(0,1-u[1]),n=t.getInsertPt(0,1-u[0]);r.pop(),r.push(e,n)}else if(3===r.length){const e=t.getInsertPt(1,u[0]);r.pop(),r.push(e)}else r.pop();1===l?e.splice(0,0,...r):(r.reverse(),e.push(...r))}}}}_getOverlapSurfaceIntersection(e){for(let t=0;t<this._surfacePatchs1.length;t++){const n=this._surfacePatchs1[t];for(let r=0;r<this._surfacePatchs2.length;r++){const s=this._surfacePatchs2[r];if(d.SurfaceSurfaceCoplaner.simple(n.surface,s.surface,this._tol)){let n,s;if(this._surfacePatchs1.length>1)if(0===t)n=this._singularCurvePatchs1[0].curve;else if(2===t)n=this._singularCurvePatchs1[1].curve;else if(1===t){const t=l.PointToCurve3dDistance.execute(e,this._singularCurvePatchs1[0].curve),r=l.PointToCurve3dDistance.execute(e,this._singularCurvePatchs1[1].curve);n=t.distance<r.distance?this._singularCurvePatchs1[0].curve:this._singularCurvePatchs1[1].curve}if(this._surfacePatchs2.length>1)if(0===r)s=this._singularCurvePatchs2[0].curve;else if(2===r)s=this._singularCurvePatchs2[1].curve;else if(1===r){const t=l.PointToCurve3dDistance.execute(e,this._singularCurvePatchs2[0].curve),r=l.PointToCurve3dDistance.execute(e,this._singularCurvePatchs2[1].curve);n=t.distance<r.distance?this._singularCurvePatchs2[0].curve:this._singularCurvePatchs2[1].curve}if(n&&!s)return n;if(!n&&s)return s;if(n&&s){const e=n.getStartPt(),t=n.getEndPt(),r=this._surface2.containsPoint(e),i=this._surface2.containsPoint(t);if(r||i){if(r&&i)return n;const e=this._surface2.getDomainU();if(r){const t=this._surface2.getIsoCurve(e.max,!1),r=a.CalculateIntersect.curve3ds(t,n);if(r)return o.MathAssert.warn(r.length>1,"奇异曲线交点个数大于1"),n.getRange().max=r[0].param2,n;const s=this._surface2.getIsoCurve(e.min,!1),i=a.CalculateIntersect.curve3ds(s,n);if(i)return o.MathAssert.warn(i.length>1,"奇异曲线交点个数大于1"),n.getRange().max=i[0].param2,n;o.MathAssert.warn(!1,"奇异曲线交点个数错误")}else{const t=this._surface2.getIsoCurve(e.min,!1),r=a.CalculateIntersect.curve3ds(t,n);if(r)return o.MathAssert.warn(r.length>1,"奇异曲线交点个数大于1"),n.getRange().min=r[0].param2,n;const s=this._surface2.getIsoCurve(e.max,!1),i=a.CalculateIntersect.curve3ds(s,n);if(i)return o.MathAssert.warn(i.length>1,"奇异曲线交点个数大于1"),n.getRange().min=i[0].param2,n;o.MathAssert.warn(!1,"奇异曲线交点个数错误")}return n}const c=s.getStartPt(),l=s.getEndPt(),d=this._surface1.containsPoint(c),u=this._surface1.containsPoint(l);if(d||u){if(d&&u)return s;const e=this._surface1.getDomainU();if(r){const t=this._surface1.getIsoCurve(e.max,!1),r=a.CalculateIntersect.curve3ds(t,s);if(r)return o.MathAssert.warn(r.length>1,"奇异曲线交点个数大于1"),s.getRange().max=r[0].param2,s;const i=this._surface1.getIsoCurve(e.min,!1),c=a.CalculateIntersect.curve3ds(i,n);if(c)return o.MathAssert.warn(c.length>1,"奇异曲线交点个数大于1"),s.getRange().max=c[0].param2,s;o.MathAssert.warn(!1,"奇异曲线交点个数错误")}else{const t=this._surface1.getIsoCurve(e.min,!1),r=a.CalculateIntersect.curve3ds(t,n);if(r)return o.MathAssert.warn(r.length>1,"奇异曲线交点个数大于1"),s.getRange().min=r[0].param2,s;const i=this._surface1.getIsoCurve(e.max,!1),c=a.CalculateIntersect.curve3ds(i,s);if(c)return o.MathAssert.warn(c.length>1,"奇异曲线交点个数大于1"),s.getRange().min=c[0].param2,s;o.MathAssert.warn(!1,"奇异曲线交点个数错误")}return s}const h=[],g=this._surface1.getDomainU().toArray();for(const e of g){const t=this._surface1.getIsoCurve(e,!1),n=a.CalculateIntersect.curve3ds(t,s);n&&(o.MathAssert.warn(n.length>1,"奇异曲线交点个数大于1"),h.push(n[0].param2))}if(h.length>0)return 2===h.length?(h[0]>h[1]&&([h[0],h[1]]=[h[1],h[0]]),s.setRange(h[0],h[1])):o.MathAssert.warn(2===h.length,"奇异曲线交点个数错误"),s;const f=[],p=this._surface2.getDomainU().toArray();for(const e of p){const t=this._surface2.getIsoCurve(e,!1),r=a.CalculateIntersect.curve3ds(t,n);r&&(o.MathAssert.warn(r.length>1,"奇异曲线交点个数大于1"),f.push(r[0].param2))}return f.length>0?(2===f.length?(f[0]>f[1]&&([f[0],f[1]]=[f[1],f[0]]),n.setRange(f[0],f[1])):o.MathAssert.warn(2===f.length,"奇异曲线交点个数错误"),n):void 0}}}}}}},45303:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurfaceSurfaceIntersectSpecial=void 0;const r=n(74729),s=n(89494),i=n(6688),o=n(56973),a=n(33218),c=n(61226),l=n(10909),d=n(97602),u=n(24013),h=n(29453),g=n(82433),f=n(32858),p=n(87222),_=n(72883),m=n(5804),v=n(60229),E=n(49246),P=n(68238),y=n(17980),C=n(19516),S=n(47423),T=n(9327),b=n(79034),w=n(83925),x=n(53487),M=n(44757),N=n(11652);t.SurfaceSurfaceIntersectSpecial=class{static execute(e,t,n=new o.Tolerance){if(e.isPlane()&&t.isPlane()){const r=e,s=t;return this._planePlane(r,s,n)}if(e.isPlane()&&t.isCylinder()){const r=e,s=t;return this._planeCylinder(r,s,n)}if(t.isPlane()&&e.isCylinder()){const r=t,s=e;return this._planeCylinder(r,s,n)}if(e.isPlane()&&t.isCone()){const r=e,s=t;return this._planeCone(r,s,n)}if(t.isPlane()&&e.isCone()){const r=t,s=e;return this._planeCone(r,s,n)}if(e.isPlane()&&t.isSphere()){const r=e,s=t;return this._planeSphere(r,s,n)}if(t.isPlane()&&e.isSphere()){const r=t,s=e;return this._planeSphere(r,s,n)}if(e.isPlane()&&t.isSweepSurface()){const r=e,s=t;return this._planeSweepSurface(r,s,n)}if(t.isPlane()&&e.isSweepSurface()){const r=t,s=e;return this._planeSweepSurface(r,s,n)}if(e.isPlane()&&t.isOffsetSurface()){const r=e,s=t;return this._planeOffsetSurface(r,s,n)}if(t.isPlane()&&e.isOffsetSurface()){const r=t,s=e;return this._planeOffsetSurface(r,s,n)}if(e.isCylinder()&&t.isCylinder()){const r=e,s=t;return this._cylinderCylinder(r,s,n)}if(e.isCylinder()&&t.isCone()){const r=e,s=t;return this._cylinderCone(r,s,n)}if(t.isCylinder()&&e.isCone()){const r=t,s=e;return this._cylinderCone(r,s,n)}if(e.isCylinder()&&t.isSphere()){const r=e,s=t;return this._cylinderSphere(r,s,n)}if(t.isCylinder()&&e.isSphere()){const r=t,s=e;return this._cylinderSphere(r,s,n)}if(e.isCylinder()&&t.isSweepSurface()){const r=e,s=t;return this._cylinderSweepSurface(r,s,n)}if(t.isCylinder()&&e.isSweepSurface()){const r=t,s=e;return this._cylinderSweepSurface(r,s,n)}if(e.isCone()&&t.isCone()){const r=e,s=t;return this._coneCone(r,s,n)}if(e.isSphere()&&t.isSweepSurface()){const r=e,s=t;return this._sphereSweepSurface(r,s,n)}if(t.isSphere()&&e.isSweepSurface()){const r=t,s=e;return this._sphereSweepSurface(r,s,n)}if(e.isSweepSurface()&&t.isSweepSurface()){const r=e,s=t;return this._sweepSweepSurface(r,s,n)}}static _planePlane(e,t,n){if(e.getNorm().isParallel(t.getNorm(),n.angleEps))return[];const r=e.getNorm(),s=t.getNorm(),o=r.cross(s).normalize(),a=o.cross(r),c=t.getOrigin().subtract(e.getOrigin()).dot(s)/s.dot(a),l=a.multiplied(c).add(e.getOrigin());return[{curve:new p.Line3d(l,o,i.Interval.infinitArray())}]}static _planeCylinder(e,t,n){if(!t.isEqualAB())return this._planeEllipseCylinder(e,t,n);const r=e.getNorm(),i=e.getOrigin(),a=t.getCenterAxis(),c=t.getCoord().getOrigin(),l=t.getA(),u=a.dot(r),h=P.CalculateDistance.pointToSurfaceSigned(c,e),g=c.subtracted(r.multiplied(h)),f=Math.abs(h);if(r.isPerpendicular(a,o.Tolerance.ANGLE_EPS)){if(f-l>o.Tolerance.LENGTH_EPS)return[];if(Math.abs(f-l)<=o.Tolerance.LENGTH_EPS){return[{curve:new p.Line3d(g,a,[-v.CONST.MODEL_MAX_LENGTH,v.CONST.MODEL_MAX_LENGTH])}]}const e=a.cross(r),t=Math.sqrt(l*l-f*f),n=g.subtracted(e.multiplied(t)),s=g.added(e.multiplied(t));return[{curve:new p.Line3d(n,a,[-v.CONST.MODEL_MAX_LENGTH,v.CONST.MODEL_MAX_LENGTH])},{curve:new p.Line3d(s,a,[-v.CONST.MODEL_MAX_LENGTH,v.CONST.MODEL_MAX_LENGTH])}]}if(r.isParallel(a,o.Tolerance.ANGLE_EPS)){const e=new s.Coordinate3(g,a);return[{curve:new d.Arc3d(e,l,l,[0,v.CONST.PI2])}]}const _=i.subtracted(c).dot(r),m=c.added(a.multiplied(_/u)),E=a.subtracted(r.multiplied(u)),y=r.cross(E),C=new s.Coordinate3(m,E,y);return[{curve:new d.Arc3d(C,l/Math.abs(u),l,[0,v.CONST.PI2])}]}static _planeEllipseCylinder(e,t,n){const i=t.getCoord(),o=t.getA(),u=t.getB();if(e.getNorm().isParallel(t.getCenterAxis())){const t=new p.Line3d(i.getOrigin(),i.getDz(),[-v.CONST.MODEL_MAX_LENGTH,v.CONST.MODEL_MAX_LENGTH]),n=C.CurveSurfaceIntersect.allPoints(t,e),r=i.clone();r.setOrigin(n[0]);return[{curve:new d.Arc3d(r,o,u,[0,v.CONST.PI2])}]}const h=i.getLocalToWorldMatrix(),g=h.inversed();if(!g)return M.MathAssert.warn("transform matrix error!"),[];const _=e.clone().transform(g),m=_.getNorm();if(m.isPerpendicular(new c.Vector3(0,0,1))){const e=new r.Coordinate2(new a.Vector2(0,0),new a.Vector2(1,0)),t=new l.Arc2d(e,o,u,!0,[0,v.CONST.PI2]),n=_.getOrigin(),s=new f.Line2d(new a.Vector2(n.x,n.y),new a.Vector2(-m.y,m.x),[-v.CONST.MODEL_MAX_LENGTH,v.CONST.MODEL_MAX_LENGTH]),i=y.CurveCurveIntersect.curve2ds(s,t);if(0===i.length)return[];const d=[];for(const e of i){const t=e.point,n=new p.Line3d(new c.Vector3(t.x,t.y,0),new c.Vector3(0,0,1),[-v.CONST.MODEL_MAX_LENGTH,v.CONST.MODEL_MAX_LENGTH]);n.transform(h);const r={curve:n};d.push(r)}return d}const E=new p.Line3d(new c.Vector3(0,0,0),new c.Vector3(0,0,1),[-1e7,1e7]),P=C.CurveSurfaceIntersect.allPoints(E,_);_.getCoord().setOrigin(P[0]);const S=_.getUDir(),T=_.getVDir(),b=o*o,w=u*u,x=w*S.x*S.x+b*S.y*S.y,N=2*(w*S.x*T.x+b*S.y*T.y),A=w*T.x*T.x+b*T.y*T.y,O=b*w,I=.5*Math.atan(N/(x-A)),D=Math.cos(I),L=Math.sin(I),V=S.multiplied(D).added(T.multiplied(L)),R=_.getNorm().cross(V),U=new s.Coordinate3(P[0],V,R),B=x*D*D+A*L*L+N*D*L,F=A*D*D+x*L*L-N*D*L,k=Math.sqrt(O/B),G=Math.sqrt(O/F),j=new d.Arc3d(U,k,G,[0,v.CONST.PI2]);j.transform(h);return[{curve:j}]}static _planeCone(e,t,n){if(!t.isEqualAB())return this._planeEllipseCone(e,t,n);const r=t.getCenterAxis(),i=t.getApexPoint(),a=t.getA(),c=e.getNorm(),l=e.getOrigin(),u=Math.sqrt(a*a+t.getH()*t.getH()),h=a/u,f=r.dot(c);if(e.containsPoint(i)){if(E.Util.isNearlyBigger(f,h)){return[{point:i}]}if(E.Util.isNearlyEqual(f,h)){const e=c.multiplied(f).subtracted(r);return[{curve:new p.Line3d(i,e,[0,v.CONST.MODEL_MAX_LENGTH])}]}const e=c.multiplied(f).subtracted(r).normalize(),n=e.cross(c),s=1-f*f,o=t.getH()/u,a=Math.sqrt(h*h*s-o*o*f*f)/o,l=e.added(n.multiplied(a)),d=new p.Line3d(i,l,[0,v.CONST.MODEL_MAX_LENGTH]),g=e.subtracted(n.multiplied(a));return[{curve:d},{curve:new p.Line3d(i,g,[0,v.CONST.MODEL_MAX_LENGTH])}]}const m=c.dot(l.subtracted(i)),P=i.added(c.multiplied(m));if(r.dot(P.subtracted(i))>o.Tolerance.LENGTH_EPS&&E.Util.isNearlyBiggerOrEqual(f,h))return[];const y=Math.abs(m);if(c.isParallel(r)){const e=y*a/t.getH(),n=new s.Coordinate3(P,r);return[{curve:new d.Arc3d(n,e,e,[0,v.CONST.PI2])}]}if(E.Util.isNearlyEqual(f,h)){const e=Math.sqrt(1-f*f)/f,t=1/e,n=m/2*(e-t),o=r.subtracted(c.multiplied(f)).normalize(),a=c.cross(o),l=i.added(c.multiplied(m)).added(a.multiplied(n)),d=new s.Coordinate3(l,o,a),u=y/2*t,h=Math.sqrt(4*v.CONST.MODEL_MAX_LENGTH*u);return[{curve:new _.Parabola3d(d,u,[-h,h]).toBezier3d()}]}const C=h*h,S=f*f-C,T=m/S,b=r.multiplied(T*f),w=c.multiplied(T*C),x=i.added(b).subtracted(w),M=c.multiplied(f).subtracted(r).normalize(),N=c.cross(M),A=new s.Coordinate3(x,M,N),O=t.getH()/u,I=Math.abs(T)*h*O,D=Math.abs(m)*h/Math.sqrt(Math.abs(S));if(E.Util.isNearlyBigger(f,h)){return[{curve:new d.Arc3d(A,I,D,[0,v.CONST.PI2])}]}const L=v.CONST.MODEL_MAX_LENGTH,V=Math.sqrt((L-I)/(L+I)),R=(-D+Math.sqrt(D*D+L*L))/L,U=V<R?V:R;return[{curve:new g.Hyperbola3d(A,I,D,[-U,U]).toBezier3d()}]}static _planeEllipseCone(e,t,n){}static _planeSphere(e,t,n){if(!t.isEqualABC())return this._planeEllipsoid(e,t,n);const r=t.getA()*t.getA(),i=t.getCenter(),o=e.getProjectedPtBy(i),a=i.sqDistanceTo(o);if(a>r+n.lengthEps2)return[];if(a<r-n.lengthEps2){const t=Math.sqrt(r-a),n=new s.Coordinate3(o,e.getNorm());return[{curve:new d.Arc3d(n,t,t)}]}return[{point:o}]}static _planeEllipsoid(e,t,n){}static _planeSweepSurface(e,t,n){const r=e.getCoord(),s=t.getPath();if(s instanceof p.Line3d){if(r.getDz().isParallel(s.getDirection())){const r=C.CurveSurfaceIntersect.execute(s,e,n);if(0===r.length)return[];return[{curve:t.getIsoCurve(r[0].curveT,!0)}]}if(r.getDz().isPerpendicular(s.getDirection())){const n=t.getIsoCurve(s.getRange().getMid(),!0),r=C.CurveSurfaceIntersect.allPoints(n,e);if(0===r.length)return[];const o=[];for(const e of r){const t={curve:new p.Line3d(e,s.getDirection(),i.Interval.infinitArray())};o.push(t)}return o}}else if(s instanceof d.Arc3d||s instanceof T.ExtendCurve3d){let i;if(s instanceof d.Arc3d)i=s.getCoord();else{const e=s.getBaseCurve();if(!e.isArc3d())return;i=e.getCoord()}if(!i.getDz().isParallel(r.getDz())||!i.getDz().isParallel(t.getPathDz()))return;const o=s instanceof d.Arc3d?s.getRange().getMid():s.getBaseCurve().getRange().getMid(),a=t.getIsoCurve(o,!0),c=C.CurveSurfaceIntersect.allPoints(a,e);if(0===c.length)return[];const l=[];for(const e of c){const r=t.getUVAt(e);if(Math.abs(r.y-o)>n.numberEps)return M.MathAssert.warn("surfaces intersect：sweep反求参数错误！"),[];const s={curve:t.getIsoCurve(r.x,!1)};l.push(s)}return l}}static _planeOffsetSurface(e,t,n){const r=e.getNorm(),s=t.getBaseSurface();if(s instanceof h.Cylinder){const o=s.getCoord();if(o.getDz().isPerpendicular(r,n.angleEps)){const r=new d.Arc3d(o,s.getA(),s.getB()),a=new x.OffsetCurve3d(r,o.getDz(),t.getOffset(),0),c=C.CurveSurfaceIntersect.allPoints(a,e,n),l=[];for(const e of c){const t={curve:new p.Line3d(e,o.getDz(),i.Interval.infinitArray())};l.push(t)}return l}if(o.getDz().isParallel(r,n.angleEps)){const r=this._planeCylinder(e,s,n)[0].curve;return[{curve:new x.OffsetCurve3d(r,r.getNormal(),t.getOffset(),0)}]}}else if(s instanceof u.Cone){if(s.getCoord().getDz().isParallel(r,n.angleEps)){const r=this._planeCone(e,s,n);if(0===r.length)return[];const i=r[0].curve;return[{curve:new x.OffsetCurve3d(i,i.getNormal(),t.getOffset(),0)}]}}else{if(s instanceof w.Sphere)return;if(s instanceof S.SweepSurface)return}}static _cylinderCylinder(e,t,n){const i=e.getCenterAxis(),a=t.getCenterAxis();if(i.isParallel(a)){if(e.isEqualAB()&&t.isEqualAB()){const n=e.getA(),r=t.getA(),s=e.getCoord().getOrigin(),a=t.getCoord().getOrigin(),c=a.subtracted(s),l=i.dot(c.normalized()),d=c.getSqLength()*(1-l*l),u=(n+r)*(n+r);if(E.Util.isNearlyBigger(d,u,o.Tolerance.LENGTH_EPS*o.Tolerance.LENGTH_EPS))return[];if(E.Util.isNearlyEqual(d,u,o.Tolerance.LENGTH_EPS*o.Tolerance.LENGTH_EPS)){const e=s.added(a).multiplied(.5);return[{curve:new p.Line3d(e,i,[-v.CONST.MODEL_MAX_LENGTH,v.CONST.MODEL_MAX_LENGTH])}]}}const n=e.getCoord(),s=r.Coordinate2.XOY(),a=new l.Arc2d(s,e.getA(),e.getB(),!0,[0,v.CONST.PI2]),c=t.getCoord().getOrigin(),d=n.getLocalPtAt(c),u=s.clone();u.setOrigin(d.toXY());const h=new l.Arc2d(u,t.getA(),t.getB(),!0,[0,v.CONST.PI2]),g=y.CurveCurveIntersect.curve2ds(a,h);if(0===g.length)return[];const f=[];for(const e of g){const t=n.getWorldPtAt(e.point),r={curve:new p.Line3d(t,i,[-v.CONST.MODEL_MAX_LENGTH,v.CONST.MODEL_MAX_LENGTH])};f.push(r)}return f}const c=v.CONST.MODEL_MAX_LENGTH,u=new p.Line3d(e.getCoord().getOrigin(),i,[-c,c]),h=new p.Line3d(t.getCoord().getOrigin(),a,[-c,c]),g=y.CurveCurveIntersect.curve3ds(u,h);if(g.length>0&&e.isEqualAB()&&t.isEqualAB()){const n=e.getA(),r=t.getA();if(E.Util.isNearlyEqual(n,r)){const e=g[0].point,t=i.added(a).normalize(),o=i.subtracted(a).normalize(),c=t.cross(o),l=t.dot(i),u=n/Math.sqrt(1-l*l),h=n/l,f=new s.Coordinate3(e,t,c),p=new d.Arc3d(f,u,n,[0,v.CONST.PI2]),_=new s.Coordinate3(e,o,c);return[{curve:p},{curve:new d.Arc3d(_,h,r,[0,v.CONST.PI2])}]}}}static _cylinderCone(e,t,n){if(!e.isEqualAB()||!t.isEqualAB())return this._ellipseCylinderCone(e,t,n);const r=e.getCenterAxis(),i=t.getCenterAxis();if(r.isParallel(i)){const n=e.getCoord().getOrigin(),o=t.getCoord().getOrigin();if(o.subtracted(n).isParallel(r)){const n=e.getA(),r=n/t.getA()*t.getH(),a=o.added(i.multiplied(t.getH()-r)),c=new s.Coordinate3(a,i);return[{curve:new d.Arc3d(c,n,n,[0,v.CONST.PI2])}]}}}static _cylinderSphere(e,t,n){if(!e.isEqualAB()&&!t.isEqualABC())return;const r=e.getCoord(),o=new p.Line3d(r.getOrigin(),r.getDz(),i.Interval.infinitArray()),a=t.getCenter(),c=o.getParamAt(a),l=o.getPtAt(c);if(a.sqDistanceTo(l)>n.lengthEps2)return;const u=e.getA(),h=t.getA(),g=u*u,f=h*h;if(f<g-n.lengthEps2)return[];if(f>g+n.lengthEps2){const e=Math.sqrt(f-g),t=o.getPtAt(c-e),n=o.getPtAt(c+e),i=new s.Coordinate3(t,r.getDz()),a=new s.Coordinate3(n,r.getDz());return[{curve:new d.Arc3d(i,u,u)},{curve:new d.Arc3d(a,u,u)}]}const _=new s.Coordinate3(l,r.getDz());return[{curve:new d.Arc3d(_,u,u)}]}static _coneCone(e,t,n){if(!e.isEqualAB()||!t.isEqualAB())return this._ellipseConeCone(e,t,n);const r=e.getCoord(),i=t.getCoord(),a=r.getDz(),c=i.getDz(),l=e.getApexPoint(),u=t.getApexPoint(),h=l.subtracted(u),g=h.normalized();if(h.getSqLength()>o.Tolerance.LENGTH_EPS*o.Tolerance.LENGTH_EPS){const n=Math.atan(e.getA()/e.getH()),r=Math.atan(t.getA()/t.getH()),s=Math.acos(a.dot(c)),i=g.reversed(),o=Math.acos(a.dot(g)),l=Math.acos(c.dot(i));if(o>n&&l>r&&n+r<=s)return[];if(o<n&&n-r>=s)return[];if(l<r&&r-n>=s)return[]}const f=r.getOrigin().subtracted(i.getOrigin());if(a.isParallel(c)){if(l.equals(u)){return[{point:l}]}if(a.isParallel(f)){const n=e.getA()/e.getH(),r=t.getA()/t.getH();let i;const o=h.getLength();i=a.dot(c)<0?n*r*o/(n+r):n*r*o/Math.abs(n-r);const u=l.subtracted(a.multiplied(i/n)),g=new s.Coordinate3(u,a);return[{curve:new d.Arc3d(g,i,i,[0,v.CONST.PI2])}]}const n=e.getA()/e.getH(),r=t.getA()/t.getH();if(E.Util.isNearlyEqual(n,r)){const e=a.dot(g),t=1/Math.sqrt(n*n+1);if(E.Util.isNearlyEqual(e,t)){let e;e=a.dot(c)<0?new p.Line3d(l,g,[-h.getLength(),0]):a.dot(c)>0?new p.Line3d(u,g,[-v.CONST.MODEL_MAX_LENGTH,0]):new p.Line3d(l,g,[-v.CONST.MODEL_MAX_LENGTH,0]);return[{curve:e}]}if(a.dot(c)<0){const t=u.added(l).multiply(.5),r=a.cross(g),i=h.getLength(),o=i*e,f=Math.sqrt(i*i-o*o),p=.5*(o*n-f),_=h.subtracted(a.multiplied(o)).normalize(),m=h.multiply(.5).added(_.multiplied(p)).added(c.multiplied(p/n)),E=new s.Coordinate3(t,m,r),P=m.getLength(),y=o*n/2,C=Math.sqrt(y*y-f*f/4);return[{curve:new d.Arc3d(E,P,C,[0,v.CONST.PI2])}]}}}h.getSqLength(),o.Tolerance.LENGTH_EPS,o.Tolerance.LENGTH_EPS}static _ellipseCylinderCone(e,t,n){}static _cylinderSweepSurface(e,t,n){const s=e.getCoord(),o=t.getPath();if(o instanceof p.Line3d){if(!s.getDz().isParallel(o.getDirection()))return;const n=t.getIsoCurve(o.getRange().getMid(),!0),i=new m.Plane(s).getCurve2d(n),c=new l.Arc2d(new r.Coordinate2(a.Vector2.O(),a.Vector2.X()),e.getA(),e.getB(),!0),d=y.CurveCurveIntersect.curve2ds(c,i);if(0===d.length)return[];const u=[];for(const t of d){const n={curve:e.getIsoCurve(t.param1,!1)};u.push(n)}return u}if(o instanceof d.Arc3d&&o.isEqualAB()&&e.isEqualAB()){const n=o.getCoord();if(!n.getDz().isParallel(t.getPathDz()))return;const r=new p.Line3d(s.getOrigin(),s.getDz(),i.Interval.infinitArray()),a=new p.Line3d(n.getOrigin(),n.getDz(),i.Interval.infinitArray());if(b.CurveCurveColinear.curve3ds(r,a)){const n=o.getMidPt(),r=e.getUVAt(n),s=e.getIsoCurve(r.x,!1),i=t.getIsoCurve(o.getRange().getMid(),!0),a=y.CurveCurveIntersect.curve3ds(s,i);if(0===a.length)return[];const c=[];for(const t of a){const n=e.getUVAt(t.point),r={curve:e.getIsoCurve(n.y,!0)};c.push(r)}return c}}const c=[],u=new p.Line3d(s.getOrigin(),s.getDz(),i.Interval.infinitArray()),h=y.CurveCurveIntersect.curve3ds(u,o,n);for(const r of h){if(!o.getTangentAt(r.param2).isParallel(s.getDz(),n.angleEps))return;const i=e.getIsoCurve(r.param1,!0),a=t.getIsoCurve(r.param2,!0),l=N.CalculateOverlap.curve3ds(i,a,n);if(1!==l.length)return;i.setRange(l[0].range1);const d={curve:i};c.push(d)}if(c.length>0)return c;o instanceof T.ExtendCurve3d&&e.isEqualAB()}static _sphereSweepSurface(e,t,n){if(!t.getProfile().isArc2d())return;const r=e.getCenter(),s=t.getPath(),i=s.getParamAt(r);if(s.getPtAt(i).sqDistanceTo(r)>n.lengthEps2||!s.getRange().containsPoint(i,n.numberEps))return;const o=t.getIsoCurve(i,!0);if(!o.isArc3d())return;if(o.isEqualAB()&&e.isEqualABC()){if(Math.abs(o.getRadius()-e.getRadius())<n.lengthEps){return[{curve:o}]}return[]}let a=!0;const c=[o.getPtAt(0),o.getPtAt(v.CONST.PI_4),o.getPtAt(v.CONST.PI_2)];for(const t of c)if(!e.containsPoint(t,n.lengthEps)){a=!1;break}if(a){return[{curve:o}]}}static _ellipseConeCone(e,t,n){const r=e.getCoord(),i=t.getCoord(),o=r.getDz(),a=i.getDz(),c=e.getApexPoint(),u=t.getApexPoint(),h=u.subtracted(c),g=h.normalized();if(h.getSqLength()>n.lengthEps2){let n=e.getA(),r=e.getB();if(n<r){const e=n;n=r,r=e}let s=e.getA(),i=e.getB();if(s<i){const e=s;s=i,i=e}const c=Math.atan(n/e.getH()),l=Math.atan(s/t.getH()),d=Math.acos(o.dot(a)),u=g.reversed(),h=Math.acos(o.dot(u)),f=Math.acos(a.dot(g));if(h>c&&f>l&&c+l<=d)return[];const p=Math.atan(r/e.getH());if(h<p&&p-l>=d)return[];const _=Math.atan(i/t.getH());if(f<_&&_-c>=d)return[]}const f=r.getOrigin().subtracted(r.getOrigin());if(o.isParallel(a)){if(c.equals(u)){const e=new l.Arc2d,t=new l.Arc2d,n=y.CurveCurveIntersect.curve2ds(e,t);if(0===n.length)return[];const s=[];for(const e of n){const t=e.point,n=r.getWorldPtAt(t).subtracted(c).normalize(),i={curve:new p.Line3d(c,n,[0,v.CONST.MODEL_MAX_LENGTH])};s.push(i)}return s}if(o.isParallel(f)&&(r.getDx().isParallel(i.getDx())||r.getDx().isParallel(i.getDy()))){let n,l;r.getDx().isParallel(i.getDx())?(n=t.getB(),l=t.getA()):(n=t.getA(),l=t.getB());const u=e.getB()/e.getH(),f=e.getA()/e.getH(),p=n/t.getH(),_=l/t.getH();if(o.dot(a)>0){if(o.dot(g)>0&&u<=p&&f<=_)return[];if(o.dot(g)<0&&u>=p&&f>=_)return[]}if(E.Util.isNearlyEqual(e.getA()/e.getB(),l/n)){if((()=>o.dot(a)<0&&o.dot(g)<0||o.dot(a)>0&&o.dot(g)*(f-_)>0)()){let t;const n=h.getLength();t=o.dot(a)<0?f*_*n/(f+_):f*_*n/Math.abs(f-_);const r=t*(e.getB()/e.getA()),i=c.subtracted(o.multiplied(t/f)),l=new s.Coordinate3(i,o);return[{curve:new d.Arc3d(l,t,r,[0,v.CONST.PI2])}]}}}}}static _sweepSweepSurface(e,t,n){const r=e.getProfile(),s=t.getProfile(),i=e.getPathDz(),o=t.getPathDz();if(i.isParallel(o,n.angleEps)&&b.CurveCurveColinear.curve2ds(r,s,n)){const r=e.getPath(),s=t.getPath(),i=y.CurveCurveIntersect.curve3ds(r,s,n);if(i){const t=[];for(const o of i){if(o.isOverlap)return;const i=r.getTangentAt(o.param1),a=s.getTangentAt(o.param2);if(!i.isParallel(a,n.angleEps))return;{const n={curve:e.getIsoCurve(o.param1,!0)};t.push(n)}}return t}}}}},33789:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurfaceSurfaceIntersectUtil=void 0;const r=n(60229),s=n(97505),i=n(6688),o=n(56973),a=n(81658),c=n(737),l=n(24013),d=n(61226),u=n(274),h=n(5804),g=n(29453),f=n(87222),p=n(68238),_=n(47423),m=n(11042),v=n(19516),E=n(49246),P=n(44757),y=n(26773),C=n(4097),S=n(83925);var T;!function(e){e[e.ON_AND_NEXT_OUTBOUNDARY=0]="ON_AND_NEXT_OUTBOUNDARY",e[e.NEXT_OUT_BOUNDARY=1]="NEXT_OUT_BOUNDARY",e[e.NOT_OUT_BOUNDARY=-1]="NOT_OUT_BOUNDARY"}(T||(T={}));t.SurfaceSurfaceIntersectUtil=class{constructor(e,t,n=new o.Tolerance,r,s){this._surface=[e,t],this._tol=n,this._initBoudaryUVs(0,r),this._initBoudaryUVs(1,s)}calAllIntersects(e,t,n,r,s=!1){if(this._surface.length<2)return[];const i=new a.SurfacePatch(this._surface[0]),o=new a.SurfacePatch(this._surface[1]);this._initSurfacePatch(this._surface[0],i),this._initSurfacePatch(this._surface[1],o),e&&t&&n&&r?(i.rangeU=e,i.rangeV=t,o.rangeU=n,o.rangeV=r):this._shrinkSurfacePatchRanges(this._surface[0],this._surface[1],i,o);const c=i.getPatchBox3d(),l=o.getPatchBox3d();if(!c.intersectsBox(l))return[];const d=[],u=[];d.push(i),u.push(o);const h=[],g={patch1:i,patch2:o};h.push(g);const f=this._surfacePatchsIntersectPoints(d,u,h);this._useHighPrecision=s;const p=[];for(const e of f){const t=this._calTwoSurfaceSingleIntersect(e,f);t&&p.push(t)}return p}calSingleIntersect(e,t,n=!1){const r=this.findSurfaceIntersectPoint(e);if(!r)return;this._useHighPrecision=n;return this._calTwoSurfaceSingleIntersect(r,[],t)}findSurfaceIntersectPoint(e){const t=new a.SurfacePatch(this._surface[0]);t.rangeU=this._surf1BoundaryUVs.rangeU?this._surf1BoundaryUVs.rangeU:this._surface[0].getDomainU(),t.rangeV=this._surf1BoundaryUVs.rangeV?this._surf1BoundaryUVs.rangeV:this._surface[0].getDomainV();const n=new a.SurfacePatch(this._surface[1]);n.rangeU=this._surf2BoundaryUVs.rangeU?this._surf2BoundaryUVs.rangeU:this._surface[1].getDomainU(),n.rangeV=this._surf2BoundaryUVs.rangeV?this._surf2BoundaryUVs.rangeV:this._surface[1].getDomainV();const r={patch1:t,patch2:n},s={uvPara1:this._surface[0].getUVAt(e),uvPara2:this._surface[1].getUVAt(e)};let i=this._calcSurfacePatchPairIntersectPoint(r,s);return void 0===i&&(i=this._calcSurfacePatchPairIntersectPoint(r,s,!1)),i}calSingleSelfIntersect(e,t,n,r=!1){const s=new a.SurfacePatch(this._surface[0]);s.rangeU=this._surf1BoundaryUVs.rangeU?this._surf1BoundaryUVs.rangeU:this._surface[0].getDomainU(),s.rangeV=this._surf1BoundaryUVs.rangeV?this._surf1BoundaryUVs.rangeV:this._surface[0].getDomainV();const i=new a.SurfacePatch(this._surface[1]);i.rangeU=this._surf2BoundaryUVs.rangeU?this._surf2BoundaryUVs.rangeU:this._surface[1].getDomainU(),i.rangeV=this._surf2BoundaryUVs.rangeV?this._surf2BoundaryUVs.rangeV:this._surface[1].getDomainV();const o={patch1:s,patch2:i},c={uvPara1:e,uvPara2:t};let l=this._calcSurfacePatchPairIntersectPoint(o,c);if(void 0===l&&(l=this._calcSurfacePatchPairIntersectPoint(o,c,!1)),!l)return;this._useHighPrecision=r;return this._calTwoSurfaceSingleIntersect(l,[],n)}_initBoudaryUVs(e,t){const n=this._surface[e],r=e=>!!(e instanceof y.PeriodInterval&&E.Util.isNearlyEqual(e.getLength(),e.period));let s,i;if(n instanceof _.SweepSurface){const e=n.getDomainU();r(e)||(s=e);const t=n.getDomainV();r(t)||(i=t)}else n instanceof c.NurbsSurface?(s=n.getDomainU(),i=n.getDomainV()):n instanceof l.Cone||n instanceof g.Cylinder||n instanceof S.Sphere?i=n.getDomainV():n instanceof h.Plane&&(s=n.getDomainU(),i=n.getDomainV());const o=(e,t)=>{if(void 0===e&&void 0===t)return;if(void 0!==e&&void 0!==t){const n=e.intersected(t);return 0===n.length?void P.MathAssert.warn(!1,"Interval intersected result is empty"):n[0]}return e||t};t&&t.length>1&&(r(t[0])||(s=o(s,t[0])),r(t[1])||(i=o(i,t[1]))),0===e?this._surf1BoundaryUVs={rangeU:s,rangeV:i}:1===e&&(this._surf2BoundaryUVs={rangeU:s,rangeV:i})}_initSurfacePatch(e,t){t.depth=0}_shrinkSurfacePatchRangesByAnotherSurfaceBox(e,t){const n=t.surface;if(n.getType()===s.EN_GEO_ELEMENT_TYPE.EN_PLANE){const s=n,o=[r.CONST.MODEL_MAX_LENGTH,-r.CONST.MODEL_MAX_LENGTH],a=[r.CONST.MODEL_MAX_LENGTH,-r.CONST.MODEL_MAX_LENGTH];for(const t of e.getCornerPts()){const e=s.getUVAt(t);e.x>o[1]&&(o[1]=e.x),e.x<o[0]&&(o[0]=e.x),e.y>a[1]&&(a[1]=e.y),e.y<a[0]&&(a[0]=e.y)}t.rangeU=new i.Interval(o[0],o[1]),t.rangeV=new i.Interval(a[0],a[1])}else{let o;if(t.rangeU=new i.Interval(0,r.CONST.PI2),n.getType()===s.EN_GEO_ELEMENT_TYPE.EN_CYLINDER){const e=n,t=e.getCoord().getDz();o=new f.Line3d(e.getCoord().getOrigin(),t,i.Interval.infinitArray())}else{const e=n,t=e.getCoord().getDz();o=new f.Line3d(e.getCoord().getOrigin(),t,i.Interval.infinitArray())}const a=[r.CONST.MODEL_MAX_LENGTH,-r.CONST.MODEL_MAX_LENGTH];for(const t of e.getCornerPts()){const e=o.getParamAt(t);e>a[1]&&(a[1]=e),e<a[0]&&(a[0]=e)}t.rangeV=new i.Interval(a[0],a[1])}}_isSurfaceRangeUVFinite(e){const t=e=>{if(e.isPlane()||e.isCylinder()||e.isCone())return!1;if(e.isSphere()||e.isNurbsSurface())return!1;if(e.isSweepSurface()){const t=e.getPath(),n=e.getProfile();return!t.isExtendCurve()&&!n.isExtendCurve()}return!1};return e.isOffsetSurface()?t(e.getBaseSurface()):t(e)}_shrinkSurfacePatchRanges(e,t,n,o){if(this._isSurfaceRangeUVFinite(e)&&this._isSurfaceRangeUVFinite(t))n.rangeU=e.getDomainU(),n.rangeV=e.getDomainV(),o.rangeU=t.getDomainU(),o.rangeV=t.getDomainV();else if(this._isSurfaceRangeUVFinite(e)&&!this._isSurfaceRangeUVFinite(t)||!this._isSurfaceRangeUVFinite(e)&&this._isSurfaceRangeUVFinite(t))if(this._isSurfaceRangeUVFinite(e)){n.rangeU=e.getDomainU(),n.rangeV=e.getDomainV();const t=e.getBox();this._shrinkSurfacePatchRangesByAnotherSurfaceBox(t,o)}else{o.rangeU=t.getDomainU(),o.rangeV=t.getDomainV();const e=t.getBox();this._shrinkSurfacePatchRangesByAnotherSurfaceBox(e,n)}else if(e.isCylinder()&&t.isCylinder()){const s=e,a=t,c=s.getCoord().getDz(),l=a.getCoord().getDz(),u=new f.Line3d(s.getCoord().getOrigin(),c,i.Interval.infinitArray()),h=new f.Line3d(a.getCoord().getOrigin(),l,i.Interval.infinitArray()),g=new d.Vector3,_=new d.Vector3;p.CalculateDistance.curve3dToCurve3d(u,h,g,_);const m=u.getParamAt(g),v=h.getParamAt(_),E=c.dot(l),P=Math.sqrt(1-E*E),y=((s.getA()>s.getB()?s.getA():s.getB())+(a.getA()>a.getB()?a.getA():a.getB()))/P;n.rangeU=new i.Interval(0,r.CONST.PI2),n.rangeV=new i.Interval(m-y,m+y),o.rangeU=new i.Interval(0,r.CONST.PI2),o.rangeV=new i.Interval(v-y,v+y)}else if(e.isCylinder()&&t.isCone()||t.isCylinder()&&e.isCone()){if(e.getType()===s.EN_GEO_ELEMENT_TYPE.EN_CONE){const t=e;n.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,t.getH()),o.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH)}else{const e=t;o.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,e.getH()),n.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH)}n.rangeU=new i.Interval(0,r.CONST.PI2),o.rangeU=new i.Interval(0,r.CONST.PI2)}else if(e.isCone()&&t.isCone()){const s=e;n.rangeU=new i.Interval(0,r.CONST.PI2),n.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,s.getH());const a=t;o.rangeU=new i.Interval(0,r.CONST.PI2),o.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,a.getH())}else{if(!(e.isPlane()&&t.isCone()||e.isCone()&&t.isPlane()))throw new Error("unexpected surface type");if(e.getType()===s.EN_GEO_ELEMENT_TYPE.EN_PLANE){n.rangeU=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH),n.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH);const e=t;o.rangeU=new i.Interval(0,r.CONST.PI2),o.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,e.getH())}else{const t=e;n.rangeU=new i.Interval(0,r.CONST.PI2),n.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,t.getH()),o.rangeU=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH),o.rangeV=new i.Interval(-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH)}}}_surfacePatchsIntersectPoints(e,t,n){let s=[],i=0;for(;i<r.CONST.MAX_SUBDEVIDE_DEPTH;){e.map((e=>a.SurfacePatch.subdivideSurfacePatch(e))),t.map((e=>a.SurfacePatch.subdivideSurfacePatch(e)));if(!this._combineSurfacePatchPairs(n,s))break;this._FilterSurfacePatchPairs(s),this._refreshSurfacePatchs(s,e,t),n.splice(0),n.push(...s),s=[],i++}const o=[];for(const e of n){const t=this._calcSurfacePatchPairIntersectPoint(e);if(t){let e=!1;for(const n of o)if(n.point.equals(t.point)){e=!0;break}e||o.push(t)}}return o}_combineSurfacePatchPairs(e,t){let n=!1;for(const r of e){if(0===r.patch1.child.length&&0===r.patch2.child.length){t.push(r);continue}const e=r.patch1.child.length>1?r.patch1.child:[r.patch1],s=r.patch2.child.length>1?r.patch2.child:[r.patch2];for(const n of e)for(const e of s){const r={patch1:n,patch2:e};t.push(r)}n=!0}return n}_FilterSurfacePatchPairs(e){for(let t=0;t<e.length;t++){const n=e[t],r=n.patch1,s=n.patch2,i=r.getPatchBox3d(),o=s.getPatchBox3d();i.intersectsBox(o)||(e.splice(t,1),t--)}}_refreshSurfacePatchs(e,t,n){const r=new Set,s=new Set;for(const t of e)r.add(t.patch1),s.add(t.patch2);t.splice(0),t.push(...r),n.splice(0),n.push(...s)}_calcSurfacePatchPairIntersectPoint(e,t,n=!0){const r=e.patch1,s=e.patch2,i=r.surface,o=s.surface;let a;if(t)a=[t.uvPara1,t.uvPara2],i.clampInDomain(a[0]),o.clampInDomain(a[1]);else{a=[{x:r.rangeU.getMid(),y:r.rangeV.getMid()},{x:s.rangeU.getMid(),y:s.rangeV.getMid()}]}const c=(e,t)=>{if(e instanceof y.PeriodInterval){const n=y.PeriodInterval.RegularizeParam(t,e.period);return n<e.min-this._tol.numberEps||n>e.max+this._tol.numberEps?n+e.period:n}return t};if(m.surfaceSurfaceIteration(i,o,a,this._tol.lengthEps,n)){if(r.rangeU.containsPoint(a[0].x,this._tol.numberEps)&&r.rangeV.containsPoint(a[0].y,this._tol.numberEps)&&s.rangeU.containsPoint(a[1].x,this._tol.numberEps)&&s.rangeV.containsPoint(a[1].y,this._tol.numberEps)){const e=r.surface.getPtAt(a[0]),t=s.surface.getPtAt(a[1]);return a[0].x=c(r.rangeU,a[0].x),a[0].y=c(r.rangeV,a[0].y),a[1].x=c(s.rangeU,a[1].x),a[1].y=c(s.rangeV,a[1].y),{point:e.midTo(t),uvPara1:a[0],uvPara2:a[1]}}if(r.surface.isSphere()&&s.rangeU.containsPoint(a[1].x,this._tol.numberEps)&&s.rangeV.containsPoint(a[1].y,this._tol.numberEps)){const e=r.surface.getPtAt(a[0]),t=s.surface.getPtAt(a[1]),n=e.midTo(t);return a[0]=r.surface.getUVAt(n),a[1].x=c(s.rangeU,a[1].x),a[1].y=c(s.rangeV,a[1].y),{point:n,uvPara1:a[0],uvPara2:a[1]}}if(r.rangeU.containsPoint(a[0].x,this._tol.numberEps)&&r.rangeV.containsPoint(a[0].y,this._tol.numberEps)&&s.surface.isSphere()){const e=r.surface.getPtAt(a[0]),t=s.surface.getPtAt(a[1]),n=e.midTo(t);return a[0].x=c(r.rangeU,a[0].x),a[0].y=c(r.rangeV,a[0].y),a[1]=s.surface.getUVAt(n),{point:n,uvPara1:a[0],uvPara2:a[1]}}}const l=i.getPtAt(a[0]),d=o.getPtAt(a[1]),u=.01;if(l.sqDistanceTo(d)<1e-4){let e;const t=this._surf1BoundaryUVs;if(t.rangeU&&(E.Util.isNearlyEqual(t.rangeU.min,a[0].x,u)?e=this._surface[0].getIsoCurve(t.rangeU.min,!1):E.Util.isNearlyEqual(t.rangeU.max,a[0].x,u)&&(e=this._surface[0].getIsoCurve(t.rangeU.max,!1))),t.rangeV&&(E.Util.isNearlyEqual(t.rangeV.min,a[0].y,u)?e=this._surface[0].getIsoCurve(t.rangeV.min,!1):E.Util.isNearlyEqual(t.rangeV.max,a[0].y,u)&&(e=this._surface[0].getIsoCurve(t.rangeV.max,!1))),e){const t=v.CurveSurfaceIntersect.nearPoint(e,o,l);if(t&&t.point.sqDistanceTo(l)<1e-4){const e=i.getUVAt(t.point);return{point:t.point,uvPara1:e,uvPara2:t.surfaceUV}}}let n;const r=this._surf2BoundaryUVs;if(r.rangeU&&(E.Util.isNearlyEqual(r.rangeU.min,a[1].x,u)?n=this._surface[1].getIsoCurve(r.rangeU.min,!1):E.Util.isNearlyEqual(r.rangeU.max,a[1].x,u)&&(n=this._surface[1].getIsoCurve(r.rangeU.max,!1))),r.rangeV&&(E.Util.isNearlyEqual(r.rangeV.min,a[1].y,u)?n=this._surface[1].getIsoCurve(r.rangeV.min,!1):E.Util.isNearlyEqual(r.rangeV.max,a[1].y,u)&&(n=this._surface[1].getIsoCurve(r.rangeV.max,!1))),n){const e=v.CurveSurfaceIntersect.nearPoint(n,i,l);if(e&&e.point.sqDistanceTo(l)<1e-4){const t=o.getUVAt(e.point);return{point:e.point,uvPara1:e.surfaceUV,uvPara2:t}}}}}_removeInitialIntersectPts(e,t,n){for(let r=0;r<t.length;r++)e.point.sqDistanceTo(t[r].point)<n&&(t.splice(r,1),r--)}_calTwoSurfaceSingleIntersect(e,t,n){const s=new u.IntersectCurve3d(this._surface),i=s.getIntersectPtsChart();i.push(e);let o=1,a=e,c=0;for(;i.length<r.CONST.MAX_INTERSECTION_NUM;){const r=this._calcNextInterscetPointInfo(a,s,o,n);if(r.isArriveBoundary===T.ON_AND_NEXT_OUTBOUNDARY)break;const l=r.newIntCurvPt;if(!l)return;let d;if(1===i.length?(c=e.point.sqDistanceTo(l.point),d=c):d=a.point.sqDistanceTo(l.point),t.length>0&&this._removeInitialIntersectPts(l,t,d),d<this._tol.lengthEps*this._tol.lengthEps)break;if(i.push(l),a=l,l.point.sqDistanceTo(e.point)<c){i.push(e),s.updateKonts();return{curve:s}}if(r.isArriveBoundary===T.NEXT_OUT_BOUNDARY)break}for(o=-1,i.reverse(),a=e;i.length<r.CONST.MAX_INTERSECTION_NUM;){const e=this._calcNextInterscetPointInfo(a,s,o,n);if(e.isArriveBoundary===T.ON_AND_NEXT_OUTBOUNDARY)break;const r=e.newIntCurvPt;if(!r)return;const c=a.point.sqDistanceTo(r.point);if(t.length>0&&this._removeInitialIntersectPts(r,t,c),c<this._tol.lengthEps*this._tol.lengthEps)break;if(i.push(r),a=r,e.isArriveBoundary===T.NEXT_OUT_BOUNDARY)break}i.reverse(),s.updateKonts();return{curve:s}}_estimateNewIntersectPt(e,t,n=1){let s;const i=10*r.CONST.MODEL_MAX_LENGTH,o=1/(6*(this._useHighPrecision?2:1)*t[2].getLength());if(o>i){const r=i;s=e.point.added(t[1].multiplied(n*r))}else{let r=o;o>50&&(r=Math.sqrt(o-50)+50),s=e.point.added(t[1].multiplied(n*r)).add(t[2].multiplied(r*r/2))}return s}_calcNextInterscetPointInfo(e,t,n,s){let i;const a=t.getIntersectPtsChart();if(a.length<2)s&&(i=s.normalized());else{const t=a[a.length-2].point;i=e.point.subtracted(t).normalize(),i.multiply(n)}const c=t.getDerivativesAtPt(e,2,n>0,i);let l;if(3===c.length)l=this._estimateNewIntersectPt(e,c,n);else{if(c.length<2){c[0]=e.point;const t=this._surface[0].getNormAt(e.uvPara1),n=this._surface[1].getNormAt(e.uvPara2);let r;if(r=t.equals(n)?t.added(n).multiply(.5):t.subtracted(n).multiply(.5),!i)throw new Error("防御了这么多层，还出问题，简直绝了！");const s=i.cross(r);s.getSqLength()<o.Tolerance.LENGTH_EPS2?c[1]=i:c[1]=r.cross(s).normalize()}if(a.length<2){C.MathError.warn("可能是曲面重合了！");const t=this._surface[0].getDerivatives(e.uvPara1,2),s=this._surface[1].getDerivatives(e.uvPara2,2);let i=r.CONST.MAX_INTEGER;const a=[t[3],t[4],t[5],s[3],s[4],s[5]];for(const e of a){const t=e.getSqLength();t<o.Tolerance.EDGE_LENGTH_EPS||t<i&&(i=t)}const d=Math.sqrt(i)/10,u=Math.min(d,50);l=e.point.added(c[1].multiplied(n*u))}else{const t=a[a.length-2].point,r=e.point.subtracted(t).getLength();l=e.point.added(c[1].multiplied(n*r))}}const d=this._tol.lengthEps*this._tol.lengthEps*1e4,u=this._adjustEstimatedPtByBoundary(e,c,l,n);if(u){let t=T.NEXT_OUT_BOUNDARY;return u.point.sqDistanceTo(e.point)<d&&(t=T.ON_AND_NEXT_OUTBOUNDARY),{isArriveBoundary:t,newIntCurvPt:u}}const h=(e,t,n)=>{const r=e.getDerivatives(t,1),s=n.subtracted(r[0]),i=r[1].getLength(),o=r[2].getLength(),a=s.dot(r[1].normalized()),c=t.x+a/i,l=s.dot(r[2].normalized());return{x:c,y:t.y+l/o}},g={pt:l,uv1:h(this._surface[0],e.uvPara1,l),uv2:h(this._surface[1],e.uvPara2,l)},f=this._refineNewIntersectPtIteratively(g,e.point);return{isArriveBoundary:T.NOT_OUT_BOUNDARY,newIntCurvPt:f}}_estimateSurfaceUV(e,t,n){const r=t.subtracted(e[0]),s=e[1].getLength(),i=e[2].getLength(),o=r.dot(e[1].normalized()),a=n.x+o/s,c=r.dot(e[2].normalized());return{x:a,y:n.y+c/i}}_estimateCurveT(e,t,n){const r=e.getDerivatives(n,1),s=t.subtracted(r[0]),i=r[1].getLength();return n+s.dot(r[1].normalized())/i}_adjustEstimatedPtByBoundary(e,t,n,s=1){const i=n.subtracted(e.point),o=i.normalized(),a=i.getLength(),c=100*this._tol.lengthEps,l=(e,t,s)=>{const i={arriveBoundary:!1,newStepLength:r.CONST.MAX_INTEGER},l=0===e?this._surf1BoundaryUVs:this._surf2BoundaryUVs;if(!l.rangeU&&!l.rangeV)return i;const d=100*c,u=this._estimateSurfaceUV(s,n,t);if(l.rangeU){const e=o.dot(s[1].normalized());if(Math.abs(e)>d/a){const e=d/s[1].getLength();E.Util.isNearlyBiggerOrEqual(u.x,l.rangeU.max,e)?(i.newStepLength=Math.abs((l.rangeU.max-t.x)/(u.x-t.x))*a,i.arriveBoundary=!0,i.isArriveVBound=!1,i.boundParam=l.rangeU.max):E.Util.isNearlySmallerOrEqual(u.x,l.rangeU.min,e)&&(i.newStepLength=Math.abs((t.x-l.rangeU.min)/(t.x-u.x))*a,i.arriveBoundary=!0,i.isArriveVBound=!1,i.boundParam=l.rangeU.min)}}if(l.rangeV){const e=o.dot(s[2].normalized());if(Math.abs(e)>d/a){const e=d/s[2].getLength();if(E.Util.isNearlyBiggerOrEqual(u.y,l.rangeV.max,e)){const e=Math.abs((l.rangeV.max-t.y)/(u.y-t.y))*a;e<i.newStepLength&&(i.newStepLength=e,i.isArriveVBound=!0,i.boundParam=l.rangeV.max),i.arriveBoundary=!0}else if(E.Util.isNearlySmallerOrEqual(u.y,l.rangeV.min,e)){const e=Math.abs((t.y-l.rangeV.min)/(t.y-u.y))*a;e<i.newStepLength&&(i.newStepLength=e,i.isArriveVBound=!0,i.boundParam=l.rangeV.min),i.arriveBoundary=!0}}}return i},d=this._surface[0].getDerivatives(e.uvPara1,1),u=this._surface[1].getDerivatives(e.uvPara2,1),h=l(0,e.uvPara1,d),g=l(1,e.uvPara2,u);if(!h.arriveBoundary&&!g.arriveBoundary)return;const f=Math.min(h.newStepLength,g.newStepLength);if(f<c)return e;if(t.length<3||t[2].getLength()<this._tol.lengthEps)n.copy(e.point.added(o.multiplied(f)));else{const r=e.point.added(t[1].multiplied(s*f)).add(t[2].multiplied(f*f/2));n.copy(r)}if(h.newStepLength<=g.newStepLength){const t=this._surface[0].getIsoCurve(h.boundParam,h.isArriveVBound),r=h.isArriveVBound?e.uvPara1.x:e.uvPara1.y,s=this._estimateCurveT(t,n,r),i=this._estimateSurfaceUV(u,n,e.uvPara2),o=v.CurveSurfaceIntersect.nearParam(t,this._surface[1],s,i,this._tol);if(o){const t=this._estimateSurfaceUV(d,o.point,e.uvPara1);return{point:o.point,uvPara1:t,uvPara2:o.surfaceUV}}}else{const t=this._surface[1].getIsoCurve(g.boundParam,g.isArriveVBound),r=g.isArriveVBound?e.uvPara2.x:e.uvPara2.y,s=this._estimateCurveT(t,n,r),i=this._estimateSurfaceUV(d,n,e.uvPara1),o=v.CurveSurfaceIntersect.nearParam(t,this._surface[0],s,i,this._tol);if(o){const t=this._estimateSurfaceUV(u,o.point,e.uvPara2);return{point:o.point,uvPara1:o.surfaceUV,uvPara2:t}}}}_refineNewIntersectPtIteratively(e,t){const n=this._surface[0],r=this._surface[1];if(n.getPtAt(e.uv1).equals(e.pt)&&r.getPtAt(e.uv2).equals(e.pt)){return{point:e.pt,uvPara1:e.uv1,uvPara2:e.uv2}}const s=new a.SurfacePatch(n,[n.getDomainU(),n.getDomainV()]),i=new a.SurfacePatch(r,[r.getDomainU(),r.getDomainV()]),o={uvPara1:e.uv1,uvPara2:e.uv2},c={patch1:s,patch2:i};let l=this._calcSurfacePatchPairIntersectPoint(c,o);if(void 0===l){if(l=this._calcSurfacePatchPairIntersectPoint(c,o,!1),void 0===l)return}else if(l.point.sqDistanceTo(e.pt)>.81*t.sqDistanceTo(e.pt)){const t=this._calcSurfacePatchPairIntersectPoint(c,o,!1);void 0!==t&&l.point.sqDistanceTo(e.pt)>t.point.sqDistanceTo(e.pt)&&(l=t)}return l}}},49172:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoopArea=void 0;const r=n(10909),s=n(61226),i=n(17165),o=n(43640);class a{static areaOfPoints(e){let t=0;const n=e.length;for(let r=n-1,s=0;s<n;r=s++)t+=e[r].x*e[s].y-e[s].x*e[r].y;return.5*t}static areaOfLoop(e){let t=0;if(!e.length)return t;let n=e[0].getStartPt().clone(),s=!1;for(const t of e)t instanceof r.Arc2d&&(s?n=n.midTo(t.getCenter()):(n=t.getCenter(),s=!0));for(const r of e)t+=this._areaOfCurve2d(r,n);return t}static areaOfPoint3ds(e,t){const n=a.areaVectorOfPoint3ds(e),r=t.normalized();return n.dot(r)}static areaVectorOfPoint3ds(e){const t=s.Vector3.make(e[e.length-1]).cross(e[0]);for(let n=1;n<e.length;n++)t.add(s.Vector3.make(e[n-1]).cross(e[n]));return t.multiply(.5)}static areaVectorOfCurve3ds(e,t=o.DiscreteParameter.NORMAL){const n=[];for(const r of e)n.push(...r.discrete(t));return a.areaVectorOfPoint3ds(n)}static _areaOfCurve2d(e,t){let n=0;if(e.isLine2d()){const r=e.getStartPt().subtracted(t),s=e.getEndPt().subtracted(t);n=.5*r.cross(s)}else if(e.isArc2d()){const r=e,s=r.getA()*r.getB()*r.getRange().getLength()*(r.isCCW()?1:-1)*.5,i=a._areaOfTriangle(r.getStartPt(),r.getEndPt(),r.getCenter()),o=a._areaOfTriangle(r.getStartPt(),r.getEndPt(),t);n=s-i+o}else if(e.isSmoothPoly2d())e.getSegments().forEach((e=>{n+=this._areaOfCurve2d(e,t)}));else{const r=i.DiscreteUtil.discreteCurve2d(e,o.DiscreteParameter.NORMAL);for(let e=1;e<r.length;e++){const s=r[e-1].subtracted(t),i=r[e].subtracted(t);n+=.5*s.cross(i)}}return n}static _areaOfTriangle(e,t,n){return.5*e.subtract(n).cross(t.subtract(n))}}t.LoopArea=a},58074:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoopCentroid=void 0;const r=n(56973),s=n(49246),i=n(33218),o=n(10909),a=n(32858),c=n(61226),l=n(43640),d=n(89494);class u{static centroidOfPoints(e,t=r.Tolerance.NUMBER_EPS){let n=0,o=0,a=0;const c=e.length;for(let t=c-1,r=0;r<c;t=r++){const s=e[t].x*e[r].y-e[r].x*e[t].y;n+=s,o+=(e[t].x+e[r].x)*s,a+=(e[t].y+e[r].y)*s}if(s.Util.isNearlyEqual(n,0,t))return new i.Vector2(o,a);const l=3*n;return o/=l,a/=l,new i.Vector2(o,a)}static centroidOfLoop(e,t=r.Tolerance.LENGTH_EPS){if(!e.length)return new i.Vector2;let n=0,s=0,o=0;const a=e[0].getStartPt(),c={x:a.x,y:a.y};for(const t of e){const e=this._integralForCurve2d(t,c);s+=e.x,o+=e.y,n+=e.area}return Math.abs(n)<t?e[0].getStartPt():(s/=n,o/=n,new i.Vector2(s,o).add(c))}static centroidOfPoint3ds(e,t=r.Tolerance.LENGTH_EPS){return u.centroidInfoOfPoint3ds(e,t).centroid}static centroidInfoOfPoint3ds(e,t=r.Tolerance.LENGTH_EPS){const n=c.Vector3.O(),s=c.Vector3.O(),i=c.Vector3.O(),o=c.Vector3.O(),a=(t,r)=>{const a=e[t],l=e[r],d=c.Vector3.make(a).cross(l);n.add(d),s.add(d.multiplied(a.x+l.x)),i.add(d.multiplied(a.y+l.y)),o.add(d.multiplied(a.z+l.z))};a(e.length-1,0);for(let t=1;t<e.length;t++)a(t-1,t);const l=n.getLength();if(l<t){const t=new c.Vector3(e[0],e[1]).cross(new c.Vector3(e[1],e[2]));return{centroid:new c.Vector3(e[0]),area:0,areaNormal:t}}const u=n.multiplied(1/l),h=new d.Coordinate3(c.Vector3.O(),u),g=u.multiplied(1/(3*l)),f=new c.Vector3(s.dot(g),i.dot(g),o.dot(g)),p=h.getLocalVectorAt(f);p.z*=1.5;return{centroid:h.getWorldVectorAt(p),area:.5*l,areaNormal:u}}static centroidOfCurve3ds(e,t=l.DiscreteParameter.HIGH,n=r.Tolerance.LENGTH_EPS){return u.centroidInfoOfCurve3ds(e,t,n).centroid}static centroidInfoOfCurve3ds(e,t=l.DiscreteParameter.HIGH,n=r.Tolerance.LENGTH_EPS){const s=[];for(const n of e)s.push(...n.discrete(t));return u.centroidInfoOfPoint3ds(s,n)}static _integralForCurve2d(e,t){if(e instanceof a.Line2d)return this._integralForLine2d(e.getStartPt(),e.getEndPt(),t);if(e instanceof o.Arc2d)return this._integralForArc2d(e,t);const n=e.discrete(l.DiscreteParameter.CALCULATE);return u._integralForPoints(n,t)}static _integralForLine2d(e,t,n){const r=e.x-n.x,s=e.y-n.y,i=t.x-n.x,o=t.y-n.y,a=(r*o-s*i)/2;return{area:a,x:(r+i)*a/3,y:(s+o)*a/3}}static _integralForPoints(e,t){let n=0,r=0,s=0;for(let i=1;i<e.length;i++){const o=this._integralForLine2d(e[i-1],e[i],t);r+=o.x,s+=o.y,n+=o.area}return{x:r,y:s,area:n}}static _integralForArc2d(e,t){const n=e.getRange(),r=n.getLength()/2,s=e.getA(),i=e.getB(),o=2*Math.sin(r)/(3*r),a=n.getMid(),c=e.isCCW()?1:-1,l=Math.cos(a)*o*s,d=Math.sin(a)*o*i*c,h=e.getCoord().getWorldPtAt({x:l,y:d}).subtract(t),g=s*i*r*(e.isCCW()?1:-1),f=u._integralForPoints([e.getStartPt(),e.getCenter(),e.getEndPt()],t);return f.x+=h.x*g,f.y+=h.y*g,f.area+=g,f}}t.LoopCentroid=u},22289:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HalfPlane=void 0;const r=n(32858),s=n(33218);class i{constructor(e,t){if("number"==typeof t.x){this.w={x:e.y-t.y,y:t.x-e.x};const n=Math.sqrt(this.w.x*this.w.x+this.w.y*this.w.y);this.w.x/=n,this.w.y/=n,this.b=-(this.w.x*e.x+this.w.y*e.y)}else this.w={x:e.x,y:e.y},this.b=t}static createByLine2d(e){const t=e.getDirection(),n=e.getStartPt();return new i({x:-t.y,y:t.x},n.x*t.y-n.y*t.x)}get normal(){return new s.Vector2(this.w)}distance(e){return this.w.x*e.x+this.w.y*e.y+this.b}clone(){return new i(this.w,this.b)}toLine2d(){let e;return e=Math.abs(this.w.x)>Math.abs(this.w.y)?{x:-this.b/this.w.x,y:0}:{x:0,y:-this.b/this.w.y},new r.Line2d(e,{x:e.x+this.w.y,y:e.y-this.w.x})}offset(e){return this.b-=e,this}intersect(e){const t=(n=this.w,r=e.w,n.x*r.y-n.y*r.x);var n,r;return{x:(this.w.y*e.b-e.w.y*this.b)/t,y:(e.w.x*this.b-this.w.x*e.b)/t}}parallel(e,t=1e-6){return Math.abs(e.w.x*this.w.y-e.w.y*this.w.x)<t}dump(){return{w:{x:this.w.x,y:this.w.y},b:this.b}}load(e){return new i(e.w,e.b)}}t.HalfPlane=i},25050:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MergeCurve=void 0;const r=n(33218),s=n(56973),i=n(32858),o=n(97505),a=n(10909),c=n(6688),l=n(26773),d=n(60229),u=n(74729),h=n(22289),g=n(3),f=n(79034),p=n(46302),_=n(4097);function m(e,t,n=s.Tolerance.LENGTH_EPS){return!!(e.pos.equals(t.pos,n)&&Math.abs(e.radius-t.radius)<n)}class v{static mergeCurve2d(e,t=s.Tolerance.LENGTH_EPS){const n=[],r=[],i=[];for(const t of e)t.isLine2d()?r.push(t):t.isArc2d()&&t.isEqualAB()?n.push(t):i.push(t);const o=v.mergeArc2d(n,t).result,a=v.mergeCurveLine2d(r,t);return o.concat(a).concat(i)}static mergeCurve2dEx(e,t=s.Tolerance.LENGTH_EPS){const n=[],r=[],i=[];for(const t of e)t.isLine2d()?r.push(t):t.isArc2d()&&t.isEqualAB()?n.push(t):i.push(t);const o=v.mergeArc2d(n,t),a=v.mergeCurveLine2dEx(r,t),c=o.result.concat(a.result);c.push(...i);const l=o.mapper;for(const e of a.mapper)l.set(e[0],e[1]);for(const e of i)l.set(e,[e]);return{result:c,mapper:l}}static mergeCurveLine2d(e,t){const n=[],r=[];for(let t=0;t<e.length;++t)e[t].getType()===o.EN_GEO_ELEMENT_TYPE.EN_LINE_2D&&r.push(e[t]);const s=[];for(let e=0;e<r.length;++e){const n=r[e].getDirection(),i=new h.HalfPlane(r[e].getStartPt(),r[e].getEndPt());Math.abs(n.x)>t?n.x>0?s.push([i.w.x,i.w.y,i.b]):s.push([-i.w.x,-i.w.y,-i.b]):n.y>0?s.push([i.w.x,i.w.y,i.b]):s.push([-i.w.x,-i.w.y,-i.b])}const a=(new g.MergePoint).merge(s,50*t),c=[];for(let e=0;e<a.points.length;++e)c.push(new h.HalfPlane({x:a.points[e][0],y:a.points[e][1]},a.points[e][2]));const l=30*t;for(let e=0;e<c.length;++e){let s=!0;const o=c[e],a=o.toLine2d(),d=[];for(const e of r)Math.abs(o.distance(e.getStartPt()))>l||Math.abs(o.distance(e.getEndPt()))>l||(a.getDirection().dot(e.getDirection())>0?(d.push({t:a.getParamAt(e.getStartPt()),wind:1}),d.push({t:a.getParamAt(e.getEndPt()),wind:-1}),s=!0):(d.push({t:a.getParamAt(e.getStartPt()),wind:-1}),d.push({t:a.getParamAt(e.getEndPt()),wind:1}),s=!1));d.sort(((e,t)=>e.t-t.t));let u=!1,h=!1,g=0,f=1/0;for(let e=0;e<d.length;){const r=d[e].t;for(;e<d.length&&Math.abs(d[e].t-r)<t;)g+=d[e++].wind;if(u=g>0,h!==u){const e=new i.Line2d(a.getPtAt(f),a.getPtAt(r));u||n.push(s?e:e.reverse()),f=r}h=u}}return n}static mergeCurveLine2dEx(e,t){const n=[];for(const t of e){let e=r.Vector2.X().angleTo(t.getDirection());e=e>=d.CONST.PI?e-d.CONST.PI:e,n.push({line:t,angle:e})}n.sort(((e,n)=>((e,n)=>{if(Math.abs(e.angle-n.angle)<t){const r=e.line.getDirection(),s=n.line.getDirection(),i=e.line.getOrigin(),o=n.line.getOrigin();return Math.abs(r.y)<t||Math.abs(s.y)<t?i.y-o.y:i.x-r.x*i.y/r.y-(o.x-s.x*o.y/s.y)}return e.angle-n.angle})(e,n)));const s=new Map,i=[],o=[];for(let e=0;e<n.length;){let t=e+1;for(;t<n.length;t++){if(!f.CurveCurveColinear.lines(n[e].line,n[t].line))break}const r=[];for(let s=e;s<t;s++)r.push(n[s].line);o.push(r),e+=r.length}for(const e of o){const t=p.CurveCurveMerge.mergeCurves2ds(e);t.length>1&&_.MathError.warn(!0,"overlap但不重合"),i.push(...t);for(const n of t)s.set(n,e)}return{result:i,mapper:s}}static mergeArc2d(e,t=s.Tolerance.LENGTH_EPS){const n=new Map,i=[],h=[];for(let t=0;t<e.length;++t)e[t].getType()===o.EN_GEO_ELEMENT_TYPE.EN_ARC_2D&&h.push(e[t]);const g=[];for(const e of h){const t=e.getCenter();g.push({pos:t,radius:e.getRadius()})}const f=[];for(let e=0;e<g.length;e++){const n=f.find((n=>m(n.arcInfo,g[e],t)));n?n.indexs.push(e):f.push({arcInfo:g[e],indexs:[e]})}for(const e of f){const t=e.arcInfo,s=[],o=e.indexs,g=[];o.map((e=>g.push(h[e])));for(const e of o){const n=h[e].getStartPt(),i=h[e].getEndPt(),o=h[e].getRange().getLength(),a=h[e].isCCW()?r.Vector2.X().angleTo(n.subtracted(t.pos)):r.Vector2.X().angleTo(i.subtracted(t.pos)),c=new l.PeriodInterval(a,a+o,d.CONST.PI2);s.push(c)}const f=c.Interval.merge(s);for(const e of f){const s=new u.Coordinate2(t.pos,r.Vector2.X()),o=new a.Arc2d(s,t.radius,t.radius,!0,e.toArray());i.push(o),n.set(o,g)}}return{result:i,mapper:n}}}t.MergeCurve=v},3:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MergePoint=t.Disjoint=void 0;class n{constructor(){this.set=[]}clear(){this.set.length=0}find(e){for(;this.set.length<=e;)this.set.push(this.set.length);return e===this.set[e]?e:this.set[e]=this.find(this.set[e])}merge(e,t){if(e<0||t<0)return;const n=this.find(e),r=this.find(t);n<r?this.set[r]=n:this.set[n]=r}}t.Disjoint=n;t.MergePoint=class{constructor(){this._tmp=[[],[],[]],this._disjoint=new n}clear(){this._disjoint.clear()}merge(e,t=1e-6){if(0===e.length)return{index:[],points:[]};const n=e[0].length-1,r=[];for(let t=0;t<e.length;++t)r.push(t);this.clear(),r.sort(((t,r)=>e[t][n]-e[r][n])),this._mergeex(e,r,0,r.length,n,t);const s=[];for(let t=0;t<e.length;++t)this._disjoint.find(t)!==t?r[t]=r[this._disjoint.find(t)]:(r[t]=s.length,s.push(e[t]));return{index:r,points:s}}_mergeex(e,t,n,r,s,i){if(!(r-n<2))if(s){const o=r+n>>1,a=e[t[o]][s];this._mergeex(e,t,n,o,s,i),this._mergeex(e,t,o,r,s,i);const c=this._tmp[s];c.length=0;for(let o=n;o<r;++o)Math.abs(e[t[o]][s]-a)>i||c.push(t[o]);const l=s-1;c.sort(((t,n)=>e[t][l]-e[n][l])),this._mergeex(e,c,0,c.length,l,i)}else for(let n=1;n<t.length;++n){const r=e[this._disjoint.find(t[n])][0],s=e[this._disjoint.find(t[n-1])][0];Math.abs(r-s)>i||this._disjoint.merge(t[n],t[n-1])}}}},42984:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClipMesh=void 0;const r=n(61226),s=n(56973),i=n(68238),o=n(87222),a=n(61077),c=n(33218),l=n(44210),d=n(1760);class u{static clipFaceMesh(e,t,n=!1,o=!0){const a=new Set,c=new Set,l=new Set;e.mesh.vertices.forEach(((e,n)=>{const o=new r.Vector3(e),d=i.CalculateDistance.pointToSurfaceSigned(o,t),u=s.Tolerance.LENGTH_EPS;d>u?a.add(n):d<-u?l.add(n):Math.abs(d)<=u&&c.add(n)}));const d=[],h=new Set,g=new Set,f=[];e.mesh.faces.forEach((([e,t,n],r)=>{c.has(e)&&c.has(t)&&c.has(n)?(d.push([e,t,n]),h.add(d.length-1)):l.has(e)||l.has(t)||l.has(n)?a.has(e)||a.has(t)||a.has(n)?g.add(r):f.push([e,t,n]):d.push([e,t,n])}));const p=e;let _;if(n&&(_=this._cloneRenderMesh(e)),g.forEach((r=>{const s=e.mesh.faces[r],i=s.filter((e=>a.has(e))),o=s.filter((e=>l.has(e))),h=s.filter((e=>c.has(e))),g=this._calNormal(e.mesh.vertices,s[0],s[1],s[2]);if(1===i.length&&1===o.length){const r=u._getVertexInfo(e,i[0]),s=u._getVertexInfo(e,o[0]),a=this._calIntersectInfo(t,r,s);p.mesh.vertices.push(a.point),p.mesh.normals.push(a.normal),p.mesh.uvs.push(a.uv);const c=p.mesh.vertices.length-1;n&&(_.mesh.vertices.push(a.point.slice()),_.mesh.normals.push(a.normal.slice()),_.mesh.uvs.push(a.uv.slice())),d.push(this._reorderPts(e.mesh.vertices,g,i[0],h[0],c)),n&&f.push(this._reorderPts(e.mesh.vertices,g,o[0],h[0],c))}else if(1===i.length&&2===o.length){const r=u._getVertexInfo(e,i[0]),s=u._getVertexInfo(e,o[0]),a=u._getVertexInfo(e,o[1]),c=this._calIntersectInfo(t,r,s);p.mesh.vertices.push(c.point),p.mesh.normals.push(c.normal),p.mesh.uvs.push(c.uv);const l=p.mesh.vertices.length-1;n&&(_.mesh.vertices.push(c.point.slice()),_.mesh.normals.push(c.normal.slice()),_.mesh.uvs.push(c.uv.slice()));const h=this._calIntersectInfo(t,r,a);p.mesh.vertices.push(h.point),p.mesh.normals.push(h.normal),p.mesh.uvs.push(h.uv);const m=p.mesh.vertices.length-1;n&&(_.mesh.vertices.push(h.point.slice()),_.mesh.normals.push(h.normal.slice()),_.mesh.uvs.push(h.uv.slice())),d.push(this._reorderPts(e.mesh.vertices,g,i[0],l,m)),n&&(f.push(this._reorderPts(e.mesh.vertices,g,o[0],l,m)),f.push(this._reorderPts(e.mesh.vertices,g,o[0],o[1],m)))}else if(2===i.length&&1===o.length){const r=u._getVertexInfo(e,i[0]),s=u._getVertexInfo(e,i[1]),a=u._getVertexInfo(e,o[0]),c=this._calIntersectInfo(t,r,a);p.mesh.vertices.push(c.point),p.mesh.normals.push(c.normal),p.mesh.uvs.push(c.uv);const l=p.mesh.vertices.length-1;n&&(_.mesh.vertices.push(c.point.slice()),_.mesh.normals.push(c.normal.slice()),_.mesh.uvs.push(c.uv.slice()));const h=this._calIntersectInfo(t,s,a);p.mesh.vertices.push(h.point),p.mesh.normals.push(h.normal),p.mesh.uvs.push(h.uv);const m=p.mesh.vertices.length-1;n&&(_.mesh.vertices.push(h.point.slice()),_.mesh.normals.push(h.normal.slice()),_.mesh.uvs.push(h.uv.slice())),d.push(this._reorderPts(e.mesh.vertices,g,i[0],l,m)),d.push(this._reorderPts(e.mesh.vertices,g,i[0],m,i[1])),n&&f.push(this._reorderPts(e.mesh.vertices,g,o[0],l,m))}})),o){Array.from(h).sort(((e,t)=>t-e)).forEach((e=>{d.splice(e,1)}))}p.mesh.faces=d,n&&(_.mesh.faces=f);let m=!1;return o&&h.size>0&&(m=!0),n&&g.size>0&&(m=!0),!n&&l.size>0&&(m=!0),{clipped:m,aboveMesh:p,downMesh:n?_:void 0}}static meshPlaneIntersect(e,t){const n=new Set,c=new Set,h=new Set;e.mesh.vertices.forEach(((e,o)=>{const a=new r.Vector3(e),l=i.CalculateDistance.pointToSurfaceSigned(a,t),d=s.Tolerance.LENGTH_EPS;l>d?n.add(o):l<-d?h.add(o):Math.abs(l)<=d&&c.add(o)}));const g=new Set;e.mesh.faces.forEach((([e,t,r],s)=>{!(n.has(e)||n.has(t)||n.has(r))||n.has(e)&&n.has(t)&&n.has(r)||g.add(s)}));const f=[];if(g.forEach((s=>{const i=e.mesh.faces[s],l=i.filter((e=>n.has(e))),d=i.filter((e=>h.has(e))),g=i.filter((e=>c.has(e)));if(1===l.length&&1===d.length){const n=u._getVertexInfo(e,l[0]),r=u._getVertexInfo(e,d[0]),s=u._getVertexInfo(e,g[0]),i=new o.Line3d(null==n?void 0:n.vector,null==r?void 0:r.vector),c=a.CalculateIntersect.curveSurface(i,t)[0];f.push(new o.Line3d(null==s?void 0:s.vector,c))}else if(1===l.length&&2===d.length){const n=u._getVertexInfo(e,l[0]),r=u._getVertexInfo(e,d[0]),s=u._getVertexInfo(e,d[1]),i=new o.Line3d(null==n?void 0:n.vector,null==r?void 0:r.vector),c=a.CalculateIntersect.curveSurface(i,t)[0],h=new o.Line3d(null==n?void 0:n.vector,null==s?void 0:s.vector),g=a.CalculateIntersect.curveSurface(h,t)[0];f.push(new o.Line3d(c,g))}else if(2===l.length&&1===d.length){const n=u._getVertexInfo(e,l[0]),r=u._getVertexInfo(e,l[1]),s=u._getVertexInfo(e,d[0]),i=new o.Line3d(null==n?void 0:n.vector,null==s?void 0:s.vector),c=a.CalculateIntersect.curveSurface(i,t)[0],h=new o.Line3d(null==r?void 0:r.vector,null==s?void 0:s.vector),g=a.CalculateIntersect.curveSurface(h,t)[0];f.push(new o.Line3d(c,g))}else if(1===l.length&&2===g.length){const t=e.mesh.vertices[g[0]],n=new r.Vector3(t),s=e.mesh.vertices[g[1]],i=new r.Vector3(s);f.push(new o.Line3d(n,i))}})),f.length<3)return new l.Polygon;const p=f.map((e=>t.getLine2D(e))),_=d.SearchGraph.simplePolygon(p);return _||new l.Polygon}static _calIntersectInfo(e,t,n){const s=new o.Line3d(t.vector,n.vector),i=a.CalculateIntersect.curveSurface(s,e)[0],l=i.distanceTo(null==t?void 0:t.vector),d=l/(i.distanceTo(null==n?void 0:n.vector)+l),u=new r.Vector3(null==t?void 0:t.normal).interpolate(new r.Vector3(n.normal),d),h=new c.Vector2(t.uv).interpolate(new c.Vector2(n.uv),d);return{point:i.toArray3(),vector:i,normal:u.toArray3(),uv:h.toArray2()}}static _getVertexInfo(e,t){const n=e.mesh.vertices[t];return{point:n,vector:new r.Vector3(n),normal:e.mesh.normals[t],uv:e.mesh.uvs[t]}}static _cloneRenderMesh(e){return{mesh:{vertices:e.mesh.vertices.map((e=>e.slice())),faces:e.mesh.faces.map((e=>e.slice())),normals:e.mesh.normals.map((e=>e.slice())),uvs:e.mesh.uvs.map((e=>e.slice()))}}}static _calNormal(e,t,n,s){return new r.Vector3(new r.Vector3(e[t]),new r.Vector3(e[n])).cross(new r.Vector3(new r.Vector3(e[n]),new r.Vector3(e[s])))}static _reorderPts(e,t,n,s,i){const o=new r.Vector3(new r.Vector3(e[n]),new r.Vector3(e[s])).cross(new r.Vector3(new r.Vector3(e[s]),new r.Vector3(e[i])));return t.dot(o)>0?[n,s,i]:[n,i,s]}}t.ClipMesh=u},66313:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MeshAssist=void 0;const r=n(20666),s=n(56973),i=n(61226);class o{static getEdgeNeighbourMap(e){const t=new Map,n=new Map,r=Math.max(...e);for(let s=0;s<e.length;s+=3)for(let i=0;i<3;i++){const o=s+i,a=e[o],c=e[s+(i+1)%3],l=c*r+a,d=n.get(l);void 0===d?n.set(a*r+c,o):(n.delete(l),t.set(o,d),t.set(d,o))}return t}static pickNeighbourFaces(e,t,n,r,s){const i=s||o.getEdgeNeighbourMap(e),a=new Set(n);for(;n.length>0;){const s=n.pop();for(let o=0;o<3;o++){const c=i.get(s+o);if(void 0===c)continue;const l=c-c%3;!a.has(l)&&r(l)&&(t.push(e[l],e[l+1],e[l+2]),n.push(l),a.add(l))}}return a}static getLoop2ds(e,t,n){var o;const a=new Set(t.keys());for(const e of t.values())for(const t of e)a.add(t);const c=Array.from(a).map((t=>{const n=3*t;return{x:e.vertices[n],y:e.vertices[n+1],z:e.vertices[n+2],id:t}}));c.sort(((e,t)=>e.x!==t.x?e.x-t.x:e.y!==t.y?e.y-t.y:e.z!==t.z?e.z-t.z:e.id-t.id));const l=new Map;for(let e=0;e<c.length;e++){const t=c[e];if(!l.has(t.id))for(let n=e+1;n<c.length;n++){const e=c[n];if(e.x-t.x>s.Tolerance.LENGTH_EPS)break;new i.Vector3(t).equals(e,s.Tolerance.LENGTH_EPS)&&l.set(e.id,t.id)}}const d=Array.from(t.entries());for(const[e,n]of d){for(let e=0;e<n.length;e++){const t=l.get(n[e]);void 0!==t&&(n[e]=t)}const r=l.get(e);if(void 0!==r){t.delete(e);const s=t.get(r);s?s.push(...n):t.set(r,n)}}const u=[],h=n.getDz(),g=new Set(t.keys());for(const e of t.values())for(const t of e)g.delete(t);for(;t.size>0;){let n;g.size>0?(n=g.keys().next().value,1===(null===(o=t.get(n))||void 0===o?void 0:o.length)&&g.delete(n)):n=t.keys().next().value;const r=h.getPerpendicular(),s=[n];for(;;){const o=t.get(n);if(!o)break;if(1===o.length)t.delete(n),n=o[0];else{const t=new i.Vector3(e.vertices[3*n],e.vertices[3*n+1],e.vertices[3*n+2]);r.reverse();const s=o.map((n=>{const s=3*n,i=t.subtracted({x:e.vertices[s],y:e.vertices[s+1],z:e.vertices[s+2]});return r.angleTo(i,h)}));let a=0;for(let e=1;e<s.length;e++)s[e]>s[a]&&(a=e);n=o[a],o.splice(a,1)}if(n===s[0])break;s.push(n)}u.push(s)}const f=s.Tolerance.CLIPPER_SCALE,p=u.map((t=>t.map((t=>{const s=3*t,i=n.getLocalPtAt({x:e.vertices[s],y:e.vertices[s+1],z:e.vertices[s+2]});return new r.IntPoint(i.x,i.y)}))));r.JS.ScaleUpPaths(p,f);const _=new r.Clipper;_.AddPaths(p,r.PolyType.ptSubject,!0);const m=new r.PolyTree;_.Execute(r.ClipType.ctUnion,m,r.PolyFillType.pftEvenOdd,r.PolyFillType.pftEvenOdd);const v=[],E=m.Childs(),P=e=>({x:e.X/f,y:e.Y/f});for(;E.length>0;){const e=E.pop(),t=[e.Contour().map(P)];for(const n of e.Childs())t.push(n.Contour().map(P)),E.push(...n.Childs());v.push(t)}return v}}t.MeshAssist=o},14704:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MeshContour=void 0;const r=n(20666),s=n(89494),i=n(2276),o=n(17165),a=n(49172),c=n(58074),l=n(61226),d=n(56973),u=n(66313);function h(e,t,n){const[r,s]=t<n?[t,n]:[n,t];return e*r+s}function g(e,t){return{vi:Math.floor(t/e),vj:t%e}}class f{static execute(e){const t=f._isFacesUp(e,d.Tolerance.EDGE_LENGTH_EPS),n=u.MeshAssist.getEdgeNeighbourMap(e.faces),r=f._splitMesh(e,t,n);if(!r.length)return[];const s=r.map((e=>f._getOuterLoop(e)));f._filterLoops(s,r),f._sortMeshes(r,s);const i=f._mixContours(s);return f._filterSmallLoops(i)}static getUpMesh(e){const t=f._isFacesUp(e,d.Tolerance.EDGE_LENGTH_EPS),n=u.MeshAssist.getEdgeNeighbourMap(e.faces),r=f._splitMesh(e,t,n);if(!r.length)return[];const s=r.map((e=>f._getOuterLoop(e)));return f._filterLoops(s,r),f._sortMeshes(r,s),r}static getHeightAtProjectPoint(e,t){const n=({vertices:e,faces:t},n)=>{const r=3*t[n];return new l.Vector3(e[r],e[r+1],e[r+2])},r=[],s=d.Tolerance.NUMBER_CALCULATION_EPS;for(let i=0;i<e.faces.length;i+=3){const o=[0,1,2].map((n=>{const r=e.faces[i+n];return{x:t.x-e.vertices[3*r],y:t.y-e.vertices[3*r+1]}}));let a=0,c=0;const l=(e,t)=>{const n=(r=o[e],i=o[t],r.x*i.y-r.y*i.x);var r,i;n>s&&a++,n<-s&&c++};if(l(0,1),l(1,2),l(2,0),0===a||0===c){const s=n(e,i),o=n(e,i+1),a=n(e,i+2),c=o.subtracted(s).cross(a.subtracted(s)).normalize(),l=-c.x/c.z,d=-c.y/c.z,u=s.z+(t.x-s.x)*l+(t.y-s.y)*d;r.push(u)}}return r}static _isFacesUp(e,t){const n=new Array(e.faces.length/3);for(let r=0;r<e.faces.length;r+=3){const s=e.faces[r],i=e.faces[r+1],o=e.faces[r+2],a=f._getArea(e.vertices,s,i,o);n[r/3]=a>t||!(a<-t)&&void 0}return n}static _splitMesh(e,t,n){const r=[],s=new Set;for(let t=0;t<e.faces.length;t+=3)s.add(t);for(;s.size>0;){const i=s.values().next().value;s.delete(i);const o=t[i/3];if(void 0===o)continue;const a=[e.faces[i],e.faces[i+1],e.faces[i+2]],c=e=>{const n=t[e/3];return n===o||void 0===n},l=u.MeshAssist.pickNeighbourFaces(e.faces,a,[i],c,n);for(const e of l)s.delete(e);r.push({faces:a,vertices:e.vertices,normals:e.normals,uvs:e.uvs})}return r}static _getOuterLoop(e){const t=new Map,n=e.vertices.length/3;for(let r=0;r<e.faces.length;r+=3)for(let s=0;s<3;s++){const i=e.faces[r+s],o=h(n,i,e.faces[r+(s+1)%3]);t.has(o)?t.delete(o):t.set(o,i)}const r=f._idFiMap2NextMap(t,n);return u.MeshAssist.getLoop2ds(e,r,s.Coordinate3.XOY()).flat()}static _idFiMap2NextMap(e,t){const n=new Map;for(const[r,s]of e){const e=g(t,r),i=e.vi===s?e.vj:e.vi,o=n.get(s);void 0===o?n.set(s,[i]):o.push(i)}return n}static _filterLoops(e,t,n=.001){for(let n=e.length-1;n>=0;n--)0===e[n].length&&(t.splice(n,1),e.splice(n,1));const r=e.map((e=>Math.abs(a.LoopArea.areaOfPoints(e[0])))),s=Math.max(...r);for(let i=e.length-1;i>=0;i--)r[i]<s*n&&(t.splice(i,1),e.splice(i,1))}static _sortMeshes(e,t){const n=new Array(e.length).fill(0),r=e.map((t=>new Array(e.length).fill(void 0)));for(let s=0;s<e.length;s++)for(let i=s+1;i<e.length;i++){const o=f._isMeshLower(e[s],e[i],t[s],t[i]);void 0!==o&&(r[s][i]=o,r[i][s]=!o,n[o?s:i]++)}const s=[],i=[];for(let t=0;t<e.length;t++)0===n[t]?i.push(t):s.push(t);const o=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n];if(r[t][s])return n}};for(;s.length>0;){const e=i.length;for(let e=0;e<s.length;e++){if(!o(s,s[e])){i.push(s[e]),s.splice(e,1);break}}if(e===i.length)break}const a=[],c=[];for(const n of i)a.push(e[n]),c.push(t[n]);e.splice(0,e.length,...a),t.splice(0,e.length,...c)}static _isMeshLower(e,t,n,s){const l=i.ClipperUtil.boolAsXys([n],[s],r.ClipType.ctIntersection);if(0===l.length)return;let d,u;for(const e of l){const t=o.DiscreteUtil.tessVector2(e);0!==t.faces.length&&(d=t.vertices,u=t.faces)}if(!d||!u)return;let h=0,g=0;for(let e=0;e<u.length;e+=3){const t=a.LoopArea.areaOfPoints([d[u[e]],d[u[e+1]],d[u[e+2]]]);t>h&&(h=t,g=e)}const p=c.LoopCentroid.centroidOfPoints([d[u[g]],d[u[g+1]],d[u[g+2]]]),_=f.getHeightAtProjectPoint(e,p),m=f.getHeightAtProjectPoint(t,p);return _.length&&m.length?_[0]<m[0]:void 0}static _mixContours(e){const t=[e[0]];let n=[i.ClipperUtil.xyLoopsToClipper(e[0])];for(let s=1;s<e.length;s++){const o=i.ClipperUtil.xyLoopsToClipper(e[s]),a=i.ClipperUtil.boolAsXys([o],n,r.ClipType.ctDifference);t.push(...a),n=i.ClipperUtil.boolAsClipperPoint([o],n,r.ClipType.ctUnion)}return t}static _filterSmallLoops(e){let t=0;const n=new Map;for(const r of e){const e=Math.abs(a.LoopArea.areaOfPoints(r[0]));n.set(r,e),e>t&&(t=e)}const r=[],s=.001*t;for(const t of e){if(n.get(t)<s)continue;const e=[t[0]];for(let n=1;n<t.length;n++){Math.abs(a.LoopArea.areaOfPoints(t[n]))>s&&e.push(t[n])}r.push(e)}return r.map((e=>i.ClipperUtil.removeGapByOffset(e,d.Tolerance.EDGE_LENGTH_EPS)))}static _getArea(e,t,n,r,s=3){const i=t*s,o=n*s,a=r*s,c=e[o]-e[i],l=e[o+1]-e[i+1],d=e[a]-e[i];return(c*(e[a+1]-e[i+1])-l*d)/2}}t.MeshContour=f},62293:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MeshUtil=void 0;const r=n(89494),s=n(56973),i=n(33218),o=n(61226),a=n(5804),c=n(4097),l=n(49246),d=n(68238),u=n(17165),h=n(66313),g=n(14704);var f;!function(e){e[e.Above=2]="Above",e[e.On=1]="On",e[e.Below=0]="Below"}(f||(f={}));class p{static boxClip(e,t,n=!0){const r=[];for(let t=0;t<e.vertices.length;t+=3)r.push(new o.Vector3([e.vertices[t],e.vertices[t+1],e.vertices[t+2]]));const s=[];for(let t=0;t<e.faces.length;t+=3){const n=a.Plane.makePlaneByTreePoints(r[e.faces[t]],r[e.faces[t+1]],r[e.faces[t+2]]);if(n)for(let i=(t+3)%e.faces.length;i<e.faces.length+3;i+=3){const o=d.CalculateDistance.pointToSurfaceSigned(r[e.faces[i%e.faces.length]],n),a=d.CalculateDistance.pointToSurfaceSigned(r[e.faces[(i+1)%e.faces.length]],n),c=d.CalculateDistance.pointToSurfaceSigned(r[e.faces[(i+2)%e.faces.length]],n);if(!(l.Util.isNearlyZero(o)&&l.Util.isNearlyZero(a)&&l.Util.isNearlyZero(c))){if(l.Util.isNearlyBigger(o,0)||l.Util.isNearlyBigger(a,0)||l.Util.isNearlyBigger(c,0)){s.push(n);break}n.reverse(),s.push(n);break}t+=3}}c.MathError.assert(6===s.length,"切割box暂时只支持矩形");let i=t;for(const e of s)i=this.clip(i,e.getCoord(),n);return i}static createFlatMeshByMesh2d(e,t=new a.Plane(r.Coordinate3.XOY())){const n=e.faces.slice(),s=[],i=[],o=[];for(const n of e.vertices)o.push(n.x,n.y),s.push(...t.getPtAt(n).data),i.push(...t.getNormAt(n).data);return{faces:n,vertices:s,uvs:o,normals:i}}static createFlatMesh(){return{faces:[],vertices:[],normals:[],uvs:[]}}static createFlatMeshByBox2(e,t=0){const{x:n,y:r}=e.min,{x:s,y:i}=e.max;return{faces:[0,1,2,2,3,0],vertices:[n,r,t,s,r,t,s,i,t,n,i,t],normals:[0,0,1,0,0,1,0,0,1,0,0,1],uvs:[n,r,s,r,s,i,n,i]}}static createFlatMeshByBox3(e){const t=[{x:e.min.x,y:e.min.y},{x:e.max.x,y:e.min.y},{x:e.max.x,y:e.max.y},{x:e.min.x,y:e.max.y}],n=r.Coordinate3.XOY().translate({x:0,y:0,z:e.min.z}),s={x:0,y:0,z:e.max.z-e.min.z};return p.extrude([t],n,s)}static toFlatMesh(e){return{vertices:[].concat(...e.vertices),faces:[].concat(...e.faces),normals:[].concat(...e.normals),uvs:[].concat(...e.uvs)}}static toMesh(e){const t={vertices:[],faces:[],normals:[],uvs:[]};for(let n=0;n<e.vertices.length;n+=3)t.vertices.push(e.vertices.slice(n,n+3));for(let n=0;n<e.faces.length;n+=3)t.faces.push(e.faces.slice(n,n+3));for(let n=0;n<e.normals.length;n+=3)t.normals.push(e.normals.slice(n,n+3));for(let n=0;n<e.uvs.length;n+=2)t.uvs.push(e.uvs.slice(n,n+2));return t}static clone(e){const t={};for(const n of Object.keys(e))t[n]=e[n].slice();return t}static merge(...e){const t=p.createFlatMesh();for(const n of e){const e=t.vertices.length/3;for(const r of n.faces)t.faces.push(r+e);t.vertices.push(...n.vertices),t.normals.push(...n.normals),t.uvs.push(...n.uvs)}return t}static getContour(e){return g.MeshContour.execute(e)}static intersectLine(e,t){const n=new r.Coordinate3(t.getOrigin(),t.getDirection()),s=new Array(e.vertices.length);for(let t=0;t<e.vertices.length;t+=3){const r=n.getLocalPtAt({x:e.vertices[t],y:e.vertices[t+1],z:e.vertices[t+2]});s[t]=r.x,s[t+1]=r.y,s[t+2]=r.z}const i={vertices:s,uvs:e.uvs,faces:e.faces,normals:e.normals},o=g.MeshContour.getHeightAtProjectPoint(i,{x:0,y:0}),a=t.getRange();return o.filter((e=>a.containsPoint(e))).sort(((e,t)=>e-t))}static clipSeperate(e,t,n=!1,r,s){const i=[],o=[],a=[],c=[],l=new Map;for(let d=0;d<e.length;++d){const u=e[d],h=r?r[d]:void 0,{newMesh:g,newUvsList:f,nextMap:p,attrs:_}=this._clip(u,t,n,h,s);l.set(g,e[d]),i.push(g),o.push(_),a.push(f),c.push(p)}const d=new Map;if(n){const e={faces:[],normals:[],uvs:[],vertices:[]};for(const t of o[0])e[t.name]=[];const n=new Map;let r=0;for(let t=0;t<i.length;++t){i[t].faces.forEach((t=>e.faces.push(t+r)));for(const n of o[t])i[t][n.name].forEach((t=>e[n.name].push(t)));for(const e of c[t]){const t=e[1].map((e=>e+r));n.set(e[0]+r,t)}r+=i[t].vertices.length/3}const s=p._fillClipSeperate(e,n,t),l=[...s.uvs];for(let e=1;e<a[0].length;++e)s.uvs.push(...l);d.set(s,void 0)}for(let e=0;e<i.length;++e){const t=i[e],n=o[e],r=a[e],s=t.vertices.length/3,c=new Array(s).fill(-1);for(const e of t.faces)c[e]=0;const u={};for(const e of n)u[e.name]=[];const h=r.map((e=>[]));let g=0;for(let e=0;e<s;e++)if(0===c[e]){c[e]=g++;for(const r of n){const n=r.name,s=e*r.stride;for(let e=0;e<r.stride;e++)u[n].push(t[n][s+e])}const s=2*e;for(let e=0;e<h.length;e++){const t=r[e];h[e].push(t[s],t[s+1])}}if(u.uvs=[],h.forEach((e=>u.uvs.push(...e))),u.faces=t.faces.map((e=>c[e])),u.faces.length>0){const e=l.get(t);d.set(u,e)}}return d}static clip(e,t,n=!1,r,s){const{newMesh:i,newUvsList:o,nextMap:a,attrs:c}=this._clip(e,t,n,r,s);n&&p._fillClip(i,o,a,t);const l=i.vertices.length/3,d=new Array(l).fill(-1);for(const e of i.faces)d[e]=0;const u={};for(const e of c)u[e.name]=[];const h=o.map((e=>[]));let g=0;for(let e=0;e<l;e++)if(0===d[e]){d[e]=g++;for(const t of c){const n=t.name,r=e*t.stride;for(let e=0;e<t.stride;e++)u[n].push(i[n][r+e])}const t=2*e;for(let e=0;e<h.length;e++){const n=o[e];h[e].push(n[t],n[t+1])}}return u.uvs=[],h.forEach((e=>u.uvs.push(...e))),u.faces=i.faces.map((e=>d[e])),u}static clipBoneInterpolation(e,t,n,r,s){const i=[];for(let t=0;t<4;t++){const r=4*n+t,o=e.boneWeights[r]*s;o>0&&i.push([e.boneIndices[r],o])}for(let t=0;t<4;t++){const n=4*r+t,o=e.boneWeights[n]*(1-s);if(o>0){const t=e.boneIndices[n],r=i.find((e=>e[0]===t));r?r[1]+=o:i.push([t,o])}}if(i.sort(((e,t)=>e[1]===t[1]?e[0]-t[0]:t[1]-e[1])),i.length>4){i.length=4;let e=0;for(const t of i)e+=t[1];for(const t of i)t[1]/=e}for(const e of i)t.boneIndices.push(e[0]),t.boneWeights.push(e[1]);for(let e=i.length;e<4;e++)t.boneIndices.push(0),t.boneWeights.push(0)}static extrude(e,t,n,r){const s=this.extrudeSeperateFaces(e,t,n,r);return p.merge(s.top,s.bottom,...s.sides.flat())}static extrudeSeperateFaces(e,t,n,r){const s=u.DiscreteUtil.tessVector2(e),o=t.getDz().data,a=[-o[0],-o[1],-o[2]],c=t.translated(n),l=p.createFlatMesh();for(const e of s.vertices)l.vertices.push(...c.getWorldPtAt(e).data),l.normals.push(...o),l.uvs.push(e.x,e.y);l.faces=s.faces.slice();const d=p.createFlatMesh();for(const e of s.vertices)d.vertices.push(...t.getWorldPtAt(e).data),d.normals.push(...a),d.uvs.push(e.x,e.y);for(let e=0;e<s.faces.length;e+=3)d.faces.push(s.faces[e],s.faces[e+2],s.faces[e+1]);const h=[],g=t.getDz().dot(n);for(let s=0;s<e.length;s++){const o=[p.createFlatMesh()],a=e[s],c=null==r?void 0:r[s];let l,d=0;{const e=new i.Vector2(a[a.length-1],a[0]).normalize();l=t.getWorldVectorAt({x:e.y,y:-e.x})}for(let e=0;e<a.length;e++){const r=a[e],s=t.getWorldPtAt(r),u=s.added(n),h=new i.Vector2(a[(e+1)%a.length]).subtract(r),f=h.getLength();h.multiply(1/f);const _=t.getWorldVectorAt({x:h.y,y:-h.x}),m=o[o.length-1],v=m.vertices.length/3;m.faces.push(v-2,v,v-1),m.faces.push(v-1,v,v+1);const E=(e,t,n)=>{e.vertices.push(...s.data,...u.data),e.uvs.push(t,0,t,g),e.normals.push(...n.data,...n.data)};if(c&&c[e]){const t=l.midTo(_).normalize();E(m,d,t),0===e&&E(m,d,t)}else{E(m,d,l);const e=p.createFlatMesh();E(e,d,_),o.push(e)}d+=f,l=_}if(o[0].uvs[0]=d,o[0].uvs[2]=d,1===o.length){const e=o[0],t=e.vertices.length/3;e.faces[0]=t-2,e.faces[2]=t-1,e.faces[3]=t-1}else{const e=o.pop(),t=p.merge(e,o[0]);o[0]=t}h.push(o)}return{top:l,bottom:d,sides:h}}static _clip(e,t,n=!1,r,i){const o=e.vertices.length/3,a=[];for(const t of Object.keys(e))"faces"!==t&&"uvs"!==t&&a.push({name:t,stride:e[t].length/o});const c=t.getOrigin(),l=t.getDz(),d=new Map,u=(e,t,n)=>{const[r,s]=n?[e,t]:[t,e],i=d.get(r);i?i.push(s):d.set(r,[s])},g=new Array(o);for(let t=0;t<o;t++){const n=p._distanceToPlane(e.vertices,t,c,l);n>s.Tolerance.LENGTH_EPS?g[t]=f.Above:n<-s.Tolerance.LENGTH_EPS?g[t]=f.Below:g[t]=f.On}const _={faces:[]};for(const t of a)_[t.name]=e[t.name].slice();const m=[],v=e.uvs.length/2/o;for(let t=0;t<v;t++)m.push(e.uvs.slice(t*o*2,(t+1)*o*2));const E=new Map,P=[],y=new Set,C=(n,s)=>{const a=n<s?n*o+s:s*o+n,d=E.get(a);if(void 0!==d)return d;const u=Math.abs(p._distanceToPlane(e.vertices,n,c,l)),h=Math.abs(p._distanceToPlane(e.vertices,s,c,l)),g=h/(u+h),f=1-g;if(r){const i={x:e.vertices[3*n]*g+e.vertices[3*s]*f,y:e.vertices[3*n+1]*g+e.vertices[3*s+1]*f,z:e.vertices[3*n+2]*g+e.vertices[3*s+2]*f},o=t.getLocalPtAt(i).x;if(o<r[0]||o>r[1])return-1}const P=e.normals.length>0;for(let t=0;t<3;t++)P&&_.normals.push(e.normals[3*n+t]*g+e.normals[3*s+t]*f),_.vertices.push(e.vertices[3*n+t]*g+e.vertices[3*s+t]*f);for(let t=0;t<v;t++){const r=m[t],i=t*o*2;for(let t=0;t<2;t++)r.push(e.uvs[2*n+t+i]*g+e.uvs[2*s+t+i]*f)}i&&i(e,_,n,s,g);const y=_.vertices.length/3-1;return E.set(a,y),y},S=(e,t,n,r)=>{r?_.faces.push(e,t,n):_.faces.push(e,n,t)};for(let s=0;s<e.faces.length;s+=3){const i=[[],[],[]],[o,a,c]=i;for(let t=s;t<s+3;t++){i[g[e.faces[t]]].push(t)}if(3===a.length)continue;if(0===o.length){if(_.faces.push(e.faces[s],e.faces[s+1],e.faces[s+2]),P.push(s),2===a.length&&n){const t=!p._isNext(a[0],a[1]);u(e.faces[a[0]],e.faces[a[1]],t)}continue}if(0===c.length){if(r){if(a.findIndex((n=>{const s=e.faces[n],i={x:e.vertices[3*s],y:e.vertices[3*s+1],z:e.vertices[3*s+2]},o=t.getLocalPtAt(i).x;return r[0]<o&&o<r[1]}))>=0)for(const t of o)y.add(e.faces[t])}continue}const l=o[0],d=c[0],h=2===c.length?c[1]:2===o.length?o[1]:a[0],m=e.faces[l],v=e.faces[d],E=e.faces[h],T=p._isNext(l,d),b=C(m,v);if(!(b<0)){if(g[E]===f.Below){const e=C(E,v);if(e<0)continue;S(b,v,e,T),n&&u(b,e,T)}else if(g[E]===f.On)S(b,v,E,T),n&&u(b,E,T);else{const e=C(E,m);if(e<0)continue;S(b,v,E,T),S(b,E,e,T),n&&u(b,e,T)}P.push(s);for(const t of o)y.add(e.faces[t])}}if(r){const t=t=>[0,1,2].findIndex((n=>y.has(e.faces[t+n])))<0;h.MeshAssist.pickNeighbourFaces(e.faces,_.faces,P,t)}return{newMesh:_,newUvsList:m,nextMap:d,attrs:a}}static _fillClip(e,t,n,r){const i=h.MeshAssist.getLoop2ds(e,n,r),o=r.getDz(),a=e.vertices.length/3,c=Object.keys(e).filter((e=>!["faces","uvs","normals","vertices"].includes(e))).map((t=>({name:t,stride:e[t].length/a}))),l=new Map,d=-Math.log10(s.Tolerance.LENGTH_EPS),g=t=>{const n=3*t;return`${e.vertices[n].toFixed(d)}_${e.vertices[n+1].toFixed(d)}_${e.vertices[n+2].toFixed(d)}`};if(c.length>0)for(let e=0;e<a;e++)l.set(g(e),e);const f=[-o.x,-o.y,-o.z];for(const n of i){const s=u.DiscreteUtil.tessVector2(n),i=e.vertices.length/3;for(let t=0;t<s.faces.length;t+=3)e.faces.push(s.faces[t]+i,s.faces[t+2]+i,s.faces[t+1]+i);for(const n of s.vertices){const s=r.getWorldPtAt(n);if(e.vertices.push(...s.data),e.normals.push(...f),t.forEach((e=>e.push(n.x,n.y))),c.length>0){const t=g(e.vertices.length/3-1),n=l.get(t)||0;for(const t of c){const r=n*t.stride,s=e[t.name];for(let e=0;e<t.stride;e++)s.push(s[r+e])}}}}}static _fillClipSeperate(e,t,n){const r=h.MeshAssist.getLoop2ds(e,t,n),i=n.getDz(),o=e.vertices.length/3,a=Object.keys(e).filter((e=>!["faces","uvs","normals","vertices"].includes(e))).map((t=>({name:t,stride:e[t].length/o}))),c=new Map,l=-Math.log10(s.Tolerance.LENGTH_EPS),d=t=>{const n=3*t;return`${e.vertices[n].toFixed(l)}_${e.vertices[n+1].toFixed(l)}_${e.vertices[n+2].toFixed(l)}`};if(a.length>0)for(let e=0;e<o;e++)c.set(d(e),e);const g={faces:[],normals:[],uvs:[],vertices:[]};for(const e of a)g[e.name]=[];const f=[-i.x,-i.y,-i.z];for(const t of r){const r=u.DiscreteUtil.tessVector2(t),s=g.vertices.length/3;for(let e=0;e<r.faces.length;e+=3)g.faces.push(r.faces[e]+s,r.faces[e+2]+s,r.faces[e+1]+s);for(const t of r.vertices){const r=n.getWorldPtAt(t);if(g.vertices.push(...r.data),g.normals.push(...f),g.uvs.push(t.x,t.y),a.length>0){const t=d(e.vertices.length/3-1),n=c.get(t)||0;for(const t of a){const r=n*t.stride,s=g[t.name],i=e[t.name];for(let e=0;e<t.stride;e++)s.push(i[r+e])}}}}return g}static _distanceToPlane(e,t,n,r){const s=3*t,i={x:e[s],y:e[s+1],z:e[s+2]};return-n.subtracted(i).dot(r)}static _isNext(e,t){return(t-e+3)%3==1}}t.MeshUtil=p},83015:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Loop2dOffset=void 0;const r=n(26773),s=n(56973),i=n(33218),o=n(32858),a=n(57249),c=n(53487),l=n(94954),d=n(94665),u=n(60229),h=n(34410),g=n(4097),f=n(61077),p=n(17980),_=n(37543),m=n(46302);class v{static execute(e,t,n=s.Tolerance.DEFAULT){const{curves:r,evolution:i}=h.CurveUtil.simplifyCurves2d(e,{smoothPolyToNurbs:!0}),o=r.map((e=>a.OffsetCurve2d.makeByOffset(e,t))),c=new Map;for(let e=0;e<o.length;e++)this._isDegeneratedCurve2d(o[e])?(o.splice(e,1),e--):c.set(o[e],r[e]);let l;try{l=v._connectCurve2ds(o,t,!0,s.Tolerance.DEFAULT)}catch(e){return{loops:[],evolution:new d.EvolutionMap}}const u=Array.from(l.keys()),g=v._makeJoints(u,n),f=v._findLoop2ds(u,g,t>0),p=new d.EvolutionMap,_=f.map((e=>{const t=[];for(let n=0;n<e.length;n++){const r=e[n];for(;n+1<e.length&&e[n+1].curveId===r.curveId;)n++;const s=g[r.curveId][e[n].jointId+1].param,i=u[r.curveId],o=i.clone().setRange(r.param,s);t.push(o),p.set(o,[i])}return t})),m=p.connectValueMap(l);for(const e of m.values())for(let t=0;t<e.length;t++)e[t]=i.get(c.get(e[t]))[0];return{loops:_,evolution:m}}static offsetCurve2dList(e,t){const n=e[0].getStartPt().equals(e[e.length-1].getEndPt()),r=e.map((e=>a.OffsetCurve2d.makeByOffset(e,t))),i=new Map;for(let t=0;t<r.length;t++)this._isDegeneratedCurve2d(r[t])?(r.splice(t,1),t--):i.set(r[t],e[t]);let o;try{o=v._connectCurve2ds(r,t,n,s.Tolerance.DEFAULT)}catch(e){return{curveList:[],evolution:new d.EvolutionMap}}return{curveList:Array.from(o.keys()),evolution:o}}static _isDegeneratedCurve2d(e){if(e.getRange().getLength()<s.Tolerance.NUMBER_EPS)return!0;if(e.isArc2d())return e.getA()<s.Tolerance.LENGTH_EPS&&e.getB()<s.Tolerance.LENGTH_EPS;if(e.isNurbsCurve2d()){const t=e.getControlPoints();let n=0;for(let e=1;e<t.length;e++){n+=t[e].sqDistanceTo(t[e-1])}return n<s.Tolerance.LENGTH_EPS2}return!1}static _connectCurve2ds(e,t,n,r){const h=new d.EvolutionMap,v=n?e.length+1:e.length;n||h.set(e[0],[e[0]]);for(let n=1;n<v;n++){const r=n-1,d=e[r],m=n%e.length,v=e[m],E=d instanceof a.OffsetCurve2d?d.getBaseCurve().getEndTangent():d.getEndTangent(),P=v instanceof a.OffsetCurve2d?v.getBaseCurve().getStartTangent():v.getStartTangent(),y=d.getEndPt().sqDistanceTo(v.getStartPt()),C=E.angleTo(P);if(y>s.Tolerance.LENGTH_EPS2)if(t>0?C<u.CONST.PI:C>u.CONST.PI){let n,s;if(d instanceof o.Line2d)n=d,n.getRange().max=u.CONST.MODEL_MAX_LENGTH;else{const s=d instanceof a.OffsetCurve2d?d.getParamMapper().getParamInfo(d.getBaseCurve().getEndParam(),!0).type:l.ParamType.Normal;if(s===l.ParamType.Normal)n=new o.Line2d(d.getEndPt(),E,[0,u.CONST.MODEL_MAX_LENGTH]);else{const e=new i.Vector2(E.y,-E.x),r=d.getBaseCurve().getEndPt().add(e.multiply(t));if(n=new o.Line2d(r,E,[-u.CONST.MODEL_MAX_LENGTH,u.CONST.MODEL_MAX_LENGTH]),s===l.ParamType.EndGap||s===l.ParamType.Reversed){const e=p.CurveCurveIntersect.curve2ds(d,n);g.MathError.assert(e.length>0,"No Intersect when tirm OffsetCurve end");let t=e[0];for(let n=1;n<e.length;n++)e[n].param2>t.param2&&(t=e[n]);n.getRange().min=t.param2,d.getRange().max=t.param1}else n.getRange().min=0}h.set(n,[e[r]])}if(v instanceof o.Line2d)s=v,s.getRange().min=-u.CONST.MODEL_MAX_LENGTH;else{const n=v instanceof c.OffsetCurve3d?v.getParamMapper().getParamInfo(v.getBaseCurve().getStartParam(),!1).type:l.ParamType.Normal;if(n===l.ParamType.Normal)s=new o.Line2d(v.getStartPt(),P,[-u.CONST.MODEL_MAX_LENGTH,0]);else{const e=new i.Vector2(P.y,-P.x),r=v.getBaseCurve().getStartPt().add(e.multiply(t));if(s=new o.Line2d(r,P,[-u.CONST.MODEL_MAX_LENGTH,u.CONST.MODEL_MAX_LENGTH]),n===l.ParamType.StartGap||n===l.ParamType.Reversed){const e=p.CurveCurveIntersect.curve2ds(v,s);g.MathError.assert(e.length>0,"No Intersect when trim OffsetCurve start");let t=e[0];for(let n=1;n<e.length;n++)e[n].param2<t.param2&&(t=e[n]);s.getRange().max=t.param2,v.getRange().min=t.param1}else s.getRange().max=0}h.set(s,[e[m]])}const f=_.LineLineIntersect.line2dAndLine2d(n,s);g.MathError.assert(f.length>0,"No Intersection found between preline & curline");const y=f[0];n.getRange().max=y.param1,s.getRange().min=y.param2}else{const n=e=>{if(e instanceof a.OffsetCurve2d&&e.isPeriodic()){const t=e.getBaseCurve(),n=t.getDomain().getLength()-e.getDomain().getLength();if(t.isNurbsCurve2d()&&e.getRange().max-e.getDomain().max<n)return!0}return!1},s=f.CalculateIntersect.curve2dsNearParams(d,v,d.getEndParam(),v.getStartParam());if(s)d.getRange().max=s.param1,v.getRange().min=s.param2;else{let s,a;if(n(d)){const n=d.getEndPt(),a=new i.Vector2(E.y,-E.x),c=d.getBaseCurve().getEndPt().add(a.multiply(t));s=new o.Line2d(n,c),h.set(s,[e[r]])}if(n(v)){const n=new i.Vector2(P.y,-P.x),r=v.getBaseCurve().getStartPt().add(n.multiply(t)),s=v.getStartPt();a=new o.Line2d(r,s),h.set(a,[e[m]])}if(s&&a){const e=_.LineLineIntersect.line2dAndLine2d(s,a);g.MathError.assert(e.length>0,"No Intersection found between preline & curline");const t=e[0];s.getRange().max=t.param1,a.getRange().min=t.param2}else if(s){const e=f.CalculateIntersect.curve2dsNearParams(s,v,s.getStartParam(),v.getStartParam());e?(s.getRange().max=e.param1,v.getRange().min=e.param2):g.MathError.assert(e,"No Intersection found between preline & curline")}else if(a){const e=f.CalculateIntersect.curve2dsNearParams(d,a,d.getEndParam(),a.getEndParam());e?(d.getRange().max=e.param1,a.getRange().min=e.param2):g.MathError.assert(e,"No Intersection found between preline & curline")}}}h.set(v,[e[m]])}const E=Array.from(h.keys());e:for(let e=0;e<E.length;){for(let t=e+1;t<E.length;t++){const n=m.CurveCurveMerge.curve2dsEvolution(E[e],E[t],m.MergeReverseMode.remove,r);if(n){h.appendKey(n,[E[e],E[t]]),E.splice(t,1),E.splice(e,1),E.push(...n.keys());continue e}}e++}return h}static _makeJoints(e,t){const n=e.map((()=>[])),i=e.length;function o(e,t,r,s,i){const o={curveId:e,jointId:-1,done:!1,point:r,param:s,thats:[]},a={curveId:t,jointId:-1,done:!1,point:r,param:i,thats:[o]};o.thats.push(a),n[e].push(o),n[t].push(a)}for(let n=0;n<i;n++){const s=e[n];if(s.getRange()instanceof r.PeriodInterval){const e=s.getStartPt(),r=s.getEndPt();e.equals(r,t.lengthEps)&&o(n,n,s.getStartPt(),s.getStartParam(),s.getEndParam())}else if(s instanceof a.OffsetCurve2d){if(s.getBaseCurve().getRange()instanceof r.PeriodInterval){const e=s.getStartPt(),r=s.getEndPt();e.equals(r,t.lengthEps)&&o(n,n,s.getStartPt(),s.getStartParam(),s.getEndParam())}else{const e=s.getBaseCurve(),t=s.getParamMapper(),r=s.getStartTangent(),i=s.getEndTangent(),a=e.getPtAt(t.getBaseParam(s.getStartParam(),!0)),c=e.getPtAt(t.getBaseParam(s.getEndParam(),!1)).subtracted(a);if(c.dot(r)>0&&c.dot(i)>0)continue;const l=s.getEndPt().subtract(s.getStartPt());if(!(l.dot(r)>0&&l.dot(i)>0))continue;const d=f.CalculateIntersect.curve2dsNearParams(s,s,s.getStartParam(),s.getEndParam());if(!d)continue;o(n,n,d.point,d.param1,d.param2)}}}for(let t=0;t<i;t++)for(let n=t+1;n<i;n++){const r=f.CalculateIntersect.curve2ds(e[t],e[n]);for(const e of r)e.isOverlap||o(t,n,e.point,e.param1,e.param2)}for(const i of n){if(0===i.length)continue;{const t=e[i[0].curveId].getRange();if(t instanceof r.PeriodInterval){const e=i.some((e=>Math.abs(e.param-t.min)<s.Tolerance.NUMBER_EPS));for(const n of i){const r=Math.abs(n.param-t.max)<s.Tolerance.NUMBER_EPS;n.param=e&&r?n.param:t.getRegularParam(n.param)}}}i.sort(((e,t)=>{const n=e.overlap?e.overlap.getMid():e.param,r=t.overlap?t.overlap.getMid():t.param;return n===r?e.jointId-t.jointId:n-r}));for(let e=0;e<i.length;e++){const n=i[e];n.jointId=e;let r=e+1;for(;r<i.length&&!(Math.abs(n.param-i[r].param)>t.numberEps);r++);if(r>e+1){const t=n.point;let s=n.param;for(let o=e+1;o<r;o++){const e=i[o];t.add(e.point),s+=e.param,n.thats.push(...e.thats);for(const t of e.thats){const r=t.thats.findIndex((t=>t===e));t.thats[r]=n}}n.point=t.multiply(1/(r-e)),n.param=s/(r-e),i.splice(e+1,r-e-1)}}if(i.length<2)continue;const n=i[0],o=i[i.length-1];if(n.point.equals(o.point)){for(const e of n.thats)e===o||o.thats.includes(e)||(o.thats.push(e),e.thats.push(o));for(const e of o.thats)e===n||n.thats.includes(e)||(n.thats.push(e),e.thats.push(n))}}return n}static _findLoop2ds(e,t,n){const r=[],s=e.length;for(let i=0;i<s;i++){const s=t[i];for(let i=0;i<s.length-1;i++){const o=s[i];if(o.done)continue;let a={joint:o,direction:!0};const c=[];let l=!0;do{a.direction?a.joint.done=!0:l=!1;const r=a.joint;c.push(r);const s=t[r.curveId],i=s[r.jointId+(a.direction?1:-1)],o=e[r.curveId].getTangentAt(i.param);let d;a.direction&&o.reverse();const u=e=>{d&&d.angle>e.angle!==n||(d=e)};a.direction?i.jointId+1<s.length&&u({joint:i,angle:Math.PI,direction:!0}):i.jointId>0&&u({joint:i,angle:Math.PI,direction:!1});for(const n of i.thats){const r=e[n.curveId].getTangentAt(n.param);if(n.jointId<t[n.curveId].length-1){u({angle:o.angleTo(r),joint:n,direction:!0})}if(n.jointId>0){u({angle:o.angleTo(r.reverse()),joint:n,direction:!1})}}if(!d){l=!1;break}a=d}while(a.joint!==o);l&&r.push(c)}}return r}}t.Loop2dOffset=v},20227:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PolygonOffset=void 0;const r=n(20666),s=n(45987),i=n(44210),o=n(89009),a=n(49246),c=n(60229),l=n(56973);t.PolygonOffset=class{static execute(e,t,n){if(e.isEmpty())return{offsetPolygon:new i.Polygon};const o=l.Tolerance.CLIPPER_SCALE,a=s.ClipperFormatConverter.polygonToPaths(e);r.JS.ScaleUpPaths(a,o);const c=new r.ClipperOffset(Number.MAX_VALUE);c.AddPaths(a,r.JoinType.jtMiter,r.EndType.etClosedPolygon),c.Execute(a,t*o),r.JS.ScaleDownPaths(a,o);const d=s.ClipperFormatConverter.pathsToPolygon(a);let u;return n&&(u=this._calEvolution(e,d,t)),{offsetPolygon:d,evolution:u}}static _calEvolution(e,t,n){const r=(e,t)=>{if(!e.getDirection().isSameDirection(t.getDirection()))return!1;const r=o.PointToCurve2dDistance.simple(t.getStartPt(),e,!0);return a.Util.isNearlyEqual(-r.distance,n)},s=new Map,i=e.getAllCurves(),l=t.getAllCurves();for(const e of l){const t=e.clone().extendDouble(c.CONST.MODEL_MAX_LENGTH),n=i.filter((e=>r(t,e)));if(!n.length)continue;const o=e.getMidPt();n.sort(((e,t)=>o.distanceTo(e.getMidPt())-o.distanceTo(t.getMidPt()))),s.set(e,n[0])}return s}}},79034:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveCurveColinear=void 0;const r=n(56973),s=n(49246),i=n(10909),o=n(97602),a=n(32858),c=n(87222),l=n(53487),d=n(57249),u=n(93145),h=n(48448),g=n(67579),f=n(43364),p=n(2111),_=n(68990),m=n(43640),v=n(56698),E=n(4097),P=n(34410),y=n(9327),C=n(24533);class S{static curve3ds(e,t,n=r.Tolerance.DEFAULT){if(e instanceof c.Line3d){if(t instanceof c.Line3d)return S.lines(e,t,n)}else if(e instanceof o.Arc3d){if(t instanceof o.Arc3d)return S.arcs(e,t,n)}else if(e instanceof l.OffsetCurve3d){if(t instanceof l.OffsetCurve3d)return S.offsetCurves(e,t,n)}else if(e instanceof u.NurbsCurve3d){if(t instanceof u.NurbsCurve3d)return S.nurbsCurves(e,t,n)}else if(e instanceof y.ExtendCurve3d&&t instanceof y.ExtendCurve3d)return S.extendCurves(e,t,n);return(e instanceof u.NurbsCurve3d||e instanceof g.SmoothPoly3d||t instanceof u.NurbsCurve3d||t instanceof g.SmoothPoly3d)&&v.CurveCurveOverlap.generalCurves(e,t,n).length>0}static curve2ds(e,t,n=r.Tolerance.DEFAULT){if(e instanceof a.Line2d){if(t instanceof a.Line2d)return S.lines(e,t,n)}else if(e instanceof i.Arc2d){if(t instanceof i.Arc2d)return S.arcs(e,t,n)}else if(e instanceof d.OffsetCurve2d){if(t instanceof d.OffsetCurve2d)return S.offsetCurves(e,t,n)}else if(e instanceof h.NurbsCurve2d){if(t instanceof h.NurbsCurve2d)return S.nurbsCurves(e,t,n)}else if(e instanceof C.ExtendCurve2d&&t instanceof C.ExtendCurve2d)return S.extendCurves(e,t,n);return(e instanceof h.NurbsCurve2d||e instanceof f.SmoothPoly2d||t instanceof h.NurbsCurve2d||t instanceof f.SmoothPoly2d)&&v.CurveCurveOverlap.generalCurves(e,t,n).length>0}static lines(e,t,n=r.Tolerance.DEFAULT){function s(e,t){return t.getPtAt(t.getParamAt(e)).sqDistanceTo(e)}return e.getDirection().isParallel(t.getDirection(),n.angleEps)&&(s(e.getMidPt(),t)<n.lengthEps2||s(t.getMidPt(),e)<n.lengthEps2)}static arcs(e,t,n){if(!e.getCenter().equals(t.getCenter(),n.lengthEps))return!1;if(e instanceof o.Arc3d&&t instanceof o.Arc3d&&!e.getNormal().isParallel(t.getNormal(),n.angleEps))return!1;const r=e.getA(),s=e.getB(),i=t.getA(),a=t.getB();return Math.abs(r-s)<n.lengthEps?Math.abs(i-a)<n.lengthEps&&Math.abs(r+s-i-a)<2*n.lengthEps:Math.abs(r-i)<n.lengthEps?Math.abs(s-a)<n.lengthEps&&e.getCoord().getDx().isParallel(t.getCoord().getDx(),n.angleEps):Math.abs(r-a)<n.lengthEps&&(Math.abs(i-s)<n.lengthEps&&e.getCoord().getDx().isPerpendicular(t.getCoord().getDx(),n.angleEps))}static areArcsSameDirection(e,t){return e instanceof i.Arc2d&&t instanceof i.Arc2d?e.isCCW()===t.isCCW():e instanceof o.Arc3d&&t instanceof o.Arc3d?e.getNormal().dot(t.getNormal())>0:(E.MathError.assert("arc1 and arc2 not same type"),!1)}static offsetCurves(e,t,n){if(e instanceof d.OffsetCurve2d&&t instanceof d.OffsetCurve2d)return!!s.Util.isNearlyEqual(e.getOffset(),t.getOffset(),n.lengthEps)&&S.curve2ds(e.getBaseCurve(),t.getBaseCurve(),n);if(e instanceof l.OffsetCurve3d&&t instanceof l.OffsetCurve3d){const r=e.getBaseCurve(),i=t.getBaseCurve();if(!e.getDz().isParallel(t.getDz(),n.angleEps))return!1;const a=e.getDz().dot(t.getDz());if(!s.Util.isNearlyEqual(e.getOffsetZ(),t.getOffsetZ()*a,n.lengthEps))return!1;let c=a;if(r instanceof o.Arc3d&&i instanceof o.Arc3d){c*=r.getNormal().dot(i.getNormal())}else if(r instanceof u.NurbsCurve3d&&i instanceof u.NurbsCurve3d){c*=P.CurveUtil.getDzByCurve(r).dot(P.CurveUtil.getDzByCurve(i))}return!!s.Util.isNearlyEqual(e.getOffsetXY(),t.getOffsetXY()*c,n.lengthEps)&&S.curve3ds(r,i,n)}return!1}static extendCurves(e,t,n){const r=e.getBaseCurve(),s=t.getBaseCurve();if(r instanceof p.Curve3d&&s instanceof p.Curve3d){if(!S.curve3ds(r,s,n))return!1}if(r instanceof _.Curve2d&&s instanceof _.Curve2d){if(!S.curve2ds(r,s,n))return!1}const i=r.getRange(),o=s.getRange();return i.equals(o,n.numberEps)}static testBySamples(e,t,n=t.getRange(),s=r.Tolerance.DEFAULT,i=m.DiscreteParameter.NORMAL.hintSegmentCount){const o=(n.max-n.min)/(i+1),a=e.getRange();for(let r=0;r<i;r++){const i=o*(r+.9+.2*Math.random())+n.min,c=t.getPtAt(i),l=e.getParamAt(c),d=e.getPtAt(l);if(!a.containsPoint(l)||d.sqDistanceTo(c)>s.edgeLengthEps2)return!1}return!0}static nurbsCurves(e,t,n){const r=e.getDegree(),i=t.getDegree(),o=e.getKnots(),a=t.getKnots(),c=e.getControlPoints(),l=t.getControlPoints();if(r!==i||o.length!==a.length||c.length!==l.length)return!1;let d=!0;for(let e=0;e<c.length;e++)if(!c[e].equals(l[e],n.lengthEps)){d=!1;break}let u=!0;if(!d){let e=!0;for(let t=0;t<c.length;t++)if(!c[t].equals(l[c.length-1-t],n.lengthEps)){e=!1;break}if(!e)return!1;u=!1}for(let e=0;e<o.length;e++){let t=a[e];if(u||(t=a[a.length-1]-a[a.length-1-e]),!s.Util.isNearlyEqual(o[e],t,n.numberEps))return!1}const h=e.getWeights(),g=t.getWeights();for(let e=0;e<h.length;e++)if(!s.Util.isNearlyEqual(h[e],g[e],n.numberEps))return!1;return!0}}t.CurveCurveColinear=S},46302:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveCurveMerge=t.MergeReverseMode=void 0;const r=n(26773),s=n(56973),i=n(10909),o=n(97602),a=n(32858),c=n(87222),l=n(57249),d=n(53487),u=n(94665),h=n(79034),g=n(4097),f=n(98106);var p;!function(e){e[e.merge=0]="merge",e[e.remove=1]="remove"}(p=t.MergeReverseMode||(t.MergeReverseMode={}));class _{static mergeCurves3ds(e,t=s.Tolerance.DEFAULT){const n=[];n.push(e[0]);for(let r=1;r<e.length;++r){const s=n[n.length-1],i=e[r],o=this.curve3ds(s,i,p.merge,t);o?(n.pop(),n.push(...o)):n.push(e[r])}if(n.length>3&&n[0].getStartPt().equals(n[n.length-1].getEndPt())){const e=this.curve3ds(n[0],n[n.length-1],p.merge,t);e&&(n.pop(),n.shift(),n.push(...e))}return n}static mergeCurves2ds(e,t=s.Tolerance.DEFAULT){const n=[];n.push(e[0]);for(let r=1;r<e.length;++r){const s=n[n.length-1],i=e[r],o=this.curve2ds(s,i,p.merge,t);o?(n.pop(),n.push(...o)):n.push(e[r])}if(n.length>3&&n[0].getStartPt().equals(n[n.length-1].getEndPt())){const e=this.curve2ds(n[0],n[n.length-1],p.merge,t);e&&(n.pop(),n.shift(),n.push(...e))}return n}static curve2ds(e,t,n=p.merge,r=s.Tolerance.DEFAULT){const i=_.curve2dsEvolution(e,t,n,r);return i?Array.from(i.keys()):void 0}static curve2dsEvolution(e,t,n=p.merge,r=s.Tolerance.DEFAULT){if(e instanceof a.Line2d){if(t instanceof a.Line2d)return _.linesEvolution(e,t,n,r)}else if(e instanceof i.Arc2d){if(t instanceof i.Arc2d)return _.arcsEvolution(e,t,n,r)}else if(e instanceof f.NurbsCurve2d){if(t instanceof f.NurbsCurve2d)return _.nurbsEvolution(e,t,n,r)}else if(e instanceof l.OffsetCurve2d&&t instanceof l.OffsetCurve2d)return _.offsetCurvesEvolution(e,t,n,r)}static curve3ds(e,t,n=p.merge,r=s.Tolerance.DEFAULT){const i=_.curve3dsEvolution(e,t,n,r);return i?Array.from(i.keys()):void 0}static curve3dsEvolution(e,t,n=p.merge,r=s.Tolerance.DEFAULT){if(e instanceof c.Line3d){if(t instanceof c.Line3d)return _.linesEvolution(e,t,n,r)}else if(e instanceof o.Arc3d){if(t instanceof o.Arc3d)return _.arcsEvolution(e,t,n,r)}else if(e instanceof f.NurbsCurve3d){if(t instanceof f.NurbsCurve3d)return _.nurbsEvolution(e,t,n,r)}else if(e instanceof d.OffsetCurve3d&&t instanceof d.OffsetCurve3d)return _.offsetCurvesEvolution(e,t,n,r)}static lines(e,t,n=p.merge,r=s.Tolerance.DEFAULT){const i=_.linesEvolution(e,t,n,r);return i?Array.from(i.keys()):void 0}static linesEvolution(e,t,n=p.merge,r=s.Tolerance.DEFAULT){if(h.CurveCurveColinear.lines(e,t,r))return _._simpleCurves(e,t,n,r)}static arcs(e,t,n=p.merge,r=s.Tolerance.DEFAULT){const i=_.arcsEvolution(e,t,n,r);return i?Array.from(i.keys()):void 0}static arcsEvolution(e,t,n=p.merge,r=s.Tolerance.DEFAULT){if(!h.CurveCurveColinear.arcs(e,t,r))return;const i=h.CurveCurveColinear.areArcsSameDirection(e,t);return _._periodCurves(e,t,i,n,r)}static nurbsEvolution(e,t,n=p.merge,r=s.Tolerance.DEFAULT){if(h.CurveCurveColinear.nurbsCurves(e,t,r))return _._nurbsRange(e,t,n,r)}static offsetCurvesEvolution(e,t,n=p.merge,i=s.Tolerance.DEFAULT){if(!h.CurveCurveColinear.offsetCurves(e,t,i))return;const o=e.getRange(),a=t.getRange(),c=o instanceof r.PeriodInterval,l=a instanceof r.PeriodInterval;return c&&l?_._periodCurves(e,t,void 0,n,i):c||l?(g.MathError.warn(!1,"period offsetCrv merge with non-period offsetCrv not supported",g.MathErrorType.Unimplemented,e,t),_._simpleCurves(e,t,n,i)):_._simpleCurves(e,t,n,i)}static _simpleCurves(e,t,n,r){const s=e.getRange(),i=e.getParamAt(t.getStartPt()),o=e.getParamAt(t.getEndPt()),[a,c]=i<o?[i,o]:[o,i],l=new u.EvolutionMap;function d(n,r){if(n<r){const t=e.clone().setRange(n,r);l.set(t,[e])}else{const s=e.clone().setRange(r,n).reverse();l.set(s,[t])}}if(i>o&&n===p.remove){if(a>s.max-r.lengthEps||c<s.min+r.lengthEps)return;return Math.abs(s.min-a)>r.lengthEps&&d(s.min,a),Math.abs(s.max-c)>r.lengthEps&&d(c,s.max),l}{if(s.max<a-r.lengthEps||c<s.min-r.lengthEps)return;const n=Math.min(s.min,a),i=Math.max(s.max,c),o=e.clone().setRange(n,i);return l.set(o,[e,t]),l}}static _nurbsRange(e,t,n,r){const s=new u.EvolutionMap;let i=!1;e.getControlPoints()[0].equals(t.getControlPoints()[0])&&e.getControlPoints()[1].equals(t.getControlPoints()[1])&&(i=!0);const o=i?t:t.clone().reverse(),a=r.numberEps,c=e.getRange(),l=o.getRange();if(n===p.remove&&!i){if(c.min-a>l.min&&c.min+a<l.max&&c.max-a>l.max)o.setRange(l.max,c.max),s.set(o,[e,t]);else if(c.min+a<l.min&&l.max-a>l.max){const n=e.clone().setRange(c.min,l.min);o.setRange(l.max,c.max),s.set(n,[e,t]),s.set(o,[e,t])}else c.min+a<l.min&&c.max-a>l.min&&(o.setRange(c.min,l.min),s.set(o,[e,t]));return s.size>0?s:void 0}const d=c.min<l.min?c.min:l.min,h=c.max>l.max?c.max:l.max;return c.getLength()+l.getLength()<h-d+a&&(o.setRange(d,h),s.set(o,[e,t])),s.size>0?s:void 0}static _periodCurves(e,t,n,i,o){const a=e.getRange(),c=a.period,l=t.getRange().period;if(Math.abs(c-l)>o.numberEps)return;const d=e.getParamAt(t.getStartPt()),h=e.getParamAt(t.getEndPt());let g;if(void 0===n){const n=e.getRange().getMid(),r=e.getTangentAt(n),s=e.getPtAt(n),i=t.getParamAt(s),o=t.getTangentAt(i);g=r.dot(o)>0}else g=n;const f=g?new r.PeriodInterval(d,h,c):new r.PeriodInterval(h,d,c),_=new u.EvolutionMap,m=(t,n,r=!1)=>{for(const s of t){const t=e.clone().setRange(s.min,s.max);r&&t.reverse(),_.set(t,n.slice())}};if(!g&&i===p.remove){const n=a.subtracted(f),r=f.subtracted(a);let i=!1;return(1!==n.length||Math.abs(n[0].getLength()-a.getLength())>s.Tolerance.DEFAULT.numberEps)&&(m(n,[e]),i=!0),(1!==r.length||Math.abs(r[0].getLength()-f.getLength())>s.Tolerance.DEFAULT.numberEps)&&(m(r,[t],!0),i=!0),i?_:void 0}{const n=r.PeriodInterval.merge([a,f]);if(2===n.length)return;return m(n,[e,t]),_}}}t.CurveCurveMerge=_},56698:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveCurveOverlap=void 0;const r=n(6688),s=n(26773),i=n(56973),o=n(10909),a=n(97602),c=n(32858),l=n(87222),d=n(38666),u=n(79034),h=n(53487),g=n(57249),f=n(43640),p=n(48448),_=n(43364),m=n(93145),v=n(67579),E=n(9327),P=n(24533),y=n(49246);function C(e,t,n){const r=e.getParamAt(t);return e.getPtAt(r).sqDistanceTo(t)<n?r:void 0}class S{static curve2ds(e,t,n=new i.Tolerance){let r;if(e instanceof c.Line2d){if(t instanceof c.Line2d)return S.lines(e,t,n)}else if(e instanceof o.Arc2d){if(t instanceof o.Arc2d)return S.arcs(e,t,n)}else if(e instanceof g.OffsetCurve2d&&t instanceof g.OffsetCurve2d){if(r=S.offsetCurves(e,t,n),r)return r}else if(e instanceof P.ExtendCurve2d&&t instanceof P.ExtendCurve2d&&(r=S.extendCurves(e,t,n),r))return r;return e instanceof p.NurbsCurve2d||e instanceof _.SmoothPoly2d||t instanceof p.NurbsCurve2d||t instanceof _.SmoothPoly2d?S.generalCurves(e,t,n):[]}static curve3ds(e,t,n=i.Tolerance.DEFAULT){let r;if(e instanceof l.Line3d){if(t instanceof l.Line3d)return S.lines(e,t,n)}else if(e instanceof a.Arc3d){if(t instanceof a.Arc3d)return S.arcs(e,t,n)}else if(e instanceof h.OffsetCurve3d&&t instanceof h.OffsetCurve3d){if(r=S.offsetCurves(e,t,n),r)return r}else if(e instanceof E.ExtendCurve3d&&t instanceof E.ExtendCurve3d&&(r=S.extendCurves(e,t,n),r))return r;return e instanceof m.NurbsCurve3d&&t instanceof m.NurbsCurve3d&&(r=S.nurbsCurves(e,t,n),r)?r:e instanceof m.NurbsCurve3d||e instanceof v.SmoothPoly3d||t instanceof m.NurbsCurve3d||t instanceof v.SmoothPoly3d?S.generalCurves(e,t,n):[]}static lines(e,t,n=i.Tolerance.DEFAULT){if(u.CurveCurveColinear.lines(e,t,n))return S._linesOverlap(e,t,n);function r(e,t){return t.getPtAt(t.getParamAt(e)).sqDistanceTo(e)}const s=e.getRange().getLength(),o=t.getRange().getLength();if(s>1&&o>1)return[];if(s<o){if(r(e.getStartPt(),t)<n.lengthEps2&&r(e.getEndPt(),t)<n.lengthEps2){const r=S._linesOverlap(t,e,n);return r.length>0&&([r[0].range1,r[0].range2]=[r[0].range2,r[0].range1]),r}}else if(r(t.getStartPt(),e)<n.lengthEps2&&r(t.getEndPt(),e)<n.lengthEps2)return S._linesOverlap(e,t,n);return[]}static arcs(e,t,n=i.Tolerance.DEFAULT){return u.CurveCurveColinear.arcs(e,t,n)?S._arcsOverlap(e,t,n):[]}static offsetCurves(e,t,n=i.Tolerance.DEFAULT){return u.CurveCurveColinear.offsetCurves(e,t,n)?S._offsetCurvesOverlap(e,t,n):[]}static extendCurves(e,t,n=i.Tolerance.DEFAULT){return u.CurveCurveColinear.extendCurves(e,t,n)?S._extendCurvesOverlap(e,t,n):[]}static nurbsCurves(e,t,n=i.Tolerance.DEFAULT){if(u.CurveCurveColinear.nurbsCurves(e,t,n))return S._nurbsCurvesOverlap(e,t,n)}static generalCurves(e,t,n=i.Tolerance.DEFAULT,r=f.DiscreteParameter.NORMAL.hintSegmentCount){const s=n.edgeLengthEps2,o=e.getStartPt().sqDistanceTo(e.getEndPt())<s,a=t.getStartPt().sqDistanceTo(t.getEndPt())<s;if(o&&a){const r=t.getStartPt(),s=e.getParamAt(r),i=e.getTangentAt(s).dot(t.getStartTangent())>0;if(u.CurveCurveColinear.testBySamples(e,t,t.getRange(),n)){return[{range1:e.getRange().clone(),range2:t.getRange().clone(),isSameDirection:i}]}return[]}if(o){const s=S._generalOpenCurves(t,e,!0,n,r);for(const e of s)[e.range1,e.range2]=[e.range2,e.range1];return s}return S._generalOpenCurves(e,t,a,n,r)}static _linesOverlap(e,t,n=i.Tolerance.DEFAULT){const s=e.getRange(),o=d.CurveCurveProject.lines(t,e),a=s.intersected(o,n.lengthEps);if(0===a.length)return[];const c=a[0],l=e.getDirection().dot(t.getDirection())>0,u=t.getParamAt(e.getPtAt(c.min)),h=t.getParamAt(e.getPtAt(c.max));return[{range1:c,range2:l?new r.Interval(u,h):new r.Interval(h,u),isSameDirection:l}]}static _arcsOverlap(e,t,n){const r=e.getRange(),i=t.getRange(),o=u.CurveCurveColinear.areArcsSameDirection(e,t);if(e.isClosed()&&t.isClosed())return[{range1:r,range2:i,isSameDirection:o}];const a=e.getParamAt(t.getStartPt()),c=e.getParamAt(t.getEndPt()),l=o?new s.PeriodInterval(a,c):new s.PeriodInterval(c,a);return r.intersected(l,n.numberEps).map((n=>{const r=e.getPtAt(n.min),s=e.getPtAt(n.max);return{range1:n,range2:o?t.getParamRangeAt(r,s):t.getParamRangeAt(s,r),isSameDirection:o}}))}static _offsetCurvesOverlap(e,t,n){const i=e.getRange(),c=t.getRange(),l=e.getBaseCurve(),d=t.getBaseCurve();if(l instanceof a.Arc3d&&d instanceof a.Arc3d||l instanceof o.Arc2d&&d instanceof o.Arc2d){const r=u.CurveCurveColinear.areArcsSameDirection(l,d),o=Math.abs(i.getLength()-i.period)<n.numberEps,a=Math.abs(c.getLength()-c.period)<n.numberEps;if(o&&a)return[{range1:i,range2:c,isSameDirection:r}];const h=i.period,g=e.getParamAt(t.getStartPt()),f=e.getParamAt(t.getEndPt()),p=r?new s.PeriodInterval(g,f,h):new s.PeriodInterval(f,g,h);return i.intersected(p,n.numberEps).map((n=>{const i=e.getPtAt(n.min),o=e.getPtAt(n.max),a=t.getParamAt(i),c=t.getParamAt(o),l=t.getParamMapper().getPeriod();return{range1:n,range2:r?new s.PeriodInterval(a,c,l):new s.PeriodInterval(c,a,l),isSameDirection:r}}))}if(l instanceof m.NurbsCurve3d&&d instanceof m.NurbsCurve3d||l instanceof p.NurbsCurve2d&&d instanceof p.NurbsCurve2d){const o=d.getParamAt(l.getStartPt()),a=l.getStartTangent().dot(d.getTangentAt(o))>0;if(i instanceof s.PeriodInterval&&c instanceof s.PeriodInterval){const e=Math.abs(i.getLength()-i.period)<n.numberEps,t=Math.abs(c.getLength()-c.period)<n.numberEps;if(e&&t)return[{range1:i,range2:c,isSameDirection:a}]}const u=e.getParamAt(t.getStartPt()),h=e.getParamAt(t.getEndPt());let g;if(i instanceof s.PeriodInterval&&c instanceof s.PeriodInterval){const e=i.period;g=a?new s.PeriodInterval(u,h,e):new s.PeriodInterval(h,u,e)}else g=a?new r.Interval(u,h):new r.Interval(h,u);return i.intersected(g,n.numberEps).map((n=>{const i=e.getPtAt(n.min),o=e.getPtAt(n.max),c=t.getParamAt(i),l=t.getParamAt(o),d=t.getParamMapper().getPeriod();let u;return u=d?a?new s.PeriodInterval(c,l,d):new s.PeriodInterval(l,c,d):a?new r.Interval(c,l):new r.Interval(l,c),{range1:n,range2:u,isSameDirection:a}}))}}static _extendCurvesOverlap(e,t,n){const s=e.getRange(),i=t.getBaseCurve().getMidPt(),o=e.getParamAt(i);let a;const c=e.getTangentAt(o),l=t.getBaseCurve().getMidTangent();if(c.isSameDirection(l,n.lengthEps))a=!0;else if(c.isOpposite(l,n.lengthEps))a=!1;else{const r=t.getBaseCurve().getRange(),s=t.getPtAt(r.min-.1),i=e.getParamAt(s),o=e.getTangentAt(i),c=t.getTangentAt(r.min-.1);a=o.isSameDirection(c,n.lengthEps)}const d=e.getParamAt(t.getStartPt()),u=e.getParamAt(t.getEndPt()),h=a?new r.Interval(d,u):new r.Interval(u,d);return s.intersected(h,n.numberEps).map((n=>{const s=e.getPtAt(n.min),i=e.getPtAt(n.max),o=t.getParamAt(s),c=t.getParamAt(i);return{range1:n,range2:a?new r.Interval(o,c):new r.Interval(c,o),isSameDirection:a}}))}static _nurbsCurvesOverlap(e,t,n){const i=e.getRange(),o=t.getRange(),a=e.getParamAt(t.getStartPt());let c;const l=e.getTangentAt(a),d=t.getStartTangent();if(l.isSameDirection(d,n.lengthEps))c=!0;else if(l.isOpposite(d,n.lengthEps))c=!1;else{const r=t.getRange();if(r instanceof s.PeriodInterval){const t=r.period-a,s=e.getTangentAt(t,!1);c=!!s.isSameDirection(d,n.lengthEps)||!s.isOpposite(d,n.lengthEps)&&l.dot(d)>0}else c=l.dot(d)>0}if(i instanceof s.PeriodInterval&&i.isClosed()&&o instanceof s.PeriodInterval&&o.isClosed())return[{range1:i,range2:o,isSameDirection:c}];const u=e.getParamAt(t.getEndPt());let h;if(i instanceof s.PeriodInterval&&o instanceof s.PeriodInterval){const e=i.period;h=c?new s.PeriodInterval(a,u,e):new s.PeriodInterval(u,a,e)}else h=c?new r.Interval(a,u):new r.Interval(u,a);return i.intersected(h,n.numberEps).map((n=>{const i=e.getPtAt(n.min),a=e.getPtAt(n.max),l=t.getParamAt(i),d=t.getParamAt(a);let u;return u=o instanceof s.PeriodInterval?c?new s.PeriodInterval(l,d,o.period):new s.PeriodInterval(d,l,o.period):c?new r.Interval(l,d):new r.Interval(d,l),{range1:n,range2:u,isSameDirection:c}}))}static _generalOpenCurves(e,t,n,r,s){const i=[{t1:e.getRange().min},{t1:e.getRange().max},{t2:t.getRange().min},{t2:t.getRange().max}],o=[];for(const n of i)void 0!==n.t1?(n.pt=e.getPtAt(n.t1),n.t2=C(t,n.pt,r.edgeLengthEps2),void 0!==n.t2&&o.push(n)):(n.pt=t.getPtAt(n.t2),n.t1=C(e,n.pt,r.edgeLengthEps2),void 0!==n.t1&&o.push(n));if(o.length<2)return[];const a=[],c=(n,s,i)=>{const o=n.t2<s.t2;if(o!==i)return;const c=t.getRange().clone(),l=o?c.set(n.t2,s.t2):c.set(s.t2,n.t2);if(!y.Util.isNearlySmallerOrEqual(t.getRange().max,l.min)&&!y.Util.isNearlyBiggerOrEqual(t.getRange().min,l.max)&&t.getPtAt(l.min).sqDistanceTo(t.getPtAt(l.max))>r.edgeLengthEps2&&u.CurveCurveColinear.testBySamples(e,t,l,r)){const t=e.getRange().clone().set(n.t1,s.t1);a.push({range1:t,range2:l,isSameDirection:o})}};o.sort(((e,t)=>e.t1!==t.t1?e.t1-t.t1:e.t2-t.t2));const l=e.getTangentAt(o[0].t1).dot(t.getTangentAt(o[0].t2))>0;if(n&&4===o.length){const e=i;l?(c(e[0],e[3],l),c(e[2],e[1],l)):(c(e[0],e[2],l),c(e[3],e[1],l))}else for(let e=1;e<o.length;e++)o[e].pt.sqDistanceTo(o[e-1].pt)>r.edgeLengthEps2&&c(o[e-1],o[e],l);return a}}t.CurveCurveOverlap=S},2648:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveSurfaceCoincide=void 0;const r=n(5804);t.CurveSurfaceCoincide=class{static execute(e,t,n){return t instanceof r.Plane?t.containsCurve(e,n.lengthEps,n.angleEps):t.containsCurve(e,n.lengthEps)}}},40616:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurfaceSurfaceCoplaner=void 0;const r=n(89494),s=n(87222),i=n(5804),o=n(47423),a=n(79034),c=n(56698);class l{static simple(e,t,n){return e instanceof o.SweepSurface?l._simpleSweepSurface(e,t,n):t instanceof o.SweepSurface?l._simpleSweepSurface(t,e,n):e.isCoplanar(t,n)}static _simpleSweepSurface(e,t,n){if(e instanceof o.SweepSurface&&t instanceof o.SweepSurface){const o=e.getProfile(),l=e.getPath(),d=e.getPathDz(),u=t.getProfile(),h=t.getPath(),g=t.getPathDz();if(l instanceof s.Line3d&&h instanceof s.Line3d){if(!l.isParallelTo(h,n.angleEps))return!1;const e=d.cross(l.getDirection()),t=new r.Coordinate3(l.getOrigin(),e,d),s=new i.Plane(t).getCurve3d(o),c=g.cross(h.getDirection()),f=new r.Coordinate3(h.getOrigin(),c,g),p=new i.Plane(f).getCurve3d(u),_=l.getOrigin().subtracted(h.getOrigin()).dot(l.getDirection());return p.translate(l.getDirection().multiplied(_)),a.CurveCurveColinear.curve3ds(s,p,n)}if(c.CurveCurveOverlap.curve3ds(l,h,n).length<1)return!1;const f=l.getStartPt(),p=l.getStartTangent(),_=d.cross(p),m=new r.Coordinate3(f,_,d),v=new i.Plane(m).getCurve3d(o),E=g.cross(p),P=new r.Coordinate3(f,E,g),y=new i.Plane(P).getCurve3d(u);return a.CurveCurveColinear.curve3ds(v,y,n)}const l=e.toSimpleSurfaces();for(const e of l)if(t.isCoplanar(e,n))return!0;return!1}}t.SurfaceSurfaceCoplaner=l},46989:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PositionJudge=void 0;const r=n(68238),s=n(79109),i=n(59683),o=n(50265),a=n(32171),c=n(56973),l=n(41454);t.PositionJudge=class{static isPtAbovePlane(e,t){return r.CalculateDistance.pointToSurfaceSigned(e,t)>0}static curveToCurve(e,t,n=c.Tolerance.LENGTH_EPS,r=c.Tolerance.ANGLE_EPS){return a.CurveCurvePositionJudge.execute(e,t,n,r)}static curveCurveOverlap(e,t,n=c.Tolerance.LENGTH_EPS,r=c.Tolerance.ANGLE_EPS){return l.CurveCurveOverlapJudge.execute(e,t,n,r)}static ptToLoop(e,t,n=c.Tolerance.LENGTH_EPS){return i.PtLoopPositionJudge.execute(e,t,n)}static ptToPolygon(e,t,n=c.Tolerance.LENGTH_EPS){return o.PtPolygonPositionJudge.execute(e,t,n)}static loopToLoop(e,t,n=c.Tolerance.LENGTH_EPS,r=!1){return s.LoopLoopPositionJudge.execute(e,t,n,r)}}},41454:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveCurveOverlapJudge=void 0;const r=n(90676),s=n(49246),i=n(56973),o=n(68990),a=n(2111),c=n(56698);t.CurveCurveOverlapJudge=class{static execute(e,t,n=i.Tolerance.LENGTH_EPS,l=i.Tolerance.ANGLE_EPS){let d;const u=new i.Tolerance(n,l);if(e instanceof o.Curve2d&&t instanceof o.Curve2d)d=c.CurveCurveOverlap.curve2ds(e,t,u);else{if(!(e instanceof a.Curve3d&&t instanceof a.Curve3d))throw new Error("Unknown curve types");d=c.CurveCurveOverlap.curve3ds(e,t,u)}const h=d.filter((e=>e.range1.getLength()>i.Tolerance.NUMBER_EPS));if(0===d.length)return r.CurveCuvePositonType.NOT_INTERSECT;if(0===h.length)return r.CurveCuvePositonType.INTERSECT_ON;if(d.length>1)return r.CurveCuvePositonType.OVERLAP;const g=h[0];return s.Util.isNearlyEqual(g.range1.getLength(),e.getRange().getLength(),n)&&s.Util.isNearlyEqual(g.range2.getLength(),t.getRange().getLength(),n)?r.CurveCuvePositonType.TOTALLY_OVERLAP:r.CurveCuvePositonType.OVERLAP}}},32171:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveCurvePositionJudge=void 0;const r=n(90676),s=n(17980),i=n(56973),o=n(68990),a=n(2111);t.CurveCurvePositionJudge=class{static execute(e,t,n=i.Tolerance.LENGTH_EPS,c=i.Tolerance.ANGLE_EPS){var l,d;if(e.isNurbsCurve()||t.isNurbsCurve())return r.CurveCuvePositonType.NOT_INTERSECT;function u(e){return!!(e.isArc()||e.isLine()||e.isOffsetCurve())}if(!u(e)||!u(t))return-1;const h=new i.Tolerance(n,c);let g;if(e instanceof o.Curve2d&&t instanceof o.Curve2d)g=s.CurveCurveIntersect.curve2ds(e,t,h);else{if(!(e instanceof a.Curve3d&&t instanceof a.Curve3d))throw new Error("unknown curve type");g=s.CurveCurveIntersect.curve3ds(e,t,h)}return g.length<1?r.CurveCuvePositonType.NOT_INTERSECT:g.some((e=>e.isOverlap))?1===g.length&&(null===(l=g[0].overlap1)||void 0===l?void 0:l.equals(e.getRange()))&&(null===(d=g[0].overlap2)||void 0===d?void 0:d.equals(t.getRange()))?r.CurveCuvePositonType.TOTALLY_OVERLAP:r.CurveCuvePositonType.OVERLAP:g.some((r=>!e.getRange().containsPointAtStartOrEnd(r.param1,n)||!t.getRange().containsPointAtStartOrEnd(r.param2,n)))?r.CurveCuvePositonType.INTERSECT_IN:r.CurveCuvePositonType.INTERSECT_ON}}},79109:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoopLoopPositionJudge=void 0;const r=n(90676),s=n(47035),i=n(56973),o=n(61077);t.LoopLoopPositionJudge=class{static execute(e,t,n=i.Tolerance.LENGTH_EPS,a=!1){const c=s.BoolOperate2d.intersect([e,t]),l=()=>{for(const n of e.getAllCurves())for(const e of t.getAllCurves()){if(o.CalculateIntersect.curve2ds(n,e).length>0)return!0}return!1};if(!this._polygonIsValid(c))return a&&l()?r.LoopLoopPositonType.INTERSECT:r.LoopLoopPositonType.OUT;const d=s.BoolOperate2d.difference(e,[t]),u=s.BoolOperate2d.difference(t,[e]),h=this._polygonIsValid(d),g=this._polygonIsValid(u);if(!h&&!g)return r.LoopLoopPositonType.EQUAL;if(!h&&g)return a&&l()?r.LoopLoopPositonType.INTERSECT:r.LoopLoopPositonType.IN;if(h&&!g)return a&&l()?r.LoopLoopPositonType.INTERSECT:r.LoopLoopPositonType.CONTAIN;if(h&&g)return r.LoopLoopPositonType.INTERSECT;throw new Error("未知类型")}static _polygonIsValid(e){return e.calcArea()>i.Tolerance.DELTA_EPS}}},18664:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointPolygonPositionJudger=void 0;const r=n(90676),s=n(56973),i=n(33218);class o{constructor(e,t=4){this._nodes=[];const n=[];e.forEach((e=>{for(let t=0;t<e.length;t++){const r=e[t],s=e[(t+1)%e.length],[i,o]=r.y<s.y?[r.y,s.y]:[s.y,r.y];n.push({stPoint:r,edPoint:s,min:i,max:o})}})),n.sort(((e,t)=>e.min===t.min?e.max-t.max:e.min-t.min)),this._nodes.push(n);for(let e=n;e.length>1;){const n=Math.ceil(e.length/t),r=new Array(n);for(let s=0;s<n;s++){const i=s*t,o=s===n-1?e.length:i+t;let a=e[i].max;for(let t=i+1;t<o;t++)e[t].max>a&&(a=e[t].max);const c=e[i].min;r[s]={min:c,max:a,st:i,ed:o}}this._nodes.push(r),e=r}}findSegments(e,t=s.Tolerance.LENGTH_EPS){const n=[{layer:this._nodes.length-1,index:0}],r=[],i=e+t,o=e-t;for(;n.length>0;){const e=n.pop(),t=this._nodes[e.layer][e.index],s=this._nodes[e.layer-1];for(let a=t.st;a<t.ed;a++){const t=s[a];t.min<i&&t.max>o&&(t.stPoint?r.push(t):n.push({layer:e.layer-1,index:a}))}}return r}}t.PointPolygonPositionJudger=class{constructor(e){this._tree=new o(e)}judge(e,t=s.Tolerance.LENGTH_EPS){const n=this._tree.findSegments(e.y,t);let o=0,a=!1;for(const s of n){const n=new i.Vector2(e).subtract(s.stPoint);if(n.getSqLength()<t*t)return r.PtLoopPositonType.ONVERTEX;const c=new i.Vector2(s.edPoint).subtract(s.stPoint),l=c.getLength();c.multiply(1/l);const d=n.dot(c),u=n.dot({x:-c.y,y:c.x});if(Math.abs(u)<t&&d>0&&d<l){a=!0;continue}if(Math.abs(n.y)<t)continue;d*c.x+s.stPoint.x>e.x&&o++}return a?r.PtLoopPositonType.ONEDGE:o%2==0?r.PtLoopPositonType.OUT:r.PtLoopPositonType.IN}}},90676:function(e,t){"use strict";var n,r,s;Object.defineProperty(t,"__esModule",{value:!0}),t.LoopLoopPositonType=t.PtLoopPositonType=t.CurveCuvePositonType=void 0,function(e){e[e.NOT_INTERSECT=0]="NOT_INTERSECT",e[e.OVERLAP=10]="OVERLAP",e[e.TOTALLY_OVERLAP=11]="TOTALLY_OVERLAP",e[e.INTERSECT_IN=21]="INTERSECT_IN",e[e.INTERSECT_ON=22]="INTERSECT_ON"}(n||(n={})),t.CurveCuvePositonType=n,function(e){e[e.OUT=0]="OUT",e[e.ONEDGE=-1]="ONEDGE",e[e.ONVERTEX=-2]="ONVERTEX",e[e.IN=1]="IN"}(r||(r={})),t.PtLoopPositonType=r,function(e){e.INTERSECT="intersect",e.EQUAL="equal",e.IN="in",e.CONTAIN="contain",e.OUT="out"}(s||(s={})),t.LoopLoopPositonType=s},59683:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PtLoopPositionJudge=void 0;const r=n(90676),s=n(33218),i=n(32858),o=n(56973),a=n(49246),c=n(17980),l=n(6688),d=n(4097);t.PtLoopPositionJudge=class{static execute(e,t,n=o.Tolerance.LENGTH_EPS){const u=new o.Tolerance(n);d.MathError.mutedWarn(t.isClosed(u),"PtLoopPositionJudge: loop不封闭！！！！！！");const h=t.getAllCurves(),g=h.length;if(g<1)return{type:r.PtLoopPositonType.OUT};for(let t=0;t<g;++t){const s=h[t],i=s.getStartPt();if(e.equals(i,n))return{type:r.PtLoopPositonType.ONVERTEX,curve:s}}const f=e.x,p=e.y;let _,m=0,v=[];const E=h[0].getStartPt();if(a.Util.isNearlyEqual(E.y,p,n)&&a.Util.isNearlyBigger(E.x,f,n)){let r=g-1;for(_=h[r];_ instanceof i.Line2d&&Math.abs(_.getDirection().y)<n;)r--,_=h[r];if(void 0===_)return this._dealHorizontalLineLoop(e,t,n);const o=new i.Line2d(e,s.Vector2.X(),l.Interval.infinitArray());v=c.CurveCurveIntersect.curve2ds(o,_,u),v.sort(((e,t)=>e.param2-t.param2));m=this._getRefPt(_,v,!1,n).y-e.y}let P=0;for(let t=0;t<g;++t){const o=h[t],d=o.getStartPt(),g=o.getEndPt();if(o instanceof i.Line2d){if(a.Util.isNearlyEqual(d.y,p,n)&&a.Util.isNearlyEqual(g.y,p,n)){if(a.Util.isNearlySmaller(g.x,f,n)===a.Util.isNearlyBigger(d.x,f,n))return{type:r.PtLoopPositonType.ONEDGE,curve:o};continue}if(new l.Interval(d.y,g.y,!0).containsPoint(p,n)){const t=(p-o.getOrigin().y)/o.getDirection().y;if(o.getRange().containsPoint(t,n)){const s=o.getOrigin().x+t*o.getDirection().x;if(a.Util.isNearlyEqual(s,f,n)||o.containsPoint(e,n))return{type:r.PtLoopPositonType.ONEDGE,curve:o};if(a.Util.isNearlyBigger(s,f,n))if(a.Util.isNearlyEqual(d.y,p,n)){P=(g.y-p)*m<0?P+1:P}else a.Util.isNearlyEqual(g.y,p,n)?m=d.y-p:P++}else a.Util.isNearlyEqual(g.y,p,n)&&(m=d.y-p)}}else{let t;if(o===_)t=v;else{const n=new i.Line2d(e,s.Vector2.X(),l.Interval.infinitArray());t=c.CurveCurveIntersect.curve2ds(n,o,u),t.sort(((e,t)=>e.param2-t.param2))}for(let s=0;s<t.length;s++){const i=t[s];if(!(i.param1<-n)){if(a.Util.isNearlyEqual(i.param1,0,n)||o.containsPoint(e,n))return{type:r.PtLoopPositonType.ONEDGE,curve:o};if(a.Util.isNearlyEqual(i.param2,o.getStartParam(),n)){P=(this._getRefPt(o,t,!0,n).y-e.y)*m<0?P+1:P}else if(a.Util.isNearlyEqual(i.param2,o.getEndParam(),n)){m=this._getRefPt(o,t,!1,n).y-e.y}else{const r=o.getTangentAt(i.param2);if(Math.abs(r.y)<n){let n;n=s-1<0?o.getStartParam():t[s-1].param2;const r=o.getPtAt((i.param2+n)/2).y-e.y;let a;a=s+1>t.length-1?o.getStartParam():t[s+1].param2;if(r*(o.getPtAt((i.param2+a)/2).y-e.y)>0)continue}P++}}}}}return{type:P%2}}static _dealHorizontalLineLoop(e,t,n=o.Tolerance.LENGTH_EPS){const s=e.x;for(const e of t.getAllCurves())return a.Util.isNearlyEqual(e.getStartPt().x,s,n)?{type:r.PtLoopPositonType.ONVERTEX,curve:e}:a.Util.isNearlyBigger(e.getStartPt().x,s,n)===a.Util.isNearlySmaller(e.getEndPt().x,s,n)?{type:r.PtLoopPositonType.ONEDGE,curve:e}:{type:r.PtLoopPositonType.OUT};return{type:r.PtLoopPositonType.OUT}}static _getRefPt(e,t,n,r=o.Tolerance.LENGTH_EPS){let s;if(t.length<2)s=n?e.getEndParam():e.getStartParam();else{const i=n?e.getStartParam():e.getEndParam();let o;o=e.getStartPt().equals(e.getEndPt(),r)?Math.abs(e.getStartParam()-t[0].param2)<r?n?t[1].param2:t[t.length-1].param2:n?t[0].param2:t[t.length-2].param2:n?t[1].param2:t[t.length-2].param2,s=(o+i)/2}return e.getPtAt(s)}}},50265:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PtPolygonPositionJudge=void 0;const r=n(90676),s=n(59683),i=n(56973);t.PtPolygonPositionJudge=class{static execute(e,t,n=i.Tolerance.LENGTH_EPS){const o=t.getBoundingBox();if(!o.isValid()||!o.containsPoint(e,n))return r.PtLoopPositonType.OUT;const a=s.PtLoopPositionJudge.execute(e,t.getLoops()[0],n);if(a.type===r.PtLoopPositonType.ONEDGE||a.type===r.PtLoopPositonType.ONVERTEX)return a.type;const c=t.getLoops();for(let t=1;t<c.length;t++){const i=s.PtLoopPositionJudge.execute(e,c[t],n);if(i.type===r.PtLoopPositonType.ONEDGE||i.type===r.PtLoopPositonType.ONVERTEX)return i.type;if(i.type===r.PtLoopPositonType.IN)return r.PtLoopPositonType.OUT}return a.type}}},46172:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Curve3dProjectToPlane=void 0;const r=n(67579),s=n(43364),i=n(10909),o=n(74729),a=n(56973),c=n(32858),l=n(60229),d=n(97700),u=n(33218),h=n(61226),g=n(17165),f=n(43640),p=n(98106);t.Curve3dProjectToPlane=class{constructor(e,t,n=a.Tolerance.DEFAULT){this._plane=t,this._curve=e,this._tol=n}execute(){if(this._curve.isLine3d()){const e=this._plane.getUVAt(this._curve.getStartPt()),t=this._plane.getUVAt(this._curve.getEndPt());if(e.equals(t))return;return new c.Line2d(e,t)}if(this._curve.isArc3d()){const e=this._curve;if(e.getNormal().isParallel(this._plane.getNorm(),this._tol.angleEps)){const t=e.getCoord(),n=this._plane.getCoord(),r=n.getLocalVectorAt(t.getDx()),s=n.getLocalPtAt(t.getOrigin()),a=new o.Coordinate2(s,r),c=e.getRange().toArray(),l=e.getNormal().dot(n.getDz())>0;return new i.Arc2d(a,e.getA(),e.getB(),l,c)}const t=this._plane.getCoord().getWorldToLocalMatrix(),n=e.transformed(t);if(e.getNormal().isPerpendicular(this._plane.getNorm(),this._tol.angleEps)){const e=this._plane.getNorm().dot(n.getCoord().getDx()),t=Math.sqrt(1-e*e),r=Math.atan2(e/n.getA(),t/n.getB()),s=n.getPtAt(r),i=n.getPtAt(r+l.CONST.PI),o=new c.Line2d(s,i);if(!n.getRange().containsPoint(r)){const e=o.getParamAt(n.getStartPt()),t=o.getParamAt(n.getEndPt());o.setRange(e<t?e:t,o.getRange().max)}if(!n.getRange().containsPoint(r+l.CONST.PI)){const e=o.getParamAt(n.getStartPt()),t=o.getParamAt(n.getEndPt());o.setRange(o.getRange().min,e>t?e:t)}return o}const r=n.getCenter(),s=n.getPtAt(0).subtract(r),a=n.getPtAt(l.CONST.PI_4).subtract(r),g=n.getPtAt(l.CONST.PI_2).subtract(r),f=[[s.x*s.x,s.x*s.y,s.y*s.y],[a.x*a.x,a.x*a.y,a.y*a.y],[g.x*g.x,g.x*g.y,g.y*g.y]],p=[1,1,1],_=d.LinearSystem.execute(f,p);if(void 0===_)return;const m=.5*Math.atan(_[1]/(_[0]-_[2])),v=Math.cos(m),E=Math.sin(m),P=_[0]*v*v+_[2]*E*E+_[1]*v*E,y=_[2]*v*v+_[0]*E*E-_[1]*v*E,C=Math.sqrt(1/P),S=Math.sqrt(1/y),T=new o.Coordinate2(r,new u.Vector2(v,E)),b=n.getNormal().dot(h.Vector3.Z())>0,w=new i.Arc2d(T,C,S,b),x=w.getParamAt(n.getStartPt());let M;return M=Math.sqrt(n.getRange().getLength()-l.CONST.PI2)<this._tol.numberEps?x+l.CONST.PI2:w.getParamAt(n.getEndPt()),w.setRange(x,M),w}if(this._curve instanceof r.SmoothPoly3d){const e=this._curve.getPoints().map((e=>this._plane.getUVAt(e)));return new s.SmoothPoly2d(e)}const e=g.DiscreteUtil.discreteCurve3d(this._curve,f.DiscreteParameter.NORMAL).map((e=>this._plane.getUVAt(e)));return p.NurbsCurve2d.makeByInterpolationPoints(e)}}},38666:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveCurveProject=void 0;const r=n(6688);t.CurveCurveProject=class{static lines(e,t){const n=t.getParamAt(e.getStartPt()),s=t.getParamAt(e.getEndPt());return new r.Interval(n,s,!0)}}},1760:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SearchGraph=void 0;const r=n(45003),s=n(72179),i=n(85232),o=n(44210),a=n(97505),c=n(55654),l=n(25182),d=n(56973);class u{static searchLoop2D(e,t,n=d.Tolerance.LENGTH_EPS){return c.SearchLoop2D.execute(e,t,n)}static simpleLoop(e,t=d.Tolerance.LENGTH_EPS){return s.SearchSimpleLoop.execute(e,t)}static simpleHole(e){let t=u.simpleLoop(e);if(!t.length)return[];t=t.filter((e=>e.getType()===a.EN_GEO_ELEMENT_TYPE.EN_LOOP));const n=r.LoopsToLoopTreeSearchGraph.execute(t);n.makeValid(!0);const s=[];return n.collectHoles(s),s.forEach((e=>{e.reverse()})),s}static simplePolygon(e,t=d.Tolerance.LENGTH_EPS){const n=u.simpleLoop(e,t);if(!n.length)return;for(const e of n)if(e.getType()!==a.EN_GEO_ELEMENT_TYPE.EN_LOOP)return;const s=r.LoopsToLoopTreeSearchGraph.execute(n);s.makeValid(!0);const i=[];return s.collectLoops(i),new o.Polygon(i)}static loopsToTree(e){return r.LoopsToLoopTreeSearchGraph.execute(e)}static loopsToPolygonExes(e){return i.ILoopsToPolygonExes.execute(e,!0).map((e=>{const t=new o.Polygon;return e.forEach((e=>t.addLoop(e,!1))),t}))}static polygonToPolygonExes(e){return e.getLoops().length<2?[e]:l.PolygonToPolygonExes.execute(e)}static polygonToHoles(e){return u.loopsToHoles(e.getLoops())}static loopsToHoles(e){const t=[];return u.loopsToTree(e).collectHoles(t),t.forEach((e=>{e.reverse()})),t}}t.SearchGraph=u},85232:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ILoopsToPolygonExes=void 0;const r=n(59683),s=n(90676),i=n(16178),o=n(44757),a=n(98106);t.ILoopsToPolygonExes=class{static execute(e,t,n=!1,r=(e=>(o.MathAssert.assert(e instanceof i.Loop,"请添加该参数"),e))){if(!e.length)return[];const s=[],a=this.getNestedLoops(e,r),c=new Map;e.forEach((e=>c.set(e,!1)));for(const e of a)0===e.level&&this.createFaces(e,n,c,s);return s.map((e=>e.map(((e,n)=>(t&&(e.isCCW?0!==n&&e.loop.reverse():0===n&&e.loop.reverse()),e.loop)))))}static getNestedLoops(e,t){const n=new Map;e.forEach((e=>n.set(e,t(e))));const r=e.map((e=>({loop:e,nesting:[],level:0,isCCW:n.get(e).isAnticlockwise()})));for(let e=0;e<r.length;++e){const t=r[e];for(let s=0;s<r.length;++s){if(e===s)continue;const i=r[s];this._loopContainsLoop(n.get(t.loop),n.get(i.loop))&&(t.nesting.push(i),i.level++)}}for(const e of r)e.nesting.sort(((e,t)=>e.level-t.level));return r.filter((e=>0===e.level))}static createFaces(e,t,n,r){const s=e.loop,i=[e];r.push(i),n.set(s,!0);let o=-1,a=0;for(const s of e.nesting)s.level>o&&(o=s.level,a++),n.get(s.loop)||(2===a?this.createFaces(s,t,n,r):1===a&&(t?s.isCCW!==e.isCCW?(i.push(s),n.set(s.loop,!0)):this.createFaces(s,t,n,r):(i.push(s),n.set(s.loop,!0))))}static _loopContainsLoop(e,t){let n=t.getAllCurves().map((e=>e.getMidPt()));n.sort((()=>.5-Math.random())),n=n.slice(0,Math.min(3,n.length));let o=e;if(e.getAllCurves().some((e=>e instanceof a.SmoothPoly2d))){const t=e.getAllCurves().map((e=>e instanceof a.SmoothPoly2d?e.getSegments():[e])).flat();o=new i.Loop(t)}for(const e of n){if(r.PtLoopPositionJudge.execute(e,o).type!==s.PtLoopPositonType.IN)return!1}return!0}}},29542:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoopTreeNode=void 0;const r=n(44757),s=n(44210);t.LoopTreeNode=class{constructor(){this.children=[]}addToChild(e){this.children||(this.children=[]),this.children.push(e)}isPolygonValid(){let e=!1;if(this.data&&(e=this.data.isAnticlockwise()),!this.children||this.children.length<1)return!0;for(const t of this.children){if(!t.data||e===t.data.isAnticlockwise())return!1;if(!t.isPolygonValid())return!1}return!0}makeValid(e){this.data&&(e?this._makeClockwise():this._makeAnticlockwise()),this.children&&this.children.length&&this.children.forEach((t=>{t.makeValid(!e)}))}collectLoops(e){this.data&&e.push(this.data),this.children&&this.children.length&&this.children.forEach((t=>{t.collectLoops(e)}))}collectHoles(e){if(this.data&&!this.data.isAnticlockwise()){const t=new s.Polygon(this.data);this.children&&this.children.length&&this.children.forEach((e=>{e.data&&(r.MathAssert.assert(e.data.isAnticlockwise()),t.addLoop(e.data))})),e.push(t)}this.children&&this.children.length&&this.children.forEach((t=>{t.collectHoles(e)}))}collectNewPolygonExes(e){if(this.data&&this.data.isAnticlockwise()){const t=new s.Polygon(this.data);this.children&&this.children.length&&this.children.forEach((e=>{e.data&&(r.MathAssert.assert(!e.data.isAnticlockwise()),t.addLoop(e.data.clone()))})),e.push(t)}this.children&&this.children.length&&this.children.forEach((t=>{t.collectNewPolygonExes(e)}))}_makeClockwise(){this.data?this.data.isAnticlockwise()&&this.data.reverse():this.children&&this.children.length&&this.children.forEach((e=>{e.data&&e.data.isAnticlockwise()&&e.data.reverse()}))}_makeAnticlockwise(){this.data?this.data.isAnticlockwise()||this.data.reverse():this.children&&this.children.length&&this.children.forEach((e=>{e.data&&(e.data.isAnticlockwise()||e.data.reverse())}))}}},45003:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LoopsToLoopTreeSearchGraph=void 0;const r=n(20666),s=n(45987),i=n(29542),o=n(33218),a=n(43640),c=n(23863);class l{static execute(e){const t=e.map((e=>{const t=c.DiscreteTopology.discretePolyline(e,a.DiscreteParameter.CALCULATE);return s.ClipperFormatConverter.vector2sToXY(t)}));r.JS.ScaleUpPaths(t,l.scale);const n=new r.Clipper;n.AddPaths(t,r.PolyType.ptClip,!0),n.AddPath([],r.PolyType.ptSubject,!0);const i=new r.PolyTree;n.Execute(r.ClipType.ctUnion,i);const o=e.map((e=>l._ptsToKey(e.toPath())));return l._polyTreeToLoopTree(i,void 0,o,[...e])}static _ptToKey(e){const t=e.multiplied(l.scale);return`${Math.round(t.x)}_${Math.round(t.y)}`}static _ptsToKey(e){let t="";return e.forEach((e=>{t+=`${l._ptToKey(new o.Vector2(e))},`})),t}static _polyTreeToLoopTree(e,t,n,r){const o=new i.LoopTreeNode;if(t&&t.addToChild(o),e.m_polygon&&e.m_polygon.length>0){const t=s.ClipperFormatConverter.pathToLoop(e.m_polygon),i=l._findLoop(t,n,r);t.isAnticlockwise()!==i.isAnticlockwise()&&i.reverse(),o.data=i}if(!e.m_Childs||e.m_Childs.length<1)return o;for(const t of e.m_Childs)l._polyTreeToLoopTree(t,o,n,r);return o}static _findLoop(e,t,n){const r=1/l.scale,s=e.toPath().map((e=>e.multiply(r))),i=[];n.forEach((e=>i.push(0)));for(const e of s){const n=e,r=`,${l._ptToKey(n)},`;t.forEach(((e,t)=>{e.includes(r)&&i[t]++}))}const o=Math.max(...i);if(0===o)throw new Error("cant find, bug!!");const a=i.findIndex((e=>e===o));t.splice(a,1);return n.splice(a,1)[0]}}t.LoopsToLoopTreeSearchGraph=l,l.scale=1e5},25182:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PolygonToPolygonExes=void 0;const r=n(44210),s=n(85232);t.PolygonToPolygonExes=class{static execute(e){return s.ILoopsToPolygonExes.execute(e.getLoops(),!1).map((e=>new r.Polygon(e)))}}},55654:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SearchLoop2D=void 0;const r=n(16178),s=n(41454),i=n(90676),o=n(49246),a=n(32858),c=n(10909),l=n(56973);t.SearchLoop2D=class{static execute(e,t,n=l.Tolerance.LENGTH_EPS){const a=new Map;for(const t of e){const e=t.getStartPt();let r;for(const[t,s]of a)if(t.equals(e,n)){r=s;break}r||(r=[],a.set(e,r)),r.push(t)}const c=[],d=new Set,u=e.slice();for(const e of u){if(!e||d.has(e))continue;const r=[],l=new Set;let u=e;for(;u;){l.add(u);const e=r.length,h=e>0?r[e-1]:null;if(h&&s.CurveCurveOverlapJudge.execute(h,u,n)===i.CurveCuvePositonType.TOTALLY_OVERLAP){u.getStartPt().equals(u.getEndPt(),n)&&o.Util.isNearlyBigger(u.getLength(),n)&&(c.push([h]),c.push([u]),d.add(h),d.add(u)),r.pop()}else r.push(u);const g=u.getEndPt();let f=[];for(const[e,t]of a)if(e.equals(g,n)){f=t;break}const p=this._findMaxTurning2D(u,f,t,n);if(!p||d.has(p)||l.has(p))break;u=p}for(;r.length>=1;){const e=r[0].getStartPt(),t=r[r.length-1].getEndPt();if(e.equals(t,n)){for(;r.length>=2&&s.CurveCurveOverlapJudge.execute(r[0],r[r.length-1],n)===i.CurveCuvePositonType.TOTALLY_OVERLAP;)r.shift(),r.pop();r.length&&(c.push(r),r.forEach((e=>d.add(e))));break}r.shift()}}return c.map((e=>new r.Loop(e)))}static _findMaxTurning2D(e,t,n,r){let c,l=-10,d=!1;const u=e.getEndTangent();for(const h of t){const t=h.getStartTangent();let g=0,f=!1;if(s.CurveCurveOverlapJudge.execute(e,h,r)===i.CurveCuvePositonType.TOTALLY_OVERLAP)g=-Math.PI,f=!0;else if(g=n?u.angleTo(t):t.angleTo(u),g>=Math.PI&&(g-=2*Math.PI),!(h instanceof a.Line2d&&e instanceof a.Line2d)){let r=1;const s=this._getAppropriateUnitStepLength([h,e]);for(;r<100&&(o.Util.isNearlyEqual(g,Math.PI,.01)||o.Util.isNearlyEqual(g,-Math.PI,.01));)g=this._calcStepAngle(e,h,u,t,s*r,n),r++}if(o.Util.isNearlyBigger(g,l)){c=h,d=f,l=g;continue}let p=g,_=l;if(!(h instanceof a.Line2d&&e instanceof a.Line2d&&c instanceof a.Line2d)){const s=this._getAppropriateUnitStepLength([h,e,c]);let i=1;for(;o.Util.isNearlyEqual(p,_,r)&&i<=100;)h instanceof a.Line2d&&e instanceof a.Line2d||(p=this._calcStepAngle(e,h,u,t,s*i,n)),c instanceof a.Line2d&&e instanceof a.Line2d||(_=this._calcStepAngle(e,c,u,t,s*i,n)),i++}(p>_||p===_&&d)&&(c=h,d=f)}return c}static _getAppropriateUnitStepLength(e){let t=Number.MIN_VALUE;for(const n of e){let e=t;e=n instanceof c.Arc2d?.01*n.getRadius():.1,t=Math.max(t,e)}return t}static _calcStepAngle(e,t,n,r,s,i=!0){let o=r;if(!(t instanceof a.Line2d)){const e=this._getAppropriateParamStep(t,s),n=t.getRange().min+e;o=t.getTangentAt(n)}let c=n;if(!(e instanceof a.Line2d)){const n=this._getAppropriateParamStep(e,s),r=e.getRange().max-n;c=t.getTangentAt(r)}let l=0;return l=i?c.angleTo(o):o.angleTo(c),l>=Math.PI&&(l-=2*Math.PI),l}static _getAppropriateParamStep(e,t){const n=t/e.getLength(),r=e.getRange().getLength();let s=r*n;return s>r&&(s=.5*r),s}}},72179:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SearchSimpleLoop=void 0;const r=n(44757),s=n(57991),i=n(16178),o=n(56973);class a{static execute(e,t=o.Tolerance.LENGTH_EPS){if(e.length<1)return[];if(1===e.length){return[new s.PolyCurve([e[0].clone()])]}const n=[],r=new Map;for(e.forEach(((e,t)=>r.set(e,t)));r.size;){const e=[a._findAndRemoveLongestCurve(r)];for(;r.size;){const n=a._findAndRemoveNextCurve(e[e.length-1][0].getEndPt(),r,t);if(!n)break;e.push(n)}for(;r.size;){const n=a._findAndRemoveNextCurve(e[0][0].getStartPt(),r,t);if(!n)break;n[0].reverse(),e.splice(0,0,n)}const o=new i.Loop;for(const[t]of e)o.addCurve(t);if(o.isValid())n.push(o);else{const e=new s.PolyCurve;o.getAllCurves().forEach((t=>{e.addCurve(t)})),n.push(e)}}return n.forEach((e=>{e.isAnticlockwise()||e.reverse()})),n}static _findAndRemoveLongestCurve(e){r.MathAssert.assert(e.size);let t,n=-1;for(const[r,s]of e){const e=r.getLength();e>n&&(n=e,t=[r,s])}return r.MathAssert.assert(t),e.delete(t[0]),t}static _findAndRemoveNextCurve(e,t,n){const s=[];for(const[r]of t){const t=r.getStartPt().distanceTo(e),i=r.getEndPt().distanceTo(e);t<n&&i<n?t>i?s.push({cv:r,d:i,reverse:!0}):s.push({cv:r,d:t,reverse:!1}):t<n?s.push({cv:r,d:t,reverse:!1}):i<n&&s.push({cv:r,d:i,reverse:!0})}if(s.length<1)return;s.sort(((e,t)=>e.d-t.d));const i=s[0],o=t.get(i.cv);r.MathAssert.assert(void 0!==o),t.delete(i.cv);const a=i.cv.clone();return i.reverse&&a.reverse(),[a,o]}}t.SearchSimpleLoop=a},99138:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TopologyEdit=void 0;const r=n(16178),s=n(32858),i=n(98106);t.TopologyEdit=class{static splitPolygonRegion(e){if(0===e.getLoops().length)return new r.Loop;let t=e.getLoops()[0].clone();for(let n=1;n<e.getLoops().length;n++)t=this._splitLoopLoopRegion(t,e.getLoops()[n].clone());return t}static _splitLoopLoopRegion(e,t){if(0===e.getAllCurves().length||0===t.getAllCurves().length)return t.getAllCurves().length>0?t:e;const n={minDist:e.getAllCurves()[0].getStartPt().sqDistanceTo(t.getAllCurves()[0].getStartPt()),index1:0,index2:0};for(let r=0;r<e.getAllCurves().length;r++){const s=e.getAllCurves()[r];for(let e=0;e<t.getAllCurves().length;e++){const i=t.getAllCurves()[e],o=s.getStartPt().sqDistanceTo(i.getStartPt());o<n.minDist&&(n.minDist=o,n.index1=r,n.index2=e)}}const r=new s.Line2d(e.getAllCurves()[n.index1].getStartPt(),t.getAllCurves()[n.index2].getStartPt());let o,a,c,l;for(let t=0;t<e.getAllCurves().length;t++){const n=e.getAllCurves()[t];if(n.isLine2d())continue;const s=i.MathAlg.CalculateIntersect.curve2ds(r,n).filter((e=>!e.point.equals(n.getStartPt())&&!e.point.equals(n.getEndPt())));if(s.length>0){a=s,o=t;break}}for(let e=0;e<t.getAllCurves().length;e++){const n=t.getAllCurves()[e];if(n.isLine2d())continue;const s=i.MathAlg.CalculateIntersect.curve2ds(r,n).filter((e=>!e.point.equals(n.getStartPt())&&!e.point.equals(n.getEndPt())));if(s.length>0){l=s,c=e;break}}if(void 0!==o){a.sort(((e,t)=>t.param1-e.param1)),r.getRange().min=a[0].param1;const t=e.getAllCurves()[o],s=t.clone();s.getRange().min=a[0].param2,t.getRange().max=a[0].param2,e.insertCurve(o+1,s),n.index1=o+1}else if(void 0!==c){l.sort(((e,t)=>e.param1-t.param1)),r.getRange().max=l[0].param1;const e=t.getAllCurves()[c],s=e.clone();s.getRange().min=l[0].param2,e.getRange().max=l[0].param2,t.insertCurve(c+1,s),n.index2=c+1}e.insertCurve(n.index1,r);const d=t.getAllCurves().slice(n.index2),u=t.getAllCurves().slice(0,n.index2);e.insertCurve(n.index1+1,...d),e.insertCurve(n.index1+1+d.length,...u);const h=r.clone();return h.reverse(),e.insertCurve(n.index1+1+t.getAllCurves().length,h),e}}},83437:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Box=void 0;const r=n(49246),s=n(56973),i=n(44757);t.Box=class{constructor(){this.makeEmpty()}expandByScalar(e){return this.min.multiply(e),this.max.multiply(e),this}setFromPoints(e){if(this.makeEmpty(),e)for(const t of e)this.expandByPoint(t);return this}getCenter(){return this.isValid()?this.min.clone().add(this.max).multiply(.5):(i.MathAssert.warn(!1,"box is not valid, get centerPt failure"),this.min.clone())}getSize(){return this.max.clone().subtract(this.min)}containsBox(e,t=s.Tolerance.LENGTH_EPS){return this.containsPoint(e.min,t)&&this.containsPoint(e.max,t)}intersectsBox(e,t=s.Tolerance.LENGTH_EPS){if(!this.isValid()||!e.isValid())return!1;for(let n=0;n<e.min.data.length;n++)if(r.Util.isNearlySmaller(this.max.data[n],e.min.data[n],t)||r.Util.isNearlyBigger(this.min.data[n],e.max.data[n],t))return!1;return!0}union(e){return e.isValid()?(this.expandByPoint(e.min),this.expandByPoint(e.max),this):this}isZeroSizeBox(){for(let e=0;e<this.max.data.length;e++)if(Math.abs(this.max.data[e]-this.min.data[e])<s.Tolerance.NUMBER_EPS)return!0;return!0}isValid(){for(let e=0;e<this.max.data.length;e++){if(!Number.isFinite(this.min.data[e])||!Number.isFinite(this.max.data[e])||Number.isNaN(this.min.data[e])||Number.isNaN(this.max.data[e]))return!1;if(!(Math.abs(this.min.data[e]-this.max.data[e])<s.Tolerance.NUMBER_EPS)&&this.min.data[e]>this.max.data[e])return!1}return!0}equals(e,t=s.Tolerance.LENGTH_EPS){return this.min.equals(e.min,t)&&this.max.equals(e.max,t)}translate(e){return this.min.add(e),this.max.add(e),this}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}}},90361:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Box2=void 0;const r=n(83437),s=n(33218),i=n(6688),o=n(56973);class a extends r.Box{constructor(e){super(),this.setFromPoints(e)}makeEmpty(){return this.min?(this.min.x=1/0,this.min.y=1/0):this.min=new s.Vector2(1/0,1/0),this.max?(this.max.x=-1/0,this.max.y=-1/0):this.max=new s.Vector2(-1/0,-1/0),this}getCornerPts(){return[this.min,new s.Vector2(this.max.x,this.min.y),this.max,new s.Vector2(this.min.x,this.max.y)]}expandByPoint(...e){const t=this.min.data,n=this.max.data;for(const r of e){const e=r instanceof s.Vector2?r.data:[r.x,r.y];e[0]<t[0]&&(t[0]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[0]>n[0]&&(n[0]=e[0]),e[1]>n[1]&&(n[1]=e[1])}return this}containsPoint(e,t=o.Tolerance.LENGTH_EPS){if(!this.isValid())return!1;const n=t,{data:r}=new s.Vector2(e),a=this.min.data,c=this.max.data;for(let e=0;e<a.length;e++){if(!new i.Interval(a[e],c[e]).containsPoint(r[e],n))return!1}return!0}getSquareDistanceTo(e){const t=this.min,n=this.max,[r,s]=e instanceof a?[e.min,e.max]:[e,e];let i=0;if(s.x<t.x){const e=t.x-s.x;i+=e*e}else if(r.x>n.x){const e=r.x-n.x;i+=e*e}if(s.y<t.y){const e=t.y-s.y;i+=e*e}else if(r.y>n.y){const e=r.y-n.y;i+=e*e}return i}setFromCenterAndSize(e,t){const n=new s.Vector2(t).multiply(.5);return this.max=new s.Vector2(e).add(n),this.min=new s.Vector2(e).subtract(n),this}clone(){return new a([this.min,this.max])}}t.Box2=a},67996:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Box3=void 0;const r=n(83437),s=n(61226),i=n(6688),o=n(56973);class a extends r.Box{constructor(e){super(),this.setFromPoints(e)}makeEmpty(){return this.min?(this.min.x=1/0,this.min.y=1/0,this.min.z=1/0):this.min=new s.Vector3(1/0,1/0,1/0),this.max?(this.max.x=-1/0,this.max.y=-1/0,this.max.z=-1/0):this.max=new s.Vector3(-1/0,-1/0,-1/0),this}getCornerPts(){if(!this.isValid())return[];const e=this.getSize(),t=this.min.clone(),n=this.min.clone();n.x+=e.x;const r=n.clone();r.y+=e.y;const s=t.clone();s.y+=e.y;const i=t.clone(),o=n.clone(),a=r.clone(),c=s.clone();return[i,o,a,c].forEach((t=>{t.z+=e.z})),[t,n,r,s,i,o,a,c]}expandByPoint(...e){const t=this.min.data,n=this.max.data;for(const r of e){const e=r instanceof s.Vector3?r.data:[r.x,r.y,r.z];e[0]<t[0]&&(t[0]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[2]<t[2]&&(t[2]=e[2]),e[0]>n[0]&&(n[0]=e[0]),e[1]>n[1]&&(n[1]=e[1]),e[2]>n[2]&&(n[2]=e[2])}return this}containsPoint(e,t=o.Tolerance.LENGTH_EPS){if(!this.isValid())return!1;const n=t,{data:r}=new s.Vector3(e),a=this.min.data,c=this.max.data;for(let e=0;e<a.length;e++){if(!new i.Interval(a[e],c[e]).containsPoint(r[e],n))return!1}return!0}getSquareDistanceTo(e){const t=this.min,n=this.max,[r,s]=e instanceof a?[e.min,e.max]:[e,e];let i=0;if(s.x<t.x){const e=t.x-s.x;i+=e*e}else if(r.x>n.x){const e=r.x-n.x;i+=e*e}if(s.y<t.y){const e=t.y-s.y;i+=e*e}else if(r.y>n.y){const e=r.y-n.y;i+=e*e}if(s.z<t.z){const e=t.z-s.z;i+=e*e}else if(r.z>n.z){const e=r.z-n.z;i+=e*e}return i}setFromCenterAndSize(e,t){const n=new s.Vector3(t).multiply(.5);return this.max=new s.Vector3(e).add(n),this.min=new s.Vector3(e).subtract(n),this}clone(){return new a([this.min,this.max])}}t.Box3=a},4375:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Coordinate=void 0;const r=n(28982);class s extends r.GeoElement{constructor(){super()}}t.Coordinate=s},74729:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Coordinate2=void 0;const o=n(33218),a=n(97505),c=n(4375),l=n(60229),d=n(13982),u=n(26581);let h=r=class extends c.Coordinate{constructor(e,t){super(),this._origin=e?new o.Vector2(e):o.Vector2.O(),this._xDir=t?new o.Vector2(t).normalize():o.Vector2.X(),this._updateY()}static XOY(){return new r(new o.Vector2(0,0),o.Vector2.X())}getDx(){return this._xDir.clone()}setDx(e){this._xDir=new o.Vector2(e),this._updateY()}getDy(){return this._yDir.clone()}getOrigin(){return this._origin.clone()}setOrigin(e){this._origin=new o.Vector2(e)}translate(e){return this._origin.add(e),this}translated(e){return this.clone().translate(e)}transform(e){return this._origin.transform(e),this._xDir.vecTransform(e).normalize(),this._updateY(),this}transformed(e){return this.clone().transform(e)}getWorldPtAt(e){return this.getOrigin().add(this.getWorldVectorAt(e))}getLocalPtAt(e){const t=new o.Vector2(this._origin,e),n=t.dot(this._xDir),r=t.dot(this._yDir);return new o.Vector2(n,r)}getWorldVectorAt(e){const{x:t,y:n}=e,r=this.getDx(),s=this.getDy();return r.multiply(t).add(s.multiply(n))}getLocalVectorAt(e){const t=new o.Vector2(e),n=t.dot(this._xDir),r=t.dot(this._yDir);return new o.Vector2(n,r)}getLocalToWorldMatrix(){return new u.Matrix3([[this._xDir.x,this._xDir.y,0],[this._yDir.x,this._yDir.y,0],[this._origin.x,this._origin.y,1]],!1)}getWorldToLocalMatrix(){return this.getLocalToWorldMatrix().inverse()}dump(){return{type:this.getType(),data:[this._origin.toArray2(),this._xDir.toArray2()]}}load({data:[e,t]}){return this._origin.resetFromArray(e),this._xDir.resetFromArray(t),this._updateY(),this}clone(){return super.clone()}getType(){return a.EN_GEO_ELEMENT_TYPE.EN_COORD_2}_updateY(){this._yDir=this._xDir.vecRotated(l.CONST.PI_2)}};h=r=s([d.registerLoader,i("design:paramtypes",[Object,Object])],h),t.Coordinate2=h},89494:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Coordinate3=void 0;const o=n(61226),a=n(61210),c=n(97505),l=n(4375),d=n(13982),u=n(43640);let h=r=class extends l.Coordinate{constructor(e,t,n){if(super(),this._origin=e?new o.Vector3(e):new o.Vector3,n)this.setXYDirs(t,n);else if(t){const e=new o.Vector3(t).normalize(),n=e.getPerpendicular(),r=e.cross(n).normalize();this.setXYDirs(n,r)}else this.setXYDirs(o.Vector3.X(),o.Vector3.Y())}static XOY(e=0){return new r(new o.Vector3(0,0,e),o.Vector3.X(),o.Vector3.Y())}static YOZ(e=0){return new r(new o.Vector3(e,0,0),o.Vector3.Y(),o.Vector3.Z())}static ZOX(e=0){return new r(new o.Vector3(0,e,0),o.Vector3.Z(),o.Vector3.X())}static XOZ(e=0){return new r(new o.Vector3(0,e,0),o.Vector3.X(),o.Vector3.Z())}static getTransformFrom1To2(e,t){const n=e.getLocalToWorldMatrix();if(!n)return;const r=t.getWorldToLocalMatrix();return n.multiply(r)}getDx(){return this._xDir.clone()}setDx(e){this._xDir=new o.Vector3(e),this._update()}getDy(){return this._yDir.clone()}setDy(e){this._yDir=new o.Vector3(e),this._update()}getDz(){return this._zDir.clone()}getOrigin(){return this._origin.clone()}setOrigin(e){this._origin=new o.Vector3(e)}setXYDirs(e,t){return this._xDir=new o.Vector3(e).normalize(),this._yDir=new o.Vector3(t).normalize(),this._update(),this}reverseZDir(){return this._zDir.reverse(),this._yDir=this._zDir.cross(this._xDir),this}translate(e){return this._origin.add(e),this}translated(e){return this.clone().translate(e)}transform(e){this._origin.transform(e),this._xDir.vecTransform(e).normalize();const t=this._yDir.vecTransform(e);return this._yDir=this._xDir.cross(t).cross(this._xDir).normalize(),this._update(),this}transformed(e){return this.clone().transform(e)}getWorldPtAt(e){return this.getOrigin().add(this.getWorldVectorAt(e))}getLocalPtAt(e){const t=new o.Vector3(e).subtract(this._origin),n=t.dot(this._xDir),r=t.dot(this._yDir),s=t.dot(this._zDir);return new o.Vector3(n,r,s)}getWorldVectorAt(e){const{x:t,y:n}=e,r=this.getDx(),s=this.getDy(),i=r.multiply(t).add(s.multiply(n)),o=e.z;return o?i.add(this.getDz().multiply(o)):i}getLocalVectorAt(e){const t=new o.Vector3(e),n=t.dot(this._xDir),r=t.dot(this._yDir),s=t.dot(this._zDir);return new o.Vector3(n,r,s)}getLocalToWorldMatrix(){return new a.Matrix4([[this._xDir.x,this._xDir.y,this._xDir.z,0],[this._yDir.x,this._yDir.y,this._yDir.z,0],[this._zDir.x,this._zDir.y,this._zDir.z,0],[this._origin.x,this._origin.y,this._origin.z,1]],!1)}getWorldToLocalMatrix(){return this.getLocalToWorldMatrix().inverse()}clone(){return super.clone()}dump(){return{type:this.getType(),data:[this._origin.toArray3(),this._xDir.toArray3(),this._yDir.toArray3()]}}load({data:[e,t,n]}){return this._origin.resetFromArray(e),this._xDir.resetFromArray(t),this._yDir.resetFromArray(n),this._update(),this}getType(){return c.EN_GEO_ELEMENT_TYPE.EN_COORD_3}tessellate(e,t=u.DiscreteParameter.NORMAL){return{debugInfo:e?{name:"Coordinate3",visible:!0}:void 0,children:[{debugInfo:e?{name:"X",visible:!0}:void 0,edges:[[this._origin.toArray3(),this._origin.clone().add(this._xDir.clone().multiply(50)).toArray3()]]},{debugInfo:e?{name:"Y",visible:!0}:void 0,edges:[[this._origin.toArray3(),this._origin.clone().add(this._yDir.clone().multiply(50)).toArray3()]]},{debugInfo:e?{name:"Z",visible:!0}:void 0,edges:[[this._origin.toArray3(),this._origin.clone().add(this._zDir.clone().multiply(50)).toArray3()]]}]}}_update(){this._zDir=this._xDir.cross(this._yDir)}};h=r=s([d.registerLoader,i("design:paramtypes",[Object,Object,Object])],h),t.Coordinate3=h},43640:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DiscreteParameter=void 0;const r=n(60229),s=n(56973);class i{constructor(e,t,n,r,s,i){this.tolerance=e,this.crossEps=t,this.hintSegmentCount=n,this.maxSegmentCount=r,this.maxFaceletCount=s,this.enableSurfaceRefiner=i}clone({tolerance:e=this.tolerance,crossEps:t=this.crossEps,hintSegmentCount:n=this.hintSegmentCount,maxSegmentCount:r=this.maxSegmentCount,maxFaceletCount:s=this.maxFaceletCount,enableSurfaceRefiner:o=this.enableSurfaceRefiner}){return new i(e,t,n,r,s,o)}ratioed(e=.5,t=this.enableSurfaceRefiner){const n=this.tolerance,r=Math.max(n.angleEps*e,i._MIN_TOLER_ANGLE_EPS),o=Math.max(this.hintSegmentCount/e,i._MIN_HINT_SEGMENT_COUNT);return new i(new s.Tolerance(n.lengthEps*e,r),this.crossEps*e,o,this.maxSegmentCount/e,this.maxFaceletCount/e,t)}}t.DiscreteParameter=i,i.LOW=new i(new s.Tolerance(36,r.CONST.PI/6),1200,4,150,3e3,!1),i.NORMAL=new i(new s.Tolerance(12,r.CONST.PI/12),400,4,400,1e4,!1),i.HIGH=new i(new s.Tolerance(4,r.CONST.PI/36),120,10,1200,3e4,!0),i.BorderScale=.1,i.UvDisEps=.1,i.CALCULATE=new i(new s.Tolerance(1,r.CONST.PI/108),30,40,5e3,1e5,!0),i._MIN_HINT_SEGMENT_COUNT=4,i._MIN_TOLER_ANGLE_EPS=r.CONST.PI/6},91743:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Euler=t.EulerOrder=void 0;const r=n(61226),s=n(49246);var i;!function(e){e[e.XYZ=0]="XYZ",e[e.YZX=1]="YZX",e[e.ZXY=2]="ZXY",e[e.XZY=3]="XZY",e[e.YXZ=4]="YXZ",e[e.ZYX=5]="ZYX"}(i=t.EulerOrder||(t.EulerOrder={}));class o{constructor(e=0,t=0,n=0,r=i.XYZ){this._x=e,this._y=t,this._z=n,this._order=r,this.isEuler=!0}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}get z(){return this._z}set z(e){this._z=e}get order(){return this._order}set order(e){this._order=e}set(e,t,n,r){this._x=e,this._y=t,this._z=n,this._order=r}clone(){return new o(this._x,this._y,this._z,this._order)}copyFrom(e){this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order}setFromRotationMatrix(e,t){const n=s.Util.clamp,r=e.data,o=r[0][0],a=r[1][0],c=r[2][0],l=r[0][1],d=r[1][1],u=r[2][1],h=r[0][2],g=r[1][2],f=r[2][2];t===i.ZYX?(this._y=Math.asin(n(c,-1,1)),Math.abs(c)<.99999?(this._x=Math.atan2(-u,f),this._z=Math.atan2(-a,o)):(this._x=Math.atan2(g,d),this._z=0)):t===i.ZXY?(this._x=Math.asin(-n(u,-1,1)),Math.abs(u)<.99999?(this._y=Math.atan2(c,f),this._z=Math.atan2(l,d)):(this._y=Math.atan2(-h,o),this._z=0)):t===i.YXZ?(this._x=Math.asin(n(g,-1,1)),Math.abs(g)<.99999?(this._y=Math.atan2(-h,f),this._z=Math.atan2(-a,d)):(this._y=0,this._z=Math.atan2(l,o))):t===i.XYZ?(this._y=Math.asin(-n(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(g,f),this._z=Math.atan2(l,o)):(this._x=0,this._z=Math.atan2(-a,d))):t===i.XZY?(this._z=Math.asin(n(l,-1,1)),Math.abs(l)<.99999?(this._x=Math.atan2(-u,d),this._y=Math.atan2(-h,o)):(this._x=0,this._y=Math.atan2(c,f))):t===i.YZX&&(this._z=Math.asin(-n(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(g,d),this._y=Math.atan2(c,o)):(this._x=Math.atan2(-u,f),this._y=0)),this._order=t}setFromVector3(e,t){return this.set(e.x,e.y,e.z,void 0!==t?t:this._order)}isEqual(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this}toArray(){const e=new Array(4);return e[0]=this._x,e[1]=this._y,e[2]=this._z,e[3]=this._order,e}toVector(){return new r.Vector3(this._x,this._y,this._z)}}t.Euler=o},28982:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GeoElement=void 0;const r=n(97505),s=n(43640);t.GeoElement=class{tessellate(e,t=s.DiscreteParameter.NORMAL){return{debugInfo:e?{name:this.constructor.name,visible:!0}:void 0}}clone(){const e=new this.constructor;return e.load(this.dump()),e}toString(){return JSON.stringify(this.dump())}isVector2(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_VECTOR_2D}isVector3(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_VECTOR_3D}isLine2d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_LINE_2D}isArc2d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_ARC_2D}isNurbsCurve2d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_NURBS_CURVE_2D}isExtendCurve2d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_EXTEND_CURVE_2D}isOffsetCurve2d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_OFFSET_CURVE_2D}isSmoothPoly2d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_SMOOTHPOLY_2D}isLoop(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_LOOP}isLine3d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_LINE_3D}isArc3d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_ARC_3D}isCircle3d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_CIRCLE_3D}isExtendCurve3d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_EXTEND_CURVE_3D}isOffsetCurve3d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_OFFSET_CURVE_3D}isNurbsCurve3d(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_NURBS_CURVE_3D}isLine(){return this.isLine2d()||this.isLine3d()}isArc(){return this.isArc2d()||this.isArc3d()}isNurbsCurve(){return this.isNurbsCurve2d()||this.isNurbsCurve3d()}isExtendCurve(){return this.isExtendCurve2d()||this.isExtendCurve3d()}isOffsetCurve(){return this.isOffsetCurve2d()||this.isOffsetCurve3d()}isPlane(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_PLANE}isCylinder(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_CYLINDER}isCone(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_CONE}isSphere(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_SPHERE}isNurbsSurface(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_NURBS_SURFACE}isSweepSurface(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_SWEEP_SURFACE}isOffsetSurface(){return this.getType()===r.EN_GEO_ELEMENT_TYPE.EN_OFFSET_SURFACE}}},6688:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Interval=void 0;const r=n(44757),s=n(49246),i=n(60229),o=n(56973);class a{constructor(e,t,n=!1){void 0!==e&&void 0!==t&&(e<t?(this._min=e,this._max=t):n?(this._min=t,this._max=e):(r.MathAssert.assert(s.Util.isNearlyEqual(e,t),`invalid interval[ ${e}, ${t}]`),this._min=e,this._max=e))}static infinit(){return new a(-i.CONST.MODEL_MAX_LENGTH,i.CONST.MODEL_MAX_LENGTH)}static infinitArray(){return[-i.CONST.MODEL_MAX_LENGTH,i.CONST.MODEL_MAX_LENGTH]}static merge(e){if(e.length<1)return[];e.length>1&&e.sort(((e,t)=>e._min-t._min));const t=[e[0]];let n=t[0];for(let r=1;r<e.length;r++)e[r]._min<n._max+o.Tolerance.DEFAULT.numberEps?n._max=Math.max(e[r]._max,n._max):(n=e[r],t.push(n));return t}get min(){return this._min}set min(e){r.MathAssert.assert(e<this._max||s.Util.isNearlyEqual(e,this._max),`min > this._max ${e} ${this._max}`),this._min=e<this.max?e:this.max}get max(){return this._max}set max(e){r.MathAssert.assert(this._min<e||s.Util.isNearlyEqual(e,this._min),`max < this._min ${e} ${this._min}`),this._max=e>this.min?e:this.min}set(e,t){return r.MathAssert.assert(e<t||s.Util.isNearlyEqual(e,t),`min > max ${e} ${t}`),this._min=e,this._max=t>e?t:e,this}setInfinit(e){return this.min=void 0!==e?e:-i.CONST.MODEL_MAX_LENGTH,this.max=i.CONST.MODEL_MAX_LENGTH,this}toArray(){return[this._min,this._max]}containsPoint(e,t=o.Tolerance.NUMBER_EPS){const n=t;return e+n>=this._min&&e-n<=this._max}clamp(e){return e<this._min?this._min:e>this._max?this._max:e}containsPointAtStartOrEnd(e,t=o.Tolerance.NUMBER_EPS){return Math.abs(this._min-e)<t||Math.abs(this._max-e)<t}containsInterval(e,t=o.Tolerance.NUMBER_EPS){const n=t;return this.containsPoint(e._min,n)&&this.containsPoint(e._max,n)}filterParams(e){const t=this._min,n=this._max;return e.filter((e=>t<=e&&e<=n))}equals(e,t=o.Tolerance.NUMBER_EPS){return this.containsInterval(e,t)&&e.containsInterval(this,t)}getLength(){return this._max-this._min}getMid(){return(this._max+this._min)/2}distanceTo(e){if("number"==typeof e)return e>=this._min&&e<=this._max?-Math.min(e-this._min,this._max-e):e>=this._max?e-this._max:e<=this._min?this._min-e:i.CONST.MODEL_MAX_LENGTH;const t=this.intersected(e);return t.length>0?-t[0].getLength():Math.min(this.distanceTo(e._min),this.distanceTo(e._max))}intersected(e,t=o.Tolerance.NUMBER_EPS){const n=Math.max(this._min,e._min),r=Math.min(this._max,e._max);if(n>r+t)return[];if(n>r){const e=(n+r)/2;return[new a(e,e)]}return[new a(n,r)]}subtracted(...e){const t=e.filter((e=>e.min<this.max-o.Tolerance.DEFAULT.numberEps)).sort(((e,t)=>e.min-t.min));let n=this.min;const r=[],s=e=>{n<e-o.Tolerance.DEFAULT.numberEps&&r.push(new a(n,e))};for(const e of t)s(e.min),e.max>n&&(n=e.max);return s(this.max),r}expandByPt(e){return e<this._min&&(this._min=e),e>this._max&&(this._max=e),this}multiply(e){return this._min*=e,this._max*=e,this}splited(...e){const t=[this._min,this._max];for(const n of e)"number"==typeof n?t.push(n):t.push(n._min,n._max);t.sort(((e,t)=>e-t));const n=t.findIndex((e=>s.Util.isNearlyEqual(e,this._min))),i=t.findIndex((e=>s.Util.isNearlyEqual(e,this._max)));r.MathAssert.assert(n>-1&&i>-1,"logic error");const c=t.slice(n,i+1),l=[];for(let e=0;e<c.length-1;e++)c[e+1]-c[e]>o.Tolerance.NUMBER_EPS&&l.push(new a(c[e],c[e+1],!0));return l}clone(){return new a(this._min,this._max)}_sub(e){const t=this.intersected(e);if(0===t.length)return[this];const n=[],r=this._min,s=t[0]._min;s>r&&n.push(new a(r,s));const i=t[0]._max,o=this._max;return o>i&&n.push(new a(i,o)),n}_add(e){if(0===this.intersected(e).length)throw new Error("no intersection cant add");return this._min=Math.min(this._min,e._min),this._max=Math.max(this._max,e._max),this}}t.Interval=a},76454:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IVector=void 0;const r=n(28982),s=n(56973),i=n(43640);class o extends r.GeoElement{constructor(){super()}get data(){return this._data}isSameDirection(e,t=s.Tolerance.ANGLE_EPS){return this.isParallel(e,t)&&this.dot(e)>0}isOpposite(e,t=s.Tolerance.ANGLE_EPS){return this.isParallel(e,t)&&this.dot(e)<0}isZero(e=s.Tolerance.LENGTH_EPS){return this.getSqLength()<=e*e}toArray2(){return[this._data[0],this._data[1]]}toArray3(){return[this._data[0],this._data[1],this._data[2]||0]}toXY(){return{x:this._data[0],y:this._data[1]}}toXYZ(){return{x:this._data[0],y:this._data[1],z:this._data[2]||0}}getLength(){return Math.sqrt(this.getSqLength())}getSqLength(){let e=0;for(const t of this._data)e+=t*t;return e}tessellate(e,t=i.DiscreteParameter.NORMAL){let n;return e&&(n={name:void 0===this.z?"Vector2":"Vector3",visible:!0}),{debugInfo:n,points:[[this._data[0],this._data[1],this._data[2]||0]]}}dump(){return{type:this.getType(),data:this._data}}load({data:e}){return this._resetData(e),this}_resetData(e){return this._data.splice(0),e&&this._data.push(...e),this}}t.IVector=o},36050:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Matrix=void 0;const r=n(72564),s=n(44757),i=n(49246),o=n(28982),a=n(56973);class c extends o.GeoElement{constructor(e,t,n=!0){if(super(),this._dim=e,t)if(n){this._data=new Array(e);for(let n=0;n<e;n++)this._data[n]=t[n].slice(0)}else this._data=t;else{this._data=new Array(e);for(let t=0;t<e;t++){const n=new Array(e).fill(0);n[t]=1,this._data[t]=n}}}determinant(){return r.det(this._data)}inverse(){try{const e=r.inv(this._data);return this.copy(e)}catch(e){return}}get dim(){return this._dim}get data(){return this._data}set(e,t,n){s.MathAssert.assert(e<this._dim&&t<this._dim,"error! out of range"),this._data[t][e]=n}resetIdentity(){for(let e=0;e<this._dim;e++){const t=this._data[e];t.fill(0),t[e]=1}return this}isIdentity(){for(let e=0;e<this._dim;e++)for(let t=0;t<this._dim;t++)if(e===t){if(!i.Util.isNearlyEqual(this.data[e][t],1,a.Tolerance.NUMBER_EPS))return!1}else if(!i.Util.isNearlyZero(this.data[e][t],a.Tolerance.NUMBER_EPS))return!1;return!0}multiply(e){const t=e.data||e,n=r.dot(t,this._data);return this.copy(n),this}preMultiply(e){const t=e.data||e,n=r.dot(this._data,t);return this.copy(n),this}multiplyScalar(e){for(const t of this._data)for(let n=0;n<this._dim;n++)t[n]*=e;return this}transpose(){const e=r.transpose(this._data);return this.copy(e)}copy(e){const t=e.data||e;for(let e=0;e<this._dim;e++)this._data[e].splice(0,this._dim,...t[e]);return this}dump(){return{type:this.getType(),data:this._data}}load({data:e}){return this.copy(e)}}t.Matrix=c},26581:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Matrix3=void 0;const o=n(72564),a=n(36050),c=n(33218),l=n(97505),d=n(13982),u=n(56973),h=n(44757);let g=r=class extends a.Matrix{static make(e,t=!0){return e instanceof r?t?e.clone():e:new r(e.data||e,t)}static makeTranslate({x:e,y:t}){return new r([[1,0,0],[0,1,0],[e,t,1]],!1)}static makeRotate(e,t){const n=Math.cos(t),s=Math.sin(t),i=(1-n)*e.x+s*e.y,o=(1-n)*e.y-s*e.x;return new r([[n,s,0],[-s,n,0],[i,o,1]],!1)}static makeScale(e,t){const n="number"==typeof t?{x:t,y:t}:t,s=(1-n.x)*e.x,i=(1-n.y)*e.y;return new r([[n.x,0,0],[0,n.y,0],[s,i,1]],!1)}static makeMirror(e,t){const{x:n,y:s}=new c.Vector2(-t.y,t.x).normalize(),i=2*n*n,o=2*n*s,a=2*s*s,l=2*(n*e.x+s*e.y);return new r([[1-i,-o,0],[-o,1-a,0],[l*n,l*s,1]],!1)}static isSvdMirror(e){return e.scale.x<0}static assertScaleEqual(e){const t=Math.abs(e.x)>u.Tolerance.NUMBER_EPS&&Math.abs(Math.abs(e.y/e.x)-1)<u.Tolerance.NUMBER_EPS;return h.MathAssert.warn(t,"暂不支持非等比缩放"),t}constructor(e,t=!0){super(3,e,t)}get data(){return this._data}toArray(e,t){const n=e||[],r=t||0,[s,i,o]=this._data;return n.splice(r,9,s[0],s[1],s[2],i[0],i[1],i[2],o[0],o[1],o[2]),n}fromArray(e,t){const n=t||0,[r,s,i]=this._data;return r[0]=e[n],r[1]=e[n+1],r[2]=e[n+2],s[0]=e[n+3],s[1]=e[n+4],s[2]=e[n+5],i[0]=e[n+6],i[1]=e[n+7],i[2]=e[n+8],this}getBasicVec(e){return new c.Vector2(this._data[e])}isMirror(){const e=new c.Vector2(this._data[0]),t=new c.Vector2(this._data[1]);return e.cross(t)<0}applyTranslate({x:e,y:t}){const n=this._data[2];return n[0]+=e,n[1]+=t,this}applyRotate(e,t){const n=r.makeRotate(e,t);return this.preMultiply(n)}applyMirror(e,t){const n=r.makeMirror(e,t);return this.preMultiply(n)}applyScale(e,t){const n=r.makeScale(e,t);return this.preMultiply(n)}decomposeTRS(){const e=this.getBasicVec(0),t=this.getBasicVec(1);if(!e.isPerpendicular(t))return[];const[n,s,i]=this._data,o=r.makeTranslate({x:i[0],y:i[1]}),a=this.determinant()>0?1:-1,c=e.getLength()*a,l=t.getLength(),d=new r([[c,0,0],[0,l,0],[0,0,1]],!1);return[o,new r([[n[0]/c,n[1]/c,0],[s[0]/l,s[1]/l,0],[0,0,1]],!1),d]}decompose(){const e=[this.data[0].slice(0,2),this.data[1].slice(0,2)],t=o.svd(e);o.det(t.U)<0&&(t.U[0][0]*=-1,t.U[1][0]*=-1,t.S[0]*=-1),o.det(t.V)<0&&(t.V[0][0]*=-1,t.V[1][0]*=-1,t.S[0]*=-1);const n=[[t.V[0][0],t.V[1][0],0],[t.V[0][1],t.V[1][1],0],[this.data[2][0],this.data[2][1],1]],s=[[...t.U[0],0],[...t.U[1],0],[0,0,1]];return{uTransform:new r(n,!1),scale:new c.Vector2(t.S),vRotate:new r(s,!1)}}multiplied(e){return this.clone().multiply(e)}preMultiplied(e){return this.clone().preMultiply(e)}multipliedScalar(e){return this.clone().multiplyScalar(e)}multipliedVector3(e){return o.dot(e,this.data)}inversed(){return this.clone().inverse()}transposed(){return this.clone().transpose()}getType(){return l.EN_GEO_ELEMENT_TYPE.EN_MATRIX_3}clone(){return super.clone()}dump(){return super.dump()}};g=r=s([d.registerLoader,i("design:paramtypes",[Array,Object])],g),t.Matrix3=g},61210:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Matrix4=void 0;const o=n(72564),a=n(36050),c=n(61226),l=n(97505),d=n(13982),u=n(56973),h=n(44757);let g=r=class extends a.Matrix{static make(e,t=!0){return e instanceof r?t?e.clone():e:new r(e.data||e,t)}static makeTranslate({x:e,y:t,z:n}){return new r([[1,0,0,0],[0,1,0,0],[0,0,1,0],[e,t,n,1]],!1)}static makeRotate(e,t,n){const s=t.x,i=t.y,o=t.z,a=Math.cos(n);let l=Math.sin(n);const d=u.Tolerance.LENGTH_EPS,h=Math.abs(s)<d,g=Math.abs(i)<d,f=Math.abs(o)<d;if(g&&f){s<0&&(l*=-1);const t=e.y*(1-a)+e.z*l,n=e.z*(1-a)-e.y*l;return new r([[1,0,0,0],[0,a,l,0],[0,-l,a,0],[0,t,n,1]],!1)}if(h&&f){i<0&&(l*=-1);const t=e.z*(1-a)+e.x*l,n=e.x*(1-a)-e.z*l;return new r([[a,0,-l,0],[0,1,0,0],[l,0,a,0],[n,0,t,1]],!1)}if(h&&g){o<0&&(l*=-1);const t=e.x*(1-a)+e.y*l,n=e.y*(1-a)-e.x*l;return new r([[a,l,0,0],[-l,a,0,0],[0,0,1,0],[t,n,0,1]],!1)}const p=t instanceof c.Vector3?t.normalized():new c.Vector3(t).normalize(),_=p.getPerpendicular(),m=p.cross(_),v=_.data,E=m.data,P=p.data,y=r.makeTranslate({x:-e.x,y:-e.y,z:-e.z});y.preMultiply([[v[0],E[0],P[0],0],[v[1],E[1],P[1],0],[v[2],E[2],P[2],0],[0,0,0,1]]);const C=_.multiplied(a).add(m.multiplied(l)),S=_.multiplied(-l).add(m.multiplied(a)),T=C.data,b=S.data;return y.preMultiply([[...T,0],[...b,0],[...P,0],[e.x,e.y,e.z,1]]),y}static makeRotateX(e){const t=Math.cos(e),n=Math.sin(e);return new r([[1,0,0,0],[0,t,n,0],[0,-n,t,0],[0,0,0,1]],!1)}static makeRotateY(e){const t=Math.cos(e),n=Math.sin(e);return new r([[t,0,-n,0],[0,1,0,0],[n,0,t,0],[0,0,0,1]],!1)}static makeRotateZ(e){const t=Math.cos(e),n=Math.sin(e);return new r([[t,n,0,0],[-n,t,0,0],[0,0,1,0],[0,0,0,1]],!1)}static makeRotateFromQuaternion(e){const t=new r,n=t.data,s=e.x,i=e.y,o=e.z,a=e.w,c=s+s,l=i+i,d=o+o,u=s*c,h=s*l,g=s*d,f=i*l,p=i*d,_=o*d,m=a*c,v=a*l,E=a*d;return n[0][0]=1-(f+_),n[1][0]=h-E,n[2][0]=g+v,n[0][1]=h+E,n[1][1]=1-(u+_),n[2][1]=p-m,n[0][2]=g-v,n[1][2]=p+m,n[2][2]=1-(u+f),n[0][3]=0,n[1][3]=0,n[2][3]=0,n[3][0]=0,n[3][1]=0,n[3][2]=0,n[3][3]=1,t}static makeScale(e,t){const{x:n,y:s,z:i}="number"==typeof t?{x:t,y:t,z:t}:t;return new r([[n,0,0,0],[0,s,0,0],[0,0,i,0],[e.x*(1-n),e.y*(1-s),e.z*(1-i),1]],!1)}static makeMirror(e,t){const{x:n,y:s,z:i}=new c.Vector3(t).normalize(),o=2*n*n,a=2*n*s,l=2*i*n,d=2*s*s,u=2*s*i,h=2*i*i,g=2*(n*e.x+s*e.y+i*e.z);return new r([[1-o,-a,-l,0],[-a,1-d,-u,0],[-l,-u,1-h,0],[g*n,g*s,g*i,1]],!1)}static makeByMatrix3(e){const[t,n,s]=e.data||e;return new r([[t[0],t[1],0,t[2]],[n[0],n[1],0,n[2]],[0,0,1,0],[s[0],s[1],0,s[2]]],!1)}static isSvdMirror(e){return e.scale.x<0}static isScaleEqual(e){return Math.abs(e.x)>u.Tolerance.NUMBER_EPS&&Math.abs(Math.abs(e.y/e.x)-1)<u.Tolerance.NUMBER_EPS&&Math.abs(Math.abs(e.z/e.x)-1)<u.Tolerance.NUMBER_EPS}static isOnlyTranslateAndRotate(e){return Math.abs(e.x-1)<u.Tolerance.NUMBER_EPS&&Math.abs(e.y-1)<u.Tolerance.NUMBER_EPS&&Math.abs(e.z-1)<u.Tolerance.NUMBER_EPS}static assertScaleEqual(e){const t=Math.abs(e.x)>u.Tolerance.NUMBER_EPS&&Math.abs(Math.abs(e.y/e.x)-1)<u.Tolerance.NUMBER_EPS&&Math.abs(Math.abs(e.z/e.x)-1)<u.Tolerance.NUMBER_EPS;return h.MathAssert.warn(t,"暂不支持非等比缩放"),t}constructor(e,t=!0){super(4,e,t)}get data(){return this._data}toArray(e,t){const n=e||[],r=t||0,[s,i,o,a]=this._data;return n.splice(r,16,s[0],s[1],s[2],s[3],i[0],i[1],i[2],i[3],o[0],o[1],o[2],o[3],a[0],a[1],a[2],a[3]),n}fromArray(e,t){const n=t||0,[r,s,i,o]=this._data;return r[0]=e[n],r[1]=e[n+1],r[2]=e[n+2],r[3]=e[n+3],s[0]=e[n+4],s[1]=e[n+5],s[2]=e[n+6],s[3]=e[n+7],i[0]=e[n+8],i[1]=e[n+9],i[2]=e[n+10],i[3]=e[n+11],o[0]=e[n+12],o[1]=e[n+13],o[2]=e[n+14],o[3]=e[n+15],this}getBasicVec(e){return new c.Vector3(this._data[e])}applyRotate(e,t,n){const s=r.makeRotate(e,t,n);return this.preMultiply(s)}applyTranslate({x:e,y:t,z:n}){const r=this._data[3];return r[0]+=e,r[1]+=t,r[2]+=n,this}applyScale(e,t){const n=r.makeScale(e,t);return this.preMultiply(n)}applyMirror(e,t){const n=r.makeMirror(e,t);return this.preMultiply(n)}getTranslation(){return new c.Vector3(this.data[3])}setTranslation(e){return this.data[3][0]=e.x,this.data[3][1]=e.y,this.data[3][2]=e.z,this}getScale(){const e=this._data[3][3],t=t=>Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])/e;return new c.Vector3(t(this._data[0]),t(this._data[1]),t(this._data[2]))}decomposeTRS(){const e=this.getBasicVec(0),t=this.getBasicVec(1),n=this.getBasicVec(2);if(!e.isPerpendicular(t)||!e.isPerpendicular(n)||!t.isPerpendicular(n))return[];const[s,i,o,a]=this._data,c=r.makeTranslate({x:a[0],y:a[1],z:a[2]}),l=this.determinant()>0?1:-1,d=e.getLength()*l,u=t.getLength(),h=n.getLength(),g=new r([[d,0,0,0],[0,u,0,0],[0,0,h,0],[0,0,0,1]],!1);return[c,new r([[s[0]/d,s[1]/d,s[2]/d,0],[i[0]/u,i[1]/u,i[2]/u,0],[o[0]/h,o[1]/h,o[2]/h,0],[0,0,0,1]],!1),g]}decompose(){const e=[this.data[0].slice(0,3),this.data[1].slice(0,3),this.data[2].slice(0,3)],t=o.svd(e);o.det(t.U)<0&&(t.U[0][0]*=-1,t.U[1][0]*=-1,t.U[2][0]*=-1,t.S[0]*=-1),o.det(t.V)<0&&(t.V[0][0]*=-1,t.V[1][0]*=-1,t.V[2][0]*=-1,t.S[0]*=-1);const[n,s,i]=t.V,a=[[n[0],s[0],i[0],0],[n[1],s[1],i[1],0],[n[2],s[2],i[2],0],this._data[3].slice(0)],l=[[...t.U[0],0],[...t.U[1],0],[...t.U[2],0],[0,0,0,1]];return{uTransform:new r(a,!1),scale:new c.Vector3(t.S),vRotate:new r(l,!1)}}isMirror(){return this.determinant()<0}multiplied(e){return this.clone().multiply(e)}preMultiplied(e){return this.clone().preMultiply(e)}multipliedScalar(e){return this.clone().multiplyScalar(e)}multipliedVector4(e){return o.dot(e,this.data)}inversed(){return this.clone().inverse()}transposed(){return this.clone().transpose()}getType(){return l.EN_GEO_ELEMENT_TYPE.EN_MATRIX_4}dump(){return super.dump()}clone(){return super.clone()}};g=r=s([d.registerLoader,i("design:paramtypes",[Array,Object])],g),t.Matrix4=g},79890:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isMirror=t.convertToMatrix4=t.convertToMatrix3=t.isExpectedSqureMatrix=void 0;const r=n(72564);t.isExpectedSqureMatrix=function(e,t){const[n,s]=r.dim(e);return n===s&&t===n},t.convertToMatrix3=function(e){const t=e.data||e;return 3===t.length?t:[[t[0][0],t[0][1],t[0][3]],[t[1][0],t[1][1],t[1][3]],[t[3][0],t[3][1],t[3][3]]]},t.convertToMatrix4=function(e){const t=e.data||e;return 4===t.length?t:[[t[0][0],t[0][1],0,t[0][2]],[t[1][0],t[1][1],0,t[1][2]],[0,0,1,0],[t[2][0],t[2][1],0,t[2][2]]]},t.isMirror=function(e){const t=e.data||e;return r.det(t)<0}},26773:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PeriodInterval=void 0;const r=n(44757),s=n(49246),i=n(60229),o=n(56973),a=n(6688);class c extends a.Interval{constructor(e,t,n=i.CONST.PI2){super(),this._min=e,this._max=t,this._period=n,this.regularize()}static isPeriod(e){return void 0!==e._period}static areEqual(e,t,n=i.CONST.PI2,r=o.Tolerance.NUMBER_EPS){const s=c.RegularizeParam(t-e,n);return s<r||s>n-r}static RegularizeParam(e,t=i.CONST.PI2,n=0){let r=(e-n)%t;return r<-o.Tolerance.CALCULATE_EPS?r+=t:t-r<o.Tolerance.CALCULATE_EPS&&(r-=t),r+n}static merge(e){if(e.length<1)return[];const t=e[0]._period;for(let n=1;n<e.length;n++)r.MathAssert.assert(e[n]._period===t,"PeriodInterval.Merge()：待合并区间周期不同！");const n=[];e.forEach((e=>{e.max>t?(n.push(new a.Interval(0,e.max-t)),n.push(new a.Interval(e.min,t))):n.push(new a.Interval(e.min,e.max))}));const s=a.Interval.merge(n);return s.length>1&&s[0].min<o.Tolerance.NUMBER_EPS&&s[s.length-1].max>t-o.Tolerance.NUMBER_EPS&&(s[s.length-1].max=s[0].max+t,s.shift()),s.map((e=>new c(e.min,e.max,t)))}static make(e,t,n){return n>0?new c(e,t,n):new a.Interval(e,t)}get min(){return this._min}set min(e){this._min=e,this.regularize()}get max(){return this._max}set max(e){this._max=e,this.regularize()}get period(){return this._period}set period(e){this._period=e,this.regularize()}set(e,t){return this._min=e,this._max=t,this.regularize(),this}setInfinit(e){if(void 0===e){const e=(this._min+this._max)/2,t=this._period/2;e<t?(this._min=e+t,this._max=e+3*t):(this._min=e-t,this._max=e+t)}else this._min=e,this._max=e+i.CONST.PI2;return this}toArray(){return[this._min,this._max]}toArrayWithPeriod(){return[this._min,this._max,this._period]}clamp(e){const t=c.RegularizeParam(e-this._min,this._period),n=this._max-this._min;if(t<=n)return t+this._min;const r=t-n,s=this._period-t;return r<s?e-r:e+s}containsPoint(e,t=o.Tolerance.NUMBER_EPS){const n=c.RegularizeParam(e-this._min,this._period);return n<this._max-this._min+t||n>this._period-t}containsPointAtStartOrEnd(e,t=o.Tolerance.NUMBER_EPS){const n=c.RegularizeParam(e-this._min,this._period);return Math.abs(n)<t||Math.abs(n-this._period)<t||Math.abs(this._max-this._min-n)<t}containsInterval(e,t=o.Tolerance.NUMBER_EPS){return!!this.isClosed(t)||e._period===this._period&&(this._min<e.min+t&&this._max>e.max-t||this._min-this._period<e.min+t&&this._max-this._period>e.max-t)}filterParams(e){const t=[];for(const n of e){const e=this.getRegularParam(n);e<=this._max&&t.push(e)}return t.sort()}equals(e,t=o.Tolerance.NUMBER_EPS){if(this._period!==e._period)return!1;const n=this.isClosed(),r=e.isClosed();return n||r?n&&r:s.Util.isNearlyEqual(this._min,e.min)&&s.Util.isNearlyEqual(this._max,e.max)}isClosed(e=o.Tolerance.NUMBER_EPS){return s.Util.isNearlyEqual(this._max-this._min,this._period,e)}distanceTo(e){if("number"==typeof e){const t=e,n=this.getRegularParam(t);if(n<this._max)return Math.max(n-this._max,this._min-n);const r=n-i.CONST.PI2;return Math.min(n-this._max,this._min-r)}const t=this.intersected(e);return t.length>0?-t[0].getLength():Math.min(c.RegularizeParam(e.min-this._max,this._period),c.RegularizeParam(this._min-e.max,this._period))}intersected(e,t=o.Tolerance.NUMBER_EPS){if(this._period!==e._period)return[];if(this.isClosed())return[e.clone()];const n=super.intersected(e,t).map((e=>new c(e.min,e.max,this._period)));if(this._max>this._period-t){const r=e.min+this._period;if(this._max>r){const e=Math.max(r,this.min);n.push(new c(e,this._max,this._period))}else if(this._max>r-t){const e=(this._max+r)/2;n.push(new c(e,e))}}if(e.max>this._period-t){const r=e.max-this._period;if(this._min<r){const e=Math.min(this.max,r);n.push(new c(this._min,e,this._period))}else if(this._min<r+t){const e=(this._min+r)/2;n.push(new c(e,e))}}return n}subtracted(...e){e.forEach((e=>{r.MathAssert.assert(e._period===this._period,"PeriodInterval.subtracted: Period not equal")}));const t=e.filter((e=>e.max>this._period)).map((e=>new a.Interval(e.min-this._period,e.max-this._period))),n=this._max>this._period?e.map((e=>new a.Interval(e.min+this._period,e.max+this._period))):[],s=e.concat(t).concat(n);return super.subtracted(...s).map((e=>new c(e.min,e.max,this._period)))}expandByPt(e){const t=this.getRegularParam(e);if(t<=this._max)return this;const n=t-this._period;return t-this._max<this._min-n?this._max=t:(this._min=n,n<0&&(this._min+=this._period,this._max+=this._period)),this}multiply(e){return r.MathAssert.assert(1===e,"PeriodInterval.multiply: Not support multiply"),this}regularize(){const e=c.RegularizeParam(this._min,this._period);let t=c.RegularizeParam(this._max-this._min,this._period);return s.Util.isNearlyZero(t)&&!s.Util.isNearlyEqual(this._min,this._max)&&(t=this._period),this._min=e,this._max=e+t,this}getRegularParam(e,t=o.Tolerance.CALCULATE_EPS){const n=c.RegularizeParam(e-this._min,this._period);return this._period-n<t?this._min:n+this._min}splited(...e){const t=[this._min,this._max];for(const n of e)if("number"==typeof n){const e=this.getRegularParam(n);e<this._max&&t.push(e)}else{const e=this.getRegularParam(n.min),r=this.getRegularParam(n.max);e<this._max&&t.push(e),r<this._max&&t.push(r)}t.sort(((e,t)=>e-t));const n=[];for(let e=0;e<t.length-1;e++)t[e+1]-t[e]>o.Tolerance.NUMBER_EPS&&n.push(new c(t[e],t[e+1],this._period));return n}clone(){return new c(this._min,this._max,this._period)}}t.PeriodInterval=c},75948:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Quaternion=void 0;const r=n(91743),s=n(61226);class i{constructor(e,t,n,r){this._x=e||0,this._y=t||0,this._z=n||0,this._w=void 0!==r?r:1}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}get z(){return this._z}set z(e){this._z=e}get w(){return this._w}set w(e){this._w=e}set(e,t,n,r){this._x=e,this._y=t,this._z=n,this._w=r}clone(){return new i(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this}setFromEuler(e){const t=e.x,n=e.y,s=e.z,i=e.order,o=Math.cos,a=Math.sin,c=o(t/2),l=o(n/2),d=o(s/2),u=a(t/2),h=a(n/2),g=a(s/2);return i===r.EulerOrder.XYZ?(this._x=u*l*d+c*h*g,this._y=c*h*d-u*l*g,this._z=c*l*g+u*h*d,this._w=c*l*d-u*h*g):i===r.EulerOrder.YXZ?(this._x=u*l*d+c*h*g,this._y=c*h*d-u*l*g,this._z=c*l*g-u*h*d,this._w=c*l*d+u*h*g):i===r.EulerOrder.ZXY?(this._x=u*l*d-c*h*g,this._y=c*h*d+u*l*g,this._z=c*l*g+u*h*d,this._w=c*l*d-u*h*g):i===r.EulerOrder.ZYX?(this._x=u*l*d-c*h*g,this._y=c*h*d+u*l*g,this._z=c*l*g-u*h*d,this._w=c*l*d+u*h*g):i===r.EulerOrder.YZX?(this._x=u*l*d+c*h*g,this._y=c*h*d+u*l*g,this._z=c*l*g-u*h*d,this._w=c*l*d-u*h*g):i===r.EulerOrder.XZY&&(this._x=u*l*d-c*h*g,this._y=c*h*d-u*l*g,this._z=c*l*g+u*h*d,this._w=c*l*d+u*h*g),this}setFromAxisAngle(e,t){const n=t/2,r=Math.sin(n);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(n),this}setFromRotationMatrix(e){const t=e.data,n=t[0][0],r=t[1][0],s=t[2][0],i=t[0][1],o=t[1][1],a=t[2][1],c=t[0][2],l=t[1][2],d=t[2][2],u=n+o+d;let h;return u>0?(h=.5/Math.sqrt(u+1),this._w=.25/h,this._x=(l-a)*h,this._y=(s-c)*h,this._z=(i-r)*h):n>o&&n>d?(h=2*Math.sqrt(1+n-o-d),this._w=(l-a)/h,this._x=.25*h,this._y=(r+i)/h,this._z=(s+c)/h):o>d?(h=2*Math.sqrt(1+o-n-d),this._w=(s-c)/h,this._x=(r+i)/h,this._y=.25*h,this._z=(a+l)/h):(h=2*Math.sqrt(1+d-n-o),this._w=(i-r)/h,this._x=(s+c)/h,this._y=(a+l)/h,this._z=.25*h),this}setFromUnitVectors(e,t){let n,r=e.dot(t)+1;return r<1e-6?(r=0,n=Math.abs(e.x)>Math.abs(e.z)?new s.Vector3(-e.y,e.x,0):new s.Vector3(0,-e.z,e.y)):n=e.cross(t),this._x=n.x,this._y=n.y,this._z=n.z,this._w=r,this.normalize(),this}reverse(){return this.conjugate(),this}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x*=e,this._y*=e,this._z*=e,this._w*=e),this}multiply(e){return this.multiplyQuaternions(this,e),this}premultiply(e){return this.multiplyQuaternions(e,this),this}multiplyQuaternions(e,t){const n=e._x,r=e._y,s=e._z,i=e._w,o=t._x,a=t._y,c=t._z,l=t._w;return this._x=n*l+i*o+r*c-s*a,this._y=r*l+i*a+s*o-n*c,this._z=s*l+i*c+n*a-r*o,this._w=i*l-n*o-r*a-s*c,this}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],this._w=e[3],this}toArray(){const e=new Array(4);return e[0]=this._x,e[1]=this._y,e[2]=this._z,e[3]=this._w,e}}t.Quaternion=i},77655:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TangentCone=void 0;const r=n(60229),s=n(56973),i=n(61226);t.TangentCone=class{constructor(e,t){this.dir=e,this.angle=t}isConeEmpty(){return this.dir.getSqLength()<s.Tolerance.LENGTH_EPS*s.Tolerance.LENGTH_EPS}isConeValid(){return this.angle!==r.CONST.PI}copy(e){this.dir.copy(e.dir),this.angle=e.angle}mergeCone(e,t=!0){if(e.getSqLength()<s.Tolerance.LENGTH_EPS*s.Tolerance.LENGTH_EPS)return!1;if(this.isConeEmpty())return this.dir=e,!0;const n=this.dir.dot(e);if(t&&n<=-s.Tolerance.ANGLE_EPS)return this.angle=r.CONST.PI,!1;if(Math.abs(n)<1){const t=Math.acos(n);if(t>this.angle){const n=-this.angle,r=Math.max(this.angle,t);this.angle=.5*(r-n);const s=.5*(n+r),i=Math.sin(t-s),o=Math.sin(s),a=this.dir.multiplied(i).add(e.multiplied(o)).multiply(1/Math.sin(t));this.dir=a}}else n<=0&&(this.angle=r.CONST.PI2);return!0}mergeTwoCone(e,t){if(e.dir.equals(i.Vector3.O()))return e.copy(t),!0;const n=e.dir.dot(t.dir);if(n<0)return e.angle=r.CONST.PI,!1;{const s=Math.acos(n);if(s+e.angle<=t.angle)e.copy(t);else if(s+t.angle>e.angle){const n=s+t.angle+e.angle;if(n>=r.CONST.PI)e.angle=r.CONST.PI;else{const r=n/2-t.angle;let i=e.dir.subtracted(t.dir);const o=Math.sin(r);i=i.multiplied(o/(Math.sin(s-r)+o)),e.dir=t.dir.added(i),e.dir.normalize(),e.angle=n/2}}}return!0}}},43255:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TiltBox3=void 0;const r=n(67996);class s extends r.Box3{constructor(e,t){super(),this.min=e.min,this.max=e.max,this.coord=t}getCoord(){return this.coord.clone()}getBox(){return new r.Box3([this.min,this.max])}getCornerPts(){const e=[],t=this.coord;for(const n of this.getBox().getCornerPts()){const r=t.getWorldPtAt(n);e.push(r)}return e}union(e){if(!e.isValid())return this;const t=e.getCornerPts();for(const e of t){const t=this.coord.getLocalPtAt(e);this.expandByPoint(t)}return this}}t.TiltBox3=s},56973:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Tolerance=void 0;const r=n(60229);class s{constructor(e=s.LENGTH_EPS,t=e,n=.1*e,r=s.EDGE_LENGTH_EPS){this.lengthEps=e,this.angleEps=t,this.processLengthEps=n,this.edgeLengthEps=r,this.lengthEps2=e*e,this.processLengthEps2=n*n,this.edgeLengthEps2=r*r}get numEps(){return this.angleEps}get numberEps(){return this.angleEps}areAnglesEqual(e,t){return Math.abs(e-t)<this.angleEps}areLengthEqual(e,t){return Math.abs(e-t)<this.lengthEps}areParamEqual(e,t){return Math.abs(e-t)<this.numberEps}isLengthZero(e){return Math.abs(e)<this.lengthEps}isSquareLengthZero(e){return e<this.lengthEps*this.lengthEps}isParamOnPeriodEnd(e,t=r.CONST.PI2){const n=e%t;return Math.abs(n)<this.numberEps||Math.abs(n+t)<this.numberEps}areParralel(e,t){const n=e.z||0,r=t.z||0,s=e.x*e.x+e.y*e.y+n*n,i=t.x*t.x+e.y*e.y+r*r,o=e.x*t.y-e.y*t.x,a=e.y*r-n*t.y,c=n*t.x-e.x*r;return(a*a+c*c+o*o)/(s*i)<Math.pow(Math.sin(this.angleEps),2)}areNear(e,t){const n=e.z||0,r=t.z||0,s=e.x-t.x,i=e.y-t.y,o=n-r;return s*s+i*i+o*o<this.lengthEps*this.lengthEps}}t.Tolerance=s,s.NUMBER_EPS=1e-6,s.NUMBER_EPS2=s.NUMBER_EPS*s.NUMBER_EPS,s.LENGTH_EPS=1e-6,s.LENGTH_EPS2=s.LENGTH_EPS*s.LENGTH_EPS,s.EDGE_LENGTH_EPS=.001,s.EDGE_LENGTH_EPS2=s.EDGE_LENGTH_EPS*s.EDGE_LENGTH_EPS,s.PROCESS_LENGTH_EPS=1e-7,s.ANGLE_EPS=1e-6,s.ROUGH_ANGLE_EPS=.001,s.DELTA_EPS=1e-10,s.NUMBER_CALCULATION_EPS=1e-8,s.ZERO_JUDGE_EPS=1e-14,s.ZERO_JUDGE_EPS2=1e-28,s.CALCULATE_EPS=1e-12,s.CALCULATE_EPS2=s.CALCULATE_EPS*s.CALCULATE_EPS,s.CALCULATE_EPS4=s.CALCULATE_EPS2*s.CALCULATE_EPS2,s.CLIPPER_SCALE=1e8,s.DEFAULT=new s(s.LENGTH_EPS)},46891:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Vector=void 0;const r=n(49246),s=n(76454),i=n(56973);class o extends s.IVector{constructor(){super()}get x(){return this._data[0]}get y(){return this._data[1]}set x(e){this._data[0]=e}set y(e){this._data[1]=e}multiply(e){for(let t=0;t<this._data.length;t++)this._data[t]*=e;return this}reverse(){for(let e=0;e<this._data.length;e++)this._data[e]=-this._data[e];return this}normalize(){const e=this.getSqLength();if(r.Util.isNearlyEqual(e,1,i.Tolerance.CALCULATE_EPS2))return this;const t=this.z;if(e<i.Tolerance.CALCULATE_EPS2)return this;const n=Math.sqrt(e),s=this.x/n,o=this.y/n;return void 0===t?this.resetFromArray([s,o]):this.resetFromArray([s,o,t/n]),this}translate(e){return this.add(e)}resetFromArray(e){for(let t=this._data.length-1;t>=0;t--)this._data[t]=e[t];return this}}t.Vector=o},33218:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Vector2=void 0;const o=n(72564),a=n(49246),c=n(46891),l=n(60229),d=n(97505),u=n(13982),h=n(26581),g=n(56973);let f=r=class extends c.Vector{constructor(e,t){super(),this._data=[0,0],void 0!==t?"number"==typeof t?this._reset(e,t):this._reset(t.x-e.x,t.y-e.y):e instanceof Array?this._reset(e[0],e[1]):e?this._reset(e.x,e.y):this._reset(0,0)}static make(e){return e instanceof r?e:new r(e)}static O(){return new r(0,0)}static X(e=1){return new r(e,0)}static Y(e=1){return new r(0,e)}get data(){return this._data}add(e){return this._data[0]+=e.x,this._data[1]+=e.y,this}added(e){return new r(this.x+e.x,this.y+e.y)}subtract(e){return this._data[0]-=e.x,this._data[1]-=e.y,this}subtracted(e){return new r(this.x-e.x,this.y-e.y)}multiplied(e){return new r(this.x*e,this.y*e)}dot(e){return this._data[0]*e.x+this._data[1]*e.y}reversed(){return new r(-this.x,-this.y)}interpolate(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}interpolated(e,t){return new r(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t)}midTo(e){return new r(.5*(this.x+e.x),.5*(this.y+e.y))}normalized(){return this.clone().normalize()}translated(e){return this.added(e)}transform(e){const t=e.data||e,n=o.dot([...this._data,1],t),r=n.pop();if(!a.Util.isNearlyEqual(r,1)&&!a.Util.isNearlyZero(r)){const e=1/r;n[0]*=e,n[1]*=e}return this.resetFromArray(n),this}vecTransform(e){const t=e.data||e,n=[t[0],t[1],[0,0,t[2][2]]];return this.transform(n)}transformed(e){return this.clone().transform(e)}vecTransformed(e){return this.clone().vecTransform(e)}rotate(e,t){return this.transform(h.Matrix3.makeRotate(e,t))}rotated(e,t){return this.clone().rotate(e,t)}vecRotate(e){const t=e%l.CONST.PI2;if(a.Util.isNearlyZero(t))return this;if(a.Util.isNearlyEqual(l.CONST.PI_2,t))return[this.x,this.y]=[-this.y,this.x],this;if(a.Util.isNearlyEqual(-l.CONST.PI_2,t))return[this.x,this.y]=[this.y,-this.x],this;if(a.Util.isNearlyEqual(l.CONST.PI,Math.abs(t)))return[this.x,this.y]=[-this.x,-this.y],this;if(a.Util.isNearlyEqual(3*l.CONST.PI_2,t))return[this.x,this.y]=[this.y,-this.x],this;if(a.Util.isNearlyEqual(-3*l.CONST.PI_2,t))return[this.x,this.y]=[-this.y,this.x],this;const n=Math.cos(e),r=Math.sin(e),{x:s,y:i}=this;return[this.x,this.y]=[s*n-i*r,s*r+i*n],this}vecRotated(e){return this.clone().vecRotate(e)}cross(e){return this.x*e.y-this.y*e.x}angle(e){return Math.atan2(Math.abs(this.cross(e)),this.dot(e))}angleTo(e){const t=this.cross(e),n=this.angle(e);return t<0&&n<l.CONST.PI&&n>0?l.CONST.PI2-n:n}isParallel(e,t=g.Tolerance.ANGLE_EPS){const n=this.normalized(),s=new r(e).normalized();return Math.abs(n.cross(s))<t}isPerpendicular(e,t=g.Tolerance.ANGLE_EPS){return Math.abs(this.dot(e))<t}distanceTo(e){return this.subtracted(e).getLength()}sqDistanceTo(e){return this.subtracted(e).getSqLength()}equals(e,t=g.Tolerance.LENGTH_EPS){return this.subtracted(e).isZero(t)}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_VECTOR_2D}dump(){return{type:d.EN_GEO_ELEMENT_TYPE.EN_VECTOR_2D,data:this._data}}clone(){return new r(this._data)}copy(e){return this._data[0]=e.x,this._data[1]=e.y,this}_reset(e,t){this._data[0]=e,this._data[1]=t}};f=r=s([u.registerLoader,i("design:paramtypes",[Object,Object])],f),t.Vector2=f},61226:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Vector3=void 0;const o=n(72564),a=n(46891),c=n(60229),l=n(97505),d=n(13982),u=n(49246),h=n(61210),g=n(56973);let f=r=class extends a.Vector{constructor(e,t,n){super(),this._data=[0,0,0],void 0!==n?this._reset(e,t,n):t?this._reset(t.x-e.x,t.y-e.y,t.z-e.z):e instanceof Array?this._reset(e[0],e[1],e[2]||0):e?this._reset(e.x,e.y,e.z):this._reset(0,0,0)}static make(e){return e instanceof r?e:new r(e)}static O(){return new r(0,0,0)}static X(e=1){return new r(e,0,0)}static Y(e=1){return new r(0,e,0)}static Z(e=1){return new r(0,0,e)}static XY({x:e,y:t},n=0){return new r(e,t,n)}get z(){return this._data[2]}set z(e){this._data[2]=e}get data(){return this._data}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z||0,this}added(e){return new r(this.x+e.x,this.y+e.y,this.z+(e.z||0))}subtract(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z||0,this}subtracted(e){return new r(this.x-e.x,this.y-e.y,this.z-(e.z||0))}multiplied(e){return new r(this.x*e,this.y*e,this.z*e)}dot(e){return this.x*e.x+this.y*e.y+this.z*(e.z||0)}reversed(){return new r(-this.x,-this.y,-this.z)}interpolate(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=((e.z||0)-this.z)*t,this}interpolated(e,t){return new r(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t,this.z+((e.z||0)-this.z)*t)}midTo(e){return new r(.5*(this.x+e.x),.5*(this.y+e.y),.5*(this.z+(e.z||0)))}normalized(){return this.clone().normalize()}translated(e){return this.added(e)}transform(e){const t=e.data||e,n=o.dot([...this._data,1],t),r=n.pop();if(!u.Util.isNearlyEqual(r,1)&&!u.Util.isNearlyZero(r)){const e=1/r;n[0]*=e,n[1]*=e,n[2]*=e}return this.resetFromArray(n),this}transformed(e){return this.clone().transform(e)}vecTransform(e){const t=e.data||e,n=[t[0],t[1],t[2],[0,0,0,t[3][3]]];return this.transform(n)}vecTransformed(e){return this.clone().vecTransform(e)}rotate(e,t,n){return this.transform(h.Matrix4.makeRotate(e,t,n))}rotated(e,t,n){return this.clone().rotate(e,t,n)}vecRotate(e,t){return this.vecTransform(h.Matrix4.makeRotate(r.O(),e,t))}vecRotated(e,t){return this.clone().vecRotate(e,t)}getPerpendicular(){const e=this.isParallel({x:0,y:0,z:1})?{x:0,y:-1,z:0}:{x:0,y:0,z:-1};return this.cross(e).normalize()}cross(e){const t=this.y*e.z-this.z*e.y,n=this.z*e.x-this.x*e.z,s=this.x*e.y-this.y*e.x;return new r(t,n,s)}isParallel(e,t=g.Tolerance.ANGLE_EPS){const n=this.getSqLength(),{x:r,y:s,z:i}=e,o=r*r+s*s+i*i;return this.cross(e).getSqLength()<=t*t*n*o}isPerpendicular(e,t=g.Tolerance.ANGLE_EPS){const n=this.getSqLength(),{x:r,y:s,z:i}=e,o=r*r+s*s+i*i,a=this.dot(e);return a*a<=t*t*n*o}angle(e,t,n=g.Tolerance.DEFAULT){const s=new r(e);if(this.isZero(n.lengthEps)||s.isZero(n.lengthEps))return 0;const i=this.cross(s),o=i.getLength();return t&&(n.isLengthZero(o)?(t.x=0,t.y=0,t.z=0):(t.x=i.x/o,t.y=i.y/o,t.z=i.z/o)),Math.atan2(o,this.dot(s))}angleTo(e,t){const n=this.cross(e),r=this.angle(e);return n.dot(t)<0&&r<c.CONST.PI&&r>0?c.CONST.PI2-r:r}distanceTo(e){return this.subtracted(e).getLength()}sqDistanceTo(e){return this.subtracted(e).getSqLength()}equals(e,t=g.Tolerance.LENGTH_EPS){return this.subtracted(e).isZero(t)}getType(){return l.EN_GEO_ELEMENT_TYPE.EN_VECTOR_3D}dump(){return{type:l.EN_GEO_ELEMENT_TYPE.EN_VECTOR_3D,data:this._data}}clone(){return new r(this._data)}copy(e){return this._data[0]=e.x,this._data[1]=e.y,this._data[2]=e.z,this}_reset(e,t,n){this._data[0]=e,this._data[1]=t,this._data[2]=n}};f=r=s([d.registerLoader,i("design:paramtypes",[Object,Object,Object])],f),t.Vector3=f},54060:function(e,t){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.NormalUnitsConversion=t.UnitsConversion=t.UnitType=void 0,function(e){e[e.MM=0]="MM",e[e.METER=1]="METER",e[e.INCH=2]="INCH"}(n=t.UnitType||(t.UnitType={}));t.UnitsConversion=class{static getScale(e=n.MM){return e===n.METER?1024:e===n.INCH?32:1}};t.NormalUnitsConversion=class{static getScale(e=n.MM){return e===n.METER?1e3:e===n.INCH?25.39999918:1}}},10909:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Arc2d=t.ArcType=void 0;const o=n(60229),a=n(68990),c=n(33218),l=n(97505),d=n(26773),u=n(13982),h=n(94399),g=n(49246),f=n(56973),p=n(74729),_=n(44757),m=n(43640),v=n(17165),E=n(26581),P=n(90361),y=n(97700),C=n(48448);var S;!function(e){e[e.HalfArc=0]="HalfArc",e[e.SmallArc=-1]="SmallArc",e[e.BigArc=1]="BigArc"}(S=t.ArcType||(t.ArcType={}));let T=r=class extends a.Curve2d{constructor(e,t,n,r,s){super(),this._range=new d.PeriodInterval(0,o.CONST.PI2),this._a=1,this._b=1,this._coord=p.Coordinate2.XOY(),this._clockSign=1,t&&n&&e&&void 0!==r&&(this._a=t,this._b=n,this._coord=e.clone(),this._clockSign=r?1:-1,this._range=s?new d.PeriodInterval(s[0],s[1]):new d.PeriodInterval(0,o.CONST.PI2))}static makeArcByStartEndAngles(e,t,n,s,i){let a,l;return i?(a=n,l=s):(a=-n,l=-s),a=d.PeriodInterval.RegularizeParam(a),l=d.PeriodInterval.RegularizeParam(l-a)+a,g.Util.isNearlyEqual(a,l)&&!g.Util.isNearlyEqual(n,s)&&(l=a+o.CONST.PI2),new r(new p.Coordinate2(e,c.Vector2.X()),t,t,i,[a,l])}static makeArcByThreePoints(e,t,n){const s=h.Circle2d.makeCircleByThreePoints(e,t,n);if(!s)return;const i=new c.Vector2(e).subtract(t),o=new c.Vector2(n).subtract(t).cross(i)>0,a=new c.Vector2(e).subtract(s.getCenter()),l=Math.atan2(a.y,a.x),d=new c.Vector2(n).subtract(s.getCenter()),u=Math.atan2(d.y,d.x);return r.makeArcByStartEndAngles(s.getCenter(),s.getRadius(),l,u,o)}static makeArcByStartEndPoints(e,t,n,s){const i=new c.Vector2(t).subtract(e),a=new c.Vector2(n).subtract(e),l=Math.atan2(i.y,i.x);let d=Math.atan2(a.y,a.x);return g.Util.isNearlyEqual(l,d)&&(d+=o.CONST.PI2),r.makeArcByStartEndAngles(e,new c.Vector2(e).distanceTo(t),l,d,s)}static makeArcFromCircle(e,t,n,r){return this.makeArcByStartEndAngles(e.getCenter(),e.getRadius(),t,n,r)}static makeEllipseByFivePoints(e,t,n,s,i,a=new f.Tolerance){const l=new c.Vector2(t).subtract(e),d=new c.Vector2(n).subtract(e),u=l.getLength();let h=d.getLength();if(a.isLengthZero(u)||a.isLengthZero(h)||a.areParralel(l,d))return;d.subtract(l.multiplied(d.dot(l)/u/u)),h=d.getLength();const g=l.cross(d)>0?1:-1,_=new p.Coordinate2(e,l),m=_.getLocalPtAt(s),v=_.getLocalPtAt(i),E=Math.atan2(m.y/h,m.x/u)*g,P=a.areNear(s,i)?E+o.CONST.PI2:Math.atan2(v.y/h,v.x/u)*g;return new r(_,u,h,g>0,[E,P])}static makeEllipseByCenterAndThreePoints(e,t,n=1){if(3!==t.length)return;const s=new p.Coordinate2(e,c.Vector2.X()),i=t.map((e=>s.getLocalPtAt(e))),a=[];for(const e of i)a.push([e.x*e.x,e.x*e.y,e.y*e.y]);const l=y.LinearSystem.execute(a,[1,1,1]);if(!l)return;const[d,u,h]=l,g=.5*Math.atan(u/(d-h)),f=Math.cos(g),_=Math.sin(g),m=c.Vector2.X().multiplied(f).added(c.Vector2.Y().multiplied(_)),v=new p.Coordinate2(e,m),E=d*f*f+h*_*_+u*f*_,P=h*f*f+d*_*_-u*f*_,C=Math.sqrt(1/E),S=Math.sqrt(1/P),T=Math.atan2(i[0].y/S,i[0].x/C)*n,b=i[0].equals(i[2])?T+o.CONST.PI2:Math.atan2(i[2].y/S,i[2].x/C)*n;return new r(v,C,S,n>0,[T,b])}static makeEllipseByFiveArcPoints(e,t=1){if(5!==e.length)return;const n=[];for(const t of e)n.push([t.x*t.x,t.x*t.y,t.y*t.y,t.x,t.y]);const s=y.LinearSystem.execute(n,[1,1,1,1,1]);if(!s)return;const[i,a,l,d,u]=s,h=.5*Math.atan(a/(i-l)),g=Math.cos(h),f=Math.sin(h),_=c.Vector2.X().multiplied(g).added(c.Vector2.Y().multiplied(f)),m=new c.Vector2(-d/2,-u/2),v=new p.Coordinate2(m,_),E=i*g*g+l*f*f+a*g*f,P=l*g*g+i*f*f-a*g*f,C=Math.sqrt(1/E),S=Math.sqrt(1/P),T=new c.Vector2(e[0].x-m.x,e[0].y-m.y),b=Math.atan2(T.y/S,T.x/C)*t,w=new c.Vector2(e[4].x-m.x,e[4].y-m.y),x=T.equals(w)?b+o.CONST.PI2:Math.atan2(w.y/S,w.x/C)*t;return new r(v,C,S,t>0,[b,x])}getA(){return this._a}setA(e){this._a=e}getB(){return this._b}setB(e){this._b=e}getCoord(){return this._coord}setCoord(e){this._coord=e.clone()}getRange(){return this._range}getCircle(){return this._assertCircle(),new h.Circle2d(this._coord.getOrigin(),this._a)}getCenter(){return this._coord.getOrigin()}getRadius(){return this._assertCircle(),(this._a+this._b)/2}isCCW(){return this._clockSign>0}getPtAt(e){const t=this._a*Math.cos(e),n=this._b*Math.sin(e)*this._clockSign;return this._coord.getWorldPtAt({x:t,y:n})}getAngleFromParam(e){return this._clockSign*e}getStartAngle(){return this.getAngleFromParam(this.getStartParam())}getEndAngle(){return this.getAngleFromParam(this.getEndParam())}getArcType(){const e=this.getRange().getLength();return g.Util.isNearlyEqual(e,o.CONST.PI)?S.HalfArc:g.Util.isNearlyBigger(e,o.CONST.PI)?S.BigArc:S.SmallArc}IsInRangeInner(e,t,n){if(t.sqDistanceTo(n)<f.Tolerance.LENGTH_EPS2)return!0;const r=this.getCenter(),s=t.subtracted(r).normalize(),i=n.subtracted(r).normalize();let o,a;1===this._clockSign?(o=s.angleTo(i),a=s):(o=i.angleTo(s),a=i);const c=e.subtracted(r).normalize();return a.angleTo(c)<o}getBoundingBox(e){const t=this.getCoord().getDx().x,n=this.getCoord().getDx().y,r=this._a*t,s=this._b*n;let i=Math.atan2(s,-r);i<0&&(i+=o.CONST.PI2);let a=i+o.CONST.PI;a>o.CONST.PI2&&(a-=o.CONST.PI2);const l=this._a*n,d=this._b*t;let u=Math.atan2(d,l);u<0&&(u+=o.CONST.PI2);let h=u+o.CONST.PI;h>o.CONST.PI2&&(h-=o.CONST.PI2);const g=this.getCenter(),f=[],p=[i,a,u,h];for(const e of p){const t=Math.sin(e),n=Math.cos(e),i=new c.Vector2(r*n-s*t,l*n+d*t);f.push(i.add(g))}const _=e||this.getRange(),m=this.getPtAt(_.min),v=this.getPtAt(_.max),E=new P.Box2([m,v]);for(const e of f)this.IsInRangeInner(e,m,v)&&E.expandByPoint(e);return E}getParamAt(e,t=f.Tolerance.LENGTH_EPS){const n=this._coord.getLocalPtAt(e),r=n.x/this._a,s=n.y/this._b,i=Math.atan2(s,r)*this._clockSign;if(g.Util.isNearlyEqual(this._a,this._b,t))return this._range.getRegularParam(i);const a=t/(this._a+this._b),l=r*r+s*s;if(Math.abs(l-1)<=a){const t=this._coord,n=t.getDx().angleTo(new c.Vector2(e).subtract(t.getOrigin()).normalize()),r=Math.atan2(Math.sin(n)/this.getB(),Math.cos(n)/this.getA()),s=this.isCCW()?r:o.CONST.PI2-r;return this._range.getRegularParam(s)}if(l>1)return this._range.getRegularParam(this.getFootByIterate(e,i,a));let d,u;return this._a>this._b?n.y>-t?(d=this.getFootByIterate(e,o.CONST.PI_2*this._clockSign,a),n.y<t&&Math.abs(Math.sin(d))>a&&(u=-d)):d=this.getFootByIterate(e,-o.CONST.PI_2*this._clockSign,a):n.x>-t?(d=this.getFootByIterate(e,0,a),n.x<t&&Math.abs(Math.cos(d))>a&&(u=o.CONST.PI-d)):d=this.getFootByIterate(e,o.CONST.PI,a),d=this._range.getRegularParam(d),void 0===u||this._range.containsPoint(d)?d:(u=this._range.getRegularParam(u),this._range.containsPoint(u)?u:d)}getAllFootParams(e,t=f.Tolerance.LENGTH_EPS){if(this.isEqualAB())return[this.getParamAt(e)];const n=t/(this._a+this._b),r=[];r.push(this.getFootByIterate(e,0,n)),r.push(this.getFootByIterate(e,o.CONST.PI_2,n)),r.push(this.getFootByIterate(e,o.CONST.PI,n)),r.push(this.getFootByIterate(e,3*o.CONST.PI_2,n));for(let e=0;e<r.length;e++)r[e]=d.PeriodInterval.RegularizeParam(r[e]);const s=g.Util.getUniqueOnes(r,((e,t)=>{const r=d.PeriodInterval.RegularizeParam(e-t);return r<n||r>o.CONST.PI2-n}));for(let n=0;n<s.length;){const r=s[n],i=this.getPtAt(r).subtract(e),o=i.getLength();if(o<t){n++;continue}i.multiply(1/o);const a=this.getTangentAt(r);Math.abs(i.dot(a))<t?n++:s.splice(n,1)}return s.map((e=>this._range.getRegularParam(e)))}getParamRangeAt(e,t){const n=this.getParamAt(e),r=this.getParamAt(t);return new d.PeriodInterval(n,r)}getTangentAt(e){const t=-this._a*Math.sin(e),n=this._b*Math.cos(e)*this._clockSign;return this._coord.getWorldVectorAt({x:t,y:n}).normalize()}isEqualAB(){return Math.abs(this._a-this._b)<f.Tolerance.LENGTH_EPS}getDerivatives(e,t){const n=this._a,r=this._b*this._clockSign,s=Math.cos(e),i=Math.sin(e),o=[s,-i,-s,i],a=[i,s,-i,-s],l=[];l.push(this.getPtAt(e));for(let e=1;e<=t;e++){const t=new c.Vector2(o[e%4]*n,a[e%4]*r);l.push(this._coord.getWorldVectorAt(t))}return l}getLength(e){const t=e||this.getRange();return this.isEqualAB()?this.getRadius()*t.getLength():super.getLength(e)}isClosed(){return g.Util.isNearlyEqual(this._range.getLength(),o.CONST.PI2)}reverse(){return this._clockSign=-this._clockSign,this._range=new d.PeriodInterval(-this._range.max,-this._range.min,o.CONST.PI2),this}split(e,t){const n=e.filter((e=>this._range.containsPoint(e,t)&&!this._range.containsPointAtStartOrEnd(e,t)));if(!n.length)return[];return this._range.splited(...n).map((e=>new r(this._coord,this._a,this._b,this._clockSign>0,e.toArray())))}offset(e){this._assertCircle();const t=e*this._clockSign;return!(t+Math.min(this._a,this._b)<0)&&(this._a+=t,this._b+=t,!0)}transform(e,t){const n=this._coord.getDx(),r=this._coord.getDy(),s=n.multiply(this._a).vecTransform(e),i=r.multiply(this._b*this._clockSign).vecTransform(e);let o,a;if(s.normalized().isPerpendicular(i.normalized()))o=s,a=i;else{const e=.5*Math.atan2(2*s.dot(i),s.getSqLength()-i.getSqLength()),t=Math.sin(e),n=Math.cos(e);o=s.multiplied(n).add(i.multiplied(t)),a=s.multiplied(-t).add(i.multiplied(n))}const c=(e=>{const t=(e.x*o.x+e.y*o.y)/o.getSqLength(),n=(e.x*a.x+e.y*a.y)/a.getSqLength();return Math.atan2(n,t)})(s.multiplied(Math.cos(this._range.min)).add(i.multiplied(Math.sin(this._range.min))));return this._range=new d.PeriodInterval(c,this._range.getLength()+c),this._clockSign=s.cross(i)<0?-1:1,this._a=o.getLength(),this._b=a.getLength(),this._coord.setOrigin(this._coord.getOrigin().transform(e)),this._coord.setDx(o.normalized()),this}translate(e){return this._coord.translate(e),this}rotate(e,t={x:0,y:0}){const n=E.Matrix3.makeRotate(t,e);return this._coord.transform(n),this}scale(e,t={x:0,y:0}){this._a*=e,this._b*=e;const n=this._coord.getOrigin().subtract(t).multiply(e).add(t);return this._coord.setOrigin(n),this}getDiscreteHintSegmentCount(e=m.DiscreteParameter.NORMAL){return Math.ceil((this._range.max-this._range.min)/e.tolerance.angleEps+2)}discrete(e=m.DiscreteParameter.NORMAL){const t=this.getDiscreteHintSegmentCount(e);return v.DiscreteUtil.discreteCurve2d(this,e.clone({hintSegmentCount:t}))}getType(){return l.EN_GEO_ELEMENT_TYPE.EN_ARC_2D}toNurbs(e=2,t=f.Tolerance.LENGTH_EPS){const n=this.getCenter(),r=this.getCoord().getDx().multiply(this._a),s=this.getCoord().getDy().multiply(this._b),i=[n.added(r),n.added(r).added(s),n.added(s).subtracted(r),n.subtracted(r),n.subtracted(r).subtracted(s),n.subtracted(s).added(r),n.added(r)];this._clockSign<0&&i.reverse();return C.NurbsCurve2d.makeByControlPoints(i,2,[0,0,0,.25,.5,.5,.75,1,1,1],[1,.5,.5,1,.5,.5,1])}clone(){return new r(this._coord,this._a,this._b,this._clockSign>0,this.getRange().toArray())}dump(){return{type:this.getType(),data:[this._a,this._b,this._coord.dump(),this._clockSign,this.getRange().toArray()]}}load({data:[e,t,n,r,s]}){return this._a=e,this._b=t,this._coord.load(n),this._clockSign=r,this._range=new d.PeriodInterval(s[0],s[1]),this}_getMinDistanceToStartEndPoints(e){const t=this.getStartPt().sqDistanceTo(e),n=this.getEndPt().sqDistanceTo(e);return t<n?{param:this.getStartParam(),sqDist:t}:{param:this.getEndParam(),sqDist:n}}_assertCircle(){_.MathAssert.warn(this.isEqualAB(),"圆弧非正圆，计算结果不精确")}};T=r=s([u.registerLoader,i("design:paramtypes",[p.Coordinate2,Number,Number,Boolean,Array])],T),t.Arc2d=T},97602:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Arc3d=void 0;const o=n(60229),a=n(2111),c=n(97505),l=n(13982),d=n(61226),u=n(29540),h=n(89494),g=n(26773),f=n(44757),p=n(49246),_=n(56973),m=n(43640),v=n(17165),E=n(74729),P=n(10909),y=n(77655),C=n(61210),S=n(93145);let T=r=class extends a.Curve3d{constructor(e,t,n,r){super(),this._coord=new h.Coordinate3,void 0!==t&&void 0!==n&&e&&(this._a=t,this._b=n,this._coord=e.clone(),this._range=r?new g.PeriodInterval(r[0],r[1]):new g.PeriodInterval(0,o.CONST.PI2))}static makeArcByThreePoints(e,t,n){const s=u.Circle3d.makeCircleByThreePoints(e,t,n);if(!s)return;const i=new r(s.getCCS(),s.getRadius(),s.getRadius(),[0,o.CONST.PI2]),a=new d.Vector3(e),c=g.PeriodInterval.RegularizeParam(i.getParamAt(e));let l=g.PeriodInterval.RegularizeParam(i.getParamAt(n)-c);return a.equals(n)&&(l=a.equals(t)?0:o.CONST.PI2),i.setRange(c,c+l)}static makeArcByStartEndPoints(e,t,n,s,i,a){const c=new d.Vector3(s).subtracted(e).normalize(),l=new d.Vector3(n).cross(c).normalize().multiply(a?1:-1),u=new h.Coordinate3(e,c,l),g=new r(u,t,t,[0,o.CONST.PI2]),f=g.getParamAt(s);let _=g.getParamAt(i);return p.Util.isNearlyEqual(f,_)&&(_+=o.CONST.PI2),g.setRange(f,_),g}static makeArcByCircleAndPts(e,t,n,s){const i=e.clone();let a=i.getParamAt(t),c=i.getParamAt(n);const l=i.getCCS();return s||(l.setXYDirs(l.getDx(),l.getDy().multiply(-1)),a=-a,c=-c),p.Util.isNearlyEqual(a,c)&&(c=a+o.CONST.PI2),new r(l,e.getRadius(),e.getRadius(),[a,c])}static makeEllipseByFivePoints(e,t,n,s,i,a=new _.Tolerance){const c=new d.Vector3(t).subtract(e),l=new d.Vector3(n).subtract(e),u=c.getLength();let g=l.getLength();if(a.isLengthZero(u)||a.isLengthZero(g)||a.areParralel(c,l))return;l.subtract(c.multiplied(l.dot(c)/u/u)),g=l.getLength();const f=new h.Coordinate3(e,c,l),p=f.getLocalPtAt(s),m=f.getLocalPtAt(i),v=Math.atan2(p.y/g,p.x/u),E=a.areNear(s,i)?v+o.CONST.PI2:Math.atan2(m.y/g,m.x/u);return new r(f,u,g,[v,E])}getA(){return this._a}setA(e){this._a=e}getB(){return this._b}setB(e){this._b=e}getCoord(){return this._coord}setCoord(e){this._coord=e.clone()}getRange(){return this._range}getCenter(){return this._coord.getOrigin()}getNormal(){return this._coord.getDz()}getCircle(){return this._assertCircle(),new u.Circle3d(this._coord,this._a)}getRadius(){return this._assertCircle(),(this._a+this._b)/2}getPtAt(e){const t=new d.Vector3(Math.cos(e)*this._a,Math.sin(e)*this._b,0);return this._coord.getWorldPtAt(t)}getParamAt(e,t=_.Tolerance.LENGTH_EPS){const n=this._coord.getLocalPtAt(e);return new P.Arc2d(E.Coordinate2.XOY(),this._a,this._b,!0,this._range.toArray()).getParamAt(n,t)}getAllFootParams(e,t=_.Tolerance.LENGTH_EPS){if(this.isEqualAB())return[this.getParamAt(e)];const n=this._coord.getLocalPtAt(e);return new P.Arc2d(E.Coordinate2.XOY(),this._a,this._b,!0,this._range.toArray()).getAllFootParams(n,t)}getParamRangeAt(e,t){const n=this.getParamAt(e),r=this.getParamAt(t);return new g.PeriodInterval(n,r)}getTangentAt(e){const t=new d.Vector3(-this._a*Math.sin(e),this._b*Math.cos(e),0);return this._coord.getWorldVectorAt(t).normalize()}getTangentCone(e,t=!0){const n=e||this._range,r=new y.TangentCone(d.Vector3.O(),0),s=n.getLength();if(p.Util.isNearlyBiggerOrEqual(s,o.CONST.PI,_.Tolerance.ANGLE_EPS))r.dir=d.Vector3.X(),r.angle=o.CONST.PI;else{const e=this.getTangentAt(n.min),t=this.getTangentAt(n.max),s=e.angleTo(t,this._coord.getDz()),i=e;i.vecRotate(this._coord.getDz(),s/2),r.dir=i,r.angle=s/2}return r}isEqualAB(){return Math.abs(this._a-this._b)<_.Tolerance.LENGTH_EPS}getDerivatives(e,t){const n=this._a,r=this._b,s=Math.cos(e),i=Math.sin(e),o=[s,-i,-s,i],a=[i,s,-i,-s],c=[];c.push(this.getPtAt(e));for(let e=1;e<=t;e++){const t=new d.Vector3(o[e%4]*n,a[e%4]*r,0);c.push(this._coord.getWorldVectorAt(t))}return c}isClosed(){return this._range.isClosed()}getLength(e){const t=e||this.getRange();return this.isEqualAB()?this.getRadius()*t.getLength():super.getLength(e)}reverse(){return this._range=new g.PeriodInterval(-this._range.max,-this._range.min),this._coord.setXYDirs(this._coord.getDx(),this._coord.getDy().multiply(-1)),this}split(e,t){const n=e.filter((e=>this._range.containsPoint(e,t)&&!this._range.containsPointAtStartOrEnd(e,t)));if(!n.length)return[];return this._range.splited(...n).map((e=>new r(this._coord,this._a,this._b,[e.min,e.max])))}transform(e,t){const n=this._coord.getDx().multiply(this._a).vecTransform(e),r=this._coord.getDy().multiply(this._b).vecTransform(e);let s,i;if(n.normalized().isPerpendicular(r.normalized()))s=n,i=r;else{const e=.5*Math.atan2(2*n.dot(r),n.getSqLength()-r.getSqLength()),t=Math.sin(e),o=Math.cos(e);s=n.multiplied(o).add(r.multiplied(t)),i=n.multiplied(-t).add(r.multiplied(o))}const o=(e=>{const t=(e.x*s.x+e.y*s.y+e.z*s.z)/s.getSqLength(),n=(e.x*i.x+e.y*i.y+e.z*i.z)/i.getSqLength();return Math.atan2(n,t)})(n.multiplied(Math.cos(this._range.min)).add(r.multiplied(Math.sin(this._range.min))));return this._range=new g.PeriodInterval(o,this._range.getLength()+o),this._coord.setOrigin(this._coord.getOrigin().transform(e)),this._coord.setDx(s.normalized()),this._coord.setDy(i.normalized()),this._a=s.getLength(),this._b=i.getLength(),this}translate(e){return this._coord.translate(e),this}rotate(e,t,n={x:0,y:0,z:1}){const r=C.Matrix4.makeRotate(t,n,e);return this._coord.transform(r),this}scale(e,t){this._a*=e,this._b*=e;const n=this._coord.getOrigin().subtract(t).multiply(e).add(t);return this._coord.setOrigin(n),this}isPlaneCurve3d(e){return this._coord.getDz()}discrete(e=m.DiscreteParameter.NORMAL){return v.DiscreteUtil.discreteCurve3d(this,e)}discreteBySpan(e=o.CONST.APPROX_ARC_MAX){const t=Math.ceil((this._range.max-this._range.min)/e),n=(this._range.max-this._range.min)/t,r=[];for(let e=0;e<t;e++)r.push(this.getPtAt(this._range.min+e*n));return r.push(this.getEndPt()),r}getType(){return c.EN_GEO_ELEMENT_TYPE.EN_ARC_3D}toNurbs(e=2,t=_.Tolerance.LENGTH_EPS){const n=this.getCenter(),r=this.getCoord().getDx().multiply(this._a),s=this.getCoord().getDy().multiply(this._b),i=[n.added(r),n.added(r).added(s),n.added(s).subtracted(r),n.subtracted(r),n.subtracted(r).subtracted(s),n.subtracted(s).added(r),n.added(r)];return S.NurbsCurve3d.makeByControlPoints(i,2,[0,0,0,.25,.5,.5,.75,1,1,1],[1,.5,.5,1,.5,.5,1])}clone(){return new r(this._coord,this._a,this._b,this._range.toArray())}dump(){return{type:this.getType(),data:[this._coord.dump(),this._a,this._b,this._range.toArray()]}}load({data:[e,t,n,r]}){return this._a=t,this._b=n,this._coord.load(e),this._range=new g.PeriodInterval(r[0],r[1],o.CONST.PI2),this}_assertCircle(){f.MathAssert.warn(this.isEqualAB(),"圆弧非正圆，计算结果不精确")}};T=r=s([l.registerLoader,i("design:paramtypes",[h.Coordinate3,Number,Number,Array])],T),t.Arc3d=T},94399:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Circle2d=void 0;const o=n(60229),a=n(68990),c=n(33218),l=n(90361),d=n(97505),u=n(6688),h=n(13982),g=n(49246),f=n(56973),p=n(43640),_=n(17165);let m=r=class extends a.Curve2d{constructor(e,t){super(),this._center=c.Vector2.O(),this._radius=0,e&&t&&(this._center=new c.Vector2(e),this._radius=t,this._range=new u.Interval(0,o.CONST.PI2*t))}static makeCircleByThreePoints(e,t,n){const s=e.x-t.x,i=e.y-t.y,o=(e.x*e.x-t.x*t.x+e.y*e.y-t.y*t.y)/2,a=n.x-t.x,l=n.y-t.y,d=(n.x*n.x-t.x*t.x+n.y*n.y-t.y*t.y)/2,u=s*l-a*i;if(g.Util.isNearlyEqual(u,0))return;const h=new c.Vector2((o*l-d*i)/u,(s*d-a*o)/u),f=h.distanceTo(e);return new r(h,f)}getCenter(){return this._center.clone()}getRadius(){return this._radius}getPtAt(e){const t=e/this._radius;return new c.Vector2(this._center.x+this._radius*Math.cos(t),this._center.y+this._radius*Math.sin(t))}getParamAt(e){const t=new c.Vector2(e).subtract(this._center);return Math.atan2(t.y,t.x)}getTangentAt(e){const t=this.getPtAt(e);t.subtract(this._center);return new c.Vector2(-t.y,t.x).normalize()}getDerivatives(e,t){throw new Error("未实现！")}getLength(e){throw new Error("暂时还没有实现")}reverse(){throw new Error("not implement")}split(e,t){throw new Error("not implement")}offset(e){const t=this._radius+e;return!(t<f.Tolerance.LENGTH_EPS)&&(this._radius=t,this._range=new u.Interval(0,o.CONST.PI2*this._radius),!0)}transform(e){return this._center.transform(e),this._radius=new c.Vector2(this._radius,0).vecTransform(e).getLength(),this._range=new u.Interval(0,o.CONST.PI2*this._radius),this}getBoundingBox(){const e=this._center.clone().add(new c.Vector2(-this._radius,-this._radius)),t=this._center.clone().add(new c.Vector2(this._radius,this._radius));return new l.Box2([e,t])}discrete(e=p.DiscreteParameter.NORMAL){const t=e.tolerance,n=2*Math.acos(1-t.lengthEps/this._radius),r=this._range.getLength()/this._radius/Math.min(n,t.angleEps);return _.DiscreteUtil.discreteCurve2d(this,e.clone({hintSegmentCount:r+2}))}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_CIRCLE_2D}clone(){return new r(this._center,this._radius)}dump(){return{type:this.getType(),data:[this._center.toArray2(),this._radius]}}load({data:[e,t]}){return this._center.resetFromArray(e),this._radius=t,this._range=new u.Interval(0,o.CONST.PI2*t),this}};m=r=s([h.registerLoader,i("design:paramtypes",[Object,Number])],m),t.Circle2d=m},29540:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Circle3d=void 0;const o=n(60229),a=n(2111),c=n(61226),l=n(97505),d=n(6688),u=n(13982),h=n(89494),g=n(67996),f=n(5804),p=n(56973),_=n(43640),m=n(17165);let v=r=class extends a.Curve3d{constructor(e,t){super(),this._ccs=h.Coordinate3.XOY(),this._radius=0,e&&t&&(this._ccs=e.clone(),this._radius=t,this._range=new d.Interval(0,o.CONST.PI2*t))}static makeCircleByCCSRadius(e,t,n,s){return new r(new h.Coordinate3(e,t,n),s)}static makeCircleByThreePoints(e,t,n){const s=r._makeCircleCCSByThreePoints(new c.Vector3(e),new c.Vector3(t),new c.Vector3(n));if(!s)return;const i=s.getOrigin().distanceTo(e);return new r(s,i)}static _makeCircleCCSByThreePoints(e,t,n){const r=f.Plane.makePlaneByTreePoints(e,t,n);if(!r)return;const s=r.getNorm(),i=e.clone().interpolate(t,.5),o=t.clone().interpolate(n,.5),a=t.subtracted(e).normalize(),c=n.subtracted(t).normalize(),l=s.cross(a),d=s.cross(c),u=l.cross(d),g=o.subtracted(i),p=u.multiplied(-1),_=d.cross(g);let m=_.getLength()/p.getLength();p.dot(_)<0&&(m=-m);const v=i.added(l.multiplied(m)),E=e.subtracted(v).normalize(),P=s.cross(E);return new h.Coordinate3(v,E,P)}getCCS(){return this._ccs.clone()}getCenter(){return this._ccs.getOrigin()}getNormal(){return this._ccs.getDz()}getRadius(){return this._radius}getPtAt(e){const t=e/this._radius,n=this._ccs.getDx(),r=this._ccs.getDy(),s=n.multiply(Math.cos(t)).add(r.multiply(Math.sin(t))).multiply(this._radius);return this.getCenter().add(s)}getLength(e){throw new Error("暂时还没有实现")}getParamAt(e){const t=this._ccs.getLocalPtAt(e);return Math.atan2(t.y,t.x)*this._radius}getTangentAt(e){const t=this.getPtAt(e);t.subtract(this.getCenter());return this.getNormal().cross(t).normalize()}isPlaneCurve3d(e){return this._ccs.getDz()}getDerivatives(e,t){throw new Error("未实现！")}reverse(){throw new Error("not implement")}offset(e){const t=this._radius+e;return!(t<p.Tolerance.LENGTH_EPS)&&(this._radius=t,this._range=new d.Interval(0,o.CONST.PI2*this._radius),!0)}transform(e){return this._radius=new c.Vector3(this._radius,0,0).vecTransform(e).getLength(),this._ccs.transform(e),this._range=new d.Interval(0,o.CONST.PI2*this._radius),this}getBoundingBox(e){const t=new g.Box3,n=this.getCenter();return t.expandByPoint(this.getProjectedPtBy(n.clone().add(c.Vector3.X()))),t.expandByPoint(this.getProjectedPtBy(n.clone().add(c.Vector3.X().reverse()))),t.expandByPoint(this.getProjectedPtBy(n.clone().add(c.Vector3.Y()))),t.expandByPoint(this.getProjectedPtBy(n.clone().add(c.Vector3.Y().reverse()))),t.expandByPoint(this.getProjectedPtBy(n.clone().add(c.Vector3.Z()))),t.expandByPoint(this.getProjectedPtBy(n.clone().add(c.Vector3.Z().reverse()))),t}split(e,t){throw new Error("暂未实现")}discrete(e=_.DiscreteParameter.NORMAL){const t=e.tolerance,n=2*Math.acos(1-t.lengthEps/this._radius),r=this._range.getLength()/this._radius/Math.min(n,t.angleEps);return m.DiscreteUtil.discreteCurve3d(this,e.clone({hintSegmentCount:r+2}))}getType(){return l.EN_GEO_ELEMENT_TYPE.EN_CIRCLE_3D}clone(){return new r(this._ccs,this._radius)}dump(){return{type:this.getType(),data:[this._ccs.dump(),this._radius]}}load({data:[e,t]}){return this._ccs.load(e),this._radius=t,this._range=new d.Interval(0,o.CONST.PI2*t),this}};v=r=s([u.registerLoader,i("design:paramtypes",[h.Coordinate3,Number])],v),t.Circle3d=v},49509:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CircularSurface=void 0;const r=n(46182),s=n(44757),i=n(56973),o=n(87222),a=n(97602),c=n(33218),l=n(32858),d=n(60229),u=n(49246),h=n(93145),g=n(53487),f=n(9327);class p extends r.CoordinateBasedSurface{getA(){return this._a}setA(e){this._a=e}getB(){return this._b}setB(e){this._b=e}getRadius(){return s.MathAssert.assert(this.isEqualAB(),"获取半径时，圆弧长短轴长度不一致"),this._a}isEqualAB(e=i.Tolerance.LENGTH_EPS){return Math.abs(this._a-this._b)<e}wireToUV(e,t=i.Tolerance.DEFAULT){const n=new Map,r=e.map((e=>{const t=this.getCurve2d(e);return s.MathAssert.assert(t,"result crv2d is undefined",e),n.set(e,t),t})),o=[];for(let n=0;n<r.length;n++){const s=n-1<0?n-1+r.length:n-1,i=r[s].getEndPt(),a=r[n].getStartPt();if(!a.equals(i,t.lengthEps)&&r[n].isLine2d()){const l=i.x-a.x,h=[n];let g=r[n],f=g.getEndPt(),p=(n+1)%r.length;for(;r[p].isLine2d()&&r[p].getStartPt().equals(f,t.lengthEps);){const e=r[p];if(!e.getDirection().isParallel(g.getDirection(),t.angleEps))break;h.push(p),g=e,f=e.getEndPt(),p=(p+1)%r.length,n++}const _=e[s],m=e[p];if(_.isPeriodic()||e[p].isPeriodic()){const e=(_.isPeriodic()?_.getRange():m.getRange()).period;if(u.Util.isNearlyEqual(l,e,t.numberEps)){for(const t of h){r[t].getOrigin().add(new c.Vector2(e,0))}continue}}else if(this.isSphere()&&e[n].getLength()>t.lengthEps)for(const e of h){r[e].getOrigin().add(new c.Vector2(d.CONST.PI2,0))}else e[n].getLength()<t.lengthEps&&o.push(n)}}for(const e of o){const t=e-1<0?e-1+r.length:e-1,n=(e+1)%r.length,s=r[t].getEndPt(),i=r[n].getStartPt();r[e]=new l.Line2d(s,i)}return{loop:r,mapping:n}}getCurve2d(e){return e instanceof o.Line3d?this._line3dToUV(e):e instanceof a.Arc3d&&e.getNormal().isParallel(this.getCoord().getDz())?this._arc3dToUV(e):super.getCurve2d(e)}containsCurve(e,t=i.Tolerance.LENGTH_EPS){if(e.isLine3d()||e.isArc3d()||e.isNurbsCurve3d())return this._containsBaseCurve(e);if(e instanceof g.OffsetCurve3d){const n=e.getBaseCurve();return n instanceof h.NurbsCurve3d&&void 0!==n.getCoincideLine()&&(this.containsPoint(e.getStartPt(),t)&&this.containsPoint(e.getEndPt(),t))}if(e instanceof f.ExtendCurve3d){const t=e.getBaseCurve();return!!(t.getRange().containsInterval(e.getRange())||e.getRange().max<=t.getRange().min||e.getRange().min>=t.getRange().max)&&this._containsBaseCurve(t)}return!1}_line3dToUV(e){const t=this.getUVAt(e.getStartPt()),n=new c.Vector2(t.x,this.getUVAt(e.getEndPt()).y);return t.equals(n)?new l.Line2d(t,c.Vector2.X(),[0,0]):new l.Line2d(t,n)}_arc3dToUV(e){const t=this.getUVAt(e.getStartPt()),n=e.getCoord().getDz().isParallel(this._coord.getDz()),r=e.getCoord().getDz().dot(this._coord.getDz())>0,s=e.getRange().getLength();let o=r?t.x+s:t.x-s,a=t.y;if(!n){const n=this.getUVAt(e.getEndPt());a=n.y,this.isEqualAB()||(r&&n.x<t.x?o+=d.CONST.PI2:!r&&n.x>t.x&&(o-=d.CONST.PI2))}const h=2*i.Tolerance.LENGTH_EPS/(this._a+this._b);u.Util.isNearlySmaller(o,0,h)&&t.x<h&&(t.x+=d.CONST.PI2,o+=d.CONST.PI2),u.Util.isNearlyBigger(o,d.CONST.PI2,h)&&t.x>d.CONST.PI2+h&&(t.x-=d.CONST.PI2,o-=d.CONST.PI2);const g=new c.Vector2(o,a);return new l.Line2d(t,g)}}t.CircularSurface=p},24013:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Cone=void 0;const o=n(89494),a=n(33218),c=n(61226),l=n(87222),d=n(49246),u=n(97505),h=n(13982),g=n(60229),f=n(97602),p=n(56973),_=n(49509),m=n(26773),v=n(6688),E=n(43640),P=n(61210),y=n(737);let C=r=class extends _.CircularSurface{constructor(e,t,n,r){super(),void 0!==t&&void 0!==n&&void 0!==r&&e&&(this._a=t,this._b=n,this._h=r,this._coord=e.clone())}static makeConeByArc3ds(e,t){const n=e.getCenter().subtract(t.getCenter());if(!t.getNormal().isParallel(e.getNormal())||n.isZero()||!n.isParallel(e.getNormal()))return;if(e.isEqualAB()&&t.isEqualAB()){const s=n.getLength(),i=e.getCoord(),a=e.getRadius(),c=t.getRadius();if(d.Util.isNearlyEqual(a,c))return;if(c<a){return new r(i,a,a,s/(a-c)*a)}const l=s/(c-a)*a,u=new o.Coordinate3(i.getOrigin(),i.getDx(),i.getDy().multiply(-1));return new r(u,a,a,l)}const s=e.getA(),i=e.getB(),a=t.getA(),c=t.getB(),l=e.getCoord(),u=t.getCoord();if(l.getDx().isParallel(u.getDx())){const e=s/i,t=a/c;if(d.Util.isNearlyEqual(s,a)||Math.abs(e-t)>p.Tolerance.LENGTH_EPS)return;const u=n.getLength();if(a<s){return new r(l,s,i,u/(s-a)*s)}const h=u/(a-s)*s,g=new o.Coordinate3(l.getOrigin(),l.getDx(),l.getDy().multiply(-1));return new r(g,s,i,h)}if(l.getDx().isParallel(u.getDy())){const e=s/i,t=c/a;if(d.Util.isNearlyEqual(s,c)||Math.abs(e-t)>p.Tolerance.LENGTH_EPS)return;const u=n.getLength();if(c<s){return new r(l,s,i,u/(s-c)*s)}const h=u/(c-s)*s,g=new o.Coordinate3(l.getOrigin(),l.getDx(),l.getDy().multiply(-1));return new r(g,s,i,h)}}getH(){return this._h}setH(e){this._h=e}getCenterAxis(){return this._coord.getDz()}getApexPoint(){return this._coord.getWorldPtAt({x:0,y:0,z:this._h})}getSemiAngleA(){return Math.atan2(this._a,this._h)}getSemiAngleB(){return Math.atan2(this._b,this._h)}getDomainU(){return new m.PeriodInterval(0,g.CONST.PI2)}getDomainV(){return new v.Interval(-g.CONST.MODEL_MAX_LENGTH,this._h)}getPtAt(e){const t=1-e.y/this._h,n={x:this._a*Math.cos(e.x)*t,y:this._b*Math.sin(e.x)*t,z:e.y};return this._coord.getWorldPtAt(n)}getNormAt(e){const t=Math.sin(e.x),n=Math.cos(e.x),r=new c.Vector3(-this._a*t,this._b*n,0),s=new c.Vector3(-this._a*n,-this._b*t,this._h),i=r.cross(s);return this._coord.getWorldVectorAt(i).normalize()}getSingularPoints(){return[this.getApexPoint()]}getDerivatives(e,t=1){const n=[],r=this._a,s=this._b,i=Math.cos(e.x),o=Math.sin(e.x),a=r*i,l=s*o,d=1-e.y/this._h,u={x:a*d,y:l*d,z:e.y},h=this._coord.getWorldPtAt(u);if(n.push(h),t<=0)return n;const g=new c.Vector3(-r*o,s*i,0),f=this._coord.getWorldVectorAt(g);n.push(f.multiplied(d));const p={x:-a/this._h,y:-l/this._h,z:1};if(n.push(this._coord.getWorldVectorAt(p)),t<=1)return n;const _=new c.Vector3(-a,-l,0),m=this._coord.getWorldVectorAt(_);if(n.push(m.multiplied(d)),n.push(f.multiplied(-1/this._h)),n.push(new c.Vector3(0,0,0)),t<=2)return n;const v=new c.Vector3(r*o,-s*i,0),E=this._coord.getWorldVectorAt(v);if(n.push(E.multiply(d)),n.push(m.multiply(-1/this._h)),n.push(c.Vector3.O()),n.push(c.Vector3.O()),t<=3)return n;const P=new c.Vector3(r*i,s*o,0),y=this._coord.getWorldVectorAt(P);if(n.push(y.multiply(d)),n.push(E.multiply(-1/this._h)),n.push(c.Vector3.O()),n.push(c.Vector3.O()),n.push(c.Vector3.O()),t<=4)return n;throw new Error("n > 4高阶导数计算未实现！")}getUVAt(e){const t=this._coord.getLocalPtAt(e);if(d.Util.isNearlyEqual(0,t.x)&&d.Util.isNearlyEqual(0,t.y))return new a.Vector2(0,t.z);const n=Math.atan2(t.y/this._b,t.x/this._a);return new a.Vector2(m.PeriodInterval.RegularizeParam(n,g.CONST.PI2),t.z)}isRuled(){return!0}isCoplanar(e,t=new p.Tolerance){if(!e.isCone())return!1;const n=e;if(!t.areNear(this.getApexPoint(),n.getApexPoint())||!t.areParralel(this.getCoord().getDz(),n.getCoord().getDz()))return!1;const r=this.getSemiAngleA(),s=this.getSemiAngleB(),i=n.getSemiAngleA(),o=n.getSemiAngleB();return t.areParralel(this.getCoord().getDx(),n.getCoord().getDx())&&t.areAnglesEqual(r,i)&&t.areAnglesEqual(s,o)||t.areParralel(this.getCoord().getDx(),n.getCoord().getDy())&&t.areAnglesEqual(r,o)&&t.areAnglesEqual(s,i)||t.areAnglesEqual(r,r)&&t.areAnglesEqual(i,o)&&t.areAnglesEqual(r,o)}containsCurve(e,t=p.Tolerance.NUMBER_EPS){if(e instanceof l.Line3d){const n=e.getStartPt(),r=this.getUVAt(n);if(this.getPtAt(r).sqDistanceTo(n)>t*t)return!1;const s=e.getEndPt(),i=this.getUVAt(s);return!(this.getPtAt(i).sqDistanceTo(s)>t*t)&&m.PeriodInterval.areEqual(i.x,r.x,g.CONST.PI2,t)}if(e instanceof f.Arc3d){const t=e;return this.containsPoint(t.getPtAt(0))&&this.containsPoint(t.getPtAt(g.CONST.PI_2))&&this.containsPoint(t.getPtAt(g.CONST.PI2))&&this.containsPoint(t.getPtAt(1.5*g.CONST.PI))}return!1}getIsoCurve(e,t){if(t){const t=1-e/this._h,n=this._coord.translated(this._coord.getDz().multiply(e));return new f.Arc3d(n,this._a*t,this._b*t,[0,g.CONST.PI2])}const n=this.getApexPoint(),r=this.getPtAt(new a.Vector2(e,0)),s=new l.Line3d(r,n);return s.getRange().min=-g.CONST.MODEL_MAX_LENGTH,s}getCurve3d(e){if(e.getType()===u.EN_GEO_ELEMENT_TYPE.EN_LINE_2D){const t=e,n=t.getStartPt(),r=t.getEndPt(),s=t.getDirection();if(s.isParallel(a.Vector2.X())){const e=(n.y+r.y)/2;if(d.Util.isNearlyEqual(e,this._h,p.Tolerance.LENGTH_EPS))return new l.Line3d(this.getApexPoint(),this._coord.getDz(),[0,0]);{const t=this._coord.translated(this._coord.getDz().multiply(e)),i=1-e/this._h;return s.isSameDirection(a.Vector2.X())?new f.Arc3d(t,this._a*i,this._b*i,[n.x,r.x]):(t.setDy(t.getDy().multiply(-1)),new f.Arc3d(t,this._a*i,this._b*i,[-n.x,-r.x]))}}if(s.isParallel(a.Vector2.Y()))return new l.Line3d(this.getPtAt(n),this.getPtAt(r))}return super.getCurve3d(e)}transform(e,t){const n=this._coord.getLocalToWorldMatrix().preMultiplied(e),r=t||P.Matrix4.make(e,!1).decompose(),s=n.decompose();if(P.Matrix4.assertScaleEqual(r.scale),P.Matrix4.assertScaleEqual(r.scale)){const t=this._coord.getWorldPtAt(new c.Vector3(this._a,this._b,this._h));this._coord.transform(e);const n=this._coord.getLocalPtAt(t.transform(e));return this._a=n.x,this._b=n.y,this._h=n.z,P.Matrix4.isSvdMirror(r)&&(this._coord.setDy(this._coord.getDy().multiply(-1)),this._h=-this._h),this}this._b*=s.scale.x,this._h*=s.scale.y,this._a*=s.scale.z;const i=c.Vector3.O().transformed(s.uTransform).transformed(s.vRotate),a=c.Vector3.X().vecTransformed(s.uTransform).vecTransformed(s.vRotate),l=c.Vector3.Y().vecTransformed(s.uTransform).vecTransformed(s.vRotate),d=new o.Coordinate3(i,a.normalized(),l.normalized());return this._coord=d,this}transformed(e){const t=this._coord.getOrigin().transformed(e),n=this._coord.getDx().multiply(this._a).vecTransform(e),s=this._coord.getDy().multiply(this._b).vecTransform(e),i=this._coord.getDz().multiply(this._h).vecTransform(e),a=i.normalized();if(a.isPerpendicular(n)&&a.isPerpendicular(s)){let e,c;if(n.normalized().isPerpendicular(s.normalized()))e=n,c=s;else{const t=.5*Math.atan2(2*n.dot(s),n.getSqLength()-s.getSqLength()),r=Math.sin(t),i=Math.cos(t);e=n.multiplied(i).add(s.multiplied(r)),c=n.multiplied(-r).add(s.multiplied(i))}n.cross(s).dot(a)<0&&c.multiply(-1);const l=e.getLength(),d=c.getLength(),u=i.getLength(),h=new o.Coordinate3(t,e,c);return new r(h,l,d,u)}const c=this.toNurbs();return c.transform(e),c}clone(){return super.clone()}toNurbs(e,t=2,n=1,r=p.Tolerance.LENGTH_EPS){const s=this.getIsoCurve(-1e3,!0),i=s.getCenter(),o=s.getCoord().getDx().multiply(s.getA()),a=s.getCoord().getDy().multiply(s.getB()),c=[i.added(o),i.added(o).added(a),i.added(a).subtracted(o),i.subtracted(o),i.subtracted(o).subtracted(a),i.subtracted(a).added(o),i.added(o)],l=[];for(const e of c){const t=[],r=1/n;for(let s=0;s<=n;s++){const n=e.multiplied(r*(1-s)).add(this.getApexPoint().multiplied(r*s));t.push(n)}l.push(t)}const d=[1,.5,.5,1,.5,.5,1],u=[];for(const e of d)u.push([e,e]);const h=y.NurbsSurface.makeByKnotsControlPointsWeights(2,1,[0,0,0,.25,.5,.5,.75,1,1,1],[0,0,1,1],l,u);return h.addSingularPoints([{pt:this.getApexPoint(),param:1,uvSign:1}]),h}getType(){return u.EN_GEO_ELEMENT_TYPE.EN_CONE}tessellate(e,t=E.DiscreteParameter.NORMAL,n=p.Tolerance.DEFAULT){const r=this.discrete(t,n),s=this.getDomainU();s.min=Math.max(s.min,-1e3),s.max=Math.min(s.max,1e3);const i=this.getDomainV();i.min=Math.max(i.min,-1e3),i.max=Math.min(i.max,1e3);const o=Math.sqrt(this._a*this._a+this._h*this._h)/this._h,a=new v.Interval(i.min*o,i.max*o),c=this.getIsoCurve(i.min,!0);c.setRange(s);const l=this.getIsoCurve(s.max,!1);l.setRange(a);const d=this.getIsoCurve(i.max,!0);d.setRange(s),d.reverse();const u=this.getIsoCurve(s.min,!1);u.setRange(a),u.reverse();const h=[c,l,d,u];return{debugInfo:{name:this.constructor.name,visible:!0},mesh:r,children:e?[{debugInfo:{name:"虚轮廓线",visible:!0},children:h.map((n=>n.tessellate(e,t))).flat()}]:[]}}dump(){return{type:this.getType(),data:[this._coord.dump(),this._a,this._b,this._h]}}load({data:[e,t,n,r]}){return this._coord.load(e),this._a=t,this._b=n,this._h=r,this}};C=r=s([h.registerLoader,i("design:paramtypes",[o.Coordinate3,Number,Number,Number])],C),t.Cone=C},46182:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoordinateBasedSurface=void 0;const r=n(97935),s=n(89494),i=n(61210);class o extends r.Surface{constructor(){super(...arguments),this._coord=new s.Coordinate3}getCoord(){return this._coord}setCoord(e){this._coord=e.clone()}translate(e){return this._coord.translate(e),this}rotate(e,t,n={x:0,y:0,z:1}){const r=i.Matrix4.makeRotate(t,n,e);return this._coord.transform(r),this}}t.CoordinateBasedSurface=o},94905:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Curve=void 0;const r=n(60229),s=n(6688),i=n(43640),o=n(56973),a=n(14571),c=n(26773),l=n(28982),d=n(44757),u=n(27316),h=n(22522),g=n(4097);class f extends l.GeoElement{constructor(){super(),this._range=s.Interval.infinit()}getAllFootParams(e,t=o.Tolerance.LENGTH_EPS){return d.MathAssert.warn(!1,`${this.constructor.name}.getAllFootParams() not supported yet`),[this.getParamAt(e)]}getParamNearT(e,t,n=o.Tolerance.LENGTH_EPS,s=o.Tolerance.ANGLE_EPS,i){const a=n/this.getDerivatives(t,1)[1].getLength(),l=Math.sin(s),d=n*n;let u=!1,h=t;this._range instanceof c.PeriodInterval||(h=this.getDomain().clamp(h));let g=0;for(;g<r.CONST.NORMAL_ITER_NUM;g++){const t=this.getDerivatives(h,2),n=t[0].subtracted(e),r=n.dot(t[1]);if(n.getSqLength()<d||Math.abs(r)<l){u=!0;break}const s=t[1].dot(t[1])+t[2].dot(t[0].subtracted(e));if(0===s){u=!1;break}const i=r/s;if(h-=i,this._range instanceof c.PeriodInterval||(h=this.getDomain().clamp(h)),Math.abs(i)<a||g>40){const t=this.getDerivatives(h,1),n=t[0].subtracted(e),r=n.dot(t[1]);u=n.getSqLength()<d||Math.abs(r)<l;break}}if(u){if(!i)return h;if(Math.abs(h-t)<i)return h;const e=this.getRange();if(e instanceof c.PeriodInterval){const n=e.getRegularParam(h);if(Math.abs(n-t)<i)return n;if(Math.abs(n-e.period-t)<i)return n-e.period;if(Math.abs(n+e.period-t)<i)return n+e.period}}const f=this.getAllFootParams(e);if(f.length>0){let e=f[0],n=Math.abs(e-t);for(let r=1;r<f.length;r++){const s=Math.abs(f[r]-t);s<n&&(n=s,e=f[r])}return e}return this.getParamAt(e)}isPeriodic(){return this._range instanceof c.PeriodInterval}isLineLike(){return!1}reversed(){return this.clone().reverse()}getStartPt(){const e=this.getStartParam();return this.getPtAt(e)}getEndPt(){const e=this.getEndParam();return this.getPtAt(e)}getMidPt(){return this.getPtAt(this.getRange().getMid())}getLength(e){if(this.isSmoothPoly2d()||this.getSingularities().length>0){const t=u.DiscreteCurve.general((e=>this.getPtAt(e)),(e=>this.getTangentAt(e)),(e||this._range).toArray(),this.getSingularities(),i.DiscreteParameter.HIGH);let n=0;for(let e=1;e<t.length;e++)n+=t[e-1].point.subtract(t[e].point).getLength();return n}const t=e||this.getRange();return h.gaussIntegration((e=>{const t=this.getDerivatives(e,1);return Math.sqrt(t[1].dot(t[1]))}),t.min,t.max,1e-6,1e-6)}discrete(e=i.DiscreteParameter.NORMAL){return[this.getStartPt(),this.getEndPt()]}tessellate(e,t=i.DiscreteParameter.NORMAL){const n=this.discrete(t);return this._tessellateByPoints(n,this.constructor.name,e)}getAnotherEndPt(e,t=o.Tolerance.LENGTH_EPS){return this.isStartPt(e,t)?this.getEndPt():this.getStartPt()}getDomain(){return s.Interval.infinit()}getStartParam(){return this.getRange().min}getEndParam(){return this.getRange().max}getStartTangent(){return this.getTangentAt(this.getStartParam(),!1)}getEndTangent(){return this.getTangentAt(this.getEndParam(),!0)}getMidTangent(){return this.getTangentAt(this.getRange().getMid())}getTangentAt(e,t){const n=this._getSnapToPrevious(e,t),r=o.Tolerance.LENGTH_EPS2,s=this.getDerivatives(e,1,n)[1];{const e=s.getSqLength();if(e>r){return s.multiply(1/Math.sqrt(e))}}let i=o.Tolerance.NUMBER_EPS;const a=n?1:-1,l=this.getPtAt(e),u=this.getDomain();for(;;){const t=e-i*a;if(!u.containsPoint(t))break;const s=this.getPtAt(t),o=l.subtracted(s),d=o.getSqLength();if(d>r){const t=o.multiply(a/Math.sqrt(d));return this._refineDegerateTangent(e,n,t)}if(i*=10,u instanceof c.PeriodInterval&&u.period<i)break}return d.MathAssert.warn(!1,"Curve failed to get tangent"),s}getSingularities(){return[]}isStartPt(e,t=o.Tolerance.LENGTH_EPS){return this.getStartPt().equals(e,t)}isEndPt(e,t=o.Tolerance.LENGTH_EPS){return this.getEndPt().equals(e,t)}containsProjectedPt(e,t=o.Tolerance.LENGTH_EPS){const n=this.getParamAt(e);return this._range.containsPoint(n)}containsPoint(e,t=o.Tolerance.LENGTH_EPS){const n=t*t;if(this.getStartPt().sqDistanceTo(e)<n||this.getEndPt().sqDistanceTo(e)<n)return!0;const r=this.getParamAt(e);return!(this.getPtAt(r).sqDistanceTo(e)>n)&&this._range.containsPoint(r,t)}getProjectedPtBy(e){const t=this.getParamAt(e);return this.getPtAt(t)}getFootByIterate(e,t,n=o.Tolerance.LENGTH_EPS,s=o.Tolerance.ANGLE_EPS,i=!0){let a=0,l=void 0!==t?t:this._range.getMid(),d=this.getDerivatives(l,2),u=d[0].subtracted(e);const h=Math.sin(s),g=.01*n,f=g*g,p=(this._range instanceof c.PeriodInterval?this._range.period:this.getDomain().getLength())/4;do{const t=u.dot(d[1]),n=d[1].dot(d[1])+u.dot(d[2]);if(Math.abs(n)<f)break;let r=t/n;Math.abs(r)>p&&(r=p*Math.sign(r));l=l-r,i&&(l=this.getDomain().clamp(l));const s=d[0];if(d=this.getDerivatives(l,2),u=d[0].subtracted(e),s.sqDistanceTo(d[0])<f)break;a++}while(a<r.CONST.NORMAL_ITER_NUM);if(u.isZero(n)||Math.abs(d[1].normalized().dot(u.normalized()))<h)return l}getFootByDichotomy(e,t,n,s=o.Tolerance.LENGTH_EPS,i=o.Tolerance.ANGLE_EPS,a=!0){const l=Math.sin(i),d=.01*s,u=d*d,h=(this._range instanceof c.PeriodInterval?this._range.period:this.getDomain().getLength())/4;let g;const f=this.getPtAt(t).subtracted(e);let p=this.getTangentAt(t).dot(f);const _=this.getPtAt(n).subtracted(e);let m=this.getTangentAt(n).dot(_);if(p*m<0){let r=t,s=n;for(let t=0;t<8;t++){g=(r+s)/2;const t=this.getPtAt(g).subtracted(e);if(t.getSqLength()<u)return g;const n=this.getTangentAt(g).dot(t);if(Math.abs(n)<l)return g;p*n<0?(m=n,s=g):m*n<0&&(p=n,r=g)}g=(r+s)/2}else g=(t+n)/2;let v=this.getDerivatives(g,2),E=v[0].subtracted(e),P=0;do{const t=E.dot(v[1]),n=v[1].dot(v[1])+E.dot(v[2]);if(Math.abs(n)<u)break;let r=t/n;Math.abs(r)>h&&(r=h*Math.sign(r));g=g-r,a&&(g=this.getDomain().clamp(g));const s=v[0];if(v=this.getDerivatives(g,2),E=v[0].subtracted(e),s.sqDistanceTo(v[0])<u)break;P++}while(P<r.CONST.NORMAL_ITER_NUM);if(E.isZero(s)||Math.abs(v[1].normalized().dot(E.normalized()))<l)return g}extend(e,t=!0){return t?this._range.max+=e:this._range.min-=e,this}extendDouble(e){return this._range.max+=e,this._range.min-=e,this}getRange(){return this._range}setRange(e,t){return"number"==typeof e&&void 0!==t?this._range.set(e,t):e instanceof s.Interval&&this._range.set(e.min,e.max),this}setRangeInfinit(e){if(this._range instanceof c.PeriodInterval)this._range.min=e||0,this._range.max=this._range.min+this._range.period;else{const t=this.getDomain();this._range.set(void 0!==e?e:t.min,t.max)}}setRangeMaxInfinit(){this._range instanceof c.PeriodInterval?this._range.max=this._range.min+this._range.period:this._range.max=this.getDomain().max}setRangeMinInfinit(){this._range instanceof c.PeriodInterval?this._range.min=this._range.max+this._range.period:this._range.min=this.getDomain().min}equals(e,t=o.Tolerance.LENGTH_EPS){return this.getType()!==e.getType()?0:this.getMidPt().equals(e.getMidPt(),t)?this.getStartPt().equals(e.getStartPt(),t)&&this.getEndPt().equals(e.getEndPt(),t)?1:this.getStartPt().equals(e.getEndPt(),t)&&this.getEndPt().equals(e.getStartPt(),t)?-1:0:0}clone(){return super.clone()}discreteBySegmentCount(e){const t=Math.ceil(e),n=(this._range.max-this._range.min)/t,r=[];for(let e=0;e<=t;e++)r.push(this.getPtAt(e*n+this._range.min));return r}getInterpPts(e){const t=[],n=[];let r=this._range.min;for(;r<=this._range.max;){const e=this.getDerivatives(r,2);let s;t.push(r),n.push(e[0]);const i=.15,o=e[1].getSqLength()/e[2].getLength();if(o>10){s=o*i*(1/Math.log10(o))}else o>.1?s=o*i:o>1e-4?s=o:(g.MathError.warn("拟合的曲线自交！！"),s=100*o);r=r+s/e[1].getLength()}return t.push(this._range.max),n.push(this.getPtAt(this._range.max)),{params:t,pts:n}}_tessellateByPoints(e,t,n){const r=[];for(let t=0;t<e.length-1;t++)r.push([e[t].toArray3(),e[t+1].toArray3()]);const s={edges:r};if(n){s.debugInfo={name:t,visible:!0};const e=a.discreteArrow(this.getMidPt(),this.getTangentAt((this._range.min+this._range.max)/2),.02*this.getLength());r.push(e)}return s}_getSnapToPrevious(e,t){return void 0===t?Math.abs(e-this._range.min)>o.Tolerance.CALCULATE_EPS:t}_refineDegerateTangent(e,t,n){return n}}t.Curve=f},68990:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Curve2d=void 0;const r=n(90361),s=n(94905),i=n(26581),o=n(43640),a=n(44757),c=n(77160),l=n(27316);class d extends s.Curve{getBox(e){return this.getBoundingBox(e)}getBoundingBox(e){const{min:t,max:n}=this._range;e&&this.setRange(e);const s=this.getSingularities(),i=this._range.splited(...s),d=new r.Box2;for(const e of i){const t=l.DiscreteCurve.execute(this.setRange(e),o.DiscreteParameter.LOW),n=[];for(let e=0;e<t.length;e++)n.push(this.getTangentAt(t[e].param,0!==e));d.expandByPoint(t[0].point);for(let e=1;e<t.length;e++){if(d.expandByPoint(t[e].point),n[e].isParallel(n[e-1]))continue;const r=c.LineLineIntersectUtil.line2dsParamed(t[e-1].point,t[e].point,n[e-1],n[e]);if(r[0]>0&&r[1]<0){const s=t[e-1].point.add(n[e-1].multiply(r[0]));d.expandByPoint(s)}else a.MathAssert.warn(!1,"曲率拐点未处理")}}return this.setRange(t,n),d}split(e,t){return this._range.splited(...e).map((e=>{const t=this.clone();return t.setRange(e),t}))}translate(e){const t=i.Matrix3.makeTranslate(e);return this.transform(t)}rotate(e,t={x:0,y:0}){const n=i.Matrix3.makeRotate(t,e);return this.transform(n)}scale(e,t={x:0,y:0}){const n=i.Matrix3.makeScale(t,e);return this.transform(n)}transformed(e,t){return this.clone().transform(e,t)}reversed(){return this.clone().reverse()}clone(){return super.clone()}}t.Curve2d=d},2111:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Curve3d=void 0;const r=n(94905),s=n(67996),i=n(61210),o=n(43640),a=n(27316),c=n(44757),l=n(6148);class d extends r.Curve{getBox(e){return this.getBoundingBox(e)}getBoundingBox(e){const{min:t,max:n}=this._range;e&&this.setRange(e);const r=this.getSingularities(),i=this._range.splited(...r),d=new s.Box3;for(const e of i){const t=a.DiscreteCurve.execute(this.setRange(e),o.DiscreteParameter.LOW),n=[];for(let e=0;e<t.length;e++)n.push(this.getTangentAt(t[e].param,0!==e));d.expandByPoint(t[0].point);for(let e=1;e<t.length;e++){if(d.expandByPoint(t[e].point),n[e].isParallel(n[e-1]))continue;const r=l.Line3dToLine3dDistanceParamed.execute(t[e-1].point,t[e].point,n[e-1],n[e]);r[0]>0&&r[1]<0?d.expandByPoint(t[e-1].point.add(n[e-1].multiply(r[0]))):c.MathAssert.mutedWarn(!1,"曲率拐点未处理")}}return this.setRange(t,n),d}translate(e){const t=i.Matrix4.makeTranslate(e);return this.transform(t)}rotate(e,t,n){const r=n||{x:0,y:0,z:1},s=i.Matrix4.makeRotate(t,r,e);return this.transform(s)}scale(e,t){const n=i.Matrix4.makeScale(t,e);return this.transform(n)}transformed(e,t){return this.clone().transform(e,t)}isPlaneCurve3d(e){return!1}split(e,t){return this._range.splited(...e).map((e=>{const t=this.clone();return t.setRange(e),t}))}reversed(){return this.clone().reverse()}clone(){return super.clone()}}t.Curve3d=d},29453:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Cylinder=void 0;const o=n(89494),a=n(33218),c=n(61226),l=n(44757),d=n(87222),u=n(97505),h=n(13982),g=n(97602),f=n(56973),p=n(26773),_=n(49509),m=n(60229),v=n(6688),E=n(79034),P=n(10909),y=n(737);let C=r=class extends _.CircularSurface{static makeCylinderByArc3d(e){return new r(e.getCoord(),e.getA(),e.getB())}constructor(e,t,n){super(),e&&void 0!==t&&(this._coord=e.clone(),this._a=t,this._b=void 0===n?t:n)}getRadius(){return l.MathAssert.assert(this.isEqualAB(f.Tolerance.NUMBER_CALCULATION_EPS),"椭圆柱调用了获取圆半径函数 getRadius()"),(this._a+this._b)/2}getCenterAxis(){return this._coord.getDz()}getPtAt(e){return this.getCoord().getWorldPtAt({x:this._a*Math.cos(e.x),y:this._b*Math.sin(e.x),z:e.y})}getNormAt(e){const t={x:this._b*Math.cos(e.x),y:this._a*Math.sin(e.x),z:0};return this._coord.getWorldVectorAt(t).normalize()}isRuled(){return!0}getDerivatives(e,t=1){const n=[],r=this._a,s=this._b,i=Math.cos(e.x),o=Math.sin(e.x),a=r*i,l=s*o,d=new c.Vector3(a,l,e.y);if(n.push(this._coord.getWorldPtAt(d)),t<=0)return n;const u=new c.Vector3(-r*o,s*i,0);if(n.push(this._coord.getWorldVectorAt(u)),n.push(this._coord.getDz()),t<=1)return n;const h=new c.Vector3(-a,-l,0);if(n.push(this._coord.getWorldVectorAt(h)),n.push(new c.Vector3(0,0,0)),n.push(new c.Vector3(0,0,0)),t<=2)return n;const g=new c.Vector3(r*o,-s*i,0);if(n.push(this._coord.getWorldVectorAt(g)),n.push(new c.Vector3(0,0,0)),n.push(new c.Vector3(0,0,0)),n.push(new c.Vector3(0,0,0)),t<=3)return n;const f=new c.Vector3(a,l,0);if(n.push(this._coord.getWorldVectorAt(f)),n.push(new c.Vector3(0,0,0)),n.push(new c.Vector3(0,0,0)),n.push(new c.Vector3(0,0,0)),n.push(new c.Vector3(0,0,0)),t<=4)return n;throw new Error("n > 4高阶导数计算未实现！")}getUVAt(e){const t=this._coord.getLocalPtAt(e),n=Math.atan2(t.y/this._b,t.x/this._a);return new a.Vector2(p.PeriodInterval.RegularizeParam(n),t.z)}isCoplanar(e,t=new f.Tolerance){if(!e.isCylinder())return!1;const n=e,r=this.getCoord(),s=n.getCoord(),i=new d.Line3d(r.getOrigin(),r.getDz(),v.Interval.infinitArray()),o=new d.Line3d(s.getOrigin(),s.getDz(),v.Interval.infinitArray());if(!E.CurveCurveColinear.lines(i,o,t))return!1;const a=this.getA(),c=this.getB(),l=n.getA(),u=n.getB();return Math.abs(a-c)<t.lengthEps?Math.abs(l-u)<t.lengthEps&&Math.abs(a+c-l-u)<2*t.lengthEps:Math.abs(a-l)<t.lengthEps?Math.abs(c-u)<t.lengthEps&&r.getDx().isParallel(s.getDx(),t.angleEps):Math.abs(a-u)<t.lengthEps&&(Math.abs(l-c)<t.lengthEps&&r.getDx().isPerpendicular(s.getDx(),t.angleEps))}containsCurve(e,t=f.Tolerance.NUMBER_EPS){if(e instanceof d.Line3d){const n=e.getStartPt(),r=this.getUVAt(n);if(this.getPtAt(r).sqDistanceTo(n)>t*t)return!1;const s=e.getEndPt(),i=this.getUVAt(s);return!(this.getPtAt(i).sqDistanceTo(s)>t*t)&&p.PeriodInterval.areEqual(r.x,i.x,m.CONST.PI2,t)}if(e instanceof g.Arc3d){const t=e;return this.containsPoint(t.getPtAt(0))&&this.containsPoint(t.getPtAt(m.CONST.PI_2))&&this.containsPoint(t.getPtAt(m.CONST.PI2))&&this.containsPoint(t.getPtAt(1.5*m.CONST.PI))}return!1}getDomainU(){return new p.PeriodInterval(0,m.CONST.PI2)}getIsoCurve(e,t){if(t){const t=this._coord.translated(this._coord.getDz().multiply(e));return new g.Arc3d(t,this._a,this._b,[0,m.CONST.PI2])}const n=this.getPtAt(new a.Vector2(e,0));return new d.Line3d(n,this.getCenterAxis(),v.Interval.infinitArray())}getCurve3d(e){if(e.getType()===u.EN_GEO_ELEMENT_TYPE.EN_LINE_2D){const t=e,n=t.getDirection(),r=t.getStartPt(),s=t.getEndPt();if(n.isParallel(a.Vector2.X())){const e=this._coord.getWorldPtAt({x:0,y:0,z:(r.y+s.y)/2}),t=this._coord.getDx(),i=this._coord.getDy();return n.x>0?new g.Arc3d(new o.Coordinate3(e,t,i),this._a,this._b,[r.x,s.x]):new g.Arc3d(new o.Coordinate3(e,t,i.multiply(-1)),this._a,this._b,[-r.x,-s.x])}if(n.isParallel(a.Vector2.Y()))return new d.Line3d(this.getPtAt(r),this.getPtAt(s))}return super.getCurve3d(e)}transform(e,t){const n=this._coord.getOrigin().transform(e),r=this._coord.getDx().multiply(this._a).vecTransform(e),s=this._coord.getDy().multiply(this._b).vecTransform(e),i=this._coord.getDz().vecTransform(e).normalized();let c,l;if(r.normalized().isPerpendicular(s.normalized()))c=r,l=s;else{const e=.5*Math.atan2(2*r.dot(s),r.getSqLength()-s.getSqLength()),t=Math.sin(e),n=Math.cos(e);c=r.multiplied(n).add(s.multiplied(t)),l=r.multiplied(-t).add(s.multiplied(n))}if(i.isPerpendicular(c)&&i.isPerpendicular(l))return r.cross(s).dot(i)<0&&l.multiply(-1),this._a=c.getLength(),this._b=l.getLength(),this._coord=new o.Coordinate3(n,c,l),this;const d=new o.Coordinate3(n,c,l),u=c.getLength(),h=l.getLength(),f=new g.Arc3d(d,u,h),p=new o.Coordinate3(n,i),_=[f.getPtAt(0),f.getPtAt(m.CONST.PI_4),f.getPtAt(m.CONST.PI_2)].map((e=>p.getLocalPtAt(e))),v=P.Arc2d.makeEllipseByCenterAndThreePoints(a.Vector2.O(),_);if(!v)throw new Error("");const E=p.getWorldVectorAt(v.getCoord().getDx()),y=p.getWorldVectorAt(v.getCoord().getDy());return this._coord=new o.Coordinate3(n,E,y),this._a=v.getA(),this._b=v.getB(),this}clone(){return super.clone()}getType(){return u.EN_GEO_ELEMENT_TYPE.EN_CYLINDER}toNurbs(e,t=2,n=1,r=f.Tolerance.LENGTH_EPS){const s=e=>{const t=e.getCenter(),n=e.getCoord().getDx().multiply(e.getA()),r=e.getCoord().getDy().multiply(e.getB());return[t.added(n),t.added(n).added(r),t.added(r).subtracted(n),t.subtracted(n),t.subtracted(n).subtracted(r),t.subtracted(r).added(n),t.added(n)]},i=e?e[1]:new v.Interval(-1e4,1e4),o=this.getIsoCurve(i.min,!0),a=this.getIsoCurve(i.max,!0),c=s(o),l=s(a),d=[];for(let e=0;e<c.length;e++){const t=[],r=1/n;for(let s=0;s<=n;s++){const n=c[e].multiplied(r*(1-s)).add(l[e].multiplied(r*s));t.push(n)}d.push(t)}const u=[1,.5,.5,1,.5,.5,1],h=[];for(const e of u)h.push([e,e]);return y.NurbsSurface.makeByKnotsControlPointsWeights(2,1,[0,0,0,.25,.5,.5,.75,1,1,1],[0,0,1,1],d,h)}dump(){return{type:this.getType(),data:[this._coord.dump(),this._a,this._b]}}load({data:[e,t,n]}){return this._coord.load(e),this._a=t,this._b=n,this}};C=r=s([h.registerLoader,i("design:paramtypes",[o.Coordinate3,Number,Number])],C),t.Cylinder=C},14571:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.discreteArrow=void 0;const r=n(33218),s=n(61226),i=n(60229);t.discreteArrow=function(e,t,n){const o=Math.max(n,.001);if(void 0===e.z){const n=new r.Vector2(e),s=new r.Vector2(t).normalize().reverse(),a=s.vecRotated(-i.CONST.PI_4),c=s.vecRotated(i.CONST.PI_4);return[a.multiply(o).add(n).toArray3(),n.toArray3(),c.multiply(o).add(n).toArray3()]}{const n=new s.Vector3(e),a=new s.Vector3(t).normalize().reverse();let c,l;return a.isParallel(s.Vector3.Z())?(c=s.Vector3.XY({x:-1,y:0},a.z).normalize(),l=s.Vector3.XY({x:1,y:0},a.z).normalize()):(c=s.Vector3.XY(new r.Vector2(a).vecRotate(-i.CONST.PI_4).toXY(),a.z),l=s.Vector3.XY(new r.Vector2(a).vecRotate(i.CONST.PI_4).toXY(),a.z)),[c.multiply(o).add(n).toArray3(),n.toArray3(),l.multiply(o).add(n).toArray3()]}}},24533:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ExtendCurve2d=void 0;const o=n(22283),a=n(6688),c=n(43640),l=n(60229),d=n(97505),u=n(13982),h=n(68990),g=n(32858),f=n(90361),p=n(56973),_=n(89009),m=n(48448);let v=r=class extends h.Curve2d{constructor(e,t=[-l.CONST.MODEL_MAX_LENGTH,l.CONST.MODEL_MAX_LENGTH]){super(),e&&(this._baseCurve=e,this.updateExtension(),this._range=new a.Interval(t[0],t[1]))}static makeByCurve(e,t=!0){const n=t?e.clone():e;return e instanceof g.Line2d?(n.getRange().setInfinit(),n):new r(n)}getBaseCurve(){return this._baseCurve}setBaseCurve(e){this._baseCurve=e,this.updateExtension()}getSingularities(){const e=this._baseCurve.getRange();return this._range.filterParams(e.toArray())}getHeadScale(){return this._head.scale}getTailScale(){return this._tail.scale}updateExtension(){const e=this._baseCurve.getRange(),t=this._baseCurve.getDerivatives(e.min,1,!1);{let n=t[1],r=n.getLength();r<p.Tolerance.LENGTH_EPS&&(n=this._baseCurve.getTangentAt(e.min,!1),r=1),this._head={curve:new g.Line2d(t[0],n,[-l.CONST.MODEL_MAX_LENGTH,0]),scale:r}}const n=this._baseCurve.getDerivatives(e.max,1,!0);{let t=n[1],r=t.getLength();r<p.Tolerance.LENGTH_EPS&&(t=this._baseCurve.getTangentAt(e.max,!0),r=1),this._tail={curve:new g.Line2d(n[0],t,[0,l.CONST.MODEL_MAX_LENGTH]),scale:r}}}isLineLike(){return this._baseCurve.isLineLike()}getPtAt(e){const t=this._getBase(e);return t.curve.getPtAt(t.param)}getParamAt(e){const t=_.PointToCurve2dDistance.execute(e,this._baseCurve),n=t.distance*t.distance,r=this._head.curve.getParamAt(e),s=this._head.curve.getPtAt(r).subtracted(e).getSqLength(),i=this._tail.curve.getParamAt(e),o=this._tail.curve.getPtAt(i).subtracted(e).getSqLength();return r<0&&s<=o?n<=s?t.param:r/this._head.scale+this._baseCurve.getRange().min:n<=o||i<=0?t.param:i/this._tail.scale+this._baseCurve.getRange().max}getAllFootParams(e,t=p.Tolerance.LENGTH_EPS){const n=this._baseCurve.getRange(),r=this._baseCurve.getAllFootParams(e).filter((e=>n.containsPoint(e))).sort(),s=this._head.curve.getParamAt(e),i=this._tail.curve.getParamAt(e),o=s/this._head.scale+this._baseCurve.getRange().min,a=i/this._tail.scale+this._baseCurve.getRange().max;return s<=t&&(0===r.length?r.push(o):Math.abs(o-r[0])*this._head.scale<t?r[0]=(o+r[0])/2:r.splice(0,0,o)),i>=-t&&(0===r.length?r.push(a):Math.abs(a-r[r.length-1])*this._tail.scale<t?r[r.length-1]=(a+r[r.length-1])/2:r.push(a)),r}getTangentAt(e,t){const n=this._getBase(e,t);return n.curve.getTangentAt(n.param,t)}getDerivatives(e,t,n){const r=this._getBase(e,n),s=r.curve.getDerivatives(r.param,t,n);for(let e=1;e<s.length;e++)s[e].multiply(r.scale);return s}getLength(e){const t=e||this._range,n=this._getBase(t.min),r=this._getBase(t.max);if(r.curve===this._head.curve||n.curve===this._tail.curve){const e=n.curve.getPtAt(n.param),t=r.curve.getPtAt(r.param);return e.subtract(t).getLength()}let s,i,o=0;return n.curve===this._head.curve?(o+=-n.param,s=this._baseCurve.getRange().min):s=t.min,r.curve===this._tail.curve?(o+=r.param,i=this._baseCurve.getRange().max):i=t.max,o+=this._baseCurve.getLength(new a.Interval(s,i)),o}toSimpleCurves(){const e=[],t=(this._range.min-this._baseCurve.getRange().min)*this._head.scale,n=(this._range.max-this._baseCurve.getRange().max)*this._tail.scale;let r,{min:s,max:i}=this._baseCurve.getRange();if(t<-p.Tolerance.EDGE_LENGTH_EPS){const n=this._head.curve;e.push(new g.Line2d(n.getOrigin(),n.getDirection(),[t,0])),s=this._baseCurve.getRange().min}else this._range.min>s&&(s=this._range.min);if(n>p.Tolerance.EDGE_LENGTH_EPS){const e=this._tail.curve;r=new g.Line2d(e.getOrigin(),e.getDirection(),[0,n])}else this._range.max<i&&(i=this._range.max);const o=this._baseCurve.clone();return s<i&&e.push(o.setRange(s,i)),r&&e.push(r),e}offset(e){throw new Error("not supported")}reverse(){const e=this._range.max-this._baseCurve.getRange().max,t=this._range.min-this._baseCurve.getRange().min;this._baseCurve.reverse(),this.updateExtension();const n=this._baseCurve.getRange();return this._range.set(n.min-e,n.max-t),this}transform(e,t){if(this._baseCurve.isLine3d())throw new Error("未实现的转换");return this._baseCurve.transform(e,t),this.updateExtension(),this}transformed(e,t){if(this._baseCurve.isLine3d())throw new Error("未实现的转换");const n=this._baseCurve.transformed(e,t),s=new r(n,this._range.toArray());if(!this._baseCurve.isOffsetCurve2d()||!n.isNurbsCurve2d())return s;const i=this._baseCurve.getRange(),o=n.getRange();if(this._range.min<i.min-p.Tolerance.NUMBER_EPS){const t=this.getPtAt(this._range.min).transformed(e),r=n.getStartPt(),i=n.getDerivatives(o.min,1),a=r.subtracted(t).getLength()/i[1].getLength(),c=o.min-a;s.getRange().min=c}if(this._range.max>i.max+p.Tolerance.NUMBER_EPS){const t=this.getPtAt(this._range.max).transformed(e),r=n.getEndPt(),i=n.getDerivatives(o.max,1),a=t.subtracted(r).getLength()/i[1].getLength(),c=o.max+a;s.getRange().max=c}return s}toNurbs(e=3,t=p.Tolerance.LENGTH_EPS){const n=this.getSingularities();n.sort();const r=this._range,s=r.clone(),i=[];let o=r;for(const e of n){const t=o.splited(e);i.push(t[0]),o=t[1]}i.push(o);const a=[];for(const n of i){this.setRange(n);const r=this.getInterpPts(t).pts,s=m.NurbsCurve2d.makeByInterpolationPoints(r,e);a.push(s)}if(this.setRange(s),1===a.length)return a[0];let c=[],l=[],d=[];for(const t of a)if(0===l.length)l=t.getControlPoints(),d=t.getWeights(),c=t.getKnots();else{c.pop(),l.pop(),d.pop(),l=l.concat(t.getControlPoints()),d=d.concat(t.getWeights());const n=c[c.length-1];for(let r=e+1;r<t.getKnots().length;r++)c.push(t.getKnots()[r]+n)}return m.NurbsCurve2d.makeByControlPoints(l,e,c,d)}getBoundingBox(e){const t=e||this._range,n=this._getBase(t.min),r=this._getBase(t.max),s=n.curve.getPtAt(n.param),i=r.curve.getPtAt(r.param);if(r.curve===this._head.curve||n.curve===this._tail.curve)return new f.Box2([s,i]);let o,a;const c=new f.Box2;n.curve===this._head.curve?(c.expandByPoint(s),o=this._baseCurve.getRange().min):o=t.min,r.curve===this._tail.curve?(c.expandByPoint(i),a=this._baseCurve.getRange().max):a=t.max;const l=this._baseCurve.getRange().clone();return this._baseCurve.setRange(o,a),c.union(this._baseCurve.getBoundingBox()),this._baseCurve.setRange(l),c}discrete(e=c.DiscreteParameter.NORMAL){const t=this._range,n=this._getBase(t.min),r=this._getBase(t.max),s=n.curve.getPtAt(n.param),i=r.curve.getPtAt(r.param);if(r.curve===this._head.curve||n.curve===this._tail.curve)return[s,i];let o,a;const l=[];let d,u=!1,h=!1;n.curve===this._head.curve?(l.push(s),o=this._baseCurve.getRange().min,d=1,u=o-this._range.min<p.Tolerance.EDGE_LENGTH_EPS):(o=t.min,d=0),r.curve===this._tail.curve?(l.push(i),a=this._baseCurve.getRange().max,h=this._range.max-a<p.Tolerance.EDGE_LENGTH_EPS):a=t.max;const g=this._baseCurve.getRange().clone();this._baseCurve.setRange(o,a);const f=this._baseCurve.discrete(e);return u&&f.shift(),h&&f.pop(),l.splice(d,0,...f),this._baseCurve.setRange(g),l}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_EXTEND_CURVE_2D}clone(){return new r(this._baseCurve.clone(),this._range.toArray())}dump(){return{type:this.getType(),data:[this._baseCurve.dump(),this._range.toArray()]}}load({data:[e,t]}){return this._baseCurve=o.Loader.load(e),this.updateExtension(),this._range=new a.Interval(t[0],t[1]),this}_getBase(e,t=!0){const n=this._baseCurve.getRange(),r=t?p.Tolerance.CALCULATE_EPS:-p.Tolerance.CALCULATE_EPS;if(e<n.min+r){const t=this._head;return{curve:t.curve,param:(e-n.min)*t.scale,scale:t.scale}}if(e>n.max+r){const t=this._tail;return{curve:t.curve,param:(e-n.max)*t.scale,scale:t.scale}}return{curve:this._baseCurve,param:e,scale:1}}};v=r=s([u.registerLoader,i("design:paramtypes",[h.Curve2d,Array])],v),t.ExtendCurve2d=v},9327:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ExtendCurve3d=void 0;const o=n(22283),a=n(6688),c=n(43640),l=n(60229),d=n(97505),u=n(13982),h=n(2111),g=n(87222),f=n(67996),p=n(56973),_=n(68956),m=n(93145);let v=r=class extends h.Curve3d{constructor(e,t=[-l.CONST.MODEL_MAX_LENGTH,l.CONST.MODEL_MAX_LENGTH]){super(),e&&(this._baseCurve=e,this.updateExtension(),this._range=new a.Interval(t[0],t[1]))}static makeByCurve(e,t=!0){const n=t?e.clone():e;return n instanceof g.Line3d||n instanceof r?(n.getRange().setInfinit(),n):new r(n)}getBaseCurve(){return this._baseCurve}getSingularities(){const e=this._baseCurve.getRange();return this._range.filterParams(e.toArray())}getHeadScale(){return this._head.scale}getTailScale(){return this._tail.scale}setBaseCurve(e){this._baseCurve=e,this.updateExtension()}getStartLine(){return this._head.curve}getEndLine(){return this._tail.curve}updateExtension(){const e=this._baseCurve.getRange(),t=this._baseCurve.getDerivatives(e.min,1,!1);{let n=t[1],r=n.getLength();r<p.Tolerance.LENGTH_EPS&&(n=this._baseCurve.getTangentAt(e.min,!1),r=1),this._head={curve:new g.Line3d(t[0],n,[-l.CONST.MODEL_MAX_LENGTH,0]),scale:r}}const n=this._baseCurve.getDerivatives(e.max,1,!0);{let t=n[1],r=t.getLength();r<p.Tolerance.LENGTH_EPS&&(t=this._baseCurve.getTangentAt(e.max,!0),r=1),this._tail={curve:new g.Line3d(n[0],t,[0,l.CONST.MODEL_MAX_LENGTH]),scale:r}}}isLineLike(){return this._baseCurve.isLineLike()}getPtAt(e){const t=this._getBase(e);return t.curve.getPtAt(t.param)}getParamAt(e){const t=_.PointToCurve3dDistance.execute(e,this._baseCurve),n=t.distance*t.distance,r=this._head.curve.getParamAt(e),s=this._head.curve.getPtAt(r).subtracted(e).getSqLength(),i=this._tail.curve.getParamAt(e),o=this._tail.curve.getPtAt(i).subtracted(e).getSqLength();return r<0&&s<=o?n<=s?t.param:r/this._head.scale+this._baseCurve.getRange().min:n<=o||i<=0?t.param:i/this._tail.scale+this._baseCurve.getRange().max}isPlaneCurve3d(e=p.Tolerance.ANGLE_EPS){return this.getBaseCurve().isPlaneCurve3d(e)}getAllFootParams(e,t=p.Tolerance.LENGTH_EPS){const n=this._baseCurve.getRange(),r=this._baseCurve.getAllFootParams(e).filter((e=>n.containsPoint(e))).sort(),s=this._head.curve.getParamAt(e),i=this._tail.curve.getParamAt(e),o=s/this._head.scale+this._baseCurve.getRange().min,a=i/this._tail.scale+this._baseCurve.getRange().max;return s<=t&&(0===r.length?r.push(o):Math.abs(o-r[0])*this._head.scale<t?r[0]=(o+r[0])/2:r.splice(0,0,o)),i>=-t&&(0===r.length?r.push(a):Math.abs(a-r[r.length-1])*this._tail.scale<t?r[r.length-1]=(a+r[r.length-1])/2:r.push(a)),r}getTangentAt(e,t){const n=this._getBase(e,t);return n.curve.getTangentAt(n.param)}getDerivatives(e,t,n){const r=this._getBase(e,n),s=r.curve.getDerivatives(r.param,t);for(let e=1;e<s.length;e++)s[e].multiply(r.scale);return s}getLength(e){const t=e||this._range,n=this._getBase(t.min),r=this._getBase(t.max);if(r.curve===this._head.curve||n.curve===this._tail.curve){const e=n.curve.getPtAt(n.param),t=r.curve.getPtAt(r.param);return e.subtract(t).getLength()}let s,i,o=0;return n.curve===this._head.curve?(o+=-n.param,s=this._baseCurve.getRange().min):s=t.min,r.curve===this._tail.curve?(o+=r.param,i=this._baseCurve.getRange().max):i=t.max,o+=this._baseCurve.getLength(new a.Interval(s,i)),o}toSimpleCurves(){const e=[],t=(this._range.min-this._baseCurve.getRange().min)*this._head.scale,n=(this._range.max-this._baseCurve.getRange().max)*this._tail.scale;let r,{min:s,max:i}=this._baseCurve.getRange();if(t<-p.Tolerance.EDGE_LENGTH_EPS){const n=this._head.curve;e.push(new g.Line3d(n.getOrigin(),n.getDirection(),[t,0])),s=this._baseCurve.getRange().min}else this._range.min>s&&(s=this._range.min);if(n>p.Tolerance.EDGE_LENGTH_EPS){const e=this._tail.curve;r=new g.Line3d(e.getOrigin(),e.getDirection(),[0,n])}else this._range.max<i&&(i=this._range.max);const o=this._baseCurve.clone();return s<i&&e.push(o.setRange(s,i)),r&&e.push(r),e}reverse(){const e=this._range.max-this._baseCurve.getRange().max,t=this._range.min-this._baseCurve.getRange().min;this._baseCurve.reverse(),this.updateExtension();const n=this._baseCurve.getRange();return this._range.set(n.min-e,n.max-t),this}transform(e,t){if(this._baseCurve.isLine3d())throw new Error("未实现的转换");return this._baseCurve.transform(e,t),this.updateExtension(),this}transformed(e,t){if(this._baseCurve.isLine3d())throw new Error("未实现的转换");const n=this._baseCurve.transformed(e,t),s=new r(n,this._range.toArray());if(!this._baseCurve.isOffsetCurve3d()||!n.isNurbsCurve3d())return s;const i=this._baseCurve.getRange(),o=n.getRange();if(this._range.min<i.min-p.Tolerance.NUMBER_EPS){const t=this.getPtAt(this._range.min).transformed(e),r=n.getStartPt(),i=n.getDerivatives(o.min,1),a=r.subtracted(t).getLength()/i[1].getLength(),c=o.min-a;s.getRange().min=c}if(this._range.max>i.max+p.Tolerance.NUMBER_EPS){const t=this.getPtAt(this._range.max).transformed(e),r=n.getEndPt(),i=n.getDerivatives(o.max,1),a=t.subtracted(r).getLength()/i[1].getLength(),c=o.max+a;s.getRange().max=c}return s}toNurbs(e=3,t=p.Tolerance.LENGTH_EPS){const n=this.getSingularities();n.sort();const r=this._range,s=r.clone(),i=[];let o=r;for(const e of n){const t=o.splited(e);i.push(t[0]),o=t[1]}i.push(o);const a=[];for(const n of i){this.setRange(n);const r=this.getInterpPts(t).pts,s=m.NurbsCurve3d.makeByInterpolationPoints(r,e);a.push(s)}if(this.setRange(s),1===a.length)return a[0];let c=[],l=[],d=[];for(const t of a)if(0===l.length)l=t.getControlPoints(),d=t.getWeights(),c=t.getKnots();else{c.pop(),l.pop(),d.pop(),l=l.concat(t.getControlPoints()),d=d.concat(t.getWeights());const n=c[c.length-1];for(let r=e+1;r<t.getKnots().length;r++)c.push(t.getKnots()[r]+n)}return m.NurbsCurve3d.makeByControlPoints(l,e,c,d)}getBoundingBox(e){const t=e||this._range,n=this._getBase(t.min),r=this._getBase(t.max),s=n.curve.getPtAt(n.param),i=r.curve.getPtAt(r.param);if(r.curve===this._head.curve||n.curve===this._tail.curve)return new f.Box3([s,i]);let o,a;const c=new f.Box3;n.curve===this._head.curve?(c.expandByPoint(s),o=this._baseCurve.getRange().min):o=t.min,r.curve===this._tail.curve?(c.expandByPoint(i),a=this._baseCurve.getRange().max):a=t.max;const l=this._baseCurve.getRange().clone();return this._baseCurve.setRange(o,a),c.union(this._baseCurve.getBoundingBox()),this._baseCurve.setRange(l),c}discrete(e=c.DiscreteParameter.NORMAL){const t=this._range,n=this._getBase(t.min),r=this._getBase(t.max),s=n.curve.getPtAt(n.param),i=r.curve.getPtAt(r.param);if(r.curve===this._head.curve||n.curve===this._tail.curve)return[s,i];let o,a;const l=[];let d,u=!1,h=!1;n.curve===this._head.curve?(l.push(s),o=this._baseCurve.getRange().min,d=1,u=o-this._range.min<p.Tolerance.EDGE_LENGTH_EPS):(o=t.min,d=0),r.curve===this._tail.curve?(l.push(i),a=this._baseCurve.getRange().max,h=this._range.max-a<p.Tolerance.EDGE_LENGTH_EPS):a=t.max;const g=this._baseCurve.getRange().clone();this._baseCurve.setRange(o,a);const f=this._baseCurve.discrete(e);return u&&f.shift(),h&&f.pop(),l.splice(d,0,...f),this._baseCurve.setRange(g),l}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_EXTEND_CURVE_3D}clone(){return new r(this._baseCurve.clone(),this._range.toArray())}dump(){return{type:this.getType(),data:[this._baseCurve.dump(),this._range.toArray()]}}load({data:[e,t]}){return this._baseCurve=o.Loader.load(e),this.updateExtension(),this._range=new a.Interval(t[0],t[1]),this}_getBase(e,t=!0){const n=this._baseCurve.getRange(),r=t?p.Tolerance.CALCULATE_EPS:-p.Tolerance.CALCULATE_EPS;if(e<n.min+r){const t=this._head;return{curve:t.curve,param:(e-n.min)*t.scale,scale:t.scale}}if(e>n.max+r){const t=this._tail;return{curve:t.curve,param:(e-n.max)*t.scale,scale:t.scale}}return{curve:this._baseCurve,param:e,scale:1}}};v=r=s([u.registerLoader,i("design:paramtypes",[h.Curve3d,Array])],v),t.ExtendCurve3d=v},70246:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Geometry2d=void 0;const r=n(26581),s=n(28982);class i extends s.GeoElement{translate(e){const t=r.Matrix3.makeTranslate(e);return this.transform(t)}rotate(e,t){const n=r.Matrix3.makeRotate(t,e);return this.transform(n)}scale(e,t){const n=r.Matrix3.makeScale(t,e);return this.transform(n)}}t.Geometry2d=i},29791:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Geometry3d=void 0;const r=n(61210),s=n(28982);class i extends s.GeoElement{translate(e){const t=r.Matrix4.makeTranslate(e);return this.transform(t)}rotate(e,t,n){const s=n||{x:0,y:0,z:1},i=r.Matrix4.makeRotate(t,s,e);return this.transform(i)}scale(e,t){const n=r.Matrix4.makeScale(t,e);return this.transform(n)}}t.Geometry3d=i},82433:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Hyperbola3d=void 0;const r=n(89494),s=n(60229),i=n(6688),o=n(33218),a=n(87222),c=n(17980),l=n(2111),d=n(97505),u=n(93145);class h extends l.Curve3d{constructor(e,t,n,o){super(),this._coord=new r.Coordinate3,t&&n&&e&&(this._coord=e,this._a=t,this._b=n,this._range=o?new i.Interval(o[0],o[1]):new i.Interval(-s.CONST.MODEL_MAX_LENGTH,s.CONST.MODEL_MAX_LENGTH))}getPtAt(e){const t=e*e,n=new o.Vector2(this._a*(1+t)/(1-t),2*this._b*e/(1-t));return this._coord.getWorldVectorAt(n)}getTangentAt(e){const t=1-e*e,n=t*t,r=new o.Vector2(4*this._a*e/n,this._b*(2+2*e*e)/n);return this._coord.getWorldVectorAt(r)}getDerivatives(e,t){throw new Error("未实现！")}getBoundingBox(e){throw new Error("unimplemented")}getParamAt(e){throw new Error("unimplemented")}getLength(e){throw new Error("unimplemented")}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_HYPERBOLA_3D}reverse(){throw new Error("unimplemented")}split(e,t){throw new Error("unimplemented")}transform(e){throw new Error("unimplemented")}toBezier3d(){const e=this.getPtAt(this._range.min),t=this.getPtAt(this._range.max),n=this.getTangentAt(this._range.min),r=this.getTangentAt(this._range.max),i=[];i.push(e);const o=new a.Line3d(e,n,[s.CONST.MAX_NEG_INTEGER,s.CONST.MAX_INTEGER]),l=new a.Line3d(t,r,[s.CONST.MAX_NEG_INTEGER,s.CONST.MAX_INTEGER]),d=c.CurveCurveIntersect.curve3ds(o,l)[0].point;i.push(d),i.push(t);return u.NurbsCurve3d.makeBezier(i,[1,1,0])}dump(){throw new Error("unimplemented")}load({data:[e,t,n,r]}){return this._a=t,this._b=n,this._coord.load(e),this._range=new i.Interval(r[0],r[1]),this}}t.Hyperbola3d=h},274:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IntersectCurve3d=void 0;const r=n(61226),s=n(93145),i=n(2111),o=n(6688),a=n(97505),c=n(56973),l=n(86059),d=n(44757),u=n(97700),h=n(60229),g=n(87222),f=n(11042),p=n(5804);class _ extends i.Curve3d{constructor(e,t){if(super(),e&&e.length>=2){this._surface=e;const n=[0];if(t){this._ptsChart=t;let e=0;for(let t=1;t<this._ptsChart.length;t++)e+=this._ptsChart[t].point.distanceTo(this._ptsChart[t-1].point),n.push(e);this._domain=new o.Interval(0,e)}else this._ptsChart=[],n.push(0),this._domain=new o.Interval(0,0);this._knots=n,this._range=this._domain}}updateKonts(){let e=0;const t=[0];for(let n=1;n<this._ptsChart.length;n++)e+=this._ptsChart[n].point.distanceTo(this._ptsChart[n-1].point),t.push(e);this._knots=t,this._domain=new o.Interval(0,e),this._range=this._domain}getAllPoints(){return this._ptsChart.map((e=>e.point))}getIntersectPtsChart(){return this._ptsChart}getDomain(){return this._domain}isPeriodic(){return!!(this._ptsChart.length>1&&this.getStartPt().equals(this.getEndPt()))}getStartPt(){return this._ptsChart[0].point}getEndPt(){return this._ptsChart[this._ptsChart.length-1].point}getPtAt(e){if(!this._domain.containsPoint(e))throw new Error("parameter out domain!");return this.getIntersectPtInfoAt(e).point}getIntersectPtInfoAt(e){if(!this._domain.containsPoint(e))throw new Error("parameter out domain!");if(Math.abs(e)<=c.Tolerance.LENGTH_EPS)return this._ptsChart[0];if(Math.abs(e-this._range.max)<=c.Tolerance.LENGTH_EPS)return this._ptsChart[this._ptsChart.length-1];let t=0,n=0,r=0;for(let s=1;s<this._ptsChart.length;s++){if(t=n,n+=this._ptsChart[s].point.distanceTo(this._ptsChart[s-1].point),Math.abs(e-n)<=c.Tolerance.LENGTH_EPS)return this._ptsChart[s];if(e<n){r=s-1;break}}const s=this._ptsChart[r],i=this._ptsChart[r+1],o=(e-t)/(n-t),a=this._getInsertPt(s,i,o);if(void 0===a)throw new Error("计算失败!");return a}getBoundingBox(e){throw new Error("unimplemented")}getTangentAt(e,t=!0){const n=this.getIntersectPtInfoAt(e);return this.getDerivativesAtPt(n,1,t)[1].normalized()}getParamAt(e){const t=this._surface[0].getUVAt(e),n=this._surface[1].getUVAt(e);if(this._surface[0].getPtAt(t).sqDistanceTo(e)<c.Tolerance.LENGTH_EPS2&&this._surface[1].getPtAt(n).sqDistanceTo(e)<c.Tolerance.LENGTH_EPS2){const t=[];for(let n=0;n<this._ptsChart.length-1;n++){const r=this._ptsChart[n+1].point.sqDistanceTo(this._ptsChart[n].point),s=this._ptsChart[n].point.sqDistanceTo(e),i=this._ptsChart[n+1].point.sqDistanceTo(e);if(s<r&&i<r){const r=this._ptsChart[n].point,s=this._ptsChart[n+1].point,i=new g.Line3d(r,s).getParamAt(e);t.push(this._knots[n]+i)}}if(1===t.length){const n=this.getIntersectPtInfoAt(t[0]);if(n.point.sqDistanceTo(e)<c.Tolerance.LENGTH_EPS2)return t[0];const r=this.getDerivativesAtPt(n,1)[1].normalized();if(Math.abs(r.dot(n.point.subtracted(e).normalized()))<c.Tolerance.ANGLE_EPS)return t[0];throw new Error("反求参数失败")}for(const n of t){if(this.getPtAt(n).sqDistanceTo(e)<c.Tolerance.LENGTH_EPS2)return n}}const r=[];for(let t=0;t<this._ptsChart.length-1;t++){const n=this._ptsChart[t+1].point.sqDistanceTo(this._ptsChart[t].point),s=this._ptsChart[t].point.sqDistanceTo(e),i=this._ptsChart[t+1].point.sqDistanceTo(e),o=s<=i?s:i;o<n&&r.push({dist:o,index:t})}const s=[];for(const t of r){const n=(this._knots[t.index]+this._knots[t.index+1])/2,r=this.getFootByIterate(e,n);void 0!==r&&s.push(r)}if(0===s.length)throw new Error("反求参数失败");if(1===s.length)return s[0];let i=s[0],o=h.CONST.MAX_INTEGER;for(const t of s){const n=this.getPtAt(t).sqDistanceTo(e);n<o&&(o=n,i=t)}return i}getKontIndex(e){if(this._ptsChart.length<1)throw new Error("invalid IntersectCurve!");let t=0,n=this._ptsChart[0].point.sqDistanceTo(e);for(let r=1;r<this._ptsChart.length;r++){const s=new g.Line3d(this._ptsChart[r-1].point,this._ptsChart[r].point),i=s.getParamAt(e);if(s.getRange().containsPoint(i,c.Tolerance.LENGTH_EPS)){if(s.getPtAt(i).sqDistanceTo(e)<.005*s.getRange().getLength())return r-1}const o=this._ptsChart[r].point.sqDistanceTo(e);o<n&&(t=r,n=o)}if(0===t){const n=new g.Line3d(this._ptsChart[t].point,this._ptsChart[t+1].point);return n.getParamAt(e)>n.getRange().min-c.Tolerance.LENGTH_EPS?t:t-1}if(t>0){const n=new g.Line3d(this._ptsChart[t-1].point,this._ptsChart[t].point);return n.getParamAt(e)>n.getRange().max+c.Tolerance.LENGTH_EPS?t:t-1}return t}getDerivatives(e,t){throw new Error("未实现！")}getDerivativesAtPt(e,t,n=!0,r){const s=[];s.push(e.point);const i=this._surface[0],o=this._surface[1];if(t>=1){const a=i.getNormAt(e.uvPara1).normalized(),l=o.getNormAt(e.uvPara2).normalized(),u=a.cross(l),h=c.Tolerance.ANGLE_EPS*c.Tolerance.ANGLE_EPS*1e4;if(u.getSqLength()<h){const s=this._getDerivativesAtTangentialPoint(e,t,n,r);return d.MathAssert.warn(s.length!==t,"intersectCurve: getDerivativesAtTangentialPoint计算失败！"),s}const g=u.normalized();if(void 0!==r&&r.dot(g)<0&&g.reverse(),s.push(g),t>=2){const n=a.dot(l),r=1-n*n,c=(e,t)=>{const n=e[3].dot(t),r=e[4].dot(t),s=e[5].dot(t),i=e[1].dot(e[1]),o=e[1].dot(e[2]),a=e[2].dot(e[2]),c=i*a-o*o,l=(e[1].dot(g)*a-e[2].dot(g)*o)/c,d=(e[2].dot(g)*i-e[1].dot(g)*o)/c;return n*l*l+2*r*l*d+s*d*d},d=i.getDerivatives(e.uvPara1,t),u=o.getDerivatives(e.uvPara2,t),h=c(d,a),f=c(u,l),p=a.multiplied((h-f*n)/r).add(l.multiplied((f-h*n)/r));s.push(p)}}return s}getLength(e){throw new Error("unimplemented")}getType(){return a.EN_GEO_ELEMENT_TYPE.EN_INTERSECT_3D}reverse(){this._ptsChart.reverse();const e=this._knots[this._knots.length-1];for(let t=0;t<this._knots.length;t++)this._knots[t]=e-this._knots[t];return this._knots.reverse(),this}split(e,t){throw new Error("unimplemented")}transform(e){for(const t of this._surface)t.transform(e);for(const t of this._ptsChart)t.point.transform(e);return this.updateKonts(),this}toSimpleCurve3d(e=3){const t=[];if(this._ptsChart.map((e=>t.push(e.point))),2===t.length){const e=this.getInsertPt(0,.5);t.splice(1,0,e)}if(3===t.length){const e=t[1].subtracted(t[0]).normalize(),n=t[2].subtracted(t[1]).normalize();if(e.isParallel(n))return new g.Line3d(t[0],t[2])}if(e>2&&t.length<e+1){const n=e+1-t.length;for(let e=0;e<n;e++){let e=0,n=0;for(let r=0;r<t.length-1;r++){const s=t[r].sqDistanceTo(t[r+1]);s>e&&(e=s,n=r)}const r=this.getInsertPt(n,.5);t.splice(n+1,0,r)}}return s.NurbsCurve3d.makeByInterpolationPoints(t,e)}toNurbs(e=3,t=c.Tolerance.LENGTH_EPS){const n=[];if(this._ptsChart.map((e=>n.push(e.point))),2===n.length){const e=this.getInsertPt(0,.5);n.splice(1,0,e)}if(e>2&&n.length<e+1){const t=e+1-n.length;for(let e=0;e<t;e++){let e=0,t=0;for(let r=0;r<n.length-1;r++){const s=n[r].sqDistanceTo(n[r+1]);s>e&&(e=s,t=r)}const r=this.getInsertPt(t,.5);n.splice(t+1,0,r)}}return s.NurbsCurve3d.makeByInterpolationPoints(n,e)}toNurbsBetweenPoints(e=3,t,n,r){const i=[];if(this._ptsChart.map((e=>i.push(e.point))),2===i.length){const e=this.getInsertPt(0,.5);i.splice(1,0,e)}if(3===i.length){const e=i[1].subtracted(i[0]).normalize(),s=i[2].subtracted(i[1]).normalize();if(e.isParallel(s)){const e=new g.Line3d(t,n);return r&&r.dot(e.getDirection())<0?e.reverse():e}}const o=this.getKontIndex(t)+1,a=this.getKontIndex(n);let[l,d]=[t,n],[u,h]=[o,a];if(u>h&&([l,d]=[d,l],[u,h]=[h,u]),r&&this._ptsChart[0].point.equals(this._ptsChart[this._ptsChart.length-1].point,c.Tolerance.LENGTH_EPS)){(u<this._ptsChart.length-2?this._ptsChart[u].point.subtracted(this._ptsChart[u+1].point):this._ptsChart[u-1].point.subtracted(this._ptsChart[u].point)).dot(r)<0&&([l,d]=[d,l],h=u+this._ptsChart.length)}const f=[];for(let e=u+1;e<=h;e++)f.push(this._ptsChart[e%this._ptsChart.length].point);if(2===f.length){const e=this.getInsertPt(u,.5);f.splice(u+1,0,e)}const p=f[0].sqDistanceTo(f[1]);l.sqDistanceTo(f[0])>p/1e4?f.splice(0,0,l):f[0]=l;const _=f[f.length-1].sqDistanceTo(f[f.length-2]);d.sqDistanceTo(f[f.length-1])>_/1e4?f.push(d):f[f.length-1]=d;const m=f.length<=e?e-1:e;return s.NurbsCurve3d.makeByInterpolationPoints(f,m)}getInsertPt(e,t){const n=this._ptsChart[e],r=this._ptsChart[e+1],s=this._getInsertPt(n,r,t);if(void 0!==s)return s.point;return n.point.multiplied(1-t).add(r.point.multiplied(t))}insertPt(e,t){const n=this._ptsChart[e],r=this._ptsChart[e+1],s=this._getInsertPt(n,r,t);return void 0!==s&&(this._ptsChart.splice(e+1,0,s),!0)}clone(){const e=[...this._surface],t=[];for(const e of this._ptsChart){const n={point:e.point.clone(),uvPara1:{x:e.uvPara1.x,y:e.uvPara1.y},uvPara2:{x:e.uvPara2.x,y:e.uvPara2.y},isSingularity:e.isSingularity};t.push(n)}return new _(e,t)}dump(){return this.toSimpleCurve3d().dump()}load(){return this}_getDerivativesAtTangentialPoint(e,t,n=!0,r){const s=[];s.push(e.point);const i=this._surface[0],o=this._surface[1],a=i.getNormAt(e.uvPara1).normalized(),g=o.getNormAt(e.uvPara2).normalized(),f=(e,t)=>({L:e[3].dot(t),M:e[4].dot(t),N:e[5].dot(t)}),p=i.getDerivatives(e.uvPara1,t+1),_=o.getDerivatives(e.uvPara2,t+1),m=f(p,a),v=f(_,g),E=a,P=1/_[1].cross(_[2]).dot(E),y=p[1].cross(_[2]),C=p[2].cross(_[2]),S=_[1].cross(p[1]),T=_[1].cross(p[2]),b=y.dot(E)*P,w=C.dot(E)*P,x=S.dot(E)*P,M=T.dot(E)*P,N=b*b*v.L+2*b*x*v.M+x*x*v.N-m.L,A=b*w*v.L+(b*M+w*x)*v.M+x*M*v.N-m.M,O=w*w*v.L+2*w*M*v.M+M*M*v.N-m.N;let I,D,L;const V=c.Tolerance.NUMBER_CALCULATION_EPS;if(Math.abs(N)<=V)if(Math.abs(A)>V){const e=-O/(2*A),t=p[1].multiplied(e).add(p[2]);D=1/t.getLength(),I=e*D,L=t.normalized()}else if(Math.abs(O)>V){const e=-2*A/O,t=p[1].added(p[2].multiplied(e));I=1/t.getLength(),D=e*I,L=t.normalized()}else{const e=p[1].equals(_[1]),t=p[2].equals(_[2]);if(t&&!e)D=1/p[2].getLength(),I=0,L=p[2].normalized();else{if(!e||t)return d.MathAssert.warn("getDerivativesAtTangentialPoint: 高阶相切，不能用此方法计算切线"),s;I=1/p[1].getLength(),D=0,L=p[1].normalized()}}else{const e=l.QuadraticEquation.solve(N,2*A,O,V);if(0===e.length)return d.MathAssert.warn("getDerivativesAtTangentialPoint: 曲面相切，只有一个孤立的切点，没有切向和曲率"),s;if(1===e.length){const t=e[0],n=p[1].multiplied(t).add(p[2]);D=1/n.getLength(),I=t*D,L=n.normalized()}else{const t=p[1].multiplied(e[0]).add(p[2]),n=p[1].multiplied(e[1]).add(p[2]);if(r){let s=r.angle(t);s=s>h.CONST.PI_2?h.CONST.PI-s:s;let i=r.angle(n);if(i=i>h.CONST.PI_2?h.CONST.PI-i:i,i<s){D=1/n.getLength();I=e[1]*D,L=n.normalized()}else{D=1/t.getLength();I=e[0]*D,L=t.normalized()}}else{D=1/t.getLength(),L=t.normalized();I=e[0]*D}}}if(void 0!==r&&r.dot(L)<0&&L.reverse(),s.push(L),I=Math.abs(I)<c.Tolerance.ZERO_JUDGE_EPS?0:I,D=Math.abs(D)<c.Tolerance.ZERO_JUDGE_EPS?0:D,t>=2){const e=b*I+w*D,t=x*I+M*D,n=I*I,r=D*D,i=e*e,o=t*t,c=p[3].multiplied(n).add(p[4].multiplied(2*I*D)).add(p[5].multiplied(r)),l=_[3].multiplied(i).add(_[4].multiplied(2*e*t)).add(_[5].multiplied(o)).subtracted(c),d=l.cross(_[2]).dot(E)*P,h=_[1].cross(l).dot(E)*P,f=p[6].dot(a)*n*I+3*p[7].dot(a)*n*D+3*p[8].dot(a)*I*r+p[9].dot(a)*D*r,y=_[6].dot(g)*i*e+3*_[7].dot(g)*i*t+3*_[8].dot(g)*e*o+_[9].dot(g)*t*o,C=m.L*I,S=m.M*I,T=m.M*D,N=m.N*D,A=v.L*e,O=v.M*e,V=v.M*t,R=v.N*t,U=A*d+O*h+V*d+R*h+y/3-f/3,B=[[A*b+O*x+V*b+R*x-C-T,A*w+O*M+V*w+R*M-S-N],[p[1].dot(L),p[2].dot(L)]],F=[-U,-(p[3].dot(L)*n+2*p[4].dot(L)*I*D+p[5].dot(L)*r)],k=u.LinearSystem.execute(B,F);if(void 0===k)return s;const G=c.added(p[1].multiplied(k[0])).added(p[2].multiplied(k[1]));s.push(G)}return s}_getInsertPt(e,t,n,s=c.Tolerance.DEFAULT){const i=this._surface[0],o=this._surface[1],a={x:e.uvPara1.x*(1-n)+t.uvPara1.x*n,y:e.uvPara1.y*(1-n)+t.uvPara1.y*n},l={x:e.uvPara2.x*(1-n)+t.uvPara2.x*n,y:e.uvPara2.y*(1-n)+t.uvPara2.y*n},d=new r.Vector3(e.point.x*(1-n)+t.point.x*n,e.point.y*(1-n)+t.point.y*n,e.point.z*(1-n)+t.point.z*n),u=e.point.subtracted(t.point),h=new p.Plane(d,u),g=[a,l,{x:0,y:0}];let _;if(f.threeSurfacesIteration(this._surface[0],this._surface[1],h,g,s.lengthEps)&&i.getDomainU().containsPoint(g[0].x)&&i.getDomainV().containsPoint(g[0].y)&&o.getDomainU().containsPoint(g[1].x)&&o.getDomainV().containsPoint(g[1].y)&&(_=h.getPtAt(g[2]),_.sqDistanceTo(d)<.01)){return{point:_,uvPara1:g[0],uvPara2:g[1]}}const m=[a,l],v=n<.5?e.point:t.point;if(f.surfaceSurfaceIteration(this._surface[0],this._surface[1],m,s.lengthEps)&&i.getDomainU().containsPoint(m[0].x)&&i.getDomainV().containsPoint(m[0].y)&&o.getDomainU().containsPoint(m[1].x)&&o.getDomainV().containsPoint(m[1].y)){const n=i.getPtAt(m[0]);if(_&&_.sqDistanceTo(d)<n.sqDistanceTo(d)){return{point:_,uvPara1:g[0],uvPara2:g[1]}}if(n.sqDistanceTo(v)<e.point.sqDistanceTo(t.point)){return{point:n,uvPara1:m[0],uvPara2:m[1]}}}if(f.surfaceSurfaceIteration(this._surface[0],this._surface[1],m,s.lengthEps,!1)&&i.getDomainU().containsPoint(m[0].x)&&i.getDomainV().containsPoint(m[0].y)&&o.getDomainU().containsPoint(m[1].x)&&o.getDomainV().containsPoint(m[1].y)){const n=i.getPtAt(m[0]);if(_&&_.sqDistanceTo(d)<n.sqDistanceTo(d)){return{point:_,uvPara1:g[0],uvPara2:g[1]}}if(n.sqDistanceTo(v)<e.point.sqDistanceTo(t.point)){return{point:n,uvPara1:m[0],uvPara2:m[1]}}}}}t.IntersectCurve3d=_},32858:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Line2d=void 0;const o=n(60229),a=n(68990),c=n(33218),l=n(90361),d=n(97505),u=n(6688),h=n(13982),g=n(49246),f=n(5804),p=n(56973),_=n(43640),m=n(79034),v=n(4097),E=n(48448);let P=r=class extends a.Curve2d{constructor(e,t,n){super(),this._origin=c.Vector2.O(),this._dir=c.Vector2.X(),!n&&e&&t?this.reset(e,t):e&&t&&n&&(this._origin=new c.Vector2(e),this._dir=new c.Vector2(t),this._dir.normalize(),this._range=new u.Interval(n[0],n[1]))}toVector2(){return new c.Vector2(this.getStartPt(),this.getEndPt())}reset(e,t){const n=new c.Vector2(e,t),r=n.getLength();r<p.Tolerance.CALCULATE_EPS?(v.MathError.mutedWarn(!1,"two points are too near to determine line direction"),this._dir=c.Vector2.X()):this._dir=n.multiply(1/r),this._origin=new c.Vector2(e),this._range=new u.Interval(0,r)}getOrigin(){return this._origin}setOrigin(e){return this._origin.copy(e)}getDirection(){return this._dir.clone()}setDirection(e){this._dir=new c.Vector2(e).normalize()}getLeftNormal(){return new c.Vector2(-this._dir.y,this._dir.x).normalize()}getRightNormal(){return this.getLeftNormal().reverse()}isLineLike(){return!0}isParallelTo(e,t=p.Tolerance.ANGLE_EPS){return this._dir.isParallel(e._dir,t)}isColinearWith(e,t=p.Tolerance.LENGTH_EPS){return m.CurveCurveColinear.lines(this,e,new p.Tolerance(t))}isPerpendicularTo(e,t=p.Tolerance.ANGLE_EPS){return this._dir.isPerpendicular(e._dir,t)}side(e,t){const n=this._origin.added(this._dir),r=(this._origin.x-e.x)*(n.y-e.y)-(this._origin.y-e.y)*(n.x-e.x);return g.Util.isNearlyZero(r,t)?0:r>0?1:-1}getPtAt(e){return this._dir.multiplied(e).add(this._origin)}getParamAt(e){return new c.Vector2(e).subtract(this._origin).dot(this._dir)}getClosestPoint(e){const t=this.getParamAt(e);return t<this._range.min?this.getStartPt():t>this._range.max?this.getEndPt():this.getPtAt(t)}getAllFootParams(e,t=p.Tolerance.LENGTH_EPS){return[this.getParamAt(e)]}getFootByIterate(e,t){return new c.Vector2(e).subtract(this._origin).dot(this._dir)}getDerivatives(e,t){const n=[];n.push(this.getPtAt(e)),t>=1&&n.push(this.getDirection());for(let e=2;e<=t;e++)n.push(new c.Vector2);return n}getTangentAt(e){return this.getDirection()}getLength(e){return void 0!==e?e.getLength():this._range.getLength()}reverse(){return this._dir.reverse(),this._range.set(-this._range.max,-this._range.min),this}split(e,t){const n=e.filter((e=>this._range.containsPoint(e,t)&&!this._range.containsPointAtStartOrEnd(e,t)));if(!n.length)return[];return this._range.splited(...n).map((e=>new r(this.getOrigin(),this.getDirection(),e.toArray())))}toNurbs(e=1,t=p.Tolerance.LENGTH_EPS){const n=[this.getStartPt()],r=this._range.getLength()/e;for(let t=1;t<=e;t++){const e=this.getPtAt(t*r);n.push(e)}return E.NurbsCurve2d.makeByInterpolationPoints(n,e)}toCurve3d(e){return new f.Plane(e).getCurve3d(this)}toInfiniteLine(){const e=this.clone();return e.setRange(new u.Interval(-o.CONST.MODEL_MAX_LENGTH,o.CONST.MODEL_MAX_LENGTH)),e}offset(e){const t=this.getDirection();t.vecRotate(-o.CONST.PI_2);const n=t.multiplied(e);return this._origin.add(n),!0}transform(e){this._origin.transform(e),this._dir.vecTransform(e);const t=this._dir.getLength();return this._dir.multiply(1/t),this._range.multiply(t),this}getBoundingBox(e){const t=e||this._range;return new l.Box2([this.getPtAt(t.min),this.getPtAt(t.max)])}tessellate(e,t=_.DiscreteParameter.NORMAL){return this._tessellateByPoints([this.getStartPt(),this.getEndPt()],"Line2d",e)}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_LINE_2D}clone(){return super.clone()}dump(){return{type:this.getType(),data:[this._origin.toArray2(),this._dir.toArray2(),this._range.toArray()]}}load({data:[e,t,n]}){return this._origin.resetFromArray(e),this._dir.resetFromArray(t).normalize(),this._range=new u.Interval(n[0],n[1]),this}translate(e){return this._origin.add(e),this}};P=r=s([h.registerLoader,i("design:paramtypes",[Object,Object,Array])],P),t.Line2d=P},87222:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Line3d=void 0;const o=n(2111),a=n(61226),c=n(97505),l=n(6688),d=n(67996),u=n(13982),h=n(56973),g=n(60229),f=n(43640),p=n(77655),_=n(79034),m=n(93145);let v=r=class extends o.Curve3d{constructor(e,t,n){super(),this._origin=a.Vector3.O(),this._dir=a.Vector3.X(),!n&&e&&t?this.reset(e,t):e&&t&&n&&(this._origin=new a.Vector3(e),this._dir=new a.Vector3(t),this._dir.normalize(),this._range=new l.Interval(n[0],n[1]))}getOrigin(){return this._origin}setOrigin(e){return this._origin.copy(e)}toVector3(){return new a.Vector3(this.getStartPt(),this.getEndPt())}toInfiniteLine(){const e=this.clone();return e.setRange(new l.Interval(-g.CONST.MODEL_MAX_LENGTH,g.CONST.MODEL_MAX_LENGTH)),e}reset(e,t){const n=new a.Vector3(e,t),r=n.getLength();r<h.Tolerance.CALCULATE_EPS?this._dir=a.Vector3.X():this._dir=n.multiply(1/r),this._origin=new a.Vector3(e),this._range=new l.Interval(0,r)}getDirection(){return this._dir.clone()}setDirection(e){this._dir=new a.Vector3(e).normalize()}isLineLike(){return!0}isParallelTo(e,t=h.Tolerance.ANGLE_EPS){return this._dir.isParallel(e._dir,t)}isColinearWith(e,t=h.Tolerance.LENGTH_EPS){return _.CurveCurveColinear.lines(this,e,new h.Tolerance(t))}isPerpendicularTo(e,t=h.Tolerance.ANGLE_EPS){return this._dir.isPerpendicular(e._dir,t)}getPtAt(e){return this._dir.multiplied(e).add(this._origin)}getParamAt(e){return new a.Vector3(e).subtract(this._origin).dot(this._dir)}getClosestPoint(e){const t=this.getParamAt(e);return t<this._range.min?this.getStartPt():t>this._range.max?this.getEndPt():this.getPtAt(t)}getAllFootParams(e,t=h.Tolerance.LENGTH_EPS){return[this.getParamAt(e)]}getFootByIterate(e,t){return new a.Vector3(e).subtract(this._origin).dot(this._dir)}getTangentAt(e){return this.getDirection()}getTangentCone(e,t=!0){return new p.TangentCone(this.getDirection(),0)}getDerivatives(e,t){const n=[];n.push(this.getPtAt(e)),t>=1&&n.push(this.getDirection());for(let e=2;e<=t;e++)n.push(new a.Vector3);return n}getLength(e){return void 0!==e?e.getLength():this._range.getLength()}getInfinitClone(){return new r(this._origin,this._dir,[-g.CONST.MODEL_MAX_LENGTH,g.CONST.MODEL_MAX_LENGTH])}isPlaneCurve3d(e){return!0}reverse(){return this._dir.reverse(),this._range.set(-this._range.max,-this._range.min),this}transform(e){this._origin.transform(e),this._dir.vecTransform(e);const t=this._dir.getLength();return this._dir.multiply(1/t),this._range.multiply(t),this}split(e,t){const n=e.filter((e=>this._range.containsPoint(e,t)&&!this._range.containsPointAtStartOrEnd(e,t)));if(!n.length)return[];return this._range.splited(...n).map((e=>new r(this.getOrigin(),this.getDirection(),e.toArray())))}toNurbs(e=1,t=h.Tolerance.LENGTH_EPS){const n=[this.getStartPt()],r=this._range.getLength()/e;for(let t=1;t<=e;t++){const e=this.getPtAt(t*r);n.push(e)}return m.NurbsCurve3d.makeByInterpolationPoints(n,e)}getBoundingBox(e){const t=e||this._range;return new d.Box3([this.getPtAt(t.min),this.getPtAt(t.max)])}tessellate(e,t=f.DiscreteParameter.NORMAL){return this._tessellateByPoints([this.getStartPt(),this.getEndPt()],"Line3d",e)}getType(){return c.EN_GEO_ELEMENT_TYPE.EN_LINE_3D}clone(){return super.clone()}dump(){return{type:this.getType(),data:[this._origin.toArray3(),this._dir.toArray3(),[this.getRange().min,this.getRange().max]]}}load({data:[e,t,n]}){return this._origin.resetFromArray(e),this._dir.resetFromArray(t),this._range=new l.Interval(n[0],n[1]),this}translate(e){return this._origin.add(e),this}};v=r=s([u.registerLoader,i("design:paramtypes",[Object,Object,Array])],v),t.Line3d=v},48448:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.NurbsCurve2d=void 0;const o=n(68990),a=n(6688),c=n(97505),l=n(13982),d=n(43640),u=n(93145),h=n(33218),g=n(56973),f=n(90361),p=n(61210);let _=r=class extends o.Curve2d{constructor(e){super(),e&&(this._nurbsCurve3d=e,this._range=e.getRange())}static makeBezier(e,t){const n=this._fiterCoPoint(e),s=n.length-1,i=u.NurbsCurve3d.getBezierKnots(s);return r.makeByControlPoints(n,s,i,t,[0,1])}static makeByControlPoints(e,t=3,n,s,i){const o=e.map((e=>({x:e.x,y:e.y,z:0}))),a=u.NurbsCurve3d.makeByControlPoints(o,t,n,s,i);return new r(a)}static makeByInterpolationPoints(e,t=3,n=!1){const s=e.map((e=>({x:e.x,y:e.y,z:0})));return new r(u.NurbsCurve3d.makeByInterpolationPoints(s,t,n))}static _fiterCoPoint(e){const t=[];t.push(e[0]);for(let n=1;n<e.length;++n)g.Tolerance.DEFAULT.areNear(e[n],e[n-1])||t.push(e[n]);return t}getDegree(){return this._nurbsCurve3d.getDegree()}getWeights(){return this._nurbsCurve3d.getWeights()}getKnots(){return this._nurbsCurve3d.getKnots()}getControlPoints(){return this._nurbsCurve3d.getControlPoints().map((e=>new h.Vector2(e)))}getDomain(){return this._nurbsCurve3d.getDomain()}isBezier(){return this._nurbsCurve3d.isBezier()}getAllFootParams(e,t=g.Tolerance.LENGTH_EPS){return this._nurbsCurve3d.getAllFootParams({x:e.x,y:e.y,z:0},t)}getPtAt(e){return new h.Vector2(this._nurbsCurve3d.getPtAt(e))}getParamAt(e){return this._nurbsCurve3d.getParamAt({x:e.x,y:e.y,z:0})}getTangentAt(e){return new h.Vector2(this._nurbsCurve3d.getTangentAt(e))}getDerivatives(e,t){return this._nurbsCurve3d.getDerivatives(e,t).map((e=>new h.Vector2(e)))}getEqualDiversionPts(e=3){return this._nurbsCurve3d.getEqualDiversionPts(e).map((e=>new h.Vector2(e)))}splitCurve(e,t=!0){return this._nurbsCurve3d.splitCurve(e,t).map((e=>new r(e)))}reverse(){return this._nurbsCurve3d.reverse(),this}offset(e){return!1}clone(){return new r(this._nurbsCurve3d.clone())}getRange(){return this._nurbsCurve3d.getRange()}setRange(e,t){return e instanceof a.Interval?this._nurbsCurve3d.setRange(e):this._nurbsCurve3d.setRange(e,t),this}getLength(e){return this._nurbsCurve3d.getLength(e)}getBoundingBox(e){const t=this._nurbsCurve3d.getBoundingBox(e);return new f.Box2([t.min,t.max])}transform(e){const t=p.Matrix4.makeByMatrix3(e);return this._nurbsCurve3d.transform(t),this}discrete(e=d.DiscreteParameter.NORMAL){return this._nurbsCurve3d.discrete(e).map((e=>new h.Vector2(e)))}getType(){return c.EN_GEO_ELEMENT_TYPE.EN_NURBS_CURVE_2D}dump(){const e=this._nurbsCurve3d.dump();e.type=c.EN_GEO_ELEMENT_TYPE.EN_NURBS_CURVE_2D;for(const t of e.data[1])t.pop();return e}load(e){const t=e.data[1];for(const e of t)e.push(0);return this._nurbsCurve3d||(this._nurbsCurve3d=new u.NurbsCurve3d),this._nurbsCurve3d.load(e),this._range=this._nurbsCurve3d.getRange(),this}};_=r=s([l.registerLoader,i("design:paramtypes",[u.NurbsCurve3d])],_),t.NurbsCurve2d=_},93145:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.NurbsCurve3d=void 0;const o=n(68894),a=n(2111),c=n(61226),l=n(6688),d=n(97505),u=n(13982),h=n(43640),g=n(44757),f=n(49246),p=n(77655),_=n(56973),m=n(61210),v=n(87222),E=n(26773),P=n(4097),y=n(17165),C=n(67996);let S=r=class extends a.Curve3d{constructor(e,t){if(super(),e){this._verbCurve=e,this._updateParameters();const n=this._controlPoints[0].sqDistanceTo(this._controlPoints[this._controlPoints.length-1])<_.Tolerance.LENGTH_EPS2;if(t)if(n){const n=e.domain();this._range=new E.PeriodInterval(t[0],t[1],n.max-n.min)}else this._range=new l.Interval(t[0],t[1]);else{const t=e.domain();this._range=n?new E.PeriodInterval(t.min,t.max,t.max-t.min):new l.Interval(t.min,t.max)}}}static mergeNurbsCurve(e,t,n,s=3){let i=e.clone(),o=t.clone();if(n){n.isSameDirection||(o=o.reverse());const e=n.range1.getMid();i=i.splitCurve(e)[0];const t=o.getParamAt(i.getPtAt(e));o=o.splitCurve(t)[1]}else if(i.getEndPt().equals(o.getEndPt()))o=o.reverse();else if(i.getStartPt().equals(o.getStartPt()))i=i.reverse();else if(i.getStartPt().equals(o.getEndPt()))[i,o]=[o,i];else if(!i.getEndPt().equals(o.getStartPt()))return;const a=i.getControlPoints(),c=i.getKnots(),l=o.getKnots();a.pop();const d=a.concat(o.getControlPoints()),u=c.slice(0,c.length-1),h=u[u.length-1],g=l[0];for(let e=s+1;e<l.length;e++)u.push(l[e]+h-g);return r.makeByControlPoints(d,s,u)}static makeBezier(e,t){const n=this._fiterCoPoint(e),s=n.length-1,i=r.getBezierKnots(s);return r.makeByControlPoints(n,s,i,t,[0,1])}static makeByControlPoints(e,t=3,n,s,i){const a=this._fiterCoPoint(e);g.MathAssert.assert(a.length>=t+1,"nurbs curve 控制点数量需大于曲线次数"),g.MathAssert.assert(!s||s.length===a.length,"控制点和权值数量应相等");const c=s||new Array(a.length).fill(1);let l;if(n)l=n;else{l=new Array(a.length+t+1);const e=l.length,n=a.length;for(let r=0;r<e;r++)l[r]=r<=t?0:r<=n?r-t:l[r-1]}const d=a.map((e=>[e.x,e.y,e.z])),u=o.geom.NurbsCurve.byKnotsControlPointsWeights(t,l,d,c);return new r(u,i)}static makeByInterpolationPoints(e,t=3,n=!1){const s=this._fiterCoPoint(e);if(s.length<=1)return g.MathAssert.warn(!1,"nurbs curve 至少需要 2 个点进行插值"),new v.Line3d(s.length>0?s[0]:c.Vector3.O(),c.Vector3.X(),[0,0]);const i=Math.min(t,s.length-1),a=s.map((e=>[e.x,e.y,e.z]));let l;if(3===i)if(n&&new c.Vector3(e[0]).equals(e[e.length-1])){const e=this._make3dNurbsByInterPoint(a).tangent(0);l=new o.geom.NurbsCurve(o.eval.Make.rationalInterpCurve(a,3,!1,e,e))}else l=this._make3dNurbsByInterPoint(a);else if(n&&new c.Vector3(e[0]).equals(e[e.length-1])){const e=o.geom.NurbsCurve.byPoints(a,i).tangent(0);l=new o.geom.NurbsCurve(o.eval.Make.rationalInterpCurve(a,i,!1,e,e))}else l=o.geom.NurbsCurve.byPoints(a,i);return new r(l)}static makeByInterpolationPointsInPlane(e,t,n=3,s=!1){const i=e.map((e=>t.getLocalPtAt(e))).map((e=>({x:e.x,y:e.y,z:0}))),o=r.makeByInterpolationPoints(i,n,s),a=o.getControlPoints().map((e=>t.getWorldPtAt(e))),c=o.getKnots(),l=o.getWeights();return r.makeByControlPoints(a,o.getDegree(),c,l)}static getBezierKnots(e){const t=[],n=e+1;for(let e=0;e<n;e++)t.push(0);for(let e=0;e<n;e++)t.push(1);return t}static _fiterCoPoint(e){const t=[];t.push(e[0]);for(let n=1;n<e.length;++n)_.Tolerance.DEFAULT.areNear(e[n],e[n-1])||t.push(e[n]);return t}static _make3dNurbsByInterPoint(e){for(var t=[0],n=1,r=e.length;n<r;){var s=n++,i=o.core.Vec.norm(o.core.Vec.sub(e[s],e[s-1])),a=t[t.length-1];t.push(a+i)}for(var c=t[t.length-1],l=0,d=t.length;l<d;){var u=l++;t[u]=t[u]/c}for(var h=[0,0,0,0],g=t.length-3,f=1;f<g;){for(var p=f++,_=0,m=0;m<3;){_+=t[p+m++]}h.push(1/3*_)}for(var v=h.concat([1,1,1,1]),E=[],P=e.length-1,y=0,C=e.length-4;y<t.length;){var S=t[y];++y;var T=o.eval.Eval.knotSpanGivenN(P,3,S,v),b=o.eval.Eval.basisFunctionsGivenKnotSpanIndex(T,S,3,v),w=T-3,x=o.core.Vec.zeros1d(w),M=o.core.Vec.zeros1d(C-w);E.push(x.concat(b).concat(M))}for(var N=e[0].length,A=[],O=0;O<N;){var I,D,L=[O++];if(I=e.map(function(e){return function(t){return t[e[0]]}}(L)),E.length>5){var V=E.map((e=>e.slice()));D=this._quickSolve(V,I.slice())}else D=o.core.Mat.solve(E,I);A.push(D)}var R=o.core.Mat.transpose(A),U=o.core.Vec.rep(R.length,1);return R=o.eval.Eval.homogenize1d(R,U),new o.geom.NurbsCurve(new o.core.NurbsCurveData(3,v,R))}static _quickSolve(e,t){const n=e.length;for(let r=0;r<3;++r)for(let s=n-3+r;s>0;--s){const i=e[s],o=e[s-1];let a=s+2-r<n?s+2-r:n-1;if(_.Tolerance.DEFAULT.isLengthZero(o[a]))continue;const c=o[a]/i[a];for(t[s-1]-=t[s]*c;a>s-6&&a>=0;--a)o[a]-=i[a]*c}for(let r=0;r<3;++r)for(let s=2-r;s<n-1;++s){const i=e[s+1],o=e[s];let a=s-2+r>0?s-2+r:0;if(_.Tolerance.DEFAULT.isLengthZero(i[a]))continue;const c=i[a]/o[a];for(t[s+1]-=t[s]*c;a<s+6&&a<n;++a)i[a]-=o[a]*c}for(let r=0;r<n;++r)t[r]*=1/e[r][r];return t}getDegree(){return this._degree}getWeights(){return this._weights}getKnots(){return this._knots}getControlPoints(){return this._controlPoints}getDomain(){const e=this._verbCurve.domain();return this._range instanceof E.PeriodInterval?new E.PeriodInterval(e.min,e.max,e.max-e.min):new l.Interval(e.min,e.max)}isBezier(){const e=this._controlPoints.length;if(this._degree+1!==e)return!1;for(let t=0;t<e;t++){if(0!==this._knots[t])return!1;if(0!==this._knots[t+e])return!1}return!0}getCoincideLine(e=_.Tolerance.ANGLE_EPS){const t=this._controlPoints[this._controlPoints.length-1].subtracted(this._controlPoints[0]).normalize(),n=new v.Line3d(this._controlPoints[0],t,l.Interval.infinitArray());for(let n=1;n<this._controlPoints.length;n++){const r=this._controlPoints[n].subtracted(this._controlPoints[0]).normalize();if(!t.isParallel(r,e))return}return n}isPlaneCurve3d(e=_.Tolerance.ANGLE_EPS){const t=this._controlPoints;if(t.length<4)return!0;let n;const r=t[0],s=c.Vector3.O(),i=t[1].subtracted(r).normalized();for(let o=2;o<t.length;o++){const a=t[o].subtracted(r);if(a.equals(s))continue;const l=a.normalized();if(void 0===n){const e=i.cross(l).normalized();e.equals(new c.Vector3(0,0,0))||(n=e)}else{const t=n.dot(l);if(Math.abs(t)>e)return!1}}return n||!0}getPtAt(e){const t=this.getDomain(),n=t instanceof E.PeriodInterval?t.getRegularParam(e):e,r=this._verbCurve.point(n);return new c.Vector3(r[0],r[1],r[2])}getAllFootParams(e,t=_.Tolerance.LENGTH_EPS,n=_.Tolerance.ANGLE_EPS){const r=[],s=!this.isPeriodic(),i=this.getDomain(),o=this._degree*this._controlPoints.length,a=(i.max-i.min)/o,l=new c.Vector3(e);let d=i.min,u=this.getPtAt(d).subtracted(l),h=this.getTangentAt(d).dot(u);Math.abs(h)<t&&r.push(d);for(let c=1;c<=o;++c){const o=i.min+a*c,g=this.getPtAt(o).subtracted(l),f=this.getTangentAt(o).dot(g);if(Math.abs(f)<t)r.push(o);else{if(h*f<0){let a;a=h>0?d:o;const c=this.getFootByIterate(e,a,t,n,s);if(void 0!==c){const a=s?c:i.clamp(c);if(a<o+t&&a>d-t)r.push(a);else{const i=this.getFootByDichotomy(e,d,o,t,n,s);void 0===i?P.MathError.warn("nurbs3d反求参数失败！"):r.push(i)}}}d=o,u=g,h=f}}if(r.length<1)return[];r.sort();const g=[r[0]];for(let e=1;e<r.length;++e)Math.abs(r[e-1]-r[e])<t||g.push(r[e]);return g.length>1&&i instanceof E.PeriodInterval&&Math.abs(g[g.length-1]-g[0]-i.period)<t&&g.pop(),g}getParamAt(e){for(var t=[e.x,e.y,e.z],n=o.eval.Tess.rationalCurveRegularSample(this._verbCurve.asNurbs(),this._knots.length,!0),r=0,s=n.length-1,i=[];r<s;){var a=n[C=r++][0],c=n[C+1][0],l=n[C].slice(1),d=n[C+1].slice(1),u=o.core.Trig.segmentClosestPoint(t,l,d,a,c),h=o.core.Vec.norm(o.core.Vec.sub(t,u.pt));i.push([h,u.u])}i.sort((function(e,t){return e[0]-t[0]}));const g=Math.min(Math.max(5,4*Math.log10(i.length)),i.length);for(var f=1/0,p=0,_=0;_<g;++_)for(var m=i[_][1]-1>0?i[_][1]-1:0,v=i[_][1]+1<this._knots[this._knots.length-1]?i[_][1]+1:this._knots[this._knots.length-1],E=o.eval.Tess.rationalCurveRegularSampleRange(this._verbCurve.asNurbs(),m,v,10*this._degree,!0),P=0,y=E.length-1;P<y;){var C;a=E[C=P++][0],c=E[C+1][0],l=E[C].slice(1),d=E[C+1].slice(1),u=o.core.Trig.segmentClosestPoint(t,l,d,a,c);(h=o.core.Vec.norm(o.core.Vec.sub(t,u.pt)))<f&&(f=h,p=u.u)}_=0;for(var S,T,b,w,x=1e-6,M=this._knots[0],N=this._knots[this._knots.length-1],A=this._controlPoints[0].equals(this._controlPoints[this._controlPoints.length-1],o.core.Constants.EPSILON),O=p;_<20;){S=o.eval.Eval.rationalCurveDerivatives(this._verbCurve.asNurbs(),O,2);for(const e of S)e.length>t.length&&e.splice(t.length);T=o.core.Vec.sub(S[0],t);var I=o.core.Vec.norm(T),D=o.core.Vec.dot(S[1],T)/(o.core.Vec.norm(S[1])*I),L=I<x,V=Math.abs(D)<1e-7;if(L&&V)return O;var R=(b=S,w=T,O-o.core.Vec.dot(b[1],w)/(o.core.Vec.dot(b[2],w)+o.core.Vec.dot(b[1],b[1])));if(R<M?R=A?N-(R-M):M:R>N&&(R=A?M+(R-N):N),o.core.Vec.norm(o.core.Vec.mul(R-O,S[1]))<x)return O;O=R,_++}return O}getTangentAt(e){const t=this.getDomain();let n;t instanceof E.PeriodInterval&&(e>t.max+_.Tolerance.CALCULATE_EPS||e<t.min-_.Tolerance.CALCULATE_EPS)?n=t.getRegularParam(e,_.Tolerance.CALCULATE_EPS):(n=e,P.MathError.warn(t.containsPoint(e,_.Tolerance.CALCULATE_EPS),"nurbs getTangentAt: 参数超出参数域"));const r=this._verbCurve.tangent(n);return new c.Vector3(r[0],r[1],r[2]).normalize()}getDerivatives(e,t){const n=this.getDomain();let r;return n instanceof E.PeriodInterval&&(e>n.max+_.Tolerance.CALCULATE_EPS||e<n.min-_.Tolerance.CALCULATE_EPS)?r=n.getRegularParam(e,_.Tolerance.CALCULATE_EPS):(r=e,n.containsPoint(e,_.Tolerance.CALCULATE_EPS)||P.MathError.warn("nurbs getDerivatives: 参数超出参数域")),this._verbCurve.derivatives(r,t).map((e=>new c.Vector3(e)))}getTangentCone(e,t=!0){const n=e||this._range,r=n.min,s=n.max,i=this.getDomain();if(s<i.min||r>i.max)return new p.TangentCone(c.Vector3.O(),0);const o=this.clone();let a;if(r<i.min){a=o.splitCurve(s)[0]}else if(r<i.min){a=o.splitCurve(r)[1]}else{a=o.splitCurve(r)[1].splitCurve(r)[0]}const l=_.Tolerance.LENGTH_EPS*_.Tolerance.LENGTH_EPS,d=new p.TangentCone(c.Vector3.O(),0),u=a.getControlPoints();let h=1;for(;h<u.length;){const e=u[h].subtracted(u[h-1]);if(e.getSqLength()>l){d.dir=e;break}h++}if(h===u.length)d.dir=c.Vector3.X(),d.angle=0;else for(h++;h<u.length;){const e=u[h].subtracted(u[h-1]);e.getSqLength()>l&&d.mergeCone(e),h++}return d}getEqualDiversionPts(e=3){g.MathAssert.assert(e>=3,"getEqualDiversionPts，请传入大于3的数字",e);const t=[],n=this.getLength(),r=n/(e-1);for(let e=0;e<=n;e+=r){const n=this.getPtAt(e);t.push(n)}return t}getKontIndex(e,t=_.Tolerance.LENGTH_EPS){let n=0;for(;n<this._knots.length-1&&!(e>this._knots[n]-t&&e<=this._knots[n+1]-t);n++);return n}getMultiplicityOfKnot(e,t,n=_.Tolerance.LENGTH_EPS){let r=0;if(Math.abs(e-this._knots[t])<n){r++;for(let s=t+1;s<this._knots.length&&Math.abs(e-this._knots[s])<n;s++)r++}else if(Math.abs(e-this._knots[t+1])<n)for(let s=t+2;s<this._knots.length&&Math.abs(e-this._knots[s])<n;s++)r++;return r}insertKnot(e,t=_.Tolerance.LENGTH_EPS){const n=this.getDomain(),r=n instanceof E.PeriodInterval?n.getRegularParam(e):e;if(r<n.min+t||r>n.max-t)return;const s=this.getKontIndex(e,t),i=this._newCtrlPtsAtInsertKnot(s,r),a=this._degree;this._knots.splice(s+1,0,r),this._controlPoints.splice(s-a+1,a-1,...i),this._weights.splice(s-a+1,0,1);const c=[];i.map((e=>c.push([e.x,e.y,e.z])));const l=this._verbCurve.controlPoints();l.splice(s-a+1,a-1,...c),this._verbCurve=o.geom.NurbsCurve.byKnotsControlPointsWeights(a,this._knots,l,this._weights)}insertMultiKnot(e,t,n=_.Tolerance.LENGTH_EPS){const r=this.getDomain(),s=r instanceof E.PeriodInterval?r.getRegularParam(e):e;if(s<r.min+n||s>r.max-n)return;const i=this._degree,a=this.getKontIndex(e,n),c=this.getMultiplicityOfKnot(s,a,n),l=this._newCtrlPtsAtInsertMultiKnot(a,s,t,c),d=new Array(t);d.fill(s);const u=new Array(t);u.fill(1),this._knots.splice(a+1,0,...d),this._controlPoints.splice(a-i+1,i-c-1,...l),this._weights.splice(a-i+1,0,...u);const h=[];l.map((e=>h.push([e.x,e.y,e.z])));const g=this._verbCurve.controlPoints();g.splice(a-i+1,i-c-1,...h),this._verbCurve=o.geom.NurbsCurve.byKnotsControlPointsWeights(i,this._knots,g,this._weights)}insertKnots(e,t=_.Tolerance.LENGTH_EPS){}getBox(e){const t=e||this._range,n=t.getLength(),r=this.getDomain();if(t.containsInterval(r))return new C.Box3(this._controlPoints);r instanceof E.PeriodInterval&&(t.min=r.getRegularParam(t.min),t.max=t.min+n);const s=this._degree,i=this.getKnots().slice(),o=this.getControlPoints().slice();let a=this.getKontIndex(t.min);if(t.min-this.getDomain().min>_.Tolerance.NUMBER_EPS&&t.min-this.getDomain().max<-_.Tolerance.NUMBER_EPS){const e=this.getMultiplicityOfKnot(t.min,a),n=this._degree-e,r=this._newCtrlPtsAtInsertMultiKnot(a,t.min,n,e),i=new Array(n);i.fill(t.min),this._knots.splice(a+1,0,...i),this._controlPoints.splice(a-s+1,s-e-1,...r),a=a-s+n}else a-=s;let c=this.getKontIndex(t.max);if(t.max-this.getDomain().min>_.Tolerance.NUMBER_EPS&&t.max-this.getDomain().max<-_.Tolerance.NUMBER_EPS){const e=this.getMultiplicityOfKnot(t.max,c),n=this._degree-e,r=this._newCtrlPtsAtInsertMultiKnot(c,t.max,n,e),i=new Array(n);i.fill(t.max),this._knots.splice(c+1,0,...i),this._controlPoints.splice(c-s+1,s-e-1,...r),c=c-s+n}else c-=s;const l=this.getControlPoints().slice(a,c+1);return this._knots=i,this._controlPoints=o,new C.Box3(l)}knotRefinement(e=!1){const t=this._degree,n=this.getKnots(),r=this.getDomain().getLength()/10;for(let e=t;e<n.length-t+1&&(n[e+1]-n[e]>r&&(this.insertKnot((n[e+1]+n[e])/2),e--),!(n.length>30));e++);}splitCurve(e,t=!0){const n=this.getDomain(),s=n instanceof E.PeriodInterval?n.getRegularParam(e):e,i=this._verbCurve.split(s);if(i.length<2)return g.MathAssert.warn(!0,"NurbsCurve 分割错误：参数有误",s),[];const a=i[0].knots();let l=1;for(let e=a.length-2;e>=0;e--)f.Util.isNearlyEqual(a[e],a[a.length-1])&&l++;if(l>i[0].degree()+1){const e=i[0].controlPoints();for(let t=0;t<l-i[1].degree()-1;t++){const t=e.length;new c.Vector3(e[t-1]).equals(new c.Vector3(e[t-2]))&&(e.pop(),a.pop())}i[0]=o.geom.NurbsCurve.byKnotsControlPointsWeights(i[0].degree(),a,e)}const d=i[1].knots();let u=1;for(let e=1;e<d.length;e++)f.Util.isNearlyEqual(d[e],d[0])&&u++;if(u>i[1].degree()+1){const e=i[1].controlPoints();for(let t=0;t<u-i[1].degree()-1;t++)new c.Vector3(e[0]).equals(new c.Vector3(e[1]))&&(e.splice(0,1),d.splice(0,1));i[1]=o.geom.NurbsCurve.byKnotsControlPointsWeights(i[1].degree(),d,e)}if(t){const e=this._verbCurve.point(this._range.min),t=this._verbCurve.point(this._range.max),n=this._verbCurve.point(s),o=i[0].closestParam(e),a=i[0].closestParam(n),c=i[1].closestParam(n),l=i[1].closestParam(t);return[new r(i[0],[o,a]),new r(i[1],[c,l])]}return[new r(i[0]),new r(i[1])]}reverse(){const e=this.getRange(),t=this.getDomain(),n=Math.abs(e.min-t.min)<_.Tolerance.NUMBER_EPS,r=Math.abs(e.max-t.max)<_.Tolerance.NUMBER_EPS;this._verbCurve=this._verbCurve.reverse(),this._updateParameters();const s=this.getDomain(),i=n?s.max:s.max-(e.min-t.min),o=r?s.min:t.max-e.max+s.min;return this._range.set(o,i),this}clone(){return new r(this._verbCurve.clone(),this._range.toArray())}getLength(e){const t=e||this._range,n=this._verbCurve.lengthAtParam(t.min);return this._verbCurve.lengthAtParam(t.max)-n}transform(e){const t=e.data||e,n=new m.Matrix4(t).transpose().data;return this._verbCurve=this._verbCurve.transform(n),this._updateParameters(),this}discrete(e=h.DiscreteParameter.NORMAL){return y.DiscreteUtil.discreteCurve3d(this,e)}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_NURBS_CURVE_3D}dump(){const e=this._controlPoints.map((e=>e.toArray3()));let t=!0;const n=this._weights[0];for(const e of this._weights)if(e!==n){t=!1;break}return{type:d.EN_GEO_ELEMENT_TYPE.EN_NURBS_CURVE_3D,data:[this._degree,e,this.isBezier()?[]:[...this._knots],t?[]:[...this._weights],this._range.toArray()]}}load({data:[e,t,n,s,i]}){const a=0===n.length?r.getBezierKnots(e):n,c=0===s.length?new Array(t.length).fill(1):s;this._verbCurve=o.geom.NurbsCurve.byKnotsControlPointsWeights(e,a,t,c),this._updateParameters();const d=this._controlPoints[0],u=this._controlPoints[this._controlPoints.length-1];if(d.sqDistanceTo(u)<_.Tolerance.LENGTH_EPS2){const e=this._verbCurve.domain();this._range=new E.PeriodInterval(i[0],i[1],e.max-e.min)}else this._range=new l.Interval(i[0],i[1]);return this}_updateParameters(){this._degree=this._verbCurve.degree(),this._knots=this._verbCurve.knots(),this._weights=this._verbCurve.weights(),this._controlPoints=this._verbCurve.controlPoints().map((e=>new c.Vector3(e)))}_newCtrlPtsAtInsertKnot(e,t){const n=[];for(let r=e-this._degree+1;r<=e;r++)n.push((t-this._knots[r])/(this._knots[r+this._degree]-this._knots[r]));const r=[];for(let t=e-this._degree+1;t<=e;t++){const s=n[t-(e-this._degree+1)],i=this._controlPoints[t].multiplied(s).add(this._controlPoints[t-1].multiplied(1-s));r.push(i)}return r}_newCtrlPtsAtInsertMultiKnot(e,t,n,r){const s=this._degree;P.MathError.warn(n+r<=s,"插入节点重复度太多");const i=Math.min(n,s-r),o=[];let a=this._controlPoints.slice(e-s,e-r+1);for(let n=1;n<=i;n++){const i=[];let c=1;for(let o=e-s+n;o<=e-r;o++){const e=(t-this._knots[o])/(this._knots[o+s-n+1]-this._knots[o]),r=a[c].multiplied(e).add(a[c-1].multiplied(1-e));i.push(r),c++}a=i,o.push(i)}const c=[];for(const e of o)c.push(e[0]);for(let e=o.length-1;e>=0;e--){const t=o[e];t.length<2||c.push(t[t.length-1])}return c}};S=r=s([u.registerLoader,i("design:paramtypes",[Object,Array])],S),t.NurbsCurve3d=S},737:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.NurbsSurface=void 0;const o=n(68894),a=n(61226),c=n(97505),l=n(13982),d=n(56973),u=n(97935),h=n(6688),g=n(33218),f=n(93145),p=n(67996),_=n(61210),m=n(44757),v=n(60229),E=n(97700),P=n(26773),y=n(43640),C=n(32858),S=n(48448),T=n(4097),b=n(5804),w=n(49246);let x=r=class extends u.Surface{constructor(e,t,n,r,s,i){if(super(),this._singularities=[],e instanceof o.geom.NurbsSurface)this._verbSurface=e,this._updateParameters();else if(t&&n&&r&&s){const a=s.map((e=>e.map((e=>[e.x,e.y,e.z]))));this._verbSurface=o.geom.NurbsSurface.byKnotsControlPointsWeights(e,t,n,r,a,i),this._updateParameters()}}static byLoftingCurves(e,t=3){const n=this._buildSimplePlane(e);if(void 0!==n)return n;const s=[];for(const t of e)if(t.isLine()){const e=t.getStartPt(),n=t.getEndPt();s.push(o.geom.NurbsCurve.byPoints([[e.x,e.y,e.z],[n.x,n.y,n.z]],1))}else if(t.isArc3d()){const e=t.getCenter(),n=t.getCoord().getDx().normalize().multiplied(t.getA()),r=t.getCoord().getDy().normalize().multiplied(t.getB()),i=t.getRange();s.push(new o.geom.EllipseArc([e.x,e.y,e.z],[n.x,n.y,n.z],[r.x,r.y,r.z],i.min,i.max))}else if(t.isNurbsCurve3d()){const e=o.geom.NurbsCurve.byKnotsControlPointsWeights(t.getDegree(),t.getKnots(),t.getControlPoints().map((e=>[e.x,e.y,e.z])),t.getWeights()),n=t.getRange();let r=e;if(n.min>t.getKnots()[0]){const t=e.split(n.min);r=t[t.length-1]}if(n.max<t.getKnots()[t.getKnots().length-1]){const e=r.split(n.max);r=e[0]}s.push(r)}else{const e=t.discrete();s.push(o.geom.NurbsCurve.byPoints(e.map((e=>[e.x,e.y,e.z]))))}return s.length>3?new r(o.geom.NurbsSurface.byLoftingCurves(s,t)):new r(o.geom.NurbsSurface.byLoftingCurves(s))}static makeByInterpolatePts(e,t,n){const s=[],i=[],o=[];for(const n of e){const e=f.NurbsCurve3d.makeByInterpolationPoints(n,t);o.push(e)}const a=[];o.map((e=>a.push(e.getControlPoints())));const c=o[0].getKnots(),l=[];for(let e=0;e<a[0].length;e++){const t=[];a.map((n=>t.push(n[e])));const r=f.NurbsCurve3d.makeByInterpolationPoints(t,n);l.push(r)}l.map((e=>s.push(e.getControlPoints()))),l.map((e=>i.push(e.getWeights())));const d=l[0].getKnots();return new r(t,n,c,d,s,i)}static makeByKnotsControlPointsWeights(e,t,n,s,i,o){return new r(e,t,n,s,i,o)}static makeByCorners(e,t,n,s){return new r(o.geom.NurbsSurface.byCorners([e.x,e.y,e.z],[t.x,t.y,t.z],[n.x,n.y,n.z],[s.x,s.y,s.z]))}static _buildSimplePlane(e){if(e.length<2)return;for(const t of e)if(!t.isLine())return;const t=[];for(let n=0;n<e.length-1;++n){const r=e[n].getStartTangent().cross(e[n+1].getStartTangent()),s=e[n].getStartTangent().cross(e[n+1].getStartPt().subtracted(e[n].getStartPt()));t.push(r),t.push(s)}for(let e=0;e<t.length;++e)for(let n=e+1;n<t.length;++n)if(!w.Util.isNearlyZero(t[e].cross(t[n]).getLength()))return;const n=e[0].getStartPt();let r;return r=w.Util.isNearlyZero(e[1].getStartPt().subtracted(e[0].getStartPt()).getLength())?e[0].getStartTangent().cross(e[1].getEndPt().subtracted(e[0].getEndPt())):e[0].getStartTangent().cross(e[1].getStartPt().subtracted(e[0].getStartPt())),new b.Plane(n,r)}getDegreeU(){return this._degreeU}getDegreeV(){return this._degreeV}getKnotsU(){return this._knotsU}getKnotsV(){return this._knotsV}getKnotsUInRange(e){const t=e||this.getDomainU(),n=this._degreeU,r=[];for(let e=n;e<this._knotsU.length-n;e++)t.containsPoint(this._knotsU[e])&&r.push(this._knotsU[e]);return r}getKnotsVInRange(e){const t=e||this.getDomainV(),n=this._degreeV,r=[];for(let e=n;e<this._knotsV.length-n;e++)t.containsPoint(this._knotsV[e])&&r.push(this._knotsV[e]);return r}getControlPoints(){return this._controlPoints}getWeights(){return this._weights}getDomainU(){const e=this._verbSurface.domainU();let t=!0;const n=this._controlPoints;for(let e=0;e<n[0].length;e++)if(!n[0][e].equals(n[n.length-1][e])){t=!1;break}return t?new P.PeriodInterval(e.min,e.max,e.max-e.min):new h.Interval(e.min,e.max)}getDomainV(){const e=this._verbSurface.domainV();let t=!0;const n=this._controlPoints;for(const e of n)if(!e[0].equals(e[e.length-1])){t=!1;break}return t?new P.PeriodInterval(e.min,e.max,e.max-e.min):new h.Interval(e.min,e.max)}addSingularPoints(e){this._singularities.push(...e)}getSingularPointInfos(){return this._singularities}getSingularPoints(){return this._singularities.map((e=>e.pt))}getPtAt(e){const t=this.getDomainU(),n=t instanceof P.PeriodInterval?t.getRegularParam(e.x):e.x,r=this.getDomainV(),s=r instanceof P.PeriodInterval?r.getRegularParam(e.y):e.y,i=this._verbSurface.point(n,s);return new a.Vector3(i)}getNormAt(e){const t=this.getDerivatives(e,1);return t[1].cross(t[2]).normalize()}getUVAt(e){let t;const n=new a.Vector3(e),r=this._controlPoints.length,s=this._controlPoints[0].length,i=this.getDomainU().getLength()/r,o=this.getDomainV().getLength()/s;for(let e=0;e<r;e++){const r=e*i;for(let e=0;e<s;e++){const s=e*o,i=new g.Vector2(r,s),a=this.getUVTry(n,i);if(a)if(t){const e=this.getPtAt(a),r=e.sqDistanceTo(n);r<t.sqrDist&&(t={uv:a,footPt:e,sqrDist:r})}else{const e=this.getPtAt(a);t={uv:a,footPt:e,sqrDist:e.sqDistanceTo(n)}}}}if(t)return t.uv;const c=this._verbSurface.closestParam([e.x,e.y,e.z]);return new g.Vector2(c)}uvInDomains(e){const t=this._verbSurface.domainU();if(!new h.Interval(t.min,t.max).containsPoint(e.x))return!1;const n=this._verbSurface.domainV();return new h.Interval(n.min,n.max).containsPoint(e.y)}getUVTry(e,t,n=d.Tolerance.ANGLE_EPS,r=d.Tolerance.LENGTH_EPS){const s=Math.sin(r),i=n*n,o=this.getDomainU(),a=this.getDomainV();let c=!1;const l={x:t.x,y:t.y};let u=0;for(;u<v.CONST.NORMAL_ITER_NUM;u++){const t=this.getDerivatives(l,2),n=t[0].subtracted(e),r=[n.dot(t[1]),n.dot(t[2])];if(n.getSqLength()<i){c=!0;break}if(Math.abs(r[0]/t[1].getLength())<s&&Math.abs(r[1]/t[2].getLength())<s){c=!0;break}const o=t[1].dot(t[1])+n.dot(t[3]),a=t[2].dot(t[1]),u=[[o,a],[a,t[2].dot(t[2])+n.dot(t[5])]];if(Math.abs(u[0][0]*u[1][1]-u[0][1]*u[1][0])<d.Tolerance.CALCULATE_EPS){c=!1;break}const h=E.LinearSystem.execute(u,r);if(void 0===h){c=!1;break}l.x-=h[0],l.y-=h[1]}if(c&&o.containsPoint(l.x)&&a.containsPoint(l.y))return o instanceof P.PeriodInterval&&(l.x=o.getRegularParam(l.x)),a instanceof P.PeriodInterval&&(l.y=a.getRegularParam(l.y)),new g.Vector2(l)}getCurve2d(e){const t=e.discrete(y.DiscreteParameter.LOW),n=this.getCurve2dForIsoCurve(t);if(n)return n;if(e.isNurbsCurve3d()&&this.isNurbsSurface()){const n=this.getUVAt(t[0]),r=n=>{if(e.getControlPoints().length===n.getControlPoints().length){const t=e.getControlPoints(),r=[...n.getControlPoints()];t[0].equals(r[0])||r.reverse();let s=!0;for(let e=0;e<t.length;e++){const n=t[e],i=r[e];if(!n.equals(i)){s=!1;break}}if(s)return!0}for(let r=0;r<t.length;r+=2){if(!n.containsPoint(t[r]))return!1;if(0===r){const s=e.getStartTangent(),i=n.getTangentAt(n.getParamAt(t[r]));s.dot(i)<0&&n.reverse()}}return!0};Math.abs(n.x)<d.Tolerance.NUMBER_EPS?n.x=0:Math.abs(n.x-1)<d.Tolerance.NUMBER_EPS&&(n.x=1);if(r(this.getIsoCurve(n.x,!1))){const e=this.getUVAt(t[t.length-1]);if(Math.abs(n.x-e.x)<d.Tolerance.LENGTH_EPS)return new C.Line2d(n,e);if(Math.abs(n.x-e.x)>d.Tolerance.LENGTH_EPS&&this.isUPeriodic()){const t=this.getDomainU().period;if(Math.abs((e.x-n.x)/t-1)<d.Tolerance.LENGTH_EPS)return e.x=n.x,new C.Line2d(n,e)}}Math.abs(n.y)<d.Tolerance.NUMBER_EPS?n.y=0:Math.abs(n.y-1)<d.Tolerance.NUMBER_EPS&&(n.y=1);if(r(this.getIsoCurve(n.y,!0))){const e=this.getUVAt(t[t.length-1]);if(Math.abs(n.y-e.y)<d.Tolerance.LENGTH_EPS)return new C.Line2d(n,e);if(Math.abs(n.y-e.y)>d.Tolerance.LENGTH_EPS&&this.isVPeriodic()){const t=this.getDomainU().period;if(Math.abs((e.y-n.y)/t-1)<d.Tolerance.LENGTH_EPS)return e.y=n.y,new C.Line2d(n,e)}}}const r=this.getAllUVsForCurvePts(t,1e-6,1e-6);let s=r[r.length-1].subtracted(r[0]);s.isZero()&&(s=r[1].subtracted(r[0]));const i=s.normalized();let o=!0;for(let e=1;e<r.length;e++){const t=r[e].subtracted(r[0]).normalize();if(!i.isParallel(t,d.Tolerance.ANGLE_EPS)){o=!1;break}}if(o){return new C.Line2d(r[0],i,[0,s.getLength()])}return S.NurbsCurve2d.makeByInterpolationPoints(r)}getAllUVsForCurvePts(e,t=d.Tolerance.NUMBER_EPS,n=d.Tolerance.NUMBER_EPS){function r(e){const t=[];for(let n=1;n<e.length;n++)t.push(e[n]-e[n-1]);return Math.max(...t)/2}const s=r(this.getKnotsU()),i=r(this.getKnotsV()),o=(e,r,o)=>{const a=this.getDerivatives(o,1),c=e.subtracted(r),l={x:o.x,y:o.y};l.x+=c.dot(a[1])/a[1].getSqLength(),l.y+=c.dot(a[2])/a[2].getSqLength();return this.getUVNearParam(e,l,t,n,s,i)},a=[],c=this.getUVAt(e[0]);a.push(c);let l=c;for(let t=1;t<e.length;t++){const n=o(e[t],e[t-1],l);a.push(n),l=n}return a}getDerivatives(e,t=1){const n=[],r=this.getDomainU(),s=r instanceof P.PeriodInterval?r.getRegularParam(e.x):e.x,i=this.getDomainV(),o=i instanceof P.PeriodInterval?i.getRegularParam(e.y):e.y,c=this._verbSurface.derivatives(s,o,t);for(let e=0;e<c.length;e++)for(let t=0;t<=e;t++)n.push(new a.Vector3(c[e-t][t]));return n}getBoundingBox(){let e=new p.Box3;if(this._controlPoints.length<2)return e;e=new p.Box3(this._controlPoints[0]);for(let t=1;t<this._controlPoints.length;t++)e.union(new p.Box3(this._controlPoints[t]));return e}getBox(e,t){if(!e&&!t){const e=new p.Box3;for(const t of this._controlPoints)e.union(new p.Box3(t));return e}const n=e||this.getDomainU(),r=t||this.getDomainV(),s=[this.getIsoCurve(r.min,!0),this.getIsoCurve(r.getMid(),!0),this.getIsoCurve(r.max,!0)];for(const e of s)e.setRange(n);const i=[this.getIsoCurve(n.min,!1),this.getIsoCurve(n.getMid(),!1),this.getIsoCurve(n.max,!1)];for(const e of i)e.setRange(r);const o=new p.Box3;for(const e of s)o.union(e.getBoundingBox());for(const e of i)o.union(e.getBoundingBox());return o}reverse(e=!1){this._verbSurface.reverse(e),this._updateParameters()}getIsoCurve(e,t){const n=this._verbSurface.isocurve(e,t);return new f.NurbsCurve3d(n)}containsCurve(e,t=d.Tolerance.LENGTH_EPS){return m.MathAssert.warn(!0,"NurbsSurface: containsCurve not implemented"),!1}isCoplanar(e,t=new d.Tolerance){return m.MathAssert.warn(!0,"NurbsSurface: isCoplanar not implemented"),!1}transform(e){const t=_.Matrix4.make(e,!0).transpose().data;return this._verbSurface=this._verbSurface.transform(t),this._updateParameters(),this._singularities.map((t=>t.pt.transform(e))),this}jointNurbsSurface(e,t=1){const n=this._controlPoints,s=this._knotsU,i=this._knotsV,o=this._weights,a=e.getControlPoints(),c=e.getKnotsU(),l=e.getKnotsV(),u=e.getWeights();if(1===t){T.MathError.assert(i.length===l.length,"不能拼接");let e=!0;for(let t=0;t<i.length;t++)if(Math.abs(i[t]-l[t])>d.Tolerance.LENGTH_EPS){e=!1;break}T.MathError.assert(e,"不能拼接");const t=s[s.length-1];s.pop();for(const e of c){const n=e+t;s.push(n)}n.pop(),a.map((e=>n.push(Array.from(e)))),o.pop(),u.map((e=>o.push(Array.from(e))));return new r(this._degreeU,this._degreeV,s,i,n,o)}if(4===t){T.MathError.assert(s.length===c.length,"不能拼接");let e=!0;for(let t=0;t<i.length;t++)if(Math.abs(s[t]-c[t])>d.Tolerance.LENGTH_EPS){e=!1;break}T.MathError.assert(e,"不能拼接");const t=i[i.length-1];i.pop();for(let e=this._degreeV+1;e<l.length;e++)i.push(l[e]+t);for(let e=0;e<n.length;e++)n[e].pop(),n[e]=n[e].concat(a[e]),o[e].pop(),o[e]=o[e].concat(u[e]);return new r(this._degreeU,this._degreeV,s,i,n,o)}if(2===t){return new r(this._degreeU,this._degreeV,s,i,n,o)}return new r(this._degreeU,this._degreeV,s,i,n,o)}getType(){return c.EN_GEO_ELEMENT_TYPE.EN_NURBS_SURFACE}discrete(){const e=this._verbSurface.tessellate();return{vertices:e.points.map((e=>[e[0],e[1],e[2]])),faces:e.faces.map((e=>[e[0],e[1],e[2]])),normals:e.normals.map((e=>[e[0],e[1],e[2]])),uvs:e.uvs.map((e=>[e[0],e[1]]))}}dump(){const e=this._controlPoints.map((e=>e.map((e=>e.data))));return{type:c.EN_GEO_ELEMENT_TYPE.EN_NURBS_SURFACE,data:[this._degreeU,this._degreeV,this._knotsU,this._knotsV,e,this._weights]}}load({data:[e,t,n,r,s,i]}){return this._verbSurface=o.geom.NurbsSurface.byKnotsControlPointsWeights(e,t,n,r,s,i),this._updateParameters(),this}clone(){const e=new r(this._verbSurface);for(const t of this._singularities)e._singularities.push({pt:t.pt.clone(),param:t.param,uvSign:t.uvSign});return e}_updateParameters(){this._controlPoints=this._verbSurface.controlPoints().map((e=>e.map((e=>new a.Vector3(e))))),this._degreeU=this._verbSurface.degreeU(),this._degreeV=this._verbSurface.degreeV(),this._knotsU=this._verbSurface.knotsU(),this._knotsV=this._verbSurface.knotsV(),this._weights=this._verbSurface.weights()}};x=r=s([l.registerLoader,i("design:paramtypes",[Object,Number,Array,Array,Array,Array])],x),t.NurbsSurface=x},57249:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.OffsetCurve2d=void 0;const o=n(22283),a=n(33218),c=n(6688),l=n(43640),d=n(60229),u=n(97505),h=n(13982),g=n(17165),f=n(94954),p=n(68990),_=n(32858),m=n(10909),v=n(26773),E=n(26581),P=n(56973),y=n(48448),C=n(49246);let S=r=class extends p.Curve2d{constructor(e,t=0,n){super(),e&&(this._baseCurve=e,this._offset=t,this._updateParamMapper(),this._initRange(n))}static makeByOffset(e,t=0){if(e instanceof _.Line2d){const n=e.getOrigin(),r=e.getDirection(),s={x:n.x+r.y*t,y:n.y-r.x*t};return new _.Line2d(s,r,e.getRange().toArray())}if(e instanceof m.Arc2d&&e.isEqualAB()){const n=t+(e.getA()+e.getB())/2;return new m.Arc2d(e.getCoord(),n,n,e.isCCW(),e.getRange().toArray())}if(e instanceof r){const n=e.getOffset()+t,s=new r(e.getBaseCurve().clone(),n);if(!e.getStartPt().equals(e.getEndPt(),P.Tolerance.LENGTH_EPS)){const t=e.getParamMapper(),n=e.getRange(),r=t.getBaseParam(n.min,!1),i=t.getBaseParam(n.max,!0),o=s.getParamMapper(),a=o.getParam(r),c=o.getParam(i);s.setRange(a,c)}return s}return new r(e.clone(),t)}getBaseCurve(){return this._baseCurve}getParamMapper(){return this._paramMapper}getDomain(){if(this._baseCurve instanceof y.NurbsCurve2d&&!this.isPeriodic()){const e=this._baseCurve.getDomain();return new c.Interval(e.min,e.max)}return this._paramMapper.getDomain()}isPeriodic(){const e=this._baseCurve;if(e instanceof m.Arc2d&&Math.abs(e.getRange().getLength()-d.CONST.PI2)<P.Tolerance.ANGLE_EPS)return!0;if(e instanceof y.NurbsCurve2d){const t=e.getControlPoints();if(t[0].sqDistanceTo(t[t.length-1])<P.Tolerance.LENGTH_EPS2)return!0}return!1}isLineLike(){return this._baseCurve.isLineLike()}getOffset(){return this._offset}setOffset(e){const t=this._startSettingChange();this._offset=e,this._updateParamMapper(),this._endSettingChange(t)}getPtAt(e){const t=this._paramMapper.getBaseParam(e),n=this._baseCurve.getPtAt(t),r=this._baseCurve.getTangentAt(t).normalize();return n.add({x:r.y*this._offset,y:-r.x*this._offset})}getParamAt(e){const t=[this._range.min,this._range.max];if(t.push(...this.getSingularities()),this._baseCurve.isPeriodic()&&!this.isPeriodic()){const e=this._baseCurve.getDomain();t.push(e.min,e.max)}for(const n of t)if(this.getPtAt(n).equals(e))return n;const n=this._baseCurve.getParamAt(e),r=this._paramMapper.getParam(n),s=this._range;return s instanceof v.PeriodInterval?s.getRegularParam(r):r}getAllFootParams(e,t=P.Tolerance.LENGTH_EPS){const n=this._baseCurve.getAllFootParams(e,t),r=[];for(const e of n){const t=this._paramMapper.getParamInfo(e);t.type===f.ParamType.Normal&&r.push(t.param)}return r}getDerivatives(e,t,n){const r=this._getSnapToPrevious(e,n),s=this._paramMapper.getBaseParam(e,r),i=this._baseCurve.getDerivatives(s,t+1,r),o=(e,t)=>{const n=this._offset*t;return new a.Vector2(e.y*n,-e.x*n)},c=i[1].getSqLength(),l=Math.sqrt(c),d=o(i[1],1/l),u=[i[0].added(d)];if(t<=0)return u;const h=i[1].dot(i[2]),g=o(i[2],c).subtract(o(i[1],h)),f=c*l;if(u.push(i[1].added(g.multiplied(1/f))),t<=1)return u;const p=i[1].dot(i[3])+i[2].dot(i[2]),_=3*l*h,m=o(i[3],c).add(o(i[2],h)).add(o(i[1],-p)).multiplied(f).subtract(g.multiplied(_)).multiply(1/(f*f));if(u.push(i[2].added(m)),t<=2)return u;const v=i[1].dot(i[4])+3*i[2].dot(i[3]),E=3*h*h/l+3*l*v,P=o(i[4],c).add(o(i[3],3*h)).subtract(o(i[1],v)).multiplied(f).subtract(g.multiplied(E)).multiply(1/(f*f)),y=m.multiplied(-2*_/f);if(u.push(i[3].added(P).add(y)),t<=3)return u;throw new Error("unimplemented: Offset Curve derivatives: nth > 3 not supported yet")}getSingularities(){const e=this._paramMapper.getSingularities();return this._range.filterParams(e)}getContinuousRanges(){const e=this._paramMapper.getSingularities();return this._range.splited(...e)}reverse(){const e=this._range instanceof v.PeriodInterval&&this._range.isClosed(),{min:t,max:n}=this._range,r=this._baseCurve.getPtAt(this._paramMapper.getBaseParam(t)),s=this._baseCurve.getPtAt(this._paramMapper.getBaseParam(n));this._baseCurve.reverse(),this._offset=-this._offset,this._updateParamMapper();const i=this._baseCurve.getParamAt(s),o=this._paramMapper.getParam(i,!1),a=this._paramMapper.getPeriod();if(e)this._range=new v.PeriodInterval(o,o+a,a);else{let e=this._baseCurve.getParamAt(r);const t=this._baseCurve.getRange();C.Util.isNearlyBiggerOrEqual(i,e)&&t instanceof v.PeriodInterval&&(e+=t.period);const n=this._paramMapper.getParam(e,!0);this._range=a>0?new v.PeriodInterval(o,n,a):new c.Interval(o,n)}return this}offset(e){return this._offset+=e,!0}toNurbs(e=3,t=P.Tolerance.LENGTH_EPS){const n=this.getSingularities();n.sort();const r=this._range,s=r.clone(),i=[];let o=r;for(const e of n){const t=o.splited(e);i.push(t[0]),o=t[1]}i.push(o);const a=[];for(const n of i){this.setRange(n);const r=this.getInterpPts(t).pts,s=y.NurbsCurve2d.makeByInterpolationPoints(r,e);a.push(s)}if(this.setRange(s),1===a.length)return a[0];let c=[],l=[],d=[];for(const t of a)if(0===l.length)l=t.getControlPoints(),d=t.getWeights(),c=t.getKnots();else{c.pop(),l.pop(),d.pop(),l=l.concat(t.getControlPoints()),d=d.concat(t.getWeights());const n=c[c.length-1];for(let r=e+1;r<t.getKnots().length;r++)c.push(t.getKnots()[r]+n)}return y.NurbsCurve2d.makeByControlPoints(l,e,c,d)}transform(e,t){const n=t||E.Matrix3.make(e,!1).decompose();return E.Matrix3.assertScaleEqual(n.scale),this._baseCurve.transform(e,n),this._offset*=n.scale.x,this}transformed(e,t){const n=t||E.Matrix3.make(e,!1).decompose();if(Math.abs(Math.abs(n.scale.y/n.scale.x)-1)<P.Tolerance.NUMBER_EPS){const t=this._baseCurve.clone();t.transform(e,n);const s=this._offset*n.scale.x;return new r(t,s)}const s=this.toNurbs();return s.transform(e),s}discrete(e=l.DiscreteParameter.NORMAL){const t=this.getContinuousRanges(),n=this._range,r=t.map((t=>(this._range=t,g.DiscreteUtil.discreteCurve2d(this,e)))),s=r.length?r[0]:[];for(let e=1;e<r.length;e++)s.push(...r[e].slice(1));return this._range=n,s}getType(){return u.EN_GEO_ELEMENT_TYPE.EN_OFFSET_CURVE_2D}clone(){return new r(this._baseCurve.clone(),this._offset,this._range.toArray())}dump(){return{type:this.getType(),data:[this._baseCurve.dump(),this._offset,this._range.toArray()]}}load({data:[e,t,n]}){return this._offset=t,this._baseCurve=o.Loader.load(e),this._updateParamMapper(),this._initRange(n),this}_refineDegerateTangent(e,t,n){const r=this._paramMapper.getBaseParam(e,t),s=this._baseCurve.getTangentAt(r,t);return s.isParallel(n,P.Tolerance.ROUGH_ANGLE_EPS)?s.multiply(Math.sign(s.dot(n))):n}_updateParamMapper(){if(this._paramMapper=new f.OffsetParameterMapper,this._baseCurve instanceof m.Arc2d){const e=this._baseCurve,t=this._baseCurve.isCCW()?this._offset:-this._offset;this._paramMapper=f.OffsetParameterMapper.ByArc(this,e,t)}else this._baseCurve.isPeriodic()&&(this._paramMapper=f.OffsetParameterMapper.periodicBaseCurve(this,this._offset))}_initRange(e){if(e)this._range=v.PeriodInterval.make(e[0],e[1],this._paramMapper.getPeriod());else{const e=this._baseCurve.getRange();this._range=this._paramMapper.getRange(e)}}_startSettingChange(){if(this._range instanceof v.PeriodInterval&&this._range.isClosed())return this._baseCurve.getRange().toArray();return[this._paramMapper.getBaseParam(this._range.min,!1),this._paramMapper.getBaseParam(this._range.max,!0)]}_endSettingChange(e){this._range=this._paramMapper.getRange(e)}};S=r=s([h.registerLoader,i("design:paramtypes",[p.Curve2d,Number,Array])],S),t.OffsetCurve2d=S},53487:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.OffsetCurve3d=void 0;const o=n(22283),a=n(6688),c=n(43640),l=n(4097),d=n(97505),u=n(13982),h=n(17165),g=n(94954),f=n(2111),p=n(61226),_=n(97602),m=n(87222),v=n(26773),E=n(61210),P=n(68956),y=n(34410),C=n(56973),S=n(93145),T=n(49246),b=n(60229);let w=r=class extends f.Curve3d{constructor(e,t,n=0,r=0,s){super(),e&&t&&(this._baseCurve=e,this._dz=t.clone(),this._offsetXY=n,this._offsetZ=r,this._updateParamMapper(),this._initRange(s))}static makeByOffset(e,t,n,s=0){if(e instanceof m.Line3d){const r=e.getDirection(),i=t.multiplied(s).add(r.cross(t).multiply(n));return new m.Line3d(e.getOrigin().added(i),e.getDirection(),e.getRange().toArray())}if(e instanceof _.Arc3d&&e.isEqualAB()&&t.isParallel(e.getNormal())){const r=t.dot(e.getNormal()),i=e.getRadius()+n*r;return new _.Arc3d(e.getCoord().translated(t.multiplied(s)),i,i,e.getRange().toArray())}if(e instanceof r){l.MathError.warn((()=>e.getDz().isParallel(t)),"Offset: none parralleled offset unsupported",l.MathErrorType.Unimplemented);const i=e.getDz().dot(t),o=e.getOffsetXY()+i*n,a=e.getOffsetZ()+i*s;if(Math.abs(o)<C.Tolerance.CALCULATE_EPS&&Math.abs(a)<C.Tolerance.CALCULATE_EPS)return e.getBaseCurve().clone();const c=new r(e.getBaseCurve().clone(),t,o,a);if(!e.getStartPt().equals(e.getEndPt(),C.Tolerance.LENGTH_EPS)){const t=e.getParamMapper(),n=e.getRange(),r=t.getBaseParam(n.min,!1),s=t.getBaseParam(n.max,!0),i=c.getParamMapper(),o=i.getParam(r),a=i.getParam(s);c.setRange(o,a)}return c}return new r(e.clone(),t,n,s)}static makeByTargetPoint(e,t){if(e instanceof m.Line3d){const n=e.getParamAt(t),r=e.getPtAt(n),s=new p.Vector3(t).subtract(r);return new m.Line3d(e.getStartPt().added(s),e.getStartTangent(),e.getRange().toArray())}let n,s=P.PointToCurve3dDistance.execute(t,e);const i=e.getRange();if(T.Util.isNearlyEqual(s.param,i.min)){n=e.getStartTangent();const r=new m.Line3d(e.getStartPt(),n,a.Interval.infinitArray());s=P.PointToCurve3dDistance.simple(t,r)}else if(T.Util.isNearlyEqual(s.param,i.max)){n=e.getEndTangent();const r=new m.Line3d(e.getEndPt(),e.getEndTangent(),a.Interval.infinitArray());s=P.PointToCurve3dDistance.simple(t,r)}else n=e.getTangentAt(s.param);const o=new p.Vector3(t).subtract(s.foot),c=y.CurveUtil.getDzByCurve(e,o),l=c.dot(o),d=n.cross(c).dot(o);return r.makeByOffset(e,c,d,l)}getBaseCurve(){return this._baseCurve}getParamMapper(){return this._paramMapper}getDomain(){if(this._baseCurve instanceof S.NurbsCurve3d&&!this.isPeriodic()){const e=this._baseCurve.getDomain();return new a.Interval(e.min,e.max)}return this._paramMapper.getDomain()}isLineLike(){return this._baseCurve.isLineLike()}getOffsetXY(){return this._offsetXY}setOffsetXY(e){const t=this._startSettingChange();this._offsetXY=e,this._updateParamMapper(),this._endSettingChange(t)}getOffsetZ(){return this._offsetZ}setOffsetZ(e){this._offsetZ=e}getDz(){return this._dz.clone()}getPtAt(e){const t=this._paramMapper.getBaseParam(e),n=this._baseCurve.getPtAt(t),r=this._baseCurve.getTangentAt(t).normalize().cross(this._dz).multiply(this._offsetXY);return n.add(r).add(this._dz.multiplied(this._offsetZ))}getParamAt(e){const t=[this._range.min,this._range.max];if(t.push(...this.getSingularities()),this._baseCurve.isPeriodic()&&!this.isPeriodic()){const e=this._baseCurve.getDomain();t.push(e.min,e.max)}for(const n of t)if(this.getPtAt(n).equals(e))return n;const n=this._range;if(this._baseCurve.isExtendCurve3d()){const t=this._baseCurve.getAllFootParams(e).map((e=>this._paramMapper.getParam(e)));let r,s=b.CONST.MAX_INTEGER;for(const i of t){const t=this.getPtAt(i).sqDistanceTo(e);if(t<s){if(t<C.Tolerance.CALCULATE_EPS2)return n instanceof v.PeriodInterval?n.getRegularParam(i):i;r=i,s=t}}if(void 0!==r)return n instanceof v.PeriodInterval?n.getRegularParam(r):r}const r=this._baseCurve.getParamAt(e),s=this._paramMapper.getParam(r);return n instanceof v.PeriodInterval?n.getRegularParam(s):s}isPlaneCurve3d(e=C.Tolerance.ANGLE_EPS){return this.getBaseCurve().isPlaneCurve3d(e)}getAllFootParams(e,t=C.Tolerance.LENGTH_EPS){const n=this._baseCurve.getAllFootParams(e,t),r=[];for(const e of n){const t=this._paramMapper.getParamInfo(e);t.type===g.ParamType.Normal&&r.push(t.param)}return r}getDerivatives(e,t,n){const r=this._getSnapToPrevious(e,n),s=this._paramMapper.getBaseParam(e,r),i=this._baseCurve.getDerivatives(s,t+1,r),o=(e,t)=>e.cross(this._dz).multiply(this._offsetXY*t),a=i[1].getSqLength(),c=Math.sqrt(a),l=o(i[1],1/c),d=this._dz.multiplied(this._offsetZ),u=[i[0].added(l).add(d)];if(t<=0)return u;const h=i[1].dot(i[2]),g=o(i[2],a).subtract(o(i[1],h)),f=a*c;if(u.push(i[1].added(g.multiplied(1/f))),t<=1)return u;const p=i[1].dot(i[3])+i[2].dot(i[2]),_=3*c*h,m=o(i[3],a).add(o(i[2],h)).add(o(i[1],-p)).multiplied(f).subtract(g.multiplied(_)).multiply(1/(f*f));if(u.push(i[2].added(m)),t<=2)return u;const v=i[1].dot(i[4])+3*i[2].dot(i[3]),E=3*h*h/c+3*c*v,P=o(i[4],a).add(o(i[3],3*h)).subtract(o(i[1],v)).multiplied(f).subtract(g.multiplied(E)).multiply(1/(f*f)),y=m.multiplied(-2*_/f);if(u.push(i[3].added(P).add(y)),t<=3)return u;throw new Error("unimplemented: Offset Curve derivatives: nth > 3 not supported yet")}getSingularities(){const e=this._paramMapper.getSingularities();return this._range.filterParams(e)}getContinuousRanges(){const e=this._paramMapper.getSingularities();return this._range.splited(...e)}reverse(){const e=this._range instanceof v.PeriodInterval&&this._range.isClosed(),{min:t,max:n}=this._range,r=this._baseCurve.getPtAt(this._paramMapper.getBaseParam(t)),s=this._baseCurve.getPtAt(this._paramMapper.getBaseParam(n));this._baseCurve.reverse(),this._offsetXY=-this._offsetXY,this._updateParamMapper();const i=this._baseCurve.getParamAt(s),o=this._paramMapper.getParam(i,!1),c=this._paramMapper.getPeriod();if(e)this._range=new v.PeriodInterval(o,o+c,c);else{let e=this._baseCurve.getParamAt(r);const t=this._baseCurve.getRange();T.Util.isNearlyBiggerOrEqual(i,e)&&t instanceof v.PeriodInterval&&(e+=t.period);const n=this._paramMapper.getParam(e,!0);this._range=c>0?new v.PeriodInterval(o,n,c):new a.Interval(o,n)}return this}toNurbs(e=3,t=C.Tolerance.LENGTH_EPS){const n=this.getSingularities();n.sort();const r=this._range,s=r.clone(),i=[];let o=r;for(const e of n){const t=o.splited(e);i.push(t[0]),o=t[1]}i.push(o);const a=[];for(const n of i){this.setRange(n);const r=this.getInterpPts(t).pts,s=S.NurbsCurve3d.makeByInterpolationPoints(r,e);a.push(s)}if(this.setRange(s),1===a.length)return a[0];let c=[],l=[],d=[];for(const t of a)if(0===l.length)l=t.getControlPoints(),d=t.getWeights(),c=t.getKnots();else{c.pop(),l.pop(),d.pop(),l=l.concat(t.getControlPoints()),d=d.concat(t.getWeights());const n=c[c.length-1];for(let r=e+1;r<t.getKnots().length;r++)c.push(t.getKnots()[r]+n)}return S.NurbsCurve3d.makeByControlPoints(l,e,c,d)}transform(e,t){const n=t||E.Matrix4.make(e,!1).decompose();return E.Matrix4.assertScaleEqual(n.scale),this._baseCurve.transform(e,n),this._dz.vecTransform(e).normalize(),this._offsetXY*=n.scale.x,this._offsetZ*=n.scale.y,this}transformed(e,t){const n=t||E.Matrix4.make(e,!1).decompose();if(E.Matrix4.isScaleEqual(n.scale)){const t=this._baseCurve.clone();t.transform(e,n);const s=this._dz.vecTransformed(e).normalize(),i=this._offsetXY*n.scale.x,o=this._offsetZ*n.scale.y;return new r(t,s,i,o)}const s=this.toNurbs();return s.transform(e),s}discrete(e=c.DiscreteParameter.NORMAL){const t=this.getContinuousRanges(),n=this._range,r=t.map((t=>(this._range=t,h.DiscreteUtil.discreteCurve3d(this,e)))),s=r.length?r[0]:[];for(let e=1;e<r.length;e++)s.push(...r[e].slice(1));return this._range=n,s}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_OFFSET_CURVE_3D}clone(){return new r(this._baseCurve.clone(),this._dz,this._offsetXY,this._offsetZ,this._range.toArray())}dump(){return{type:this.getType(),data:[this._baseCurve.dump(),this._dz.toArray3(),this._offsetXY,this._offsetZ,this._range.toArray()]}}load({data:[e,t,n,r,s]}){return this._baseCurve=o.Loader.load(e),this._dz=new p.Vector3(t),this._offsetXY=n,this._offsetZ=r,this._updateParamMapper(),this._initRange(s),this}_refineDegerateTangent(e,t,n){const r=this._paramMapper.getBaseParam(e,t),s=this._baseCurve.getTangentAt(r,t);return s.isParallel(n,C.Tolerance.ROUGH_ANGLE_EPS)?s.multiplied(Math.sign(s.dot(n))):n}_updateParamMapper(){if(this._paramMapper=new g.OffsetParameterMapper,this._baseCurve instanceof _.Arc3d){const e=this._baseCurve,t=this._offsetXY*this._dz.dot(e.getNormal());this._paramMapper=g.OffsetParameterMapper.ByArc(this,e,t)}else this._baseCurve.isPeriodic()&&(this._paramMapper=g.OffsetParameterMapper.periodicBaseCurve(this,this._offsetXY))}_initRange(e){if(e)this._range=v.PeriodInterval.make(e[0],e[1],this._paramMapper.getPeriod());else{const e=this._baseCurve.getRange();this._range=this._paramMapper.getRange(e)}}_startSettingChange(){if(this._range instanceof v.PeriodInterval&&this._range.isClosed())return this._baseCurve.getRange().toArray();return[this._paramMapper.getBaseParam(this._range.min,!1),this._paramMapper.getBaseParam(this._range.max,!0)]}_endSettingChange(e){this._range=this._paramMapper.getRange(e)}};w=r=s([u.registerLoader,i("design:paramtypes",[f.Curve3d,p.Vector3,Number,Number,Array])],w),t.OffsetCurve3d=w},94954:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OffsetParameterMapper=t.ParamType=void 0;const r=n(60229),s=n(26773),i=n(44757),o=n(6688),a=n(49246),c=n(56973),l=n(52716),d=n(21728),u=n(53487);var h,g;!function(e){e[e.None=0]="None",e[e.Previous=1]="Previous",e[e.Next=2]="Next"}(h||(h={})),function(e){e[e.Normal=0]="Normal",e[e.Reversed=1]="Reversed",e[e.StartGap=2]="StartGap",e[e.MidGap=3]="MidGap",e[e.EndGap=4]="EndGap"}(g=t.ParamType||(t.ParamType={}));class f{constructor(e,t=0,n=0,r=[]){this._domains=e,this._period=t,this._basePeriod=n,this._singularities=r}static ByArc(e,t,n){const i=t.getA(),o=t.getB(),a=o*o/i,d=i*i/o;if(n>-Math.min(a,d))return new f(void 0,r.CONST.PI2,r.CONST.PI2,[]);if(n<-Math.max(i,o)){const e={min:0,baseMin:0,length:r.CONST.PI2,isReversed:!0};return new f([e],r.CONST.PI2,r.CONST.PI2,[])}const u=n=>e.getDerivatives(n,1)[1].dot(t.getTangentAt(n)),g=((e,t)=>{const n=s.PeriodInterval.RegularizeParam(t-e)+e;return l.SolveEquationUtil.quadraticInterpolation(u,e,n)})(0,r.CONST.PI_2),p=[g,r.CONST.PI-g,r.CONST.PI+g,r.CONST.PI2-g,r.CONST.PI2+g];if(n<-Math.min(i,o)){const e=i>o?1:0,t=[];for(let n=0;n<4;n++)t.push({min:p[n],baseMin:p[n],length:p[n+1]-p[n],isReversed:n%2===e});return new f(t,r.CONST.PI2,r.CONST.PI2,p)}function _(e,n,r,i){const o=e.length,a=(n+o-1)%o,l=e[a],d=e[n],u=l.baseMin+l.length,g=s.PeriodInterval.RegularizeParam(d.baseMin-u),f=t.getRange(),p=s.PeriodInterval.RegularizeParam(f.min-u),_=s.PeriodInterval.RegularizeParam(f.max-u),m=p>c.Tolerance.NUMBER_EPS&&p<g-c.Tolerance.NUMBER_EPS;if(m===(_>c.Tolerance.NUMBER_EPS&&_<g-c.Tolerance.NUMBER_EPS))return h.None;if(m){const t=s.PeriodInterval.RegularizeParam(d.baseMin-i-c.Tolerance.NUMBER_EPS);d.baseMin=i,d.length+=t;for(let r=n+1;r<o;r++)e[r].min+=t;return h.Next}{const t=s.PeriodInterval.RegularizeParam(r-u-c.Tolerance.NUMBER_EPS);l.length+=t;for(let n=a+1;n<o;n++)e[n].min+=t;return h.Previous}}const m=-n;let v,E,P;if(i>o){const e=(Math.pow(i/o*m,2)-o*o)/(i*i-o*o),t=Math.asin(Math.pow(e,.5)),n=r.CONST.PI-2*t;v=[{baseMin:t,min:0,length:n,isReversed:!1},{baseMin:r.CONST.PI+t,min:n,length:n,isReversed:!1}],E=_(v,0,p[3],p[0]),P=_(v,1,p[1],p[2])}else{const e=(Math.pow(o/i*m,2)-i*i)/(o*o-i*i),t=Math.acos(Math.pow(e,.5));v=[{baseMin:r.CONST.PI-t,min:0,length:2*t,isReversed:!1},{baseMin:r.CONST.PI2-t,min:2*t,length:2*t,isReversed:!1}],E=_(v,0,p[0],p[1]),P=_(v,1,p[2],p[3])}if(E&&P)return E===h.Previous?(v[1].min=0,new f([v[1]],0,r.CONST.PI2,[])):new f([v[0]],0,r.CONST.PI2,[]);if(E)return new f(v,0,r.CONST.PI2,[v[0].length]);if(P)return v[1].min=0,v[0].min=v[1].length,v[0].baseMin+=r.CONST.PI2,new f([v[1],v[0]],0,r.CONST.PI2,[v[1].length]);const y=v[0].length;return new f(v,2*y,r.CONST.PI2,[0,y])}static periodicBaseCurve(e,t){const n=e.getBaseCurve(),i=n.getDomain();let o;if(!(i instanceof s.PeriodInterval))return new f;o=i.period;const a=n.getTangentAt(i.min,!1),l=n.getTangentAt(i.max,!0);if(a.equals(l))return new f(void 0,o,o);let d;if(e instanceof u.OffsetCurve3d){const t=e.getDz();d=l.angleTo(a,t)}else d=l.angleTo(a);if(d<r.CONST.PI&&t<0||d>r.CONST.PI&&t>0){const t=i.min,r=i.max;let s;if(n.isNurbsCurve()&&e.setRange(t,r),e.isOffsetCurve3d()){const t=f._calcSelfIntersect(e,c.Tolerance.DEFAULT);if(t){const e=[t.param1,t.param2];e[0]>e[1]&&([e[0],e[1]]=[e[1],e[0]]);const n=e[1]-e[0];s={baseMin:e[0],min:0,length:n,isReversed:!1}}}else if(e.isOffsetCurve2d()){const t=f._calcSelfIntersect(e,c.Tolerance.DEFAULT);if(t){const e=[t.param1,t.param2];e[0]>e[1]&&([e[0],e[1]]=[e[1],e[0]]);const n=e[1]-e[0];s={baseMin:e[0],min:0,length:n,isReversed:!1}}}if(s)return new f([s],s.length,o,[s.min])}return new f}static Simple(){return new f}static _calcSelfIntersect(e,t){const n=e.getBaseCurve(),r=n.getDomain(),i=r.min,o=r.max,a=t=>{const n=e.getDerivatives(t[0],1),r=e.getDerivatives(t[1],1),s=n[0].subtracted(r[0]);return[s.dot(n[1]),s.dot(r[1])]},l=t=>{const n=e.getDerivatives(t[0],2),r=e.getDerivatives(t[1],2),s=n[0].subtracted(r[0]);return[[n[1].dot(n[1])+s.dot(n[2]),-r[1].dot(n[1])],[n[1].dot(r[1]),-r[1].dot(r[1])+s.dot(r[2])]]},u=(t,n)=>{t[0]=s.PeriodInterval.RegularizeParam(t[0],r.period),t[1]=s.PeriodInterval.RegularizeParam(t[1],r.period);const i=e.getPtAt(t[0]),o=e.getPtAt(t[1]);return i.sqDistanceTo(o)<n*n},h=n.getDomain().getLength()/11;for(let n=0;n<5;n++){const r=i+n*h;for(let n=0;n<5;n++){const s=o-n*h;if(e.isOffsetCurve3d()){const n=d.NonlinearSystem.execute(a,l,[r,s],t.lengthEps,t.angleEps,u);if(n.length>0&&Math.abs(n[1]-n[0])>c.Tolerance.NUMBER_EPS){return{point:e.getPtAt(n[0]),param1:n[0],param2:n[1]}}}else if(e.isOffsetCurve2d()){const n=d.NonlinearSystem.execute(a,l,[r,s],t.lengthEps,t.angleEps,u);if(n.length>0&&Math.abs(n[1]-n[0])>c.Tolerance.NUMBER_EPS){return{point:e.getPtAt(n[0]),param1:n[0],param2:n[1]}}}}}}getBaseParam(e,t=!0,n=c.Tolerance.CALCULATE_EPS){if(!this._domains)return e;const r=this._period>0?s.PeriodInterval.RegularizeParam(e,this._period):e;let o;if(t){if(this._period>0&&r<n){const e=this._domains[this._domains.length-1];return e.baseMin+e.length}o=n}else{if(this._period>0&&r>this._period-n)return this._domains[0].baseMin;o=-n}for(const e of this._domains){const t=r-e.min;if(t<e.length+o)return e.baseMin+t}i.MathAssert.warn(!0,"Invalid t",e);const a=this._domains[this._domains.length-1];return e-a.min+a.baseMin}getParam(e,t=!0){return this.getParamInfo(e,t).param}getParamInfo(e,t=!0){if(!this._domains)return{param:e,type:g.Normal};const n=this._basePeriod>0?s.PeriodInterval.RegularizeParam(e,this._basePeriod,this._domains[0].baseMin):e,r=this._basePeriod>0?(e-n)/this._basePeriod*this._period:0;for(let e=0;e<this._domains.length;e++){const t=this._domains[e],s=n-t.baseMin;if(s<0)return{param:t.min+r,type:0===e?g.StartGap:g.MidGap};if(s<=t.length)return{param:s+t.min+r,type:t.isReversed?g.Reversed:g.Normal}}if(0===this._basePeriod||t){const e=this._domains[this._domains.length-1];return{param:e.min+e.length+r,type:0===this._period?g.EndGap:g.MidGap}}return{param:this._domains[0].min+r,type:0===this._period?g.StartGap:g.MidGap}}isPeriod(){return this._period>0}getPeriod(){return this._period}getBasePeriod(){return this._basePeriod}getRange(e){const[t,n]=e instanceof o.Interval?e.toArray():e,r=this.getParam(t,!1),i=this.getParam(n,!0);if(this._period>0){const e=a.Util.isNearlyEqual(r,i,c.Tolerance.NUMBER_EPS)&&n-t>this._basePeriod/2?r+this._period:i;return new s.PeriodInterval(r,e,this._period)}return new o.Interval(r,i)}getSingularities(){return this._singularities.slice(0)}getDomain(){if(!this._domains)return this._period?new s.PeriodInterval(0,this._period,this._period):o.Interval.infinit();const e=this._domains[this._domains.length-1];return this._period?new s.PeriodInterval(this._domains[0].min,e.min+e.length,this._period):new o.Interval(this._domains[0].min,e.min+e.length)}clone(){var e;const t=null===(e=this._domains)||void 0===e?void 0:e.map((e=>({min:e.min,baseMin:e.baseMin,length:e.length,isReversed:e.isReversed})));return new f(t,this._period,this._basePeriod,this._singularities.slice(0))}}t.OffsetParameterMapper=f},78680:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.OffsetSurface=void 0;const o=n(13982),a=n(97935),c=n(33218),l=n(44757),d=n(56973),u=n(97505),h=n(22283),g=n(43640),f=n(61210),p=n(47423),_=n(737),m=n(53487),v=n(34410),E=n(5804),P=n(29453),y=n(49246),C=n(24013),S=n(57249),T=n(4097),b=n(93145);let w=r=class extends a.Surface{constructor(e,t=0){super(),e&&(this._baseSurface=e,this._offset=t),this.simplify()}static make(e,t){if(e instanceof E.Plane){const n=e.getNorm();return e.clone().translate(n.multiplied(t))}if(e instanceof P.Cylinder){const n=e.getA(),s=e.getB();return y.Util.isNearlyEqual(n,s)?new P.Cylinder(e.getCoord(),n+t,s+t):new r(e,t)}if(e instanceof C.Cone){const n=e.getA(),s=e.getB();if(y.Util.isNearlyEqual(n,s)){const r=e.getH(),i=n/Math.sqrt(n*n+r*r),o=n+t/(i*s/n),a=r+t/i;return new C.Cone(e.getCoord(),o,o,a)}return new r(e,t)}if(e instanceof p.SweepSurface){const n=e.getProfile(),r=S.OffsetCurve2d.makeByOffset(n,t);return p.SweepSurface.make(e.getPath(),r,e.getPathDz()).surface}return new r(e,t)}simplify(){for(;this._baseSurface instanceof r;){const e=this._baseSurface;this._baseSurface=e.getBaseSurface(),this._offset+=e.getOffset()}return this}getBaseSurface(){return this._baseSurface}getOffset(){return this._offset}setBaseSurface(e){this._baseSurface=e}setOffset(e){this._offset=e}getDomainU(){return this._baseSurface.getDomainU()}getDomainV(){return this._baseSurface.getDomainV()}isUPeriodic(){return this._baseSurface.isUPeriodic()}isVPeriodic(){return this._baseSurface.isVPeriodic()}getPtAt(e){const t=this._baseSurface.getDerivatives(e,1),n=t[1].cross(t[2]).normalize();return t[0].added(n.multiplied(this._offset))}getUVAt(e){return this._baseSurface.getUVAt(e)}getNormAt(e){return this._baseSurface.getNormAt(e)}getIsoCurve(e,t){if(this._baseSurface instanceof _.NurbsSurface){const n=[],r=t?this.getDomainU():this.getDomainV(),s=t?new c.Vector2(r.min,e):new c.Vector2(e,r.min);n.push(this.getPtAt(s));let i=r.min;for(;i>r.max;){const r=t?new c.Vector2(i,e):new c.Vector2(e,i),s=this.getDerivatives(r,2);if(n.push(this.getPtAt(r)),n.length>200){T.MathError.warn("NurbsSurface offset: getIsoCurve is not precise");break}i+=1/(6*(t?s[3]:s[5]).getLength())}const o=t?new c.Vector2(r.max,e):new c.Vector2(e,r.max);return n.push(this.getPtAt(o)),b.NurbsCurve3d.makeByInterpolationPoints(n)}if(this._baseSurface instanceof p.SweepSurface){const n=this._baseSurface.getPath();if(t){const r=this._baseSurface.getIsoCurve(e,t);return m.OffsetCurve3d.makeByOffset(r,n.getTangentAt(e),this._offset,0)}const r=v.CurveUtil.getDzByCurve(n,this._baseSurface.getPathDz());if(r){const n=this._baseSurface.getIsoCurve(e,t),s=this._baseSurface.getProfile().getTangentAt(e),i=new c.Vector2(s.y,-s.x),o=i.x*this._offset,a=i.y*this._offset;return m.OffsetCurve3d.makeByOffset(n,r,o,a)}throw new Error("unimplemented: NurbsSurface offset.getIsoCurve: not implemented")}const n=this._baseSurface.getIsoCurve(e,t);let r;t||(this._baseSurface instanceof P.Cylinder||this._baseSurface instanceof C.Cone)&&(r=this._baseSurface.getNormAt(new c.Vector2(e,0)));const s=v.CurveUtil.getDzByCurve(n,r);return m.OffsetCurve3d.makeByOffset(n,s,this._offset,0)}getDerivatives(e,t,n,r){const s=this._baseSurface.getDerivatives(e,t+1),i=s[1].cross(s[2]),o=i.normalized(),a=[s[0].added(o.multiplied(this._offset))];if(t<=0)return a;const c=1/i.getLength(),l=c*c*c,d=s[3].cross(s[2]).add(s[1].cross(s[4])),u=-i.dot(d)*l,h=d.multiplied(c).add(i.multiplied(u)),g=s[4].cross(s[2]).add(s[1].cross(s[5])),f=-i.dot(g)*l,p=g.multiplied(c).add(i.multiplied(f)),_=s[1].added(h.multiplied(this._offset)),m=s[2].added(p.multiplied(this._offset));if(a.push(_),a.push(m),t<=1)return a;const v=l*c*c,E=s[6].cross(s[2]).add(s[3].cross(s[4]).multiply(2)).add(s[1].cross(s[7])),P=s[7].cross(s[2]).add(s[3].cross(s[5])).add(s[4].cross(s[4])).add(s[1].cross(s[8])),y=s[8].cross(s[2]).add(s[4].cross(s[5]).multiply(2)).add(s[1].cross(s[9])),C=i.dot(d),S=i.dot(g),T=d.dot(d)+i.dot(E),b=g.dot(d)+i.dot(P),w=g.dot(g)+i.dot(y),x=-3*C*v,M=-3*S*v,N=E.multiplied(c).add(d.multiplied(u)).subtract(d.multiplied(C).add(i.multiplied(T)).multiply(l)).subtract(i.multiplied(C*x)),A=P.multiplied(c).add(d.multiplied(f)).subtract(g.multiplied(C).add(i.multiplied(b)).multiply(l)).subtract(i.multiplied(C*M)),O=y.multiplied(c).add(g.multiplied(f)).subtract(g.multiplied(S).add(i.multiplied(w)).multiply(l)).subtract(i.multiplied(S*M)),I=s[3].added(N.multiplied(this._offset)),D=s[4].added(A.multiplied(this._offset)),L=s[5].added(O.multiplied(this._offset));if(a.push(I),a.push(D),a.push(L),t<=2)return a;const V=v*c*c,R=-5*C*V,U=-5*S*V,B=s[10].cross(s[2]).add(s[6].cross(s[4]).multiply(3)).add(s[3].cross(s[7]).multiply(3)).add(s[1].cross(s[11])),F=s[11].cross(s[2]).add(s[6].cross(s[5])).add(s[7].cross(s[4]).multiply(2)).add(s[3].cross(s[8]).multiply(2)).add(s[4].cross(s[7])).add(s[1].cross(s[12])),k=s[12].cross(s[2]).add(s[7].cross(s[5]).multiply(2)).add(s[3].cross(s[9])).add(s[8].cross(s[4])).add(s[4].cross(s[9]).multiply(2)).add(s[1].cross(s[13])),G=s[13].cross(s[2]).add(s[8].cross(s[5]).multiply(3)).add(s[4].cross(s[9]).multiply(3)).add(s[1].cross(s[14])),j=E.dot(d)+2*d.dot(E)+i.dot(B),z=P.dot(d)+d.dot(P)+g.dot(E)+i.dot(F),W=y.dot(d)+g.dot(P)+g.dot(P)+i.dot(k),q=y.dot(g)+2*g.dot(y)+i.dot(G),H=d.multiplied(2*C).add(i.multiplied(T)),Y=E.multiplied(2*C).add(d.multiplied(3*T)).add(i.multiplied(j)),X=P.multiplied(2*C).add(d.multiplied(2*b)).add(g.multiplied(T)).add(i.multiplied(z)),J=B.multiplied(c).add(E.multiplied(u)).subtract(Y.multiply(l)).subtract(H.multiply(x)).add(d.multiplied(3*C*C*v)).add(i.multiplied(6*C*T*v+3*C*C*R)),K=F.multiplied(c).add(E.multiplied(f)).subtract(X.multiplied(l)).subtract(H.multiply(M)).add(g.multiplied(3*C*C*v)).add(i.multiplied(6*C*b*v+3*C*C*U)),Z=d.multiplied(S).add(g.multiplied(C)).add(i.multiplied(b)),$=P.multiplied(S).add(d.multiplied(w)).add(y.multiplied(C)).add(g.multiplied(2*b)).add(i.multiplied(W)),Q=k.multiplied(c).add(P.multiplied(f)).subtract($.multiply(l)).subtract(Z.multiply(M)).add(g.multiplied(3*C*S*v)).add(i.multiplied(3*(b*S*v+C*w*v+C*S*U))),ee=g.multiplied(2*S).add(i.multiplied(w)),te=y.multiplied(2*S).add(g.multiplied(3*w)).add(i.multiplied(q)),ne=G.multiplied(c).add(y.multiplied(f)).subtract(te.multiply(l)).subtract(ee.multiply(M)).add(g.multiplied(3*S*S*v)).add(i.multiplied(6*S*w*v+3*S*S*U)),re=s[6].added(J.multiplied(this._offset)),se=s[7].added(K.multiplied(this._offset)),ie=s[8].added(Q.multiplied(this._offset)),oe=s[9].added(ne.multiplied(this._offset));if(a.push(re),a.push(se),a.push(ie),a.push(oe),t<=3)return a;throw new Error("unimplemented: Sweep Curve derivatives: n > 2 not supported yet")}transform(e,t){const n=t||f.Matrix4.make(e,!1).decompose();return f.Matrix4.assertScaleEqual(n.scale),this._baseSurface.transform(e,n),this._offset*=n.scale.z,this}transformed(e,t){const n=t||f.Matrix4.make(e,!1).decompose();if(f.Matrix4.isScaleEqual(n.scale))return this.clone().transform(e,n);const r=this.toNurbs();return r.transform(e),r}toNurbs(e,t=3,n=3,r=d.Tolerance.LENGTH_EPS){T.MathError.warn(!0,"not well complement");const s=this.getIsoCurve(0,!1),i=this.getIsoCurve(0,!0),o=[];for(const e of i.getInterpPts(r).params){const t=[];for(const n of s.getInterpPts(r).params){const r=this.getPtAt({x:n,y:e});t.push(r)}o.push(t)}return _.NurbsSurface.makeByInterpolatePts(o,t,n)}isCoplanar(e,t){return l.MathAssert.warn("SweepSurface.isCoplanar: not implemented"),!1}containsCurve(e,t){const n=e.discrete(g.DiscreteParameter.LOW);for(const e of n)if(!this.containsPoint(e))return!1;return!0}clone(){return new r(this._baseSurface.clone(),this._offset)}getType(){return u.EN_GEO_ELEMENT_TYPE.EN_OFFSET_SURFACE}dump(){return{type:this.getType(),data:[this._baseSurface.dump(),this._offset]}}load({data:[e,t]}){return this._baseSurface=h.Loader.load(e),this._offset=t,this}};w=r=s([o.registerLoader,i("design:paramtypes",[a.Surface,Number])],w),t.OffsetSurface=w},72883:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Parabola3d=void 0;const r=n(89494),s=n(6688),i=n(60229),o=n(33218),a=n(93145),c=n(17980),l=n(87222),d=n(2111),u=n(97505);class h extends d.Curve3d{constructor(e,t,n){super(),this._coord=new r.Coordinate3,void 0!==t&&e&&n&&(this._coord=e,this._f=t,this._range=n?new s.Interval(n[0],n[1]):new s.Interval(-i.CONST.MODEL_MAX_LENGTH,i.CONST.MODEL_MAX_LENGTH))}getPtAt(e){const t=new o.Vector2(e*e/(4*this._f),e);return this._coord.getWorldVectorAt(t)}getTangentAt(e){const t=new o.Vector2(e/(2*this._f),1);return this._coord.getWorldVectorAt(t)}getDerivatives(e,t){throw new Error("unimplemented")}getBoundingBox(e){throw new Error("unimplemented")}getParamAt(e){throw new Error("unimplemented")}getLength(e){throw new Error("unimplemented")}getType(){return u.EN_GEO_ELEMENT_TYPE.EN_PARABOLA_3D}reverse(){throw new Error("unimplemented")}split(e,t){throw new Error("unimplemented")}transform(e){throw new Error("unimplemented")}toBezier3d(){const e=this.getPtAt(this._range.min),t=this.getPtAt(this._range.max),n=this.getTangentAt(this._range.min),r=this.getTangentAt(this._range.max),s=[];s.push(e);const o=new l.Line3d(e,n,[i.CONST.MAX_NEG_INTEGER,i.CONST.MAX_INTEGER]),d=new l.Line3d(t,r,[i.CONST.MAX_NEG_INTEGER,i.CONST.MAX_INTEGER]),u=c.CurveCurveIntersect.curve3ds(o,d)[0].point;return s.push(u),s.push(t),a.NurbsCurve3d.makeBezier(s)}dump(){throw new Error("unimplemented")}load({data:[e,t,n]}){return this._f=t,this._coord.load(e),this._range=new s.Interval(n[0],n[1]),this}}t.Parabola3d=h},5804:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Plane=void 0;const o=n(89494),a=n(33218),c=n(61226),l=n(32858),d=n(87222),u=n(46182),h=n(49246),g=n(97505),f=n(13982),p=n(10909),_=n(97602),m=n(56973),v=n(67579),E=n(43364),P=n(74729),y=n(79890),C=n(93145),S=n(53487),T=n(9327),b=n(48448),w=n(24533),x=n(57249),M=n(6688),N=n(11067),A=n(737);let O=r=class extends u.CoordinateBasedSurface{static XOY(e=0){return new r(new c.Vector3(0,0,e),c.Vector3.X(),c.Vector3.Y())}static YOZ(e=0){return new r(new c.Vector3(e,0,0),c.Vector3.Y(),c.Vector3.Z())}static ZOX(e=0){return new r(new c.Vector3(0,e,0),c.Vector3.Z(),c.Vector3.X())}static makePlaneByTreePoints(e,t,n){const s=new c.Vector3(t).subtract(e).normalize(),i=new c.Vector3(n).subtract(e),o=i.subtract(s.multiplied(i.dot(s))).normalize();if(!h.Util.isNearlyZero(s.getLength())&&!h.Util.isNearlyZero(o.getLength()))return new r(e,s,o)}static makePlaneByPoints(e,t){const n=N.GeomUtil.createPlaneFromPoints(e);if(n){return r.makePlaneByPointNormal(e[0],n,t)}}static makePlaneByPointNormal(e,t,n){if(n&&!new c.Vector3(n).isParallel(t)){const s=new c.Vector3(t).cross(n),i=s.cross(t);return new r(e,i,s)}return new r(e,t)}constructor(e,t,n){super(),n?this._coord=new o.Coordinate3(e,t,n):t?this._coord=new o.Coordinate3(e,t):e&&(this._coord=e.clone())}getOrigin(){return this._coord.getOrigin()}getNorm(){return this._coord.getDz()}reverse(){return this._coord.setDy(this._coord.getDy().multiply(-1)),this}getUDir(){return this._coord.getDx().clone()}getVDir(){return this._coord.getDy().clone()}getPtAt(e){return this._coord.getWorldPtAt(e)}getNormAt(e){return this._coord.getDz()}getDerivatives(e,t=1){const n=[];if(n.push(this.getPtAt(e)),t>=1){n.push(this.getUDir()),n.push(this.getVDir());for(let e=2;e<=t;e++)for(let t=0;t<=e;t++)n.push(c.Vector3.O())}return n}getUVAt(e){const t=this._coord.getLocalPtAt(e);return new a.Vector2(t.x,t.y)}getLine3DByPts(e,t){const n=this.getPtAt(e),r=this.getPtAt(t);return new d.Line3d(n,r)}getLine3D(e){return this.getLine3DByPts(e.getStartPt(),e.getEndPt())}isRuled(){return!0}isParellel(e,t=m.Tolerance.ANGLE_EPS){return this._coord.getDz().isParallel(e._coord.getDz(),t)}isPerpendicular(e,t=m.Tolerance.ANGLE_EPS){return this._coord.getDz().isPerpendicular(e._coord.getDz(),t)}isCoplanar(e,t=new m.Tolerance){return!!e.isPlane()&&(this._coord.getDz().isParallel(e._coord.getDz(),t.angleEps)&&(this.containsPoint(e._coord.getOrigin(),t.lengthEps)||e.containsPoint(this._coord.getOrigin(),t.lengthEps)))}containsCurve(e,t=m.Tolerance.LENGTH_EPS,n=m.Tolerance.ANGLE_EPS){const r=e=>{if(e instanceof d.Line3d)return this.containsPoint(e.getStartPt(),t)&&this.containsPoint(e.getEndPt(),t);if(e instanceof _.Arc3d){let r=this.containsPoint(e.getCoord().getOrigin(),t);return r=r&&this._coord.getDz().isParallel(e.getCoord().getDz(),n),r}if(e instanceof C.NurbsCurve3d){const n=e.getControlPoints();for(const e of n)if(!this.containsPoint(e,t))return!1;return!0}return!1};if(e.isLine3d()||e.isArc3d()||e.isNurbsCurve3d())return r(e);if(e instanceof S.OffsetCurve3d){const n=e.getOffsetZ(),s=e.getBaseCurve();if(n<t)return r(s);return r(s.clone().translate(new c.Vector3(e.getDz().multiply(n))))}if(e instanceof T.ExtendCurve3d)return r(e.getBaseCurve());throw new Error("暂不支持该种类型")}getIsoCurve(e,t){if(t){const t=this.getUDir(),n=this.getPtAt(new a.Vector2(0,e));return new d.Line3d(n,t,M.Interval.infinitArray())}const n=this.getVDir(),r=this.getPtAt(new a.Vector2(e,0));return new d.Line3d(r,n,M.Interval.infinitArray())}getLine2D(e){const t=this.getUVAt(e.getStartPt()),n=this.getUVAt(e.getEndPt());if(!t.equals(n))return new l.Line2d(t,n)}getCurve2d(e){const t=this._coord;if(e instanceof d.Line3d){const n=t.getLocalPtAt(e.getStartPt()),r=t.getLocalPtAt(e.getEndPt());return new l.Line2d(n,r)}if(e instanceof _.Arc3d){const n=e,r=t.getLocalVectorAt(n.getCoord().getDx()),s=t.getLocalVectorAt(n.getCoord().getDy()),i=t.getLocalPtAt(n.getCoord().getOrigin()),o=new P.Coordinate2(i,r),a=n.getRange().toArray();return o.getDy().dot(s)>0?new p.Arc2d(o,n.getA(),n.getB(),!0,a):new p.Arc2d(o,n.getA(),n.getB(),!1,[a[0],a[1]])}if(e instanceof C.NurbsCurve3d){const n=e.getKnots(),r=e.getDegree(),s=e.getWeights(),i=e.getControlPoints().map((e=>t.getLocalPtAt(e))),o=e.getRange();return b.NurbsCurve2d.makeByControlPoints(i,r,n,s,o.toArray())}if(e instanceof S.OffsetCurve3d){const n=e.getBaseCurve(),r=e.getOffsetXY(),s=this.getCurve2d(n),i=Math.sign(e.getDz().dot(t.getDz()));return new x.OffsetCurve2d(s,r*i,e.getRange().toArray())}if(e instanceof T.ExtendCurve3d){const t=e.getBaseCurve(),n=this.getCurve2d(t);return new w.ExtendCurve2d(n,e.getRange().toArray())}if(e instanceof v.SmoothPoly3d){const n=e.getPoints().map((e=>t.getLocalPtAt(e)));return new E.SmoothPoly2d(n)}throw new Error("暂不支持该种类型")}getCurve3d(e){const t=this._coord;if(e instanceof l.Line2d)return this.getLine3D(e);if(e instanceof p.Arc2d){const n=new o.Coordinate3(t.getWorldPtAt(e.getCoord().getOrigin()),t.getWorldVectorAt(e.getCoord().getDx()),t.getWorldVectorAt(e.getCoord().getDy()).multiply(e.isCCW()?1:-1));return new _.Arc3d(n,e.getA(),e.getB(),e.getRange().toArray())}if(e instanceof b.NurbsCurve2d){const n=e.getKnots(),r=e.getDegree(),s=e.getWeights(),i=e.getControlPoints().map((e=>t.getWorldPtAt(e))),o=e.getRange();return C.NurbsCurve3d.makeByControlPoints(i,r,n,s,o.toArray())}if(e instanceof x.OffsetCurve2d){const n=e.getBaseCurve(),r=e.getOffset(),s=this.getCurve3d(n);return new S.OffsetCurve3d(s,t.getDz(),r,0,e.getRange().toArray())}if(e instanceof w.ExtendCurve2d){const t=e.getBaseCurve(),n=this.getCurve3d(t);return new T.ExtendCurve3d(n,e.getRange().toArray())}if(e instanceof E.SmoothPoly2d){const t=e.getPoints().map((e=>this._coord.getWorldPtAt(e)));return new v.SmoothPoly3d(t)}throw new Error("暂不支持该种类型")}transform(e){this._coord.transform(e);return y.isMirror(e)&&this._coord.setDx(this._coord.getDx().reverse()),this}toNurbs(e,t=1,n=1,r=m.Tolerance.LENGTH_EPS){const s=e?e[0]:this.getDomainU(),i=e?e[1]:this.getDomainV(),o=s.getLength()/t,a=i.getLength()/n,c=[];for(let e=0;e<=n;e++){const n=i.min+a*e,r=[];for(let e=0;e<=t;e++){const t=this.getPtAt({x:s.min+o*e,y:n});r.push(t)}c.push(r)}return A.NurbsSurface.makeByInterpolatePts(c,t,n)}clone(){return super.clone()}getType(){return g.EN_GEO_ELEMENT_TYPE.EN_PLANE}dump(){return{type:this.getType(),data:[this._coord.dump()]}}load({data:[e]}){return this._coord.load(e),this}};O=r=s([f.registerLoader,i("design:paramtypes",[Object,Object,Object])],O),t.Plane=O},58059:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PolylineFunction=t.Polyline=void 0;const r=n(65826),s=n(44757);class i{constructor(e,t){s.MathAssert.assert(e.length===t.length,"控制顶点与参数个数不同"),this._points=e,this._ts=t}get ts(){return this._ts}get points(){return this._points}getPtAt(e){const t=r.ArrayUtil.binarySearch(this._ts,e),n=this._ts[t],s=(e-n)/(this._ts[t+1]-n);return this._getInterpolator()(this._points[t],this._points[t+1],s)}}t.Polyline=i;t.PolylineFunction=class extends i{_getInterpolator(){return(e,t,n)=>e+(t-e)*n}}},43364:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SmoothPoly2d=void 0;const i=n(68990),o=n(33218),a=n(90361),c=n(97505),l=n(13982),d=n(56973),u=n(32858),h=n(6688),g=n(43640),f=n(49246),p=n(89009),_=n(4097);let m=class extends i.Curve2d{constructor(e){super(),this._pts=[],this._ts=[],e&&(this._pts=e.map((e=>new o.Vector2(e))),this._calParams())}getPoints(){return this._pts}getTs(){return this._ts}getSegments(){if(this._pts.length<2)return[];const e=[];for(let t=1;t<this._pts.length;t++)e.push(new u.Line2d(this._pts[t-1],this._pts[t]));return e}getPtAt(e){const t=this._getSegment(e),n=e-this._ts[t-1],r=this._ts[t]-this._ts[t-1];return f.Util.isNearlyZero(r,d.Tolerance.LENGTH_EPS)?this._pts[t]:this._pts[t-1].interpolated(this._pts[t],n/r)}getParamAt(e){if(this._pts.length<2)return 0;const t=new u.Line2d(this._pts[0],this._pts[1]);let n=p.PointToCurve2dDistance.simple(e,t);for(let t=1;t<this._pts.length;t++){const r=new u.Line2d(this._pts[t-1],this._pts[t]),s=p.PointToCurve2dDistance.simple(e,r);s.distance<n.distance&&(s.param+=this._ts[t-1],n=s)}return n.param}getTangentAt(e){const t=this._getSegment(e);return this._pts[t].subtracted(this._pts[t-1]).normalize()}getDerivatives(e,t){throw new Error("暂时还没有实现!")}getLength(e){return e?e.getLength():this._range.getLength()}reverse(){let e=0,t=this._pts.length-1;for(;e<t;e++,t--){const n=this._pts[t];this._pts[t]=this._pts[e],this._pts[e]=n;const r=-this._ts[t]+this._ts[this._ts.length-1];this._ts[t]=-this._ts[e]+this._ts[this._ts.length-1],this._ts[e]=r}return e===t&&(this._ts[e]=-this._ts[e]+this._ts[this._ts.length-1]),this._range=new h.Interval(this._ts[0],this._ts[this._ts.length-1]),this}offset(e){throw new Error("暂时还没有实现")}split(e,t){throw new Error("暂时还没有实现")}transform(e){for(let t=0;t<this._pts.length;t++)this._pts[t]=this._pts[t].transform(e);return this._calParams(),this}getBoundingBox(e){const t=new a.Box2,n=(e,t)=>{const n=e-this._ts[t-1],r=this._ts[t]-this._ts[t-1];return f.Util.isNearlyZero(r,d.Tolerance.LENGTH_EPS)?this._pts[t]:this._pts[t-1].interpolated(this._pts[t],n/r)},r=e||this._range,s=this._getSegment(r.min),i=n(r.min,s),o=this._getSegment(r.max),c=n(r.max,o);t.expandByPoint(c),t.expandByPoint(i);for(let e=s;e<o;e++)t.expandByPoint(this._pts[e]);return t}discrete(e=g.DiscreteParameter.NORMAL){const t=this._getSegment(this._range.min),n=this._getSegment(this._range.max),r=[this.getStartPt()];for(let e=t;e<n;e++)r.push(this._pts[e].clone());return r.push(this.getEndPt()),r}getType(){return c.EN_GEO_ELEMENT_TYPE.EN_SMOOTHPOLY_2D}clone(){return super.clone()}dump(){return{type:this.getType(),data:[this._pts.map((e=>e.toArray2()))]}}load({data:[e]}){return this._pts=e.map((e=>new o.Vector2(e))),this._calParams(),this}_getSegment(e){if(_.MathError.assert(this._pts.length>=2,"不合法的SmoothPoly"),2===this._pts.length)return 1;let t,n,r;for(n=0,r=this._ts.length-1;this._ts[n]===this._ts[n+1];)n++;for(;this._ts[r]===this._ts[r-1];)r--;for(;n+1<r;)if(t=Math.floor((n+r)/2),e<this._ts[t])for(r=t;this._ts[r]===this._ts[r-1];)r--;else for(n=t;this._ts[n]===this._ts[n+1];)n++;return r}_calParams(){this._ts=[0];for(let e=1;e<this._pts.length;){const t=this._pts[e].distanceTo(this._pts[e-1]);t<d.Tolerance.LENGTH_EPS?this._pts.splice(e,1):(this._ts.push(this._ts[e-1]+t),e++)}this._range=new h.Interval(this._ts[0],this._ts[this._ts.length-1])}};m=r([l.registerLoader,s("design:paramtypes",[Array])],m),t.SmoothPoly2d=m},67579:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SmoothPoly3d=void 0;const i=n(2111),o=n(61226),a=n(97505),c=n(67996),l=n(13982),d=n(56973),u=n(87222),h=n(6688),g=n(43640),f=n(49246),p=n(68956),_=n(4097);let m=class extends i.Curve3d{constructor(e,t){super(),this._pts=[],this._ts=[],e&&(this._pts=e.map((e=>new o.Vector3(e))),this._calParams()),t&&(this._curve=t)}getPoints(){return this._pts}getTs(){return this._ts}getCurve(){return this._curve}getSegments(){if(this._pts.length<2)return[];const e=[];for(let t=1;t<this._pts.length;t++)e.push(new u.Line3d(this._pts[t-1],this._pts[t]));return e}getPtAt(e){const t=this._getSegment(e),n=e-this._ts[t-1],r=this._ts[t]-this._ts[t-1];return f.Util.isNearlyZero(r,d.Tolerance.LENGTH_EPS)?this._pts[t]:this._pts[t-1].interpolated(this._pts[t],n/r)}getParamAt(e){if(this._pts.length<2)return 0;const t=new u.Line3d(this._pts[0],this._pts[1]);let n=p.PointToCurve3dDistance.simple(e,t);for(let t=1;t<this._pts.length;t++){const r=new u.Line3d(this._pts[t-1],this._pts[t]),s=p.PointToCurve3dDistance.simple(e,r);s.distance<n.distance&&(s.param+=this._ts[t-1],n=s)}return n.param}getTangentAt(e){const t=this._getSegment(e);return this._pts[t].subtracted(this._pts[t-1]).normalize()}getDerivatives(e,t){throw new Error("暂时还没有实现!")}getLength(e){return e?e.getLength():this._range.getLength()}reverse(){let e=0,t=this._pts.length-1;for(;e<t;e++,t--){const n=this._pts[t];this._pts[t]=this._pts[e],this._pts[e]=n;const r=-this._ts[t]+this._ts[this._ts.length-1];this._ts[t]=-this._ts[e]+this._ts[this._ts.length-1],this._ts[e]=r}return e===t&&(this._ts[e]=-this._ts[e]+this._ts[this._ts.length-1]),this._range=new h.Interval(this._ts[0],this._ts[this._ts.length-1]),this}offset(e){throw new Error("暂时还没有实现")}split(e,t){throw new Error("暂时还没有实现")}transform(e){for(let t=0;t<this._pts.length;t++)this._pts[t]=this._pts[t].transform(e);return this._calParams(),this}getBoundingBox(e){if(1===this._pts.length)return new c.Box3(this._pts);const t=new c.Box3,n=(e,t)=>{const n=e-this._ts[t-1],r=this._ts[t]-this._ts[t-1];return f.Util.isNearlyZero(r,d.Tolerance.LENGTH_EPS)?this._pts[t]:this._pts[t-1].interpolated(this._pts[t],n/r)},r=e||this._range,s=this._getSegment(r.min),i=n(r.min,s),o=this._getSegment(r.max),a=n(r.max,o);t.expandByPoint(a),t.expandByPoint(i);for(let e=s;e<o;e++)t.expandByPoint(this._pts[e]);return t}discrete(e=g.DiscreteParameter.NORMAL){const t=this._getSegment(this._range.min),n=this._getSegment(this._range.max),r=[this.getStartPt()];for(let e=t;e<n;e++)r.push(this._pts[e].clone());return r.push(this.getEndPt()),r}getType(){return a.EN_GEO_ELEMENT_TYPE.EN_SMOOTHPOLY_3D}clone(){return super.clone()}dump(){return{type:this.getType(),data:[this._pts.map((e=>e.toArray3()))]}}load({data:[e]}){return this._pts=e.map((e=>new o.Vector3(e))),this._calParams(),this}_getSegment(e){if(_.MathError.assert(this._pts.length>=2,"不合法的SmoothPoly"),2===this._pts.length)return 1;let t,n,r;for(n=0,r=this._ts.length-1;this._ts[n]===this._ts[n+1];)n++;for(;this._ts[r]===this._ts[r-1];)r--;for(;n+1<r;)if(t=Math.floor((n+r)/2),e<this._ts[t])for(r=t;this._ts[r]===this._ts[r-1];)r--;else for(n=t;this._ts[n]===this._ts[n+1];)n++;return r}_calParams(){this._ts=[0];for(let e=1;e<this._pts.length;){const t=this._pts[e].distanceTo(this._pts[e-1]);t<d.Tolerance.LENGTH_EPS?this._pts.splice(e,1):(this._ts.push(this._ts[e-1]+t),e++)}this._range=new h.Interval(this._ts[0],this._ts[this._ts.length-1])}};m=r([l.registerLoader,s("design:paramtypes",[Array,i.Curve3d])],m),t.SmoothPoly3d=m},83925:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Sphere=void 0;const o=n(89494),a=n(6688),c=n(26773),l=n(56973),d=n(33218),u=n(61226),h=n(13982),g=n(60229),f=n(97505),p=n(44757),_=n(49246),m=n(97602),v=n(49509),E=n(9327),P=n(87222),y=n(93145),C=n(53487),S=n(67996),T=n(97700),b=n(32858),w=n(737);let x=r=class extends v.CircularSurface{constructor(e,t,n,r){super(),e&&void 0!==t&&(this._coord=e.clone(),this._a=t,this._b=void 0===n?t:n,this._c=void 0===r?t:r)}getC(){return this._c}getRadius(){return p.MathAssert.assert(this.isEqualABC(l.Tolerance.CALCULATE_EPS),"获取半径时，abc轴长度不一致"),(this._a+this._b+this._c)/3}getCenter(){return this._coord.getOrigin()}getPoles(){const e=this._coord;return[e.getOrigin().add(e.getDz().multiplied(this._c)),e.getOrigin().add(e.getDz().multiplied(-this._c))]}isEqualABC(e=l.Tolerance.LENGTH_EPS){return Math.abs(this._a-this._b)<e&&Math.abs(this._a-this._c)<e}getPtAt(e){const t=Math.cos(e.y),n={x:this._a*t*Math.cos(e.x),y:this._b*t*Math.sin(e.x),z:this._c*Math.sin(e.y)};return this._coord.getWorldPtAt(n)}getNormAt(e){const t=Math.cos(e.x),n=Math.sin(e.x),r=Math.cos(e.y),s=Math.sin(e.y),i=new u.Vector3(-this._a*r*n,this._b*r*t,0),o=new u.Vector3(-this._a*s*t,-this._b*s*n,this._c*r),a=i.cross(o);return this._coord.getWorldVectorAt(a).normalize()}getSingularPoints(){return this.getPoles()}getDerivatives(e,t=1){const n=[],r=this._a,s=this._b,i=this._c,o=Math.cos(e.x),a=Math.sin(e.x),c=Math.cos(e.y),l=Math.sin(e.y),d=[o,-a,-o,a],h=[a,o,-a,-o],g=[c,-l,-c,l],f=[l,c,-l,-c],p={x:r*g[0]*d[0],y:s*g[0]*h[0],z:i*f[0]},_=this._coord.getWorldPtAt(p);if(n.push(_),t<=0)return n;const m=new u.Vector3(r*g[0]*d[1],s*g[0]*h[1],0),v=this._coord.getWorldVectorAt(m);n.push(v);const E=new u.Vector3(r*g[1]*d[0],s*g[1]*h[0],i*f[1]),P=this._coord.getWorldVectorAt(E);if(n.push(P),t<=1)return n;const y=new u.Vector3(r*g[0]*d[2],s*g[0]*h[2],0),C=this._coord.getWorldVectorAt(y);n.push(C);const S=new u.Vector3(r*g[1]*d[1],s*g[1]*h[1],0),T=this._coord.getWorldVectorAt(S);n.push(T);const b=new u.Vector3(r*g[2]*d[0],s*g[2]*h[0],i*f[2]),w=this._coord.getWorldVectorAt(b);if(n.push(w),t<=2)return n;const x=new u.Vector3(r*g[0]*d[3],s*g[0]*h[3],0),M=this._coord.getWorldVectorAt(x);n.push(M);const N=new u.Vector3(r*g[1]*d[2],s*g[1]*h[2],0),A=this._coord.getWorldVectorAt(N);n.push(A);const O=new u.Vector3(r*g[2]*d[1],s*g[2]*h[1],0),I=this._coord.getWorldVectorAt(O);n.push(I);const D=new u.Vector3(r*g[3]*d[0],s*g[3]*h[0],i*f[3]),L=this._coord.getWorldVectorAt(D);if(n.push(L),t<=3)return n;const V=new u.Vector3(r*g[0]*d[0],s*g[0]*h[0],0),R=this._coord.getWorldVectorAt(V);n.push(R);const U=new u.Vector3(r*g[1]*d[3],s*g[1]*h[3],0),B=this._coord.getWorldVectorAt(U);n.push(B);const F=new u.Vector3(r*g[2]*d[2],s*g[2]*h[2],0),k=this._coord.getWorldVectorAt(F);n.push(k);const G=new u.Vector3(r*g[3]*d[1],s*g[3]*h[1],0),j=this._coord.getWorldVectorAt(G);n.push(j);const z=new u.Vector3(r*g[0]*d[0],s*g[0]*h[0],i*f[0]),W=this._coord.getWorldVectorAt(z);if(n.push(W),t<=4)return n;throw new Error("unimplemented: n > 4高阶导数计算未实现！")}getUVAt(e){const t=this._coord.getLocalPtAt(e);if(t.z>=this._c-l.Tolerance.LENGTH_EPS)return new d.Vector2(0,g.CONST.PI_2);if(t.z<=-this._c+l.Tolerance.LENGTH_EPS)return new d.Vector2(0,-g.CONST.PI_2);const n=Math.atan2(t.y/this._b,t.x/this._a),r=Math.asin(t.z/this._c);return new d.Vector2(c.PeriodInterval.RegularizeParam(n,g.CONST.PI2),r)}getCurve2d(e){if(e instanceof m.Arc3d){if(e.getNormal().isParallel(this.getCoord().getDz()))return this._arc3dToUV(e);if(e.getCenter().equals(this.getCenter())){const t=this.getPoles(),n=e.getStartPt(),r=e.getEndPt(),s=this.getUVAt(n),i=this.getUVAt(r);let o;const a=.001*(this._a+this._b+this._c);if(n.equals(t[0],a)||n.equals(t[1],a))if(r.equals(t[0],a)||r.equals(t[1],a)){const t=e.getPtAt(e.getRange().getLength()/4);o=this.getUVAt(t)}else o=i;else o=s;return s.x=o.x,i.x=o.x,new b.Line2d(s,i)}}return super.getCurve2d(e)}containsCurve(e,t=l.Tolerance.LENGTH_EPS){const n=n=>!(e instanceof P.Line3d||e instanceof y.NurbsCurve3d)&&(e instanceof m.Arc3d&&(this.containsPoint(e.getPtAt(0),t)&&this.containsPoint(e.getPtAt(g.CONST.PI),t)&&this.containsPoint(e.getPtAt(g.CONST.PI_2),t)&&this.containsPoint(e.getPtAt(3*g.CONST.PI_2),t)));if(e.isLine3d()||e.isArc3d()||e.isNurbsCurve3d())return n();if(e instanceof C.OffsetCurve3d)return!1;if(e instanceof E.ExtendCurve3d){const t=e.getBaseCurve();return!!t.getRange().containsInterval(e.getRange())&&n()}throw new Error("暂不支持该种类型")}getDomainU(){return new c.PeriodInterval(0,g.CONST.PI2)}getDomainV(){return new a.Interval(-g.CONST.PI_2,g.CONST.PI_2)}getIsoCurve(e,t){if(t){const t=Math.cos(e),n=this._c*Math.sin(e),r=this._coord.getDz(),s=this._coord.translated(r.multiplied(n));return new m.Arc3d(s,this._a*t,this._b*t,[0,g.CONST.PI2])}const n=this._a*Math.cos(e),r=this._b*Math.sin(e),s=Math.sqrt(n*n+r*r),i=this._coord.getDx(),a=this._coord.getDz(),c=i.vecRotate(a,e),l=new o.Coordinate3(this._coord.getOrigin(),c,a);return new m.Arc3d(l,s,this._c,[-g.CONST.PI_2,g.CONST.PI_2])}getBox(e,t){const n=e||this.getDomainU(),r=t||this.getDomainV(),s=[this.getIsoCurve(r.min,!0),this.getIsoCurve(r.max,!0)];for(const e of s)e.setRange(n);const i=[this.getIsoCurve(n.min,!1),this.getIsoCurve(n.max,!1)];for(const e of i)e.setRange(r);const o=new S.Box3;for(const e of s)o.union(e.getBoundingBox());for(const e of i)o.union(e.getBoundingBox());for(const e of[u.Vector3.X(),u.Vector3.Y(),u.Vector3.Z()]){const t=this.getDirMaxPt(e);t&&n.containsPoint(t.uv.x)&&r.containsPoint(t.uv.y)&&o.expandByPoint(t.pt);const s=this.getDirMaxPt(e.reversed());s&&n.containsPoint(s.uv.x)&&r.containsPoint(s.uv.y)&&o.expandByPoint(s.pt)}return o}getDirMaxPt(e){let t=!1;const n=this._coord.getLocalVectorAt(e),r={x:Math.atan2(n.y,n.x),y:Math.asin(n.y)};let s=0;for(;s<g.CONST.NORMAL_ITER_NUM;s++){const n=this.getDerivatives(r,2),s=[n[1].dot(e),n[2].dot(e)];if(Math.abs(s[0])<l.Tolerance.LENGTH_EPS&&Math.abs(s[1])<l.Tolerance.LENGTH_EPS){t=!0;break}const i=[[n[3].dot(e),n[4].dot(e)],[n[4].dot(e),n[5].dot(e)]];if(Math.abs(i[0][0]*i[1][1]-i[0][1]*i[1][0])<l.Tolerance.CALCULATE_EPS){t=!1;break}const o=T.LinearSystem.execute(i,s);if(void 0===o){t=!1;break}r.x-=o[0],r.y-=o[1]}if(t)return{uv:r,pt:this.getPtAt(r)}}isCoplanar(e,t=new l.Tolerance){if(!e.isSphere())return!1;const n=e,r=n.getCoord();if(!this._coord.getOrigin().equals(r.getOrigin()))return!1;const s=e=>{const n=new Map;n.set(e.getA(),[e.getCoord().getDx()]),_.Util.isNearlyEqual(e.getB(),e.getA(),t.lengthEps)?n.get(e.getA()).push(e.getCoord().getDy()):n.set(e.getB(),[e.getCoord().getDy()]);let r=!1;for(const s of n)if(_.Util.isNearlyEqual(e.getC(),s[0],t.lengthEps)){s[1].push(e.getCoord().getDz()),r=!0;break}return r||n.set(e.getC(),[e.getCoord().getDz()]),n},i=s(this),o=s(n);if(i.size!==o.size)return!1;if(1===i.size)return _.Util.isNearlyEqual(this._a,n.getA(),t.lengthEps);if(2===i.size){for(const e of i){let n=!1;for(const r of o)if(_.Util.isNearlyEqual(e[0],r[0],t.lengthEps)){if(e[1].length!==r[1].length)return!1;if(1===e[1].length&&!e[1][0].isParallel(r[1][0]))return!1;n=!0;break}if(!n)return!1}return!0}for(const e of i){let n=!1;for(const r of o)if(_.Util.isNearlyEqual(e[0],r[0],t.lengthEps)){if(e[1][0].isParallel(r[1][0]))return!1;n=!0;break}if(!n)return!1}return!0}transform(e){const t=this._coord.getOrigin().transformed(e),n=this._coord.getDx().multiply(this._a).vecTransform(e),r=this._coord.getDy().multiply(this._b).vecTransform(e),s=this._coord.getDz().multiply(this._c).vecTransform(e),i=s.normalized();if(i.isPerpendicular(n)&&i.isPerpendicular(r)){let e,a;if(n.normalized().isPerpendicular(r.normalized()))e=n,a=r;else{const t=.5*Math.atan2(2*n.dot(r),n.getSqLength()-r.getSqLength()),s=Math.sin(t),i=Math.cos(t);e=n.multiplied(i).add(r.multiplied(s)),a=n.multiplied(-s).add(r.multiplied(i))}return n.cross(r).dot(i)<0&&a.multiply(-1),this._a=e.getLength(),this._b=a.getLength(),this._c=s.getLength(),this._coord=new o.Coordinate3(t,e,a),this}return this}transformed(e){const t=this._coord.getOrigin().transformed(e),n=this._coord.getDx().multiply(this._a).vecTransform(e),s=this._coord.getDy().multiply(this._b).vecTransform(e),i=this._coord.getDz().multiply(this._c).vecTransform(e),a=i.normalized();if(a.isPerpendicular(n)&&a.isPerpendicular(s)){let e,c;if(n.normalized().isPerpendicular(s.normalized()))e=n,c=s;else{const t=.5*Math.atan2(2*n.dot(s),n.getSqLength()-s.getSqLength()),r=Math.sin(t),i=Math.cos(t);e=n.multiplied(i).add(s.multiplied(r)),c=n.multiplied(-r).add(s.multiplied(i))}n.cross(s).dot(a)<0&&c.multiply(-1);const l=e.getLength(),d=c.getLength(),u=i.getLength(),h=new o.Coordinate3(t,e,c);return new r(h,l,d,u)}const c=this.toNurbs();return c.transform(e),c}toNurbs(e,t=2,n=2,r=l.Tolerance.LENGTH_EPS){const s=this.getIsoCurve(0,!0),i=s.getCenter(),o=s.getCoord().getDx().multiply(s.getA()),a=s.getCoord().getDy().multiply(s.getB()),c=s.getCoord().getDz().multiply(this.getC()),d=[i.added(o),i.added(o).added(a),i.added(a).subtracted(o),i.subtracted(o),i.subtracted(o).subtracted(a),i.subtracted(a).added(o),i.added(o)],u=this.getPoles(),h=[];for(const e of d){const t=e.subtracted(c),n=e.added(c);h.push([u[1],t,n,u[0]])}const g=[1,.5,.5,1,.5,.5,1],f=[1,.5,.5,1],p=[];for(const e of g)p.push([e*f[0],e*f[1],e*f[2],e*f[3]]);const _=w.NurbsSurface.makeByKnotsControlPointsWeights(2,2,[0,0,0,.25,.5,.5,.75,1,1,1],[0,0,0,.5,1,1,1],h,p);return _.addSingularPoints([{pt:this.getPoles()[0],param:1,uvSign:1},{pt:this.getPoles()[1],param:0,uvSign:1}]),_}clone(){return super.clone()}getType(){return f.EN_GEO_ELEMENT_TYPE.EN_SPHERE}dump(){return{type:this.getType(),data:[this._coord.dump(),this._a,this._b,this._c]}}load({data:[e,t,n,r]}){return this._coord.load(e),this._a=t,this._b=n,this._c=r,this}};x=r=s([h.registerLoader,i("design:paramtypes",[o.Coordinate3,Number,Number,Number])],x),t.Sphere=x},97935:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Surface=void 0;const r=n(33218),s=n(67996),i=n(56973),o=n(43640),a=n(67579),c=n(17165),l=n(49246),d=n(29791),u=n(6688),h=n(60229),g=n(26773),f=n(32858),p=n(48448),_=n(43638),m=n(97700);class v extends d.Geometry3d{constructor(){super()}isUPeriodic(){return this.getDomainU()instanceof g.PeriodInterval}isVPeriodic(){return this.getDomainV()instanceof g.PeriodInterval}isRuled(){return!1}getDomainU(){return u.Interval.infinit()}getDomainV(){return u.Interval.infinit()}clampInDomain(e){this.isSweepSurface()||this.isNurbsSurface()?(this.isUPeriodic()||(e.x=this.getDomainU().clamp(e.x)),this.isVPeriodic()||(e.y=this.getDomainV().clamp(e.y))):this.isCone()&&(e.y=this.getDomainV().clamp(e.y))}getBoundingBox(){throw new Error("No bounding box for Surface")}getBox(e,t){const n=e||this.getDomainU(),r=t||this.getDomainV(),i=[this.getIsoCurve(n.min,!1).setRange(r),this.getIsoCurve(n.max,!1).setRange(r),this.getIsoCurve(r.min,!0).setRange(n),this.getIsoCurve(r.max,!0).setRange(n)],o=new s.Box3;return i.forEach((e=>{o.union(e.getBoundingBox())})),o}getNormAtPoint(e){const t=this.getUVAt(e);return this.getNormAt(t)}getSingularPoints(){return[]}translate(e){return super.translate(e)}rotate(e,t,n){return super.rotate(e,t,n)}clone(){return super.clone()}transformed(e,t){return this.clone().transform(e,t)}getProjectedPtBy(e){const t=this.getUVAt(e);return this.getPtAt(t)}containsPoint(e,t=i.Tolerance.LENGTH_EPS){const n=this.getPtAt(this.getUVAt(e)).sqDistanceTo(e);return l.Util.isNearlyZero(n,t*t)}distanceToPoint(e){return this.getPtAt(this.getUVAt(e)).distanceTo(e)}signDistanceToPoint(e){const t=this.getUVAt(e),n=this.getPtAt(t);let r=n.distanceTo(e);return n.subtracted(e).dot(this.getNormAt(t))>0&&(r=-r),r}getUVNearParam(e,t,n=i.Tolerance.ANGLE_EPS,s=i.Tolerance.LENGTH_EPS,o,a){const c=Math.sin(s),l=n*n;let d=!1;const u={x:t.x,y:t.y};let f=0;for(;f<h.CONST.NORMAL_ITER_NUM;f++){const t=this.getDerivatives(u,2),n=t[0].subtracted(e),r=[n.dot(t[1]),n.dot(t[2])];if(n.getSqLength()<l){d=!0;break}if(Math.abs(r[0])<c&&Math.abs(r[1])<c){d=!0;break}const s=t[1].dot(t[1])+n.dot(t[3]),o=t[2].dot(t[1]),a=[[s,o],[o,t[2].dot(t[2])+n.dot(t[5])]];if(Math.abs(a[0][0]*a[1][1]-a[0][1]*a[1][0])<i.Tolerance.CALCULATE_EPS){d=!1;break}const h=m.LinearSystem.execute(a,r);if(void 0===h){d=!1;break}u.x-=h[0],u.y-=h[1]}let p=!1,_=!1;if(d){if(!o&&!a)return new r.Vector2(u);if(o){if(Math.abs(u.x-t.x)<o)p=!0;else if(Math.abs(u.x-t.x)>o){const e=this.getDomainU();e instanceof g.PeriodInterval&&(u.x=e.getRegularParam(u.x),Math.abs(u.x-t.x)<o&&(p=!0),Math.abs(u.x-e.period-t.x)<o&&(u.x-=e.period,p=!0),Math.abs(u.x+e.period-t.x)<o&&(u.x+=e.period,p=!0))}}else p=!0;if(a){if(Math.abs(u.y-t.y)<a)_=!0;else if(Math.abs(u.y-t.y)>a){const e=this.getDomainV();e instanceof g.PeriodInterval&&(u.x=e.getRegularParam(u.x),Math.abs(u.y-t.y)<a&&(_=!0),Math.abs(u.y-e.period-t.y)<a&&(u.y-=e.period,_=!0),Math.abs(u.y+e.period-t.y)<a&&(u.y+=e.period,_=!0))}}else _=!0}if(p&&_)return new r.Vector2(u);return this.getUVAt(e)}getCurve2dForIsoCurve(e){if(e.length>200&&!this.isPlane()){const t=this.getUVAt(e[0]),n=this.getIsoCurve(t.x,!1),r=c.DiscreteUtil.discreteCurve3d(n,o.DiscreteParameter.NORMAL);if(Math.abs(r.length/e.length-1)<.01){let r=!0;for(let t=0;t<e.length;t+=2)if(!n.containsPoint(e[t])){r=!1;break}if(r){const n=this.getUVAt(e[e.length-1]);if(Math.abs(t.x-n.x)<i.Tolerance.LENGTH_EPS)return new f.Line2d(t,n);if(Math.abs(t.x-n.x)>i.Tolerance.LENGTH_EPS&&this.isUPeriodic()){const e=this.getDomainU().period;if(Math.abs((n.x-t.x)/e-1)<i.Tolerance.LENGTH_EPS)return n.x=t.x,new f.Line2d(t,n)}}}const s=this.getIsoCurve(t.y,!0),a=c.DiscreteUtil.discreteCurve3d(s,o.DiscreteParameter.NORMAL);if(Math.abs(a.length/e.length-1)<.01){let n=!0;for(let t=0;t<e.length;t+=2)if(!s.containsPoint(e[t])){n=!1;break}if(n){const n=this.getUVAt(e[e.length-1]);if(Math.abs(t.y-n.y)<i.Tolerance.LENGTH_EPS)return new f.Line2d(t,n);if(Math.abs(t.y-n.y)>i.Tolerance.LENGTH_EPS&&this.isVPeriodic()){const e=this.getDomainU().period;if(Math.abs((n.y-t.y)/e-1)<i.Tolerance.LENGTH_EPS)return n.y=t.y,new f.Line2d(t,n)}}}}}getCurve2d(e){const t=c.DiscreteUtil.discreteCurve3d(e,o.DiscreteParameter.NORMAL),n=this.getCurve2dForIsoCurve(t);if(n)return n;const r=t.map((e=>this.getUVAt(e))),s=this.getDomainU();if(s instanceof g.PeriodInterval){const e=s.period;if(r.length>2){let t=!0;for(;t;){let n=0,s=0;for(;n<r.length-2;n++){const t=r[n+1].x-r[n].x,i=Math.abs(r[n+2].x-r[n+1].x);if(Math.abs(t)>e/2&&Math.abs(t)>2*i){s=t<0?1:-1;break}}if(0===s){const t=r[n+1].x-r[n].x,i=Math.abs(r[n].x-r[n-1].x);Math.abs(t)>e/2&&Math.abs(t)>2*i?s=t<0?1:-1:n++}if(t=0!==s,0!==s)for(s>0&&n++;n>=0&&n<r.length;)r[n].x+=e,n+=s}}if(Math.min(r[0].x,r[r.length-1].x)>e-i.Tolerance.NUMBER_EPS)for(const t of r)t.x-=e;else if(Math.max(r[0].x,r[r.length-1].x)<i.Tolerance.NUMBER_EPS)for(const t of r)t.x+=e}const a=this.getDomainV();if(a instanceof g.PeriodInterval){const e=a.period;if(r.length>2){let t=!0;for(;t;){let n=0,s=0;for(;n<r.length-2;n++){const t=r[n+1].y-r[n].y,i=Math.abs(r[n+2].y-r[n+1].y);if(Math.abs(t)>e/2&&Math.abs(t)>2*i){s=t<0?1:-1;break}}if(0===s){const t=r[n+1].y-r[n].y,i=Math.abs(r[n].y-r[n-1].y);Math.abs(t)>e/2&&Math.abs(t)>2*i?s=t<0?1:-1:n++}if(t=0!==s,0!==s)for(s>0&&n++;n>=0&&n<r.length;)r[n].y+=e,n+=s}}if(Math.min(r[0].y,r[r.length-1].y)>e-i.Tolerance.NUMBER_EPS)for(const t of r)t.y-=e;else if(Math.max(r[0].y,r[r.length-1].y)<i.Tolerance.NUMBER_EPS)for(const t of r)t.y+=e}const l=r[r.length-1].subtracted(r[0]);if(l.isZero()){for(let e=1;e<r.length;e++){if(r[e].subtracted(r[0]).getSqLength()>i.Tolerance.LENGTH_EPS2)return p.NurbsCurve2d.makeByInterpolationPoints(r)}return new f.Line2d(r[0],r[r.length-1])}const d=l.normalized();let u=!0;for(let e=1;e<r.length;e++){const t=r[e].subtracted(r[0]).normalize();if(!d.isParallel(t,i.Tolerance.ANGLE_EPS)){u=!1;break}}return u?new f.Line2d(r[0],d,[0,l.getLength()]):p.NurbsCurve2d.makeByInterpolationPoints(r)}getCurve3d(e){const t=c.DiscreteUtil.discreteCurve2dOnSurface(e,this,o.DiscreteParameter.CALCULATE).points;return new a.SmoothPoly3d(t)}wireToUV(e,t=i.Tolerance.DEFAULT){const n=new Map,r=e.map((e=>{const t=this.getCurve2d(e);return n.set(e,t),t}));return _.SurfaceUtil.unifyCurve2dUVBetweenCurves(e,this,r,t),{loop:r,mapping:n}}firstFundamentalForm(e){const t=this.getDerivatives(e,1);return[t[1].dot(t[1]),t[1].dot(t[2]),t[2].dot(t[2])]}tessellate(e,t=o.DiscreteParameter.NORMAL,n=i.Tolerance.DEFAULT){const r=this.discrete(t,n),s=this.getDomainU();s.min=Math.max(s.min,-1e3),s.max=Math.min(s.max,1e3);const a=this.getDomainV();a.min=Math.max(a.min,-1e3),a.max=Math.min(a.max,1e3);const c=this.getIsoCurve(a.min,!0);c.setRange(s);const l=this.getIsoCurve(s.max,!1);l.setRange(a);const d=this.getIsoCurve(a.max,!0);d.setRange(s),d.reverse();const u=this.getIsoCurve(s.min,!1);u.setRange(a),u.reverse();const h=[c,l,d,u];return{debugInfo:{name:this.constructor.name,visible:!0},mesh:r,children:e?[{debugInfo:{name:"虚轮廓线",visible:!0},children:h.map((n=>n.tessellate(e,t))).flat()}]:[]}}discrete(e=o.DiscreteParameter.NORMAL,t=i.Tolerance.DEFAULT){const n=this.getDomainU();n.min=Math.max(n.min,-1e3),n.max=Math.min(n.max,1e3);const s=this.getDomainV();s.min=Math.max(s.min,-1e3),s.max=Math.min(s.max,1e3);const a=[new r.Vector2(n.min,s.min),new r.Vector2(n.max,s.min),new r.Vector2(n.max,s.max),new r.Vector2(n.min,s.max)],l=[{pCurve:new f.Line2d(a[0],a[1])},{pCurve:new f.Line2d(a[1],a[2])},{pCurve:new f.Line2d(a[2],a[3])},{pCurve:new f.Line2d(a[3],a[0])}];return c.DiscreteUtil.discreteSurface(this,[l],!0,e,t)}_containsBaseCurve(e,t=i.Tolerance.LENGTH_EPS){if(e.isLine3d())return this.containsPoint(e.getStartPt(),t)&&this.containsPoint(e.getEndPt(),t)&&this.containsPoint(e.getMidPt(),t);if(e.isArc3d())return this.containsPoint(e.getPtAt(0),t)&&this.containsPoint(e.getPtAt(h.CONST.PI),t)&&this.containsPoint(e.getPtAt(h.CONST.PI_2),t)&&this.containsPoint(e.getPtAt(3*h.CONST.PI_2),t);if(e.isNurbsCurve3d()){const n=e;return void 0!==n.getCoincideLine()&&this.containsPoint(n.getStartPt(),t)&&this.containsPoint(n.getEndPt(),t)&&this.containsPoint(e.getMidPt(),t)}return!1}}t.Surface=v},47423:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.SweepSurface=void 0;const o=n(56973),a=n(97935),c=n(2111),l=n(61226),d=n(53487),u=n(68990),h=n(33218),g=n(97505),f=n(22283),p=n(13982),_=n(9327),m=n(44757),v=n(32858),E=n(5804),P=n(61210),y=n(26581),C=n(87222),S=n(97602),T=n(89494),b=n(29453),w=n(60229),x=n(34410),M=n(6688),N=n(24013),A=n(26773),O=n(43640),I=n(48448),D=n(49246),L=n(43255),V=n(67996),R=n(74729),U=n(90361),B=n(737),F=n(8366),k=n(4097);let G=r=class extends a.Surface{constructor(e,t,n=!0,r){if(super(),t&&e){const s=e.isExtendCurve3d()?e.getBaseCurve():e,i=e=>{const t=e.getRange();if(t instanceof A.PeriodInterval&&Math.abs(t.getLength()-t.period)<o.Tolerance.NUMBER_EPS){if(e.isArc3d())return!0;if(e.isNurbsCurve3d()){const t=e.getStartTangent(),n=e.getEndTangent();if(t.equals(n))return!0}}return!1};if(s instanceof d.OffsetCurve3d){r?(this._pathDz=new l.Vector3(r),m.MathAssert.assert(s.getDz().isParallel(r))):this._pathDz=s.getDz();const o=this._pathDz.dot(s.getDz()),a=s.getBaseCurve(),c=s.getParamMapper(),d=s.getRange(),u=c.getBaseParam(d.min,!1),h=c.getBaseParam(d.max,!0);a.setRange(u,h),n||e.isExtendCurve3d()?i(s)?this._path=s.getBaseCurve():this._path=_.ExtendCurve3d.makeByCurve(s.getBaseCurve()):this._path=s.getBaseCurve();const g={x:-o*s.getOffsetXY(),y:o*s.getOffsetZ()};this._profile=t.translate(g)}else this._profile=t,n||e.isExtendCurve3d()?i(s)?this._path=s:this._path=e.isExtendCurve3d()?e:_.ExtendCurve3d.makeByCurve(e,!1):this._path=e,this._pathDz=r?new l.Vector3(r):x.CurveUtil.getDzByCurve(e)}}static make(e,t,n,s=!0){const i=e.getStartPt(),a=e.getStartTangent(),c=new l.Vector3(n),u=c.cross(a),g=new T.Coordinate3(i,u,c),f=e instanceof _.ExtendCurve3d?e.getBaseCurve():e,p=f instanceof d.OffsetCurve3d?f.getBaseCurve():f;if(t instanceof v.Line2d){const n=g.getWorldVectorAt(t.getDirection()),r=x.CurveUtil.getDzByPlaneCurve(p);if(r&&r.isPerpendicular(n)){e instanceof C.Line3d?g.setOrigin(e.getOrigin()):e instanceof S.Arc3d&&g.setOrigin(e.getCoord().getOrigin());const r=g.getWorldPtAt(t.getOrigin());return{surface:new E.Plane(r,n,a),isSameDirection:!0}}if(e instanceof S.Arc3d){const r=e.getNormal();if(!s){if(n.isParallel(r)){const s=n.dot(r)<0;if(e.isEqualAB()){const n=e.getA()-t.getStartPt().x;return{surface:new b.Cylinder(e.getCoord(),n,n),isSameDirection:s}}if(Math.abs(t.getStartPt().x)<o.Tolerance.LENGTH_EPS)return{surface:new b.Cylinder(e.getCoord(),e.getA(),e.getB()),isSameDirection:s}}if(e.isEqualAB()){const n=t.getOrigin(),r=t.getDirection(),s=r.y/r.x,i=n.x-n.y/s,a=e.getA()-i,c=Math.abs(a),l=a*s,d=r.y<0==a>0;if(l>o.Tolerance.LENGTH_EPS)return{surface:new N.Cone(e.getCoord(),c,c,Math.abs(l)),isSameDirection:d};if(l<-o.Tolerance.LENGTH_EPS){const t=e.getCoord(),n=new T.Coordinate3(t.getOrigin(),t.getDx(),t.getDy().reverse());return{surface:new N.Cone(n,c,c,-l),isSameDirection:d}}}}}}if(e instanceof d.OffsetCurve3d){const i=p.clone();i.setRange(e.getParamMapper().getBaseParam(e.getStartParam(),!1),e.getParamMapper().getBaseParam(e.getEndParam(),!0));const o=t.clone(),a=e.getDz(),c=y.Matrix3.makeRotate(new h.Vector2(0,0),a.angle(n)),l=y.Matrix3.makeTranslate(new h.Vector2(-e.getOffsetXY(),e.getOffsetZ()));return o.transform(c.multiplied(l)),{surface:new r(i,o,s,n),isSameDirection:!0}}return{surface:new r(e.clone(),t.clone(),s,n),isSameDirection:!0}}getPath(){return this._path}getPathDz(){return this._pathDz.clone()}setPathByBaseCurve(e,t=!0){this._path=t?_.ExtendCurve3d.makeByCurve(e,!1):e,this._pathDz=x.CurveUtil.getDzByCurve(e,this._pathDz)}getProfile(){return this._profile}setProfile(e){this._profile=e}getDomainU(){return this._profile.getRange()}getDomainV(){return this._path.getRange()}isUPeriodic(){const e=this._profile.getRange();return e instanceof A.PeriodInterval&&e.isClosed()}isVPeriodic(){const e=this._path.getRange();return e instanceof A.PeriodInterval&&e.isClosed()}isRuled(){return this._path.isLine3d()||this._profile.isLine2d()}getPtAt(e){const t=this._profile.getPtAt(e.x),n=this._path.getPtAt(e.y),r=this._path.getTangentAt(e.y).normalize().cross(this._pathDz).multiply(-t.x);return n.add(r).add(this._pathDz.multiplied(t.y))}getUVAt(e){const t=this.getUVsAt(e);return t.find((e=>this.getDomainU().containsPoint(e.x)&&this.getDomainV().containsPoint(e.y)))||t[0]}getUVNearParam(e,t,n=o.Tolerance.ANGLE_EPS,r=o.Tolerance.LENGTH_EPS,s,i){let a;a=this._path.isLine3d()?this._path.getParamAt(e):this._path.getParamNearT(e,t.y,r,n,i);const c=new l.Vector3(e).subtract(this._path.getPtAt(a)),d=c.dot(this._pathDz),u={x:c.dot(this._pathDz.cross(this._path.getTangentAt(a))),y:d};let g;if(this._profile.isLine2d())g=this._profile.getParamAt(u);else{g=this._profile.getParamNearT(u,t.x,r,n,s);this._profile.getPtAt(g).sqDistanceTo(u)>o.Tolerance.EDGE_LENGTH_EPS2&&(g=this._profile.getParamAt(u))}return new h.Vector2(g,a)}getAllUVsForCurvePts(e,t,n=o.Tolerance.NUMBER_EPS,r=o.Tolerance.NUMBER_EPS){function s(e){if(e.isNurbsCurve()){const t=[],n=e.getKnots();for(let e=1;e<n.length;e++)t.push(n[e]-n[e-1]);return Math.max(...t)/2}if(e.isArc())return t.tolerance.angleEps;if(e.isExtendCurve()||e.isOffsetCurve()){return s(e.getBaseCurve())}}const i=s(this._path),a=s(this._profile),c=(e,t,s)=>{const o=this.getDerivatives(s,1),c=e.subtracted(t),l={x:s.x,y:s.y};l.x+=c.dot(o[1])/o[1].getSqLength(),l.y+=c.dot(o[2])/o[2].getSqLength();return this.getUVNearParam(e,l,n,r,a,i)},l=e.length;let d=Math.round(Math.random()*(l-2))+1,u=this.getUVsAt(e[d],n);if(l>3){let t=0;for(;u.length>1&&t<3;){const r=Math.round(Math.random()*(l-2))+1,s=this.getUVsAt(e[r],n);s.length<u.length&&(d=r,u=s),t++}}const h=[];for(const t of u){const n=[];n.push(t);let r=t;for(let t=d+1;t<e.length;t++){const s=c(e[t],e[t-1],r);n.push(s),r=s}n.reverse(),r=t;for(let t=d-1;t>=0;t--){const s=c(e[t],e[t+1],r);n.push(s),r=s}n.reverse(),h.push(n)}return h}getUVsForCurvePts(e,t,n=o.Tolerance.NUMBER_EPS,r=o.Tolerance.ANGLE_EPS,s,i){function a(e){if(e.isNurbsCurve()){const t=[],n=e.getKnots();for(let e=1;e<n.length;e++)t.push(n[e]-n[e-1]);return Math.max(...t)/2}if(e.isArc())return t.tolerance.angleEps;if(e.isExtendCurve()||e.isOffsetCurve()){return a(e.getBaseCurve())}}const c=a(this._path),l=a(this._profile),d=(e,t,s)=>{const i=this.getDerivatives(s,1),o=e.subtracted(t),a={x:s.x,y:s.y};a.x+=o.dot(i[1])/i[1].getSqLength(),a.y+=o.dot(i[2])/i[2].getSqLength();return this.getUVNearParam(e,a,n,r,l,c)},u=e.length;let g=Math.round(Math.random()*(u-2))+1,f=this.getUVsAt(e[g],n);if(u>3){let t=0;for(;f.length>1&&t<3;){const r=Math.round(Math.random()*(u-2))+1,s=this.getUVsAt(e[r],n);s.length<f.length&&(g=r,f=s),t++}}const p=[];let _;if(f.length>1)if(s&&i){const e=new h.Vector2(s,i);_=f.sort(((t,n)=>t.sqDistanceTo(e)-n.sqDistanceTo(e)))[0]}else if(i){_=f.sort(((e,t)=>Math.abs(e.y-i)-Math.abs(t.y-i)))[0]}else if(s){_=f.sort(((e,t)=>Math.abs(e.x-s)-Math.abs(t.x-s)))[0]}else _=f[0];else _=f[0];p.push(_);let m=_;for(let t=g+1;t<e.length;t++){const n=d(e[t],e[t-1],m);p.push(n),m=n}p.reverse(),m=_;for(let t=g-1;t>=0;t--){const n=d(e[t],e[t+1],m);p.push(n),m=n}return p.reverse(),p}getUVsAt(e,t=o.Tolerance.LENGTH_EPS){const n=this._path.getAllFootParams(e);0===n.length&&n.push(this._path.getParamAt(e));const r=n.map((t=>{const n=new l.Vector3(e).subtract(this._path.getPtAt(t)),r=n.dot(this._pathDz),s={x:n.dot(this._pathDz.cross(this._path.getTangentAt(t))),y:r},i={x:this._profile.getParamAt(s),y:t};return{uv:i,dist:this.getPtAt(i).sqDistanceTo(e)}})),s=[0];for(let e=1;e<r.length;e++)r[e].dist<r[s[0]].dist-t?(s.length=0,s.push(e)):r[e].dist<r[s[0]].dist+t&&s.push(e);return s.map((e=>new h.Vector2(r[e].uv)))}getNormAt(e){const t=this._path instanceof _.ExtendCurve3d?this._path.getBaseCurve():this._path,n=t instanceof d.OffsetCurve3d?t.getBaseCurve():t;if(this._profile.isLine2d()&&n.isArc3d()&&n.isEqualAB()&&(D.Util.isNearlyEqual(this._profile.getStartPt().x,n.getRadius())&&D.Util.isNearlyZero(e.x)||D.Util.isNearlyEqual(this._profile.getEndPt().x,n.getRadius())&&D.Util.isNearlyEqual(e.x,this._profile.getLength()))){const t=n.getTangentAt(e.y),r=this._profile.getDirection(),s=new l.Vector3(-r.x,0,r.y);return n.getCoord().getWorldVectorAt(s.rotate(new l.Vector3(0,0,0),n.getCoord().getDz(),e.y)).normalize().cross(t).normalize()}const r=this.getDerivatives(e,1);return r[1].cross(r[2]).normalize()}getSingularityUVs(){const e=this._path;if(e.isExtendCurve3d()){const t=[],n=[],r=e.getBaseCurve().getRange();return n.push(r.min),n.push(r.max),[t,n]}return[]}getCurve2ds(e){const t=e.discrete(O.DiscreteParameter.LOW),n=this.getAllUVsForCurvePts(t,O.DiscreteParameter.LOW,1e-6,1e-6),r=[];for(const e of n){let t=e[e.length-1].subtracted(e[0]);t.isZero()&&(t=e[1].subtracted(e[0]));const n=t.normalized();let s=!0;for(let t=1;t<e.length;t++){const r=e[t].subtracted(e[0]).normalize();if(!n.isParallel(r,o.Tolerance.ANGLE_EPS)){s=!1;break}}if(s){const s=new v.Line2d(e[0],n,[0,t.getLength()]);r.push(s)}else{const t=this._path.getRange().getLength()/this._profile.getRange().getLength();if(t>100||t<.01){const t=new U.Box2(e),n=(t.max.y-t.min.y)/(t.max.x-t.min.x);if(n>100||n<.01){const t=I.NurbsCurve2d.makeByInterpolationPoints(e,2);r.push(t);continue}}const n=I.NurbsCurve2d.makeByInterpolationPoints(e);r.push(n)}}return r}getCurve2d(e){return this.getCurve2ds(e)[0]}getIsoCurve(e,t){if(t){const t=this._path.getPtAt(e),n=this._path.getTangentAt(e),r=this._pathDz.cross(n);return new E.Plane(t,r,this._pathDz).getCurve3d(this._profile)}const n=this._profile.getPtAt(e);return d.OffsetCurve3d.makeByOffset(this._path,this._pathDz,-n.x,n.y)}getBox(e,t){const n=e||this.getDomainU(),r=t||this.getDomainV();if(this._profile.isLine2d()||this._path.isLine3d()){const e=[this.getIsoCurve(n.min,!1).setRange(r),this.getIsoCurve(n.max,!1).setRange(r),this.getIsoCurve(r.min,!0).setRange(n),this.getIsoCurve(r.max,!0).setRange(n)],t=new V.Box3;return e.forEach((e=>{t.union(e.getBoundingBox())})),t}const s=[];if(this._pathDz.isParallel(l.Vector3.X())||this._pathDz.isParallel(l.Vector3.Y())||this._pathDz.isParallel(l.Vector3.Z())){const e=this._profile.getBoundingBox(n);s.push(...e.getCornerPts())}else{const e=this._path.getTangentAt(r.min),t=l.Vector3.Z().angleTo(this._pathDz,e),i=h.Vector2.X().vecRotate(-t),o=new R.Coordinate2(h.Vector2.O(),i),a=o.getWorldToLocalMatrix();this._profile.transformed(a).getBoundingBox(n).getCornerPts().map((e=>s.push(o.getWorldPtAt(e))))}const i=new V.Box3;for(const e of s){const t=d.OffsetCurve3d.makeByOffset(this._path,this._pathDz,-e.x,e.y).getBoundingBox(r);i.union(t)}return i}getTiltBox(e,t){let n;if(this._path.isLine3d()){const e=this._path.getDirection(),t=this.getPathDz(),r=t.cross(e),s=this._path.getOrigin();n=new T.Coordinate3(s,r,t)}else if(this._path.isArc3d())n=this._path.getCoord().clone();else if((this._path.isExtendCurve3d()||this._path.isOffsetCurve3d())&&this._path.getBaseCurve().isArc3d()){n=this._path.getBaseCurve().getCoord().clone()}else{const e=x.CurveUtil.getDzByCurve(this._path);n=new T.Coordinate3(this._path.getMidPt(),e)}const r=n.getWorldToLocalMatrix(),s=this.transformed(r).getBox(e,t);return new L.TiltBox3(s,n)}getSingularityCurves(){const e=[],t=this._path.getSingularities();for(const n of t){const t=this.getIsoCurve(n,!0);e.push(t)}return e}toSimpleSurfaces(){const e=this._profile,t=this._path;if(e instanceof v.Line2d&&t instanceof C.Line3d){const n=t.getOrigin(),r=t.getStartTangent(),s=this._pathDz.cross(r),i=new T.Coordinate3(n,s,this._pathDz),o=i.getWorldPtAt(e.getOrigin()),a=i.getWorldVectorAt(e.getDirection());return[new E.Plane(o,a,r)]}if(!(t instanceof _.ExtendCurve3d))return[this];return[t.getStartLine(),t.getBaseCurve(),t.getEndLine()].map((t=>r.make(t,e,this._pathDz,!1).surface))}toSimpleSurfacePatchs(e){const t=this._profile,n=this._path;if(t instanceof v.Line2d&&n instanceof C.Line3d){const r=n.getOrigin(),s=n.getStartTangent(),i=this._pathDz.cross(s),o=new T.Coordinate3(r,i,this._pathDz),a=o.getWorldPtAt(t.getOrigin()),c=o.getWorldVectorAt(t.getDirection());return[{surface:new E.Plane(a,c,s),rangeUV:e}]}if(!n.isExtendCurve3d())return[{surface:this,rangeUV:e}];const s=[],i=t.getRange(),a=n.getRange(),c=[n.getStartLine(),n.getBaseCurve(),n.getEndLine()].map((e=>r.make(e,this._profile,this._pathDz,!1).surface));if(n instanceof _.ExtendCurve3d){const t=[],r=n.getBaseCurve().getRange();t.push(a.min),t.push(r.min),t.push(r.max),t.push(a.max);for(let n=0;n<3;n++){const r=new M.Interval(t[n],t[n+1]);if(e){const t=r.intersected(e[1]);t.length>0&&t[0].getLength()>o.Tolerance.NUMBER_EPS&&s.push({surface:c[n],rangeUV:[i,t[0]]})}else s.push({surface:c[n],rangeUV:[i,r]})}}for(const e of s){const t=e.surface,n=e.rangeUV[0],s=e.rangeUV[1],i=[];if(t instanceof r){i.push(n);const e=t.getPath();if(e.isLine3d()){const e=this.getPtAt(new h.Vector2(n.min,s.min)),r=this.getPtAt(new h.Vector2(n.max,s.max)),o=t.getUVAt(e),a=t.getUVAt(r);i.push(new M.Interval(o.y,a.y,!0))}else i.push(e.getRange())}else{const e=new h.Vector2(n.min,s.min),r=new h.Vector2(n.max,s.max),o=this.getPtAt(e),a=this.getPtAt(r),c=t.getUVAt(o),l=t.getUVAt(a);if(c.x>l.x&&([c.x,l.x]=[l.x,c.x]),c.y>l.y&&([c.y,l.y]=[l.y,c.y]),t.isUPeriodic()){const n=t.getDomainU(),s=n instanceof A.PeriodInterval?n.period:w.CONST.PI2,o=e.midTo(r),a=this.getPtAt(o),d=t.getUVAt(a),u=new A.PeriodInterval(c.x,l.x,s);u.containsPoint(d.x)?i.push(u):i.push(new A.PeriodInterval(l.x,c.x+s,s))}else i.push(new M.Interval(c.x,l.x));if(t.isVPeriodic()){const n=t.getDomainV(),s=n instanceof A.PeriodInterval?n.period:w.CONST.PI2,o=e.midTo(r),a=this.getPtAt(o),d=t.getUVAt(a),u=new A.PeriodInterval(c.y,l.y,s);u.containsPoint(d.y)?i.push(u):i.push(new A.PeriodInterval(l.y,c.y+s,s))}else i.push(new M.Interval(c.y,l.y))}for(const e of i)e.min<-w.CONST.MODEL_MAX_LENGTH&&(e.min=-w.CONST.MODEL_MAX_LENGTH),e.max>w.CONST.MODEL_MAX_LENGTH&&(e.max=w.CONST.MODEL_MAX_LENGTH);e.rangeUV=i}return s}getDerivatives(e,t,n,r){const s=this._path.getDerivatives(e.y,t+1,r),i=this._profile.getDerivatives(e.x,t,n),o=this._pathDz,a=s[1].dot(s[1]),c=Math.sqrt(a),l=(e,t,n)=>o.cross(t).multiply(n*i[e].x),d=[s[0].added(l(0,s[1],1/c)).add(o.multiplied(i[0].y))];if(t<=0)return d;const u=s[1].dot(s[2]),h=s[2].multiplied(a).subtract(s[1].multiplied(u)),g=a*c;if(d.push(l(1,s[1],1/c).add(o.multiplied(i[1].y))),d.push(s[1].added(l(0,h,1/g))),t<=1)return d;const f=s[1].dot(s[3])+s[2].dot(s[2]),p=3*c*u,_=s[3].multiplied(a).add(s[2].multiplied(u)).subtract(s[1].multiplied(f)).multiplied(g).subtract(h.multiplied(p)).multiply(1/(g*g));if(d.push(l(2,s[1],1/c).add(o.multiplied(i[2].y))),d.push(l(1,h,1/g)),d.push(s[2].add(l(0,_,1))),t<=2)return d;const m=s[4].dot(s[1])+3*s[2].dot(s[2]),v=s[3].multiplied(3*u),E=s[1].multiplied(m),P=s[4].multiplied(a).add(v).subtract(E),y=3*(u*u+f*a)/c;d.push(l(3,s[1],1/c).add(o.multiplied(i[3].y))),d.push(l(2,h,1/g)),d.push(l(1,_,1));const C=P.multiplied(g).subtract(h.multiplied(y)).multiply(1/(g*g)),S=_.multiplied(2*p/g);if(d.push(s[3].add(l(0,C.subtracted(S),1))),t<=3)return d;throw new Error("Sweep Curve derivatives: n > 2 not supported yet")}transform(e,t){const n=t||P.Matrix4.make(e,!1).decompose();return P.Matrix4.assertScaleEqual(n.scale),this._profile.scale(n.scale.y),this._path.transform(e,t),this._pathDz.vecTransform(e).normalize(),P.Matrix4.isSvdMirror(n)&&(this._profile.transform(y.Matrix3.makeMirror({x:0,y:0},{x:0,y:1})),this._profile.reverse()),this}transformed(e,t){const n=t||P.Matrix4.make(e,!1).decompose();if(P.Matrix4.isScaleEqual(n.scale))return this.clone().transform(e,n);const r=this.toNurbs();return r.transform(e),r}isCoplanar(e,t){return m.MathAssert.warn("SweepSurface.isCoplanar: not implemented"),!1}containsCurve(e,t){const n=e.isLine3d()?[e.getStartPt(),e.getMidPt(),e.getEndPt()]:e.discrete(O.DiscreteParameter.LOW);for(const e of n)if(!this.containsPoint(e))return!1;return!0}toNurbs(e,t,n,r=o.Tolerance.LENGTH_EPS){let s,i;if(t)s=t;else if(this._profile.isLine2d())s=1;else if(this._profile.isArc2d())s=2;else if(this._profile.isExtendCurve2d()){s=this._profile.getBaseCurve().isArc2d()?2:3}else s=3;if(n)i=n;else if(this._path.isLine3d())i=1;else if(this._path.isArc3d())i=2;else if(this._path.isExtendCurve3d()){i=this._path.getBaseCurve().isArc3d()?2:3}else i=3;const a=[],c=this.toSimpleSurfacePatchs();if(1===c.length){const e=this._path.getInterpPts(r).params;if(e.length<i+1){const t=this._path.getRange(),n=t.getLength()/i;for(let r=1;r<i;r++)e.splice(1,0,t.min+n*r)}const t=this._profile.getInterpPts(r).params;if(t.length<s+1){const e=this._profile.getRange(),n=e.getLength()/s;for(let r=1;r<s;r++)t.splice(1,0,e.min+n*r)}const n=[];for(const r of e){const e=[];for(const n of t){const t=this.getPtAt({x:n,y:r});e.push(t)}n.push(e)}return B.NurbsSurface.makeByInterpolatePts(n,s,i)}const l=c[0].surface,d=c[1].surface;for(const e of c){const t=F.Fitting.nurbsSurfaceFitting(e.surface,e.rangeUV,i,i);a.push(t)}let u;3!==c.length&&k.MathError.warn(""),u=d.isCylinder()?1:(l.isCylinder(),4);let h=a[0];for(let e=1;e<a.length;e++){const t=a[e];h=h.jointNurbsSurface(t,u)}return h}clone(){return new r(this._path.clone(),this._profile.clone(),!1,this._pathDz)}getType(){return g.EN_GEO_ELEMENT_TYPE.EN_SWEEP_SURFACE}dump(){return{type:this.getType(),data:[this._path.dump(),this._profile.dump(),this._pathDz.toArray3()]}}load({data:[e,t,n]}){return this._path=f.Loader.load(e),this._profile=f.Loader.load(t),this._pathDz=new l.Vector3(n),this}};G=r=s([p.registerLoader,i("design:paramtypes",[c.Curve3d,u.Curve2d,Boolean,Object])],G),t.SweepSurface=G},98106:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Polygon=t.Loop=t.PolyCurve=t.IntersectCurve3d=t.ExtendCurve3d=t.ExtendCurve2d=t.OffsetCurve3d=t.OffsetCurve2d=t.SmoothPoly3d=t.SmoothPoly2d=t.NurbsCurve3d=t.NurbsCurve2d=t.OffsetSurface=t.SweepSurface=t.NurbsSurface=t.Sphere=t.Cone=t.Cylinder=t.Plane=t.Surface=t.Circle3d=t.Arc3d=t.ArcType=t.Arc2d=t.Circle2d=t.Line3d=t.Line2d=t.Curve3d=t.Curve2d=t.Curve=t.DiscreteParameter=t.Tolerance=t.Euler=t.Coordinate3=t.Coordinate2=t.Coordinate=t.Quaternion=t.Matrix4=t.Matrix3=t.Matrix=t.Vector3=t.Vector2=t.Vector=t.Box3=t.Box2=t.Box=t.PeriodInterval=t.Interval=t.GeoElement=t.EN_GEO_ELEMENT_TYPE=void 0,t.ClipperLib=t.MatrixUtil=t.MathAlg=t.MathErrorType=t.MathError=t.LogCall=t.Log=t.NormalUnitsConversion=t.UnitsConversion=t.UnitType=t.MathAssert=t.ClipperUtil=t.SurfaceUtil=t.UvUtil=t.CurveUtil=t.GeomUtil=t.MathUtil=t.registerLoader=t.Loader=t.CONST=t.ObjParser=t.SVGParser=t.SolveEquationUtil=t.gaussIntegration=t.InvBilinear=t.EvolutionMap=t.TrimmedSurface=void 0;const r=n(16472);t.MathAlg=r;const s=n(79890);t.MatrixUtil=s;const i=n(20666);t.ClipperLib=i;var o=n(97505);Object.defineProperty(t,"EN_GEO_ELEMENT_TYPE",{enumerable:!0,get:function(){return o.EN_GEO_ELEMENT_TYPE}});var a=n(28982);Object.defineProperty(t,"GeoElement",{enumerable:!0,get:function(){return a.GeoElement}});var c=n(6688);Object.defineProperty(t,"Interval",{enumerable:!0,get:function(){return c.Interval}});var l=n(26773);Object.defineProperty(t,"PeriodInterval",{enumerable:!0,get:function(){return l.PeriodInterval}});var d=n(83437);Object.defineProperty(t,"Box",{enumerable:!0,get:function(){return d.Box}});var u=n(90361);Object.defineProperty(t,"Box2",{enumerable:!0,get:function(){return u.Box2}});var h=n(67996);Object.defineProperty(t,"Box3",{enumerable:!0,get:function(){return h.Box3}});var g=n(46891);Object.defineProperty(t,"Vector",{enumerable:!0,get:function(){return g.Vector}});var f=n(33218);Object.defineProperty(t,"Vector2",{enumerable:!0,get:function(){return f.Vector2}});var p=n(61226);Object.defineProperty(t,"Vector3",{enumerable:!0,get:function(){return p.Vector3}});var _=n(36050);Object.defineProperty(t,"Matrix",{enumerable:!0,get:function(){return _.Matrix}});var m=n(26581);Object.defineProperty(t,"Matrix3",{enumerable:!0,get:function(){return m.Matrix3}});var v=n(61210);Object.defineProperty(t,"Matrix4",{enumerable:!0,get:function(){return v.Matrix4}});var E=n(75948);Object.defineProperty(t,"Quaternion",{enumerable:!0,get:function(){return E.Quaternion}});var P=n(4375);Object.defineProperty(t,"Coordinate",{enumerable:!0,get:function(){return P.Coordinate}});var y=n(74729);Object.defineProperty(t,"Coordinate2",{enumerable:!0,get:function(){return y.Coordinate2}});var C=n(89494);Object.defineProperty(t,"Coordinate3",{enumerable:!0,get:function(){return C.Coordinate3}});var S=n(91743);Object.defineProperty(t,"Euler",{enumerable:!0,get:function(){return S.Euler}});var T=n(56973);Object.defineProperty(t,"Tolerance",{enumerable:!0,get:function(){return T.Tolerance}});var b=n(43640);Object.defineProperty(t,"DiscreteParameter",{enumerable:!0,get:function(){return b.DiscreteParameter}});var w=n(94905);Object.defineProperty(t,"Curve",{enumerable:!0,get:function(){return w.Curve}});var x=n(68990);Object.defineProperty(t,"Curve2d",{enumerable:!0,get:function(){return x.Curve2d}});var M=n(2111);Object.defineProperty(t,"Curve3d",{enumerable:!0,get:function(){return M.Curve3d}});var N=n(32858);Object.defineProperty(t,"Line2d",{enumerable:!0,get:function(){return N.Line2d}});var A=n(87222);Object.defineProperty(t,"Line3d",{enumerable:!0,get:function(){return A.Line3d}});var O=n(94399);Object.defineProperty(t,"Circle2d",{enumerable:!0,get:function(){return O.Circle2d}});var I=n(10909);Object.defineProperty(t,"Arc2d",{enumerable:!0,get:function(){return I.Arc2d}}),Object.defineProperty(t,"ArcType",{enumerable:!0,get:function(){return I.ArcType}});var D=n(97602);Object.defineProperty(t,"Arc3d",{enumerable:!0,get:function(){return D.Arc3d}});var L=n(29540);Object.defineProperty(t,"Circle3d",{enumerable:!0,get:function(){return L.Circle3d}});var V=n(97935);Object.defineProperty(t,"Surface",{enumerable:!0,get:function(){return V.Surface}});var R=n(5804);Object.defineProperty(t,"Plane",{enumerable:!0,get:function(){return R.Plane}});var U=n(29453);Object.defineProperty(t,"Cylinder",{enumerable:!0,get:function(){return U.Cylinder}});var B=n(24013);Object.defineProperty(t,"Cone",{enumerable:!0,get:function(){return B.Cone}});var F=n(83925);Object.defineProperty(t,"Sphere",{enumerable:!0,get:function(){return F.Sphere}});var k=n(737);Object.defineProperty(t,"NurbsSurface",{enumerable:!0,get:function(){return k.NurbsSurface}});var G=n(47423);Object.defineProperty(t,"SweepSurface",{enumerable:!0,get:function(){return G.SweepSurface}});var j=n(78680);Object.defineProperty(t,"OffsetSurface",{enumerable:!0,get:function(){return j.OffsetSurface}});var z=n(48448);Object.defineProperty(t,"NurbsCurve2d",{enumerable:!0,get:function(){return z.NurbsCurve2d}});var W=n(93145);Object.defineProperty(t,"NurbsCurve3d",{enumerable:!0,get:function(){return W.NurbsCurve3d}});var q=n(43364);Object.defineProperty(t,"SmoothPoly2d",{enumerable:!0,get:function(){return q.SmoothPoly2d}});var H=n(67579);Object.defineProperty(t,"SmoothPoly3d",{enumerable:!0,get:function(){return H.SmoothPoly3d}});var Y=n(57249);Object.defineProperty(t,"OffsetCurve2d",{enumerable:!0,get:function(){return Y.OffsetCurve2d}});var X=n(53487);Object.defineProperty(t,"OffsetCurve3d",{enumerable:!0,get:function(){return X.OffsetCurve3d}});var J=n(24533);Object.defineProperty(t,"ExtendCurve2d",{enumerable:!0,get:function(){return J.ExtendCurve2d}});var K=n(9327);Object.defineProperty(t,"ExtendCurve3d",{enumerable:!0,get:function(){return K.ExtendCurve3d}});var Z=n(274);Object.defineProperty(t,"IntersectCurve3d",{enumerable:!0,get:function(){return Z.IntersectCurve3d}});var $=n(57991);Object.defineProperty(t,"PolyCurve",{enumerable:!0,get:function(){return $.PolyCurve}});var Q=n(16178);Object.defineProperty(t,"Loop",{enumerable:!0,get:function(){return Q.Loop}});var ee=n(44210);Object.defineProperty(t,"Polygon",{enumerable:!0,get:function(){return ee.Polygon}});var te=n(75105);Object.defineProperty(t,"TrimmedSurface",{enumerable:!0,get:function(){return te.TrimmedSurface}});var ne=n(94665);Object.defineProperty(t,"EvolutionMap",{enumerable:!0,get:function(){return ne.EvolutionMap}});var re=n(14485);Object.defineProperty(t,"InvBilinear",{enumerable:!0,get:function(){return re.InvBilinear}});var se=n(22522);Object.defineProperty(t,"gaussIntegration",{enumerable:!0,get:function(){return se.gaussIntegration}});var ie=n(52716);Object.defineProperty(t,"SolveEquationUtil",{enumerable:!0,get:function(){return ie.SolveEquationUtil}});var oe=n(66922);Object.defineProperty(t,"SVGParser",{enumerable:!0,get:function(){return oe.SVGParser}});var ae=n(22480);Object.defineProperty(t,"ObjParser",{enumerable:!0,get:function(){return ae.ObjParser}});var ce=n(60229);Object.defineProperty(t,"CONST",{enumerable:!0,get:function(){return ce.CONST}});var le=n(22283);Object.defineProperty(t,"Loader",{enumerable:!0,get:function(){return le.Loader}});var de=n(13982);Object.defineProperty(t,"registerLoader",{enumerable:!0,get:function(){return de.registerLoader}});var ue=n(49246);Object.defineProperty(t,"MathUtil",{enumerable:!0,get:function(){return ue.Util}});var he=n(11067);Object.defineProperty(t,"GeomUtil",{enumerable:!0,get:function(){return he.GeomUtil}});var ge=n(34410);Object.defineProperty(t,"CurveUtil",{enumerable:!0,get:function(){return ge.CurveUtil}});var fe=n(52463);Object.defineProperty(t,"UvUtil",{enumerable:!0,get:function(){return fe.UvUtil}});var pe=n(43638);Object.defineProperty(t,"SurfaceUtil",{enumerable:!0,get:function(){return pe.SurfaceUtil}});var _e=n(2276);Object.defineProperty(t,"ClipperUtil",{enumerable:!0,get:function(){return _e.ClipperUtil}});var me=n(44757);Object.defineProperty(t,"MathAssert",{enumerable:!0,get:function(){return me.MathAssert}});var ve=n(54060);Object.defineProperty(t,"UnitType",{enumerable:!0,get:function(){return ve.UnitType}}),Object.defineProperty(t,"UnitsConversion",{enumerable:!0,get:function(){return ve.UnitsConversion}}),Object.defineProperty(t,"NormalUnitsConversion",{enumerable:!0,get:function(){return ve.NormalUnitsConversion}});var Ee=n(63814);Object.defineProperty(t,"Log",{enumerable:!0,get:function(){return Ee.Log}}),Object.defineProperty(t,"LogCall",{enumerable:!0,get:function(){return Ee.LogCall}});var Pe=n(4097);Object.defineProperty(t,"MathError",{enumerable:!0,get:function(){return Pe.MathError}}),Object.defineProperty(t,"MathErrorType",{enumerable:!0,get:function(){return Pe.MathErrorType}})},22480:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjParser=void 0;t.ObjParser=class{static exportMeshes(e){let t="";for(const n of e)for(let e=0;e<n.vertices.length;e+=3)t+=`v ${n.vertices[e]} ${n.vertices[e+1]} ${n.vertices[e+2]}\n`;for(const n of e)for(let e=0;e<n.uvs.length;e+=2)t+=`vt ${n.uvs[e]} ${n.uvs[e+1]}\n`;for(const n of e)for(let e=0;e<n.normals.length;e+=3)t+=`vn ${n.normals[e]} ${n.normals[e+1]} ${n.normals[e+2]}\n`;let n=1;for(const r of e){for(let e=0;e<r.faces.length;e+=3){const s=r.faces[e]+n,i=r.faces[e+1]+n,o=r.faces[e+2]+n;t+=`f ${s}/${s}/${s} ${i}/${i}/${i} ${o}/${o}/${o}\n`}n+=r.vertices.length/3}return t}}},66922:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SVGParser=void 0;const r=n(90361),s=n(74729),i=n(6688),o=n(26581),a=n(33218),c=n(10909),l=n(32858),d=n(48448),u=n(57991),h=n(60229),g=n(49246);class f{static stringToPolyCurves(e,t=!0){const n=[],r=f._SVGStringToCommands(e),i=(e,t)=>e-(t-e),o=e=>t?Math.round(100*e)/100:e;let d=a.Vector2.O(),h=a.Vector2.O(),p=[];for(const e of r){const t=e.cmd,r=e.data,f=a.Vector2.O();let _;switch(t){case"M":p.length>0&&n.push(new u.PolyCurve(p)),p=[],f.x=o(r[0]),f.y=o(r[1]);break;case"L":f.x=o(r[0]),f.y=o(r[1]),h.x=f.x,h.y=f.y,f.equals(d)||p.push(new l.Line2d(d,f));break;case"H":f.x=o(r[0]),h=f.clone(),f.equals(d)||p.push(new l.Line2d(d,f));break;case"V":f.y=o(r[0]),h=f.clone(),f.equals(d)||p.push(new l.Line2d(d,f));break;case"C":if(f.x=o(r[4]),f.y=o(r[5]),h.x=o(r[2]),h.y=o(r[3]),_=this._createBezierCurve([d,new a.Vector2(o(r[0]),o(r[1])),h,f],d),!_)continue;p.push(_);break;case"Q":if(f.x=o(r[2]),f.y=o(r[3]),h.x=o(r[0]),h.y=o(r[1]),_=this._createBezierCurve([d,h,f],d),!_)continue;p.push(_);break;case"S":if(f.x=o(r[2]),f.y=o(r[3]),_=this._createBezierCurve([d,new a.Vector2(i(d.x,h.x),i(d.y,h.y)),new a.Vector2(o(r[0]),o(r[1])),f],d),h.x=o(r[0]),h.y=o(r[1]),!_)continue;p.push(_);break;case"T":if(f.x=o(r[0]),f.y=o(r[1]),_=this._createBezierCurve([d,new a.Vector2(i(d.x,h.x),i(d.y,h.y)),f],d),h.x=i(d.x,h.x),h.y=i(d.y,h.y),!_)continue;p.push(_);break;case"A":if(f.x=r[5],f.y=r[6],g.Util.isNearlyEqual(r[0],r[1])){const e=this._computeArcInfo(r[0],d,f,!r[3],!!r[4]).center,t=!!r[4],n=c.Arc2d.makeArcByStartEndPoints(e,d,f,t);p.push(n)}else{const e=r[2]*Math.PI/180,t=this._computeEllipseInfo(r[0],r[1],e,d,f,!!r[3],!!r[4]),n=t.center,i=!!r[4],o=new a.Vector2(1,0).rotate(a.Vector2.O(),e),l=new s.Coordinate2(n,o);let u=[t.startAngle,t.endAngle];i||(u=[-t.startAngle,-t.endAngle]);const h=new c.Arc2d(l,r[0],r[1],i,u);p.push(h)}break;case"Z":p.length&&!p[0].getStartPt().equals(d)&&p.push(new l.Line2d(d,p[0].getStartPt()))}d=f}return n.push(new u.PolyCurve(p)),n}static svgDataToPolyCurves(e,t=!0){const n=[];e.outterFaces.forEach((e=>{const r=f.stringToPolyCurves(e.path,t);for(const e of r)0!==e.getAllCurves().length&&n.push(e)}));const s=new r.Box2;n[0].getAllCurves().forEach((e=>{s.union(e.getBoundingBox())})),e.innerFaces.forEach((e=>{const r=f.stringToPolyCurves(e.path,t);for(const e of r)0!==e.getAllCurves().length&&n.push(e)}));const i=s.getCenter(),c=s.getSize(),l=o.Matrix3.makeTranslate(i.multiplied(-1));l.applyScale(a.Vector2.O(),10);const d=o.Matrix3.makeTranslate({x:10*c.x/2,y:10*c.y/2});return n.forEach((e=>{e.transform(l).transform(d)})),n}static _SVGStringToCommands(e){const t=e=>{const t=e.split(/[\s,]+/),n=[];for(let e=0;e<t.length;e++){const r=t[e];if(r.indexOf(".")!==r.lastIndexOf(".")){const n=r.split(".");for(let r=2;r<n.length;r++)t.splice(e+r-1,0,`0.${n[r]}`)}n.push(parseFloat(r))}return n},n=e.match(/[a-df-z][^a-df-z]*/gi),r=[];if(n)for(let e=0;e<n.length;e++){const s=n[e],i=s.charAt(0),o=s.substr(1).trim();r.push({cmd:i,data:t(o)})}return r}static _createBezierCurve(e,t){const n=(e=>{const t=[];for(const n of e)t.every((e=>!e.equals(n)))&&t.push(n);return t})(e);if(!(n.length<=1))return 2!==n.length||t.equals(e[e.length-1])?d.NurbsCurve2d.makeBezier(n):new l.Line2d(t,e[e.length-1])}static _computeEllipseInfo(e,t,n,r,s,i,o){const c=(r.x-s.x)/2,l=(r.y-s.y)/2,d=Math.cos(n)*c+Math.sin(n)*l,u=-Math.sin(n)*c+Math.cos(n)*l;let h=Math.abs(e),g=Math.abs(t),f=h*h,p=g*g;const _=d*d,m=u*u,v=_/f+m/p;if(v>1){const e=Math.sqrt(v);h*=e,g*=e,f=h*h,p=g*g}const E=f*m+p*_,P=(f*p-E)/E;let y=Math.sqrt(Math.max(0,P));i===o&&(y=-y);const C=y*h*u/g,S=-y*g*d/h,T=Math.cos(n)*C-Math.sin(n)*S+(r.x+s.x)/2,b=Math.sin(n)*C+Math.cos(n)*S+(r.y+s.y)/2,w=(e,t,n,r)=>{const s=e*n+t*r,i=Math.sqrt(e*e+t*t)*Math.sqrt(n*n+r*r);let o=Math.acos(Math.max(-1,Math.min(1,s/i)));return e*r-t*n<0&&(o=-o),o},x=w(1,0,(d-C)/h,(u-S)/g),M=w((d-C)/h,(u-S)/g,(-d-C)/h,(-u-S)/g)%(2*Math.PI);return{center:new a.Vector2(T,b),startAngle:x,endAngle:x+M}}static _computeArcInfo(e,t,n,r,s){const o=t.midTo(n),c=(n.x-t.x)/2,d=(n.y-t.y)/2,u=new a.Vector2(-d,c);r!==s&&u.reverse();const g=c*c+d*d,f=Math.sqrt(e*e-g),p=new l.Line2d(o,u,i.Interval.infinitArray()).getPtAt(f);let _=2*Math.asin(Math.sqrt(g)/e);return r||(_=h.CONST.PI2-_),{center:p,angle:_}}}t.SVGParser=f},22283:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Loader=void 0;class n{static registerLoader(...e){for(const t of e){const e=(new t).getType();if(this._ctors.has(e))return;this._ctors.set(e,t)}}static reflect(e){const t=[],n=e.split("\n");for(let e of n)if(e=e.trim(),!(e.length<10))try{const n=JSON.parse(e);if(Array.isArray(n))n.forEach((e=>{const n=this.load(e);t.push(n)}));else{const e=this.load(n);t.push(e)}}catch(e){}return t}static load(e){const t=this._ctors.get(e.type);if(!t)throw new Error(`请注册类型:${e.type}`);return(new t).load(e)}static reflectMesh(e){const t=[],n=e.split("\n");for(let e of n)if(e=e.trim(),!(e.length<10))try{const n=JSON.parse(e);if(!(n.faces&&n.normals&&n.vertices&&n.uvs))throw new Error("load数据的类型不正确");n.type="RENDER_MESH",n.data=[n.vertices,n.faces,n.normals,n.uvs],n.vertices=[],n.faces=[],n.uvs=[];const r=this.load(n);t.push(r)}catch(e){}return t}}t.Loader=n,n._ctors=new Map},13982:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.registerLoader=void 0;const r=n(22283);t.registerLoader=function(e){r.Loader.registerLoader(e)}},22522:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gaussIntegration=void 0;const n=[1,.6521451548625461,.3478548451374538,.362683783378362,.3137066458778873,.2223810344533745,.1012285362903763,.1894506104550685,.1826034150449236,.1691565193950025,.1495959888165767,.1246289712555339,.0951585116824928,.0622535239386479,.0271524594117541,.0965400885147278,.0956387200792749,.0938443990808046,.0911738786957639,.0876520930044038,.0833119242269467,.0781938957870703,.0723457941088485,.0658222227763618,.0586840934785355,.0509980592623762,.0428358980222267,.0342738629130214,.0253920653092621,.0162743947309057,.0070186100094701,.0486909570091397,.0485754674415034,.048344762234803,.0479993885964583,.0475401657148303,.04696818281621,.0462847965813144,.0454916279274181,.0445905581637566,.0435837245293235,.0424735151236536,.0412625632426235,.0399537411327203,.0385501531786156,.03705512854024,.0354722132568824,.0338051618371416,.0320579283548516,.0302346570724025,.0283396726142595,.0263774697150547,.0243527025687109,.0222701738083833,.0201348231535302,.0179517157756973,.0157260304760247,.0134630478967186,.0111681394601311,.0088467598263639,.0065044579689784,.0041470332605625,.0017832807216964],r=[.5773502691896257,.3399810435848563,.8611363115940526,.1834346424956498,.525532409916329,.7966664774136267,.9602898564975363,.0950125098376374,.2816035507792589,.4580167776572274,.6178762444026438,.755404408355003,.8656312023878318,.9445750230732326,.9894009349916499,.0483076656877383,.1444719615827965,.2392873622521371,.3318686022821277,.4213512761306353,.5068999089322294,.5877157572407623,.6630442669302152,.7321821187402897,.7944837959679424,.84936761373257,.8963211557660521,.9349060759377397,.9647622555875064,.9856115115452684,.9972638618494816,.0243502926634244,.072993121787799,.1214628192961206,.1696444204239928,.2174236437400071,.2646871622087674,.311322871990211,.3572201583376681,.4022701579639916,.4463660172534641,.489403145707053,.5312794640198946,.571895646202634,.6111553551723933,.6489654712546573,.6852363130542333,.7198818501716109,.7528199072605319,.7839723589433414,.8132653151227975,.8406292962525803,.8659993981540928,.8893154459951141,.9105221370785028,.9295691721319396,.9464113748584028,.9610087996520538,.973326827789911,.983336253884626,.9910133714767443,.9963401167719553,.9993050417357722];t.gaussIntegration=function(e,t,s,i,o){const a=.5*(s-t),c=.5*(s+t);let l=0,d=0,u=0,h=0,g=0,f=e(.4226497308103743*a+t);f+=e(1.5773502691896257*a+t),f*=a;let p=1,_=1;for(let t=1;t<6;t++){_*=2,l=0;for(let t=0;t<_;t++)d=a*r[p+t],u=e(c-d),h=e(c+d),g=u+h,l+=n[p+t]*g;p+=_,l*=a;const t=Math.abs(f-l);if(t<Math.abs(o*l)||t<i)return l;f=l}return l}},14485:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InvBilinear=void 0;const r=n(49246);t.InvBilinear=class{constructor(e,t,n,r,s,i,o,a){this._u0=e,this._u1=t,this._v0=n,this._v1=r,this._p0=s,this._p1=i,this._p2=o,this._p3=a}solve(e){const t=this._p1.subtracted(this._p0),n=this._p2.subtracted(this._p0),s=this._p3.subtracted(this._p2).added(t.reversed()),i=e.subtracted(this._p0),o=1e-4,a=s.cross(n),c=t.cross(n)+i.cross(s),l=i.cross(t);let d,u,h,g;if(Math.abs(a)<=o)d=-l/c;else{const e=c*c-4*a*l;if(e>=0){const t=Math.sqrt(e);d=.5*(-c+t)/a,u=.5*(-c-t)/a}}if(void 0!==d){const e=t.added(s.multiplied(d));h=Math.abs(e.x)>Math.abs(e.y)?(i.x-n.x*d)/e.x:(i.y-n.y*d)/e.y}if(void 0!==u){const e=t.added(s.multiplied(u));g=Math.abs(e.x)>Math.abs(e.y)?(i.x-n.x*u)/e.x:(i.y-n.y*u)/e.y}let f=h,p=d;if(void 0===u||r.Util.isInRange(h,0,1,o)||r.Util.isInRange(d,0,1,o)||(f=g,p=u),void 0!==f&&void 0!==p)return f=this._u0+f*(this._u1-this._u0),p=this._v0+p*(this._v1-this._v0),[f,p]}}},6837:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CubicEquation=void 0;const r=n(86059),s=n(44757),i=n(12351);function o(e){const t=Math.pow(Math.abs(e),1/3);return e>0?t:-t}t.CubicEquation=class{static solve(e,t,n,s){if(Math.abs(e)<1e-12)return r.QuadraticEquation.solve(t,n,s);const a=(3*e*n-t*t)/(3*e*e),c=(27*e*e*s-9*e*t*n+2*t*t*t)/(27*e*e*e),l=(()=>{if(Math.abs(a)<1e-12&&Math.abs(c)<1e-12)return[0];const e=c/2,t=a/3,n=e*e+t*t*t;if(n>-1e-16){const t=Math.sqrt(Math.abs(n)),r=o(-e+t),s=o(-e-t),a=r+s;if(n>1e-7)return[a];const c=new i.Plurality(-.5,Math.sqrt(3)/2),l=c.multiplied(c),d=c.scaled(r).added(l.scaled(s)),u=l.scaled(r).added(c.scaled(s));return[a,d.added(u).a/2]}const r=Math.sqrt(-t*t*t),s=2*o(r),l=Math.acos(-c/(2*r));return[s*Math.cos(l),s*Math.cos(l+2*Math.PI/3),s*Math.cos(l+4*Math.PI/3)]})(),d=-t/(3*e);return l.map((e=>e+d))}static solve2(e,t,n,i){if(Math.abs(e)<1e-12)return r.QuadraticEquation.solve(t,n,i);const a=t*t-3*e*n,c=t*n-9*e*i,l=n*n-3*t*i;if(Math.abs(a)<1e-12&&Math.abs(c)<1e-12)return Math.abs(e)>Math.abs(t)?Math.abs(e)>=Math.abs(n)?[-t/(3*e)]:[-3*i/n]:Math.abs(t)>=Math.abs(n)?[-n/t]:[-t/(3*e)];const d=c*c-4*a*l;if(d>1e-12){const n=Math.sqrt(d),r=a*t+3*e*(-c-n)/2,s=o(a*t+3*e*(-c+n)/2),i=o(r),l=(-t-s-i)/(3*e);if(Math.abs(s-i)>1e-8)return[l];return[l,-t/(3*e)+(s+i)/(6*e)]}if(Math.abs(d)<1e-12){if(Math.abs(a)<1e-12)return void s.MathAssert.warn("解三次方程错误！");const n=c/a;return[-t/e+n,-n/2]}const u=(2*a*t-3*e*c)/(2*Math.pow(a,1/3)),h=Math.acos(u),g=Math.cos(h/3),f=Math.sqrt(a);return[(-t-2*f*g)/(3*e),(-t+f*(g+1.7320508075688772*Math.sin(h/3)))/(3*e),(-t+f*(g-1.7320508075688772*Math.sin(h/3)))/(3*e)]}}},97700:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LinearSystem=void 0;const r=n(72564),s=n(26581),i=n(61210),o=n(56973),a=n(4097);t.LinearSystem=class{static execute(e,t){if(e.length<1||e.length!==e[0].length)return;if(2===e.length){const n=e[0][0]*e[1][1]-e[0][1]*e[1][0],r=t[0]*e[1][1]-t[1]*e[0][1];if(Math.abs(n)<o.Tolerance.CALCULATE_EPS)return Math.abs(e[0][0])<o.Tolerance.NUMBER_CALCULATION_EPS&&(Math.abs(e[0][0])<Math.abs(e[1][0])||Math.abs(e[0][1])<o.Tolerance.NUMBER_CALCULATION_EPS&&Math.abs(e[0][1])<Math.abs(e[1][1]))&&([e[0],e[1]]=[e[1],e[0]],[t[0],t[1]]=[t[1],t[0]]),Math.abs(r)<o.Tolerance.CALCULATE_EPS?Math.abs(e[0][0])>Math.abs(e[0][1])?[t[0]/e[0][0],0]:[0,t[0]/e[0][1]]:Math.abs(t[1])<o.Tolerance.ZERO_JUDGE_EPS&&Math.abs(e[1][0])<o.Tolerance.ZERO_JUDGE_EPS&&Math.abs(e[1][0])<o.Tolerance.ZERO_JUDGE_EPS?[t[0]/e[0][0],0]:void 0;const s=1/n;return[r*s,(t[1]*e[0][0]-t[0]*e[1][0])*s]}const n=r.det(e);if(Math.abs(n)>o.Tolerance.CALCULATE_EPS)return r.solve(e,t);const c=e=>{for(let n=0;n<t.length;n++)if(Number.isNaN(e[n]))return!1;return!0};let l=r.svd(e),d=0;for(;!c(l.S)&&d<4;){const t=o.Tolerance.ZERO_JUDGE_EPS*Math.pow(100,d);for(const n of e)for(let e=0;e<n.length;e++)n[e]=Math.abs(n[e])<t?0:n[e]+t;l=r.svd(e),d++}if(3===e.length){const e=new s.Matrix3(l.V),n=new s.Matrix3;for(let e=0;e<3;e++)l.S[e]<o.Tolerance.CALCULATE_EPS?n.set(e,e,l.S[e]):n.set(e,e,1/l.S[e]);const r=new s.Matrix3(l.U);return e.transposed().multiplied(n).multiply(r).multipliedVector3([t[0],t[1],t[2]])}if(4===e.length){const e=new i.Matrix4(l.V),n=new i.Matrix4;for(let e=0;e<4;e++)l.S[e]<o.Tolerance.CALCULATE_EPS?n.set(e,e,l.S[e]):n.set(e,e,1/l.S[e]);const r=new i.Matrix4(l.U);return e.transposed().multiplied(n).multiply(r).multipliedVector4([t[0],t[1],t[2],t[3]])}a.MathError.warn("不支持的类型：矩阵不满秩，且矩阵A的维数 > 4")}}},21728:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NonlinearSystem=void 0;const r=n(56973),s=n(97700),i=n(60229);t.NonlinearSystem=class{static execute(e,t,n,o=r.Tolerance.LENGTH_EPS,a=r.Tolerance.ANGLE_EPS,c){const l=Math.sin(a),d=.01*o,u=Math.sin(.01*a),h=(e,n)=>{const i=t(e);if(Math.abs(i[0][0]*i[1][1]-i[0][1]*i[1][0])<r.Tolerance.CALCULATE_EPS)return[];const o=s.LinearSystem.execute(i,n);return void 0!==o?o:[]},g=(e,t,n,r)=>!(!(Math.abs(t[0])<r&&Math.abs(t[1])<r)||void 0!==c&&!c(e,n));let f=0,p=n,_=e(p),m=!0;for(;f<i.CONST.NORMAL_ITER_NUM||m;){const t=h(p,_);if(0===t.length)return g(p,_,o,l)?p:[];const n=[p[0]-t[0],p[1]-t[1]],s=e(n);if(g(n,s,d,u))return n;if(f>=i.CONST.NORMAL_ITER_NUM&&Math.abs(s[0])<Math.abs(_[0])-r.Tolerance.CALCULATE_EPS&&Math.abs(s[1])<Math.abs(_[1])-r.Tolerance.CALCULATE_EPS&&(m=!0),p=n,_=s,f>i.CONST.MAX_ITER_NUM)break;f++}return g(p,_,o,l)?p:[]}}},12351:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Plurality=void 0;class n{constructor(e,t){this.a=e,this.b=t}added(e){return new n(this.a+e.a,this.b+e.b)}subed(e){return new n(this.a-e.a,this.b-e.b)}scaled(e){return new n(this.a*e,this.b*e)}multiplied(e){const t=this.a*e.a-this.b*e.b,r=this.a*e.b+this.b*e.a;return new n(t,r)}}t.Plurality=n},86059:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QuadraticEquation=void 0;const r=n(56973),s=n(4097);t.QuadraticEquation=class{static solve(e,t,n,i=r.Tolerance.CALCULATE_EPS){if(Math.abs(e)<i)return Math.abs(t)<i?(s.MathError.warn("QuadraticEquation方程不合法：a = b = 0"),Math.abs(n)>i?[NaN]:[0]):[n/t];const o=i*i,a=t*t,c=4*e*n;let l=a-c;const d=(a+Math.abs(c))/2;if(l<-o||d>1e12&&l/d<-o)return s.MathError.warn("QuadraticEquation方程无解：b * b - 4 * a * c < 0"),[];l<o&&(l=0);const u=Math.sqrt(l),h=(-t-u)/(2*e),g=(-t+u)/(2*e);return Math.abs(g-h)<i?[h]:[h,g]}}},52716:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SolveEquationUtil=void 0;const r=n(56973),s=n(60229),i=n(6837),o=n(86059);t.SolveEquationUtil=class{static solveQuadraticEquation(e,t,n){return o.QuadraticEquation.solve(e,t,n)}static solveCubicEquation(e,t,n,r){return i.CubicEquation.solve(e,t,n,r)}static execute(e,t,n,s=r.Tolerance.NUMBER_CALCULATION_EPS){return this.quadraticInterpolation(e,t,n,s)}static iterationNewton(e,t,n,i=r.Tolerance.NUMBER_CALCULATION_EPS,o,a){let c=0,l=n,d=!0;for(;c<s.CONST.NORMAL_ITER_NUM||d;){const n=e(l),o=l-n/t(l);if(Math.abs(o-l)<i||c>(a||s.CONST.MAX_ITER_NUM)){l=o;break}if(c>=s.CONST.NORMAL_ITER_NUM){const t=e(o);d=Math.abs(t)<Math.abs(n)-r.Tolerance.CALCULATE_EPS}l=o,c++}if(Math.abs(e(l))<(o||i))return l}static linearInterpolation(e,t,n=r.Tolerance.NUMBER_CALCULATION_EPS){let i=0,o=t,a=!0;const c=1e-4;for(;i<s.CONST.NORMAL_ITER_NUM||a;){const t=e(o),l=o-t*c/(e(o+c)-t);if(Math.abs(l-o)<n||i>s.CONST.MAX_ITER_NUM){o=l;break}i>=s.CONST.NORMAL_ITER_NUM&&(a=Math.abs(e(l))<Math.abs(e(o))-r.Tolerance.CALCULATE_EPS),o=l,i++}if(Math.abs(e(o))<n)return o}static quadraticInterpolation(e,t,n,i=r.Tolerance.NUMBER_CALCULATION_EPS){let o=0,a=n;const c=[t,n,(t+n)/2],l=[e(c[0]),e(c[1]),e(c[2])];let d=!0;for(;o<s.CONST.NORMAL_ITER_NUM||d;){const t=c[1]-c[0],n=c[2]-c[1],u=(l[1]-l[0])/t,h=(l[2]-l[1])/n,g=(h-u)/(t+n),f=g*n+h,p=l[2],_=f*f,m=4*g*p;if(_-m<0){if(a=-f/(2*g),Math.abs(a-c[2])<i)break}else{let e=Math.sqrt(_-m);e=f>0?e:-e;const t=-2*p/(f+e);if(a=c[2]+t,Math.abs(t)<i)break}if(Math.abs(a-c[1])<Math.abs(a-c[0])?([c[0],c[1],c[2]]=[c[1],c[2],a],[l[0],l[1],l[2]]=[l[1],l[2],e(a)]):([c[1],c[2]]=[c[2],a],[l[1],l[2]]=[l[2],e(a)]),o>=s.CONST.NORMAL_ITER_NUM&&(d=Math.abs(l[2])<Math.abs(l[1])-r.Tolerance.CALCULATE_EPS),o>s.CONST.MAX_ITER_NUM)break;o++}if(Math.abs(e(a))<i)return a}static inverseQuadraticInterpolation(e,t=.5,n,i=r.Tolerance.NUMBER_CALCULATION_EPS){let o=0,a=t;const c=[t-n,t+n,t],l=[e(c[0]),e(c[1]),e(c[2])];let d=!0;for(;o<s.CONST.NORMAL_ITER_NUM||d;){if(Math.abs(l[0]-l[1])<i||Math.abs(l[0]-l[2])<i){if(a=c[2]-l[2]*(c[1]-c[2])/(l[1]-l[2]),Math.abs(a-c[2])<i)break;[c[0],c[1],c[2]]=[c[1],c[2],a],[l[0],l[1],l[2]]=[l[1],l[2],e(a)],o++;continue}if(Math.abs(l[1]-l[2])<i){if(a=c[2]-l[2]*(c[0]-c[2])/(l[0]-l[2]),Math.abs(a-c[2])<i)break;[c[1],c[2]]=[c[2],a],[l[1],l[2]]=[l[2],e(a)],o++;continue}const t=l[0]-l[1],n=l[1]-l[2],u=l[2]-l[0];if(a=c[0]*l[1]*l[2]/(t*-u)+c[1]*l[0]*l[2]/(n*-t)+c[2]*l[0]*l[1]/(u*-n),Math.abs(a-c[2])<i)break;if(Math.abs(a-c[1])<Math.abs(a-c[0])?([c[0],c[1],c[2]]=[c[1],c[2],a],[l[0],l[1],l[2]]=[l[1],l[2],e(a)]):([c[1],c[2]]=[c[2],a],[l[1],l[2]]=[l[2],e(a)]),o>=s.CONST.NORMAL_ITER_NUM&&(d=Math.abs(l[2])<Math.abs(l[1])-r.Tolerance.CALCULATE_EPS),o>s.CONST.MAX_ITER_NUM)break;o++}if(Math.abs(e(a))<i)return a}}},94665:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EvolutionMap=void 0;class n extends Map{add(e,...t){const n=this.get(e);n?n.push(...t):this.set(e,t)}remove(e,t){const n=this.get(t),r=(t,n)=>{const r=n.findIndex((t=>t===e));return!(r<0)&&(1===n.length?this.delete(t):n.splice(r,1),!0)};if(n)return r(t,n);if(t)return!1;let s=!1;for(const[e,t]of this.entries())s=s||r(e,t);return s}connectValueMap(e,t=!0){const r=new n;for(const[n,s]of this){const i=new Set;for(const t of s){const n=e.get(t);n&&n.forEach((e=>i.add(e)))}(i.size>0||t)&&r.set(n,Array.from(i))}return r}connectKeyMap(e,t=!0){return e.connectValueMap(this,t)}mergeValueMap(e){const t=new n,r=new Set;for(const[n,s]of this){const i=new Set;for(const t of s){const n=e.get(t);n?(n.forEach((e=>i.add(e))),r.add(t)):i.add(t)}t.set(n,Array.from(i))}for(const[n,s]of e)if(!r.has(n)){const e=t.get(n);e?e.push(...s):t.set(n,s)}return t}mergeKeyMap(e){return e.mergeValueMap(this)}appendKey(e,t){for(const[t,n]of e)if(void 0!==t)for(const e of n){const n=this.get(e);n&&this.add(t,...n)}if(t instanceof Array)for(const e of t)this.delete(e);else if(t)for(const t of e.values())for(const n of t)e.has(n)||this.delete(n)}uniqueValues(){const e=new Set;for(const t of this.values())for(const n of t)e.add(n);return[...e]}reversed(){const e=new n;for(const[t,n]of this)for(const r of n)e.add(r,t);return e}reversedWithEmptyValue(){const e=new n;for(const[t,n]of this)if(0===n.length)e.add(void 0,t);else for(const r of n)e.add(r,t);return e}clearUnusedKeys(e){const t=[];for(const n of this)e.has(n[0])||(t.push(n),this.delete(n[0]));return t}clearUnusedValues(e){const t=[],n=new Set;for(const[r,s]of this)for(let i=s.length-1;i>=0;i--)e.has(s[i])||(n.add(s[i]),1===s.length?(t.push(r),this.delete(r)):s.splice(i,1));return{keys:t,values:Array.from(n)}}}t.EvolutionMap=n},16178:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Loop=void 0;const o=n(68990),a=n(57991),c=n(33218),l=n(32858),d=n(97505),u=n(13982),h=n(56973),g=n(43640);let f=r=class extends a.PolyCurve{static createByRectangle(e,t){let n,s,i,o;e.x>t.x?(n=t.x,i=e.x):(n=e.x,i=t.x),e.y>t.y?(s=t.y,o=e.y):(s=e.y,o=t.y);const a=[new c.Vector2(n,s),new c.Vector2(i,s),new c.Vector2(i,o),new c.Vector2(n,o)];return new r(a)}static createByOffset(e,t,n){const s=e.clone(),i=e.clone();return s.offset(-t),i.offset(n),s.reverse(),new r([i,new l.Line2d(i.getEndPt(),s.getStartPt()),s,new l.Line2d(s.getEndPt(),i.getStartPt())])}constructor(e){if(super(),e&&e.length>0)if(e[0]instanceof o.Curve2d)e.forEach((e=>this.addCurve(e)));else for(let t=0;t<e.length;t++)new c.Vector2(e[t]).equals(e[(t+1)%e.length])||this.addCurve(new l.Line2d(e[t],e[(t+1)%e.length]))}isClosed(e=new h.Tolerance){const t=this._curves,n=t.length;for(let r=0;r<n;r++){const s=r-1<0?r-1+n:r-1;if(!t[r].getStartPt().equals(t[s].getEndPt(),e.lengthEps))return!1}return!0}isValid(e=new h.Tolerance){if(!super.isValid(e))return!1;const{length:t}=this._curves;return!(t<=0)&&this._curves[0].getStartPt().equals(this._curves[this._curves.length-1].getEndPt(),e.edgeLengthEps)}toPath(e=g.DiscreteParameter.NORMAL){const t=[];return this._curves.forEach((n=>{if(n.isLine2d())t.push(n.getStartPt());else{const r=n.discrete(e);r.pop(),t.push(...r)}})),t}getAllPoints(){const e=[];return this._curves.forEach((t=>{e.push(t.getStartPt())})),e}getType(){return d.EN_GEO_ELEMENT_TYPE.EN_LOOP}dump(){return super.dump()}load(e){return super.load(e)}clone(){return super.clone()}makeStartEndConnected(){return super.makeStartEndConnected(!0),this}};f=r=s([u.registerLoader,i("design:paramtypes",[Array])],f),t.Loop=f},57991:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.PolyCurve=void 0;const i=n(68990),o=n(33218),a=n(32858),c=n(97505),l=n(79890),d=n(90361),u=n(13982),h=n(22283),g=n(32171),f=n(90676),p=n(56973),_=n(49172),m=n(58074),v=n(11067),E=n(43640),P=n(70246);let y=class extends P.Geometry2d{constructor(e){if(super(),this._curves=[],e&&e.length>0)if(e[0]instanceof i.Curve2d)e.forEach((e=>this.addCurve(e)));else for(let t=0;t<e.length-1;t++)new o.Vector2(e[t]).equals(e[(t+1)%e.length])||this.addCurve(new a.Line2d(e[t],e[t+1]))}addCurve(e){return this._curves.push(e),e}offset(e){return this.getAllCurves().forEach((t=>{t.offset(e)})),this.makeStartEndConnected(),!0}makeStartEndConnected(e=!1){for(let e=0;e<this._curves.length-1;++e){const t=this._curves[e],n=this._curves[e+1];t.getEndPt().equals(n.getEndPt())&&n.reverse()}return this}insertCurve(e,...t){this._curves.splice(e,0,...t)}deleteByArrayIdx(e){return!!this._curves.splice(e,1).length}copyAllCurves(){return this._curves.map((e=>e.clone()))}getAllCurves(){return[...this._curves]}clear(){this._curves.splice(0)}isEmpty(){return!this._curves.length}isAnticlockwise(){return this.calcArea()>0}reverse(){for(const e of this._curves)e.reverse();return this._curves.reverse(),this}calcArea(){const{length:e}=this._curves;return e?_.LoopArea.areaOfLoop(this._curves):0}isValid(e=new p.Tolerance){const{length:t}=this._curves;if(!v.GeomUtil.curvesConnected(this._curves,e.edgeLengthEps))return!1;for(let n=0;n<t;n++){const r=this._curves[n];for(let s=n+1;s<t;s++){const t=this._curves[s],n=g.CurveCurvePositionJudge.execute(r,t,e.edgeLengthEps,e.angleEps);if(n!==f.CurveCuvePositonType.INTERSECT_ON&&n!==f.CurveCuvePositonType.NOT_INTERSECT)return!1}}return!0}isOnlyLines(){return!this._curves.find((e=>e.getType()!==c.EN_GEO_ELEMENT_TYPE.EN_LINE_2D))}translate(e){return this._curves.forEach((t=>t.translate(e))),this}rotate(e,t){return this._curves.forEach((n=>n.rotate(e,t))),this}scale(e,t=o.Vector2.O()){return this._curves.forEach((n=>n.scale(e,t))),this}transform(e){return this._curves.forEach((t=>t.transform(e))),l.isMirror(e)&&this.reverse(),this}reversed(){return this.clone().reverse()}transformed(e){return this.clone().transform(e)}getBoundingBox(){const e=new d.Box2;return this._curves.forEach((t=>e.union(t.getBoundingBox()))),e}toPath(){const e=this._curves.map((e=>e.getStartPt()));return e.push(this._curves[this._curves.length-1].getEndPt()),e}tessellate(e,t=E.DiscreteParameter.NORMAL){let n;return e&&(n={name:this.getType()===c.EN_GEO_ELEMENT_TYPE.EN_POLY_CURVE?"PolyCurve":"Loop",visible:!0}),{debugInfo:n,children:this._curves.map((n=>n.tessellate(e,t)))}}getCentroidPoint(){const e=this.getAllCurves();return m.LoopCentroid.centroidOfLoop(e)}getType(){return c.EN_GEO_ELEMENT_TYPE.EN_POLY_CURVE}clone(){return super.clone()}dump(){return{type:this.getType(),data:this._curves.map((e=>e.dump()))}}load({data:e}){return this._curves=e.map((e=>h.Loader.load(e))),this}};y=r([u.registerLoader,s("design:paramtypes",[Array])],y),t.PolyCurve=y},44210:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.Polygon=void 0;const o=n(16178),a=n(97505),c=n(33218),l=n(90361),d=n(13982),u=n(56973),h=n(58074),g=n(43640),f=n(70246),p=n(17980);let _=r=class extends f.Geometry2d{constructor(e){if(super(),this.loops=[],e&&(e instanceof o.Loop&&this.addLoop(e),e instanceof Array&&e.length>0)){if(e[0]instanceof Array){const t=e.map((e=>new o.Loop(e)));return this._sortLoopByArea(t),void t.forEach((e=>this.addLoop(e,!1)))}if(e[0]instanceof o.Loop){const t=[...e];return this._sortLoopByArea(t),void t.forEach((e=>this.addLoop(e,!1)))}"object"==typeof e[0]&&void 0!==e[0].x&&"number"==typeof e[0].x&&void 0!==e[0].y&&"number"==typeof e[0].y&&this.addLoop(new o.Loop(e))}}static createByRectangle(e,t){return new r(o.Loop.createByRectangle(e,t))}static fromPolygonEx(e){const t=[];e.forEach((e=>{t.push(...e.getLoops())}));const n=new r;return t.forEach((e=>n.addLoop(e,!1))),n}getLoops(){return this.loops}isEmpty(){return this.loops.length<1}reverse(){return this.loops.forEach((e=>{e.reverse()})),this}isOnlyLines(){for(const e of this.loops)if(!e.isOnlyLines())return!1;return!0}isValid(e=new u.Tolerance){if(this.loops.length<1)return!0;for(const t of this.loops)if(!t.isValid(e))return!1;if(1===this.loops.length)return!!this.loops[0].isAnticlockwise();const t=this.loops.map((e=>e.getBoundingBox()));for(let n=0;n<this.loops.length;n++)for(let r=n+1;r<this.loops.length;r++){const s=this.loops[n],i=this.loops[r];if(t[n].intersectsBox(t[r]))for(const t of s.getAllCurves())for(const n of i.getAllCurves())if(p.CurveCurveIntersect.curve2ds(t,n,e).length)return!1}return!0}addLoop(e,t=!0){return this.loops.push(e),t&&this._sortLoopByArea(this.loops),!0}makeStartEndConnected(){this.getLoops().forEach((e=>e.makeStartEndConnected()))}deleteAllLoops(){return this.loops.splice(0,this.loops.length),!0}copyAllCurves(){const e=[];return this.loops.forEach((t=>{e.push(...t.copyAllCurves())})),e}getAllCurves(){const e=[];return this.loops.forEach((t=>{e.push(...t.getAllCurves())})),e}calcArea(){let e=0;for(const t of this.loops)e+=t.calcArea();return e}getType(){return a.EN_GEO_ELEMENT_TYPE.EN_POLYGON}translate(e){return this.loops.forEach((t=>t.translate(e))),this}rotate(e,t){return this.loops.forEach((n=>n.rotate(e,t))),this}scale(e,t=c.Vector2.O()){return this.loops.forEach((n=>n.scale(e,t))),this}transform(e){return this.loops.forEach((t=>t.transform(e))),this}reversed(){return this.clone().reverse()}transformed(e){return this.clone().transform(e)}getBoundingBox(){const e=new l.Box2;for(const t of this.loops){const n=t.getBoundingBox();e.union(n)}return e}toPaths(){return this.getLoops().map((e=>e.toPath()))}dump(){return{type:this.getType(),data:this.loops.map((e=>e.dump()))}}load({data:e}){return e.map((e=>(new o.Loop).load(e))).forEach((e=>this.addLoop(e,!1))),this}tessellate(e,t=g.DiscreteParameter.NORMAL){return{debugInfo:{name:"Polygon",visible:!0},children:this.loops.map((n=>n.tessellate(e,t)))}}clone(){return super.clone()}getCentroidPoint(){const e=this.getAllCurves();return h.LoopCentroid.centroidOfLoop(e)}_sortLoopByArea(e){const t=e.map((e=>({area:e.calcArea(),loop:e}))).sort(((e,t)=>t.area-e.area));for(let n=0;n<t.length;n++)e[n]=t[n].loop}};_=r=s([d.registerLoader,i("design:paramtypes",[Object])],_),t.Polygon=_},75105:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.TrimmedSurface=void 0;const o=n(67996),a=n(56973),c=n(33218),l=n(43640),d=n(97935),u=n(24013),h=n(29453),g=n(5804),f=n(97505),p=n(13982),_=n(22283),m=n(44210),v=n(16178),E=n(50265),P=n(90676),y=n(17165);let C=r=class extends d.Surface{constructor(e,t,n,r){super(),this._bPositive=!0,e&&t&&void 0!==n&&(this._surface=e,this._uvPolygon=t,this._bPositive=n,this._loops=r||this._uvPolygon.getLoops().map((e=>e.getAllCurves().map((e=>this._surface.getCurve3d(e))))))}static createPlane(e,t,n){const s=n||t,i=[[-1,-1],[1,-1],[1,1],[-1,1]].map((e=>({x:e[0]*t,y:e[1]*s})));return new r(new g.Plane(e),new m.Polygon(i),!0)}static createByRangeUV(e,t,n,s=!0){const i=[new c.Vector2(t.min,n.min),new c.Vector2(t.max,n.min),new c.Vector2(t.max,n.max),new c.Vector2(t.min,n.max)],o=new m.Polygon(new v.Loop(i));return new r(e,o,s)}static createByBoundary2d(e,t,n){const s=t.map((t=>t.map((t=>e.getCurve3d(t))))),i=new m.Polygon(t.map((e=>new v.Loop(e))));return new r(e,i,n,s)}static createByBoundary3d(e,t,n){if(e instanceof g.Plane||e instanceof u.Cone||e instanceof h.Cylinder){const s=t.map((t=>new v.Loop(e.wireToUV(t).loop)));return new r(e,new m.Polygon(s),n,t)}throw new Error("not implemented")}getSurface(){return this._surface}getSameDirWithSurface(){return this._bPositive}getUVPolygon(){return this._uvPolygon}getLoops(){return this._loops}reverse(){return this._bPositive=!this._bPositive,this}getPtAt(e){return this._surface.getPtAt(e)}getNormAt(e){return this._surface.getNormAt(e).multiply(this._bPositive?1:-1)}getDerivatives(e,t=1){return this._surface.getDerivatives(e,t)}getUVAt(e){return this._surface.getUVAt(e)}containsPoint(e,t=a.Tolerance.LENGTH_EPS){if(!this._surface.containsPoint(e,t))return!1;const n=this._surface.getUVAt(e);return E.PtPolygonPositionJudge.execute(n,this._uvPolygon,t)!==P.PtLoopPositonType.OUT}containsCurve(e,t=a.Tolerance.LENGTH_EPS){if(!this._surface.containsCurve(e,t))return!1;if(!this.getCurve2d(e))return!1;throw new Error("not implemented")}getDomainU(){return this._surface.getDomainU()}getDomainV(){return this._surface.getDomainV()}getIsoCurve(e,t){return this._surface.getIsoCurve(e,t)}getCurve2d(e){return this._surface.getCurve2d(e)}getCurve3d(e){return this._surface.getCurve3d(e)}getBoundingBox(){const e=new o.Box3;if(this._loops.length<1)return e;for(const t of this._loops[0])e.union(t.getBoundingBox());return e}isCoplanar(e,t){return this._surface.isCoplanar(e,t)}transform(e,t){return this._surface.transform(e,t),this._loops.forEach((n=>n.forEach((n=>n.transform(e,t))))),this._updateUvs(),this}transformed(e,t){return this.clone().transform(e,t)}clone(){const e=this._loops.map((e=>e.map((e=>e.clone()))));return new r(this._surface.clone(),this._uvPolygon.clone(),this._bPositive,e)}getType(){return f.EN_GEO_ELEMENT_TYPE.EN_TRIM}dump(){return{type:this.getType(),data:[this._surface.dump(),this._bPositive,this._uvPolygon.dump()]}}load({data:[e,t,n]}){return this._surface=_.Loader.load(e),this._bPositive=t,this._uvPolygon=_.Loader.load(n),this._loops=this._uvPolygon.getLoops().map((e=>e.getAllCurves().map((e=>this.getCurve3d(e))))),this}tessellate(e,t=l.DiscreteParameter.NORMAL,n=a.Tolerance.DEFAULT){return{debugInfo:{name:"裁剪曲面",visible:!0},mesh:this.discrete(t,n),children:e?[{debugInfo:{name:"轮廓线",visible:!0},children:this._loops.map((n=>n.map((n=>n.tessellate(e,t))))).flat()},{debugInfo:{name:this.getSurface().constructor.name,visible:!0}},{debugInfo:{name:this.getSameDirWithSurface()?"同向":"反向",visible:!0}}]:[]}}discrete(e=l.DiscreteParameter.NORMAL,t=a.Tolerance.DEFAULT){const n=this._uvPolygon.getLoops().map((e=>e.getAllCurves().map((e=>({pCurve:e})))));return y.DiscreteUtil.discreteSurface(this._surface,n,this._bPositive,e,t)}_updateUvs(){this._uvPolygon=new m.Polygon(this._loops.map((e=>new v.Loop(this._surface.wireToUV(e).loop))))}};C=r=s([p.registerLoader,i("design:paramtypes",[d.Surface,m.Polygon,Boolean,Array])],C),t.TrimmedSurface=C},60229:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CONST=void 0;class n{}t.CONST=n,n.PI=Math.PI,n.PI2=2*Math.PI,n.PI_2=Math.PI/2,n.PI_4=Math.PI/4,n.PI_6=Math.PI/6,n.PI_16=Math.PI/16,n.NORMAL_ITER_NUM=20,n.MAX_ITER_NUM=200,n.PI_12=Math.PI/12,n.MAX_SUBDEVIDE_DEPTH=16,n.MAX_INTERSECTION_NUM=1e3,n.MODEL_MAX_LENGTH=1e6,n.APPROX_ARC_MIN=Math.PI/180,n.APPROX_ARC_MAX=Math.PI/18,n.MAX_INTEGER=1e100,n.MAX_NEG_INTEGER=-1e100},97505:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_GEO_ELEMENT_TYPE=void 0,function(e){e.EN_INVALID="invalid",e.EN_GLOBAL="glb",e.EN_MATRIX_3="m3",e.EN_MATRIX_4="m4",e.EN_COORD_2="cord2",e.EN_COORD_3="cord3",e.EN_IMVECTOR_2D="imv2",e.EN_IMVECTOR_3D="imv3",e.EN_VECTOR_2D="v2",e.EN_VECTOR_3D="v3",e.EN_LINE_2D="ln2",e.EN_LINE_3D="ln3",e.EN_ARC_2D="ac2",e.EN_ARC_3D="ac3",e.EN_CIRCLE_2D="circ2",e.EN_CIRCLE_3D="circ3",e.EN_PARABOLA_3D="prbl3",e.EN_HYPERBOLA_3D="hybl3",e.EN_INTERSECT_3D="int3",e.EN_NURBS_CURVE_3D="ncv3",e.EN_NURBS_CURVE_2D="ncv2",e.EN_SMOOTHPOLY_2D="smpl2",e.EN_SMOOTHPOLY_3D="smpl3",e.EN_OFFSET_CURVE_2D="ocv2",e.EN_OFFSET_CURVE_3D="ocv3",e.EN_EXTEND_CURVE_2D="excv2",e.EN_EXTEND_CURVE_3D="excv3",e.EN_OFFSET_SURFACE="offs",e.EN_SWEEP_SURFACE="swps",e.EN_POLY_CURVE="plc",e.EN_LOOP="lop",e.EN_POLYGON="plg",e.EN_PLANE="pl",e.EN_CYLINDER="cld",e.EN_CONE="con",e.EN_SPHERE="sph",e.EN_TRIM="trims",e.EN_NURBS_SURFACE="nbs",e.EN_BREP_VERTEX="bv",e.EN_BREP_COEDGE="bc",e.EN_BREP_EDGE="be",e.EN_BREP_WIRE="bw",e.EN_BREP_FACE="bf",e.EN_BREP_SHELL="bs",e.EN_BREP_BODY="bb"}(t.EN_GEO_ELEMENT_TYPE||(t.EN_GEO_ELEMENT_TYPE={}))},65826:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ArrayUtil=void 0;t.ArrayUtil=class{static binarySearch(e,t){let n=0,r=e.length-1;for(;r>n+1;){const s=Math.floor((n+r)/2);e[s]>t?r=s:n=s}for(;n>0&&e[n-1]===t;)n--;return n}}},44757:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MathAssert=void 0;const r=n(4097);t.MathAssert=class{static assert(e,t="error",...n){0}static warn(e,t="error",...n){r.MathError.warn(e,t,r.MathErrorType.Algorithm,...n)}static mutedWarn(e,t="error",...n){r.MathError.mutedWarn(e,t,r.MathErrorType.Algorithm,...n)}}},45987:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClipperFormatConverter=void 0;const r=n(44210),s=n(16178),i=n(57991),o=n(97505);class a{static vector2ToXY(e){return{X:e.x,Y:e.y}}static vector2sToXY(e){return e.map((e=>({X:e.x,Y:e.y})))}static pathsToPolygon(e){const t=[];for(const n of e){const e=a.pathToLoop(n);e&&!e.isEmpty()&&t.push(e)}return new r.Polygon(t)}static pathToLoop(e){return new s.Loop(e.map((e=>({x:e.X,y:e.Y}))))}static loopToPath(e){return e.toPath().map((e=>a.vector2ToXY(e)))}static pathToPolyline(e){return new i.PolyCurve(e.map((e=>({x:e.X,y:e.Y}))))}static polylineToPath(e){return e.toPath().map((e=>({X:e.x,Y:e.y})))}static polygonToPaths(e){const t=[];return e.getLoops().forEach((e=>{const n=e.getAllCurves(),r=[];for(let t=0;t<n.length;t++){const s=n[t].discrete();t===n.length-1&&e.getType()!==o.EN_GEO_ELEMENT_TYPE.EN_LOOP||s.pop(),r.push(...s)}const s=[];r.forEach((e=>s.push({X:e.x,Y:e.y}))),r.length>0&&t.push(s)})),t}static clpExPolygonToPolygon(e){const t=[];for(let n=0;n<e.outer.length;n++)t.push(e.outer[n]);const n=a.pathsToPolygon([t]);for(let t=0;t<e.holes.length;t++){const r=[];for(let n=0;n<e.holes[t].length;n++)r.push(e.holes[t][n]);n.addLoop(a.pathToLoop(r))}return n}static clipperExPolygonsToPolygon(e){return e.map((e=>a.clpExPolygonToPolygon(e)))}}t.ClipperFormatConverter=a},2276:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClipperUtil=void 0;const r=n(20666),s=n(56973);class i{static clipperTreeToPathLists(e){const t=[],n=e.Childs();for(;n.length>0;){const e=n.pop(),r=[e.Contour()];for(const t of e.Childs())r.push(t.Contour()),n.push(...t.Childs());t.push(r)}return t}static xyLoopsToClipper(e,t=s.Tolerance.CLIPPER_SCALE){const n=e.map((e=>e.map((e=>new r.IntPoint(e.x,e.y)))));return r.JS.ScaleUpPaths(n,t),n}static clipperPathsToXys(e,t=s.Tolerance.CLIPPER_SCALE){return e.map((e=>e.map((e=>({x:e.X/t,y:e.Y/t})))))}static boolAsClipperPoint(e,t,n){const s=new r.Clipper;for(const t of e){const e=t[0][0]instanceof r.IntPoint?t:i.xyLoopsToClipper(t);s.AddPaths(e,r.PolyType.ptSubject,!0)}for(const e of t){const t=e[0][0]instanceof r.IntPoint?e:i.xyLoopsToClipper(e);s.AddPaths(t,r.PolyType.ptClip,!0)}const o=new r.PolyTree;return s.Execute(n,o,r.PolyFillType.pftEvenOdd,r.PolyFillType.pftEvenOdd),i.clipperTreeToPathLists(o)}static boolAsXys(e,t,n){return i.boolAsClipperPoint(e,t,n).map((e=>i.clipperPathsToXys(e)))}static removeGapByOffset(e,t){const n=s.Tolerance.CLIPPER_SCALE,o=i.xyLoopsToClipper(e,n),a=[1,-1,-1,1];for(const e of a){const s=new r.ClipperOffset;s.AddPaths(o,r.JoinType.jtMiter,r.EndType.etClosedPolygon),s.Execute(o,e*t*n)}return i.clipperPathsToXys(o,n)}}t.ClipperUtil=i},34410:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CurveUtil=void 0;const r=n(49172),s=n(43640),i=n(56973),o=n(61226),a=n(97602),c=n(32858),l=n(87222),d=n(48448),u=n(93145),h=n(57249),g=n(53487),f=n(43364),p=n(67579),_=n(94665),m=n(60229),v=n(9327),E=n(49246);class P{static getDzByCurve(e,t){if(e instanceof v.ExtendCurve3d){const t=e.getBaseCurve();return P.getDzByCurve(t)}if(e instanceof g.OffsetCurve3d)return e.getDz();if(e instanceof a.Arc3d)return e.getNormal();if(e instanceof u.NurbsCurve3d){const t=P.getDzByPoints(e.getControlPoints());if(t)return t}if(e instanceof p.SmoothPoly3d){const t=P.getDzByPoints(e.getPoints());if(t)return t}if(t)return t;return(e instanceof l.Line3d?e.getDirection():e.getMidPt().subtract(e.getStartPt())).getPerpendicular()}static getDzByPlaneCurve(e,t=i.Tolerance.ANGLE_EPS){if(e.isLineLike())return new o.Vector3;if(e instanceof a.Arc3d)return e.getNormal();if(e instanceof v.ExtendCurve3d){const t=e.getBaseCurve();return P.getDzByPlaneCurve(t)}if(e instanceof g.OffsetCurve3d)return e.getDz();const n=s.DiscreteParameter.LOW.hintSegmentCount,r=[],{min:c,max:l}=e.getRange(),d=(l-c)/n;for(let t=0;t<=n;t++){const n=d*t+c;r.push(e.getPtAt(n))}const u=new o.Vector3;for(let e=1;e<r.length;e++)r[e].subtract(r[0]);for(let e=2;e<r.length;e++){const n=r[e-1].cross(r[e]);if(!n.isParallel(u,t))return;u.add(n)}return u.normalize()}static getDzByCurves(e,t){const n=[];if(e.length>1){for(const t of e){const e=t.discrete(s.DiscreteParameter.LOW);e.pop(),n.push(...e)}const t=e[e.length-1].getEndPt();n[0].sqDistanceTo(t)>i.Tolerance.LENGTH_EPS2&&n.push(t)}else{const t=10,r=e[0],s=r.getRange().min,i=r.getRange().getLength()/(t-1);for(let e=0;e<t;e++)n.push(r.getPtAt(s+i*e))}const r=P.getDzByPoints(n);return r||(t||e[0].getStartTangent().getPerpendicular())}static getDzByPoints(e){const t=r.LoopArea.areaVectorOfPoint3ds(e),n=t.getLength();return n<i.Tolerance.LENGTH_EPS2?void 0:t.multiply(1/n)}static makeRectangleByXY(e,t,n,r){const s=[{x:e,y:n},{x:t,y:n},{x:t,y:r},{x:e,y:r}];return[new c.Line2d(s[0],s[1]),new c.Line2d(s[1],s[2]),new c.Line2d(s[2],s[3]),new c.Line2d(s[3],s[0])]}static simplifyCurves2d(e,t={}){const n=[],r=new _.EvolutionMap,s=(e,t)=>{n.push(e),r.set(e,[t])};for(const n of e){if(n instanceof h.OffsetCurve2d){if(t.splitOffsetCurve){const e=n.getContinuousRanges();if(e.length>1){for(const t of e)s(n.clone().setRange(t),n);continue}}}else if(n instanceof f.SmoothPoly2d){if(t.smoothPolyToNurbs){const e=n.discrete();s(d.NurbsCurve2d.makeByInterpolationPoints(e),n);continue}if(t.smoothPolyToLines){const e=n.discrete();for(let t=1;t<e.length;t++)s(new c.Line2d(e[t-1],e[t]),n);continue}}s(t.clone?n.clone():n,n)}return{curves:n,evolution:r}}static simplifyCurves3d(e,t={}){const n=[],r=new _.EvolutionMap,s=(e,t)=>{n.push(e),r.set(e,[t])};for(const n of e){if(n instanceof g.OffsetCurve3d){if(t.splitOffsetCurve){const e=n.getContinuousRanges();if(e.length>1){for(const t of e)s(n.clone().setRange(t),n);continue}}}else if(n instanceof p.SmoothPoly3d){const e=n.getCurve();if(e)s(e,n);else{if(t.smoothPolyToNurbs){const e=n.discrete();s(u.NurbsCurve3d.makeByInterpolationPoints(e),n);continue}if(t.smoothPolyToLines){const e=n.discrete();for(let t=1;t<e.length;t++)s(new l.Line3d(e[t-1],e[t]),n);continue}}}s(t.clone?n.clone():n,n)}return{curves:n,evolution:r}}static filterParamsByDistance(e,t,n,r=i.Tolerance.EDGE_LENGTH_EPS){if(e.length<1)return[];let s=m.CONST.MODEL_MAX_LENGTH;const o=[],a=[];e.sort(((e,t)=>e-t)),a.push(e[0]);for(let t=1;t<e.length;++t)E.Util.isNearlyEqual(a[a.length-1],e[t])||a.push(e[t]);for(const e of a){const i=n.getPtAt(e).distanceTo(t);i<s-r?(o.splice(0,o.length,e),s=i):i<s+r&&(o.push(e),s=(s*(o.length-1)+e)/o.length)}return o}static getArc3dPoles(e){return[0,m.CONST.PI_2,m.CONST.PI,3*m.CONST.PI/2].map((t=>e.getPtAt(t))).filter((t=>e.containsPoint(t)))}static filterCurvesBurr(e,t,n){if(e.length<3)return e;const r=[];r.push(e[0]);for(let s=1;s<e.length;++s){if(r.length<1){r.push(e[s]);continue}const i=r[r.length-1],o=e[s];if(i.isLine3d()&&o.isLine3d()&&i.isParallelTo(o,t)){if(i.getStartPt().distanceTo(o.getEndPt())<n&&E.Util.isNearlyEqual(i.getLength(),o.getLength(),n)){r.pop();continue}}else if(i.isArc()&&o.isArc()&&i.getCenter().distanceTo(o.getCenter())<n){if(i.getStartPt().distanceTo(o.getEndPt())<n&&E.Util.isNearlyEqual(i.getLength(),o.getLength(),n)){r.pop();continue}}r.push(e[s])}if(r.length>2&&r[0].getStartPt().equals(r[r.length-1].getEndPt())){const e=r[r.length-1],s=r[0];if(e.isLine3d()&&s.isLine3d()&&e.isParallelTo(s,t)){e.getStartPt().distanceTo(s.getEndPt())<n&&E.Util.isNearlyEqual(e.getLength(),s.getLength(),n)&&(r.pop(),r.shift())}else if(e.isArc()&&s.isArc()&&e.getCenter().distanceTo(s.getCenter())<n){e.getStartPt().distanceTo(s.getEndPt())<n&&E.Util.isNearlyEqual(e.getLength(),s.getLength(),n)&&(r.pop(),r.shift())}}return r}static setCurveRange(e,t,n,r){let s=e.getParamAt(t),o=e.getParamAt(n);if(!e.isPeriodic())return s>o?(e.setRange(o,s),!0):(e.setRange(s,o),!1);const a=e.getRange().period;if(t.equals(n,i.Tolerance.EDGE_LENGTH_EPS))return e.setRange(s,s+a),!1;if(void 0===r)return s>o+i.Tolerance.NUMBER_EPS?e.setRange(s,o+a):e.setRange(s,o),!1;let c=!1;const l=(s+o)/2,d=e.getPtAt(l),u=e.getPtAt(l+a/2);return s<o?d.sqDistanceTo(r)>u.sqDistanceTo(r)&&(s+=a,c=!0):d.sqDistanceTo(r)<u.sqDistanceTo(r)?c=!0:o+=a,c?(e.setRange(o,s),!0):(e.setRange(s,o),!1)}}t.CurveUtil=P},11067:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GeomUtil=void 0;const r=n(56973),s=n(61226);t.GeomUtil=class{static curvesConnected(e,t=r.Tolerance.LENGTH_EPS){for(let n=0;n<e.length-1;n++){const r=e[n],s=e[n+1];if(!r.getEndPt().equals(s.getStartPt(),t))return!1}return!0}static createPlaneFromPoints(e){if(e.length<3)return;const t=[0,0,0];for(let n=0;n<e.length;n++){const r=(n+1)%e.length,s=e[n],i=e[r];t[0]+=(s.y-i.y)*(s.z+i.z),t[1]+=(s.z-i.z)*(s.x+i.x),t[2]+=(s.x-i.x)*(s.y+i.y)}let n=new s.Vector3(t[0],t[1],t[2]);n.isZero()||(n=n.normalized());const r=e[0];if(n.equals(new s.Vector3(0,0,0))){const t=e[1].subtracted(r).normalized();for(let i=2;i<e.length;i++){const o=e[i].subtracted(r).normalized(),a=t.cross(o).normalized();if(!a.equals(new s.Vector3(0,0,0))){n=a;break}}}return n.equals(new s.Vector3(0,0,0))?void 0:n}static splitCurveByPoints(e,t,n=r.Tolerance.NUMBER_EPS){const s=[];for(const n of t)if(!n.equals(e.getStartPt())&&!n.equals(e.getEndPt())){const t=e.getParamAt(n);s.push(t)}return e.split(s,n)}}},63814:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LogCall=t.Log=void 0;const s=n(4097);function i(e,t,n){const r=e[t];if(r)r.start++,n===s.MathErrorType.None?r.success++:(r.failed++,r[n]|=0,r[n]++);else if(n===s.MathErrorType.None)e[t]={start:1,success:1,failed:0};else{const r={start:1,success:0,failed:1};r[n]=1,e[t]=r}}function o(e){if(!e)return e;const t=typeof e;if("number"===t||"string"===t||"boolean"===t)return e;if(e.dump)return e.dump();if(e instanceof Map||e instanceof Set)return;if(Array.isArray(e))return e.map((e=>o(e)));const n={};for(const t of Object.keys(e))n[t]=o(e[t]);return n}class a{constructor(){this._counts={},this._sessions=[],this._listenerMap=new Map}static getInstance(){return this._instance||(this._instance=new a),a._instance}static d(e,t="",n=""){let r=`${t}\n`;r+=a.toString(e),r+=`\n${n}`}static e(e,t="",n=""){let r=`${t}\n`;r+=a.toString(e),r+=`\n${n}`}static w(e,t="",n=""){let r=`${t}\n`;r+=a.toString(e),r+=`\n${n}`}static toString(e){let t="";return e instanceof Array?e.forEach((e=>{t+=`${e}\n`})):t+=`${e}`,t}start(e){this._sessions.push(e)}stop(e,t=s.MathErrorType.None){for(;this._sessions.length>0;)if(this._sessions.pop()===e)return void i(this._counts,e,t);i(this._counts,e,s.MathErrorType.Unknown)}getCounts(){return this._counts}getSessions(){return this._sessions}getCurrentSession(){return this._sessions[this._sessions.length-1]||""}clear(){this._counts={},this._sessions=[]}on(e,t){const n=this._listenerMap.get(e);n?n.includes(t)||n.push(t):this._listenerMap.set(e,[t])}off(e,t){const n=this._listenerMap.get(e);if(n){const r=n.findIndex((e=>e===t));r>=0&&(n.splice(r,1),n.length||this._listenerMap.delete(e))}}emit(e,t){return r(this,void 0,void 0,(function*(){const n=this._listenerMap.get(e);if(n)for(const e of n){const n=e(t);n instanceof Promise&&(yield n)}}))}shouldLogTest(e){return!!this._listenerMap.get(e)}}t.Log=a,a.showError=!0,t.LogCall=function(e={}){return function(t,n,r){const i=e.callName||(t?`${t.name}.`:"")+n,c=r.value;r.value=function(...e){const t=a.getInstance();t.start(i);let n=s.MathErrorType.None;try{if(t.shouldLogTest(c.name)){const n={api:c.name,input:o(e)},r=Date.now(),s=c.apply(this,e);return n.time=Date.now()-r,n.output=o(s),t.emit(c.name,n),s}return c.apply(this,e)}catch(e){throw n=e instanceof s.MathError?t.getCurrentSession()===i||e.type===s.MathErrorType.Unimplemented?e.type:s.MathErrorType.Algorithm:s.MathErrorType.Unknown,e}finally{t.stop(i,n)}}}}},4097:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MathError=t.MathErrorType=void 0;const r=n(63814);var s;!function(e){e.Input="input",e.Algorithm="algorithm",e.Geometry="geometry",e.Unimplemented="unimplemented",e.Unknown="unknown",e.Default="default",e.None="none"}(s=t.MathErrorType||(t.MathErrorType={}));class i extends Error{constructor(e="",t="",n=s.Default,r=[]){super(e),this._algorithm=t,this._type=n,this._params=r}static assert(e,t,n,...s){if(!(e instanceof Function?e():e)){throw new i(t,r.Log.getInstance().getCurrentSession(),n,s)}}static warn(e,t,n,...r){}static mutedWarn(e,t,n,...r){}get algorithm(){return this._algorithm}set algorithm(e){this._algorithm=e}get type(){return this._type}set type(e){this._type=e}get name(){return this.constructor.name}get params(){return this._params}set params(e){this._params=e}get fullMessage(){let e=`${this.algorithm}(${this.type}) - ${this.message} \n`;for(const t of this._params)e+=t instanceof Object?`${t.constructor.name}} \n`:`${t} \n`;return e}toString(){return this.fullMessage}}t.MathError=i,i.showMutedWarn=!1},43638:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SurfaceUtil=void 0;const r=n(56973),s=n(26773),i=n(49246),o=n(33218);t.SurfaceUtil=class{static unifyCurve2dUVBetweenCurves(e,t,n,a=r.Tolerance.DEFAULT){if(e.length<1)return;const c=a.edgeLengthEps;if(!e[0].getStartPt().equals(e[e.length-1].getEndPt(),c))return;for(let t=1;t<e.length;t++)if(!e[t].getStartPt().equals(e[t-1].getEndPt(),c))return;const l=t.getDomainU(),d=t.getDomainV();if(!(l instanceof s.PeriodInterval||d instanceof s.PeriodInterval))return;for(let e=1;e<n.length;e++){const t=n[e-1].getEndPt(),r=n[e].getStartPt(),s=t.subtracted(r),i=s.getSqLength();i<a.edgeLengthEps2||((n[e-1].isNurbsCurve2d()||n[e].isNurbsCurve2d())&&i<1e4*a.edgeLengthEps2||n[e].translate(s))}let u=0,h=0;const g=n.map((e=>e.getStartPt())),f=(e,t)=>{const n=Math.max(...t),r=Math.min(...t);return i.Util.isNearlyBiggerOrEqual(r,e)?-Math.round(r/e)*e:i.Util.isNearlySmallerOrEqual(n,0)?Math.round((e-n)/e)*e:0};if(l instanceof s.PeriodInterval){const e=g.map((e=>e.x));u=f(l.period,e)}if(d instanceof s.PeriodInterval){const e=g.map((e=>e.y));h=f(d.period,e)}if(u||h){const e=new o.Vector2(u,h);n.forEach((t=>t.translate(e)))}}}},49246:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Util=void 0;const r=n(56973);t.Util=class{static degreeToRadius(e){return e*Math.PI/180}static radiusToDegree(e){return 180*e/Math.PI}static isNearlyEqual(e,t,n=r.Tolerance.NUMBER_EPS){return Math.abs(e-t)<=n}static isNearlySmaller(e,t,n=r.Tolerance.NUMBER_EPS){return e-t<-n}static isNearlySmallerOrEqual(e,t,n=r.Tolerance.NUMBER_EPS){return e-t<=n}static isNearlyBigger(e,t,n=r.Tolerance.NUMBER_EPS){return e-t>n}static isNearlyBiggerOrEqual(e,t,n=r.Tolerance.NUMBER_EPS){return e-t>=-n}static isNearlyZero(e,t=r.Tolerance.NUMBER_EPS){return Math.abs(e)<=t}static isInRange(e,t,n,s=r.Tolerance.NUMBER_EPS){return e-t>=-s&&e-n<=s}static randomInRange(e,t){return Math.random()*(t-e)+e}static sum(e){return e.reduce(((e,t)=>e+t),0)}static clamp(e,t,n){return Math.max(t,Math.min(n,e))}static getUniqueOnes(e,t){const n=[];e:for(const r of e){for(const e of n)if(t(r,e))continue e;n.push(r)}return n}}},52463:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UvUtil=void 0;const r=n(16472),s=n(43640),i=n(6688),o=n(26773),a=n(33218),c=n(58059),l=n(60229),d=n(4097);class u{static logCurveLoops(e,t){e.forEach((e=>{e.forEach((e=>{}))}))}static logConnectedLoops(e,t){for(const t of e);}static unifyUvBetweenCurves(e,t,n,r){const s=u.getPoleVs(e),{y:i}=n,o=u._getUPeriod(e);if(o>0){u._TEST_OUTPUT&&u.logCurveLoops(t,"P0 PCurveLoops");const e=o,n=e/2;t.forEach((t=>{let o=t[0][0].x,a=0;t.forEach((t=>{let c=!1;if(2===t.length){const e=u._getPoleIndex(t[0].y,s,i),n=u._getPoleIndex(t[1].y,s,i);if(e>=0&&e===n&&(c=!0,r)){const e=r(t[0],t[1]);t.splice(1,0,...e)}}for(let r=0;r<t.length;r++){const s=t[r],i=s.x-o;c&&r>0||(i>n?a-=e:i<-n&&(a+=e)),o=s.x,s.x+=a}}))})),u._TEST_OUTPUT&&u.logCurveLoops(t,"P1 PCurveLoops")}const a=u._getVPeriod(e);if(a>0){const e=a,n=e/2;t.forEach((t=>{let r=t[0][0].y,s=0;t.forEach((t=>{for(const i of t){const t=i.y-r;t>n?s-=e:t<-n&&(s+=e),r=i.y,i.y+=s}}))}))}}static connectUvCurves(e,t){return e.map((e=>{for(let t=0;t<e.length;t++){const n=e[t],r=e[(t+1)%e.length],s=r[r.length-1],i=r[0],o=n[n.length-1];new a.Vector2(s).distanceTo(o)<new a.Vector2(i).distanceTo(o)&&r.reverse()}for(let n=0;n<e.length;n++){const r=e[n],s=e[(n+1)%e.length],i=r[r.length-1],o=s[0];u.areEqual(i,o,t)&&(u._interpolate(s[0],i,.5),r.pop())}const n=[],r=e[e.length-1];let s=r[r.length-1];for(const r of e)if(0!==r.length){for(let e=0;e<r.length;e++)if(!u.areEqual(s,r[e],t)){for(let t=e;t<r.length;t++)n.push(r[t]);break}s=r[r.length-1]}return n}))}static unifyUvBetweenLoops(e,t,n){const r=u.getPoleVs(e),{x:s,y:i}=n,c=u._getUPeriod(e);if(c>0){u._TEST_OUTPUT&&u.logConnectedLoops(t,"P2 Combined");const e=t[0],n=c;for(let c=1;c<t.length;c++){const d=t[c],h=d.find((e=>u._getPoleIndex(e.y,r,i)<0));if(!h)continue;const g=h.x,f=g-n/2,p=[];let _=e[e.length-1],m=o.PeriodInterval.RegularizeParam(_.x-f)-n/2;e.forEach((e=>{const t=o.PeriodInterval.RegularizeParam(e.x-f)-n/2;if(m>s&&Math.abs(t)<s)p.push(e);else if(m>s&&t<0&&m-t<n/2){const n=1/(1+Math.abs(t/m));p.push(u._interpolated(_,e,n))}_=e,m=t}));const v=h.y,E=p.reduce(((e,t)=>t.y>v&&t.y<e.y?t:e),new a.Vector2(0,l.CONST.MODEL_MAX_LENGTH)),P=Math.round((E.x-g)/n)*n;d.forEach((e=>{e.x+=P}))}u._TEST_OUTPUT&&u.logConnectedLoops(t,"P3 Adjusted")}const d=u._getVPeriod(e);if(d>0){const e=t[0],n=d;for(let r=1;r<t.length;r++){const s=t[r],c=s[0].y,d=c-n/2,h=[];let g=e[e.length-1],f=o.PeriodInterval.RegularizeParam(g.y-d)-n/2;e.forEach((e=>{const t=o.PeriodInterval.RegularizeParam(e.y-d)-n/2;if(f>i&&Math.abs(t)<i)h.push(e);else if(f>i&&t<0&&f-t<n/2){const n=1/(1+Math.abs(t/f));h.push(u._interpolated(g,e,n))}g=e,f=t}));const p=s[0].x,_=h.reduce(((e,t)=>t.x>p&&t.x<e.x?e:t),new a.Vector2(l.CONST.MODEL_MAX_LENGTH,0)),m=Math.round((_.y-c)/n)*n;s.forEach((e=>{e.y+=m}))}}}static areEqual(e,t,n){const r=(e.x-t.x)/n.x,s=(e.y-t.y)/n.y;return r*r+s*s<1}static getPoleVs(e){return e.isCone()?[e.getH()]:e.isSphere()?[-l.CONST.PI_2,l.CONST.PI_2]:[]}static getSurfaceUvEps(e,t){let n=t.lengthEps,r=t.lengthEps;if(e.isCone()||e.isCylinder())n=t.angleEps;else if(e.isSphere())n=t.angleEps,r=t.angleEps;else if(e.isSweepSurface()){const s=e;n=u.getCurveEps(s.getProfile(),t),r=u.getCurveEps(s.getPath(),t)}else e.isNurbsSurface()&&(n=t.numberEps,r=t.numberEps);return{x:n,y:r}}static getCurveEps(e,t){const n=e.isExtendCurve()?e.getBaseCurve():e;return n.isArc()?t.angleEps:n.isNurbsCurve()?t.numberEps:t.lengthEps}static parseUvInArcLength(e,t,n=!0){const a=n?e.map((e=>e.slice())):e;if(t.isPlane())return a;const l=new i.Interval(0,0),d=new i.Interval(0,0);for(const[t,n]of e)l.expandByPt(t),d.expandByPt(n);const u=t.getDomainU(),h=t.getDomainV(),g=u instanceof o.PeriodInterval?[u.min,u.max]:l.toArray(),f=h instanceof o.PeriodInterval?[h.min,h.max]:d.toArray(),p=t.isSweepSurface()?e=>t.getPath().getPtAt(e):e=>t.getPtAt({x:0,y:e}),_=r.DiscreteUtil.discreteGeneralCurve((e=>t.getPtAt({x:e,y:0})),(e=>t.getIsoCurve(0,!0).getTangentAt(e)),g,[],s.DiscreteParameter.NORMAL),m=r.DiscreteUtil.discreteGeneralCurve(p,(e=>t.getIsoCurve(0,!1).getTangentAt(e)),f,[],s.DiscreteParameter.NORMAL),v=_.map((e=>e.param)),E=m.map((e=>e.param)),P=[0],y=[0];for(let e=1;e<_.length;e++)P.push(P[e-1]+_[e-1].point.distanceTo(_[e].point));for(let e=1;e<m.length;e++)y.push(y[e-1]+m[e-1].point.distanceTo(m[e].point));const C=new c.PolylineFunction(P,v),S=new c.PolylineFunction(y,E),T=-C.getPtAt(0),b=-S.getPtAt(0);for(const e of a)e[0]=C.getPtAt(e[0])+T,e[1]=S.getPtAt(e[1])+b;return a}static _getPoleIndex(e,t,n){for(let r=0;r<t.length;r++)if(Math.abs(e-t[r])<n)return r;return-1}static _interpolated(e,t,n=.5){return this._interpolate({x:e.x,y:e.y},t,n)}static _interpolate(e,t,n=.5){return e.x+=(t.x-e.x)*n,e.y+=(t.y-t.y)*n,e}static _getUPeriod(e){if(e.isUPeriodic())return e.getDomainU().period;if(e.isSweepSurface()){const t=e.getProfile();if(t.isPeriodic())return t.getRange().period;if(t.isExtendCurve2d())return 0;if(t.getStartPt().equals(t.getEndPt())){if(0===t.getRange().min)return t.getRange().max;const e="扫掠面离散不支持 range.min 非 0 的封闭 profile";d.MathError.warn(!1,e,d.MathErrorType.Unimplemented)}}return 0}static _getVPeriod(e){if(e.isVPeriodic())return e.getDomainV().period;if(e.isSweepSurface()){const t=e.getPath();if(t.isPeriodic())return t.getRange().period;if(t.isExtendCurve3d())return 0;if(t.getStartPt().equals(t.getEndPt())){if(0===t.getRange().min)return t.getRange().max;const e="扫掠面离散不支持 range.min 非 0 的封闭 path";d.MathError.warn(!1,e,d.MathErrorType.Unimplemented)}}return 0}}t.UvUtil=u,u._TEST_OUTPUT=!1},68894:function(e){e.exports=function(){var e={},t=this,n=(new Function("try {return this===window;}catch(e){ return false;}"),new Function("try {return this===global;}catch(e){return false;}")),r=new Function("try {return typeof importScripts === 'function';}catch(e){return false;}");if(n()||r()){var s=t;if(r()){var i=function(e,n){var r=t;return e.split(".").forEach((function(e){r&&(r=r[e])})),r?r[n]:null};onmessage=function(e){if(e.data.className&&e.data.methodName){var t=i(e.data.className,e.data.methodName);t&&postMessage({result:t.apply(null,e.data.args),id:e.data.id})}}}}return function(e,t,n){"use strict";t.geom=t.geom||{},t.eval=t.eval||{},t.core=t.core||{},t.promhx=t.promhx||{};var r={},s=function(){return x.__string_rec(this,"")};function i(e,t){function n(){}n.prototype=e;var r=new n;for(var s in t)r[s]=t[s];return t.toString!==Object.prototype.toString&&(r.toString=t.toString),r}var o=function(){};r.HxOverrides=o,o.__name__=["HxOverrides"],o.strDate=function(e){switch(e.length){case 8:var t=e.split(":"),n=new Date;return n.setTime(0),n.setUTCHours(t[0]),n.setUTCMinutes(t[1]),n.setUTCSeconds(t[2]),n;case 10:var r=e.split("-");return new Date(r[0],r[1]-1,r[2],0,0,0);case 19:var s=e.split(" "),i=s[0].split("-"),o=s[1].split(":");return new Date(i[0],i[1]-1,i[2],o[0],o[1],o[2]);default:throw new w("Invalid date format : "+e)}},o.cca=function(e,t){var n=e.charCodeAt(t);if(n==n)return n},o.substr=function(e,t,n){return null!=t&&0!=t&&null!=n&&n<0?"":(null==n&&(n=e.length),t<0?(t=e.length+t)<0&&(t=0):n<0&&(n=e.length+n-t),e.substr(t,n))},o.iter=function(e){return{cur:0,arr:e,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var a=function(){};r.Lambda=a,a.__name__=["Lambda"],a.fold=function(e,t,n){for(var r=nt(e)();r.hasNext();)n=t(r.next(),n);return n};var c=function(){this.length=0};r.List=c,c.__name__=["List"],c.prototype={add:function(e){var t=[e];null==this.h?this.h=t:this.q[1]=t,this.q=t,this.length++},pop:function(){if(null==this.h)return null;var e=this.h[0];return this.h=this.h[1],null==this.h&&(this.q=null),this.length--,e},isEmpty:function(){return null==this.h},__class__:c},Math.__name__=["Math"];var l=function(){};r.Reflect=l,l.__name__=["Reflect"],l.field=function(e,t){try{return e[t]}catch(e){return e instanceof w&&(e=e.val),null}},l.callMethod=function(e,t,n){return t.apply(e,n)},l.fields=function(e){var t=[];if(null!=e){var n=Object.prototype.hasOwnProperty;for(var r in e)"__id__"!=r&&"hx__closures__"!=r&&n.call(e,r)&&t.push(r)}return t},l.isFunction=function(e){return"function"==typeof e&&!(e.__name__||e.__ename__)},l.deleteField=function(e,t){return!!Object.prototype.hasOwnProperty.call(e,t)&&(delete e[t],!0)};var d=function(){};r.Std=d,d.__name__=["Std"],d.string=function(e){return x.__string_rec(e,"")},d.parseFloat=function(e){return parseFloat(e)};var u=function(){this.b=""};r.StringBuf=u,u.__name__=["StringBuf"],u.prototype={add:function(e){this.b+=d.string(e)},__class__:u};var h=function(){};r.StringTools=h,h.__name__=["StringTools"],h.fastCodeAt=function(e,t){return e.charCodeAt(t)};var g=r.ValueType={__ename__:["ValueType"],__constructs__:["TNull","TInt","TFloat","TBool","TObject","TFunction","TClass","TEnum","TUnknown"]};g.TNull=["TNull",0],g.TNull.toString=s,g.TNull.__enum__=g,g.TInt=["TInt",1],g.TInt.toString=s,g.TInt.__enum__=g,g.TFloat=["TFloat",2],g.TFloat.toString=s,g.TFloat.__enum__=g,g.TBool=["TBool",3],g.TBool.toString=s,g.TBool.__enum__=g,g.TObject=["TObject",4],g.TObject.toString=s,g.TObject.__enum__=g,g.TFunction=["TFunction",5],g.TFunction.toString=s,g.TFunction.__enum__=g,g.TClass=function(e){var t=["TClass",6,e];return t.__enum__=g,t.toString=s,t},g.TEnum=function(e){var t=["TEnum",7,e];return t.__enum__=g,t.toString=s,t},g.TUnknown=["TUnknown",8],g.TUnknown.toString=s,g.TUnknown.__enum__=g;var f=function(){};r.Type=f,f.__name__=["Type"],f.getClassName=function(e){var t=e.__name__;return null==t?null:t.join(".")},f.getEnumName=function(e){return e.__ename__.join(".")},f.resolveClass=function(e){var t=r[e];return null!=t&&t.__name__?t:null},f.resolveEnum=function(e){var t=r[e];return null!=t&&t.__ename__?t:null},f.createEmptyInstance=function(e){function t(){}return t.prototype=e.prototype,new t},f.createEnum=function(e,t,n){var r=l.field(e,t);if(null==r)throw new w("No such constructor "+t);if(l.isFunction(r)){if(null==n)throw new w("Constructor "+t+" need parameters");return l.callMethod(e,r,n)}if(null!=n&&0!=n.length)throw new w("Constructor "+t+" does not need parameters");return r},f.getEnumConstructs=function(e){return e.__constructs__.slice()},f.typeof=function(e){switch(typeof e){case"boolean":return g.TBool;case"string":return g.TClass(String);case"number":return Math.ceil(e)==e%2147483648?g.TInt:g.TFloat;case"object":if(null==e)return g.TNull;var t=e.__enum__;if(null!=t)return g.TEnum(t);var n=x.getClass(e);return null!=n?g.TClass(n):g.TObject;case"function":return e.__name__||e.__ename__?g.TObject:g.TFunction;case"undefined":return g.TNull;default:return g.TUnknown}};var p=function(){};r["haxe.IMap"]=p,p.__name__=["haxe","IMap"];var _=function(e,t){this.high=e,this.low=t};r["haxe._Int64.___Int64"]=_,_.__name__=["haxe","_Int64","___Int64"],_.prototype={__class__:_};var m=function(){this.buf=new u,this.cache=[],this.useCache=m.USE_CACHE,this.useEnumIndex=m.USE_ENUM_INDEX,this.shash=new C,this.scount=0};r["haxe.Serializer"]=m,m.__name__=["haxe","Serializer"],m.prototype={toString:function(){return this.buf.b},serializeString:function(e){var t=this.shash.get(e);if(null!=t)return this.buf.b+="R",void(this.buf.b+=null==t?"null":""+t);this.shash.set(e,this.scount++),this.buf.b+="y",null==(e=encodeURIComponent(e)).length?this.buf.b+="null":this.buf.b+=""+e.length,this.buf.b+=":",this.buf.b+=null==e?"null":""+e},serializeRef:function(e){for(var t=typeof e,n=0,r=this.cache.length;n<r;){var s=n++,i=this.cache[s];if(typeof i==t&&i==e)return this.buf.b+="r",this.buf.b+=null==s?"null":""+s,!0}return this.cache.push(e),!1},serializeFields:function(e){for(var t=0,n=l.fields(e);t<n.length;){var r=n[t];++t,this.serializeString(r),this.serialize(l.field(e,r))}this.buf.b+="g"},serialize:function(e){var t=f.typeof(e);switch(t[1]){case 0:this.buf.b+="n";break;case 1:var n=e;if(0==n)return void(this.buf.b+="z");this.buf.b+="i",this.buf.b+=null==n?"null":""+n;break;case 2:var r=e;isNaN(r)?this.buf.b+="k":isFinite(r)?(this.buf.b+="d",this.buf.b+=null==r?"null":""+r):this.buf.b+=r<0?"m":"p";break;case 3:this.buf.b+=e?"t":"f";break;case 6:var s=t[2];if(s==String)return void this.serializeString(e);if(this.useCache&&this.serializeRef(e))return;switch(s){case Array:var i=0;this.buf.b+="a";for(var o=e.length,a=0;a<o;){var h=a++;null==e[h]?i++:(i>0&&(1==i?this.buf.b+="n":(this.buf.b+="u",this.buf.b+=null==i?"null":""+i),i=0),this.serialize(e[h]))}i>0&&(1==i?this.buf.b+="n":(this.buf.b+="u",this.buf.b+=null==i?"null":""+i)),this.buf.b+="h";break;case c:this.buf.b+="l";for(var g=e.h,p=null;null!=g;){var _;p=g[0],g=g[1],_=p,this.serialize(_)}this.buf.b+="h";break;case Date:var v=e;this.buf.b+="v",this.buf.add(v.getTime());break;case C:this.buf.b+="b";for(var y=e,T=y.keys();T.hasNext();){var b=T.next();this.serializeString(b),this.serialize(null!=ht[b]?y.getReserved(b):y.h[b])}this.buf.b+="h";break;case E:this.buf.b+="q";for(var M=e,N=M.keys();N.hasNext();){var A=N.next();this.buf.b+=":",this.buf.b+=null==A?"null":""+A,this.serialize(M.h[A])}this.buf.b+="h";break;case P:this.buf.b+="M";for(var O=e,I=O.keys();I.hasNext();){var D=I.next(),L=l.field(D,"__id__");l.deleteField(D,"__id__"),this.serialize(D),D.__id__=L,this.serialize(O.h[D.__id__])}this.buf.b+="h";break;case S:for(var V=e,R=0,U=V.length-2,B=new u,F=m.BASE64;R<U;){var k=V.get(R++),G=V.get(R++),j=V.get(R++);B.add(F.charAt(k>>2)),B.add(F.charAt(63&(k<<4|G>>4))),B.add(F.charAt(63&(G<<2|j>>6))),B.add(F.charAt(63&j))}if(R==U){var z=V.get(R++),W=V.get(R++);B.add(F.charAt(z>>2)),B.add(F.charAt(63&(z<<4|W>>4))),B.add(F.charAt(W<<2&63))}else if(R==U+1){var q=V.get(R++);B.add(F.charAt(q>>2)),B.add(F.charAt(q<<4&63))}var H=B.b;this.buf.b+="s",null==H.length?this.buf.b+="null":this.buf.b+=""+H.length,this.buf.b+=":",this.buf.b+=null==H?"null":""+H;break;default:this.useCache&&this.cache.pop(),null!=e.hxSerialize?(this.buf.b+="C",this.serializeString(f.getClassName(s)),this.useCache&&this.cache.push(e),e.hxSerialize(this),this.buf.b+="g"):(this.buf.b+="c",this.serializeString(f.getClassName(s)),this.useCache&&this.cache.push(e),this.serializeFields(e))}break;case 4:if(x.__instanceof(e,dt)){var Y=f.getClassName(e);this.buf.b+="A",this.serializeString(Y)}else if(x.__instanceof(e,ut))this.buf.b+="B",this.serializeString(f.getEnumName(e));else{if(this.useCache&&this.serializeRef(e))return;this.buf.b+="o",this.serializeFields(e)}break;case 7:var X=t[2];if(this.useCache){if(this.serializeRef(e))return;this.cache.pop()}this.useEnumIndex?this.buf.b+="j":this.buf.b+="w",this.serializeString(f.getEnumName(X)),this.useEnumIndex?(this.buf.b+=":",this.buf.b+=d.string(e[1])):this.serializeString(e[0]),this.buf.b+=":";var J=e.length;this.buf.b+=d.string(J-2);for(var K=2;K<J;){var Z=K++;this.serialize(e[Z])}this.useCache&&this.cache.push(e);break;case 5:throw new w("Cannot serialize function");default:throw new w("Cannot serialize "+d.string(e))}},__class__:m};var v=function(e){this.buf=e,this.length=e.length,this.pos=0,this.scache=[],this.cache=[];var t=v.DEFAULT_RESOLVER;null==t&&(t=f,v.DEFAULT_RESOLVER=t),this.setResolver(t)};r["haxe.Unserializer"]=v,v.__name__=["haxe","Unserializer"],v.initCodes=function(){for(var e=[],t=0,n=v.BASE64.length;t<n;){var r=t++;e[v.BASE64.charCodeAt(r)]=r}return e},v.prototype={setResolver:function(e){this.resolver=null==e?{resolveClass:function(e){return null},resolveEnum:function(e){return null}}:e},get:function(e){return this.buf.charCodeAt(e)},readDigits:function(){for(var e=0,t=!1,n=this.pos;;){var r=this.buf.charCodeAt(this.pos);if(r!=r)break;if(45!=r){if(r<48||r>57)break;e=10*e+(r-48),this.pos++}else{if(this.pos!=n)break;t=!0,this.pos++}}return t&&(e*=-1),e},readFloat:function(){for(var e=this.pos;;){var t=this.buf.charCodeAt(this.pos);if(!(t>=43&&t<58||101==t||69==t))break;this.pos++}return d.parseFloat(o.substr(this.buf,e,this.pos-e))},unserializeObject:function(e){for(;;){if(this.pos>=this.length)throw new w("Invalid object");if(103==this.buf.charCodeAt(this.pos))break;var t=this.unserialize();if("string"!=typeof t)throw new w("Invalid object key");var n=this.unserialize();e[t]=n}this.pos++},unserializeEnum:function(e,t){if(58!=this.get(this.pos++))throw new w("Invalid enum format");var n=this.readDigits();if(0==n)return f.createEnum(e,t);for(var r=[];n-- >0;)r.push(this.unserialize());return f.createEnum(e,t,r)},unserialize:function(){switch(this.get(this.pos++)){case 110:return null;case 116:return!0;case 102:return!1;case 122:return 0;case 105:return this.readDigits();case 100:return this.readFloat();case 121:var e=this.readDigits();if(58!=this.get(this.pos++)||this.length-this.pos<e)throw new w("Invalid string length");var t=o.substr(this.buf,this.pos,e);return this.pos+=e,t=decodeURIComponent(t.split("+").join(" ")),this.scache.push(t),t;case 107:return NaN;case 109:return-1/0;case 112:return 1/0;case 97:this.buf;var n=[];for(this.cache.push(n);;){var r=this.buf.charCodeAt(this.pos);if(104==r){this.pos++;break}if(117==r){this.pos++;var s=this.readDigits();n[n.length+s-1]=null}else n.push(this.unserialize())}return n;case 111:var i={};return this.cache.push(i),this.unserializeObject(i),i;case 114:var a=this.readDigits();if(a<0||a>=this.cache.length)throw new w("Invalid reference");return this.cache[a];case 82:var l=this.readDigits();if(l<0||l>=this.scache.length)throw new w("Invalid string reference");return this.scache[l];case 120:throw new w(this.unserialize());case 99:var d=this.unserialize(),u=this.resolver.resolveClass(d);if(null==u)throw new w("Class not found "+d);var g=f.createEmptyInstance(u);return this.cache.push(g),this.unserializeObject(g),g;case 119:var p=this.unserialize(),_=this.resolver.resolveEnum(p);if(null==_)throw new w("Enum not found "+p);var m=this.unserializeEnum(_,this.unserialize());return this.cache.push(m),m;case 106:var y=this.unserialize(),T=this.resolver.resolveEnum(y);if(null==T)throw new w("Enum not found "+y);this.pos++;var b=this.readDigits(),x=f.getEnumConstructs(T)[b];if(null==x)throw new w("Unknown enum index "+y+"@"+b);var M=this.unserializeEnum(T,x);return this.cache.push(M),M;case 108:var N=new c;for(this.cache.push(N),this.buf;104!=this.buf.charCodeAt(this.pos);)N.add(this.unserialize());return this.pos++,N;case 98:var A=new C;for(this.cache.push(A),this.buf;104!=this.buf.charCodeAt(this.pos);){var O=this.unserialize();A.set(O,this.unserialize())}return this.pos++,A;case 113:var I=new E;this.cache.push(I),this.buf;for(var D=this.get(this.pos++);58==D;){var L=this.readDigits();I.set(L,this.unserialize()),D=this.get(this.pos++)}if(104!=D)throw new w("Invalid IntMap format");return I;case 77:var V=new P;for(this.cache.push(V),this.buf;104!=this.buf.charCodeAt(this.pos);){var R=this.unserialize();V.set(R,this.unserialize())}return this.pos++,V;case 118:var U;if(this.buf.charCodeAt(this.pos)>=48&&this.buf.charCodeAt(this.pos)<=57&&this.buf.charCodeAt(this.pos+1)>=48&&this.buf.charCodeAt(this.pos+1)<=57&&this.buf.charCodeAt(this.pos+2)>=48&&this.buf.charCodeAt(this.pos+2)<=57&&this.buf.charCodeAt(this.pos+3)>=48&&this.buf.charCodeAt(this.pos+3)<=57&&45==this.buf.charCodeAt(this.pos+4)){var B=o.substr(this.buf,this.pos,19);U=o.strDate(B),this.pos+=19}else{var F=this.readFloat(),k=new Date;k.setTime(F),U=k}return this.cache.push(U),U;case 115:var G=this.readDigits(),j=this.buf;if(58!=this.get(this.pos++)||this.length-this.pos<G)throw new w("Invalid bytes length");var z=v.CODES;null==z&&(z=v.initCodes(),v.CODES=z);var W,q=this.pos,H=3&G;W=3*(G>>2)+(H>=2?H-1:0);for(var Y=q+(G-H),X=S.alloc(W),J=0;q<Y;){var K=z[h.fastCodeAt(j,q++)],Z=z[h.fastCodeAt(j,q++)];X.set(J++,K<<2|Z>>4);var $=z[h.fastCodeAt(j,q++)];X.set(J++,Z<<4|$>>2);var Q=z[h.fastCodeAt(j,q++)];X.set(J++,$<<6|Q)}if(H>=2){var ee=z[h.fastCodeAt(j,q++)],te=z[h.fastCodeAt(j,q++)];if(X.set(J++,ee<<2|te>>4),3==H){var ne=z[h.fastCodeAt(j,q++)];X.set(J++,te<<4|ne>>2)}}return this.pos+=G,this.cache.push(X),X;case 67:var re=this.unserialize(),se=this.resolver.resolveClass(re);if(null==se)throw new w("Class not found "+re);var ie=f.createEmptyInstance(se);if(this.cache.push(ie),ie.hxUnserialize(this),103!=this.get(this.pos++))throw new w("Invalid custom data");return ie;case 65:var oe=this.unserialize(),ae=this.resolver.resolveClass(oe);if(null==ae)throw new w("Class not found "+oe);return ae;case 66:var ce=this.unserialize(),le=this.resolver.resolveEnum(ce);if(null==le)throw new w("Enum not found "+ce);return le}throw this.pos--,new w("Invalid char "+this.buf.charAt(this.pos)+" at position "+this.pos)},__class__:v};var E=function(){this.h={}};r["haxe.ds.IntMap"]=E,E.__name__=["haxe","ds","IntMap"],E.__interfaces__=[p],E.prototype={set:function(e,t){this.h[e]=t},remove:function(e){return!!this.h.hasOwnProperty(e)&&(delete this.h[e],!0)},keys:function(){var e=[];for(var t in this.h)this.h.hasOwnProperty(t)&&e.push(0|t);return o.iter(e)},__class__:E};var P=function(){this.h={},this.h.__keys__={}};r["haxe.ds.ObjectMap"]=P,P.__name__=["haxe","ds","ObjectMap"],P.__interfaces__=[p],P.prototype={set:function(e,t){var n=e.__id__||(e.__id__=++P.count);this.h[n]=t,this.h.__keys__[n]=e},keys:function(){var e=[];for(var t in this.h.__keys__)this.h.hasOwnProperty(t)&&e.push(this.h.__keys__[t]);return o.iter(e)},__class__:P};var y=r["haxe.ds.Option"]={__ename__:["haxe","ds","Option"],__constructs__:["Some","None"]};y.Some=function(e){var t=["Some",0,e];return t.__enum__=y,t.toString=s,t},y.None=["None",1],y.None.toString=s,y.None.__enum__=y;var C=function(){this.h={}};r["haxe.ds.StringMap"]=C,C.__name__=["haxe","ds","StringMap"],C.__interfaces__=[p],C.prototype={set:function(e,t){null!=ht[e]?this.setReserved(e,t):this.h[e]=t},get:function(e){return null!=ht[e]?this.getReserved(e):this.h[e]},setReserved:function(e,t){null==this.rh&&(this.rh={}),this.rh["$"+e]=t},getReserved:function(e){return null==this.rh?null:this.rh["$"+e]},keys:function(){var e=this.arrayKeys();return o.iter(e)},arrayKeys:function(){var e=[];for(var t in this.h)this.h.hasOwnProperty(t)&&e.push(t);if(null!=this.rh)for(var t in this.rh)36==t.charCodeAt(0)&&e.push(t.substr(1));return e},__class__:C};var S=function(e){this.length=e.byteLength,this.b=new ft(e),this.b.bufferValue=e,e.hxBytes=this,e.bytes=this.b};r["haxe.io.Bytes"]=S,S.__name__=["haxe","io","Bytes"],S.alloc=function(e){return new S(new gt(e))},S.prototype={get:function(e){return this.b[e]},set:function(e,t){this.b[e]=255&t},__class__:S};var T=r["haxe.io.Error"]={__ename__:["haxe","io","Error"],__constructs__:["Blocked","Overflow","OutsideBounds","Custom"]};T.Blocked=["Blocked",0],T.Blocked.toString=s,T.Blocked.__enum__=T,T.Overflow=["Overflow",1],T.Overflow.toString=s,T.Overflow.__enum__=T,T.OutsideBounds=["OutsideBounds",2],T.OutsideBounds.toString=s,T.OutsideBounds.__enum__=T,T.Custom=function(e){var t=["Custom",3,e];return t.__enum__=T,t.toString=s,t};var b=function(){};r["haxe.io.FPHelper"]=b,b.__name__=["haxe","io","FPHelper"],b.i32ToFloat=function(e){var t=e>>>23&255,n=8388607&e;return 0==n&&0==t?0:(1-(e>>>31<<1))*(1+Math.pow(2,-23)*n)*Math.pow(2,t-127)},b.floatToI32=function(e){if(0==e)return 0;var t;t=e<0?-e:e;var n=Math.floor(Math.log(t)/.6931471805599453);return n<-127?n=-127:n>128&&(n=128),(e<0?-2147483648:0)|n+127<<23|8388607&Math.round(8388608*(t/Math.pow(2,n)-1))},b.i64ToDouble=function(e,t){var n=(t>>20&2047)-1023,r=4294967296*(1048575&t)+2147483648*(e>>>31)+(2147483647&e);return 0==r&&-1023==n?0:(1-(t>>>31<<1))*(1+Math.pow(2,-52)*r)*Math.pow(2,n)},b.doubleToI64=function(e){var t=b.i64tmp;if(0==e)t.low=0,t.high=0;else{var n;n=e<0?-e:e;var r,s=Math.floor(Math.log(n)/.6931471805599453),i=4503599627370496*(n/Math.pow(2,s)-1),o=0|(r=Math.round(i)),a=r/4294967296|0;t.low=o,t.high=(e<0?-2147483648:0)|s+1023<<20|a}return t};var w=function(e){Error.call(this),this.val=e,this.message=String(e),Error.captureStackTrace&&Error.captureStackTrace(this,w)};r["js._Boot.HaxeError"]=w,w.__name__=["js","_Boot","HaxeError"],w.__super__=Error,w.prototype=i(Error.prototype,{__class__:w});var x=function(){};r["js.Boot"]=x,x.__name__=["js","Boot"],x.getClass=function(e){if(e instanceof Array&&null==e.__enum__)return Array;var t=e.__class__;if(null!=t)return t;var n=x.__nativeClassName(e);return null!=n?x.__resolveNativeClass(n):null},x.__string_rec=function(e,t){if(null==e)return"null";if(t.length>=5)return"<...>";var n=typeof e;switch("function"==n&&(e.__name__||e.__ename__)&&(n="object"),n){case"object":if(e instanceof Array){if(e.__enum__){if(2==e.length)return e[0];var r=e[0]+"(";t+="\t";for(var s=2,i=e.length;s<i;){var o=s++;r+=2!=o?","+x.__string_rec(e[o],t):x.__string_rec(e[o],t)}return r+")"}var a=e.length,c="[";t+="\t";for(var l=0;l<a;){var d=l++;c+=(d>0?",":"")+x.__string_rec(e[d],t)}return c+="]"}var u;try{u=e.toString}catch(e){return e instanceof w&&(e=e.val),"???"}if(null!=u&&u!=Object.toString&&"function"==typeof u){var h=e.toString();if("[object Object]"!=h)return h}var g=null,f="{\n";t+="\t";var p=null!=e.hasOwnProperty;for(var g in e)p&&!e.hasOwnProperty(g)||"prototype"!=g&&"__class__"!=g&&"__super__"!=g&&"__interfaces__"!=g&&"__properties__"!=g&&(2!=f.length&&(f+=", \n"),f+=t+g+" : "+x.__string_rec(e[g],t));return f+="\n"+(t=t.substring(1))+"}";case"function":return"<function>";case"string":return e;default:return String(e)}},x.__interfLoop=function(e,t){if(null==e)return!1;if(e==t)return!0;var n=e.__interfaces__;if(null!=n)for(var r=0,s=n.length;r<s;){var i=n[r++];if(i==t||x.__interfLoop(i,t))return!0}return x.__interfLoop(e.__super__,t)},x.__instanceof=function(e,t){if(null==t)return!1;switch(t){case ot:return(0|e)===e;case ct:return"number"==typeof e;case lt:return"boolean"==typeof e;case String:return"string"==typeof e;case Array:return e instanceof Array&&null==e.__enum__;case at:return!0;default:if(null==e)return!1;if("function"==typeof t){if(e instanceof t)return!0;if(x.__interfLoop(x.getClass(e),t))return!0}else if("object"==typeof t&&x.__isNativeObj(t)&&e instanceof t)return!0;return t==dt&&null!=e.__name__||t==ut&&null!=e.__ename__||e.__enum__==t}},x.__nativeClassName=function(e){var t=x.__toStr.call(e).slice(8,-1);return"Object"==t||"Function"==t||"Math"==t||"JSON"==t?null:t},x.__isNativeObj=function(e){return null!=x.__nativeClassName(e)},x.__resolveNativeClass=function(e){return n[e]};var M=function(e){if(e instanceof Array&&null==e.__enum__)this.a=e,this.byteLength=e.length;else{var t=e;this.a=[];for(var n=0;n<t;){var r=n++;this.a[r]=0}this.byteLength=t}};r["js.html.compat.ArrayBuffer"]=M,M.__name__=["js","html","compat","ArrayBuffer"],M.sliceImpl=function(e,t){var n=new ft(this,e,null==t?null:t-e),r=new gt(n.byteLength);return new ft(r).set(n),r},M.prototype={slice:function(e,t){return new M(this.a.slice(e,t))},__class__:M};var N=function(e,t,n){if(this.buf=e,this.offset=null==t?0:t,this.length=null==n?e.byteLength-this.offset:n,this.offset<0||this.length<0||this.offset+this.length>e.byteLength)throw new w(T.OutsideBounds)};r["js.html.compat.DataView"]=N,N.__name__=["js","html","compat","DataView"],N.prototype={getInt8:function(e){var t=this.buf.a[this.offset+e];return t>=128?t-256:t},getUint8:function(e){return this.buf.a[this.offset+e]},getInt16:function(e,t){var n=this.getUint16(e,t);return n>=32768?n-65536:n},getUint16:function(e,t){return t?this.buf.a[this.offset+e]|this.buf.a[this.offset+e+1]<<8:this.buf.a[this.offset+e]<<8|this.buf.a[this.offset+e+1]},getInt32:function(e,t){var n=this.offset+e,r=this.buf.a[n++],s=this.buf.a[n++],i=this.buf.a[n++],o=this.buf.a[n++];return t?r|s<<8|i<<16|o<<24:o|i<<8|s<<16|r<<24},getUint32:function(e,t){var n=this.getInt32(e,t);return n<0?n+4294967296:n},getFloat32:function(e,t){return b.i32ToFloat(this.getInt32(e,t))},getFloat64:function(e,t){var n=this.getInt32(e,t),r=this.getInt32(e+4,t);return b.i64ToDouble(t?n:r,t?r:n)},setInt8:function(e,t){this.buf.a[e+this.offset]=t<0?t+128&255:255&t},setUint8:function(e,t){this.buf.a[e+this.offset]=255&t},setInt16:function(e,t,n){this.setUint16(e,t<0?t+65536:t,n)},setUint16:function(e,t,n){var r=e+this.offset;n?(this.buf.a[r]=255&t,this.buf.a[r++]=t>>8&255):(this.buf.a[r++]=t>>8&255,this.buf.a[r]=255&t)},setInt32:function(e,t,n){this.setUint32(e,t,n)},setUint32:function(e,t,n){var r=e+this.offset;n?(this.buf.a[r++]=255&t,this.buf.a[r++]=t>>8&255,this.buf.a[r++]=t>>16&255,this.buf.a[r++]=t>>>24):(this.buf.a[r++]=t>>>24,this.buf.a[r++]=t>>16&255,this.buf.a[r++]=t>>8&255,this.buf.a[r++]=255&t)},setFloat32:function(e,t,n){this.setUint32(e,b.floatToI32(t),n)},setFloat64:function(e,t,n){var r=b.doubleToI64(t);n?(this.setUint32(e,r.low),this.setUint32(e,r.high)):(this.setUint32(e,r.high),this.setUint32(e,r.low))},__class__:N};var A=function(){};r["js.html.compat.Uint8Array"]=A,A.__name__=["js","html","compat","Uint8Array"],A._new=function(e,t,n){var r;if("number"==typeof e){r=[];for(var s=0;s<e;)r[s++]=0;r.byteLength=r.length,r.byteOffset=0,r.buffer=new M(r)}else if(x.__instanceof(e,M)){var i=e;null==t&&(t=0),null==n&&(n=i.byteLength-t),(r=0==t?i.a:i.a.slice(t,t+n)).byteLength=r.length,r.byteOffset=t,r.buffer=i}else{if(!(e instanceof Array&&null==e.__enum__))throw new w("TODO "+d.string(e));(r=e.slice()).byteLength=r.length,r.byteOffset=0,r.buffer=new M(r)}return r.subarray=A._subarray,r.set=A._set,r},A._set=function(e,t){var n=this;if(x.__instanceof(e.buffer,M)){var r=e;if(e.byteLength+t>n.byteLength)throw new w("set() outside of range");for(var s=0,i=e.byteLength;s<i;){var o=s++;n[o+t]=r[o]}}else{if(!(e instanceof Array&&null==e.__enum__))throw new w("TODO");var a=e;if(a.length+t>n.byteLength)throw new w("set() outside of range");for(var c=0,l=a.length;c<l;){var d=c++;n[d+t]=a[d]}}},A._subarray=function(e,t){var n=this,r=A._new(n.slice(e,t));return r.byteOffset=e,r};var O=function(e){this._resolved=!1,this._pending=!1,this._errorPending=!1,this._fulfilled=!1,this._update=[],this._error=[],this._errored=!1,null!=e&&O.link(e,this,(function(e){return e}))};r["promhx.base.AsyncBase"]=O,O.__name__=["promhx","base","AsyncBase"],O.link=function(e,t,n){e._update.push({async:t,linkf:function(e){t.handleResolve(n(e))}}),O.immediateLinkUpdate(e,t,n)},O.immediateLinkUpdate=function(e,t,n){if(!e._errored||e._errorPending||e._error.length>0||t.handleError(e._errorVal),e._resolved&&!e._pending)try{t.handleResolve(n(e._val))}catch(e){e instanceof w&&(e=e.val),t.handleError(e)}},O.linkAll=function(e,t){for(var n=function(n,r,s){if(0==n.length||O.allFulfilled(n)){for(var i,o=[],a=nt(e)();a.hasNext();){var c=a.next();o.push(c==r?s:c._val)}i=o,t.handleResolve(i)}},r=nt(e)();r.hasNext();){var s=r.next();s._update.push({async:t,linkf:function(e,t,n){return function(r){e(t,n,r)}}(n,function(t){for(var n=[],r=nt(e)();r.hasNext();){var i=r.next();i!=s&&n.push(i)}return n}(),s)})}O.allFulfilled(e)&&t.handleResolve(function(t){for(var n=[],r=nt(e)();r.hasNext();){var s=r.next();n.push(s._val)}return n}())},O.pipeLink=function(e,t,n){var r=!1,s=function(e){if(!r){r=!0;var s=n(e);s._update.push({async:t,linkf:it(t,t.handleResolve)}),O.immediateLinkUpdate(s,t,(function(e){return e}))}};if(e._update.push({async:t,linkf:s}),e._resolved&&!e._pending)try{s(e._val)}catch(e){e instanceof w&&(e=e.val),t.handleError(e)}},O.allResolved=function(e){for(var t=nt(e)();t.hasNext();)if(!t.next()._resolved)return!1;return!0},O.allFulfilled=function(e){for(var t=nt(e)();t.hasNext();)if(!t.next()._fulfilled)return!1;return!0},O.prototype={catchError:function(e){return this._error.push(e),this},errorThen:function(e){return this._errorMap=e,this},isResolved:function(){return this._resolved},isErrored:function(){return this._errored},isErrorHandled:function(){return this._error.length>0},isErrorPending:function(){return this._errorPending},isFulfilled:function(){return this._fulfilled},isPending:function(){return this._pending},handleResolve:function(e){this._resolve(e)},_resolve:function(e){var t=this;this._pending?R.enqueue(function(e,t){return function(){e(t)}}(it(this,this._resolve),e)):(this._resolved=!0,this._pending=!0,R.queue.add((function(){t._val=e;for(var n=0,r=t._update;n<r.length;){var s=r[n];++n;try{s.linkf(e)}catch(e){e instanceof w&&(e=e.val),s.async.handleError(e)}}t._fulfilled=!0,t._pending=!1})),R.continueOnNextLoop())},handleError:function(e){this._handleError(e)},_handleError:function(e){var t=this,n=function(e){if(t._error.length>0)for(var n=0,r=t._error;n<r.length;){var s=r[n];++n,s(e)}else{if(!(t._update.length>0))throw new w(e);for(var i=0,o=t._update;i<o.length;){var a=o[i];++i,a.async.handleError(e)}}t._errorPending=!1};this._errorPending||(this._errorPending=!0,this._errored=!0,this._errorVal=e,R.queue.add((function(){if(null!=t._errorMap)try{t._resolve(t._errorMap(e))}catch(e){e instanceof w&&(e=e.val),n(e)}else n(e)})),R.continueOnNextLoop())},then:function(e){var t=new O(null);return O.link(this,t,e),t},unlink:function(e){var t=this;R.queue.add((function(){t._update=t._update.filter((function(t){return t.async!=e}))})),R.continueOnNextLoop()},isLinked:function(e){for(var t=!1,n=0,r=this._update;n<r.length;){var s=r[n];if(++n,s.async==e)return!0}return t},__class__:O};var I=t.promhx.Deferred=function(){O.call(this)};r["promhx.Deferred"]=I,I.__name__=["promhx","Deferred"],I.__super__=O,I.prototype=i(O.prototype,{resolve:function(e){this.handleResolve(e)},throwError:function(e){this.handleError(e)},promise:function(){return new D(this)},stream:function(){return new L(this)},publicStream:function(){return new V(this)},__class__:I});var D=t.promhx.Promise=function(e){O.call(this,e),this._rejected=!1};r["promhx.Promise"]=D,D.__name__=["promhx","Promise"],D.whenAll=function(e){var t=new D(null);return O.linkAll(e,t),t},D.promise=function(e){var t=new D;return t.handleResolve(e),t},D.__super__=O,D.prototype=i(O.prototype,{isRejected:function(){return this._rejected},reject:function(e){this._rejected=!0,this.handleError(e)},handleResolve:function(e){if(this._resolved){var t="Promise has already been resolved";throw new w(U.AlreadyResolved(t))}this._resolve(e)},then:function(e){var t=new D(null);return O.link(this,t,e),t},unlink:function(e){var t=this;R.queue.add((function(){if(t._fulfilled)t._update=t._update.filter((function(t){return t.async!=e}));else{var n="Downstream Promise is not fullfilled";t.handleError(U.DownstreamNotFullfilled(n))}})),R.continueOnNextLoop()},handleError:function(e){this._rejected=!0,this._handleError(e)},pipe:function(e){var t=new D(null);return O.pipeLink(this,t,e),t},errorPipe:function(e){var t=new D;return this.catchError((function(n){e(n).then(it(t,t._resolve))})),this.then(it(t,t._resolve)),t},__class__:D});var L=t.promhx.Stream=function(e){O.call(this,e),this._end_promise=new D};r["promhx.Stream"]=L,L.__name__=["promhx","Stream"],L.foreach=function(e){for(var t=new L(null),n=nt(e)();n.hasNext();){var r=n.next();t.handleResolve(r)}return t.end(),t},L.wheneverAll=function(e){var t=new L(null);return O.linkAll(e,t),t},L.concatAll=function(e){for(var t=new L(null),n=nt(e)();n.hasNext();){var r=n.next();t.concat(r)}return t},L.mergeAll=function(e){for(var t=new L(null),n=nt(e)();n.hasNext();){var r=n.next();t.merge(r)}return t},L.stream=function(e){var t=new L(null);return t.handleResolve(e),t},L.__super__=O,L.prototype=i(O.prototype,{then:function(e){var t=new L(null);return O.link(this,t,e),this._end_promise._update.push({async:t._end_promise,linkf:function(e){t.end()}}),t},detachStream:function(e){for(var t=[],n=!1,r=0,s=this._update;r<s.length;){var i=s[r];++r,i.async==e?(this._end_promise._update=this._end_promise._update.filter((function(t){return t.async!=e._end_promise})),n=!0):t.push(i)}return this._update=t,n},first:function(){var e=new D(null);return this.then((function(t){e._resolved||e.handleResolve(t)})),e},handleResolve:function(e){this._end||this._pause||this._resolve(e)},pause:function(e){null==e&&(e=!this._pause),this._pause=e},pipe:function(e){var t=new L(null);return O.pipeLink(this,t,e),this._end_promise.then((function(e){t.end()})),t},errorPipe:function(e){var t=new L(null);return this.catchError((function(n){var r=e(n);r.then(it(t,t._resolve)),r._end_promise.then(it(rt=t._end_promise,rt._resolve))})),this.then(it(t,t._resolve)),this._end_promise.then((function(e){t.end()})),t},handleEnd:function(){if(this._pending)R.queue.add(it(this,this.handleEnd)),R.continueOnNextLoop();else{if(this._end_promise._resolved)return;var e;this._end=!0,e=this._resolved?y.Some(this._val):y.None,this._end_promise.handleResolve(e),this._update=[],this._error=[]}},end:function(){return R.queue.add(it(this,this.handleEnd)),R.continueOnNextLoop(),this},endThen:function(e){return this._end_promise.then(e)},filter:function(e){var t=new L(null);return this._update.push({async:t,linkf:function(n){e(n)&&t.handleResolve(n)}}),O.immediateLinkUpdate(this,t,(function(e){return e})),t},concat:function(e){var t=new L(null);return this._update.push({async:t,linkf:it(t,t.handleResolve)}),O.immediateLinkUpdate(this,t,(function(e){return e})),this._end_promise.then((function(n){e.pipe((function(e){return t.handleResolve(e),t})),e._end_promise.then((function(e){t.end()}))})),t},merge:function(e){var t=new L(null);return this._update.push({async:t,linkf:it(t,t.handleResolve)}),e._update.push({async:t,linkf:it(t,t.handleResolve)}),O.immediateLinkUpdate(this,t,(function(e){return e})),O.immediateLinkUpdate(e,t,(function(e){return e})),t},__class__:L});var V=t.promhx.PublicStream=function(e){L.call(this,e)};r["promhx.PublicStream"]=V,V.__name__=["promhx","PublicStream"],V.publicstream=function(e){var t=new V(null);return t.handleResolve(e),t},V.__super__=L,V.prototype=i(L.prototype,{resolve:function(e){this.handleResolve(e)},throwError:function(e){this.handleError(e)},update:function(e){this.handleResolve(e)},__class__:V});var R=function(){};r["promhx.base.EventLoop"]=R,R.__name__=["promhx","base","EventLoop"],R.enqueue=function(e){R.queue.add(e),R.continueOnNextLoop()},R.set_nextLoop=function(e){if(null!=R.nextLoop)throw new w("nextLoop has already been set");return R.nextLoop=e,R.nextLoop},R.queueEmpty=function(){return R.queue.isEmpty()},R.finish=function(e){null==e&&(e=1e3);for(var t=null;e-- >0&&null!=(t=R.queue.pop());)t();return R.queue.isEmpty()},R.clear=function(){R.queue=new c},R.f=function(){var e=R.queue.pop();null!=e&&e(),R.queue.isEmpty()||R.continueOnNextLoop()},R.continueOnNextLoop=function(){null!=R.nextLoop?R.nextLoop(R.f):setImmediate(R.f)};var U=r["promhx.error.PromiseError"]={__ename__:["promhx","error","PromiseError"],__constructs__:["AlreadyResolved","DownstreamNotFullfilled"]};U.AlreadyResolved=function(e){var t=["AlreadyResolved",0,e];return t.__enum__=U,t.toString=s,t},U.DownstreamNotFullfilled=function(e){var t=["DownstreamNotFullfilled",1,e];return t.__enum__=U,t.toString=s,t};var B=function(){};r["verb.Verb"]=B,B.__name__=["verb","Verb"],B.main=function(){};var F=function(){};r["verb.core.ArrayExtensions"]=F,F.__name__=["verb","core","ArrayExtensions"],F.alloc=function(e,t){if(!(t<0))for(;e.length<t;)e.push(null)},F.reversed=function(e){var t=e.slice();return t.reverse(),t},F.last=function(e){return e[e.length-1]},F.first=function(e){return e[0]},F.spliceAndInsert=function(e,t,n,r){e.splice(t,n),e.splice(t,0,r)},F.left=function(e){if(0==e.length)return[];var t=Math.ceil(e.length/2);return e.slice(0,t)},F.right=function(e){if(0==e.length)return[];var t=Math.ceil(e.length/2);return e.slice(t)},F.rightWithPivot=function(e){if(0==e.length)return[];var t=Math.ceil(e.length/2);return e.slice(t-1)},F.unique=function(e,t){if(0==e.length)return[];for(var n=[e.pop()];e.length>0;){for(var r=e.pop(),s=!0,i=0;i<n.length;){var o=n[i];if(++i,t(r,o)){s=!1;break}}s&&n.push(r)}return n};var k=function(){};r["verb.core.Binomial"]=k,k.__name__=["verb","core","Binomial"],k.get=function(e,t){if(0==t)return 1;if(0==e||t>e)return 0;if(t>e-t&&(t=e-t),k.memo_exists(e,t))return k.get_memo(e,t);for(var n=1,r=e,s=1,i=t+1;s<i;){var o=s++;k.memo_exists(r,o)?(e--,n=k.get_memo(r,o)):(n*=e--,n/=o,k.memoize(r,o,n))}return n},k.get_no_memo=function(e,t){if(0==t)return 1;if(0==e||t>e)return 0;t>e-t&&(t=e-t);for(var n=1,r=1,s=t+1;r<s;)n*=e--,n/=r++;return n},k.memo_exists=function(e,t){return k.memo.h.hasOwnProperty(e)&&k.memo.h[e].h.hasOwnProperty(t)},k.get_memo=function(e,t){return k.memo.h[e].h[t]},k.memoize=function(e,t,n){k.memo.h.hasOwnProperty(e)||k.memo.set(e,new E),k.memo.h[e].h[t]=n};var G=t.core.BoundingBox=function(e){this.max=null,this.min=null,this.dim=3,this.initialized=!1,null!=e&&this.addRange(e)};r["verb.core.BoundingBox"]=G,G.__name__=["verb","core","BoundingBox"],G.intervalsOverlap=function(e,t,n,r,s){var i;null==s&&(s=-1),i=s<-.5?j.TOLERANCE:s;var o=Math.min(e,t)-i,a=Math.max(e,t)+i,c=Math.min(n,r)-i,l=Math.max(n,r)+i;return o>=c&&o<=l||a>=c&&a<=l||c>=o&&c<=a||l>=o&&l<=a},G.prototype={fromPoint:function(e){return new G([e])},add:function(e){if(!this.initialized)return this.dim=e.length,this.min=e.slice(0),this.max=e.slice(0),this.initialized=!0,this;for(var t=0,n=this.dim;t<n;){var r=t++;e[r]>this.max[r]&&(this.max[r]=e[r]),e[r]<this.min[r]&&(this.min[r]=e[r])}return this},addRange:function(e){for(var t=e.length,n=0;n<t;){var r=n++;this.add(e[r])}return this},contains:function(e,t){return null==t&&(t=-1),!!this.initialized&&this.intersects(new G([e]),t)},intersects:function(e,t){if(null==t&&(t=-1),!this.initialized||!e.initialized)return!1;for(var n=this.min,r=this.max,s=e.min,i=e.max,o=0,a=this.dim;o<a;){var c=o++;if(!G.intervalsOverlap(n[c],r[c],s[c],i[c],t))return!1}return!0},clear:function(){return this.initialized=!1,this},getLongestAxis:function(){for(var e=0,t=0,n=0,r=this.dim;n<r;){var s=n++,i=this.getAxisLength(s);i>e&&(e=i,t=s)}return t},getAxisLength:function(e){return e<0||e>this.dim-1?0:Math.abs(this.min[e]-this.max[e])},intersect:function(e,t){if(!this.initialized)return null;var n=this.min,r=this.max,s=e.min,i=e.max;if(!this.intersects(e,t))return null;for(var o=[],a=[],c=0,l=this.dim;c<l;){var d=c++;o.push(Math.min(r[d],i[d])),a.push(Math.max(n[d],s[d]))}return new G([a,o])},__class__:G};var j=t.core.Constants=function(){};r["verb.core.Constants"]=j,j.__name__=["verb","core","Constants"];var z=t.core.SerializableBase=function(){};r["verb.core.SerializableBase"]=z,z.__name__=["verb","core","SerializableBase"],z.prototype={serialize:function(){var e=new m;return e.serialize(this),e.toString()},__class__:z};var W=t.core.Plane=function(e,t){this.origin=e,this.normal=t};r["verb.core.Plane"]=W,W.__name__=["verb","core","Plane"],W.__super__=z,W.prototype=i(z.prototype,{__class__:W});var q=t.core.Ray=function(e,t){this.origin=e,this.dir=t};r["verb.core.Ray"]=q,q.__name__=["verb","core","Ray"],q.__super__=z,q.prototype=i(z.prototype,{__class__:q});var H=t.core.NurbsCurveData=function(e,t,n){this.degree=e,this.controlPoints=n,this.knots=t};r["verb.core.NurbsCurveData"]=H,H.__name__=["verb","core","NurbsCurveData"],H.__super__=z,H.prototype=i(z.prototype,{__class__:H});var Y=t.core.NurbsSurfaceData=function(e,t,n,r,s){this.degreeU=e,this.degreeV=t,this.knotsU=n,this.knotsV=r,this.controlPoints=s};r["verb.core.NurbsSurfaceData"]=Y,Y.__name__=["verb","core","NurbsSurfaceData"],Y.__super__=z,Y.prototype=i(z.prototype,{__class__:Y});var X=t.core.MeshData=function(e,t,n,r){this.faces=e,this.points=t,this.normals=n,this.uvs=r};r["verb.core.MeshData"]=X,X.__name__=["verb","core","MeshData"],X.empty=function(){return new X([],[],[],[])},X.__super__=z,X.prototype=i(z.prototype,{__class__:X});var J=t.core.PolylineData=function(e,t){this.points=e,this.params=t};r["verb.core.PolylineData"]=J,J.__name__=["verb","core","PolylineData"],J.__super__=z,J.prototype=i(z.prototype,{__class__:J});var K=t.core.VolumeData=function(e,t,n,r,s,i,o){this.degreeU=e,this.degreeV=t,this.degreeW=n,this.knotsU=r,this.knotsV=s,this.knotsW=i,this.controlPoints=o};r["verb.core.VolumeData"]=K,K.__name__=["verb","core","VolumeData"],K.__super__=z,K.prototype=i(z.prototype,{__class__:K});var Z=t.core.Pair=function(e,t){this.item0=e,this.item1=t};r["verb.core.Pair"]=Z,Z.__name__=["verb","core","Pair"],Z.prototype={__class__:Z};var $=t.core.Interval=function(e,t){this.min=e,this.max=t};r["verb.core.Interval"]=$,$.__name__=["verb","core","Interval"],$.prototype={__class__:$};var Q=t.core.CurveCurveIntersection=function(e,t,n,r){this.point0=e,this.point1=t,this.u0=n,this.u1=r};r["verb.core.CurveCurveIntersection"]=Q,Q.__name__=["verb","core","CurveCurveIntersection"],Q.prototype={__class__:Q};var ee=t.core.CurveSurfaceIntersection=function(e,t,n,r){this.u=e,this.uv=t,this.curvePoint=n,this.surfacePoint=r};r["verb.core.CurveSurfaceIntersection"]=ee,ee.__name__=["verb","core","CurveSurfaceIntersection"],ee.prototype={__class__:ee};var te=t.core.MeshIntersectionPoint=function(e,t,n,r,s){this.visited=!1,this.adj=null,this.opp=null,this.uv0=e,this.uv1=t,this.point=n,this.faceIndex0,this.faceIndex1};r["verb.core.MeshIntersectionPoint"]=te,te.__name__=["verb","core","MeshIntersectionPoint"],te.prototype={__class__:te};var ne=t.core.PolylineMeshIntersection=function(e,t,n,r,s){this.point=e,this.u=t,this.uv=n,this.polylineIndex=r,this.faceIndex=s};r["verb.core.PolylineMeshIntersection"]=ne,ne.__name__=["verb","core","PolylineMeshIntersection"],ne.prototype={__class__:ne};var re=t.core.SurfaceSurfaceIntersectionPoint=function(e,t,n,r){this.uv0=e,this.uv1=t,this.point=n,this.dist=r};r["verb.core.SurfaceSurfaceIntersectionPoint"]=re,re.__name__=["verb","core","SurfaceSurfaceIntersectionPoint"],re.prototype={__class__:re};var se=t.core.TriSegmentIntersection=function(e,t,n,r){this.point=e,this.s=t,this.t=n,this.p=r};r["verb.core.TriSegmentIntersection"]=se,se.__name__=["verb","core","TriSegmentIntersection"],se.prototype={__class__:se};var ie=t.core.CurveTriPoint=function(e,t,n){this.u=e,this.point=t,this.uv=n};r["verb.core.CurveTriPoint"]=ie,ie.__name__=["verb","core","CurveTriPoint"],ie.prototype={__class__:ie};var oe=function(e,t,n,r,s){null==s&&(s=!1),null==r&&(r=-1),this.uv=n,this.point=e,this.normal=t,this.id=r,this.degen=s};r["verb.core.SurfacePoint"]=oe,oe.__name__=["verb","core","SurfacePoint"],oe.fromUv=function(e,t){return new oe(null,null,[e,t])},oe.prototype={__class__:oe};var ae=t.core.CurvePoint=function(e,t){this.u=e,this.pt=t};r["verb.core.CurvePoint"]=ae,ae.__name__=["verb","core","CurvePoint"],ae.prototype={__class__:ae};var ce=t.core.KdTree=function(e,t){this.dim=3,this.points=e,this.distanceFunction=t,this.dim=e[0].point.length,this.root=this.buildTree(e,0,null)};r["verb.core.KdTree"]=ce,ce.__name__=["verb","core","KdTree"],ce.prototype={buildTree:function(e,t,n){var r,s,i=t%this.dim;return 0==e.length?null:1==e.length?new ue(e[0],i,n):(e.sort((function(e,t){var n=e.point[i]-t.point[i];return 0==n?0:n>0?1:-1})),r=Math.floor(e.length/2),(s=new ue(e[r],i,n)).left=this.buildTree(e.slice(0,r),t+1,s),s.right=this.buildTree(e.slice(r+1),t+1,s),s)},nearest:function(e,t,n){var r,s=this,i=new le((function(e){return-e.item1})),o=null;r=o=function(n){for(var r,a,c,l,d=n.dimension,u=s.distanceFunction(e,n.kdPoint.point),h=[],g=0,f=s.dim;g<f;)g++,h.push(0);a=h;for(var p=function(e,n){i.push(new Z(e,n)),i.size()>t&&i.pop()},_=0,m=s.dim;_<m;){var v=_++;v==n.dimension?a[v]=e[v]:a[v]=n.kdPoint.point[v]}c=s.distanceFunction(a,n.kdPoint.point),null!=n.right||null!=n.left?(r=null==n.right?n.left:null==n.left?n.right:e[d]<n.kdPoint.point[d]?n.left:n.right,o(r),(i.size()<t||u<i.peek().item1)&&p(n,u),(i.size()<t||Math.abs(c)<i.peek().item1)&&null!=(l=r==n.left?n.right:n.left)&&o(l)):(i.size()<t||u<i.peek().item1)&&p(n,u)};for(var a=0;a<t;)a++,i.push(new Z(null,n));r(this.root);for(var c=[],l=0;l<t;){var d=l++;null!=i.content[d].item0&&c.push(new Z(i.content[d].item0.kdPoint,i.content[d].item1))}return c},__class__:ce};var le=function(e){this.content=[],this.scoreFunction=e};r["verb.core.BinaryHeap"]=le,le.__name__=["verb","core","BinaryHeap"],le.prototype={push:function(e){this.content.push(e),this.bubbleUp(this.content.length-1)},pop:function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.sinkDown(0)),e},peek:function(){return this.content[0]},remove:function(e){for(var t=this.content.length,n=0;n<t;){var r=n++;if(this.content[r]==e){var s=this.content.pop();return void(r!=t-1&&(this.content[r]=s,this.scoreFunction(s)<this.scoreFunction(e)?this.bubbleUp(r):this.sinkDown(r)))}}throw new w("Node not found.")},size:function(){return this.content.length},bubbleUp:function(e){for(var t=this.content[e];e>0;){var n=Math.floor((e+1)/2)-1,r=this.content[n];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[n]=t,this.content[e]=r,e=n}},sinkDown:function(e){for(var t=this.content.length,n=this.content[e],r=this.scoreFunction(n);;){var s=2*(e+1),i=s-1,o=-1,a=0;if(i<t){var c=this.content[i];(a=this.scoreFunction(c))<r&&(o=i)}if(s<t){var l=this.content[s];this.scoreFunction(l)<(-1==o?r:a)&&(o=s)}if(-1==o)break;this.content[e]=this.content[o],this.content[o]=n,e=o}},__class__:le};var de=t.core.KdPoint=function(e,t){this.point=e,this.obj=t};r["verb.core.KdPoint"]=de,de.__name__=["verb","core","KdPoint"],de.prototype={__class__:de};var ue=t.core.KdNode=function(e,t,n){this.kdPoint=e,this.left=null,this.right=null,this.parent=n,this.dimension=t};r["verb.core.KdNode"]=ue,ue.__name__=["verb","core","KdNode"],ue.prototype={__class__:ue};var he=function(){};r["verb.eval.IBoundingBoxTree"]=he,he.__name__=["verb","eval","IBoundingBoxTree"],he.prototype={__class__:he};var ge=function(e,t){this._boundingBox=null,this._curve=e,null==t&&(t=we.domain(this._curve.knots)/64),this._knotTol=t};r["verb.core.LazyCurveBoundingBoxTree"]=ge,ge.__name__=["verb","core","LazyCurveBoundingBoxTree"],ge.__interfaces__=[he],ge.prototype={split:function(){var e=F.first(this._curve.knots),t=F.last(this._curve.knots),n=t-e,r=Ae.curveSplit(this._curve,(t+e)/2+.1*n*Math.random());return new Z(new ge(r[0],this._knotTol),new ge(r[1],this._knotTol))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=new G(Ie.dehomogenize1d(this._curve.controlPoints))),this._boundingBox},yield:function(){return this._curve},indivisible:function(e){return we.domain(this._curve.knots)<this._knotTol},empty:function(){return!1},__class__:ge};var fe=function(e,t){if(this._boundingBox=null,this._mesh=e,null==t){for(var n=[],r=0,s=e.faces.length;r<s;){var i=r++;n.push(i)}t=n}this._faceIndices=t};r["verb.core.LazyMeshBoundingBoxTree"]=fe,fe.__name__=["verb","core","LazyMeshBoundingBoxTree"],fe.__interfaces__=[he],fe.prototype={split:function(){var e=Ee.sortTrianglesOnLongestAxis(this.boundingBox(),this._mesh,this._faceIndices),t=F.left(e),n=F.right(e);return new Z(new fe(this._mesh,t),new fe(this._mesh,n))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=Ee.makeMeshAabb(this._mesh,this._faceIndices)),this._boundingBox},yield:function(){return this._faceIndices[0]},indivisible:function(e){return 1==this._faceIndices.length},empty:function(){return 0==this._faceIndices.length},__class__:fe};var pe=function(e,t){this._boundingBox=null,this._polyline=e,null==t&&(t=new $(0,0!=e.points.length?e.points.length-1:0)),this._interval=t};r["verb.core.LazyPolylineBoundingBoxTree"]=pe,pe.__name__=["verb","core","LazyPolylineBoundingBoxTree"],pe.__interfaces__=[he],pe.prototype={split:function(){var e=this._interval.min,t=this._interval.max,n=e+Math.ceil((t-e)/2),r=new $(e,n),s=new $(n,t);return new Z(new pe(this._polyline,r),new pe(this._polyline,s))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=new G(this._polyline.points)),this._boundingBox},yield:function(){return this._interval.min},indivisible:function(e){return this._interval.max-this._interval.min==1},empty:function(){return this._interval.max-this._interval.min==0},__class__:pe};var _e=function(e,t,n,r){null==t&&(t=!1),this._boundingBox=null,this._surface=e,this._splitV=t,null==n&&(n=we.domain(e.knotsU)/16),null==r&&(r=we.domain(e.knotsV)/16),this._knotTolU=n,this._knotTolV=r};r["verb.core.LazySurfaceBoundingBoxTree"]=_e,_e.__name__=["verb","core","LazySurfaceBoundingBoxTree"],_e.__interfaces__=[he],_e.prototype={split:function(){var e,t;this._splitV?(e=F.first(this._surface.knotsV),t=F.last(this._surface.knotsV)):(e=F.first(this._surface.knotsU),t=F.last(this._surface.knotsU));var n=(e+t)/2,r=Ae.surfaceSplit(this._surface,n,this._splitV);return new Z(new _e(r[0],!this._splitV,this._knotTolU,this._knotTolV),new _e(r[1],!this._splitV,this._knotTolU,this._knotTolV))},boundingBox:function(){if(null==this._boundingBox){this._boundingBox=new G;for(var e=0,t=this._surface.controlPoints;e<t.length;){var n=t[e];++e,this._boundingBox.addRange(Ie.dehomogenize1d(n))}}return this._boundingBox},yield:function(){return this._surface},indivisible:function(e){return we.domain(this._surface.knotsV)<this._knotTolV&&we.domain(this._surface.knotsU)<this._knotTolU},empty:function(){return!1},__class__:_e};var me=t.core.Mat=function(){};r["verb.core.Mat"]=me,me.__name__=["verb","core","Mat"],me.mul=function(e,t){for(var n=[],r=0,s=t.length;r<s;){var i=r++;n.push(we.mul(e,t[i]))}return n},me.mult=function(e,t){var n,r,s,i,o,a,c,l;n=e.length,r=t.length,s=t[0].length,i=[];for(var d=n-1,u=0,h=0;d>=0;){for(o=[],a=e[d],h=s-1;h>=0;){for(c=a[r-1]*t[r-1][h],u=r-2;u>=1;)l=u-1,c+=a[u]*t[u][h]+a[l]*t[l][h],u-=2;0==u&&(c+=a[0]*t[0][h]),o[h]=c,h--}i[d]=o,d--}return i},me.add=function(e,t){for(var n=[],r=0,s=e.length;r<s;){var i=r++;n.push(we.add(e[i],t[i]))}return n},me.div=function(e,t){for(var n=[],r=0,s=e.length;r<s;){var i=r++;n.push(we.div(e[i],t))}return n},me.sub=function(e,t){for(var n=[],r=0,s=e.length;r<s;){var i=r++;n.push(we.sub(e[i],t[i]))}return n},me.dot=function(e,t){for(var n=[],r=0,s=e.length;r<s;){var i=r++;n.push(we.dot(e[i],t))}return n},me.identity=function(e){for(var t=we.zeros2d(e,e),n=0;n<e;){var r=n++;t[r][r]=1}return t},me.transpose=function(e){if(0==e.length)return[];for(var t=[],n=0,r=e[0].length;n<r;){var s=n++;t.push(function(t){for(var n=[],r=0,i=e.length;r<i;){var o=r++;n.push(e[o][s])}return n}())}return t},me.solve=function(e,t){return me.LUsolve(me.LU(e),t)},me.LUsolve=function(e,t){var n,r,s,i,o,a=e.LU,c=a.length,l=t.slice(),d=e.P;for(n=c-1;-1!=n;)l[n]=t[n],--n;for(n=0;n<c;){for(s=d[n],d[n]!=n&&(o=l[n],l[n]=l[s],l[s]=o),i=a[n],r=0;r<n;)l[n]-=l[r]*i[r],++r;++n}for(n=c-1;n>=0;){for(i=a[n],r=n+1;r<c;)l[n]-=l[r]*i[r],++r;l[n]/=i[n],--n}return l},me.LU=function(e){Math.abs;for(var t,n,r,s,i,o,a,c,l,d=[],u=0,h=e.length;u<h;){var g=u++;d.push(e[g].slice())}var f=(e=d).length,p=f-1,_=[];for(r=0;r<f;){for(a=r,o=e[r],l=Math.abs(o[r]),n=r+1;n<f;)l<(s=Math.abs(e[n][r]))&&(l=s,a=n),++n;for(_[r]=a,a!=r&&(e[r]=e[a],e[a]=o,o=e[r]),i=o[r],t=r+1;t<f;)e[t][r]/=i,++t;for(t=r+1;t<f;){for(c=e[t],n=r+1;n<p;)c[n]-=c[r]*o[n],c[++n]-=c[r]*o[n],++n;n==p&&(c[n]-=c[r]*o[n]),++t}++r}return new ve(e,_)};var ve=function(e,t){this.LU=e,this.P=t};r["verb.core._Mat.LUDecomp"]=ve,ve.__name__=["verb","core","_Mat","LUDecomp"],ve.prototype={__class__:ve};var Ee=t.core.Mesh=function(){};r["verb.core.Mesh"]=Ee,Ee.__name__=["verb","core","Mesh"],Ee.getTriangleNorm=function(e,t){var n=e[t[0]],r=e[t[1]],s=e[t[2]],i=we.sub(r,n),o=we.sub(s,n),a=we.cross(i,o);return we.mul(1/we.norm(a),a)},Ee.makeMeshAabb=function(e,t){for(var n=new G,r=0;r<t.length;){var s=t[r];++r,n.add(e.points[e.faces[s][0]]),n.add(e.points[e.faces[s][1]]),n.add(e.points[e.faces[s][2]])}return n},Ee.sortTrianglesOnLongestAxis=function(e,t,n){for(var r=e.getLongestAxis(),s=[],i=0;i<n.length;){var o=n[i];++i;var a=Ee.getMinCoordOnAxis(t.points,t.faces[o],r);s.push(new Z(a,o))}s.sort((function(e,t){var n=e.item0,r=t.item0;return n==r?0:n>r?1:-1}));for(var c=[],l=0,d=s.length;l<d;){var u=l++;c.push(s[u].item1)}return c},Ee.getMinCoordOnAxis=function(e,t,n){for(var r=1/0,s=0;s<3;){var i=e[t[s++]][n];i<r&&(r=i)}return r},Ee.getTriangleCentroid=function(e,t){for(var n=[0,0,0],r=0;r<3;)for(var s=r++,i=0;i<3;){var o=i++;n[o]+=e[t[s]][o]}for(var a=0;a<3;)n[a++]/=3;return n},Ee.triangleUVFromPoint=function(e,t,n){var r=e.faces[t],s=e.points[r[0]],i=e.points[r[1]],o=e.points[r[2]],a=e.uvs[r[0]],c=e.uvs[r[1]],l=e.uvs[r[2]],d=we.sub(s,n),u=we.sub(i,n),h=we.sub(o,n),g=we.norm(we.cross(we.sub(s,i),we.sub(s,o))),f=we.norm(we.cross(u,h))/g,p=we.norm(we.cross(h,d))/g,_=we.norm(we.cross(d,u))/g;return we.add(we.mul(f,a),we.add(we.mul(p,c),we.mul(_,l)))};var Pe=function(e,t){if(this._empty=!1,this._face=-1,null==t){for(var n=[],r=0,s=e.faces.length;r<s;){var i=r++;n.push(i)}t=n}if(this._boundingBox=Ee.makeMeshAabb(e,t),t.length<1)this._empty=!0;else if(t.length<2)this._face=t[0];else{var o=Ee.sortTrianglesOnLongestAxis(this._boundingBox,e,t),a=F.left(o),c=F.right(o);this._children=new Z(new Pe(e,a),new Pe(e,c))}};r["verb.core.MeshBoundingBoxTree"]=Pe,Pe.__name__=["verb","core","MeshBoundingBoxTree"],Pe.__interfaces__=[he],Pe.prototype={split:function(){return this._children},boundingBox:function(){return this._boundingBox},yield:function(){return this._face},indivisible:function(e){return null==this._children},empty:function(){return this._empty},__class__:Pe};var ye=t.core.Minimizer=function(){};r["verb.core.Minimizer"]=ye,ye.__name__=["verb","core","Minimizer"],ye.uncmin=function(e,t,n,r,s){null==n&&(n=1e-8),null==r&&(r=function(t){return ye.numericalGradient(e,t)}),null==s&&(s=1e3);var i,o,a,c,l=(t=t.slice(0)).length,d=e(t),u=d;if(isNaN(d))throw new w("uncmin: f(x0) is a NaN!");n=Math.max(n,j.EPSILON);var h,g,f,p,_,m,v=me.identity(l),E=0,P=[],y="";for(a=r(t);E<s;){if(!we.all(we.finite(a))){y="Gradient has Infinity or NaN";break}if(o=we.neg(me.dot(v,a)),!we.all(we.finite(o))){y="Search direction has Infinity or NaN";break}if((m=we.norm(o))<n){y="Newton step smaller than tol";break}for(_=1,i=we.dot(a,o),h=t;E<s&&!(_*m<n)&&(P=we.mul(_,o),h=we.add(t,P),(u=e(h))-d>=.1*_*i||isNaN(u));)_*=.5,++E;if(_*m<n){y="Line search step size smaller than tol";break}if(E==s){y="maxit reached during line search";break}c=r(h),g=we.sub(c,a),p=we.dot(g,P),f=me.dot(v,g),v=me.sub(me.add(v,me.mul((p+we.dot(g,f))/(p*p),ye.tensor(P,P))),me.div(me.add(ye.tensor(f,P),ye.tensor(P,f)),p)),t=h,d=u,a=c,++E}return new Ce(t,d,a,v,E,y)},ye.numericalGradient=function(e,t){var n=t.length,r=e(t);if(NaN==r)throw new w("gradient: f(x) is a NaN!");for(var s,i,o,a,c,l,d,u,h=t.slice(0),g=[],f=.001,p=0,_=0;_<n;)for(var m=_++,v=Math.max(1e-6*r,1e-8);;){if(++p>20)throw new w("Numerical gradient fails");if(h[m]=t[m]+v,s=e(h),h[m]=t[m]-v,i=e(h),h[m]=t[m],isNaN(s)||isNaN(i))v/=16;else{if(g[m]=(s-i)/(2*v),o=t[m]-v,a=t[m],c=t[m]+v,l=(s-r)/v,d=(r-i)/v,u=we.max([Math.abs(g[m]),Math.abs(r),Math.abs(s),Math.abs(i),Math.abs(o),Math.abs(a),Math.abs(c),1e-8]),!(Math.min(we.max([Math.abs(l-g[m]),Math.abs(d-g[m]),Math.abs(l-d)])/u,v/u)>f))break;v/=16}}return g},ye.tensor=function(e,t){for(var n,r,s=e.length,i=t.length,o=[],a=s-1;a>=0;){n=[],r=e[a];for(var c=i-1;c>=3;)n[c]=r*t[c],n[--c]=r*t[c],n[--c]=r*t[c],n[--c]=r*t[c],--c;for(;c>=0;)n[c]=r*t[c],--c;o[a]=n,a--}return o};var Ce=function(e,t,n,r,s,i){this.solution=e,this.value=t,this.gradient=n,this.invHessian=r,this.iterations=s,this.message=i};r["verb.core.MinimizationResult"]=Ce,Ce.__name__=["verb","core","MinimizationResult"],Ce.prototype={__class__:Ce};var Se=function(){};r["verb.core.ISerializable"]=Se,Se.__name__=["verb","core","ISerializable"],Se.prototype={__class__:Se};var Te=t.core.Deserializer=function(){};r["verb.core.Deserializer"]=Te,Te.__name__=["verb","core","Deserializer"],Te.deserialize=function(e){return new v(e).unserialize()};var be=t.core.Trig=function(){};r["verb.core.Trig"]=be,be.__name__=["verb","core","Trig"],be.isPointInPlane=function(e,t,n){return Math.abs(we.dot(we.sub(e,t.origin),t.normal))<n},be.distToSegment=function(e,t,n){var r=be.segmentClosestPoint(t,e,n,0,1);return we.dist(t,r.pt)},be.rayClosestPoint=function(e,t,n){var r=we.sub(e,t),s=we.dot(r,n);return we.add(t,we.mul(s,n))},be.distToRay=function(e,t,n){var r=be.rayClosestPoint(e,t,n),s=we.sub(r,e);return we.norm(s)},be.threePointsAreFlat=function(e,t,n,r){var s=we.sub(t,e),i=we.sub(n,e),o=we.cross(s,i);return we.dot(o,o)<r},be.segmentClosestPoint=function(e,t,n,r,s){var i=we.sub(n,t),o=we.norm(i);if(o<j.EPSILON)return{u:r,pt:t};var a=t,c=we.mul(1/o,i),l=we.sub(e,a),d=we.dot(l,c);return d<0?{u:r,pt:t}:d>o?{u:s,pt:n}:{u:r+(s-r)*d/o,pt:we.add(a,we.mul(d,c))}};var we=t.core.Vec=function(){};r["verb.core.Vec"]=we,we.__name__=["verb","core","Vec"],we.angleBetween=function(e,t){return Math.acos(we.dot(e,t)/(we.norm(e)*we.norm(t)))},we.positiveAngleBetween=function(e,t,n){var r=we.cross(e,t),s=we.norm(e)*we.norm(t),i=we.dot(e,t),o=we.norm(r)/s,a=i/s,c=Math.atan2(o,a),l=we.dot(n,r);return Math.abs(l)<j.EPSILON||l>0?c:-c},we.signedAngleBetween=function(e,t,n){var r=we.cross(e,t),s=we.norm(e)*we.norm(t),i=we.dot(e,t),o=we.norm(r)/s,a=i/s,c=Math.atan2(o,a);return we.dot(n,r)>0?c:2*Math.PI-c},we.angleBetweenNormalized2d=function(e,t){var n=e[0]*t[1]-e[1]*t[0];return Math.atan2(n,we.dot(e,t))},we.domain=function(e){return F.last(e)-F.first(e)},we.range=function(e){for(var t=[],n=0,r=0;r<e;)r++,t.push(n),n+=1;return t},we.span=function(e,t,n){if(null==n)return[];if(n<j.EPSILON)return[];if(e>t&&n>0)return[];if(t>e&&n<0)return[];for(var r=[],s=e;s<=t;)r.push(s),s+=n;return r},we.neg=function(e){return e.map((function(e){return-e}))},we.min=function(e){return a.fold(e,(function(e,t){return Math.min(e,t)}),1/0)},we.max=function(e){return a.fold(e,(function(e,t){return Math.max(e,t)}),-1/0)},we.all=function(e){return a.fold(e,(function(e,t){return t&&e}),!0)},we.finite=function(e){return e.map((function(e){return isFinite(e)}))},we.onRay=function(e,t,n){return we.add(e,we.mul(n,t))},we.lerp=function(e,t,n){return we.add(we.mul(e,t),we.mul(1-e,n))},we.normalized=function(e){return we.div(e,we.norm(e))},we.cross=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},we.dist=function(e,t){return we.norm(we.sub(e,t))},we.distSquared=function(e,t){return we.normSquared(we.sub(e,t))},we.sum=function(e){return a.fold(e,(function(e,t){return t+e}),0)},we.addAll=function(e){var t=nt(e)();if(!t.hasNext())return null;var n=t.next().length;return a.fold(e,(function(e,t){return we.add(t,e)}),we.rep(n,0))},we.norm=function(e){var t=we.normSquared(e);return 0!=t?Math.sqrt(t):t},we.normSquared=function(e){return a.fold(e,(function(e,t){return t+e*e}),0)},we.rep=function(e,t){for(var n=[],r=0;r<e;)r++,n.push(t);return n},we.zeros1d=function(e){for(var t=[],n=0;n<e;)n++,t.push(0);return t},we.zeros2d=function(e,t){for(var n=[],r=0;r<e;)r++,n.push(we.zeros1d(t));return n},we.zeros3d=function(e,t,n){for(var r=[],s=0;s<e;)s++,r.push(we.zeros2d(t,n));return r},we.dot=function(e,t){for(var n=0,r=0,s=e.length;r<s;){var i=r++;n+=e[i]*t[i]}return n},we.add=function(e,t){for(var n=[],r=0,s=e.length;r<s;){var i=r++;n.push(e[i]+t[i])}return n},we.mul=function(e,t){for(var n=[],r=0,s=t.length;r<s;){var i=r++;n.push(e*t[i])}return n},we.div=function(e,t){for(var n=[],r=0,s=e.length;r<s;){var i=r++;n.push(e[i]/t)}return n},we.sub=function(e,t){for(var n=[],r=0,s=e.length;r<s;){var i=r++;n.push(e[i]-t[i])}return n},we.isZero=function(e){for(var t=0,n=e.length;t<n;){var r=t++;if(Math.abs(e[r])>j.TOLERANCE)return!1}return!0},we.sortedSetUnion=function(e,t){for(var n=[],r=0,s=0;r<e.length||s<t.length;)if(r>=e.length)n.push(t[s]),s++;else if(s>=t.length)n.push(e[r]),r++;else{var i=e[r]-t[s];Math.abs(i)<j.EPSILON?(n.push(e[r]),r++,s++):i>0?(n.push(t[s]),s++):(n.push(e[r]),r++)}return n},we.sortedSetSub=function(e,t){for(var n=[],r=0,s=0;r<e.length;)s>=t.length?(n.push(e[r]),r++):Math.abs(e[r]-t[s])<j.EPSILON?(r++,s++):(n.push(e[r]),r++);return n};var xe=t.eval.Analyze=function(){};r["verb.eval.Analyze"]=xe,xe.__name__=["verb","eval","Analyze"],xe.knotMultiplicities=function(e){for(var t=[new Me(e[0],0)],n=t[0],r=0;r<e.length;){var s=e[r];++r,Math.abs(s-n.knot)>j.EPSILON&&(n=new Me(s,0),t.push(n)),n.inc()}return t},xe.isRationalSurfaceClosed=function(e,t){var n;null==t&&(t=!0);for(var r=0,s=(n=t?e.controlPoints:me.transpose(e.controlPoints))[0].length;r<s;){var i=r++;if(!(we.dist(F.first(n)[i],F.last(n)[i])<j.EPSILON))return!1}return!0},xe.rationalSurfaceClosestPoint=function(e,t){var n=xe.rationalSurfaceClosestParam(e,t);return Ie.rationalSurfacePoint(e,n[0],n[1])},xe.rationalSurfaceClosestParam=function(e,t){for(var n,r,s,i=5,o=0,a=1e-4,c=5e-4,l=e.knotsU[0],d=F.last(e.knotsU),u=e.knotsV[0],h=F.last(e.knotsV),g=xe.isRationalSurfaceClosed(e),f=xe.isRationalSurfaceClosed(e,!1),p=Re.rationalSurfaceAdaptive(e,new Ue),_=1/0,m=0,v=p.points.length;m<v;){var E=m++,P=p.points[E],y=we.normSquared(we.sub(t,P));y<_&&(_=y,s=p.uvs[E])}for(var C=function(t){return Ie.rationalSurfaceDerivatives(e,t[0],t[1],2)},S=function(e,t,n){var r=t[1][0],s=t[0][1],i=t[2][0],o=t[0][2],a=t[1][1],c=t[1][1],l=[-we.dot(r,n),-we.dot(s,n)],d=[[we.dot(r,r)+we.dot(i,n),we.dot(r,s)+we.dot(a,n)],[we.dot(r,s)+we.dot(c,n),we.dot(s,s)+we.dot(o,n)]],u=me.solve(d,l);return we.add(u,e)};o<i;){n=C(s),r=we.sub(n[0][0],t);var T=we.norm(r),b=we.dot(n[1][0],r),w=we.norm(n[1][0])*T,x=we.dot(n[0][1],r),M=we.norm(n[0][1])*T;if(T<a&&b/w<c&&x/M<c)return s;var N=S(s,n,r);if(N[0]<l?N=g?[d-(N[0]-l),N[1]]:[l+j.EPSILON,N[1]]:N[0]>d&&(N=g?[l+(N[0]-d),N[1]]:[d-j.EPSILON,N[1]]),N[1]<u?N=f?[N[0],h-(N[1]-u)]:[N[0],u+j.EPSILON]:N[1]>h&&(N=f?[N[0],u+(N[0]-h)]:[N[0],h-j.EPSILON]),we.norm(we.mul(N[0]-s[0],n[1][0]))+we.norm(we.mul(N[1]-s[1],n[0][1]))<a)return s;s=N,o++}return s},xe.rationalCurveClosestPoint=function(e,t){return Ie.rationalCurvePoint(e,xe.rationalCurveClosestParam(e,t))},xe.rationalCurveClosestParam=function(e,t){for(var n=1/0,r=0,s=Re.rationalCurveRegularSample(e,e.controlPoints.length*e.degree,!0),i=0,o=s.length-1;i<o;){var a=i++,c=s[a][0],l=s[a+1][0],d=s[a].slice(1),u=s[a+1].slice(1),h=be.segmentClosestPoint(t,d,u,c,l),g=we.norm(we.sub(t,h.pt));g<n&&(n=g,r=h.u)}for(var f,p,_=5,m=0,v=1e-4,E=5e-4,P=e.knots[0],y=F.last(e.knots),C=we.normSquared(we.sub(e.controlPoints[0],F.last(e.controlPoints)))<j.EPSILON,S=r,T=function(t){return Ie.rationalCurveDerivatives(e,t,2)},b=function(e,t,n){return e-we.dot(t[1],n)/(we.dot(t[2],n)+we.dot(t[1],t[1]))};m<_;){f=T(S),p=we.sub(f[0],t);var w=we.norm(p),x=we.dot(f[1],p)/(we.norm(f[1])*w),M=w<v,N=Math.abs(x)<E;if(M&&N)return S;var A=b(S,f,p);if(A<P?A=C?y-(A-P):P:A>y&&(A=C?P+(A-y):y),we.norm(we.mul(A-S,f[1]))<v)return S;S=A,m++}return S},xe.rationalCurveParamAtArcLength=function(e,t,n,r,s){if(null==n&&(n=.001),t<j.EPSILON)return e.knots[0];var i,o,a=0,c=((i=null!=r?r:Ve.decomposeCurveIntoBeziers(e))[a],-j.EPSILON);for(o=null!=s?s:[];c<t&&a<i.length;){if(a<o.length?o[a]=o[a]:o[a]=xe.rationalBezierCurveArcLength(e),t<(c+=o[a])+j.EPSILON)return xe.rationalBezierCurveParamAtArcLength(e,t,n,o[a]);a++}return-1},xe.rationalBezierCurveParamAtArcLength=function(e,t,n,r){if(t<0)return e.knots[0];var s;if(t>(s=null!=r?r:xe.rationalBezierCurveArcLength(e)))return F.last(e.knots);var i,o=e.knots[0],a=0,c=F.last(e.knots),l=s,d=0,u=0;for(i=null!=n?n:2*j.TOLERANCE;l-a>i;)d=(o+c)/2,(u=xe.rationalBezierCurveArcLength(e,d))>t?(c=d,l=u):(o=d,a=u);return(o+c)/2},xe.rationalCurveArcLength=function(e,t,n){null==n&&(n=16),null==t&&(t=F.last(e.knots));for(var r=Ve.decomposeCurveIntoBeziers(e),s=0,i=r[0],o=0;s<r.length&&i.knots[0]+j.EPSILON<t;){var a=Math.min(F.last(i.knots),t);o+=xe.rationalBezierCurveArcLength(i,a,n),i=r[++s]}return o},xe.rationalBezierCurveArcLength=function(e,t,n){null==n&&(n=16);for(var r,s,i=((null==t?F.last(e.knots):t)-e.knots[0])/2,o=0,a=e.degree+n,c=0;c<a;){var l=c++;r=i*xe.Tvalues[a][l]+i+e.knots[0],s=Ie.rationalCurveDerivatives(e,r,1),o+=xe.Cvalues[a][l]*we.norm(s[1])}return i*o};var Me=t.eval.KnotMultiplicity=function(e,t){this.knot=e,this.mult=t};r["verb.eval.KnotMultiplicity"]=Me,Me.__name__=["verb","eval","KnotMultiplicity"],Me.prototype={inc:function(){this.mult++},__class__:Me};var Ne=t.eval.Check=function(){};r["verb.eval.Check"]=Ne,Ne.__name__=["verb","eval","Check"],Ne.isValidKnotVector=function(e,t){if(0==e.length)return!1;if(e.length<2*(t+1))return!1;for(var n=F.first(e),r=0,s=t+1;r<s;){var i=r++;if(Math.abs(e[i]-n)>j.EPSILON)return!1}n=F.last(e);for(var o=e.length-t-1,a=e.length;o<a;){var c=o++;if(Math.abs(e[c]-n)>j.EPSILON)return!1}return Ne.isNonDecreasing(e)},Ne.isNonDecreasing=function(e){for(var t=F.first(e),n=0,r=e.length;n<r;){var s=n++;if(e[s]<t-j.EPSILON)return!1;t=e[s]}return!0},Ne.isValidNurbsCurveData=function(e){if(null==e.controlPoints)throw new w("Control points array cannot be null!");if(null==e.degree)throw new w("Degree cannot be null!");if(e.degree<1)throw new w("Degree must be greater than 1!");if(null==e.knots)throw new w("Knots cannot be null!");if(e.knots.length!=e.controlPoints.length+e.degree+1)throw new w("controlPoints.length + degree + 1 must equal knots.length!");if(!Ne.isValidKnotVector(e.knots,e.degree))throw new w("Invalid knot vector format!  Should begin with degree + 1 repeats and end with degree + 1 repeats!");return e},Ne.isValidNurbsSurfaceData=function(e){if(null==e.controlPoints)throw new w("Control points array cannot be null!");if(null==e.degreeU)throw new w("DegreeU cannot be null!");if(null==e.degreeV)throw new w("DegreeV cannot be null!");if(e.degreeU<1)throw new w("DegreeU must be greater than 1!");if(e.degreeV<1)throw new w("DegreeV must be greater than 1!");if(null==e.knotsU)throw new w("KnotsU cannot be null!");if(null==e.knotsV)throw new w("KnotsV cannot be null!");if(e.knotsU.length!=e.controlPoints.length+e.degreeU+1)throw new w("controlPointsU.length + degreeU + 1 must equal knotsU.length!");if(e.knotsV.length!=e.controlPoints[0].length+e.degreeV+1)throw new w("controlPointsV.length + degreeV + 1 must equal knotsV.length!");if(!Ne.isValidKnotVector(e.knotsU,e.degreeU)||!Ne.isValidKnotVector(e.knotsV,e.degreeV))throw new w("Invalid knot vector format!  Should begin with degree + 1 repeats and end with degree + 1 repeats!");return e};var Ae=t.eval.Divide=function(){};r["verb.eval.Divide"]=Ae,Ae.__name__=["verb","eval","Divide"],Ae.surfaceSplit=function(e,t,n){var r,s,i,o;null==n&&(n=!1),n?(i=e.controlPoints,r=e.knotsV,s=e.degreeV):(i=me.transpose(e.controlPoints),r=e.knotsU,s=e.degreeU);for(var a=[],c=0,l=s+1;c<l;)c++,a.push(t);o=a;for(var d=[],u=[],h=Ie.knotSpan(s,t,r),g=null,f=0;f<i.length;){var p=i[f];++f,g=Ve.curveKnotRefine(new H(s,r,p),o),d.push(g.controlPoints.slice(0,h+1)),u.push(g.controlPoints.slice(h+1))}var _=g.knots.slice(0,h+s+2),m=g.knots.slice(h+1);return n?[new Y(e.degreeU,s,e.knotsU.slice(),_,d),new Y(e.degreeU,s,e.knotsU.slice(),m,u)]:(d=me.transpose(d),u=me.transpose(u),[new Y(s,e.degreeV,_,e.knotsV.slice(),d),new Y(s,e.degreeV,m,e.knotsV.slice(),u)])},Ae.curveSplit=function(e,t){for(var n,r=e.degree,s=(e.controlPoints,e.knots),i=[],o=0,a=r+1;o<a;)o++,i.push(t);n=i;var c=Ve.curveKnotRefine(e,n),l=Ie.knotSpan(r,t,s),d=c.knots.slice(0,l+r+2),u=c.knots.slice(l+1),h=c.controlPoints.slice(0,l+1),g=c.controlPoints.slice(l+1);return[new H(r,d,h),new H(r,u,g)]},Ae.rationalCurveByEqualArcLength=function(e,t){var n=xe.rationalCurveArcLength(e)/t;return Ae.rationalCurveByArcLength(e,n)},Ae.rationalCurveByArcLength=function(e,t){var n=Ve.decomposeCurveIntoBeziers(e),r=n.map((function(e){return xe.rationalBezierCurveArcLength(e)})),s=we.sum(r),i=[new Oe(e.knots[0],0)];if(t>s)return i;for(var o,a=t,c=0,l=a,d=0,u=0;c<n.length;){for(d+=r[c];l<d+j.EPSILON;)o=xe.rationalBezierCurveParamAtArcLength(n[c],l-u,j.TOLERANCE,r[c]),i.push(new Oe(o,l)),l+=a;u+=r[c],c++}return i};var Oe=t.eval.CurveLengthSample=function(e,t){this.u=e,this.len=t};r["verb.eval.CurveLengthSample"]=Oe,Oe.__name__=["verb","eval","CurveLengthSample"],Oe.prototype={__class__:Oe};var Ie=t.eval.Eval=function(){};r["verb.eval.Eval"]=Ie,Ie.__name__=["verb","eval","Eval"],Ie.rationalCurveTangent=function(e,t){return Ie.rationalCurveDerivatives(e,t,1)[1]},Ie.rationalSurfaceNormal=function(e,t,n){var r=Ie.rationalSurfaceDerivatives(e,t,n,1);return we.cross(r[1][0],r[0][1])},Ie.rationalSurfaceDerivatives=function(e,t,n,r){null==r&&(r=1);for(var s=Ie.surfaceDerivatives(e,t,n,r),i=Ie.rational2d(s),o=Ie.weight2d(s),a=[],c=i[0][0].length,l=0,d=r+1;l<d;){var u=l++;a.push([]);for(var h=0,g=r-u+1;h<g;){for(var f=h++,p=i[u][f],_=1,m=f+1;_<m;){var v=_++;p=we.sub(p,we.mul(k.get(f,v)*o[0][v],a[u][f-v]))}for(var E=1,P=u+1;E<P;){var y=E++;p=we.sub(p,we.mul(k.get(u,y)*o[y][0],a[u-y][f]));for(var C=we.zeros1d(c),S=1,T=f+1;S<T;){var b=S++;C=we.add(C,we.mul(k.get(f,b)*o[y][b],a[u-y][f-b]))}p=we.sub(p,we.mul(k.get(u,y),C))}a[u].push(we.mul(1/o[0][0],p))}}return a},Ie.rationalSurfacePoint=function(e,t,n){return Ie.dehomogenize(Ie.surfacePoint(e,t,n))},Ie.rationalCurveDerivatives=function(e,t,n){null==n&&(n=1);for(var r=Ie.curveDerivatives(e,t,n),s=Ie.rational1d(r),i=Ie.weight1d(r),o=[],a=0,c=n+1;a<c;){for(var l=a++,d=s[l],u=1,h=l+1;u<h;){var g=u++;d=we.sub(d,we.mul(k.get(l,g)*i[g],o[l-g]))}o.push(we.mul(1/i[0],d))}return o},Ie.rationalCurvePoint=function(e,t){return Ie.dehomogenize(Ie.curvePoint(e,t))},Ie.surfaceDerivatives=function(e,t,n,r){var s=e.knotsU.length-e.degreeU-2,i=e.knotsV.length-e.degreeV-2;return Ie.surfaceDerivativesGivenNM(s,i,e,t,n,r)},Ie.surfaceDerivativesGivenNM=function(e,t,n,r,s,i){var o=n.degreeU,a=n.degreeV,c=n.controlPoints,l=n.knotsU,d=n.knotsV;if(!Ie.areValidRelations(o,c.length,l.length)||!Ie.areValidRelations(a,c[0].length,d.length))throw new w("Invalid relations between control points, knot vector, and n");var u,h,g=c[0][0].length;u=i<o?i:o,h=i<a?i:a;for(var f=we.zeros3d(i+1,i+1,g),p=Ie.knotSpanGivenN(e,o,r,l),_=Ie.knotSpanGivenN(t,a,s,d),m=Ie.derivativeBasisFunctionsGivenNI(p,r,o,e,l),v=Ie.derivativeBasisFunctionsGivenNI(_,s,a,t,d),E=we.zeros2d(a+1,g),P=0,y=u+1;P<y;){for(var C=P++,S=0,T=a+1;S<T;){var b=S++;E[b]=we.zeros1d(g);for(var x=0,M=o+1;x<M;){var N=x++;E[b]=we.add(E[b],we.mul(m[C][N],c[p-o+N][_-a+b]))}}for(var A=i-C,O=0,I=(A<h?A:h)+1;O<I;){var D=O++;f[C][D]=we.zeros1d(g);for(var L=0,V=a+1;L<V;){var R=L++;f[C][D]=we.add(f[C][D],we.mul(v[D][R],E[R]))}}}return f},Ie.surfacePoint=function(e,t,n){var r=e.knotsU.length-e.degreeU-2,s=e.knotsV.length-e.degreeV-2;return Ie.surfacePointGivenNM(r,s,e,t,n)},Ie.surfacePointGivenNM=function(e,t,n,r,s){var i=n.degreeU,o=n.degreeV,a=n.controlPoints,c=n.knotsU,l=n.knotsV;if(!Ie.areValidRelations(i,a.length,c.length)||!Ie.areValidRelations(o,a[0].length,l.length))throw new w("Invalid relations between control points, knot vector, and n");for(var d=a[0][0].length,u=Ie.knotSpanGivenN(e,i,r,c),h=Ie.knotSpanGivenN(t,o,s,l),g=Ie.basisFunctionsGivenKnotSpanIndex(u,r,i,c),f=Ie.basisFunctionsGivenKnotSpanIndex(h,s,o,l),p=u-i,_=h,m=we.zeros1d(d),v=we.zeros1d(d),E=0,P=o+1;E<P;){var y=E++;v=we.zeros1d(d),_=h-o+y;for(var C=0,S=i+1;C<S;){var T=C++;v=we.add(v,we.mul(g[T],a[p+T][_]))}m=we.add(m,we.mul(f[y],v))}return m},Ie.curveDerivatives=function(e,t,n){var r=e.knots.length-e.degree-2;return Ie.curveDerivativesGivenN(r,e,t,n)},Ie.curveDerivativesGivenN=function(e,t,n,r){var s=t.degree,i=t.controlPoints,o=t.knots;if(!Ie.areValidRelations(s,i.length,o.length))throw new w("Invalid relations between control points, knot vector, and n");var a,c=i[0].length;a=r<s?r:s;for(var l=we.zeros2d(r+1,c),d=Ie.knotSpanGivenN(e,s,n,o),u=Ie.derivativeBasisFunctionsGivenNI(d,n,s,a,o),h=0,g=a+1;h<g;)for(var f=h++,p=0,_=s+1;p<_;){var m=p++;l[f]=we.add(l[f],we.mul(u[f][m],i[d-s+m]))}return l},Ie.curvePoint=function(e,t){var n=e.knots.length-e.degree-2;return Ie.curvePointGivenN(n,e,t)},Ie.areValidRelations=function(e,t,n){return t+e+1-n==0},Ie.curvePointGivenN=function(e,t,n){var r=t.degree,s=t.controlPoints,i=t.knots;if(!Ie.areValidRelations(r,s.length,i.length))throw new w("Invalid relations between control points, knot Array, and n");for(var o=Ie.knotSpanGivenN(e,r,n,i),a=Ie.basisFunctionsGivenKnotSpanIndex(o,n,r,i),c=we.zeros1d(s[0].length),l=0,d=r+1;l<d;){var u=l++;c=we.add(c,we.mul(a[u],s[o-r+u]))}return c},Ie.volumePoint=function(e,t,n,r){var s=e.knotsU.length-e.degreeU-2,i=e.knotsV.length-e.degreeV-2,o=e.knotsW.length-e.degreeW-2;return Ie.volumePointGivenNML(e,s,i,o,t,n,r)},Ie.volumePointGivenNML=function(e,t,n,r,s,i,o){if(!Ie.areValidRelations(e.degreeU,e.controlPoints.length,e.knotsU.length)||!Ie.areValidRelations(e.degreeV,e.controlPoints[0].length,e.knotsV.length)||!Ie.areValidRelations(e.degreeW,e.controlPoints[0][0].length,e.knotsW.length))throw new w("Invalid relations between control points and knot vector");for(var a=e.controlPoints,c=e.degreeU,l=e.degreeV,d=e.degreeW,u=e.knotsU,h=e.knotsV,g=e.knotsW,f=a[0][0][0].length,p=Ie.knotSpanGivenN(t,c,s,u),_=Ie.knotSpanGivenN(n,l,i,h),m=Ie.knotSpanGivenN(r,d,o,g),v=Ie.basisFunctionsGivenKnotSpanIndex(p,s,c,u),E=Ie.basisFunctionsGivenKnotSpanIndex(_,i,l,h),P=Ie.basisFunctionsGivenKnotSpanIndex(m,o,d,g),y=p-c,C=we.zeros1d(f),S=we.zeros1d(f),T=we.zeros1d(f),b=0,x=d+1;b<x;){var M=b++;T=we.zeros1d(f);for(var N=m-d+M,A=0,O=l+1;A<O;){var I=A++;S=we.zeros1d(f);for(var D=_-l+I,L=0,V=c+1;L<V;){var R=L++;S=we.add(S,we.mul(v[R],a[y+R][D][N]))}T=we.add(T,we.mul(E[I],S))}C=we.add(C,we.mul(P[M],T))}return C},Ie.derivativeBasisFunctions=function(e,t,n){var r=Ie.knotSpan(t,e,n),s=n.length-1-t-1;return Ie.derivativeBasisFunctionsGivenNI(r,e,t,s,n)},Ie.derivativeBasisFunctionsGivenNI=function(e,t,n,r,s){var i=we.zeros2d(n+1,n+1),o=we.zeros1d(n+1),a=we.zeros1d(n+1),c=0,l=0;i[0][0]=1;for(var d=1,u=n+1;d<u;){var h=d++;o[h]=t-s[e+1-h],a[h]=s[e+h]-t,c=0;for(var g=0;g<h;){var f=g++;i[h][f]=a[f+1]+o[h-f],l=i[f][h-1]/i[h][f],i[f][h]=c+a[f+1]*l,c=o[h-f]*l}i[h][h]=c}for(var p=we.zeros2d(r+1,n+1),_=we.zeros2d(2,n+1),m=0,v=1,E=0,P=0,y=0,C=0,S=n+1;C<S;){var T=C++;p[0][T]=i[T][n]}for(var b=0,w=n+1;b<w;){var x=b++;m=0,v=1,_[0][0]=1;for(var M=1,N=r+1;M<N;){var A=M++;E=0,P=x-A,y=n-A,x>=A&&(_[v][0]=_[m][0]/i[y+1][P],E=_[v][0]*i[P][y]);for(var O=P>=-1?1:-P,I=1+(x-1<=y?A-1:n-x);O<I;){var D=O++;_[v][D]=(_[m][D]-_[m][D-1])/i[y+1][P+D],E+=_[v][D]*i[P+D][y]}x<=y&&(_[v][A]=-_[m][A-1]/i[y+1][x],E+=_[v][A]*i[x][y]),p[A][x]=E;var L=m;m=v,v=L}}for(var V=n,R=1,U=r+1;R<U;){for(var B=R++,F=0,k=n+1;F<k;){var G=F++;p[B][G]*=V}V*=n-B}return p},Ie.basisFunctions=function(e,t,n){var r=Ie.knotSpan(t,e,n);return Ie.basisFunctionsGivenKnotSpanIndex(r,e,t,n)},Ie.basisFunctionsGivenKnotSpanIndex=function(e,t,n,r){var s=we.zeros1d(n+1),i=we.zeros1d(n+1),o=we.zeros1d(n+1),a=0,c=0;s[0]=1;for(var l=1,d=n+1;l<d;){var u=l++;i[u]=t-r[e+1-u],o[u]=r[e+u]-t,a=0;for(var h=0;h<u;){var g=h++;c=s[g]/(o[g+1]+i[u-g]),s[g]=a+o[g+1]*c,a=i[u-g]*c}s[u]=a}return s},Ie.knotSpan=function(e,t,n){return Ie.knotSpanGivenN(n.length-e-2,e,t,n)},Ie.knotSpanGivenN=function(e,t,n,r){if(n>r[e+1]-j.EPSILON)return e;if(n<r[t]+j.EPSILON)return t;for(var s=t,i=e+1,o=Math.floor((s+i)/2);n<r[o]||n>=r[o+1];)n<r[o]?i=o:s=o,o=Math.floor((s+i)/2);return o},Ie.dehomogenize=function(e){for(var t=[],n=e[e.length-1],r=e.length-1,s=0;s<r;){var i=s++;t.push(e[i]/n)}return t},Ie.rational1d=function(e){var t=e[0].length-1;return e.map((function(e){return e.slice(0,t)}))},Ie.rational2d=function(e){return e.map(Ie.rational1d)},Ie.weight1d=function(e){var t=e[0].length-1;return e.map((function(e){return e[t]}))},Ie.weight2d=function(e){return e.map(Ie.weight1d)},Ie.dehomogenize1d=function(e){return e.map(Ie.dehomogenize)},Ie.dehomogenize2d=function(e){return e.map(Ie.dehomogenize1d)},Ie.homogenize1d=function(e,t){var n,r=e.length,s=e[0].length,i=[],o=0,a=[];n=null!=t?t:we.rep(e.length,1);for(var c=0;c<r;){var l=c++,d=[];a=e[l],o=n[l];for(var u=0;u<s;){var h=u++;d.push(a[h]*o)}d.push(o),i.push(d)}return i},Ie.homogenize2d=function(e,t){var n,r=e.length,s=[];if(null!=t)n=t;else{for(var i=[],o=0;o<r;)o++,i.push(we.rep(e[0].length,1));n=i}for(var a=0;a<r;){var c=a++;s.push(Ie.homogenize1d(e[c],n[c]))}return s};var De=t.eval.Intersect=function(){};r["verb.eval.Intersect"]=De,De.__name__=["verb","eval","Intersect"],De.surfaces=function(e,t,n){var r=Re.rationalSurfaceAdaptive(e),s=Re.rationalSurfaceAdaptive(t);return De.meshes(r,s).map((function(r){return r.map((function(r){return De.surfacesAtPointWithEstimate(e,t,r.uv0,r.uv1,n)}))})).map((function(e){return Le.rationalInterpCurve(e.map((function(e){return e.point})),3)}))},De.surfacesAtPointWithEstimate=function(e,t,n,r,s){var i,o,a,c,l,d,u,h,g,f,p,_,m,v=5,E=0;do{if(o=(i=Ie.rationalSurfaceDerivatives(e,n[0],n[1],1))[0][0],c=i[1][0],l=i[0][1],a=we.normalized(we.cross(c,l)),d=we.dot(a,o),h=(u=Ie.rationalSurfaceDerivatives(t,r[0],r[1],1))[0][0],f=u[1][0],p=u[0][1],g=we.normalized(we.cross(f,p)),_=we.dot(g,h),(m=we.distSquared(o,h))<s*s)break;var P=we.normalized(we.cross(a,g)),y=we.dot(P,o),C=De.threePlanes(a,d,g,_,P,y);if(null==C)throw new w("panic!");var S=we.sub(C,o),T=we.sub(C,h),b=we.cross(c,a),x=we.cross(l,a),M=we.cross(f,g),N=we.cross(p,g),A=we.dot(x,S)/we.dot(x,c),O=we.dot(b,S)/we.dot(b,l),I=we.dot(N,T)/we.dot(N,f),D=we.dot(M,T)/we.dot(M,p);n=we.add([A,O],n),r=we.add([I,D],r),E++}while(E<v);return new re(n,r,o,m)},De.meshes=function(e,t,n,r){null==n&&(n=new fe(e)),null==r&&(r=new fe(t));var s=De.boundingBoxTrees(n,r,0),i=F.unique(s.map((function(n){return De.triangles(e,n.item0,t,n.item1)})).filter((function(e){return null!=e})).filter((function(e){return we.distSquared(e.min.point,e.max.point)>j.EPSILON})),(function(e,t){var n=we.sub(e.min.uv0,t.min.uv0),r=we.dot(n,n),s=we.sub(e.max.uv0,t.max.uv0),i=we.dot(s,s),o=we.sub(e.min.uv0,t.max.uv0),a=we.dot(o,o),c=we.sub(e.max.uv0,t.min.uv0),l=we.dot(c,c);return r<j.EPSILON&&i<j.EPSILON||a<j.EPSILON&&l<j.EPSILON}));return De.makeMeshIntersectionPolylines(i)},De.meshSlices=function(e,t,n,r){for(var s=new Pe(e),i=s.boundingBox(),o=i.min[0],a=i.min[1],c=i.max[0],l=i.max[1],d=we.span(t,n,r),u=[],h=0;h<d.length;){var g=d[h];++h;var f=new X([[0,1,2],[0,2,3]],[[o,a,g],[c,a,g],[c,l,g],[o,l,g]],null,[[0,0],[1,0],[1,1],[0,1]]);u.push(De.meshes(e,f,s))}return u},De.makeMeshIntersectionPolylines=function(e){if(0==e.length)return[];for(var t=0;t<e.length;){var n=e[t];++t,n.max.opp=n.min,n.min.opp=n.max}for(var r=De.kdTreeFromSegments(e),s=[],i=0;i<e.length;){var o=e[i];++i,s.push(o.min),s.push(o.max)}for(var a=0;a<s.length;){var c=s[a];if(++a,null==c.adj){var l=De.lookupAdjacentSegment(c,r,e.length);null!=l&&null==l.adj&&(c.adj=l,l.adj=c)}}var d=s.filter((function(e){return null==e.adj}));0==d.length&&(d=s);for(var u=[],h=0,g=!1;0!=d.length;){var f=d.pop();if(!f.visited){for(var p=[],_=f;null!=_&&!_.visited&&(_.visited=!0,_.opp.visited=!0,p.push(_),h+=2,(_=_.opp.adj)!=f););p.length>0&&(p.push(p[p.length-1].opp),u.push(p))}if(0==d.length&&s.length>0&&(g||h<s.length)){g=!0;var m=s.pop();d.push(m)}}return u},De.kdTreeFromSegments=function(e){for(var t=[],n=0;n<e.length;){var r=e[n];++n,t.push(new de(r.min.point,r.min)),t.push(new de(r.max.point,r.max))}return new ce(t,we.distSquared)},De.lookupAdjacentSegment=function(e,t,n){var r=t.nearest(e.point,n,j.EPSILON).filter((function(t){return e!=t.item0.obj})).map((function(e){return e.item0.obj}));return 1==r.length?r[0]:null},De.curveAndSurface=function(e,t,n,r,s){null==n&&(n=.001),null!=r||(r=new ge(e)),null!=s||(s=new _e(t));var i=De.boundingBoxTrees(r,s,n);return F.unique(i.map((function(e){var t=e.item0,r=e.item1,s=(F.first(t.knots)+F.last(t.knots))/2,i=[(F.first(r.knotsU)+F.last(r.knotsU))/2,(F.first(r.knotsV)+F.last(r.knotsV))/2];return De.curveAndSurfaceWithEstimate(t,r,[s].concat(i),n)})).filter((function(e){return we.distSquared(e.curvePoint,e.surfacePoint)<n*n})),(function(e,t){return Math.abs(e.u-t.u)<.5*n}))},De.curveAndSurfaceWithEstimate=function(e,t,n,r){null==r&&(r=.001);var s=function(n){var r=Ie.rationalCurvePoint(e,n[0]),s=Ie.rationalSurfacePoint(t,n[1],n[2]),i=we.sub(r,s);return we.dot(i,i)},i=function(n){var r=Ie.rationalCurveDerivatives(e,n[0],1),s=Ie.rationalSurfaceDerivatives(t,n[1],n[2],1),i=we.sub(s[0][0],r[0]),o=we.mul(-1,r[1]),a=s[1][0],c=s[0][1];return[2*we.dot(o,i),2*we.dot(a,i),2*we.dot(c,i)]},o=ye.uncmin(s,n,r*r,i).solution;return new ee(o[0],[o[1],o[2]],Ie.rationalCurvePoint(e,o[0]),Ie.rationalSurfacePoint(t,o[1],o[2]))},De.polylineAndMesh=function(e,t,n){for(var r=De.boundingBoxTrees(new pe(e),new fe(t),n),s=[],i=0;i<r.length;){var o=r[i];++i;var a=o.item0,c=o.item1,l=De.segmentWithTriangle(e.points[a],e.points[a+1],t.points,t.faces[c]);if(null!=l){var d=l.point,u=we.lerp(l.p,[e.params[a]],[e.params[a+1]])[0],h=Ee.triangleUVFromPoint(t,c,d);s.push(new ne(d,u,h,a,c))}}return s},De.boundingBoxTrees=function(e,t,n){null==n&&(n=1e-9);var r=[],s=[];r.push(e),s.push(t);for(var i=[];r.length>0;){var o=r.pop(),a=s.pop();if(!o.empty()&&!a.empty()&&o.boundingBox().intersects(a.boundingBox(),n)){var c=o.indivisible(n),l=a.indivisible(n);if(c&&l)i.push(new Z(o.yield(),a.yield()));else if(!c||l)if(c||!l){var d=o.split(),u=a.split();r.push(d.item1),s.push(u.item1),r.push(d.item1),s.push(u.item0),r.push(d.item0),s.push(u.item1),r.push(d.item0),s.push(u.item0)}else{var h=o.split();r.push(h.item1),s.push(a),r.push(h.item0),s.push(a)}else{var g=a.split();r.push(o),s.push(g.item1),r.push(o),s.push(g.item0)}}}return i},De.curves=function(e,t,n){var r=De.boundingBoxTrees(new ge(e),new ge(t),0);return F.unique(r.map((function(r){return De.curvesWithEstimate(e,t,F.first(r.item0.knots),F.first(r.item1.knots),n)})).filter((function(e){return we.distSquared(e.point0,e.point1)<n})),(function(e,t){return Math.abs(e.u0-t.u0)<5*n}))},De.curvesWithEstimate=function(e,t,n,r,s){var i=function(n){var r=Ie.rationalCurvePoint(e,n[0]),s=Ie.rationalCurvePoint(t,n[1]),i=we.sub(r,s);return we.dot(i,i)},o=function(n){var r=Ie.rationalCurveDerivatives(e,n[0],1),s=Ie.rationalCurveDerivatives(t,n[1],1),i=we.sub(r[0],s[0]),o=r[1],a=we.mul(-1,s[1]);return[2*we.dot(o,i),2*we.dot(a,i)]},a=ye.uncmin(i,[n,r],s*s,o),c=a.solution[0],l=a.solution[1],d=Ie.rationalCurvePoint(e,c),u=Ie.rationalCurvePoint(t,l);return new Q(d,u,c,l)},De.triangles=function(e,t,n,r){var s=e.faces[t],i=n.faces[r],o=Ee.getTriangleNorm(e.points,s),a=Ee.getTriangleNorm(n.points,i),c=e.points[s[0]],l=n.points[i[0]],d=De.planes(c,o,l,a);if(null==d)return null;var u=De.clipRayInCoplanarTriangle(d,e,t);if(null==u)return null;var h=De.clipRayInCoplanarTriangle(d,n,r);if(null==h)return null;var g=De.mergeTriangleClipIntervals(u,h,e,t,n,r);return null==g?null:new $(new te(g.min.uv0,g.min.uv1,g.min.point,t,r),new te(g.max.uv0,g.max.uv1,g.max.point,t,r))},De.clipRayInCoplanarTriangle=function(e,t,n){for(var r=t.faces[n],s=[t.points[r[0]],t.points[r[1]],t.points[r[2]]],i=[t.uvs[r[0]],t.uvs[r[1]],t.uvs[r[2]]],o=[we.sub(i[1],i[0]),we.sub(i[2],i[1]),we.sub(i[0],i[2])],a=[we.sub(s[1],s[0]),we.sub(s[2],s[1]),we.sub(s[0],s[2])],c=a.map(we.normalized),l=a.map(we.norm),d=null,u=null,h=0;h<3;){var g=h++,f=s[g],p=c[g],_=De.rays(f,p,e.origin,e.dir);if(null!=_){var m=_.u0,v=_.u1;m<-j.EPSILON||m>l[g]+j.EPSILON||((null==d||v<d.u)&&(d=new ie(v,we.onRay(e.origin,e.dir,v),we.onRay(i[g],o[g],m/l[g]))),(null==u||v>u.u)&&(u=new ie(v,we.onRay(e.origin,e.dir,v),we.onRay(i[g],o[g],m/l[g]))))}}return null==u||null==d?null:new $(d,u)},De.mergeTriangleClipIntervals=function(e,t,n,r,s,i){if(t.min.u>e.max.u+j.EPSILON||e.min.u>t.max.u+j.EPSILON)return null;var o,a;o=e.min.u>t.min.u?new Z(e.min,0):new Z(t.min,1),a=e.max.u<t.max.u?new Z(e.max,0):new Z(t.max,1);var c=new $(new te(null,null,o.item0.point,r,i),new te(null,null,a.item0.point,r,i));return 0==o.item1?(c.min.uv0=o.item0.uv,c.min.uv1=Ee.triangleUVFromPoint(s,i,o.item0.point)):(c.min.uv0=Ee.triangleUVFromPoint(n,r,o.item0.point),c.min.uv1=o.item0.uv),0==a.item1?(c.max.uv0=a.item0.uv,c.max.uv1=Ee.triangleUVFromPoint(s,i,a.item0.point)):(c.max.uv0=Ee.triangleUVFromPoint(n,r,a.item0.point),c.max.uv1=a.item0.uv),c},De.planes=function(e,t,n,r){var s=we.cross(t,r);if(we.dot(s,s)<j.EPSILON)return null;var i,o,a,c,l=0,d=Math.abs(s[0]),u=Math.abs(s[1]),h=Math.abs(s[2]);u>d&&(l=1,d=u),h>d&&(l=2,d=h),0==l?(i=t[1],o=t[2],a=r[1],c=r[2]):1==l?(i=t[0],o=t[2],a=r[0],c=r[2]):(i=t[0],o=t[1],a=r[0],c=r[1]);var g=-we.dot(e,t),f=-we.dot(n,r),p=i*c-o*a,_=(o*f-g*c)/p,m=(g*a-i*f)/p;return new q(0==l?[0,_,m]:1==l?[_,0,m]:[_,m,0],we.normalized(s))},De.threePlanes=function(e,t,n,r,s,i){var o=we.cross(n,s),a=we.dot(e,o);if(Math.abs(a)<j.EPSILON)return null;var c=we.sub(we.mul(i,n),we.mul(r,s)),l=we.add(we.mul(t,o),we.cross(e,c));return we.mul(1/a,l)},De.polylines=function(e,t,n){for(var r=De.boundingBoxTrees(new pe(e),new pe(t),n),s=[],i=0;i<r.length;){var o=r[i];++i;var a=o.item0,c=o.item1,l=De.segments(e.points[a],e.points[a+1],t.points[c],t.points[c+1],n);null!=l&&(l.u0=we.lerp(l.u0,[e.params[a]],[e.params[a+1]])[0],l.u1=we.lerp(l.u1,[t.params[c]],[t.params[c+1]])[0],s.push(l))}return s},De.segments=function(e,t,n,r,s){var i=we.sub(t,e),o=Math.sqrt(we.dot(i,i)),a=we.mul(1/o,i),c=we.sub(r,n),l=Math.sqrt(we.dot(c,c)),d=we.mul(1/l,c),u=De.rays(e,a,n,d);if(null!=u){var h=Math.min(Math.max(0,u.u0/o),1),g=Math.min(Math.max(0,u.u1/l),1),f=we.onRay(e,i,h),p=we.onRay(n,c,g);if(we.distSquared(f,p)<s*s)return new Q(f,p,h,g)}return null},De.rays=function(e,t,n,r){var s=we.dot(t,r),i=we.dot(t,n),o=we.dot(t,e),a=we.dot(r,n),c=we.dot(r,e),l=we.dot(t,t),d=l*we.dot(r,r)-s*s;if(Math.abs(d)<j.EPSILON)return null;var u=(s*(i-o)-l*(a-c))/d,h=(i-o+u*s)/l,g=we.onRay(e,t,h),f=we.onRay(n,r,u);return new Q(g,f,h,u)},De.segmentWithTriangle=function(e,t,n,r){var s=n[r[0]],i=n[r[1]],o=n[r[2]],a=we.sub(i,s),c=we.sub(o,s),l=we.cross(a,c),d=we.sub(t,e),u=we.sub(e,s),h=-we.dot(l,u),g=we.dot(l,d);if(Math.abs(g)<j.EPSILON)return null;var f=h/g;if(f<0||f>1)return null;var p=we.add(e,we.mul(f,d)),_=we.dot(a,c),m=we.dot(a,a),v=we.dot(c,c),E=we.sub(p,s),P=we.dot(E,a),y=we.dot(E,c),C=_*_-m*v;if(Math.abs(C)<j.EPSILON)return null;var S=(_*y-v*P)/C,T=(_*P-m*y)/C;return S>1+j.EPSILON||T>1+j.EPSILON||T<-j.EPSILON||S<-j.EPSILON||S+T>1+j.EPSILON?null:new se(p,S,T,f)},De.segmentAndPlane=function(e,t,n,r){var s=we.dot(r,we.sub(t,e));if(Math.abs(s)<j.EPSILON)return null;var i=we.dot(r,we.sub(n,e))/s;return i>1+j.EPSILON||i<-j.EPSILON?null:{p:i}};var Le=t.eval.Make=function(){};r["verb.eval.Make"]=Le,Le.__name__=["verb","eval","Make"],Le.rationalTranslationalSurface=function(e,t){for(var n=Ie.rationalCurvePoint(t,F.first(t.knots)),r=F.first(t.knots),s=F.last(t.knots),i=2*t.controlPoints.length,o=(s-r)/(i-1),a=[],c=0;c<i;){var l=c++,d=we.sub(Ie.rationalCurvePoint(t,r+l*o),n),u=Ve.rationalCurveTransform(e,[[1,0,0,d[0]],[0,1,0,d[1]],[0,0,1,d[2]],[0,0,0,1]]);a.push(u)}return Le.loftedSurface(a)},Le.surfaceBoundaryCurves=function(e){return[Le.surfaceIsocurve(e,F.first(e.knotsU),!1),Le.surfaceIsocurve(e,F.last(e.knotsU),!1),Le.surfaceIsocurve(e,F.first(e.knotsV),!0),Le.surfaceIsocurve(e,F.last(e.knotsV),!0)]},Le.surfaceIsocurve=function(e,t,n){var r,s;null==n&&(n=!1),r=n?e.knotsV:e.knotsU,s=n?e.degreeV:e.degreeU;for(var i=xe.knotMultiplicities(r),o=-1,a=0,c=i.length;a<c;){var l=a++;if(Math.abs(t-i[l].knot)<j.EPSILON){o=l;break}}var d,u=s+1;o>=0&&(u-=i[o].mult),d=u>0?Ve.surfaceKnotRefine(e,we.rep(u,t),n):e;var h=Ie.knotSpan(s,t,r);return Math.abs(t-F.first(r))<j.EPSILON?h=0:Math.abs(t-F.last(r))<j.EPSILON&&(h=(n?d.controlPoints[0].length:d.controlPoints.length)-1),n?new H(d.degreeU,d.knotsU,function(e){for(var t=[],n=0,r=d.controlPoints;n<r.length;){var s=r[n];++n,t.push(s[h])}return t}()):new H(d.degreeV,d.knotsV,d.controlPoints[h])},Le.loftedSurface=function(e,t){var n=(e=Ve.unifyCurveKnotVectors(e))[0].degree;null==t&&(t=3),t>e.length-1&&(t=e.length-1);for(var r=e[0].knots,s=[],i=[],o=0,a=e[0].controlPoints.length;o<a;){var c=[o++],l=e.map(function(e){return function(t){return t.controlPoints[e[0]]}}(c)),d=Le.rationalInterpCurve(l,t,!0);i.push(d.controlPoints),s=d.knots}return new Y(n,t,r,s,i)},Le.clonedCurve=function(e){return new H(e.degree,e.knots.slice(),e.controlPoints.map((function(e){return e.slice()})))},Le.rationalBezierCurve=function(e,t){for(var n=e.length-1,r=[],s=0,i=n+1;s<i;)s++,r.push(0);for(var o=0,a=n+1;o<a;)o++,r.push(1);return null==t&&(t=we.rep(e.length,1)),new H(n,r,Ie.homogenize1d(e,t))},Le.fourPointSurface=function(e,t,n,r,s){null==s&&(s=3);for(var i=s,o=[],a=0,c=s+1;a<c;){for(var l=a++,d=[],u=0,h=s+1;u<h;){var g=u++,f=1-l/i,p=we.lerp(f,e,t),_=we.lerp(f,r,n),m=we.lerp(1-g/i,p,_);m.push(1),d.push(m)}o.push(d)}var v=we.rep(s+1,0),E=we.rep(s+1,1);return new Y(s,s,v.concat(E),v.concat(E),o)},Le.ellipseArc=function(e,t,n,r,s){var i=we.norm(t),o=we.norm(n);t=we.normalized(t),n=we.normalized(n),s<r&&(s=2*Math.PI+r);var a=s-r,c=0,l=a/(c=a<=Math.PI/2?1:a<=Math.PI?2:a<=3*Math.PI/2?3:4),d=Math.cos(l/2),u=we.add(e,we.add(we.mul(i*Math.cos(r),t),we.mul(o*Math.sin(r),n))),h=we.sub(we.mul(Math.cos(r),n),we.mul(Math.sin(r),t)),g=[],f=we.zeros1d(2*c+3),p=0,_=r,m=we.zeros1d(2*c);g[0]=u,m[0]=1;for(var v=1,E=c+1;v<E;){var P=v++;_+=l;var y=we.add(e,we.add(we.mul(i*Math.cos(_),t),we.mul(o*Math.sin(_),n)));m[p+2]=1,g[p+2]=y;var C=we.sub(we.mul(Math.cos(_),n),we.mul(Math.sin(_),t)),S=De.rays(u,we.mul(1/we.norm(h),h),y,we.mul(1/we.norm(C),C)),T=we.add(u,we.mul(S.u0,h));m[p+1]=d,g[p+1]=T,p+=2,P<c&&(u=y,h=C)}for(var b=2*c+1,w=0;w<3;){var x=w++;f[x]=0,f[x+b]=1}switch(c){case 2:f[3]=f[4]=.5;break;case 3:f[3]=f[4]=.3333333333333333,f[5]=f[6]=.6666666666666666;break;case 4:f[3]=f[4]=.25,f[5]=f[6]=.5,f[7]=f[8]=.75}return new H(2,f,Ie.homogenize1d(g,m))},Le.arc=function(e,t,n,r,s,i){return Le.ellipseArc(e,we.mul(r,we.normalized(t)),we.mul(r,we.normalized(n)),s,i)},Le.polyline=function(e){for(var t,n=[0,0],r=0,s=0,i=e.length-1;s<i;){var o=s++;r+=we.dist(e[o],e[o+1]),n.push(r)}n.push(r),n=we.mul(1/r,n);for(var a=[],c=0,l=e.length;c<l;)c++,a.push(1);return t=a,new H(1,n,Ie.homogenize1d(e.slice(0),t))},Le.extrudedSurface=function(e,t,n){for(var r=[[],[],[]],s=[[],[],[]],i=Ie.dehomogenize1d(n.controlPoints),o=Ie.weight1d(n.controlPoints),a=we.mul(t,e),c=we.mul(.5*t,e),l=0,d=i.length;l<d;){var u=l++;r[2][u]=i[u],r[1][u]=we.add(c,i[u]),r[0][u]=we.add(a,i[u]),s[0][u]=o[u],s[1][u]=o[u],s[2][u]=o[u]}return new Y(2,n.degree,[0,0,0,1,1,1],n.knots,Ie.homogenize2d(r,s))},Le.cylindricalSurface=function(e,t,n,r,s){var i=we.cross(e,t),o=(Math.PI,Le.arc(n,t,i,s,0,2*Math.PI));return Le.extrudedSurface(e,r,o)},Le.revolvedSurface=function(e,t,n,r){var s,i,o=Ie.dehomogenize1d(e.controlPoints),a=Ie.weight1d(e.controlPoints);r<=Math.PI/2?(s=1,i=we.zeros1d(6+2*(s-1))):r<=Math.PI?(s=2,(i=we.zeros1d(6+2*(s-1)))[3]=i[4]=.5):r<=3*Math.PI/2?(s=3,(i=we.zeros1d(6+2*(s-1)))[3]=i[4]=.3333333333333333,i[5]=i[6]=.6666666666666666):(s=4,(i=we.zeros1d(6+2*(s-1)))[3]=i[4]=.25,i[5]=i[6]=.5,i[7]=i[8]=.75);for(var c=r/s,l=3+2*(s-1),d=0;d<3;){var u=d++;i[u]=0,i[l+u]=1}for(var h=Math.cos(c/2),g=0,f=we.zeros1d(s+1),p=we.zeros1d(s+1),_=we.zeros3d(2*s+1,o.length,3),m=we.zeros2d(2*s+1,o.length),v=1,E=s+1;v<E;){var P=v++;g+=c,p[P]=Math.cos(g),f[P]=Math.sin(g)}for(var y=0,C=o.length;y<C;){var S=y++,T=be.rayClosestPoint(o[S],t,n),b=we.sub(o[S],T),w=we.norm(b),x=we.cross(n,b);w>j.EPSILON&&(b=we.mul(1/w,b),x=we.mul(1/w,x)),_[0][S]=o[S];var M=o[S];m[0][S]=a[S];for(var N=x,A=0,O=1,I=s+1;O<I;){var D,L=O++;D=0==w?T:we.add(T,we.add(we.mul(w*p[L],b),we.mul(w*f[L],x))),_[A+2][S]=D,m[A+2][S]=a[S];var V=we.sub(we.mul(p[L],x),we.mul(f[L],b));if(0==w)_[A+1][S]=T;else{var R=De.rays(M,we.mul(1/we.norm(N),N),D,we.mul(1/we.norm(V),V)),U=we.add(M,we.mul(R.u0,N));_[A+1][S]=U}m[A+1][S]=h*a[S],A+=2,L<s&&(M=D,N=V)}}return new Y(2,e.degree,i,e.knots,Ie.homogenize2d(_,m))},Le.sphericalSurface=function(e,t,n,r){var s=Le.arc(e,we.mul(-1,t),n,r,0,Math.PI);return Le.revolvedSurface(s,e,t,2*Math.PI)},Le.conicalSurface=function(e,t,n,r,s){var i=2*Math.PI,o=1,a=[we.add(n,we.mul(r,e)),we.add(n,we.mul(s,t))],c=[1,1],l=new H(o,[0,0,1,1],Ie.homogenize1d(a,c));return Le.revolvedSurface(l,n,e,i)},Le.rationalInterpCurve=function(e,t,n,r,s){if(null==n&&(n=!1),null==t&&(t=3),e.length<t+1)throw new w("You need to supply at least degree + 1 points! You only supplied "+e.length+" points.");for(var i=[0],o=1,a=e.length;o<a;){var c=o++,l=we.norm(we.sub(e[c],e[c-1])),d=i[i.length-1];i.push(d+l)}for(var u=i[i.length-1],h=0,g=i.length;h<g;){var f=h++;i[f]=i[f]/u}var p,_,m=we.rep(t+1,0),v=null!=r&&null!=s;p=v?0:1,_=v?i.length-t+1:i.length-t;for(var E=p;E<_;){for(var P=E++,y=0,C=0;C<t;)y+=i[P+C++];m.push(1/t*y)}var S,T,b=m.concat(we.rep(t+1,1)),x=[];S=v?e.length+1:e.length-1,T=v?e.length-(t-1):e.length-(t+1);for(var M=0;M<i.length;){var N=i[M];++M;var A=Ie.knotSpanGivenN(S,t,N,b),O=Ie.basisFunctionsGivenKnotSpanIndex(A,N,t,b),I=A-t,D=we.zeros1d(I),L=we.zeros1d(T-I);x.push(D.concat(O).concat(L))}if(v){var V=x[0].length-2,R=[-1,1].concat(we.zeros1d(V)),U=we.zeros1d(V).concat([-1,1]);F.spliceAndInsert(x,1,0,R),F.spliceAndInsert(x,x.length-1,0,U)}for(var B=e[0].length,k=[],G=(1-b[b.length-t-2])/t,j=b[t+1]/t,z=0;z<B;){var W,q=[z++];if(v){(W=[e[0][q[0]]]).push(j*r[q[0]]);for(var Y=1,X=e.length-1;Y<X;){var J=Y++;W.push(e[J][q[0]])}W.push(G*s[q[0]]),W.push(F.last(e)[q[0]])}else W=e.map(function(e){return function(t){return t[e[0]]}}(q));var K=me.solve(x,W);k.push(K)}var Z=me.transpose(k);if(!n){var $=we.rep(Z.length,1);Z=Ie.homogenize1d(Z,$)}return new H(t,b,Z)};var Ve=t.eval.Modify=function(){};r["verb.eval.Modify"]=Ve,Ve.__name__=["verb","eval","Modify"],Ve.curveReverse=function(e){return new H(e.degree,Ve.knotsReverse(e.knots),F.reversed(e.controlPoints))},Ve.surfaceReverse=function(e,t){return null==t&&(t=!1),t?new Y(e.degreeU,e.degreeV,e.knotsU,Ve.knotsReverse(e.knotsV),function(t){for(var n=[],r=0,s=e.controlPoints;r<s.length;){var i=s[r];++r,n.push(F.reversed(i))}return n}()):new Y(e.degreeU,e.degreeV,Ve.knotsReverse(e.knotsU),e.knotsV,F.reversed(e.controlPoints))},Ve.knotsReverse=function(e){for(var t=F.first(e),n=(F.last(e),[t]),r=e.length,s=1;s<r;){var i=s++;n.push(n[i-1]+(e[r-i]-e[r-i-1]))}return n},Ve.unifyCurveKnotVectors=function(e){e=e.map(Le.clonedCurve);for(var t,n=a.fold(e,(function(e,t){return Ve.imax(e.degree,t)}),0),r=0,s=e.length;r<s;){var i=r++;e[i].degree<n&&(e[i]=Ve.curveElevateDegree(e[i],n))}for(var o=[],c=0;c<e.length;){var l=e[c];++c,o.push(new $(F.first(l.knots),F.last(l.knots)))}t=o;for(var d=0,u=e.length;d<u;){var h=d++,g=[t[h].min];e[h].knots=e[h].knots.map(function(e){return function(t){return t-e[0]}}(g))}for(var f=t.map((function(e){return e.max-e.min})),p=a.fold(f,(function(e,t){return Math.max(e,t)}),0),_=0,m=e.length;_<m;){var v=_++,E=[p/f[v]];e[v].knots=e[v].knots.map(function(e){return function(t){return t*e[0]}}(E))}for(var P=a.fold(e,(function(e,t){return we.sortedSetUnion(e.knots,t)}),[]),y=0,C=e.length;y<C;){var S=y++,T=we.sortedSetSub(P,e[S].knots);0==T.length&&(e[S]=e[S]),e[S]=Ve.curveKnotRefine(e[S],T)}return e},Ve.imin=function(e,t){return e<t?e:t},Ve.imax=function(e,t){return e>t?e:t},Ve.curveElevateDegree=function(e,t){if(t<=e.degree)return e;var n=e.knots.length-e.degree-2,r=e.degree,s=e.knots,i=e.controlPoints,o=t-e.degree,a=e.controlPoints[0].length,c=we.zeros2d(r+o+1,r+1),l=[],d=[],u=[],h=n+r+1,g=t,f=Math.floor(g/2),p=[],_=[];c[0][0]=1,c[g][r]=1;for(var m=1,v=f+1;m<v;)for(var E=m++,P=1/k.get(g,E),y=Ve.imin(r,E),C=Ve.imax(0,E-o),S=y+1;C<S;){var T=C++;c[E][T]=P*k.get(r,T)*k.get(o,E-T)}for(var b=f+1;b<g;)for(var w=b++,x=Ve.imin(r,w),M=Ve.imax(0,w-o),N=x+1;M<N;){var A=M++;c[w][A]=c[g-w][r-A]}var O=g+1,I=-1,D=r,L=r+1,V=1,R=s[0];p[0]=i[0];for(var U=0,B=g+1;U<B;)_[U++]=R;for(var F=0,G=r+1;F<G;){var j=F++;l[j]=i[j]}for(;L<h;){for(var z=L;L<h&&s[L]==s[L+1];)L+=1;var W,q,Y=L-z+1,X=s[L],J=I;if(I=r-Y,W=J>0?Math.floor((J+2)/2):1,q=I>0?Math.floor(g-(I+1)/2):g,I>0){for(var K=X-R,Z=[],$=r;$>Y;)Z[$-Y-1]=K/(s[D+$]-R),$--;for(var Q=1,ee=I+1;Q<ee;){for(var te=Q++,ne=I-te,re=Y+te,se=r;se>=re;)l[se]=we.add(we.mul(Z[se-re],l[se]),we.mul(1-Z[se-re],l[se-1])),se--;u[ne]=l[r]}}for(var ie=W,oe=g+1;ie<oe;){var ae=ie++;d[ae]=we.zeros1d(a);for(var ce=Ve.imin(r,ae),le=Ve.imax(0,ae-o),de=ce+1;le<de;){var ue=le++;d[ae]=we.add(d[ae],we.mul(c[ae][ue],l[ue]))}}if(J>1)for(var he=O-2,ge=O,fe=X-R,pe=(X-_[O-1])/fe,_e=1;_e<J;){for(var me=_e++,ve=he,Ee=ge,Pe=Ee-O+1;Ee-ve>me;){if(ve<V){var ye=(X-_[ve])/(R-_[ve]);p[ve]=we.lerp(ye,p[ve],p[ve-1])}if(Ee>=W){if(Ee-me<=O-g+J){var Ce=(X-_[Ee-me])/fe;d[Pe]=we.lerp(Ce,d[Pe],d[Pe+1])}}else d[Pe]=we.lerp(pe,d[Pe],d[Pe+1]);ve+=1,Ee-=1,Pe-=1}he-=1,ge+=1}if(D!=r)for(var Se=0,Te=g-J;Se<Te;)Se++,_[O]=R,O+=1;for(var be=W,xe=q+1;be<xe;){var Me=be++;p[V]=d[Me],V+=1}if(L<h){for(var Ne=0;Ne<I;){var Ae=Ne++;l[Ae]=u[Ae]}for(var Oe=I,Ie=r+1;Oe<Ie;){var De=Oe++;l[De]=i[L-r+De]}D=L,L+=1,R=X}else for(var Le=0,Re=g+1;Le<Re;)_[O+Le++]=X}return new H(t,_,p)},Ve.rationalSurfaceTransform=function(e,t){for(var n=Ie.dehomogenize2d(e.controlPoints),r=0,s=n.length;r<s;)for(var i=r++,o=0,a=n[i].length;o<a;){var c=o++,l=n[i][c];l.push(1),n[i][c]=me.dot(t,l).slice(0,l.length-1)}return new Y(e.degreeU,e.degreeV,e.knotsU.slice(),e.knotsV.slice(),Ie.homogenize2d(n,Ie.weight2d(e.controlPoints)))},Ve.rationalCurveTransform=function(e,t){for(var n=Ie.dehomogenize1d(e.controlPoints),r=0,s=n.length;r<s;){var i=r++,o=n[i];o.push(1),n[i]=me.dot(t,o).slice(0,o.length-1)}return new H(e.degree,e.knots.slice(),Ie.homogenize1d(n,Ie.weight1d(e.controlPoints)))},Ve.surfaceKnotRefine=function(e,t,n){var r,s,i,o=[];n?(i=e.controlPoints,r=e.knotsV,s=e.degreeV):(i=me.transpose(e.controlPoints),r=e.knotsU,s=e.degreeU);for(var a=null,c=0;c<i.length;){var l=i[c];++c,a=Ve.curveKnotRefine(new H(s,r,l),t),o.push(a.controlPoints)}var d=a.knots;return n?new Y(e.degreeU,e.degreeV,e.knotsU.slice(),d,o):(o=me.transpose(o),new Y(e.degreeU,e.degreeV,d,e.knotsV.slice(),o))},Ve.decomposeCurveIntoBeziers=function(e){for(var t=e.degree,n=e.controlPoints,r=e.knots,s=xe.knotMultiplicities(r),i=t+1,o=0;o<s.length;){var a=s[o];if(++o,a.mult<i){var c=we.rep(i-a.mult,a.knot),l=Ve.curveKnotRefine(new H(t,r,n),c);r=l.knots,n=l.controlPoints}}r.length;for(var d=2*i,u=[],h=0;h<n.length;){var g=r.slice(h,h+d),f=n.slice(h,h+i);u.push(new H(t,g,f)),h+=i}return u},Ve.curveKnotRefine=function(e,t){if(0==t.length)return Le.clonedCurve(e);for(var n=e.degree,r=e.controlPoints,s=e.knots,i=r.length-1,o=i+n+1,a=t.length-1,c=Ie.knotSpan(n,t[0],s),l=Ie.knotSpan(n,t[a],s),d=[],u=[],h=0,g=c-n+1;h<g;){var f=h++;d[f]=r[f]}for(var p=l-1,_=i+1;p<_;){var m=p++;d[m+a+1]=r[m]}for(var v=0,E=c+1;v<E;){var P=v++;u[P]=s[P]}for(var y=l+n,C=o+1;y<C;){var S=y++;u[S+a+1]=s[S]}for(var T=l+n-1,b=l+n+a,w=a;w>=0;){for(;t[w]<=s[T]&&T>c;)d[b-n-1]=r[T-n-1],u[b]=s[T],b-=1,T-=1;d[b-n-1]=d[b-n];for(var x=1,M=n+1;x<M;){var N=x++,A=b-n+N,O=u[b+N]-t[w];Math.abs(O)<j.EPSILON?d[A-1]=d[A]:(O/=u[b+N]-s[T-n+N],d[A-1]=we.add(we.mul(O,d[A-1]),we.mul(1-O,d[A])))}u[b]=t[w],b-=1,w--}return new H(n,u,d)},Ve.curveKnotInsert=function(e,t,n){for(var r=e.degree,s=e.controlPoints,i=e.knots,o=0,a=s.length,c=Ie.knotSpan(r,t,i),l=[],d=[],u=[],h=1,g=c+1;h<g;){var f=h++;d[f]=i[f]}for(var p=1,_=n+1;p<_;)d[c+p++]=t;for(var m=c+1,v=i.length;m<v;){var E=m++;d[E+n]=i[E]}for(var P=0,y=c-r+1;P<y;){var C=P++;u[C]=s[C]}for(var S=c-o;S<a;){var T=S++;u[T+n]=s[T]}for(var b=0,w=r-o+1;b<w;){var x=b++;l[x]=s[c-r+x]}for(var M=0,N=0,A=1,O=n+1;A<O;){var I=A++;M=c-r+I;for(var D=0,L=r-I-o+1;D<L;){var V=D++;N=(t-i[M+V])/(i[V+c+1]-i[M+V]),l[V]=we.add(we.mul(N,l[V+1]),we.mul(1-N,l[V]))}u[M]=l[0],u[c+n-I-o]=l[r-I-o]}for(var R=M+1,U=c-o;R<U;){var B=R++;u[B]=l[B-M]}return new H(r,d,u)};var Re=t.eval.Tess=function(){};r["verb.eval.Tess"]=Re,Re.__name__=["verb","eval","Tess"],Re.rationalCurveRegularSample=function(e,t,n){return Re.rationalCurveRegularSampleRange(e,e.knots[0],F.last(e.knots),t,n)},Re.rationalCurveRegularSampleRange=function(e,t,n,r,s){r<1&&(r=2);for(var i=[],o=(n-t)/(r-1),a=0,c=0;c<r;)a=t+o*c++,s?i.push([a].concat(Ie.rationalCurvePoint(e,a))):i.push(Ie.rationalCurvePoint(e,a));return i},Re.rationalCurveAdaptiveSample=function(e,t,n){if(null==n&&(n=!1),null==t&&(t=1e-6),1==e.degree){if(n){for(var r=[],s=0,i=e.controlPoints.length;s<i;){var o=s++;r.push([e.knots[o+1]].concat(Ie.dehomogenize(e.controlPoints[o])))}return r}return e.controlPoints.map(Ie.dehomogenize)}return Re.rationalCurveAdaptiveSampleRange(e,e.knots[0],F.last(e.knots),t,n)},Re.rationalCurveAdaptiveSampleRange=function(e,t,n,r,s){var i=Ie.rationalCurvePoint(e,t),o=Ie.rationalCurvePoint(e,n),a=t+(n-t)*(.5+.2*Math.random()),c=Ie.rationalCurvePoint(e,a),l=we.sub(i,o),d=we.sub(i,c);if(we.dot(l,l)<r&&we.dot(d,d)>r||!be.threePointsAreFlat(i,c,o,r)){var u=t+.5*(n-t),h=Re.rationalCurveAdaptiveSampleRange(e,t,u,r,s),g=Re.rationalCurveAdaptiveSampleRange(e,u,n,r,s);return h.slice(0,-1).concat(g)}return s?[[t].concat(i),[n].concat(o)]:[i,o]},Re.rationalSurfaceNaive=function(e,t,n){t<1&&(t=1),n<1&&(n=1),e.degreeU,e.degreeV,e.controlPoints;for(var r=e.knotsU,s=e.knotsV,i=(F.last(r)-r[0])/t,o=(F.last(s)-s[0])/n,a=[],c=[],l=[],d=0,u=t+1;d<u;)for(var h=d++,g=0,f=n+1;g<f;){var p=h*i,_=g++*o;c.push([p,_]);var m=Ie.rationalSurfaceDerivatives(e,p,_,1),v=m[0][0];a.push(v);var E=we.normalized(we.cross(m[1][0],m[0][1]));l.push(E)}for(var P=[],y=0;y<t;)for(var C=y++,S=0;S<n;){var T=S++,b=C*(n+1)+T,w=(C+1)*(n+1)+T,x=w+1,M=[b,w,x],N=[b,x,b+1];P.push(M),P.push(N)}return new X(P,a,l,c)},Re.divideRationalSurfaceAdaptive=function(e,t){null==t&&(t=new Ue),null!=t.minDivsU?t.minDivsU=t.minDivsU:t.minDivsU=1,null!=t.minDivsV?t.minDivsU=t.minDivsV:t.minDivsU=1,null!=t.refine?t.refine=t.refine:t.refine=!0;var n,r,s=2*(e.controlPoints.length-1),i=2*(e.controlPoints[0].length-1);n=t.minDivsU>s?t.minDivsU=t.minDivsU:t.minDivsU=s,r=t.minDivsV>i?t.minDivsV=t.minDivsV:t.minDivsV=i;for(var o=F.last(e.knotsU),a=e.knotsU[0],c=F.last(e.knotsV),l=e.knotsV[0],d=(o-a)/n,u=(c-l)/r,h=[],g=[],f=0,p=r+1;f<p;){for(var _=f++,m=[],v=0,E=n+1;v<E;){var P=a+d*v++,y=l+u*_,C=Ie.rationalSurfaceDerivatives(e,P,y,1),S=we.normalized(we.cross(C[0][1],C[1][0]));m.push(new oe(C[0][0],S,[P,y],-1,we.isZero(S)))}g.push(m)}for(var T=0;T<r;)for(var b=T++,w=0;w<n;){var x=w++,M=[g[r-b-1][x],g[r-b-1][x+1],g[r-b][x+1],g[r-b][x]];h.push(new Be(e,M))}if(!t.refine)return h;for(var N=0;N<r;)for(var A=N++,O=0;O<n;){var I=O++,D=A*n+I,L=Re.north(D,A,I,n,r,h),V=Re.east(D,A,I,n,r,h),R=Re.south(D,A,I,n,r,h),U=Re.west(D,A,I,n,r,h);h[D].neighbors=[R,V,L,U],h[D].divide(t)}return h},Re.north=function(e,t,n,r,s,i){return 0==t?null:i[e-r]},Re.south=function(e,t,n,r,s,i){return t==s-1?null:i[e+r]},Re.east=function(e,t,n,r,s,i){return n==r-1?null:i[e+1]},Re.west=function(e,t,n,r,s,i){return 0==n?null:i[e-1]},Re.triangulateAdaptiveRefinementNodeTree=function(e){for(var t=X.empty(),n=0;n<e.length;){var r=e[n];++n,r.triangulate(t)}return t},Re.rationalSurfaceAdaptive=function(e,t){null!=t||(t=new Ue);var n=Re.divideRationalSurfaceAdaptive(e,t);return Re.triangulateAdaptiveRefinementNodeTree(n)};var Ue=t.core.AdaptiveRefinementOptions=function(){this.minDivsV=1,this.minDivsU=1,this.refine=!0,this.maxDepth=10,this.minDepth=0,this.normTol=.025};r["verb.eval.AdaptiveRefinementOptions"]=Ue,Ue.__name__=["verb","eval","AdaptiveRefinementOptions"],Ue.prototype={__class__:Ue};var Be=t.core.AdaptiveRefinementNode=function(e,t,n){if(this.srf=e,this.neighbors=null==n?[null,null,null,null]:n,this.corners=t,null==this.corners){var r=e.knotsU[0],s=F.last(e.knotsU),i=e.knotsV[0],o=F.last(e.knotsV);this.corners=[oe.fromUv(r,i),oe.fromUv(s,i),oe.fromUv(s,o),oe.fromUv(r,o)]}};r["verb.eval.AdaptiveRefinementNode"]=Be,Be.__name__=["verb","eval","AdaptiveRefinementNode"],Be.prototype={isLeaf:function(){return null==this.children},center:function(){return null!=this.centerPoint?this.centerPoint:this.evalSrf(this.u05,this.v05)},evalCorners:function(){this.u05=(this.corners[0].uv[0]+this.corners[2].uv[0])/2,this.v05=(this.corners[0].uv[1]+this.corners[2].uv[1])/2;for(var e=0;e<4;){var t=e++;if(null==this.corners[t].point){var n=this.corners[t];this.evalSrf(n.uv[0],n.uv[1],n)}}},evalSrf:function(e,t,n){var r=Ie.rationalSurfaceDerivatives(this.srf,e,t,1),s=r[0][0],i=we.cross(r[0][1],r[1][0]),o=we.isZero(i);return o||(i=we.normalized(i)),null!=n?(n.degen=o,n.point=s,n.normal=i,n):new oe(s,i,[e,t],-1,o)},getEdgeCorners:function(e){if(this.isLeaf())return[this.corners[e]];if(this.horizontal)switch(e){case 0:return this.children[0].getEdgeCorners(0);case 1:return this.children[0].getEdgeCorners(1).concat(this.children[1].getEdgeCorners(1));case 2:return this.children[1].getEdgeCorners(2);case 3:return this.children[1].getEdgeCorners(3).concat(this.children[0].getEdgeCorners(3))}switch(e){case 0:return this.children[0].getEdgeCorners(0).concat(this.children[1].getEdgeCorners(0));case 1:return this.children[1].getEdgeCorners(1);case 2:return this.children[1].getEdgeCorners(2).concat(this.children[0].getEdgeCorners(2));case 3:return this.children[0].getEdgeCorners(3)}return null},getAllCorners:function(e){var t=[this.corners[e]];if(null==this.neighbors[e])return t;var n=this.neighbors[e].getEdgeCorners((e+2)%4),r=e%2,s=j.EPSILON,i=this,o=[function(e){return e.uv[0]>i.corners[0].uv[0]+s&&e.uv[0]<i.corners[2].uv[0]-s},function(e){return e.uv[1]>i.corners[0].uv[1]+s&&e.uv[1]<i.corners[2].uv[1]-s}],a=n.filter(o[r]);return a.reverse(),t.concat(a)},midpoint:function(e){if(null==this.midPoints&&(this.midPoints=[null,null,null,null]),null!=this.midPoints[e])return this.midPoints[e];switch(e){case 0:this.midPoints[0]=this.evalSrf(this.u05,this.corners[0].uv[1]);break;case 1:this.midPoints[1]=this.evalSrf(this.corners[1].uv[0],this.v05);break;case 2:this.midPoints[2]=this.evalSrf(this.u05,this.corners[2].uv[1]);break;case 3:this.midPoints[3]=this.evalSrf(this.corners[0].uv[0],this.v05)}return this.midPoints[e]},hasBadNormals:function(){return this.corners[0].degen||this.corners[1].degen||this.corners[2].degen||this.corners[3].degen},fixNormals:function(){for(var e=this.corners.length,t=0;t<e;){var n=t++;if(this.corners[n],this.corners[n].degen){var r=this.corners[(n+1)%e],s=this.corners[(n+3)%e];r.degen?this.corners[n].normal=s.normal:this.corners[n].normal=r.normal}}},shouldDivide:function(e,t){if(t<e.minDepth)return!0;if(t>=e.maxDepth)return!1;if(this.hasBadNormals())return this.fixNormals(),!1;if(this.splitVert=we.normSquared(we.sub(this.corners[0].normal,this.corners[1].normal))>e.normTol||we.normSquared(we.sub(this.corners[2].normal,this.corners[3].normal))>e.normTol,this.splitHoriz=we.normSquared(we.sub(this.corners[1].normal,this.corners[2].normal))>e.normTol||we.normSquared(we.sub(this.corners[3].normal,this.corners[0].normal))>e.normTol,this.splitVert||this.splitHoriz)return!0;var n=this.center();return we.normSquared(we.sub(n.normal,this.corners[0].normal))>e.normTol||we.normSquared(we.sub(n.normal,this.corners[1].normal))>e.normTol||we.normSquared(we.sub(n.normal,this.corners[2].normal))>e.normTol||we.normSquared(we.sub(n.normal,this.corners[3].normal))>e.normTol},divide:function(e){null==e&&(e=new Ue),null==e.normTol&&(e.normTol=.085),null==e.minDepth&&(e.minDepth=0),null==e.maxDepth&&(e.maxDepth=10),this._divide(e,0,!0)},_divide:function(e,t,n){if(this.evalCorners(),this.shouldDivide(e,t)){if(t++,this.splitVert&&!this.splitHoriz?n=!1:!this.splitVert&&this.splitHoriz&&(n=!0),this.horizontal=n,this.horizontal){var r=[this.corners[0],this.corners[1],this.midpoint(1),this.midpoint(3)],s=[this.midpoint(3),this.midpoint(1),this.corners[2],this.corners[3]];this.children=[new Be(this.srf,r),new Be(this.srf,s)],this.children[0].neighbors=[this.neighbors[0],this.neighbors[1],this.children[1],this.neighbors[3]],this.children[1].neighbors=[this.children[0],this.neighbors[1],this.neighbors[2],this.neighbors[3]]}else{var i=[this.corners[0],this.midpoint(0),this.midpoint(2),this.corners[3]],o=[this.midpoint(0),this.corners[1],this.corners[2],this.midpoint(2)];this.children=[new Be(this.srf,i),new Be(this.srf,o)],this.children[0].neighbors=[this.neighbors[0],this.children[1],this.neighbors[2],this.neighbors[3]],this.children[1].neighbors=[this.neighbors[0],this.neighbors[1],this.neighbors[2],this.children[0]]}for(var a=0,c=this.children;a<c.length;){var l=c[a];++a,l._divide(e,t,!n)}}},triangulate:function(e){if(null==e&&(e=X.empty()),this.isLeaf())return this.triangulateLeaf(e);for(var t=0,n=this.children;t<n.length;){var r=n[t];if(++t,null==r)break;r.triangulate(e)}return e},triangulateLeaf:function(e){for(var t=e.points.length,n=[],r=[],s=0,i=0;i<4;){var o=i++,a=this.getAllCorners(o);2==a.length&&(s=o+1);for(var c=0,l=a.length;c<l;){var d=c++;n.push(a[d])}}for(var u=0;u<n.length;){var h=n[u];++u,-1==h.id?(e.uvs.push(h.uv),e.points.push(h.point),e.normals.push(h.normal),h.id=t,r.push(t),t++):r.push(h.id)}if(4==n.length)return e.faces.push([r[0],r[3],r[1]]),e.faces.push([r[3],r[2],r[1]]),e;if(5==n.length){var g=r.length;return e.faces.push([r[s],r[(s+2)%g],r[(s+1)%g]]),e.faces.push([r[(s+4)%g],r[(s+3)%g],r[s]]),e.faces.push([r[s],r[(s+3)%g],r[(s+2)%g]]),e}var f=this.center();e.uvs.push(f.uv),e.points.push(f.point),e.normals.push(f.normal);for(var p=e.points.length-1,_=0,m=n.length-1;_<n.length;)e.faces.push([p,r[_],r[m]]),m=_++;return e},__class__:Be};var Fe=function(){};r["verb.geom.ICurve"]=Fe,Fe.__name__=["verb","geom","ICurve"],Fe.__interfaces__=[Se],Fe.prototype={__class__:Fe};var ke=t.geom.NurbsCurve=function(e){this._data=Ne.isValidNurbsCurveData(e)};r["verb.geom.NurbsCurve"]=ke,ke.__name__=["verb","geom","NurbsCurve"],ke.__interfaces__=[Fe],ke.byKnotsControlPointsWeights=function(e,t,n,r){return new ke(new H(e,t.slice(),Ie.homogenize1d(n,r)))},ke.byPoints=function(e,t){return null==t&&(t=3),new ke(Le.rationalInterpCurve(e,t))},ke.__super__=z,ke.prototype=i(z.prototype,{degree:function(){return this._data.degree},knots:function(){return this._data.knots.slice(0)},controlPoints:function(){return Ie.dehomogenize1d(this._data.controlPoints)},weights:function(){return Ie.weight1d(this._data.controlPoints)},asNurbs:function(){return new H(this.degree(),this.knots(),Ie.homogenize1d(this.controlPoints(),this.weights()))},clone:function(){return new ke(this._data)},domain:function(){return new $(F.first(this._data.knots),F.last(this._data.knots))},transform:function(e){return new ke(Ve.rationalCurveTransform(this._data,e))},point:function(e){return Ie.rationalCurvePoint(this._data,e)},tangent:function(e){return Ie.rationalCurveTangent(this._data,e)},derivatives:function(e,t){return null==t&&(t=1),Ie.rationalCurveDerivatives(this._data,e,t)},closestPoint:function(e){return xe.rationalCurveClosestPoint(this._data,e)},closestParam:function(e){return xe.rationalCurveClosestParam(this._data,e)},length:function(){return xe.rationalCurveArcLength(this._data)},lengthAtParam:function(e){return xe.rationalCurveArcLength(this._data,e)},paramAtLength:function(e,t){return xe.rationalCurveParamAtArcLength(this._data,e,t)},divideByEqualArcLength:function(e){return Ae.rationalCurveByEqualArcLength(this._data,e)},divideByArcLength:function(e){return Ae.rationalCurveByArcLength(this._data,e)},split:function(e){return Ae.curveSplit(this._data,e).map((function(e){return new ke(e)}))},reverse:function(){return new ke(Ve.curveReverse(this._data))},tessellate:function(e){return Re.rationalCurveAdaptiveSample(this._data,e,!1)},__class__:ke});var Ge=t.geom.Arc=function(e,t,n,r,s,i){ke.call(this,Le.arc(e,t,n,r,s,i)),this._center=e,this._xaxis=t,this._yaxis=n,this._radius=r,this._minAngle=s,this._maxAngle=i};r["verb.geom.Arc"]=Ge,Ge.__name__=["verb","geom","Arc"],Ge.__super__=ke,Ge.prototype=i(ke.prototype,{center:function(){return this._center},xaxis:function(){return this._xaxis},yaxis:function(){return this._yaxis},radius:function(){return this._radius},minAngle:function(){return this._minAngle},maxAngle:function(){return this._maxAngle},__class__:Ge});var je=t.geom.BezierCurve=function(e,t){ke.call(this,Le.rationalBezierCurve(e,t))};r["verb.geom.BezierCurve"]=je,je.__name__=["verb","geom","BezierCurve"],je.__super__=ke,je.prototype=i(ke.prototype,{__class__:je});var ze=t.geom.Circle=function(e,t,n,r){Ge.call(this,e,t,n,r,0,2*Math.PI)};r["verb.geom.Circle"]=ze,ze.__name__=["verb","geom","Circle"],ze.__super__=Ge,ze.prototype=i(Ge.prototype,{__class__:ze});var We=function(){};r["verb.geom.ISurface"]=We,We.__name__=["verb","geom","ISurface"],We.__interfaces__=[Se],We.prototype={__class__:We};var qe=t.geom.NurbsSurface=function(e){this._data=Ne.isValidNurbsSurfaceData(e)};r["verb.geom.NurbsSurface"]=qe,qe.__name__=["verb","geom","NurbsSurface"],qe.__interfaces__=[We],qe.byKnotsControlPointsWeights=function(e,t,n,r,s,i){return new qe(new Y(e,t,n,r,Ie.homogenize2d(s,i)))},qe.byCorners=function(e,t,n,r){return new qe(Le.fourPointSurface(e,t,n,r))},qe.byLoftingCurves=function(e,t){return new qe(Le.loftedSurface(function(t){for(var n=[],r=0;r<e.length;){var s=e[r];++r,n.push(s.asNurbs())}return n}(),t))},qe.__super__=z,qe.prototype=i(z.prototype,{degreeU:function(){return this._data.degreeU},degreeV:function(){return this._data.degreeV},knotsU:function(){return this._data.knotsU.slice(0)},knotsV:function(){return this._data.knotsV.slice(0)},controlPoints:function(){return Ie.dehomogenize2d(this._data.controlPoints)},weights:function(){return Ie.weight2d(this._data.controlPoints)},asNurbs:function(){return new Y(this.degreeU(),this.degreeV(),this.knotsU(),this.knotsV(),Ie.homogenize2d(this.controlPoints(),this.weights()))},clone:function(){return new qe(this.asNurbs())},domainU:function(){return new $(F.first(this._data.knotsU),F.last(this._data.knotsU))},domainV:function(){return new $(F.first(this._data.knotsV),F.last(this._data.knotsV))},point:function(e,t){return Ie.rationalSurfacePoint(this._data,e,t)},normal:function(e,t){return Ie.rationalSurfaceNormal(this._data,e,t)},derivatives:function(e,t,n){return null==n&&(n=1),Ie.rationalSurfaceDerivatives(this._data,e,t,n)},closestParam:function(e){return xe.rationalSurfaceClosestParam(this._data,e)},closestPoint:function(e){return xe.rationalSurfaceClosestPoint(this._data,e)},split:function(e,t){return null==t&&(t=!1),Ae.surfaceSplit(this._data,e,t).map((function(e){return new qe(e)}))},reverse:function(e){return null==e&&(e=!1),new qe(Ve.surfaceReverse(this._data,e))},isocurve:function(e,t){return null==t&&(t=!1),new ke(Le.surfaceIsocurve(this._data,e,t))},boundaries:function(e){return Le.surfaceBoundaryCurves(this._data).map((function(e){return new ke(e)}))},tessellate:function(e){return Re.rationalSurfaceAdaptive(this._data,e)},transform:function(e){return new qe(Ve.rationalSurfaceTransform(this._data,e))},__class__:qe});var He=t.geom.ConicalSurface=function(e,t,n,r,s){qe.call(this,Le.conicalSurface(e,t,n,r,s)),this._axis=e,this._xaxis=t,this._base=n,this._height=r,this._radius=s};r["verb.geom.ConicalSurface"]=He,He.__name__=["verb","geom","ConicalSurface"],He.__super__=qe,He.prototype=i(qe.prototype,{axis:function(){return this._axis},xaxis:function(){return this._xaxis},base:function(){return this._base},height:function(){return this._height},radius:function(){return this._radius},__class__:He});var Ye=t.geom.CylindricalSurface=function(e,t,n,r,s){qe.call(this,Le.cylindricalSurface(e,t,n,r,s)),this._axis=e,this._xaxis=t,this._base=n,this._height=r,this._radius=s};r["verb.geom.CylindricalSurface"]=Ye,Ye.__name__=["verb","geom","CylindricalSurface"],Ye.__super__=qe,Ye.prototype=i(qe.prototype,{axis:function(){return this._axis},xaxis:function(){return this._xaxis},base:function(){return this._base},height:function(){return this._height},radius:function(){return this._radius},__class__:Ye});var Xe=t.geom.EllipseArc=function(e,t,n,r,s){ke.call(this,Le.ellipseArc(e,t,n,r,s)),this._center=e,this._xaxis=t,this._yaxis=n,this._minAngle=r,this._maxAngle=s};r["verb.geom.EllipseArc"]=Xe,Xe.__name__=["verb","geom","EllipseArc"],Xe.__super__=ke,Xe.prototype=i(ke.prototype,{center:function(){return this._center},xaxis:function(){return this._xaxis},yaxis:function(){return this._yaxis},minAngle:function(){return this._minAngle},maxAngle:function(){return this._maxAngle},__class__:Xe});var Je=t.geom.Ellipse=function(e,t,n){Xe.call(this,e,t,n,0,2*Math.PI)};r["verb.geom.Ellipse"]=Je,Je.__name__=["verb","geom","Ellipse"],Je.__super__=Xe,Je.prototype=i(Xe.prototype,{__class__:Je});var Ke=t.geom.ExtrudedSurface=function(e,t){qe.call(this,Le.extrudedSurface(we.normalized(t),we.norm(t),e.asNurbs())),this._profile=e,this._direction=t};r["verb.geom.ExtrudedSurface"]=Ke,Ke.__name__=["verb","geom","ExtrudedSurface"],Ke.__super__=qe,Ke.prototype=i(qe.prototype,{profile:function(){return this._profile},direction:function(){return this._direction},__class__:Ke});var Ze=t.geom.Intersect=function(){};r["verb.geom.Intersect"]=Ze,Ze.__name__=["verb","geom","Intersect"],Ze.curves=function(e,t,n){return null==n&&(n=.001),De.curves(e.asNurbs(),t.asNurbs(),n)},Ze.curveAndSurface=function(e,t,n){return null==n&&(n=.001),De.curveAndSurface(e.asNurbs(),t.asNurbs(),n)},Ze.surfaces=function(e,t,n){return null==n&&(n=.001),De.surfaces(e.asNurbs(),t.asNurbs(),n).map((function(e){return new ke(e)}))};var $e=t.geom.Line=function(e,t){ke.call(this,Le.polyline([e,t])),this._start=e,this._end=t};r["verb.geom.Line"]=$e,$e.__name__=["verb","geom","Line"],$e.__super__=ke,$e.prototype=i(ke.prototype,{start:function(){return this._start},end:function(){return this._end},__class__:$e});var Qe=t.geom.RevolvedSurface=function(e,t,n,r){qe.call(this,Le.revolvedSurface(e.asNurbs(),t,n,r)),this._profile=e,this._center=t,this._axis=n,this._angle=r};r["verb.geom.RevolvedSurface"]=Qe,Qe.__name__=["verb","geom","RevolvedSurface"],Qe.__super__=qe,Qe.prototype=i(qe.prototype,{profile:function(){return this._profile},center:function(){return this._center},axis:function(){return this._center},angle:function(){return this._angle},__class__:Qe});var et=t.geom.SphericalSurface=function(e,t){qe.call(this,Le.sphericalSurface(e,[0,0,1],[1,0,0],t)),this._center=e,this._radius=t};r["verb.geom.SphericalSurface"]=et,et.__name__=["verb","geom","SphericalSurface"],et.__super__=qe,et.prototype=i(qe.prototype,{center:function(){return this._center},radius:function(){return this._radius},__class__:et});var tt=t.geom.SweptSurface=function(e,t){qe.call(this,Le.rationalTranslationalSurface(e.asNurbs(),t.asNurbs())),this._profile=e,this._rail=t};function nt(e){return e instanceof Array?function(){return o.iter(e)}:"function"==typeof e.iterator?it(e,e.iterator):e.iterator}r["verb.geom.SweptSurface"]=tt,tt.__name__=["verb","geom","SweptSurface"],tt.__super__=qe,tt.prototype=i(qe.prototype,{profile:function(){return this._profile},rail:function(){return this._rail},__class__:tt});var rt,st=0;function it(e,t){return null==t?null:(null==t.__id__&&(t.__id__=st++),null==e.hx__closures__?e.hx__closures__={}:n=e.hx__closures__[t.__id__],null==n&&(n=function(){return n.method.apply(n.scope,arguments)},n.scope=e,n.method=t,e.hx__closures__[t.__id__]=n),n);var n}r.Math=Math,String.prototype.__class__=r.String=String,String.__name__=["String"],r.Array=Array,Array.__name__=["Array"],Date.prototype.__class__=r.Date=Date,Date.__name__=["Date"];var ot=r.Int={__name__:["Int"]},at=r.Dynamic={__name__:["Dynamic"]},ct=r.Float=Number;ct.__name__=["Float"];var lt=r.Bool=Boolean;lt.__ename__=["Bool"];var dt=r.Class={__name__:["Class"]},ut={};null==Array.prototype.map&&(Array.prototype.map=function(e){for(var t=[],n=0,r=this.length;n<r;){var s=n++;t[s]=e(this[s])}return t}),null==Array.prototype.filter&&(Array.prototype.filter=function(e){for(var t=[],n=0,r=this.length;n<r;){var s=this[n++];e(s)&&t.push(s)}return t});var ht={},gt=n.ArrayBuffer||M;null==gt.prototype.slice&&(gt.prototype.slice=M.sliceImpl),n.DataView;var ft=n.Uint8Array||A._new;!function(e,t){if(!e.setImmediate){var n,r=1,s={},i=!1,o=e.document,a=Object.getPrototypeOf&&Object.getPrototypeOf(e);a=a&&a.setTimeout?a:e,"[object process]"==={}.toString.call(e.process)?h():g()?f():e.MessageChannel?p():o&&"onreadystatechange"in o.createElement("script")?_():m(),a.setImmediate=n,a.clearImmediate=u}function c(e){return s[r]=l.apply(t,e),r++}function l(e){var n=[].slice.call(arguments,1);return function(){"function"==typeof e?e.apply(t,n):new Function(""+e)()}}function d(e){if(i)setTimeout(l(d,e),0);else{var t=s[e];if(t){i=!0;try{t()}finally{u(e),i=!1}}}}function u(e){delete s[e]}function h(){n=function(){var e=c(arguments);return process.nextTick(l(d,e)),e}}function g(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}function f(){var t="setImmediate$"+Math.random()+"$",r=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&d(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",r,!1):e.attachEvent("onmessage",r),n=function(){var n=c(arguments);return e.postMessage(t+n,"*"),n}}function p(){var e=new MessageChannel;e.port1.onmessage=function(e){d(e.data)},n=function(){var t=c(arguments);return e.port2.postMessage(t),t}}function _(){var e=o.documentElement;n=function(){var t=c(arguments),n=o.createElement("script");return n.onreadystatechange=function(){d(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n),t}}function m(){n=function(){var e=c(arguments);return setTimeout(l(d,e),0),e}}}(new Function("return this")()),m.USE_CACHE=!1,m.USE_ENUM_INDEX=!1,m.BASE64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789%:",v.DEFAULT_RESOLVER=f,v.BASE64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789%:",P.count=0,b.i64tmp=new _(0,0),x.__toStr={}.toString,A.BYTES_PER_ELEMENT=1,R.queue=new c,k.memo=new E,j.TOLERANCE=1e-6,j.EPSILON=1e-10,j.VERSION="2.0.0",xe.Tvalues=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],xe.Cvalues=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],B.main()}("undefined"!=typeof console&&console,e,void 0!==s?s:void 0!==t?t:"undefined"!=typeof self?self:this),e}()},21282:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RayToCurve3dDistance=void 0;const r=n(98106);t.RayToCurve3dDistance=class{static excute(e,t){if(!(t instanceof r.Line3d))return{distance:Number.MAX_VALUE};const n=t;if(e.isParallelTo(n))return{distance:Number.MAX_VALUE};const s=e.getDirection().cross(n.getDirection()).normalize(),i=new r.Plane(r.Vector3.O(),s),o=i.getLine2D(e).extend(r.CONST.MODEL_MAX_LENGTH,!0).extend(r.CONST.MODEL_MAX_LENGTH,!1),a=i.getLine2D(n);if(0===r.MathAlg.PositionJudge.curveToCurve(o,a))return{distance:Number.MAX_VALUE};const c=e.getDirection().cross(s),l=new r.Plane(e.getPtAt(0),c),d=r.MathAlg.CalculateIntersect.curveSurface(n,l),u=n.getPtAt(0).subtract(e.getPtAt(0));return{distance:Math.abs(u.dot(s)),pt:d[0]}}}},83385:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Cmd=void 0;const s=n(95829);t.Cmd=class{getCmdId(){return this._cmdId}getName(){return this.getCmdId()}getCurrentDoc(){return this._app.getMainDoc()}getIApp(){return s.DebugWarn.assert(this._app,"启动cmd后才可以调该方法"," ","2020-09-11"),this._app}clearSelection(){return!0}execute(e){return r(this,void 0,void 0,(function*(){this.executeSync(e)}))}executeSync(e){}onDestroy(){}}},72235:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteCmd=void 0;const i=n(45084),o=n(66250),a=n(83385);let c=class extends a.Cmd{executeSync(){return s(this,void 0,void 0,(function*(){}))}};c=r([i.registerCmd(o.ModelCmdIds.CMD_CANCLE_CURRENT_CMD)],c),t.DeleteCmd=c},28625:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteCmd=void 0;const i=n(45084),o=n(66250),a=n(83385),c=n(41207),l=n(21498),d=n(26452);let u=class extends a.Cmd{clearSelection(){return!1}execute(e){return s(this,void 0,void 0,(function*(){if(void 0===e)yield this._deleteSelection();else{const t=this.getCurrentDoc();yield c.transact(t,"delete element",(()=>{t.deleteElementsById(e)}))}}))}_deleteSelection(){return s(this,void 0,void 0,(function*(){const e=l.Selection.getInstance().getSelectedElementIds();if(!e.length)return;const t=this.getCurrentDoc(),n=[];let r=!0;t.getElementsByIds(e).forEach((e=>{e.canBeDeleted()?n.push(e.id):r=!1})),n.length&&(l.Selection.getInstance().clear(),d.HighLight.getInstance().clear(),yield c.transact(t,"删除",(()=>{this.getCurrentDoc().deleteElementsById(...n)})))}))}};u=r([i.registerCmd(o.ModelCmdIds.CMD_DELETE_ELEMENT)],u),t.DeleteCmd=u},66250:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModelCmdIds=void 0;class n{}t.ModelCmdIds=n,n.CMD_UNDO="cmd.undo",n.CMD_REDO="cmd.redo",n.CMD_CANCLE_CURRENT_CMD="model_cmd_ids.cmd.cancle.current.cmd",n.CMD_DELETE_ELEMENT="cmd.delete",n.CMD_COPY_ELEMENT="cmd.copy.element",n.CMD_RESET_POLYCURVE_ISCIRCLE="cmd.reset.polycurveiscircle",n.CMD_SET_VERTEX_FEATURE_TYPE="cmd.set.vertexfeaturetype",n.CMD_CREATE_VARIABLE="cmd.create.variable",n.CMD_EDIT_VARIABLE="cmd.edit.variable",n.CMD_RESET_DB_PROPERTY="cmd.edit.db.property",n.CMD_MAKE_DB_PROPERTY_TO_EXPRESSION="cmd.make.db.property.to.expression"},43775:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CmdManager=void 0;const s=n(21498),i=n(26452),o=n(95829),a=n(63912),c=n(26874);class l{constructor(){this._registeredCmds=new Map,this._busy=!1}static getInstance(){return l.instance||(l.instance=new l),l.instance}getCurrentCmd(){return this._currentCmd}registerCmd(e,t){const{_registeredCmds:n}=l.getInstance();return o.DebugWarn.warn(void 0===n.get(e),`${e} have been registered!`," ","2020-04-13"),n.set(e,t),!0}sendCmd(e,t,n){var d,u;return r(this,void 0,void 0,(function*(){const{_registeredCmds:r}=l.getInstance(),h=r.get(t);if(o.DebugWarn.assert(h,`cant find command:${t}`," ","2020-04-13"),o.DebugWarn.assert(e.getMainDoc(),"cant getDoc"," ","2020-04-13"),!h)return!1;if(null===(d=this._disableCmds)||void 0===d?void 0:d.has(h.getCmdId()))return!1;for(a.eventManager.dispatchEvent(new a.PreSendCmdEvent(t,n));this._busy;)e.actionMgr.resetAllActions(!1),yield c.sleep(50);return h.clearSelection()&&(s.Selection.getInstance().clear(),i.HighLight.getInstance().clear(),null===(u=e.getMainDoc())||void 0===u||u.updateView()),h._app=e,this._currentCmd=h,this._busy=!0,yield h.execute(n).catch((e=>{a.eventManager.dispatchEvent(new a.CmdErrorEvent(e,t,n))})),h.onDestroy(),delete h._app,delete this._currentCmd,a.eventManager.dispatchEvent(new a.CmdFinishedEvent(t)),this._busy=!1,!0}))}addDisableCmds(e){this._disableCmds||(this._disableCmds=new Set),e.forEach((e=>this._disableCmds.add(e)))}clearDisableCmds(e){this._disableCmds&&(e?e.forEach((e=>this._disableCmds.delete(e))):this._disableCmds.clear(),0===this._disableCmds.size&&delete this._disableCmds)}}t.CmdManager=l},45164:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ResetDBPropertyCmd=t.resetDBProperties=void 0;const i=n(45084),o=n(66250),a=n(83385),c=n(21498),l=n(41207),d=n(95829);function u(e,t){for(const n of t){const t=e.getElementById(n.elementId);if(n.propertyName.startsWith("CALC_"))t.db[n.propertyName]=n.dumpedProperty;else{const e=t.newEmptyDB();e.commit();const r={};r[n.propertyName]=n.dumpedProperty,e.load(r);const s=e[n.propertyName];d.DebugWarn.assert(void 0!==s,"找不到修改的值"," ","2020-05-20"),t.db[n.propertyName]=s}}}t.resetDBProperties=u;let h=class extends a.Cmd{clearSelection(){return!1}execute(e){return s(this,void 0,void 0,(function*(){const t=c.Selection.getInstance().getSelectedElementIds()[0];if(void 0===e[0].elementId&&void 0===t)return;const n=this.getCurrentDoc();yield l.transact(n,"create variable element",(()=>{u(n,e.map((e=>({elementId:e.elementId||t,propertyName:e.propertyName,dumpedProperty:e.dumpedProperty}))))}))}))}};h=r([i.registerCmd(o.ModelCmdIds.CMD_RESET_DB_PROPERTY)],h),t.ResetDBPropertyCmd=h},20591:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.RedoCmd=t.UndoCmd=void 0;const s=n(45084),i=n(66250),o=n(83385);let a=class extends o.Cmd{executeSync(){this.getCurrentDoc().transactionMgr.undo(),this.getCurrentDoc().updateView()}};a=r([s.registerCmd(i.ModelCmdIds.CMD_UNDO)],a),t.UndoCmd=a;let c=class extends o.Cmd{executeSync(){this.getCurrentDoc().transactionMgr.redo(),this.getCurrentDoc().updateView()}};c=r([s.registerCmd(i.ModelCmdIds.CMD_REDO)],c),t.RedoCmd=c},25008:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(20591),n(28625),n(45164),n(72235)},45084:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.registerCmd=void 0;const r=n(43775);t.registerCmd=function(e){return t=>{const n=new t;n._cmdId=e,r.CmdManager.getInstance().registerCmd(e,n)}}},79500:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseCalculator=void 0;t.BaseCalculator=class{constructor(e){this._config=e}init(e){this._db=e}clone(){return new this.constructor(this._config)}}},24611:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CalculatorMgr=void 0;const r=n(95829),s=n(56943);class i{constructor(){this._registeredCalculators=new Map}static getInstance(){return i.instance||(i.instance=new i),i.instance}collectCalculators(e){return this._getCalculators(e)}registerElementCalculator(e,t){let n=this._getCalculators(e);n||(n=new Map,this._registeredCalculators.set(s.getElementSerialId(e),n));const i=t.getOutputProperty(),o=n.get(i);return r.DebugWarn.warn(void 0===o,`${e.name}.${i} will overwite a existing calculator`," ","2020-04-13"),n.set(i,t),!0}unregisterElementCalculator(e,t){const n=this._getCalculators(e);if(!n)return!1;const s=t.getOutputProperty(),i=n.get(s);return r.DebugWarn.assert(i===t,`${e.name}.${s} unregister failed!`," ","2020-04-13"),n.delete(s),!0}_getCalculators(e){return this._registeredCalculators.get(s.getElementSerialId(e))}}t.CalculatorMgr=i},57607:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleCalculator=t.EN_SIMPLE_CALC_OPERATION=void 0;const s=n(95829),i=n(79500);var o;!function(e){e[e.EN_ASSIGN=0]="EN_ASSIGN",e[e.EN_ADD=1]="EN_ADD",e[e.EN_SUB=2]="EN_SUB",e[e.EN_MULTI=3]="EN_MULTI",e[e.EN_DIV=4]="EN_DIV"}(o=t.EN_SIMPLE_CALC_OPERATION||(t.EN_SIMPLE_CALC_OPERATION={}));class a extends i.BaseCalculator{constructor(e){super(e)}getOutputProperty(){return this._config.outPropertyName}getInputPropertyIds(){const e=[this._db.genPropertyId(this._config.inputPropertyName1)];return this._config.inputPropertyName2&&e.push(this._db.genPropertyId(this._config.inputPropertyName2)),e}execute(){return r(this,void 0,void 0,(function*(){const{outPropertyName:e,inputPropertyName1:t,inputPropertyName2:n}=this._config;if(s.DebugWarn.assert(t,"操作符1不能为空"," ","2020-04-13"),this._config.operation===o.EN_ASSIGN)return s.DebugWarn.assert(!n,"赋值操作不需要操作符2"," ","2020-04-13"),this._db[this._config.outPropertyName]=this._db[this._config.inputPropertyName1],!0;switch(s.DebugWarn.assert(n,"操作符2不能为空"," ","2020-04-13"),this._config.operation){case o.EN_ADD:return this._db[e]=this._db[t]+this._db[n],!0;case o.EN_SUB:return this._db[e]=this._db[t]-this._db[n],!0;case o.EN_MULTI:return this._db[e]=this._db[t]*this._db[n],!0;case o.EN_DIV:return this._db[e]=this._db[t]/this._db[n],!0}throw new Error("not support this operation")}))}}t.SimpleCalculator=a},95611:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DocRegenerator=void 0;n(44567);const s=n(95829),i=n(29955),o=n(40475);function a(e,t,n){e.getElementById(t)||s.DebugWarn.assert(!1,`${t.toString()}已被删除，其属性${n}依在更新？`," ","2020-04-13")}t.DocRegenerator=class{constructor(e,t=!0){this._doc=e,this._consoleError=t}regenerateAll(){return r(this,void 0,void 0,(function*(){const e=this._getPpIdsToRegenerateAll();for(const t of e)yield this.regeneratePropery(t);this._postRegenerateAll()}))}syncRegenerateAll(){const e=this._getPpIdsToRegenerateAll();for(const t of e)this.syncRegeneratePropery(t);this._postRegenerateAll()}regenerate(){return r(this,void 0,void 0,(function*(){const e=this._getPropertyIdsToRegenerate();for(const t of e){let e=!1;if(yield this.regeneratePropery(t).catch((t=>{e=!0})),e)throw new Error("关联更新element异常")}return this._doc._isRegenerating=!1,!0}))}syncRegenerate(){const e=this._getPropertyIdsToRegenerate();for(const t of e)this.syncRegeneratePropery(t);return this._doc._isRegenerating=!1,!0}regeneratePropery({eleId:e,propertyName:t}){var n;return r(this,void 0,void 0,(function*(){a(this._doc,e,t);const r=this._doc.cacheForElementsGraph.propertyGraph.getCachedCalculator(e,t);if(!r)return;let s=!1;try{const e=r.execute();e instanceof Promise&&(yield e.catch((e=>{this._consoleError,s=!0})))}catch(e){this._consoleError,s=!0}if(s)throw this._doc._isRegenerating=!1,new Error(`关联更新${null===(n=e.asInt)||void 0===n?void 0:n.call(e)}.${t}异常`)}))}syncRegeneratePropery({eleId:e,propertyName:t}){var n;a(this._doc,e,t);const r=this._doc.cacheForElementsGraph.propertyGraph.getCachedCalculator(e,t);if(r)try{const e=r.execute();o.assertNotPromise(e)}catch(r){throw this._doc._isRegenerating=!1,this._consoleError,new Error(`关联更新${null===(n=e.asInt)||void 0===n?void 0:n.call(e)}.${t}异常`)}}_getPropertyIdsToRegenerate(){if(!this._doc.transactionMgr.getCurrentTransaction())return s.DebugWarn.assert(!1,"没有起事务，为什么调关联更新?"," ","2020-04-13"),[];const e=this._doc.transactionMgr.getCurrentTransaction();e&&e.undoRedoEntity.updateDependencyGraph();const t=this._doc.cacheForElementsGraph.propertyGraph.hasNoCircle();s.DebugWarn.assert(t,"暂时只支持单向的关联关系"," ","2020-04-13");const n=this._doc.transactionMgr.getTransactionCache().getModifiedDatasToRegenerate(),r=[];for(const{id:e,modifiedKeys:t}of n)t.forEach((t=>r.push(new i.PropertyId(e,t))));return this._doc.cacheForElementsGraph.getPropertyIdsToRegenerate(r)}_getPpIdsToRegenerateAll(){return this._doc.cacheForElementsGraph.clear(),this._doc.cacheForElementsGraph.onElementsAdded(this._doc.filterElements()),this._doc.cacheForElementsGraph.propertyTopoSort()}_postRegenerateAll(){var e,t;this._doc.cacheForView.clear(),null===(e=this._doc.transactionMgr.getCurrentTransaction())||void 0===e||e.undoRedoEntity.clear(),null===(t=this._doc.transactionMgr.getCurrentTransaction())||void 0===t||t.undoRedoEntity.onElementsAdded(this._doc.filterElements())}}},29955:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PropertyId=void 0;class n{constructor(e,t){this.eleId=e,this.propertyName=t}toString(){return`${this.eleId.asInt()}${n.CONNECTOR}${this.propertyName}`}}t.PropertyId=n,n.CONNECTOR="."},61962:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBElement=void 0;const r=n(95829),s=n(18064),i=n(12239),o=n(98381),a=n(89171),c=n(7758);class l extends a.IDB{constructor(){super(...arguments),this.id=s.ElementId.INVALID,this.name="",this.invalidInfo="",this.jsonData=new c.JsonData,this.CALC_CachedData=null,this.CALC_GRep=o.GRep.empty,this.CALC_BodiesForToponame=null,this.topoNameToGNodeIdMap=new Map([["",""]]),this.CALC_RegisteredCalculators=void 0,this.visible=!0,this.internalVisible=!0,this.CALC_INVISIBLE=new Set}setJsonData(e,t){const n=this.jsonData.clone();n.set(e,t),this.jsonData=n}deleteJsonData(e){const t=this.jsonData.clone();t.delete(e),this.jsonData=t}getJsonData(e){return this.jsonData.get(e)}genPropertyId(e){return r.DebugWarn.assert(e in this&&"string"==typeof e,`属性不存在 -- ${e}`," ","2020-04-13"),i.PropertyIdUtil.genId(this.getDoc(),this.id,e)}}t.DBElement=l},89171:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IDB=void 0;const r=n(98106),s=n(52807),i=n(95829);t.IDB=class{constructor(){this._cachedNewData={},this._db={}}getDoc(){return this._doc}ownKeys(){return[...new Set([...Object.keys(this._db),...Object.keys(this._cachedNewData)])]}rollBack(){Object.keys(this._cachedNewData).forEach((e=>{this[e]=this._db[e]})),this.commit()}isTransient(){return!!Object.keys(this._cachedNewData).length}commit(){Object.keys(this._cachedNewData).forEach((e=>{this._db[e]=this._cachedNewData[e]})),this._clearCache()}getModified(){const e=[];return Object.keys(this._cachedNewData).forEach((t=>{const n={};n.propertyName=t,n.oldValue=this._db[t],n.newValue=this._cachedNewData[t],e.push(n)})),e}dump(){return this._dumpData(this._db)}load(e){const t=this;for(const n of this.ownKeys())if(!n.startsWith("_")&&!n.startsWith("CALC_")&&void 0!==e[n]&&null!==e[n])if(Array.isArray(this[n]))t[n]=this._loadArray(e,n);else if(this[n]instanceof Map)t[n]=this._loadMap(e,n);else if(this[n]instanceof Set)t[n]=this._loadSet(e,n);else if(s.isIDumpLoad(this[n])){const r=new this[n].constructor;r.load(e[n]),t[n]=r}else{if(this[n]===s.MathCommonObj){const s=r.Loader.load(e[n]);t[n]=s;continue}t[n]=e[n]}}dumpWithCache(){const e=this._dumpData(this._db),t=this._dumpData(this._cachedNewData);return Object.assign(e,t)}clone(){const e=new this.constructor;return e.load(this.dump()),e}_dumpData(e={}){const t=new this.constructor,n={};for(const r of Object.keys(e))if(!r.startsWith("_")&&!r.startsWith("CALC_"))if(Array.isArray(e[r])){const s=this._dumpArray(e[r]),i=this._dumpArray(t[r]);if(JSON.stringify(s)===JSON.stringify(i))continue;n[r]=s}else if(e[r]instanceof Map){const s=this._dumpMap(e[r]),i=this._dumpMap(t[r]);if(JSON.stringify(s)===JSON.stringify(i))continue;n[r]=s}else if(e[r]instanceof Set){const s=this._dumpSet(e[r]),i=this._dumpSet(t[r]);if(JSON.stringify(s)===JSON.stringify(i))continue;n[r]=s}else{const i=s.dumpAProperty(e[r]),o=s.dumpAProperty(t[r]);if(JSON.stringify(i)===JSON.stringify(o))continue;n[r]=i}return n}_dumpArray(e){const t=[...e];for(let e=0;e<t.length;++e){const n=t[e];t[e]=n instanceof Array?this._dumpArray(n):s.dumpAProperty(n)}return t}_loadArray(e,t){if(0===e[t].length)return[];const n=this._db[t][0].constructor,i=this._db[t][0],o=s.isIDumpLoad(this._db[t][0]);return e[t].map((e=>{if(o){const t=new n;return t.load(e),t}if(i===s.MathCommonObj){return r.Loader.load(e)}return e}))}_dumpMap(e){const t=[...e];for(let e=0;e<t.length;++e){const n=this._dumpArray(t[e]);t[e]=n}return this._dumpArray(t)}_loadMap(e,t){let n,r;i.DebugWarn.assert(this._db[t].size>0,"DB数据需要提供初始值"," ","2020-05-14");for(const e of this._db[t].values()){n=e.constructor,r=s.isIDumpLoad(e);break}const o=new Map;for(const s of e[t]){s instanceof Array||i.DebugWarn.assert(!1,"未支持的BD数据类型"," ","2020-05-14");const e=s[0];let t=s[1];if(r){const e=new n;e.load(t),t=e}o.set(e,t)}return o}_dumpSet(e){const t=[...e];return this._dumpArray(t)}_loadSet(e,t){let n,r;i.DebugWarn.assert(this._db[t].size>0,"DB数据需要提供初始值"," ","2020-05-14");for(const e of this._db[t].values()){n=e.constructor,r=s.isIDumpLoad(e);break}const o=new Set;for(let s of e[t]){if(r){const e=new n;e.load(s),s=e}o.add(s)}return o}_clearCache(){Object.keys(this._cachedNewData).forEach((e=>{delete this._cachedNewData[e]})),this._cachedNewData={}}}},52807:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MathCommonObj=t.IDBPropertyType=t.dumpAProperty=t.isIDumpLoad=void 0;const r=n(95829);function s(e){return e&&e.dump instanceof Function&&e.load instanceof Function}t.isIDumpLoad=s,t.dumpAProperty=function(e){const t=typeof e;return"number"===t||"string"===t||"boolean"===t?e:s(e)?e.dump():((Array.isArray(e)||e instanceof Map||e instanceof Set||!e)&&r.DebugWarn.assert(!1,"未支持的BD数据类型","zhouyag","2020-05-14"),e)},function(e){e[e.INVALID=0]="INVALID",e[e.NUMBER=1]="NUMBER",e[e.STRING=2]="STRING",e[e.BOOLEAN=3]="BOOLEAN",e[e.I_DUMP_LOAD=4]="I_DUMP_LOAD",e[e.ARRAY=5]="ARRAY"}(t.IDBPropertyType||(t.IDBPropertyType={})),t.MathCommonObj=Symbol("MathCommonObj")},7758:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JsonData=void 0;class n{constructor(){this.json={}}dump(){return this.json}load(e){return this.json=Object.assign({},e),this}set(e,t){this.json[e]=t}get(e){return this.json[e]}delete(e){delete this.json[e]}clone(){const e=Object.assign({},this.json),t=new n;return t.json=e,t}}t.JsonData=n},28555:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugMode=void 0;t.DebugMode=class{constructor(){this.logSelectedElement=!1,this.showGNodeId=!1,this.showTopoName=!1,this.showTransactionTime=!1,this.vUseV0=!1,this.sdkHasNoView=!0,this.sketchCvAux=!1,this.dontThrowErrorInSolver=!1}}},95829:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DebugWarn=void 0;const r=n(63912);t.DebugWarn=class{static assert(e,t="assert",n,s){if(!e){const e=`${t}\n报告人:${n}\n报告时间：${s}\n点击确定可debug`;throw r.eventManager.dispatchEvent(new r.DebugWarnEvent(!0,e)),new Error(e)}}static warn(e,t="warn",n,s,...i){if(!e){const e=`${t}\n报告人:${n}\n报告时间：${s}\n点击确定可debug`;r.eventManager.dispatchEvent(new r.DebugWarnEvent(!1,e))}}}},62891:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DocSaver=void 0;const s=n(42704),i=n(95829),o=n(17731),a=n(45712),c=n(60472),l=n(48399),d=n(41207),u=n(64323);t.DocSaver=class{constructor(e){this._doc=e}static dumpEmptyDoc(){return{versionCode:0,birthVersion:u.birthVersionCode,fileExtension:"pm",documentName:"new-doc",docUUID:`L${s.uuid()}`,documentType:0,doc:[]}}reflect(e){return r(this,void 0,void 0,(function*(){try{const t=JSON.parse(e);if(!t.fileExtension)throw new Error("cant recognize this file");yield this.load(t)}catch(e){}}))}dump(){const e=this._doc.getAllElementsByCtor(),t=e.filter((e=>!e.isTemporary()&&e.constructor._meta_&&e.constructor._meta_.save)).map((e=>Object.assign({_ctor_:e.constructor._meta_.ctor},e.db.dump()))),n=e.map((e=>{var t;return null===(t=e.getDependentSeekIds)||void 0===t?void 0:t.call(e)})).flat().filter((e=>e)),r=e.map((e=>{var t;return null===(t=e.getSubpartSeekIds)||void 0===t?void 0:t.call(e)})).flat().filter((e=>e)),s={versionCode:this._doc.getVersion(),birthVersion:this._doc.getBirthVersion(),fileExtension:this._doc.fileExtension,documentName:this._doc.getName(),docUUID:this._doc.getUUID(),documentType:this._doc.getDocumentType(),doc:t};return(null==n?void 0:n.length)&&(s.dependentSeekIds=[...new Set(n)]),(null==r?void 0:r.length)&&(s.subpartSeekIds=[...new Set(r)]),s}import(e){let t=[];return d.syncTransact(this._doc,"导入Elements",(()=>{t=this._fillQDocument(e,!1);for(const e of t)try{e.onLoad()}catch(e){}}))?t:[]}load(e){return r(this,void 0,void 0,(function*(){try{const t=new o.Transaction(this._doc,"打开文件");t.canUndo=!1,this._clearQDocument(),this._fillQDocument(e);for(const e of this._doc.filterElements())yield e.asyncOnLoad().catch((e=>{}));return yield this._doc.regenerateAll().catch((e=>{})),t.commit(),this._doc.updateView(!0),!0}catch(e){i.DebugWarn.warn(!1,`parsing saved doc failed -- ${e}`,"","")}return!1}))}syncLoad(e){try{const t=new o.Transaction(this._doc,"打开文件");t.canUndo=!1,this._clearQDocument(),this._fillQDocument(e);for(const e of this._doc.filterElements())e.onLoad();return this._doc.syncRegenerateAll(),t.commit(),this._doc.updateView(!0),!0}catch(e){i.DebugWarn.warn(!1,`parsing saved doc failed -- ${e}`,"","")}return!1}_clearQDocument(){this._doc.filterElements((e=>e.category===c.categoryTmpElement||e.constructor._meta_&&e.constructor._meta_.save)).map((e=>e.id)).forEach((e=>this._doc.elementMgr.delete(this._doc.getElementById(e))))}_fillQDocument(e,t=!0){const n=[];e.doc.forEach((e=>{try{const t=a.elementClassNameToCtorMap.get(e._ctor_);if(!t)return;l.__CAN_CREATE.canCreate=!0;const r=new t;r._db._doc=this._doc,r.db.load(e),n.push(r)}catch(t){i.DebugWarn.warn(!1,`load element ${e} failed`," ","2020-04-10")}finally{l.__CAN_CREATE.canCreate=!1}}));for(const e of n){const n=this._doc.elementMgr.add(e,t);i.DebugWarn.assert(n,"elementId重复"," ","2020-04-09")}if(this._doc.transactionMgr.getTransactionCache().onElementsAdded(n),n.length){const e=Math.max(...n.map((e=>e.id.asInt())));this._doc.idPool.clearStableId(e)}return t&&(this._doc.setName(e.documentName),this._doc.setVersion(e.versionCode),this._doc._birthVersionCode=e.birthVersion||0,this._doc.fileExtension=e.fileExtension,i.DebugWarn.assert(void 0!==this._doc._docUUID,"","",""),this._doc._docUUID=e.docUUID),n}}},64323:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.TDocument=t.birthVersionCode=void 0;const s=n(42704),i=n(95611),o=n(28555),a=n(95829),c=n(18064),l=n(18051),d=n(61175),u=n(54498),h=n(62891),g=n(86688),f=n(48399),p=n(46804),_=n(55083),m=n(57224),v=n(69042);t.birthVersionCode=2;t.TDocument=class{constructor(e,n,r){this.cacheForView=new l.ViewChangedCache,this.cacheForElementsGraph=new d.ElementsGraph(this),this.debugMode=new o.DebugMode,this.idPool=new u.IDPool,this.fileExtension="pm",this._versionCode=0,this._birthVersionCode=t.birthVersionCode,this._isRegenerating=!1,this._name=e,this._documentType=n,this.elementMgr=new m.ElementMgr,this.transactionMgr=new g.TransactionMgr,this.transactionMgr.init(this),this._docUUID=r||`L${s.uuid()}`}getName(){return this._name}setName(e){return this._name=e,this}getUUID(){return this._docUUID}getDocumentType(){return this._documentType}getVersion(){return this._versionCode}setVersion(e){this._versionCode=e}getBirthVersion(){return this._birthVersionCode}create(e){f.__CAN_CREATE.canCreate=!0;const t=new e;t._db._doc=this;let n=this.idPool.genId(t);if(!n){const e=this.transactionMgr.idPoolGC();[...this.elementMgr.getElementsMap().keys()].forEach((t=>e.add(t))),this.idPool.reset(e),n=this.idPool.genId(t)}return a.DebugWarn.assert(n,"Id资源已耗尽"," ","2020-04-13"),t.id=n,f.__CAN_CREATE.canCreate=!1,a.DebugWarn.assert(!this.getElementById(t.id),"该Id已存在"," ","2020-04-13"),t.isTemporary()||this.checkIfCanModifyDoc(),a.DebugWarn.assert(e._meta_&&e._meta_.ctor,"Element未注册meta"," ","2020-08-20"),this.elementMgr.add(t),t.isTemporary()||this.transactionMgr.getTransactionCache().onElementsAdded([t]),t}regenerateAll(){return r(this,void 0,void 0,(function*(){const e=new i.DocRegenerator(this);return yield e.regenerateAll(),!0}))}syncRegenerateAll(){return new i.DocRegenerator(this).syncRegenerateAll(),!0}regenerate(e=!0){return r(this,void 0,void 0,(function*(){this._isRegenerating=!0;return new i.DocRegenerator(this,e).regenerate()}))}syncRegenerate(e=!0){this._isRegenerating=!0;return new i.DocRegenerator(this,e).syncRegenerate()}getElementById(e){let t;return t=e instanceof c.ElementId?e.asInt():e,this.elementMgr.getElementById(t)}getElementsByIds(e){const t=[];return e.forEach((e=>{const n=this.getElementById(e);n&&t.push(n)})),t}filterElements(e){return e?this.elementMgr.getAllElements().filter(e):this.elementMgr.getAllElements()}getAllElementsByCtor(e){return e?this.elementMgr.getElementByCtor(e._meta_.ctor):this.filterElements()}deleteElementsById(...e){const t=this.getElementsByIds(e);if(!t.length)return!1;const n=new Set;t.forEach((e=>{n.add(e.id.asInt()),this.cacheForElementsGraph.getStrongDescendantsToDelete(e.id).forEach((e=>n.add(e)))}));const r=[];let s=!0;const i=[];return n.forEach((e=>{const t=this.getElementById(e);if(!t)return;let o=this.cacheForElementsGraph.getWeaksToNotify(new c.ElementId(e));o=o.filter((e=>!n.has(e.asInt()))),this.getElementsByIds(o).forEach((e=>{i.push({child:e,parent:t})})),t.isTemporary()||(s=!1),r.push(t)})),i.forEach((({child:e,parent:t})=>{this.getElementById(e.id)&&e.updateForWeakParentDeletion(t)})),s||(this.checkIfCanModifyDoc(),a.DebugWarn.assert(!this._isRegenerating,"关联更新的过程中不能执行删除"," ","2020-04-13"),this.transactionMgr.getTransactionCache().onElementsDeleted(r)),r.forEach((e=>{this.elementMgr.delete(e)})),this.cacheForElementsGraph.onElementsDeleted(r),this.cacheForView.cacheElementChanged(_.EN_EVENT_TYPE.ELEMENT_DID_DELETE,r),!0}updateView(e=!1){return this.getAllElementsByCtor(v.ModelView).forEach((t=>t.updateView(e))),this.cacheForView.clear(),!0}checkIfCanModifyDoc(){a.DebugWarn.assert(this.transactionMgr.getCurrentTransaction(),"事务外不可修改文档"," ","2020-04-13")}save(){return new h.DocSaver(this).dump()}saveAsCrypto(){const e=this.save();return{data:p.JsonUtil.pack(e)}}}},38977:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DocumentManager=void 0;const s=n(95829),i=n(63912),o=n(55083),a=n(64323),c=n(62891);class l{constructor(){this._uuidToDocuments=new Map,this._shouleSendEvent=!1}static getInstance(){return l._instance||(l._instance=new l,l._instance._shouleSendEvent=!0),l._instance}getDocumentByUUID(e){const t=this._uuidToDocuments.get(e);if(t)return t}getDocumentCount(){return this._uuidToDocuments.size}openDocument(e){return r(this,void 0,void 0,(function*(){s.DebugWarn.assert(void 0!==e.documentName&&void 0!==e.docUUID,"不存在此runtimeId的document!"," ","2020-04-20");const t=this.createMainDocument(e.documentName,e.docUUID),n=new c.DocSaver(t);if(yield n.load(e))return this._shouleSendEvent&&i.eventManager.dispatchEvent(new i.MessageEvent(o.EN_EVENT_TYPE.DOCUMENT_OPENED,t)),t}))}createMainDocument(e,t){const n=new a.TDocument(e,0,t);return s.DebugWarn.assert(!this._uuidToDocuments.get(n.getUUID()),"uuid重复"," ","2020-09-15"),this._uuidToDocuments.set(n.getUUID(),n),this._shouleSendEvent&&i.eventManager.dispatchEvent(new i.DocumentEvent(o.EN_EVENT_TYPE.DOCUMENT_OPENED,n)),n}closeDocument(e){const t=this._uuidToDocuments.get(e);t&&t.elementMgr.clear();return this._uuidToDocuments.delete(e)&&this._shouleSendEvent&&i.eventManager.dispatchEvent(new i.DocumentEvent(o.EN_EVENT_TYPE.DOCUMENT_CLOSED)),!0}}t.DocumentManager=l},57224:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ElementMgr=void 0;t.ElementMgr=class{constructor(){this._allElements=new Map,this._ctorToElements=new Map}clear(){this._allElements.clear(),this._ctorToElements.clear()}getAllElements(){return[...this._allElements.values()]}getElementsMap(){return this._allElements}getElementsMapDbg(){const e=new Map;for(const t of this._ctorToElements.values())t.size&&e.set(t.values().next().value,[...t]);return e}getElementById(e){return this._allElements.get(e)}getElementByCtor(e){const t=this._ctorToElements.get(e);return t?[...t]:[]}add(e,t=!0){if(!t&&this._allElements.get(e.id.asInt()))return!1;this._allElements.set(e.id.asInt(),e);const n=this._ctorToElements.get(e.getSerialId());return n?n.add(e):this._ctorToElements.set(e.getSerialId(),new Set([e])),!0}delete(e){this._allElements.delete(e.id.asInt());const t=this._ctorToElements.get(e.getSerialId());t&&t.delete(e)}}},15119:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FileUtil=void 0;const r=n(46804);t.FileUtil=class{static parse(e){try{const t=r.JsonUtil.parse(e.trim());if(!t.fileExtension)throw new Error("cant recognize this file");return t}catch(e){return}}}},54498:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IDPool=void 0;const r=n(18064),s=n(95829);class i{constructor(){this._unstablePool=[],this._tmpPool=[],this._currentStableIndex=0,this.reset()}reset(e){this._unstablePool.splice(0);for(let t=0;t<i.MAX_UNSTABLE_NUM;t++){const n=i.MAX_UNSTABLE_OFFSET+t;if(!(null==e?void 0:e.has(n))&&(this._unstablePool.push(n),this._unstablePool.length>=1e3))break}this._tmpPool.splice(0);for(let t=0;t<i.MAX_TMP_NUM;t++){const n=i.MAX_TMP_OFFSET+t;(null==e?void 0:e.has(n))||this._tmpPool.push(n)}}genId(e){return e.isTemporary()?this.genTmpId():e.constructor._meta_&&e.constructor._meta_.save?this.genStableId():this.genUnstableId()}genTmpId(){const e=this._tmpPool.pop();if(void 0!==e)return new r.ElementId(e)}genUnstableId(){const e=this._unstablePool.pop();if(void 0!==e)return new r.ElementId(e)}genStableId(){const e=++this._currentStableIndex;return s.DebugWarn.assert(e<i.MAX_UNSTABLE_OFFSET,"stable id资源已耗尽"," ","2020-08-03"),new r.ElementId(e)}clearStableId(e){this._currentStableIndex=e}isStableId(e){return e<i.MAX_UNSTABLE_OFFSET}}t.IDPool=i,i.MAX_TMP_NUM=1e3,i.MAX_TMP_OFFSET=Math.pow(2,32)-i.MAX_TMP_NUM,i.MAX_UNSTABLE_NUM=1e6,i.MAX_UNSTABLE_OFFSET=Math.pow(2,32)-i.MAX_UNSTABLE_NUM-i.MAX_TMP_NUM},46804:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JsonUtil=void 0;const r=n(75733);class s{static pack(e){const t=r.pack(e);let n=e;"object"==typeof e&&(n=JSON.stringify(e));const s=n.length;let i=t.length/s*100;return i=Number(i.toFixed(2)),t}static unpack(e){return e.startsWith("{")||e.startsWith("[")?JSON.parse(e):r.unpack(e)}static parse(e){let t={};try{t=s.unpack(e)}catch(n){try{t=JSON.parse(e)}catch(e){return t}}return t}static stringify(e){let t="";try{t=JSON.stringify(e)}catch(e){return t}return t}}t.JsonUtil=s},73872:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.CtrlPoint=t.EN_CTRLPOINT_STYLE=void 0;const i=n(98106),o=n(61962),a=n(95829),c=n(98381),l=n(56327),d=n(39836),u=n(45712);var h;!function(e){e[e.INTERACTIVE=0]="INTERACTIVE",e[e.NORMAL=1]="NORMAL"}(h=t.EN_CTRLPOINT_STYLE||(t.EN_CTRLPOINT_STYLE={}));let g=r=class extends l.AuxElement{constructor(){super(...arguments),this._pointStyle=h.NORMAL}get category(){return d.categoryCtrlPoint}canBeMoved(){return!0}ctrlPtInit(e,t,n){return this.masterId=e,this._worldPos=t,n&&(this._snapAxis=n.normalize()),this.updateGRep(),this}get pointStyle(){return this._pointStyle}set pointStyle(e){this._pointStyle=e,this.updateGRep()}get worldPos(){return this._worldPos}set worldPos(e){this._worldPos=e,this.updateGRep()}getSnapAxis(){return this._snapAxis}bindTranslation(e){this._translationHandler=e}bindClick(e){this._clickHandler=e}performTranslate(e,t){let n=t;if(this._snapAxis){const e=this._snapAxis.clone().dot(t);n=this._snapAxis.clone().multiplied(e)}return this.worldPos=e.clone().add(n),this.updateGRep(),!0}translate(e){return!!this._translationHandler&&(this._translationHandler(this,this.worldPos,new i.Vector3(e)),!0)}confirmTranslate(e,t){this._translationHandler&&this._translationHandler(this,e,t)}collectCalculators(){return[]}confirmClick(){this._clickHandler&&this._clickHandler(this)}getMaster(){const e=this.getDoc().getElementById(this.masterId);return a.DebugWarn.assert(e,"ctrl point must have valid master","",""),e}createGRep(){return this.pointStyle===h.INTERACTIVE?this.createInteractiveGRep():this.createNormalGRep()}updateGRep(){this.setGRep(this.createGRep())}createNormalGRep(){const e=new c.GRep;e.canPick=!0;const t=e.addPoint3d(this.worldPos.clone());return t.setStyle({point:{color:17596,size:18}}),t.id=r.gpointID,e.elementId=this.id,e}createInteractiveGRep(){const e=new c.GRep;e.canPick=!0;const t=e.addPoint3d(this.worldPos.clone());return t.setStyle({point:{color:16777215,size:18}}),t.id=r.gpointID,e.elementId=this.id,e}};g.gpointID=10,g=r=s([u.elementMeta("CtrlPoint",o.DBElement,!1)],g),t.CtrlPoint=g},98255:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.Dimension=void 0;const s=n(98106),i=n(61962),o=n(56327),a=n(78568),c=n(55301),l=n(45712);let d=class extends o.AuxElement{dimensionInit(e,t,n,r){return this.masterId=r,this._firstPt=e,this._secondPt=t,this._direction=n,this.updateGRep(),this}canBeMoved(){return!1}updateGRep(){this.setGRep(this.createGRep3d())}createGRep3d(){const e=this.getLinearMeasure().getGRep();return e.canPick=!0,e.canSnap=!1,e}getInputParams(){return{position:this.getLinearMeasure().getTextPosition(),value:this._firstPt.distanceTo(this._secondPt)}}get category(){return c.categoryDimension}getLinearMeasure(){let e=this._secondPt.clone().subtracted(this._firstPt);e.equals(s.Vector3.O())&&(e=s.Vector3.Y());const t=this._direction.clone().cross(e),n=new s.Plane(this._firstPt,t);return new a.LinearMeasureSystem(n,this._firstPt,this._secondPt,!0)}};d=r([l.elementMeta("Dimension",i.DBElement,!1)],d),t.Dimension=d},56327:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AuxElement=void 0;const r=n(95829),s=n(6218);class i extends s.Element{auxElementInit(e){this.masterId=e}isTemporary(){return!0}get masterId(){return this._masterId}set masterId(e){this._masterId=e;const t=this.getDoc().getElementById(this._masterId);r.DebugWarn.assert(t,"master为空?","","")}reportDependency(){const e=[];return this.masterId.isValid()&&e.push(this.masterId),[e,[]]}}t.AuxElement=i},78568:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AngleMeasureSystem=t.LinearMeasureSystem=t.MeasureSystem=void 0;const r=n(98106),s=n(98381),i=n(98193),o=n(25617);t.MeasureSystem=class{};t.LinearMeasureSystem=class{constructor(e,t,n,r){this._distance=0,this._showText=!1,this._showText=r,this.set(e,t,n)}category(){return o.categoryLinearSystem}set plane(e){this._plane=e,this._update()}set firstPt(e){this._firstPt=e,this._update()}get firstPt(){return this._firstPt}set secondPt(e){this._secondPt=e,this._update()}get secondPt(){return this._secondPt}set(e,t,n){this._plane=e,this._firstPt=t,this._secondPt=n,this._update()}getTextPosition(){return this._textPosition}getMeasuredDistance(){return this._distance}getGRep(){const e=this._getParallelLine(),t=new s.GRep;if(!e)return t;const n=e.getStartPt(),i=e.getEndPt();t.addCurve3d(new r.Line3d(this._firstPt,n)),t.addCurve3d(e),t.addCurve3d(new r.Line3d(i,this._secondPt));const o=this._direction.clone().cross(i.clone().subtracted(n)).normalize();if(t.addCurve3d(l(n,this._direction,o)),t.addCurve3d(l(i,this._direction,o)),this._textPosition=e.getMidPt(),this._showText){const n=(1e3*this._distance).toFixed(0),r=this.drawText(n,e.getMidPt());t.addNode(r)}return t}drawText(e,t){const n=new i.GText3d(e);return n.setStyle({text:{size:.24}}),n.position=t,n}_update(){const e=this._secondPt.clone().subtracted(this._firstPt),t=this._plane.getNorm();if(this._direction=t.cross(e),this._secondPt.equals(this._firstPt))this._textPosition=this._firstPt;else{const e=this._getParallelLine();this._textPosition=e.getMidPt()}this._distance=this._firstPt.distanceTo(this._secondPt)}_getParallelLine(){const e=new r.Line3d(this._firstPt,this._direction,[0,a]),t=new r.Line3d(this._secondPt,this._direction,[0,a]),n=e.getEndPt(),s=t.getEndPt();if(!n.equals(s))return new r.Line3d(n,s)}};t.AngleMeasureSystem=class{constructor(e,t,n,r){this._firstDirection=e,this._secondDirection=t,this._originPoint=n,this._len=3,this._textPosition=n,this._plane=r.clone();const s=this._plane.getCoord();s.setOrigin(n),this._plane.setCoord(s),this._coord=s,this._angle=0,this._update()}set firstDirection(e){this._firstDirection=e,this._update()}set secondDirection(e){this._secondDirection=e,this._update()}set originPoint(e){this._originPoint=e.clone(),this._update()}set len(e){this._len=e,this._update()}getGRep(){const e=new s.GRep,t=this._line1.getEndPt(),n=this._line2.getEndPt(),r=180*this._angle/Math.PI;!t.equals(n)&&this._arc?this._textPosition=this._arc.getMidPt():this._textPosition=this._originPoint;const o=new i.GText3d(r.toPrecision(3));o.position=this._textPosition,o.setStyle({text:{size:16}}),e.addNode(o);const a=this._plane.getNorm();return e.addCurve3d(this._line1),e.addCurve3d(this._line2),this._arc&&e.addCurve3d(this._arc),e.addCurve3d(l(t,this._firstDirection,a)),e.addCurve3d(l(n,this._firstDirection,a)),e}_update(){this._line1=new r.Line3d(this._originPoint,this._firstDirection,[0,this._len]),this._line2=new r.Line3d(this._originPoint,this._secondDirection,[0,this._len]);const e=r.MathAlg.CalculateProject.curve3dToPlane(this._line1,this._plane),t=r.MathAlg.CalculateProject.curve3dToPlane(this._line2,this._plane);if(e instanceof r.Line2d&&t instanceof r.Line2d){const n=r.Vector2.X().angleTo(e.getDirection()),s=r.Vector2.X().angleTo(t.getDirection());this._angle=Math.abs(s-n);let i=!0;this._angle>Math.PI&&(i=!1,this._angle=2*Math.PI-this._angle);const o=r.Arc2d.makeArcByStartEndAngles(this._plane.getUVAt(this._originPoint),this._len,n,this._angle,i);this._arc=r.Arc3d.makeArcByThreePoints(this._coord.getWorldPtAt(o.getStartPt()),this._coord.getWorldPtAt(o.getMidPt()),this._coord.getWorldPtAt(o.getEndPt()))}}};const a=1,c=.075;function l(e,t,n){const s=c/2,i=t.clone().rotate(e,n,r.CONST.PI_4),o=new r.Line3d(e,i);return o.setRange(-s,s),o}},96080:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Category=t.categoryMapping=void 0;const r=n(22530),s=n(59853);t.categoryMapping=new Map;t.Category=class{constructor(e=s.EN_CATEGORY_IDS.INVALID){this.id=e,this._defaultStyle={},t.categoryMapping.set(e,this)}setStyle(e={}){Object.assign(this._defaultStyle,e)}getStyle(){return this._defaultStyle}getRenderArea(){return r.EN_RENDER_AREA.MODEL}}},39836:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryCtrlPoint=t.CategoryCtrlPoint=void 0;const r=n(22530),s=n(96080);class i extends s.Category{constructor(){super(...arguments),this._defaultStyle={point:{size:10,color:170}}}getRenderArea(){return r.EN_RENDER_AREA.OVERLAY}}t.CategoryCtrlPoint=i,t.categoryCtrlPoint=new i},55301:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryDimension=t.CategoryDimension=void 0;const r=n(22530),s=n(96080);class i extends s.Category{constructor(){super(...arguments),this._defaultStyle={line:{width:1,color:8167935}}}getRenderArea(){return r.EN_RENDER_AREA.OVERLAY}}t.CategoryDimension=i,t.categoryDimension=new i},32730:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryForm=t.CategoryForm=void 0;const r=n(96080);class s extends r.Category{constructor(){super(...arguments),this._defaultStyle={line:{width:2,color:0},face:{color:16777215}}}}t.CategoryForm=s,t.categoryForm=new s},59853:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_CATEGORY_IDS=void 0,function(e){e.INVALID="invalid",e.MODEL_LINE="MODEL_LINE",e.INSTANCE="INSTANCE",e.TMP="TMP",e.WORK_PLANE_UE="work_plane_ue",e.USER_DATA_UE="user_dta_ue",e.MODEL_VIEW="model_view",e.UNIQUE_ELEMENT="unique_element"}(t.EN_CATEGORY_IDS||(t.EN_CATEGORY_IDS={}))},59660:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryInvalid=void 0;const r=n(96080),s=n(59853);class i extends r.Category{constructor(){super(s.EN_CATEGORY_IDS.INVALID)}}t.categoryInvalid=new i},25617:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryLinearSystem=t.CategoryLinearSystem=void 0;const r=n(22530),s=n(96080);class i extends s.Category{getRenderArea(){return r.EN_RENDER_AREA.OVERLAY}}t.CategoryLinearSystem=i,t.categoryLinearSystem=new i},12475:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryModelLine=void 0;const r=n(22530),s=n(96080),i=n(59853);class o extends s.Category{constructor(){super(i.EN_CATEGORY_IDS.MODEL_LINE),this._defaultStyle={line:{width:2,color:16711935}}}getRenderArea(){return r.EN_RENDER_AREA.OVERLAY}}t.categoryModelLine=new o},13524:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryModelView=void 0;const r=n(22530),s=n(96080),i=n(59853);class o extends s.Category{constructor(){super(i.EN_CATEGORY_IDS.MODEL_VIEW)}getRenderArea(){return r.EN_RENDER_AREA.OVERLAY}}t.categoryModelView=new o},60472:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryTmpElement=void 0;const r=n(22530),s=n(96080),i=n(59853);class o extends s.Category{constructor(){super(i.EN_CATEGORY_IDS.TMP)}getRenderArea(){return r.EN_RENDER_AREA.OVERLAY}}t.categoryTmpElement=new o},23614:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryUniqueElement=t.CategoryUniqueElement=void 0;const r=n(96080),s=n(59853);class i extends r.Category{constructor(e){super(e||s.EN_CATEGORY_IDS.UNIQUE_ELEMENT)}}t.CategoryUniqueElement=i,t.categoryUniqueElement=new i},5951:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryDataStoreElement=t.CategoryDataStoreElement=void 0;const r=n(59853),s=n(23614);class i extends s.CategoryUniqueElement{constructor(){super(r.EN_CATEGORY_IDS.USER_DATA_UE)}}t.CategoryDataStoreElement=i,t.categoryDataStoreElement=new i},8217:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.DataStoreElement=void 0;const i=n(5951),o=n(1207),a=n(6218),c=n(45712);let l=r=class extends a.Element{static getDataStoreElementByUUID(e,t){return e.getAllElementsByCtor(r).find((e=>e.getUUID()===t))}get category(){return i.categoryDataStoreElement}init(e){return this._db.uuid=e,this}getUUID(){return this._db.uuid}shouldShowInViewStatic(){return!1}shouldShowInPropertyGraphStatic(){return!1}};l=r=s([c.elementMeta("ebf13c03-8379-49ca-9179-c18e9754ebd1",o.DBDataStoreElement,!0)],l),t.DataStoreElement=l},1207:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBDataStoreElement=void 0;const r=n(61962);class s extends r.DBElement{constructor(){super(...arguments),this.uuid=""}}t.DBDataStoreElement=s},64282:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ElementCustomizedBase=void 0;const r=n(95829),s=n(98381),i=n(59660);t.ElementCustomizedBase=class{init(e,t){return this._doc=e,this._hostElementId=t,this}regenerateGRep(){return s.GRep.empty}getGNodesWhenSelected(){return[]}getHostElement(){const e=this._doc.getElementById(this._hostElementId);return r.DebugWarn.assert(e,"ele为空"," ","2020-11-04"),e}get category(){return i.categoryInvalid}}},48451:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryGrepKeepElementInstance=t.CategoryGrepKeepElement=void 0;const r=n(96080);class s extends r.Category{}t.CategoryGrepKeepElement=s,t.categoryGrepKeepElementInstance=new s},30191:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.GrepKeepElement=void 0;const s=n(61962),i=n(45712),o=n(48451),a=n(6218);let c=class extends a.Element{constructor(){super(...arguments),this._canBeDelete=!1,this._canBeCopied=!1,this._canBeMoved=!1,this._canBeRotated=!1}init(e){return e&&(this._customized=e,this._customized.init(this.getDoc(),this.id)),this}get category(){return o.categoryGrepKeepElementInstance}canBeMoved(){return this._canBeMoved}setCanBeMoved(e){this._canBeMoved=e}canBeRotated(){return this._canBeRotated}setCanBeRotated(e){this._canBeRotated=e}canBeDeleted(){return this._canBeDelete}setCanDeleted(e){this._canBeDelete=e}canBeCopied(){return this._canBeCopied}setCanBeCopied(e){this._canBeCopied=e}getCustomized(){return this._customized}getGNodesWhenSelected(){const e=[];return this._customized?(e.push(...this._customized.getGNodesWhenSelected()),e):(e.push(...super.getGNodesWhenSelected()),e)}};c=r([i.elementMeta("GrepKeepElement",s.DBElement,!1)],c),t.GrepKeepElement=c},45975:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TransformedGRepCalculator=void 0;const r=n(79500),s=n(24611),i=n(84983),o=n(98381),a=n(95031),c=n(55252);class l extends r.BaseCalculator{getOutputProperty(){return a.keyOf("CALC_GRep")}getInputPropertyIds(){return[this._db.genPropertyId("translateX"),this._db.genPropertyId("translateY"),this._db.genPropertyId("translateZ"),this._db.genPropertyId("rotateX"),this._db.genPropertyId("rotateY"),this._db.genPropertyId("rotateZ"),this._db.genPropertyId("materialId"),this._db.genPropertyId("textureRotation"),this._db.genPropertyId("textureTileSizeX"),this._db.genPropertyId("textureTileSizeY"),this._db.genPropertyId("textureOffsetX"),this._db.genPropertyId("textureOffsetY"),this._db.genPropertyId("CALC_originalGRep")]}execute(){const e=this._db.getDoc().getElementById(this._db.id),t=e.getTransformMatrix(),n=this._getStyle(),r=new o.GRep,s=i.GRepRef.create(e.getOriginalGRep(),e.id,{matrix:t,overriddenStyle:n});return r.addNode(s),this._db.CALC_GRep=r,!0}_getStyle(){if(!this._db.materialId)return;const e=void 0;if(!e)return;const t=e.getJsonData("textureUrl"),n=e.getJsonData("tileSize"),r=this._db.textureTileSizeX||n.x,s=this._db.textureTileSizeY||n.y;return{face:{color:16777215,texture:t,rotation:this._db.textureRotation,tileSizeX:r,tileSizeY:s,offsetX:this._db.textureOffsetX,offsetY:this._db.textureOffsetY}}}}t.TransformedGRepCalculator=l,s.CalculatorMgr.getInstance().registerElementCalculator(c.TransformableElement,new l)},11706:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBTransformableElement=void 0;const r=n(61962),s=n(98381),i=n(51923);class o extends r.DBElement{constructor(){super(...arguments),this.CALC_originalGRep=s.GRep.empty,this.translateX=0,this.translateY=0,this.translateZ=0,this.rotateX=0,this.rotateY=0,this.rotateZ=0,this.materialId="",this.textureRotation=0,this.paveMethod=i.ENUM_PAVE_METHOD.REPEAT,this.textureTileSizeX=0,this.textureTileSizeY=0,this.textureOffsetX=0,this.textureOffsetY=0,this.INVISIBLE_condition=!1}}t.DBTransformableElement=o},99091:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_TRANSFORM_TYPE=void 0,function(e){e.TRANSLATE_X="translateX",e.TRANSLATE_Y="translateY",e.TRANSLATE_Z="translateZ",e.ROTATE_X="rotateX",e.ROTATE_Y="rotateY",e.ROTATE_Z="rotateZ"}(t.EN_TRANSFORM_TYPE||(t.EN_TRANSFORM_TYPE={}))},55252:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.TransformableElement=void 0;const s=n(98106),i=n(99091),o=n(11706),a=n(45712),c=n(95829),l=n(6218);let d=class extends l.Element{getPaveMethod(){return this._db.paveMethod}getOriginalGRep(){return this._db.CALC_originalGRep}getTransformParam(e){const t=this.db[e];return c.DebugWarn.assert(void 0!==t,"未支持的类型"," ","2020-05-19"),t}getPosition(){return new s.Vector3(this._db.translateX,this._db.translateY,this._db.translateZ)}getRotation(){return new s.Vector3(this._db.rotateX,this._db.rotateY,this._db.rotateZ)}setTransformParam(e,t){this.getTransformParam(e),this.db[e]=t}getTransformMatrix(){return s.Matrix4.makeRotateX(s.MathUtil.degreeToRadius(this._db.rotateX)).applyRotate(new s.Vector3,s.Vector3.Y(),s.MathUtil.degreeToRadius(this._db.rotateY)).applyRotate(new s.Vector3,s.Vector3.Z(),s.MathUtil.degreeToRadius(this._db.rotateZ)).applyTranslate({x:this._db.translateX,y:this._db.translateY,z:this._db.translateZ})}translate(e){return this.setTransformParam(i.EN_TRANSFORM_TYPE.TRANSLATE_X,e.x+this.getTransformParam(i.EN_TRANSFORM_TYPE.TRANSLATE_X)),this.setTransformParam(i.EN_TRANSFORM_TYPE.TRANSLATE_Y,e.y+this.getTransformParam(i.EN_TRANSFORM_TYPE.TRANSLATE_Y)),this.setTransformParam(i.EN_TRANSFORM_TYPE.TRANSLATE_Z,e.z+this.getTransformParam(i.EN_TRANSFORM_TYPE.TRANSLATE_Z)),!0}get invisiableCondition(){return this._db.INVISIBLE_condition}};d=r([a.elementMeta("TransformableElement",o.DBTransformableElement)],d),t.TransformableElement=d},25384:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryWorkPlaneUE=t.CategoryWorkPlaneUE=void 0;const r=n(59853),s=n(23614);class i extends s.CategoryUniqueElement{constructor(){super(r.EN_CATEGORY_IDS.WORK_PLANE_UE)}}t.CategoryWorkPlaneUE=i,t.categoryWorkPlaneUE=new i},90701:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkPlaneUE=void 0;const i=n(61962),o=n(98381),a=n(47475),c=n(45712),l=n(25981),d=n(25384);let u=class extends l.UniqueElement{constructor(){super(),this._workPlane=new a.WorkPlane}isTemporary(){return!0}setWorkPlane(e){this._workPlane=e,this.updateGRep()}getWorkPlane(){return this._workPlane}getText(){return this._workPlane.name}setText(e){this._workPlane.name=e,this.updateGRep()}updateGRep(){this.setGRep(this.createGRep3d())}shouldShowInPropertyGraphStatic(){return!1}createGRep3d(){const e=new o.GRep;return e.canGpuPick=!1,e.canSnap=!1,e}get category(){return d.categoryWorkPlaneUE}};u=r([c.elementMeta("WorkPlaneUE",i.DBElement,!1),s("design:paramtypes",[])],u),t.WorkPlaneUE=u},6218:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Element=void 0;const s=n(98106),i=n(61962),o=n(95829),a=n(59660),c=n(48399),l=n(63912),d=n(55083),u=n(38675),h=n(24611),g=n(98381),f=n(34558),p=n(56943);class _{constructor(){o.DebugWarn.assert(c.__CAN_CREATE.canCreate,`请使用pm.app.document.create(${this.constructor.name}).init()创建Element`," ","2020-04-13"),this.__createElementDB?this._db=this.newEmptyDB():this._db=new i.DBElement,this._db.commit()}get db(){return this._db}getDoc(){return this._db.getDoc()}get category(){return a.categoryInvalid}get id(){return this._db.id}set id(e){this._db.id=e}get name(){return this._db.name}set name(e){this._db.name=e}get visible(){return this._db.visible}set visible(e){this._db.visible=e}get internalVisible(){return this._db.internalVisible}set internalVisible(e){this._db.internalVisible=e}set invalidInfo(e){this._db.invalidInfo=e}get invalidInfo(){return this._db.invalidInfo}isElementVisible(e){return void 0!==e?!this._db.CALC_INVISIBLE.has(e):this.visible&&this.internalVisible&&0===this._db.CALC_INVISIBLE.size}isElementCustomizedVisible(e){return void 0!==e?!this._db.CALC_INVISIBLE.has(e):0===this._db.CALC_INVISIBLE.size}setCustomizedVisible(e,t){if(t){if(this.db.CALC_INVISIBLE.has(e)){const t=new Set(this.db.CALC_INVISIBLE);t.delete(e),this._db.CALC_INVISIBLE=t}}else if(!this.db.CALC_INVISIBLE.has(e)){const t=new Set(this.db.CALC_INVISIBLE);t.add(e),this._db.CALC_INVISIBLE=t}}isTemporary(){return!1}isVisibleAsInstance(){return!0}asyncOnLoad(){return r(this,void 0,void 0,(function*(){this.onLoad()}))}getGNodesWhenSelected(){const e=[],t=this.getGRep();return null==t||t.traverse((t=>{let n,r=t;t.getType()===u.GNODE_TYPE.GNodeRef&&(r=t.getOriginGNode(),n=t.getMatrix());const s=[];if(r.getType()===u.GNODE_TYPE.GCurve3d)s.push(r.geo);else if(r.getType()===u.GNODE_TYPE.GEdge)s.push(r.geo.getCurve());else if(r.getType()===u.GNODE_TYPE.GCurves)s.push(...r.geo);else if(r.getType()===u.GNODE_TYPE.GSurface){r.geo.getLoops().forEach((e=>e.forEach((e=>s.push(e)))))}n?s.forEach((t=>e.push(t.transformed(n)))):e.push(...s)})),[new f.GCurves(e)]}getGNodesWhenActive(){return this.getGNodesWhenSelected()}onLoad(){}newEmptyDB(){const e=this.__createElementDB();return e.commit(),e}registerCalculator(...e){if(!e.length)return!1;let t;return t=this._db.CALC_RegisteredCalculators?new Map(this._db.CALC_RegisteredCalculators.entries()):new Map,e.forEach((e=>t.set(e.getOutputProperty(),e))),this._db.CALC_RegisteredCalculators=t,!0}getRegisteredCalculator(e){var t;return null===(t=this._db.CALC_RegisteredCalculators)||void 0===t?void 0:t.get(e)}unRegisterCalculator(e){if(!this._db.CALC_RegisteredCalculators)return!0;const t=new Map(this._db.CALC_RegisteredCalculators);return t.delete(e),this._db.CALC_RegisteredCalculators=t,!0}getCalculatorInstances(){const e=this._collectClassCalculators(),t=new Map,n=e.map((e=>e.clone()));this._db.CALC_RegisteredCalculators&&n.push(...this._db.CALC_RegisteredCalculators.values());for(const e of n)e.init(this.db),t.set(e.getOutputProperty(),e);return[...t.values()]}markDirty(){const e=this._db.dump();this._db.load(e)}markGRepDirty(){this._db.CALC_GRep=new g.GRep}shouldShowInViewStatic(){return!0}shouldShowInPropertyGraphStatic(){return!0}shouldShowInDeletionGraphStatic(){return!1}shouldSave(){var e;return!this.isTemporary()&&!!(null===(e=this.constructor._meta_)||void 0===e?void 0:e.save)}reportDependency(){return[void 0,void 0]}updateForWeakParentDeletion(e){}getGRep(){const e=this.db.CALC_GRep;if(!e.elementId){e.elementId=this.id,e.doc=this.getDoc(),e.category=this.category;const t=e.getStyle();e.setStyle(this.category.getStyle()),e.setStyle(t)}return e}setGRep(e){return e.elementId=this.id,e.doc=this.getDoc(),e.category=this.category,e.isEmpty()||e.setStyle(this.category.getStyle()),this.db.CALC_GRep===e&&e.clearRenderNode(),this.db.CALC_GRep=e,this.db.CALC_GRep.category=this.category,!0}canBeMoved(){return!1}canBeRotated(){return!1}translate(e){return!1}transform(e){return!1}rotate(e,t,n){const r=s.Matrix4.makeRotate(e,t,n);return this.transform(r)}canBeDeleted(){return!0}canBeCopied(){return!0}clone(){if(o.DebugWarn.assert(this.canBeCopied(),"此对象不能被拷贝！"," ","2020-04-23"),!this.canBeCopied())return this;const e=this.getDoc().create(this.constructor);l.eventManager.dispatchEvent(new l.ElementEvent(d.EN_EVENT_TYPE.ELEMENT_CLONE,[{element:e,srcElement:this}]));const t=this._db.dumpWithCache(),n=this.reportAttributesToIgnoreOnCopy();o.DebugWarn.assert(n.has(_._reportCopyFunctionCalledSymbol),"reportRelatedElementsToIgnore中未调用父类此方法！"," ","2020-04-23"),n.delete(_._reportCopyFunctionCalledSymbol);for(const e of n)o.DebugWarn.assert(t[e],"Element不存在此属性"," ","2020-04-23"),delete t[e];return e.db.load(t),e}reportAttributesToIgnoreOnCopy(){const e=new Set;return e.add(_._reportCopyFunctionCalledSymbol),e.add("id"),e}getCachedData(){return this._db.CALC_CachedData}setCachedData(e){this._db.CALC_CachedData=e}getSerialId(){return p.getElementSerialId(this.constructor)}_collectClassCalculators(){const e=[];let t=this.__proto__;for(;e.push(t.constructor),t.constructor!==_;)t=t.__proto__;e.reverse();const n=new Map;for(const t of e){const e=h.CalculatorMgr.getInstance().collectCalculators(t);if(e)for(const[t,r]of e)n.set(t,r)}return[...n.values()]}}t.Element=_,_._reportCopyFunctionCalledSymbol=Symbol("reportCopyFunctionCalledSymbol"),_._meta_={ctor:""}},18064:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ElementId=void 0;class n{constructor(e){this._id=-1,this._id=e}static get INVALID(){return new n(-1)}asInt(){return this._id}equals(e){return!!e&&this._id===e.asInt()}isValid(){return this._id&&this._id>-1}toString(){return""+this._id}dump(){return{id:this._id}}load(e){this._id=e.id}}t.ElementId=n},45712:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.elementMeta=t.elementClassNameToCtorMap=void 0;const r=n(95829),s=n(55083),i=n(62735);t.elementClassNameToCtorMap=new Map,t.elementMeta=function(e,n,o=!0){return t.elementClassNameToCtorMap.has(e)||function(e){const t=new e;Object.keys(t).filter((e=>!e.startsWith("_"))).forEach((t=>{Object.defineProperty(e.prototype,t,{set(e){const n=this._doc;if(this.id&&this.id.isValid()){const e=n.getElementById(this.id);e&&(e.isTemporary()||(n.checkIfCanModifyDoc(),n.transactionMgr.getTransactionCache().onElementsUpdated([e])),i.shouldCacheToView(e,t)&&n.cacheForView.cacheElementChanged(s.EN_EVENT_TYPE.ELEMENT_DID_UPDATE,[e]))}this._cachedNewData[t]=e},get(){return void 0!==this._cachedNewData[t]?this._cachedNewData[t]:this._db[t]}})}))}(n),s=>{t.elementClassNameToCtorMap.has(e)||(r.DebugWarn.assert(!t.elementClassNameToCtorMap.has(e),`${e} already registered`," ","2020-06-01"),s.prototype.__createElementDB=()=>new n,t.elementClassNameToCtorMap.set(e,s),s._meta_={save:o,ctor:e})}}},12918:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InstanceGRepCalculator=void 0;const r=n(50548),s=n(90712),i=n(79500),o=n(95829),a=n(98381),c=n(95031),l=n(37509),d=n(24611);class u extends i.BaseCalculator{getOutputProperty(){return c.keyOf("CALC_originalGRep")}getInputPropertyIds(){return[this._db.genPropertyId("paramIdToStatement")]}execute(){const e=this._db.getDoc().getElementById(this._db.id),t=l.UniqueElementUtil.getOrCreateUniqueElement(this._db.getDoc(),s.FamilyService);o.DebugWarn.assert(t,"familyService不应该为空"," ","2020-05-11"),e.updateInstanceDoc();const n=t.getInstanceGRep(e.getUuidOrSeekId(),`${e.id}`);return this._db.CALC_originalGRep=n||new a.GRep,!0}}t.InstanceGRepCalculator=u,d.CalculatorMgr.getInstance().registerElementCalculator(r.Instance,new u)},8521:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryInstance=t.CategoryInstance=void 0;const r=n(96080),s=n(59853);class i extends r.Category{constructor(){super(s.EN_CATEGORY_IDS.INSTANCE),this.defaultStyle={line:{width:2,color:0},face:{color:16711935,texture:""}}}}t.CategoryInstance=i,t.categoryInstance=new i},3109:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBFamilyService=void 0;const r=n(61962);class s extends r.DBElement{constructor(){super(...arguments),this.nestedDocUUIDToDocFiles=new Map([["",""]]),this.CALC_Cache=new Map}}t.DBFamilyService=s},35356:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBInstance=void 0;const r=n(11706);class s extends r.DBTransformableElement{constructor(){super(...arguments),this.paramIdToStatement=new Map([["",""]]),this.familyDocUUID="",this.seekId="",this.version=0}}t.DBInstance=s},90712:function(e,t,n){"use strict";var r,s=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.FamilyService=void 0;const i=n(95829),o=n(64323),a=n(62891),c=n(15119),l=n(98381),d=n(84983),u=n(41207),h=n(45712),g=n(25981),f=n(3109);let p=r=class extends g.UniqueElement{hasFile({seekId:e,uuid:t}){return this._db.nestedDocUUIDToDocFiles.has(e)||this._db.nestedDocUUIDToDocFiles.has(t)}addFamilyFile(e,t){const n=c.FileUtil.parse(e);if(!n||!n.docUUID)return;const r=new Map;for(const[e,t]of this._db.nestedDocUUIDToDocFiles)e&&r.set(e,t);return r.set(t||n.docUUID,JSON.stringify(n)),this._db.nestedDocUUIDToDocFiles=r,n.docUUID}deleteFamilyFile({seekId:e,uuid:t}){return this._db.nestedDocUUIDToDocFiles=new Map(this._db.nestedDocUUIDToDocFiles),this._db.nestedDocUUIDToDocFiles.delete(e)||this._db.nestedDocUUIDToDocFiles.delete(t)}getDocFile(e){const t=this._db.nestedDocUUIDToDocFiles.get(e);if(t)return c.FileUtil.parse(t)}modifyInstanceDoc(e,t,n){const r=e.seekId,s=e.uuid;let i=this._db.CALC_Cache.get(`${r||s}.${t}`);if(!i){const e=this._db.nestedDocUUIDToDocFiles.get(r||s),n=c.FileUtil.parse(e);if(!n)return!1;i=new o.TDocument("l",1,s),new a.DocSaver(i).syncLoad(n),this._db.CALC_Cache.set(`${r||s}.${t}`,i)}if(!i)return!1;if(!(null==n?void 0:n.size))return!0;const l=new Set([...n.keys()]);return u.syncTransact(i,"更新族文档变量",(()=>{const e=i.filterElements((e=>"VariableElement"===e.getSerialId()&&("SYSTEM_VARIABLE"===e.variableType||"CUSTOM_VAIABLE"===e.variableType)&&l.has(e.name)));n.forEach(((t,n)=>{const r=e.find((e=>e.name===n));if(!r)return;if(void 0===t||t===r.statementValue)return;const s="number"==typeof t?t.toFixed(8):`${t}`;r.edit({expression:s})}))})),!0}getInstanceDoc(e,t){return this._db.CALC_Cache.get(`${e.seekId||e.uuid}.${t}`)}getInstanceGRep(e,t){const n=this.getInstanceDoc(e,t);if(!n)return;const r=n.filterElements((e=>!e.isTemporary()&&e.isVisibleAsInstance()&&e.shouldShowInViewStatic()&&e.isElementVisible()&&e.getGRep().children.length>0&&(void 0===e.db.INVISIBLE_condition||!e.db.INVISIBLE_condition))),s=new l.GRep;for(const e of r){const t=e.getGRep();t.isEmpty()||s.addNode(d.GRepRef.create(t,e.id))}return s}getDocParamIdToStatement(e,t){const n=this.getInstanceDoc(e,t);i.DebugWarn.assert(n,"familyDoc为空!"," ","2020-05-13");const r=new Map,s=n.filterElements((e=>e.expressionStatement));for(const e of s)"MIDDLE_VARIABLE"!==e.variableType&&"MESURE_VARIABLE"!==e.variableType&&r.set(e.name,e.statementValue);return r}static setCachedElementDataFunc(e){this._cachedElementDataFunc=e}static callCachedElementDataFunc(e,t){r._cachedElementDataFunc&&r._cachedElementDataFunc(e,t)}};p=r=s([h.elementMeta("FamilyService",f.DBFamilyService)],p),t.FamilyService=p},50548:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.Instance=void 0;const s=n(90712),i=n(35356),o=n(8521),a=n(95829),c=n(55252),l=n(99091),d=n(45712),u=n(37509);let h=class extends c.TransformableElement{instanceInit(e){return e.uuid&&(this._db.familyDocUUID=e.uuid),e.seekId&&(this._db.seekId=e.seekId),this._db.version=1,this}getUUID(){return this._db.familyDocUUID}setSeekId(e){this._db.seekId=e}getSeekId(){return this._db.seekId}getUuidOrSeekId(){return this._db.seekId?{seekId:this._db.seekId}:{uuid:this._db.familyDocUUID}}updateInstanceDoc(){return this._getFamilyService().modifyInstanceDoc(this.getUuidOrSeekId(),`${this.id}`,this._db.paramIdToStatement)}getInstanceDoc(){return this._getFamilyService().getInstanceDoc(this.getUuidOrSeekId(),`${this.id}`)}getDependentSeekIds(){if(this._db.materialId)return[this._db.materialId]}getSubpartSeekIds(){return this._db.seekId?[this._db.seekId]:void 0}get category(){return o.categoryInstance}getParameterInfoByName(e){const t=this.getInstanceDoc();a.DebugWarn.assert(t,"famDoc为空!"," ","2020-05-13");const n=t.filterElements((t=>t.expressionStatement&&t.name===e))[0];return a.DebugWarn.assert(n,"ele为空!"," ","2020-05-13"),{name:n.name,friendlyName:n.friendlyName,expressionName:n.expressionName,valueType:n.valueType}}getParamIdToStatement(){const e=u.UniqueElementUtil.getOrCreateUniqueElement(this.getDoc(),s.FamilyService).getDocParamIdToStatement(this.getUuidOrSeekId(),`${this.id}`);for(const[t,n]of this._db.paramIdToStatement)""!==t&&e.set(t,n);return e}getDocFile(){return this._getFamilyService().getDocFile(this.getSeekId()||this.getUUID())}getInstanceParams(){const e={};for(const[t,n]of this._db.paramIdToStatement)""!==t&&(e[t]=n);return e}setParamStatementByName(e,t){if(this._db.paramIdToStatement.get(e)===t)return!1;a.DebugWarn.assert(e,"name无效"," ","2020-05-11");const n=new Map(this._db.paramIdToStatement.entries());return n.set(e,t),this._db.paramIdToStatement=n,!0}canBeMoved(){return!0}isToponameValid(){return!0}translate(e){const t=this.getGRep();return!(!this.canBeMoved()||!t)&&(this.setTransformParam(l.EN_TRANSFORM_TYPE.TRANSLATE_X,this.getTransformParam(l.EN_TRANSFORM_TYPE.TRANSLATE_X)+e.x),this.setTransformParam(l.EN_TRANSFORM_TYPE.TRANSLATE_Y,this.getTransformParam(l.EN_TRANSFORM_TYPE.TRANSLATE_Y)+e.y),this.setTransformParam(l.EN_TRANSFORM_TYPE.TRANSLATE_Z,this.getTransformParam(l.EN_TRANSFORM_TYPE.TRANSLATE_Z)+e.z),!0)}updateParamNameToStatement(){const e=u.UniqueElementUtil.getOrCreateUniqueElement(this.getDoc(),s.FamilyService).getDocParamIdToStatement(this.getUuidOrSeekId(),`${this.id}`),t=new Map(this._db.paramIdToStatement.entries());for(const[n]of t)e.has(n)||t.delete(n);this._db.paramIdToStatement=t}_getFamilyService(){const e=u.UniqueElementUtil.getOrCreateUniqueElement(this.getDoc(),s.FamilyService);return a.DebugWarn.assert(e,"fcc不应该为空"," ",""),e}};h=r([d.elementMeta("Instance",i.DBInstance)],h),t.Instance=h},96869:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getPmFileBySeekIdSync=t.getPmFileBySeekIdAsync=void 0;const s=n(15119);function i(e){const t=e.attributes.find((e=>"f2a3114e-400f-4fec-89d7-719e6a228da7"===e.id));return t?s.FileUtil.parse(t.free[0]):void 0}t.getPmFileBySeekIdAsync=function(e){return r(this,void 0,void 0,(function*(){const e={};if(!e)return;return i(e)}))},t.getPmFileBySeekIdSync=function(e){const t={};if(!t)return;return i(t)}},56943:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getElementSerialId=void 0,t.getElementSerialId=function(e){return e._meta_.ctor}},7055:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.castToIWithAuxiliaryElement=void 0,t.castToIWithAuxiliaryElement=function(e){const t=e;if(t&&t.createAuxElements&&t.clearAuxElements)return t}},69042:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.ModelView=void 0;const s=n(98106),i=n(57767),o=n(6218),a=n(98381),c=n(22530),l=n(13524),d=n(26874),u=n(45712),h=n(61962),g=n(34558),f=n(40260),p=n(38675);let _=class extends o.Element{constructor(){super(...arguments),this._idToGRepMap=new Map,this._renderDirty=!0,this._showGrid=!0,this._showAxis=!0,this._createModelViewGrepFunc=d.CreateModelViewGrep}isTemporary(){return!0}modelViewInit(e){return e&&(this._createModelViewGrepFunc=e),this.setGRep(this.createGRep()),this}get category(){return l.categoryModelView}getCameraInfo(){return this.iRender.getActiveCameraInfo()}onMount(){this.iRender.createScene(),this.generateAll(),this.iRender.updateView()}onUnMount(){this.iRender.clearScene(),this._idToGRepMap.clear()}getAllVisibleGReps(){return[...this._idToGRepMap.values()].filter((e=>void 0===e.grepRenderArea||e.grepRenderArea===c.EN_RENDER_AREA.MODEL))}generateAll(){this._idToGRepMap.clear(),this.iRender.clearScene();const e=this.getDoc();for(const t of e.filterElements()){if(!this._isElementValid(t))continue;const e=t.getGRep();e&&this._addGRep(e)}}shouldShowInPropertyGraphStatic(){return!1}createGRep(){const e=new a.GRep;return this._createModelViewGrepFunc(e,this._showGrid,this._showAxis),e}get showGrid(){return this._showGrid}set showGrid(e){this._showGrid!==e&&(this._showGrid=e,this.setGRep(this.createGRep()))}get showAxis(){return this._showAxis}set showAxis(e){this._showAxis!==e&&(this._showAxis=e,this.setGRep(this.createGRep()))}updateView(e=!1){if(e)return this.generateAll(),void this.iRender.updateView();this.getDoc().cacheForView.isChanged()&&(this._renderDirty=!1,this._updateElements(),this._updateSelection(),this._updateHighlight(),this._renderDirty&&this.iRender.updateView())}asString(){let e="";for(const[,t]of this._idToGRepMap)e+=`${t.asString()}\n`;return e}_updateElements(){const{container:e}=this.getDoc().cacheForView,t=e[i.EN_VIEW_CHANGED_CACHE_TYPE.ELEMENTS_ADDED].keys(),n=e[i.EN_VIEW_CHANGED_CACHE_TYPE.ELEMENTS_MODIFIED].keys(),r=e[i.EN_VIEW_CHANGED_CACHE_TYPE.ELEMENTS_DELETED].keys();for(const e of t){const t=this.getDoc().getElementById(e);if(!t)continue;const n=t.getGRep();n&&(this._isElementValid(t)&&this._addGRep(n))}for(const e of n){const t=this.getDoc().getElementById(e);if(!t)continue;const n=t.getGRep();this._isElementValid(t)?this._updateGRep(n):this._removeGRep(e)}for(const e of r)this._removeGRep(e)}_isElementValid(e){if(!e.shouldShowInViewStatic())return!1;const t=e.getGRep();return t&&!t.isEmpty()&&e.isElementVisible()}_updateSelection(){const{selection:e}=this.getDoc().cacheForView;if(!e)return;const t=e.getActiveElements(),n=e.getSelectedGNodes();this.iRender.clearSelection(),this._renderDirty=!0;const r=[],i=[],o=[],a=[];n.forEach((e=>{if(e.getType()===p.GNODE_TYPE.GEdge)r.push(e.geo.getCurve());else if(e.getType()===p.GNODE_TYPE.GCurve3d)r.push(e.geo);else if(e.getType()===p.GNODE_TYPE.GCurves)r.push(...e.geo);else if(e.getType()===p.GNODE_TYPE.GPoint3d)i.push(e.toRenderNode());else{const t=e.toRenderNodeForActive();t instanceof f.RenderMesh?o.push(t):t instanceof f.RenderEdge&&a.push(t)}}));const c=[];if(t.forEach((e=>{e.getGNodesWhenSelected().forEach((e=>{e instanceof f.RenderMesh?o.push(e):e instanceof g.GCurves?c.push(e):e instanceof f.RenderPoint&&i.push(e)}))})),c.forEach((e=>{e.drawOverlay?this.iRender.drawSelections(e):r.push(...e.geo)})),r.length){const e=new g.GCurves(r);this.iRender.drawSelections(e)}if(i.forEach((e=>this.iRender.drawSelections(e))),o.length&&this.iRender.drawSelections(o),a.length>1){const e=new f.RenderEdge;e.points=[],a.forEach((t=>{t.points.forEach((n=>{const r=n.map((e=>t.globalMatrix?new s.Vector3(e).transform(t.globalMatrix):new s.Vector3(e)));e.points.push(r)}))})),this.iRender.drawSelections(e)}else 1===a.length&&this.iRender.drawSelections(a[0])}_updateHighlight(){const{highLight:e}=this.getDoc().cacheForView;if(!e)return;const t=e.getActiveObjects();this.iRender.clearHighlight(),this._renderDirty=!0;const n=[],r=[],i=[],o=[],a=[];t.forEach((e=>{if("number"==typeof e)n.push(e);else if(e){const t=e;if(t.getType()===p.GNODE_TYPE.GEdge)r.push(t.geo.getCurve().clone());else if(t.getType()===p.GNODE_TYPE.GCurve3d)r.push(t.geo);else if(t.getType()===p.GNODE_TYPE.GCurves)t.geo.forEach((e=>r.push(e)));else if(t.getType()===p.GNODE_TYPE.GPoint3d)i.push(t.toRenderNode());else{const e=t.toRenderNodeForActive();e instanceof f.RenderMesh?o.push(e):e instanceof f.RenderEdge&&a.push(e)}}else;}));const c=[];let l;if(n.forEach((e=>{const t=this.getDoc().getElementById(e);t.category.activeFaceStyle&&(l=t.category.activeFaceStyle);t.getGNodesWhenActive().forEach((e=>{e instanceof f.RenderMesh?o.push(e):e instanceof g.GCurves?c.push(e):e instanceof f.RenderPoint&&i.push(e)}))})),c.forEach((e=>{e.drawOverlay?this.iRender.drawActives(e):e.geo.forEach((e=>r.push(e)))})),r.length){const e=new g.GCurves(r);this.iRender.drawActives(e)}if(i.forEach((e=>this.iRender.drawActives(e))),o.length&&this.iRender.drawActives(o,l),a.length>1){const e=new f.RenderEdge;e.points=[],a.forEach((t=>{t.points.forEach((n=>{const r=n.map((e=>t.globalMatrix?new s.Vector3(e).transform(t.globalMatrix):new s.Vector3(e)));e.points.push(r)}))})),this.iRender.drawActives(e)}else 1===a.length&&this.iRender.drawActives(a[0]);this._renderDirty=!0}_addGRep(e){if(!e)return;const t=e.elementId.asInt();e.isEmpty()?this._removeGRep(t):(this._idToGRepMap.set(t,e),this.iRender.addGrep(e),this._renderDirty=!0)}_removeGRep(e){const t=this.iRender.removeObject(e);this._idToGRepMap.delete(e),t&&(this._renderDirty=!0)}_updateGRep(e){const t=e.elementId.asInt();e.isEmpty()&&this._removeGRep(t),this._idToGRepMap.set(t,e),this.iRender.removeObject(t),this.iRender.addGrep(e),this._renderDirty=!0}};_=r([u.elementMeta("ModelView",h.DBElement,!1)],_),t.ModelView=_},18051:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ViewChangedCache=void 0;const r=n(55083),s=n(57767);t.ViewChangedCache=class{constructor(){this.container=[];for(let e=0;e<s.EN_VIEW_CHANGED_CACHE_TYPE.__COUNT;e++)this.container.push(new Set)}isChanged(){for(const e of this.container)if(e.size)return!0;return this.selection||this.highLight}clear(){for(const e of this.container)e.clear();delete this.selection,delete this.highLight}cacheHighlight(e){this.highLight=e}cacheSelection(e){this.selection=e}cacheElementChanged(e,t){const n=t.filter((e=>e.shouldShowInViewStatic())),i=this.container[s.EN_VIEW_CHANGED_CACHE_TYPE.ELEMENTS_MODIFIED],o=this.container[s.EN_VIEW_CHANGED_CACHE_TYPE.ELEMENTS_DELETED];r.EN_EVENT_TYPE.ELEMENT_DID_UPDATE===e||r.EN_EVENT_TYPE.ELEMENT_CREATE===e?n.forEach((e=>{o.has(e.id.asInt())&&o.delete(e.id.asInt()),i.add(e.id.asInt())})):r.EN_EVENT_TYPE.ELEMENT_DID_DELETE===e&&n.forEach((e=>{i.has(e.id.asInt())&&i.delete(e.id.asInt()),o.add(e.id.asInt())}))}}},57767:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_VIEW_CHANGED_CACHE_TYPE=void 0,function(e){e[e.ELEMENTS_ADDED=0]="ELEMENTS_ADDED",e[e.ELEMENTS_MODIFIED=1]="ELEMENTS_MODIFIED",e[e.ELEMENTS_DELETED=2]="ELEMENTS_DELETED",e[e.__COUNT=3]="__COUNT"}(t.EN_VIEW_CHANGED_CACHE_TYPE||(t.EN_VIEW_CHANGED_CACHE_TYPE={}))},12239:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PropertyIdUtil=void 0;const r=n(29955),s=n(95829);t.PropertyIdUtil=class{static genId(e,t,n){const i=e.getElementById(t);return s.DebugWarn.assert(i,"element不存在"," ","2020-04-13"),s.DebugWarn.assert(n in i.db,"属性不存在"," ","2020-04-13"),new r.PropertyId(i.id,n)}static addIdToArrIfExist(e,t,n,s){const i=e.getElementById(t);return!(!i||!i.db)&&(s.push(new r.PropertyId(i.id,n)),!0)}}},62735:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shouldCacheToView=void 0,t.shouldCacheToView=function(e,t){return!("CALC_GRep"!==t&&"visible"!==t&&"internalVisible"!==t&&"CALC_INVISIBLE"!==t||!e.shouldShowInViewStatic())}},10325:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.TmpElement=void 0;const s=n(60472),i=n(6218),o=n(45712),a=n(61962);let c=class extends i.Element{isTemporary(){return!0}get category(){return s.categoryTmpElement}init(){return this}shouldShowInDeletionGraphStatic(){return!1}shouldShowInPropertyGraphStatic(){return!1}};c=r([o.elementMeta("TmpElement",a.DBElement,!1)],c),t.TmpElement=c},26762:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TmpElementPainter=void 0;const r=n(98106),s=n(98381),i=n(26452),o=n(10325),a=n(66480),c=n(95829);t.TmpElementPainter=class{constructor(e){this._tmpGRepRemoved=!1,this._doc=e,this._tmpElementId=e.create(o.TmpElement).init().id}get tmpElement(){const e=this._doc.getElementById(this._tmpElementId);return c.DebugWarn.assert(e,"ele为空"," ",""),e}drawTmpCurve(e,t){const n=new s.GRep,r=n.addCurve3d(e);void 0!==t&&r.setStyle({line:{color:t}}),this.drawTmpGRep(n)}drawTmpLine(e,t,n){if(e.equals(t))return;const i=new s.GRep,o=i.addCurve3d(new r.Line3d(e,t));void 0!==n&&o.setStyle({line:{color:n}}),this.drawTmpGRep(i)}drawTmpRect(e,t,n){const i=Math.min(e.x,t.x);let o=Math.min(e.y,t.y);const c=Math.max(e.x,t.x);let l=Math.max(e.y,t.y);e.y>t.y?(o=t.y,l=e.y):(o=e.y,l=t.y);const d=[new r.Vector2(i,o),new r.Vector2(c,o),new r.Vector2(c,l),new r.Vector2(i,l)],u=new s.GRep,{length:h}=d;for(let e=0;e<h;e++){const t=new a.GCurve3d(new r.Line3d(d[e].toXYZ(),d[(e+1)%h].toXYZ()));u.addNode(t)}this.drawTmpGRep(u,n)}drawTmpTriangle(e,t,n){const i=new s.GRep;i.addCurve3d(new r.Line3d(e,t)),i.addCurve3d(new r.Line3d(e,n)),i.addCurve3d(new r.Line3d(n,t)),this.drawTmpGRep(i)}drawTmpGRep(e,t=8947848,n=!1){e.enableRenderFeature=n,e.canGpuPick=!1,e.elementId=this._tmpElementId,e.setStyle({line:{color:t,width:1},face:{color:t,opacity:.3}}),this.tmpElement.setGRep(e),this._tmpGRepRemoved=!1}clearTmp(){this._tmpGRepRemoved||this._doc.getElementById(this._tmpElementId)&&(this.drawTmpGRep(s.GRep.empty),this._tmpGRepRemoved=!0,i.HighLight.getInstance().getSelectedGNodes().length&&i.HighLight.getInstance().clear(),this._doc.updateView())}destroy(){this.clearTmp(),this._doc.deleteElementsById(this._tmpElementId),delete this._tmpElement}}},25981:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniqueElement=void 0;const r=n(23614),s=n(6218);class i extends s.Element{get category(){return r.categoryUniqueElement}}t.UniqueElement=i},37509:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniqueElementUtil=void 0;const r=n(95829);t.UniqueElementUtil=class{static getOrCreateUniqueElement(e,t){const n=e.getAllElementsByCtor(t);return r.DebugWarn.assert(n.length<2,"该Element不是唯一的?"," ","2020-04-13"),1===n.length?n[0]:e.create(t)}static getUniqueElement(e,t){const n=e.getAllElementsByCtor(t);return r.DebugWarn.assert(n.length<2,"该Element不是唯一的?"," ","2020-04-13"),n[0]}}},5504:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ElementGraph=void 0;const r=n(44567),s=n(29955),i=n(95829);t.ElementGraph=class{constructor(){this.clear()}clear(){this._graph=new r.Graph}getAllDownStreamSortedNodes(e){const t={};this._cachedTopoSorts.forEach(((e,n)=>{t[e]=n}));return this.getAllDownStreamNodes(e).sort(((e,n)=>t[e]-t[n]))}getAllDownStreamNodes(e){const t=this._graph,n=[],s=[];e.forEach((e=>{t.hasNode(e)?s.push(e):n.push(e)}));const i=r.alg.preorder(t,s);return n.push(...i),n}getDownStreamNodes(e){const t=this._graph,n=new Set;return e.forEach((e=>{if(!t.hasNode(e))return;const r=t.successors(e);r&&r.forEach((e=>n.add(e)))})),[...n]}toString(){const e=this._graph.edges().map((({v:e,w:t})=>[this._convertNodeToReadble(e),this._convertNodeToReadble(t)]));return JSON.stringify(e)}hasNoCircle(){try{return this._cachedTopoSorts=r.alg.topsort(this._graph),!0}catch(e){return!1}}onElementsAdded(e){e.forEach((e=>{this._convertToEdge(e).forEach((({v:e,w:t})=>{void 0!==e?(i.DebugWarn.assert(e.includes(s.PropertyId.CONNECTOR)&&t.includes(s.PropertyId.CONNECTOR),"数据格式不正确"," ","2020-04-17"),this._graph.setEdge(e,t)):this._graph.setNode(t)}))}))}onElementsDeleted(e){if(!e.length)return;const t=e[0].getDoc(),n=this._graph,r=new Set;for(const t of e)r.add(t.id.toString());const s=n.edges(),i=[];for(const e of s){const t=e.w.split("."),n=t.length?t[0]:"";r.has(n)&&i.push(e)}i.forEach((e=>n.removeEdge(e)));n.nodes().filter((e=>{const t=n.nodeEdges(e);return!t||!t.length})).forEach((e=>{const r=Number.parseInt(e,10);t.getElementById(r)||n.removeNode(e)}))}onElementsUpdated(e){this.onElementsDeleted(e),this.onElementsAdded(e)}}},61175:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ElementsGraph=void 0;const r=n(94788),s=n(66655),i=n(16437);t.ElementsGraph=class{constructor(e){this.onElementsAdded=e=>{const t=this._getInternalGraphes(),n=this._getFilteredElements(e);for(let e=0;e<3;e++)t[e].onElementsAdded(n[e])},this.onElementsDeleted=e=>{const t=this._getInternalGraphes(),n=this._getFilteredElements(e);for(let e=0;e<3;e++)t[e].onElementsDeleted(n[e])},this.onElementsUpdated=e=>{const t=this._getInternalGraphes(),n=this._getFilteredElements(e);for(let e=0;e<3;e++)t[e].onElementsUpdated(n[e])},this.strong=new r.StrongDenpendencyGraph(e),this.weak=new s.WeakDenpendencyGraph(e),this.propertyGraph=new i.ElementsUpdateGraph(e)}getStrongDescendantsToDelete(e){return this.strong.getStrongToDelete([e])}getWeaksToNotify(e){return this.weak.getWeakToNotify([e])}getPropertyIdsToRegenerate(e){return this.propertyGraph.getPropertiesToUpdate(e)}propertyTopoSort(){return this.propertyGraph.topoSort()}getCalcDataCount(){return this.propertyGraph.getCalcDataCount()}clear(){this.propertyGraph.clear(),this.strong.clear(),this.weak.clear()}_getInternalGraphes(){return[this.strong,this.weak,this.propertyGraph]}_getFilteredElements(e){const t=e.filter((e=>e.shouldShowInDeletionGraphStatic()));return[t,t,e.filter((e=>e.shouldShowInPropertyGraphStatic()))]}}},55495:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GraphForDelete=void 0;const r=n(5504),s=n(29955);class i extends r.ElementGraph{constructor(e,t){if(super(),this._doc=e,this._convertNodeToReadble=e=>{var t;const n=Number.parseInt(e,10);return`${null===(t=this._doc.getElementById(n))||void 0===t?void 0:t.constructor.name}`+n},this._convertToEdge=e=>{const t=e.reportDependency()[this._strongOrWeak];if(!t)return[];const n=this._idToNode(e.id);return t.filter((e=>e&&e.isValid())).map((e=>({v:this._idToNode(e),w:n})))},"strong"===t)this._strongOrWeak=0;else{if("weak"!==t)throw new Error("bad param");this._strongOrWeak=1}}_idToNode(e){return new s.PropertyId(e,"").toString()}}t.GraphForDelete=i},94788:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StrongDenpendencyGraph=void 0;const r=n(55495);class s extends r.GraphForDelete{constructor(e){super(e,"strong")}getStrongToDelete(e){if(!e.length)return[];const t=e.map((e=>this._idToNode(e)));return this.getAllDownStreamNodes(t).map((e=>Number.parseInt(e,10)))}}t.StrongDenpendencyGraph=s},66655:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WeakDenpendencyGraph=void 0;const r=n(18064),s=n(55495);class i extends s.GraphForDelete{constructor(e){super(e,"weak")}getWeakToNotify(e){if(!e.length)return[];const t=e.map((e=>this._idToNode(e)));return this.getDownStreamNodes(t).map((e=>new r.ElementId(Number.parseInt(e,10))))}}t.WeakDenpendencyGraph=i},16437:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ElementsUpdateGraph=void 0;const r=n(44567),s=n(5504),i=n(95829),o=n(29955),a=n(18064);class c extends s.ElementGraph{constructor(e){super(),this._doc=e,this._cachedCalculators=new Map,this._convertToEdge=e=>{i.DebugWarn.assert(e.id.isValid(),"ID不合法"," ","2020-04-13");let t=this._cachedCalculators.get(e.id.asInt());t||(t=new Map,this._cachedCalculators.set(e.id.asInt(),t));const n=[],r=e.getCalculatorInstances();for(const s of r){let r;const i=s.getOutputProperty();r=i.includes(".")?`${e.db.id.asInt()}.${i}`:e.db.genPropertyId(i).toString(),t.set(i,s);const o=s.getInputPropertyIds(),a=[];o.filter((e=>e.eleId.isValid())).forEach((e=>{a.push({v:e.toString(),w:r})})),a.length||a.push({v:void 0,w:r}),a.forEach((e=>n.push(e)))}return n},this._convertNodeToReadble=e=>{const t=this._doc.getElementById(Number.parseInt(e,10));return t?(t.name||t.constructor.name)+e:e}}getCalcDataCount(){return this._graph.nodes().length}topoSort(){const e=r.alg.topsort(this._graph);return this._cachedTopoSorts=e,e.map((e=>this._nodeToPropertyId(e)))}getPropertiesToUpdate(e){const t=e.map((e=>e.toString()));return this.getAllDownStreamSortedNodes(t).map((e=>{const t=e.indexOf(o.PropertyId.CONNECTOR),n=e.substring(0,t),r=e.substring(t+1);return new o.PropertyId(new a.ElementId(Number.parseInt(n,10)),r)}))}getInfluencedElements(e){const t=e.map((e=>e.toString())),n=this.getAllDownStreamSortedNodes(t).map((e=>{const t=e.indexOf(o.PropertyId.CONNECTOR),n=e.substring(0,t);return Number.parseInt(n,10)}));return[...new Set(n)].map((e=>new a.ElementId(e)))}getCachedCalculator(e,t){var n;return null===(n=this._cachedCalculators.get(e.asInt()))||void 0===n?void 0:n.get(t)}onElementsDeleted(e){super.onElementsDeleted(e),e.forEach((e=>this._cachedCalculators.delete(e.id.asInt())))}onElementsUpdated(e){if(!e.length)return;const t=e[0].getDoc(),n=this._graph,r=new Set(e.map((e=>e.id.toString()))),s=n.edges(),i=new Map;for(const e of s){const t=e.w.split("."),n=t.length?t[0]:"";r.has(n)&&i.set(`${e.v}=${e.w}`,e)}if(e.forEach((e=>this._cachedCalculators.delete(e.id.asInt()))),e.forEach((e=>{this._convertToEdge(e).forEach((({v:e,w:t})=>{void 0!==e?i.delete(`${e}=${t}`)||this._graph.setEdge(e,t):this._graph.setNode(t)}))})),!i.size)return;i.forEach((e=>n.removeEdge(e)));n.nodes().filter((e=>{const t=n.nodeEdges(e);return!t||!t.length})).forEach((e=>{const r=Number.parseInt(e,10);t.getElementById(r)||n.removeNode(e)}))}_nodeToPropertyId(e){const[t,n]=e.split(o.PropertyId.CONNECTOR);return new o.PropertyId(new a.ElementId(Number.parseInt(t,10)),n)}}t.ElementsUpdateGraph=c},63912:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.eventManager=t.EventManager=t.CmdFinishedEvent=t.CmdErrorEvent=t.DebugWarnEvent=t.PreSendCmdEvent=t.TransactRollbackEvent=t.TransactEvent=t.FamilyDeleteEvent=t.FamilyLoadEvent=t.DocumentEvent=t.MessageEvent=t.SnappeddEvent=t.SelectionEvent=t.ElementIdEvent=t.ElementEvent=t.Event=t.EventManagerGeneric=void 0;const s=n(55083),i=n(95829);class o{constructor(){this._listenerMap=new Map,this._delayedEventParam=new Map}on(e,t){this._checkName(e),this._checkListener(t);const n=this._listenerMap.get(e);n?n.includes(t)||n.push(t):this._listenerMap.set(e,[t])}off(e,t){this._checkName(e),this._checkListener(t);const n=this._listenerMap.get(e);if(n){const r=n.findIndex((e=>e===t));if(r>=0)return n.splice(r,1),void(n.length||this._listenerMap.delete(e))}}emit(e,t){return r(this,void 0,void 0,(function*(){this._checkName(e);const n=this._listenerMap.get(e);if(n)for(const e of n){const n=e(t);n instanceof Promise&&(yield n)}}))}emitDelay(e,t,n=0){return r(this,void 0,void 0,(function*(){if(!this._delayedEventParam.has(e))return this._delayedEventParam.set(e,t),new Promise((t=>{setTimeout((()=>r(this,void 0,void 0,(function*(){i.DebugWarn.assert(this._delayedEventParam.has(e),"出错"," ","2020-11-23");const n=this._delayedEventParam.get(e);this._delayedEventParam.delete(e),yield this.emit(e,n),t()}))),n)}));this._delayedEventParam.set(e,t)}))}isListenerEmpty(e){this._checkName(e);const t=this._listenerMap.get(e);return void 0===t||0===t.length}_checkName(e){if(!e||"string"!=typeof e)throw new Error(`Illegal event name: ${e}`)}_checkListener(e){if(!(e&&e instanceof Function))throw new Error(`Illegal event listener: ${e}`)}}t.EventManagerGeneric=o;class a{constructor(e,t){this.eventType=e,this.data=t}}t.Event=a;t.ElementEvent=class extends a{constructor(e,t){super(e,t);const n=this.data;(!n||n.length<1)&&(this.eventType=s.EN_EVENT_TYPE.INVALID)}};t.ElementIdEvent=class extends a{};t.SelectionEvent=class extends a{constructor(e){super(s.EN_EVENT_TYPE.SELECTION_CHANGE),this.data=e}};t.SnappeddEvent=class extends a{constructor(e){super(s.EN_EVENT_TYPE.SNAPPED_EVENT),this.data=e}};t.MessageEvent=class extends a{};t.DocumentEvent=class extends a{};t.FamilyLoadEvent=class extends a{};t.FamilyDeleteEvent=class extends a{};t.TransactEvent=class extends a{};t.TransactRollbackEvent=class extends a{constructor(){super(s.EN_EVENT_TYPE.TRANSACT_ROLLBACK)}};t.PreSendCmdEvent=class extends a{constructor(e,t){super(s.EN_EVENT_TYPE.PRE_SEND_CMD,{cmdId:e,param:t})}};t.DebugWarnEvent=class extends a{constructor(e,t){super(s.EN_EVENT_TYPE.DEBUG_WARN,{isAssert:e,msg:t})}};t.CmdErrorEvent=class extends a{constructor(e,t,n){super(s.EN_EVENT_TYPE.CMD_ERROR,{cmdId:t,param:n,error:e})}};t.CmdFinishedEvent=class extends a{constructor(e){super(s.EN_EVENT_TYPE.CMD_FINISHED,{cmdId:e})}};class c extends o{addEventListener(e,t){this.on(e,t)}removeEventListener(e,t){this.off(e,t)}dispatchEvent(e){return r(this,void 0,void 0,(function*(){e.eventType!==s.EN_EVENT_TYPE.INVALID&&(yield this.emit(e.eventType,e.data))}))}dispatchEventDelay(e,t=0){return r(this,void 0,void 0,(function*(){e.eventType!==s.EN_EVENT_TYPE.INVALID&&(yield this.emitDelay(e.eventType,e.data,t))}))}}t.EventManager=c,t.eventManager=new c},55083:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_EVENT_TYPE=void 0,function(e){e.ELEMENT_CREATE="element_create",e.ELEMENT_DID_UPDATE="element_did_update",e.ELEMENT_DID_DELETE="element_did_delete",e.ELEMENT_CLONE="element_clone",e.SELECTION_CHANGE="selection_change",e.SNAPPED_EVENT="SNAPPED_EVENT",e.CAMERA_CHANGE="camera_change",e.CAMERA_SWITCH="camera_switch",e.CAMERA_MOVE="camera_move",e.MESSAGE_STAUS_BAR_INFO="message_staus_bar_info",e.MESSAGE_TOAST="message_toast",e.MESSAGE_TOAST_URL="message_toast_url",e.MESSAGE_NOTICE="message_notice",e.MESSAGE_LOADING="message_loading",e.MESSAGE_SUCCEESS="message_success",e.MESSAGE_ERROR="message_error",e.MESSAGE_MOUSE_TEXT1="message_mouse_text1",e.MESSAGE_MOUSE_TEXT2="message_mouse_text2",e.MESSAGE_EDIT_MODE_ENTER="message_edit_mode_enter",e.MESSAGE_EDIT_MODE_EXIT="message_edit_mode_exit",e.MESSAGE_POPIMG="message_pop_img",e.DOCUMENT_CREATED="document_created",e.DOCUMENT_OPENED="document_opened",e.DOCUMENT_SAVED="document_saved",e.DOCUMENT_CLOSED="document_closed",e.FAMILY_LOAD="family_load",e.FAMILY_DELETE="family_delete",e.INVALID="invalid",e.TRANSACT_COMMIT="transact_commit",e.TRANSACT_ROLLBACK="transact_rollback",e.PRE_SEND_CMD="pre.send.cmd",e.POLYCURVE_EDITING="polycurve_editing",e.CMD_FINISHED="cmd.finished",e.CMD_ERROR="cmd.error",e.DEBUG_WARN="debug.warn"}(t.EN_EVENT_TYPE||(t.EN_EVENT_TYPE={}))},48399:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.__CAN_CREATE=void 0;class n{}t.__CAN_CREATE=n,n.canCreate=!1},21032:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FlagTester=t.Flags=void 0;class n{}t.Flags=n,n.None=0,n.RENDER=1,n.GPU_SELECT=2,n.SNAP=4,n.PICK=8,n.FROZEN=16,n.EDITABLE=n.RENDER|n.GPU_SELECT|n.SNAP|n.PICK,n.DYNAMIC=32;class r{static renderable(e){return(e&n.RENDER)===n.RENDER}static gpuSelectable(e){return(e&n.GPU_SELECT)===n.GPU_SELECT}static pickable(e){return(e&n.PICK)===n.PICK}static snapable(e){return(e&n.SNAP)===n.SNAP}static editable(e){return r.renderable(e)&&r.gpuSelectable(e)}static frozen(e){return(e&n.FROZEN)===n.FROZEN}static clearFlag(e,t){return e&~t}static isDynamic(e){return(e&n.DYNAMIC)===n.DYNAMIC}static setFlag(e,t){return e|t}static toggleFlag(e,t){return e^t}static apply(e,t){let s=e&t;return r.frozen(t)&&(s=r.setFlag(s,n.FROZEN)),s}}t.FlagTester=r},15204:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GGeoNode2d=void 0;const r=n(98106),s=n(27122);class i extends s.GNode{constructor(e,t){super(),this.plane=e.clone(),this.geo=t}performTranslate(e){const t=r.Matrix4.makeTranslate(e);this.transform(t)}transform(e){return!!this.plane.transform(e)}get grepRenderArea(){return this.category.getRenderArea()}getBoundingBox(){return new r.Box3}_copy(e){return super._copy(e),this}}t.GGeoNode2d=i},24357:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GBody=void 0;const r=n(67549),s=n(27122),i=n(22276),o=n(48076),a=n(38675);class c extends s.GNode3d{constructor(e,t,n=!0){super(),this._gfaceList=[],this._gedgeList=[],this.resetBody(e,t,n)}get geo(){return this._geo}get faceList(){return this._gfaceList}get edgeList(){return this._gedgeList}resetBody(e,t,n){if(this._geo=e,this._gfaceList.splice(0),this._gedgeList.splice(0),e.getFaces().forEach((e=>{const n=new o.GFace(e,this);n.id=(null==t?void 0:t.get(e.tag))||n.globalID,this._gfaceList.push(n)})),n)for(const n of e.getEdges()){if(n.getSmooth())continue;if(0===n.getCurve().getLength())continue;const e=new i.GEdge(n,this);e.id=(null==t?void 0:t.get(n.tag))||e.globalID,this._gedgeList.push(e)}}transform(e){return!!this._geo.transform(e)}getBodyChildren(){return[...this.faceList,...this.edgeList]}getType(){return a.GNODE_TYPE.GBody}getTraverseChildren(){return[...this._gedgeList,...this._gfaceList]}getBody(){return this._geo}clone(e){return new c(e?this._geo.clone():this._geo)._copy(this)}intersected(e,t,n){return this._toGGroup().intersected(e,t,n)}getBoundingBox(){return this._toGGroup().getBoundingBox()}_toGGroup(){const e=new r.GGroup3d;return e.addNodes(...this._gfaceList,...this._gedgeList),e.parent=this,e}_toRenderNodeImpl(e){return r.GGroup3d.prototype._toRenderNodeImpl.call(this._toGGroup(),e)}_copy(e){super._copy(e);const t=e.getBodyChildren(),n=this.getBodyChildren();for(let e=0;e<t.length;e++)n[e].copyFlagsAndStyle(t[e]);return this}}t.GBody=c},83384:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GBodyUtil=void 0;const r=n(98106);t.GBodyUtil=class{static drawBoxGCurves(e,t,n={line:{dotted:!0,dashSize:6,gapSize:6}},s=1){const i=t.clone();if(!i.isValid())return;if(!r.MathUtil.isNearlyEqual(1,s)){const e=i.getSize().multiply(s);i.setFromCenterAndSize(i.getCenter(),e)}const o=i.getSize(),a=new r.Vector3(i.min.x,i.min.y,i.min.z),c=new r.Vector3(a.x+o.x,a.y,a.z),l=new r.Vector3(a.x+o.x,a.y+o.y,a.z),d=new r.Vector3(a.x,a.y+o.y,a.z),u=new r.Vector3(a.x,a.y,a.z+o.z),h=new r.Vector3(a.x+o.x,a.y,a.z+o.z),g=new r.Vector3(a.x+o.x,a.y+o.y,a.z+o.z),f=new r.Vector3(a.x,a.y+o.y,a.z+o.z),p=[];[[a,c],[c,l],[l,d],[d,a],[u,h],[h,g],[g,f],[f,u],[l,g],[h,c],[d,f],[u,a]].forEach((([e,t])=>{e.equals(t,.01)||p.push(new r.Line3d(e,t))})),p.forEach((t=>{const r=e.addCurve3d(t);r.canGpuPick=!1,n?r.setStyle(n):r.setStyle({line:{dotted:!0,dashSize:6,gapSize:6}})}))}}},87346:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GCurve2d=void 0;const r=n(98106),s=n(40260),i=n(88583),o=n(15204),a=n(38675);class c extends o.GGeoNode2d{constructor(e,t){super(e,t)}getType(){return a.GNODE_TYPE.GCurve2d}intersected(e,t,n){const s=new r.Vector2,i=this.plane.getUVAt(e);if(r.MathAlg.CalculateDistance.pointToCurve2d(i,this.geo,s)<t)return this.plane.getPtAt(s)}clone(){return new c(this.plane,this.geo.clone())._copy(this)}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=i.getLineStyle(this.getStyle())),this}_toRenderNodeImpl(e){const t=this.geo.discrete(e),n=new s.RenderEdge;return n.points=[t.map((e=>this.plane.getPtAt(e)))],n.style=i.getLineStyle(this.getStyle()),n}}t.GCurve2d=c},66480:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GCurve3d=void 0;const r=n(98106),s=n(21282),i=n(40260),o=n(27122),a=n(40095),c=n(88583),l=n(38675);class d extends o.GNode3d{constructor(e){super(),this.geo=e}getType(){return l.GNODE_TYPE.GCurve3d}getBoundingBox(){return this.geo.getBoundingBox()}transform(e){return!!this.geo.transform(e)}intersected(e,t,n){const i=this.geo.clone();if(n){if(e instanceof r.Vector3){const r=a.generateRay(e,n),o=s.RayToCurve3dDistance.excute(r,i);if(o.distance<t&&o.pt)return o.pt}}else{if(r.MathAlg.CalculateDistance.pointToCurve3d(e,i)<t){const t=i.getParamAt(e);return i.getPtAt(t)}}}clone(e){return new d(e?this.geo.clone():this.geo)._copy(this)}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=c.getLineStyle(this.getStyle())),this}getStartPt(){return this.geo.getStartPt()}getEndPt(){return this.geo.getEndPt()}_toRenderNodeImpl(e){const t=this.geo.discrete(e),n=new i.RenderEdge;return n.points=[t],n.style=c.getLineStyle(this.getStyle()),n}}t.GCurve3d=d},34558:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GCurves=void 0;const r=n(98106),s=n(27122),i=n(88583),o=n(38675),a=n(40260);class c extends s.GNode3d{constructor(e,t){super(),this.geo=e,this.edges=t}getType(){return o.GNODE_TYPE.GCurves}getBoundingBox(){const e=new r.Box3;return this.geo.forEach((t=>e.union(t.getBoundingBox()))),e}transform(e){return this.geo.forEach((t=>t.transform(e))),!0}intersected(e,t,n){}clone(e){return new c(this.geo.map((t=>e?t.clone():t)),this.edges)._copy(this)}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=i.getLineStyle(this.getStyle())),this}_toRenderNodeImpl(e){const t=new a.RenderEdge;return t.points=this.geo.map((t=>t.discrete(e))),t.style=i.getLineStyle(this.getStyle()),t}}t.GCurves=c},22276:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GEdge=void 0;const r=n(98106),s=n(21282),i=n(40260),o=n(27122),a=n(40095),c=n(88583),l=n(38675);class d extends o.GNode3d{constructor(e,t){super(),this.geo=e,this.gbody=t,this.parent=t}getType(){return l.GNODE_TYPE.GEdge}getTopoFaces(){return this.gbody?this.gbody.faceList.filter((e=>!!e.geo.getEdges().find((e=>e.tag===this.geo.tag)))):[]}getBoundingBox(){return this.geo.getBoundingBox()}transform(e){const t=this.geo;return t.setCurve(t.getCurve().transform(e)),!!t}intersected(e,t,n){const i=this.geo.getCurve().clone();if(n){if(e instanceof r.Vector3){const r=a.generateRay(e,n),o=s.RayToCurve3dDistance.excute(r,i);if(o.distance<t&&o.pt)return o.pt}}else{if(r.MathAlg.CalculateDistance.pointToCurve3d(e,i)<t)return e}}clone(){if(!this.gbody){const e=new d(this.geo);return e._copy(this),e}throw new Error("cant implement")}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=c.getLineStyle(this.getStyle())),this}getStartPt(){return this.geo.getStartVertex().getPoint().clone()}getEndPt(){return this.geo.getEndVertex().getPoint().clone()}_toRenderNodeImpl(e){const t=this.geo.getCurve().discrete(e),n=new i.RenderEdge;return n.points=[t],n.style=c.getLineStyle(this.getStyle()),n}}t.GEdge=d},48076:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GFace=void 0;const r=n(3319),s=n(98106),i=n(95829),o=n(40260),a=n(27122),c=n(88583),l=n(40095),d=n(38675),u=n(67821);class h extends a.GNode3d{constructor(e,t){super(),this.geo=e,this.gbody=t,this.parent=t}getType(){return d.GNODE_TYPE.GFace}setInternalGRep(e){this._internalGRep=e}getTopoGEdges(){return this.gbody?this.gbody.edgeList.filter((e=>!!e.geo.getFaces().find((e=>e.tag===this.geo.tag)))):[]}getBoundingBox(){return this.geo.getBoundingBox()}transform(e){const t=this.geo;return t.setSurface(t.getSurface().transform(e)),!!t}getFinalPlane(){const e=this.geo.getSurface().clone();if(e.isPlane())return this.geo.getSameDirWithSurface()||e.reverse(),e}intersected(e,t,n){const i=this.geo;if(!n){return r.alg.BrepPositionJudge.isPtInFace(e,i,t)?e:void 0}const a=l.generateRay(e,n);if(l.isRayIntersectedBoundingSphere(a,this.getBoundingBox(),t))try{const e=i.getSurface(),n=s.MathAlg.CalculateIntersect.curveSurface(a,e);if(!n.length)return;return n.find((e=>r.alg.BrepPositionJudge.isPtInFace(e,i,t)&&a.containsProjectedPt(e)))}catch(t){const r=this.toRenderNode();if(!(r instanceof o.RenderMesh))return;const s={vertices:[...r.getVerts()],faces:[...r.getIndices()],normals:[...r.getNormals()],uvs:[...r.getUVs()]};return l.rayIntersectMesh(e,n,s)}}clone(){if(!this.gbody){const e=new h(this.geo);return e._copy(this),e}throw new Error("cant implement")}toRenderNodeForActive(e){if(this._renderNode&&this._renderNode instanceof o.RenderMesh)return this._renderNode.cloneDeep();const t=new o.RenderMesh;try{const n=this.geo.tessellate(!1,e),{vertices:r,faces:s,normals:i,uvs:o}=n.mesh;if(t.setVerts(r.map((([e,t,n])=>({x:e,y:t,z:n})))),s&&t.setIndices(s),i&&t.setNormals(i.map((([e,t,n])=>({x:e,y:t,z:n})))),o){const e=this.getStyle().face;u.setUVToRenderMesh(this.doc,o,e,t)}}catch(e){i.DebugWarn.warn(!1,"invalid gface","","")}return t.style=c.getFaceStyle(this.getStyle()),t.userData=this.userData,t}setStyle(e){var t,n,r,s;if(super.setStyle(e),this._renderNode){const e=null===(t=this._renderNode.style.face)||void 0===t?void 0:t.tileSizeX,i=null===(n=this._renderNode.style.face)||void 0===n?void 0:n.tileSizeY;if(e||i)this.clearRenderNode();else{const t=this.getStyle(),n=null===(r=t.face)||void 0===r?void 0:r.tileSizeX,a=null===(s=t.face)||void 0===s?void 0:s.tileSizeY;e===n&&i===a||this._renderNode.traverse((e=>{e instanceof o.RenderMesh&&u.setUVToRenderMesh(this.doc,e.getUVs(),t.face,e)})),this._renderNode.style=c.getFaceStyle(t)}}return this}_toRenderNodeImpl(e){if(this._internalGRep){this._internalGRep.elementId=this.elementId;const e=this._internalGRep.toRenderNode();return e.traverse((e=>{if(e instanceof o.RenderGroup)return;const t=++a.GNode._gID;e.setID(t),e.gnode=this})),e}return this.toRenderNodeForActive(e)}}t.GFace=h},67549:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GGroup3d=void 0;const r=n(98106),s=n(40260),i=n(66480),o=n(27122),a=n(25214),c=n(38675),l=n(34558),d=n(48076),u=n(22276);class h extends o.GNode3d{constructor(){super(...arguments),this._children=[]}getType(){return c.GNODE_TYPE.GGroup3d}addNode(e){e.parent=this,this._children.push(e)}transform(e){for(const t of this._children){if(!t.transform(e))return!1}return!0}removeNodeByglobalID(e){for(let t=0;t<this._children.length;t++){if(this._children[t].globalID===e)return this._children.splice(t,1),!0;if(this.children[t]instanceof h){if(this.children[t].removeNodeByglobalID(e))return!0}}return!1}addNodes(...e){e.forEach((e=>this.addNode(e)))}addPoint3d(e){const t=new a.GPoint3d(e);return this.addNode(t),t}addCurve3d(e){const t=new i.GCurve3d(e);return this.addNode(t),t}addGFace(e,t){const n=new d.GFace(e);return void 0!==t&&(n.id=t),this.addNode(n),n}addGEdge(e,t){const n=new u.GEdge(e);return void 0!==t&&(n.id=t),this.addNode(n),n}addGCurves(e){const t=new l.GCurves(e);return this.addNode(t),t}isEmpty(){return this._children.length<1}getBoundingBox(){const e=new r.Box3;return this._children.forEach((t=>{const n=t.getBoundingBox();n.isValid()&&e.union(n)})),e}intersected(e,t,n){for(const r of this._children){const s=r.intersected(e,t,n);if(s)return s}}getTraverseChildren(){return this._children}clear(){this._children.splice(0)}asString(){let e="";return this._children.forEach((t=>{e+=`${t.asString()}\n`})),e}clone(){return(new h)._copy(this)}clearRenderNode(){this.children.forEach((e=>e.clearRenderNode())),this._renderNode=void 0}_toRenderNodeImpl(e){const t=new s.RenderGroup;return this.elementId&&(t.elementId=this.elementId.asInt()),this._children.forEach((n=>{const r=n.toRenderNode(e);t.add(r)})),t.setID(this.globalID),t}_copy(e,t){return super._copy(e),e._children.forEach((e=>this.addNode(e.clone(t)))),this}get children(){return this._children}}t.GGroup3d=h},75707:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GMesh=void 0;const r=n(98106),s=n(40260),i=n(27122),o=n(88583),a=n(38675),c=n(67821),l=n(40095);class d extends i.GNode3d{constructor(e,t,n,r){super(),this._verts=e,this._indices=t,this._normals=n,this._uvs=r}get vertices(){return this._verts}get indices(){return this._indices}get normals(){return this._normals}get uvs(){return this._uvs}getType(){return a.GNODE_TYPE.GMesh}transform(e){if(this._verts)for(let t=0;t<this._verts.length/3;t++){const n=new r.Vector3(this._verts[3*t],this._verts[3*t+1],this._verts[3*t+2]);n.transform(e),this._verts[3*t]=n.x,this._verts[3*t+1]=n.y,this._verts[3*t+2]=n.z}if(this._normals)for(let t=0;t<this._normals.length/3;t++){const n=new r.Vector3(this._normals[3*t],this._normals[3*t+1],this._normals[3*t+2]);n.vecTransform(e),this._normals[3*t]=n.x,this._normals[3*t+1]=n.y,this._normals[3*t+2]=n.z}return!0}clone(){const e=new d(Float32Array.from(this._verts),Uint32Array.from(this._indices),Float32Array.from(this._normals),Float32Array.from(this._uvs));return e._copy(this),e}getBoundingBox(){const e=new r.Box3;for(let t=0;t<this._verts.length/3;t++){const n=new r.Vector3(this._verts[3*t],this._verts[3*t+1],this._verts[3*t+2]);e.expandByPoint(n)}return e}toIFlatMesh(){return{vertices:[...this._verts],faces:[...this._indices],normals:[...this._normals],uvs:[...this._uvs]}}intersected(e,t,n){if(l.isRayIntersectedBoundingSphere(l.generateRay(e,n),this.getBoundingBox(),t))return l.rayIntersectMesh(e,n,this.toIFlatMesh())}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=o.getFaceStyle(this.getStyle())),this}_toRenderNodeImpl(e){const t=new s.RenderMesh;t.setVerts(this._verts),t.setIndices(this._indices),t.setNormals(this._normals);const n=this.getStyle();return c.setUVToRenderMesh(this.doc,this._uvs,n.face,t,this.keepUV),t.style=n,t.userData=this.userData,t}}t.GMesh=d},27122:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GNode3d=t.GNode=void 0;const r=n(21032),s=n(38675),i=n(95829);class o{constructor(){this.oldFlags=r.Flags.EDITABLE,this.flags=r.Flags.EDITABLE,this._style={},o._gID++,this.globalID=o._gID}toRenderNodeForActive(e){return this.toRenderNode(e)}getType(){return i.DebugWarn.assert(!1,"GNode应该有合法的Type！"," ","2020-04-20"),s.GNODE_TYPE.INVALID}get canPick(){return(!this.parent||this.parent.canPick)&&r.FlagTester.pickable(this.flags)}set canPick(e){this.flags=e?r.FlagTester.setFlag(this.flags,r.Flags.PICK):r.FlagTester.clearFlag(this.flags,r.Flags.PICK)}get canGpuPick(){return(!this.parent||this.parent.canGpuPick)&&r.FlagTester.gpuSelectable(this.flags)}set canGpuPick(e){this.flags=e?r.FlagTester.setFlag(this.flags,r.Flags.GPU_SELECT):r.FlagTester.clearFlag(this.flags,r.Flags.GPU_SELECT)}get canSnap(){return(!this.parent||this.parent.canSnap)&&r.FlagTester.snapable(this.flags)}set canSnap(e){this.flags=e?r.FlagTester.setFlag(this.flags,r.Flags.SNAP):r.FlagTester.clearFlag(this.flags,r.Flags.SNAP)}get visible(){return r.FlagTester.renderable(this.flags)}set visible(e){this.flags=e?r.FlagTester.setFlag(this.flags,r.Flags.RENDER):r.FlagTester.clearFlag(this.flags,r.Flags.RENDER)}get elementId(){let e=this;for(;e.parent;)e=e.parent;return e._refElementId}get doc(){var e;let t=this;for(;t.parent;)t=t.parent;return null===(e=t)||void 0===e?void 0:e._doc}get grepRenderArea(){return this.category.getRenderArea()}get category(){let e=this;for(;e.parent;)e=e.parent;return e.category}setStyle(e){return Object.assign(this._style,e),this}getStyle(){const e=this._style,t=this.parent?this.parent.getStyle():{};return Object.assign(t,e)}getFinalFlag(){let e=this.flags;if(this.parent){const t=this.parent.getFinalFlag();e=e&~r.Flags.GPU_SELECT|e&t&r.Flags.GPU_SELECT,e=e&~r.Flags.RENDER|e&t&r.Flags.RENDER}return e}toRenderNode(e){if(this._renderNode)return this._renderNode;const t=this.discreteParams||e;return this._renderNode=this._toRenderNodeImpl(t),this._renderNode.flags=this.getFinalFlag(),this._renderNode.setID(this.globalID),this._renderNode.gnode=this,void 0!==this.onBeforeRender&&(this._renderNode.onBeforeRender=this.onBeforeRender),this._renderNode.userData=this.userData,this._renderNode}traverse(e){var t;e(this),null===(t=this.getTraverseChildren())||void 0===t||t.forEach((t=>t.traverse(e)))}getTraverseChildren(){}find(e){const t={result:void 0};return this._find(e,t),t.result}asString(){return this.geo&&this.geo.dump()?`${this.geo}`:""}copyFlagsAndStyle(e){return this.canGpuPick=e.canGpuPick,this.canSnap=e.canSnap,this.visible=e.visible,this._style=Object.assign({},e._style),this.id=e.id,this.name=e.name,this}isGFace(){return this.getType()===s.GNODE_TYPE.GFace}isGFaceRef(){return this.getType()===s.GNODE_TYPE.GNodeRef&&this.getOriginGNode().isGFace()}isGEdge(){return this.getType()===s.GNODE_TYPE.GEdge}isGEdgeRef(){return this.getType()===s.GNODE_TYPE.GNodeRef&&this.getOriginGNode().isGEdge()}isGEmptyNodeRef(){return this.getType()===s.GNODE_TYPE.GNodeRef}clearRenderNode(){this._renderNode=void 0}_copy(e){return this.copyFlagsAndStyle(e),this}_find(e,t){if(t.result)return;if(e(this))return void(t.result=this);const n=this.getTraverseChildren();if(null==n?void 0:n.length)for(const r of n){if(t.result)return;r._find(e,t)}}}t.GNode=o,o._gID=0;t.GNode3d=class extends o{get grepRenderArea(){return this.category.getRenderArea()}}},95266:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GNodeKey=void 0;const r=n(98106),s=n(18064),i=n(7684),o=n(38675);class a{constructor(e,t,n){this.eleId=null!=e?e:s.ElementId.INVALID,"number"!=typeof t&&"string"!=typeof t||(this.id=t),this.type=n}clone(){return(new a).load(this.dump())}isValid(){var e;return!!(null===(e=this.eleId)||void 0===e?void 0:e.isValid())}getElement(e){return e.getElementById(this.eleId)}getGNode(e){const t=this.getElement(e);if(t)return t.getGRep().getGNodeById(this.id,!0)}getFace(e,t){do{const n=this.getElement(e);let s=t||(null==n?void 0:n.db.CALC_BodiesForToponame);if((null==s?void 0:s.length)||(s=[],null==n||n.getGRep().traverse((e=>{if(e.getType()===o.GNODE_TYPE.GFace){const t=e.geo.getParent();null==s||s.push(t)}}))),!s.length)break;for(const e of[...new Set(s)])if(e.getType()===r.EN_GEO_ELEMENT_TYPE.EN_BREP_SHELL||e.getType()===r.EN_GEO_ELEMENT_TYPE.EN_BREP_BODY){const t=e.getFaces().find((e=>i.getGNodeIdFromGeo(e,!1)===this.id));if(t)return{f:t}}}while(0);const n=this.getGNode(e);return(null==n?void 0:n.isGFace())?{f:n.geo}:(null==n?void 0:n.isGEmptyNodeRef())&&n.getOriginGNode().isGFace()?{f:n.getOriginGNode().geo,m:n.getMatrix().clone()}:void 0}getSurface(e){const t=this.getFace(e);if(!t)return;return{surface:t.f.getSurface().clone(),reverse:!t.f.getSameDirWithSurface(),m:t.m}}getFinalPlane(e){const t=this.getSurface(e);if(!(null==t?void 0:t.surface.isPlane()))return;const{surface:n,reverse:r,m:s}=t;return r&&n.reverse(),s&&!s.isIdentity()&&n.transform(s),n}dump(){return{eleId:this.eleId.asInt(),gnodeId:this.id,type:this.type}}load(e){return this.id=e.gnodeId,this.eleId=new s.ElementId(e.eleId),this.type=e.type,this}}t.GNodeKey=a},38675:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GNODE_TYPE=void 0,function(e){e[e.INVALID=-1]="INVALID",e[e.GPoint2d=1]="GPoint2d",e[e.GCurve2d=2]="GCurve2d",e[e.GPoint3d=3]="GPoint3d",e[e.GCurve3d=4]="GCurve3d",e[e.GEdge=5]="GEdge",e[e.GFace=6]="GFace",e[e.GBody=7]="GBody",e[e.GGroup3d=8]="GGroup3d",e[e.GRep=9]="GRep",e[e.GMesh=10]="GMesh",e[e.GText3d=11]="GText3d",e[e.GNodeRef=12]="GNodeRef",e[e.GRepRef=13]="GRepRef",e[e.GSurface=14]="GSurface",e[e.GCurves=16]="GCurves"}(t.GNODE_TYPE||(t.GNODE_TYPE={}))},40095:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rayIntersectMesh=t.isRayIntersectedBoundingSphere=t.generateRay=void 0;const r=n(98106);function s(e,t){return new r.Line3d(e,t,[0,100*r.CONST.MODEL_MAX_LENGTH])}t.generateRay=s,t.isRayIntersectedBoundingSphere=function(e,t,n){if(!t.isValid())return!1;const s=t.getCenter(),i=t.getSize().getLength()/2,o=e.getProjectedPtBy(s).distanceTo(s);return r.MathUtil.isNearlySmaller(o,i,n)},t.rayIntersectMesh=function(e,t,n){const i=s(e,t),o=r.MathAlg.MeshUtil.intersectLine(n,i);if(o.length)return i.getPtAt(o[0])}},88324:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GPoint2d=void 0;const r=n(98106),s=n(40260),i=n(88583),o=n(15204),a=n(38675);class c extends o.GGeoNode2d{constructor(e,t){super(e,t)}getType(){return a.GNODE_TYPE.GPoint2d}getBoundingBox(){return new r.Box3}intersected(e,t,n){const r=this.plane.getPtAt(this.geo);if(e.sqDistanceTo(r)<5*t)return r}clone(e){return new c(this.plane,e?this.geo.clone():this.geo)._copy(this)}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=i.getPointStyle(this.getStyle())),this}_toRenderNodeImpl(){const e=new s.RenderPoint;return e.point=this.plane.getPtAt(this.geo),e.style=i.getPointStyle(this.getStyle()),e}}t.GPoint2d=c},25214:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GPoint3d=void 0;const r=n(98106),s=n(40260),i=n(27122),o=n(40095),a=n(88583),c=n(38675);class l extends i.GNode3d{constructor(e){super(),this.geo=e}getType(){return c.GNODE_TYPE.GPoint3d}getBoundingBox(){const e=this.geo.clone();return new r.Box3([e])}transform(e){return!!this.geo.transform(e)}clone(e){return new l(e?this.geo.clone():this.geo)._copy(this)}intersected(e,t,n){const s=this.geo.clone();if(!n)return e.sqDistanceTo(s)<5*t?s:void 0;if(e instanceof r.Vector3){const i=o.generateRay(e,n);return r.MathAlg.CalculateDistance.pointToCurve3d(s,i)<t?s:void 0}}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=a.getPointStyle(this.getStyle())),this}_toRenderNodeImpl(){const e=new s.RenderPoint;return e.point=this.geo,e.style=a.getPointStyle(this.getStyle()),e}}t.GPoint3d=l},98381:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GRep=void 0;const r=n(98106),s=n(67549),i=n(38675),o=n(84983);class a extends s.GGroup3d{constructor(){super(...arguments),this.enableRenderFeature=!0,this.wireOnlySameAsWhite=!1}static get empty(){return new a}get grepRenderArea(){var e;return null!==(e=this._selfRenderArea)&&void 0!==e?e:super.grepRenderArea}set grepRenderArea(e){this._selfRenderArea=e}getType(){return i.GNODE_TYPE.GRep}set elementId(e){this._refElementId=e}get elementId(){return this._refElementId}set doc(e){this._doc=e}get doc(){return this._doc}set category(e){this._category=e}get category(){return this._category}set wireframeStyle(e){this._wireframeStyle=e}get wireframeStyle(){return this._wireframeStyle}getGNodeById(e,t){var n;const s=this;if(!("string"==typeof e&&e.startsWith("~")&&t))return s.find((t=>t.id===e));const a=e.substring(1),[c,l]=a.split(".");if(!c||!l)return;const d=Number.parseInt(l,10),u=c.split("|").map((e=>{const[t,n]=e.split("@");return{id:Number.parseInt(t,10),key:n}}));if(Number.isNaN(d)||!u.length)return;let h,g=s;for(;g&&u.length;){const e=g.children.find((e=>e.getType()===i.GNODE_TYPE.GRepRef&&e.getCurPath()===u[0].id&&e.getKey()===u[0].key));e?(g=e.getOriginGRep(),h=(null!==(n=e.getMatrix())&&void 0!==n?n:new r.Matrix4).multiplied(h||new r.Matrix4),u.shift()):g=void 0}const f=null==g?void 0:g.find((e=>e.id===d));if(!f)return;const p=new o.GEmptyNodeRef(f,h);p.id=e;const _=a.split("|");return p.setPath(_),p}clone(e){return(new a)._copy(this,e)}getBoundingBox(){return this._cachedBbx||(this._cachedBbx=super.getBoundingBox()),this._cachedBbx}_copy(e,t){return super._copy(e,t),this.elementId=e.elementId,this.category=e.category,this}}t.GRep=a},84983:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GRepRef=t.GEmptyNodeRef=t.getLowLevelGnodeId=void 0;const r=n(98106),s=n(40260),i=n(38675),o=n(27122),a=n(98381),c=n(95829);t.getLowLevelGnodeId=function(e){if(e.includes("|")){const t=e.indexOf("|"),n=e.substring(t+1);return c.DebugWarn.assert(t>-1,"gnode id error"," ","2022-06-01"),`~${n}`}if(e.includes(".")){const t=e.indexOf("."),n=e.substring(t+1);return c.DebugWarn.assert(t>-1,"gnode id error"," ","2022-06-01"),Number.parseInt(n,10)}};class l extends o.GNode{constructor(e,t){super(),this._gnode=e,this._matrix=t,this._path=[],this.visible=e.visible,this.disableGNodeRenderFeature=e.disableGNodeRenderFeature,this.userData=e.userData,this.flags=e.flags}getPath(){return this._path}getElementPath(){return this._path.map((e=>Number.parseInt(e.split("@")[0],10)))}setPath(e){this._path=e}getOriginGNode(){return this._gnode}getMatrix(){return this._matrix||new r.Matrix4}getType(){return i.GNODE_TYPE.GNodeRef}transform(e){return!0}getBoundingBox(){return new r.Box3}intersected(e,t,n){let r,s;if(this._matrix){const t=this._matrix.inversed();c.DebugWarn.assert(t,"矩阵无法求逆?"," ","2020-08-20"),r=e.transformed(t),s=n.vecTransformed(t)}else r=e,s=n;const i=this._gnode.intersected(r,t,s);return this._matrix?null==i?void 0:i.transform(this._matrix):i}clone(){throw new Error("cant clone")}getCurve3ds(e=!1){const t=[],n=this._gnode;return n.getType()===i.GNODE_TYPE.GCurve3d?t.push(n.geo):n.getType()===i.GNODE_TYPE.GEdge?t.push(n.geo.getCurve()):e||n.getType()!==i.GNODE_TYPE.GCurves||t.push(...n.geo),this._matrix&&!this._matrix.isIdentity()?t.map((e=>e.transformed(this._matrix))):t}getFinalPlane(){const e=this.getOriginGNode();if(!e.isGFace())return;const t=e.getFinalPlane();return this._matrix?null==t?void 0:t.transform(this._matrix):t}getSurface(){let e;const t=this._gnode;return t.getType()===i.GNODE_TYPE.GFace?e=t.geo.getSurface():t.getType()===i.GNODE_TYPE.GSurface&&(e=t.geo),e&&this._matrix&&!this._matrix.isIdentity()?e.transformed(this._matrix):e}_toRenderNodeImpl(e){const t=this.getOriginGNode().toRenderNode(e);if(!this._matrix)return t;const n=t.clone();return n.transform(this._matrix),n}}t.GEmptyNodeRef=l;class d extends o.GNode3d{constructor(e,t,n,r){super(),this._grep=e,this._matrix=t,this._gemptyNodeFilter=n,this._overriddenStyle=r,this._curPathId=-1,this._key="0",this._emptyNodes=new Map}static makeGNodeToGRepRef(e,t){const n=new a.GRep;return n.addNode(e),new d(n,t)}static create(e,t,n){const r=new d(e,null==n?void 0:n.matrix,null==n?void 0:n.gemptyNodeFilter,null==n?void 0:n.overriddenStyle);return r._curPathId=t.asInt(),(null==n?void 0:n.key)&&(r._key=n.key),r}getType(){return i.GNODE_TYPE.GRepRef}getTraverseChildren(){return[...this._emptyNodes.values()]}getCurPath(){return this._curPathId}getKey(){return this._key}getOriginGRep(){return this._grep}getMatrix(){return this._matrix}getBoundingBox(){const e=this._grep.getBoundingBox();if(!this._matrix||this._matrix.isIdentity())return e;const t=e.getCornerPts().map((e=>e.transform(this._matrix)));return new r.Box3(t)}transform(e){return this._matrix?this._matrix.preMultiply(e):this._matrix=e,!0}intersected(e,t,n){for(const r of this.getTraverseChildren()){const s=r.intersected(e,t,n);if(s)return s}}clone(){return new d(this._grep,this._matrix)}_toRenderNodeImpl(){const e=new s.RenderGroup;this._emptyNodes.clear();return this._grep.toRenderNode().traverse((t=>{var n,r,i,o,a,d,u;if(t instanceof s.RenderGroup)return;let h=this._matrix,g=t.gnode;c.DebugWarn.assert(g,"没有找到gnode"," ","2020-08-19");const f=[`${this._curPathId>-1?this._curPathId:null===(n=this.elementId)||void 0===n?void 0:n.asInt()}@${this._key}`];if(g instanceof l){f.push(...g.getPath());const e=g.getMatrix();e&&(h=h?h.multiplied(e):e),g=g.getOriginGNode()}const p=new l(g,h);if(p.id=`~${f.join("|")}.${g.id}`,p.setPath(f),p.parent=this,this._gemptyNodeFilter&&!this._gemptyNodeFilter(p))return;this._emptyNodes.set(p.globalID,p),p.parent=this;const _=t.clone();if(_.setID(p.globalID),_.gnode=p,this._matrix&&_.transform(this._matrix),this._overriddenStyle)try{const e=JSON.parse(JSON.stringify(_.style));(null===(r=this._overriddenStyle)||void 0===r?void 0:r.point)&&(e.point=e.point||{},Object.assign(e.point,null===(i=this._overriddenStyle)||void 0===i?void 0:i.point)),(null===(o=this._overriddenStyle)||void 0===o?void 0:o.line)&&(e.line=e.line||{},Object.assign(e.line,null===(a=this._overriddenStyle)||void 0===a?void 0:a.line)),(null===(d=this._overriddenStyle)||void 0===d?void 0:d.face)&&(e.face=e.face||{},Object.assign(e.face,null===(u=this._overriddenStyle)||void 0===u?void 0:u.face)),_.style=e}catch(e){}e.add(_)})),e.setID(this.globalID),e}}t.GRepRef=d},40155:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GSurface=void 0;const r=n(98106),s=n(95829),i=n(40260),o=n(27122),a=n(88583),c=n(40095),l=n(38675),d=n(67821);class u extends o.GNode3d{constructor(e){super(),this.geo=e}getType(){return l.GNODE_TYPE.GSurface}getBoundingBox(){return this.geo.getBoundingBox()}transform(e){return!!this.geo.transform(e)}intersected(e,t,n){const s=this.geo.clone();if(n){const t=c.generateRay(e,n),i=r.MathAlg.CalculateIntersect.curveSurface(t,s);if(i.length>0){const e=i[0];try{if(s.containsPoint(e)&&t.containsProjectedPt(e))return e}catch(e){r.Log.e([s],"face 不合法")}}}else{if(r.MathAlg.CalculateDistance.pointToSurface(e,s)<t)return e}}clone(e){return new u(e?this.geo.clone():this.geo)}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=a.getFaceStyle(this.getStyle())),this}_toRenderNodeImpl(e){const t=new i.RenderMesh;try{const n=this.geo.tessellate(!1,e),{vertices:r,faces:s,normals:i,uvs:o}=n.mesh;t.setVerts(r.map((([e,t,n])=>({x:e,y:t,z:n})))),s&&t.setIndices(s),i&&t.setNormals(i.map((([e,t,n])=>({x:e,y:t,z:n})))),o&&d.setUVToRenderMesh(this.doc,o,this.getStyle().face,t)}catch(e){s.DebugWarn.warn(!1,"invalid GSurface","","")}return t.style=a.getFaceStyle(this.getStyle()),t.userData=this.userData,t}}t.GSurface=u},98193:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GText3d=void 0;const r=n(98106),s=n(40260),i=n(27122),o=n(88583),a=n(38675);class c extends i.GNode3d{constructor(e,t){super(),this.text=e,this.position=r.Vector3.O(),t&&(this.position=t)}getType(){return a.GNODE_TYPE.GText3d}getBoundingBox(){return new r.Box3}transform(e){return!!this.position.transform(e)}intersected(e,t,n){}clone(){return new c(this.text)._copy(this)}setStyle(e){return super.setStyle(e),this._renderNode&&(this._renderNode.style=o.getTextStyle(this.getStyle())),this}_toRenderNodeImpl(){const e=new s.RenderText;return e.text=this.text,e.style=o.getTextStyle(this.getStyle()),e.position=this.position.toXYZ(),e}_copy(e){return super._copy(e),this.position=e.position.clone(),this}}t.GText3d=c},88583:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFaceStyle=t.getLineStyle=t.getPointStyle=t.getTextStyle=void 0;const r=n(26874),s={default_style_opacity:1,default_style_text_size:.32,default_style_text_color:0,default_style_point_size:8,point_size_gpu_pick_context:2,default_style_point_color:0,default_style_line_width:1,default_style_line_color:0,default_style_face_color:8421504,default_style_face_texture:"",default_style_dashed_line_dash_size:3,default_style_dashed_line_gap_size:1};t.getTextStyle=function(e={}){return e.text?{text:{opacity:r.isNumber(e.text.opacity)?e.text.opacity:s.default_style_opacity,size:r.isNumber(e.text.size)?e.text.size:s.default_style_text_size,color:r.isNumber(e.text.color)?e.text.color:s.default_style_text_color,nostroke:e.text.nostroke}}:{text:{opacity:s.default_style_opacity,size:s.default_style_text_size,color:s.default_style_text_color}}},t.getPointStyle=function(e={}){return e.point?{point:{opacity:r.isNumber(e.point.opacity)?e.point.opacity:s.default_style_opacity,size:r.isNumber(e.point.size)?e.point.size:s.default_style_point_size,color:r.isNumber(e.point.color)?e.point.color:s.default_style_point_color}}:{point:{opacity:s.default_style_opacity,size:s.default_style_point_size,color:s.default_style_point_color}}},t.getLineStyle=function(e={}){return e.line?{line:{opacity:r.isNumber(e.line.opacity)?e.line.opacity:s.default_style_opacity,color:r.isNumber(e.line.color)?e.line.color:s.default_style_line_color,width:e.line.width?e.line.width:s.default_style_line_width,dotted:!!e.line.dotted&&e.line.dotted,dashSize:e.line.dashSize?e.line.dashSize:s.default_style_dashed_line_dash_size,gapSize:e.line.gapSize?e.line.gapSize:s.default_style_dashed_line_gap_size,depthWrite:e.line.depthWrite,fatLineStyle:e.line.fatLineStyle}}:{line:{opacity:s.default_style_opacity,color:s.default_style_line_color,width:s.default_style_line_width,dotted:!1,dashSize:s.default_style_dashed_line_dash_size,gapSize:s.default_style_dashed_line_gap_size}}},t.getFaceStyle=function(e={}){var t;const n=Object.assign({},e.face);return n&&(n.opacity=r.isNumber(n.opacity)?n.opacity:s.default_style_opacity,n.color=null!==(t=n.color)&&void 0!==t?t:s.default_style_face_color,n.texture=n.texture||s.default_style_face_texture,n.depthWrite=!1!==n.depthWrite,n.doubleSide=!(!1===n.doubleSide)),{face:n}}},31667:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.getGNodeIdFromGeo=t.taggedTopoNameToGeo=t.taggedGNodeIdToGeo=t.symbolGNodeId=t.isTopoNameValid=t.symbolTopoName=t.GPoint3d=t.GPoint2d=t.getFaceStyle=t.GNodeKey=t.GNODE_TYPE=t.GRep=t.GGroup3d=t.GGeoNode2d=t.GNode3d=t.GNode=t.ModelView=t.TransactionGroup=t.Transaction=t.TmpElement=t.JsonUtil=t.FileUtil=t.DocSaver=t.TDocument=t.ElementId=t.CategoryUniqueElement=t.Category=t.elementMeta=t.getElementSerialId=t.AngleMeasureSystem=t.LinearMeasureSystem=t.Dimension=t.CtrlPoint=t.AuxElement=t.Element=t.MathCommonObj=t.DBElement=t.JsonData=t.setUVToRenderMesh=t.addAxis=t.AddGridHelper=t.rgbToHex=t.isNumber=t.intToCssColor=t.colorStr2Hex=t.Short=t.brep=t.math=t.graphlib=t.axios=void 0,t.syncTransact=t.transact=t.WorkPlane=t.UniqueElement=t.UniqueElementUtil=t.FlagTester=t.Flags=t.EN_CATEGORY_IDS=t.CategoryGrepKeepElement=t.RayToCurve3dDistance=t.DebugWarn=t.EN_EVENT_TYPE=t.Selection=t.HighLight=t.eventManager=t.SnappeddEvent=t.MessageEvent=t.SelectionEvent=t.ElementEvent=t.CmdFinishedEvent=t.EventManagerGeneric=t.EventManager=t.Event=t.EN_RENDER_AREA=t.IRender=t.CameraInfo=t.RenderText=t.EN_RNODE_TYPE=t.RenderEdge=t.RenderPoint=t.RenderNode=t.RenderMesh=t.RenderGroup=t.getLowLevelGnodeId=t.GEmptyNodeRef=t.GRepRef=t.GText3d=t.GMesh=t.GBody=t.GSurface=t.GFace=t.GEdge=t.GCurves=t.GCurve3d=t.GCurve2d=t.resetDBProperties=t.askForGNodeId=t.makeDefaultTopoFindFunc=t.defaultTopoFind=t.getTopoNameFromGeo=void 0,t.InstanceGRepCalculator=t.FamilyService=t.DBInstance=t.Instance=t.ElementCustomizedBase=t.GrepKeepElement=t.WorkPlaneUE=t.DataStoreElement=t.TransformedGRepCalculator=t.DBTransformableElement=t.TransformableElement=t.EN_TRANSFORM_TYPE=t.getPmFileBySeekIdSync=t.getPmFileBySeekIdAsync=t.doNothing=t.sleep=t.symbolOriginUVBox=t.ENUM_COLOR_MODE=t.ENUM_PAVE_METHOD=t.RedoCmd=t.UndoCmd=t.CategoryForm=t.categoryForm=t.GBodyUtil=t.ElementIdEvent=t.FamilyDeleteEvent=t.Unit=t.FamilyLoadEvent=t.globalURLTranformer=t.ModelCmdIds=t.registerCmd=t.CmdManager=t.Cmd=t.Loader=t.ResourceCache=t.DocumentManager=t.keyOf=t.TmpElementPainter=t.PropertyIdUtil=t.PropertyId=t.BaseCalculator=t.SimpleCalculator=t.EN_SIMPLE_CALC_OPERATION=t.CalculatorMgr=t.categoryTmpElement=t.categoryModelView=t.categoryModelLine=t.categoryInvalid=void 0,n(25008);const i=n(98106);t.math=i;const o=n(3319);t.brep=o;const a=n(42704);t.Short=a;const c=n(44567);t.graphlib=c;const l=n(30083);t.axios=l.default;var d=n(26874);Object.defineProperty(t,"colorStr2Hex",{enumerable:!0,get:function(){return d.colorStr2Hex}}),Object.defineProperty(t,"intToCssColor",{enumerable:!0,get:function(){return d.intToCssColor}}),Object.defineProperty(t,"isNumber",{enumerable:!0,get:function(){return d.isNumber}}),Object.defineProperty(t,"rgbToHex",{enumerable:!0,get:function(){return d.rgbToHex}}),Object.defineProperty(t,"AddGridHelper",{enumerable:!0,get:function(){return d.AddGridHelper}}),Object.defineProperty(t,"addAxis",{enumerable:!0,get:function(){return d.addAxis}});var u=n(67821);Object.defineProperty(t,"setUVToRenderMesh",{enumerable:!0,get:function(){return u.setUVToRenderMesh}});var h=n(7758);Object.defineProperty(t,"JsonData",{enumerable:!0,get:function(){return h.JsonData}});var g=n(61962);Object.defineProperty(t,"DBElement",{enumerable:!0,get:function(){return g.DBElement}});var f=n(52807);Object.defineProperty(t,"MathCommonObj",{enumerable:!0,get:function(){return f.MathCommonObj}});var p=n(6218);Object.defineProperty(t,"Element",{enumerable:!0,get:function(){return p.Element}});var _=n(56327);Object.defineProperty(t,"AuxElement",{enumerable:!0,get:function(){return _.AuxElement}});var m=n(73872);Object.defineProperty(t,"CtrlPoint",{enumerable:!0,get:function(){return m.CtrlPoint}});var v=n(98255);Object.defineProperty(t,"Dimension",{enumerable:!0,get:function(){return v.Dimension}});var E=n(78568);Object.defineProperty(t,"LinearMeasureSystem",{enumerable:!0,get:function(){return E.LinearMeasureSystem}}),Object.defineProperty(t,"AngleMeasureSystem",{enumerable:!0,get:function(){return E.AngleMeasureSystem}});var P=n(56943);Object.defineProperty(t,"getElementSerialId",{enumerable:!0,get:function(){return P.getElementSerialId}});var y=n(45712);Object.defineProperty(t,"elementMeta",{enumerable:!0,get:function(){return y.elementMeta}});var C=n(96080);Object.defineProperty(t,"Category",{enumerable:!0,get:function(){return C.Category}});var S=n(23614);Object.defineProperty(t,"CategoryUniqueElement",{enumerable:!0,get:function(){return S.CategoryUniqueElement}});var T=n(18064);Object.defineProperty(t,"ElementId",{enumerable:!0,get:function(){return T.ElementId}});var b=n(64323);Object.defineProperty(t,"TDocument",{enumerable:!0,get:function(){return b.TDocument}});var w=n(62891);Object.defineProperty(t,"DocSaver",{enumerable:!0,get:function(){return w.DocSaver}});var x=n(15119);Object.defineProperty(t,"FileUtil",{enumerable:!0,get:function(){return x.FileUtil}});var M=n(46804);Object.defineProperty(t,"JsonUtil",{enumerable:!0,get:function(){return M.JsonUtil}});var N=n(10325);Object.defineProperty(t,"TmpElement",{enumerable:!0,get:function(){return N.TmpElement}});var A=n(17731);Object.defineProperty(t,"Transaction",{enumerable:!0,get:function(){return A.Transaction}});var O=n(50412);Object.defineProperty(t,"TransactionGroup",{enumerable:!0,get:function(){return O.TransactionGroup}});var I=n(69042);Object.defineProperty(t,"ModelView",{enumerable:!0,get:function(){return I.ModelView}});var D=n(27122);Object.defineProperty(t,"GNode",{enumerable:!0,get:function(){return D.GNode}}),Object.defineProperty(t,"GNode3d",{enumerable:!0,get:function(){return D.GNode3d}});var L=n(15204);Object.defineProperty(t,"GGeoNode2d",{enumerable:!0,get:function(){return L.GGeoNode2d}});var V=n(67549);Object.defineProperty(t,"GGroup3d",{enumerable:!0,get:function(){return V.GGroup3d}});var R=n(98381);Object.defineProperty(t,"GRep",{enumerable:!0,get:function(){return R.GRep}});var U=n(38675);Object.defineProperty(t,"GNODE_TYPE",{enumerable:!0,get:function(){return U.GNODE_TYPE}});var B=n(95266);Object.defineProperty(t,"GNodeKey",{enumerable:!0,get:function(){return B.GNodeKey}});var F=n(88583);Object.defineProperty(t,"getFaceStyle",{enumerable:!0,get:function(){return F.getFaceStyle}});var k=n(88324);Object.defineProperty(t,"GPoint2d",{enumerable:!0,get:function(){return k.GPoint2d}});var G=n(25214);Object.defineProperty(t,"GPoint3d",{enumerable:!0,get:function(){return G.GPoint3d}});var j=n(7684);Object.defineProperty(t,"symbolTopoName",{enumerable:!0,get:function(){return j.symbolTopoName}}),Object.defineProperty(t,"isTopoNameValid",{enumerable:!0,get:function(){return j.isTopoNameValid}}),Object.defineProperty(t,"symbolGNodeId",{enumerable:!0,get:function(){return j.symbolGNodeId}}),Object.defineProperty(t,"taggedGNodeIdToGeo",{enumerable:!0,get:function(){return j.taggedGNodeIdToGeo}}),Object.defineProperty(t,"taggedTopoNameToGeo",{enumerable:!0,get:function(){return j.taggedTopoNameToGeo}}),Object.defineProperty(t,"getGNodeIdFromGeo",{enumerable:!0,get:function(){return j.getGNodeIdFromGeo}}),Object.defineProperty(t,"getTopoNameFromGeo",{enumerable:!0,get:function(){return j.getTopoNameFromGeo}});var z=n(56183);Object.defineProperty(t,"defaultTopoFind",{enumerable:!0,get:function(){return z.defaultTopoFind}}),Object.defineProperty(t,"makeDefaultTopoFindFunc",{enumerable:!0,get:function(){return z.makeDefaultTopoFindFunc}});var W=n(40415);Object.defineProperty(t,"askForGNodeId",{enumerable:!0,get:function(){return W.askForGNodeId}});var q=n(45164);Object.defineProperty(t,"resetDBProperties",{enumerable:!0,get:function(){return q.resetDBProperties}});var H=n(87346);Object.defineProperty(t,"GCurve2d",{enumerable:!0,get:function(){return H.GCurve2d}});var Y=n(66480);Object.defineProperty(t,"GCurve3d",{enumerable:!0,get:function(){return Y.GCurve3d}});var X=n(34558);Object.defineProperty(t,"GCurves",{enumerable:!0,get:function(){return X.GCurves}});var J=n(22276);Object.defineProperty(t,"GEdge",{enumerable:!0,get:function(){return J.GEdge}});var K=n(48076);Object.defineProperty(t,"GFace",{enumerable:!0,get:function(){return K.GFace}});var Z=n(40155);Object.defineProperty(t,"GSurface",{enumerable:!0,get:function(){return Z.GSurface}});var $=n(24357);Object.defineProperty(t,"GBody",{enumerable:!0,get:function(){return $.GBody}});var Q=n(75707);Object.defineProperty(t,"GMesh",{enumerable:!0,get:function(){return Q.GMesh}});var ee=n(98193);Object.defineProperty(t,"GText3d",{enumerable:!0,get:function(){return ee.GText3d}});var te=n(84983);Object.defineProperty(t,"GRepRef",{enumerable:!0,get:function(){return te.GRepRef}}),Object.defineProperty(t,"GEmptyNodeRef",{enumerable:!0,get:function(){return te.GEmptyNodeRef}}),Object.defineProperty(t,"getLowLevelGnodeId",{enumerable:!0,get:function(){return te.getLowLevelGnodeId}});var ne=n(40260);Object.defineProperty(t,"RenderGroup",{enumerable:!0,get:function(){return ne.RenderGroup}}),Object.defineProperty(t,"RenderMesh",{enumerable:!0,get:function(){return ne.RenderMesh}}),Object.defineProperty(t,"RenderNode",{enumerable:!0,get:function(){return ne.RenderNode}}),Object.defineProperty(t,"RenderPoint",{enumerable:!0,get:function(){return ne.RenderPoint}}),Object.defineProperty(t,"RenderEdge",{enumerable:!0,get:function(){return ne.RenderEdge}});var re=n(40260);Object.defineProperty(t,"EN_RNODE_TYPE",{enumerable:!0,get:function(){return re.EN_RNODE_TYPE}}),Object.defineProperty(t,"RenderText",{enumerable:!0,get:function(){return re.RenderText}});var se=n(67283);Object.defineProperty(t,"CameraInfo",{enumerable:!0,get:function(){return se.CameraInfo}}),Object.defineProperty(t,"IRender",{enumerable:!0,get:function(){return se.IRender}});var ie=n(22530);Object.defineProperty(t,"EN_RENDER_AREA",{enumerable:!0,get:function(){return ie.EN_RENDER_AREA}});var oe=n(63912);Object.defineProperty(t,"Event",{enumerable:!0,get:function(){return oe.Event}}),Object.defineProperty(t,"EventManager",{enumerable:!0,get:function(){return oe.EventManager}}),Object.defineProperty(t,"EventManagerGeneric",{enumerable:!0,get:function(){return oe.EventManagerGeneric}}),Object.defineProperty(t,"CmdFinishedEvent",{enumerable:!0,get:function(){return oe.CmdFinishedEvent}}),Object.defineProperty(t,"ElementEvent",{enumerable:!0,get:function(){return oe.ElementEvent}}),Object.defineProperty(t,"SelectionEvent",{enumerable:!0,get:function(){return oe.SelectionEvent}}),Object.defineProperty(t,"MessageEvent",{enumerable:!0,get:function(){return oe.MessageEvent}}),Object.defineProperty(t,"SnappeddEvent",{enumerable:!0,get:function(){return oe.SnappeddEvent}}),Object.defineProperty(t,"eventManager",{enumerable:!0,get:function(){return oe.eventManager}}),s(n(55751),t);var ae=n(26452);Object.defineProperty(t,"HighLight",{enumerable:!0,get:function(){return ae.HighLight}});var ce=n(21498);Object.defineProperty(t,"Selection",{enumerable:!0,get:function(){return ce.Selection}});var le=n(55083);Object.defineProperty(t,"EN_EVENT_TYPE",{enumerable:!0,get:function(){return le.EN_EVENT_TYPE}});var de=n(95829);Object.defineProperty(t,"DebugWarn",{enumerable:!0,get:function(){return de.DebugWarn}});var ue=n(21282);Object.defineProperty(t,"RayToCurve3dDistance",{enumerable:!0,get:function(){return ue.RayToCurve3dDistance}});var he=n(48451);Object.defineProperty(t,"CategoryGrepKeepElement",{enumerable:!0,get:function(){return he.CategoryGrepKeepElement}});var ge=n(59853);Object.defineProperty(t,"EN_CATEGORY_IDS",{enumerable:!0,get:function(){return ge.EN_CATEGORY_IDS}});var fe=n(21032);Object.defineProperty(t,"Flags",{enumerable:!0,get:function(){return fe.Flags}}),Object.defineProperty(t,"FlagTester",{enumerable:!0,get:function(){return fe.FlagTester}});var pe=n(37509);Object.defineProperty(t,"UniqueElementUtil",{enumerable:!0,get:function(){return pe.UniqueElementUtil}});var _e=n(25981);Object.defineProperty(t,"UniqueElement",{enumerable:!0,get:function(){return _e.UniqueElement}});var me=n(47475);Object.defineProperty(t,"WorkPlane",{enumerable:!0,get:function(){return me.WorkPlane}});var ve=n(41207);Object.defineProperty(t,"transact",{enumerable:!0,get:function(){return ve.transact}}),Object.defineProperty(t,"syncTransact",{enumerable:!0,get:function(){return ve.syncTransact}});var Ee=n(59660);Object.defineProperty(t,"categoryInvalid",{enumerable:!0,get:function(){return Ee.categoryInvalid}});var Pe=n(12475);Object.defineProperty(t,"categoryModelLine",{enumerable:!0,get:function(){return Pe.categoryModelLine}});var ye=n(13524);Object.defineProperty(t,"categoryModelView",{enumerable:!0,get:function(){return ye.categoryModelView}});var Ce=n(60472);Object.defineProperty(t,"categoryTmpElement",{enumerable:!0,get:function(){return Ce.categoryTmpElement}});var Se=n(24611);Object.defineProperty(t,"CalculatorMgr",{enumerable:!0,get:function(){return Se.CalculatorMgr}});var Te=n(57607);Object.defineProperty(t,"EN_SIMPLE_CALC_OPERATION",{enumerable:!0,get:function(){return Te.EN_SIMPLE_CALC_OPERATION}}),Object.defineProperty(t,"SimpleCalculator",{enumerable:!0,get:function(){return Te.SimpleCalculator}});var be=n(79500);Object.defineProperty(t,"BaseCalculator",{enumerable:!0,get:function(){return be.BaseCalculator}});var we=n(29955);Object.defineProperty(t,"PropertyId",{enumerable:!0,get:function(){return we.PropertyId}});var xe=n(12239);Object.defineProperty(t,"PropertyIdUtil",{enumerable:!0,get:function(){return xe.PropertyIdUtil}});var Me=n(26762);Object.defineProperty(t,"TmpElementPainter",{enumerable:!0,get:function(){return Me.TmpElementPainter}});var Ne=n(95031);Object.defineProperty(t,"keyOf",{enumerable:!0,get:function(){return Ne.keyOf}});var Ae=n(38977);Object.defineProperty(t,"DocumentManager",{enumerable:!0,get:function(){return Ae.DocumentManager}});var Oe=n(25332);Object.defineProperty(t,"ResourceCache",{enumerable:!0,get:function(){return Oe.ResourceCache}});var Ie=n(23654);Object.defineProperty(t,"Loader",{enumerable:!0,get:function(){return Ie.Loader}});var De=n(83385);Object.defineProperty(t,"Cmd",{enumerable:!0,get:function(){return De.Cmd}});var Le=n(43775);Object.defineProperty(t,"CmdManager",{enumerable:!0,get:function(){return Le.CmdManager}});var Ve=n(45084);Object.defineProperty(t,"registerCmd",{enumerable:!0,get:function(){return Ve.registerCmd}});var Re=n(66250);Object.defineProperty(t,"ModelCmdIds",{enumerable:!0,get:function(){return Re.ModelCmdIds}});var Ue=n(21345);Object.defineProperty(t,"globalURLTranformer",{enumerable:!0,get:function(){return Ue.globalURLTranformer}});var Be=n(63912);Object.defineProperty(t,"FamilyLoadEvent",{enumerable:!0,get:function(){return Be.FamilyLoadEvent}});var Fe=n(92839);Object.defineProperty(t,"Unit",{enumerable:!0,get:function(){return Fe.Unit}});var ke=n(63912);Object.defineProperty(t,"FamilyDeleteEvent",{enumerable:!0,get:function(){return ke.FamilyDeleteEvent}}),Object.defineProperty(t,"ElementIdEvent",{enumerable:!0,get:function(){return ke.ElementIdEvent}});var Ge=n(83384);Object.defineProperty(t,"GBodyUtil",{enumerable:!0,get:function(){return Ge.GBodyUtil}});var je=n(32730);Object.defineProperty(t,"categoryForm",{enumerable:!0,get:function(){return je.categoryForm}});var ze=n(32730);Object.defineProperty(t,"CategoryForm",{enumerable:!0,get:function(){return ze.CategoryForm}});var We=n(20591);Object.defineProperty(t,"UndoCmd",{enumerable:!0,get:function(){return We.UndoCmd}}),Object.defineProperty(t,"RedoCmd",{enumerable:!0,get:function(){return We.RedoCmd}});var qe=n(51923);Object.defineProperty(t,"ENUM_PAVE_METHOD",{enumerable:!0,get:function(){return qe.ENUM_PAVE_METHOD}}),Object.defineProperty(t,"ENUM_COLOR_MODE",{enumerable:!0,get:function(){return qe.ENUM_COLOR_MODE}}),Object.defineProperty(t,"symbolOriginUVBox",{enumerable:!0,get:function(){return qe.symbolOriginUVBox}});var He=n(26874);Object.defineProperty(t,"sleep",{enumerable:!0,get:function(){return He.sleep}}),Object.defineProperty(t,"doNothing",{enumerable:!0,get:function(){return He.doNothing}});var Ye=n(96869);Object.defineProperty(t,"getPmFileBySeekIdAsync",{enumerable:!0,get:function(){return Ye.getPmFileBySeekIdAsync}}),Object.defineProperty(t,"getPmFileBySeekIdSync",{enumerable:!0,get:function(){return Ye.getPmFileBySeekIdSync}});var Xe=n(99091);Object.defineProperty(t,"EN_TRANSFORM_TYPE",{enumerable:!0,get:function(){return Xe.EN_TRANSFORM_TYPE}});var Je=n(55252);Object.defineProperty(t,"TransformableElement",{enumerable:!0,get:function(){return Je.TransformableElement}});var Ke=n(11706);Object.defineProperty(t,"DBTransformableElement",{enumerable:!0,get:function(){return Ke.DBTransformableElement}});var Ze=n(45975);Object.defineProperty(t,"TransformedGRepCalculator",{enumerable:!0,get:function(){return Ze.TransformedGRepCalculator}});var $e=n(8217);Object.defineProperty(t,"DataStoreElement",{enumerable:!0,get:function(){return $e.DataStoreElement}});var Qe=n(90701);Object.defineProperty(t,"WorkPlaneUE",{enumerable:!0,get:function(){return Qe.WorkPlaneUE}});var et=n(30191);Object.defineProperty(t,"GrepKeepElement",{enumerable:!0,get:function(){return et.GrepKeepElement}});var tt=n(64282);Object.defineProperty(t,"ElementCustomizedBase",{enumerable:!0,get:function(){return tt.ElementCustomizedBase}});var nt=n(50548);Object.defineProperty(t,"Instance",{enumerable:!0,get:function(){return nt.Instance}});var rt=n(35356);Object.defineProperty(t,"DBInstance",{enumerable:!0,get:function(){return rt.DBInstance}});var st=n(90712);Object.defineProperty(t,"FamilyService",{enumerable:!0,get:function(){return st.FamilyService}});var it=n(12918);Object.defineProperty(t,"InstanceGRepCalculator",{enumerable:!0,get:function(){return it.InstanceGRepCalculator}})},25332:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResourceCache=void 0;t.ResourceCache=class{constructor(){this._elementId2Key=new Map}deleteCacheByElementId(e){const t=this._elementId2Key.get(e);t&&(this._elementId2Key.delete(e),Array.from(this._elementId2Key.values()).includes(t)||t&&this._deleteCache(t))}get(e,t){const n=this._getCacheKey(e,t);if(n)return this._doGet(n,t)}set(e,t,n){const r=this._getCacheKey(e,n);r&&this._doSet(r,t,n)}_doSet(e,t,n){n&&n.elementId&&this._elementId2Key.set(n.elementId,e)}_doGet(e,t){t&&t.elementId&&!this._elementId2Key.has(t.elementId)&&this._elementId2Key.set(t.elementId,e)}_getCacheKey(e,t={}){if(!t.skipCache)return t.cacheKey?t.cacheKey:this._doGenerateCacheKey(e)}_doGenerateCacheKey(e){return e}}},23654:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Loader=void 0;t.Loader=class{constructor(e){this._cache=e}load(e,t){const n=this.getFromCache(e,t);if(n)return n;const r=this.doLoad(e,t).then((e=>e));return this._cache.set(e,r,t),r}getFromCache(e,t){return this._cache.get(e,t)}clearCache(){this._cache.clear()}}},21345:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.globalURLTranformer=void 0;t.globalURLTranformer=new class{transform(e){var t;return(null===(t=this._transformFunc)||void 0===t?void 0:t.call(this,e))||e}setTransformFunc(e){this._transformFunc=e}}},92839:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Unit=void 0;class n{static ConvertToMeter(e,t){return Number(t)*n.ConvertToMeterFactor[e.toLowerCase()]}static ConvertToMilliMeter(e,t){return Number(t)*n.ConvertToMeterFactor[e.toLowerCase()]*1e3}}t.Unit=n,n.ConvertToMeterFactor={feet:.3048,ft:.3048,inches:.0254,in:.0254,cm:.01,dm:.1,m:1,km:1e3,mm:.001,meters:1,centimeters:.01,kilometers:1e3,millimeters:.001}},67283:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IRender=t.CameraInfo=void 0;const r=n(98106),s=n(22530);t.CameraInfo=class{constructor(){this.top=0,this.left=this.top,this.bottom=1,this.right=this.bottom,this.near=.1,this.far=2e3,this.fov=60,this.orthogonal=!0,this.pixelToWorldScale=1,this.position=new r.Vector3,this.forwardVector=new r.Vector3,this.matrixView=new r.Matrix4,this.matrixProjection=new r.Matrix4}};class i{constructor(){this.id=0,this._renderFeature={geometry:"real"},i._idTotal++,this.id=i._idTotal}get renderFeature(){return this._renderFeature}set renderFeature(e){this.renderFeature.geometry!==e.geometry&&(this._renderFeature={geometry:e.geometry},this._updateViewWithRenderFeature())}clearSelection(){this.clearRenderArea(s.EN_RENDER_AREA.SELECTION)}clearHighlight(){this.clearRenderArea(s.EN_RENDER_AREA.ACTIVE)}updateElementTransformationDynamic(e,t){}updateElementVisible(e,t){}render(){}isSync(){return!0}set camera(e){this._viewCamera=e}get camera(){return this._viewCamera}}t.IRender=i,i._idTotal=0},22530:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_RENDER_AREA=void 0,function(e){e[e.BASE=0]="BASE",e[e.MODEL=1]="MODEL",e[e.ACTIVE=2]="ACTIVE",e[e.SELECTION=3]="SELECTION",e[e.OVERLAY=4]="OVERLAY",e[e.___COUNT=5]="___COUNT"}(t.EN_RENDER_AREA||(t.EN_RENDER_AREA={}))},40260:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RenderGroup=t.RenderText=t.RenderMesh=t.RenderEdge=t.RenderPoint=t.RenderNode=t.EN_RNODE_TYPE=void 0;const r=n(98106),s=n(21032);var i;!function(e){e[e.UNKOWN=0]="UNKOWN",e[e.POINT=1]="POINT",e[e.EDGE=2]="EDGE",e[e.FACE=3]="FACE",e[e.MESH=4]="MESH",e[e.GROUP=5]="GROUP",e[e.TEXT=6]="TEXT",e[e.SPRITE=7]="SPRITE",e[e.MODEL=8]="MODEL"}(i=t.EN_RNODE_TYPE||(t.EN_RNODE_TYPE={}));class o{constructor(){this.type=i.UNKOWN}get globalID(){return this._globalID}set globalID(e){this._globalID=e}setVisible(e){e?this.flags=s.FlagTester.setFlag(this.flags,s.Flags.RENDER):s.FlagTester.clearFlag(this.flags,s.Flags.RENDER)}setID(e){this._globalID=e}isVisible(){return s.FlagTester.renderable(this.flags)}canPick(){return s.FlagTester.gpuSelectable(this.flags)}copyWorldMatrix(e){this.globalMatrix=void 0,e&&!e.isIdentity()&&(this.globalMatrix=e)}transform(e){this.globalMatrix?this.globalMatrix=this.globalMatrix.preMultiplied(e):this.globalMatrix=e}traverse(e){e(this),this instanceof u&&this.children.forEach((t=>{t.traverse(e)}))}_cloneByCtor(e){const t=new e;return this._copyDataTo(t)}_copyDataTo(e){const t="style";for(const n of Reflect.ownKeys(this))n===t?e[t]=Object.assign({},this[t]):"globalMatrix"===n?this.globalMatrix?e.globalMatrix=this.globalMatrix.clone():e.globalMatrix=void 0:e[n]=this[n];return e}}t.RenderNode=o;class a extends o{constructor(){super(...arguments),this.type=i.POINT}setColor(e){this.style&&this.style.point&&(this.style.point.color=e)}clone(){return this._cloneByCtor(a)}}t.RenderPoint=a;class c extends o{constructor(){super(...arguments),this.type=i.EDGE}clone(){return this._cloneByCtor(c)}}t.RenderEdge=c;class l extends o{constructor(){super(...arguments),this.type=i.MESH}setVerts(e){if(e instanceof Float32Array)this._verts=e;else{this._verts=new Float32Array(3*e.length);for(let t=0;t<e.length;t++)this._verts[3*t]=e[t].x,this._verts[3*t+1]=e[t].y,this._verts[3*t+2]=e[t].z}}setIndices(e){if(e instanceof Uint32Array)this._indices=e;else{this._indices=new Uint32Array(3*e.length);for(let t=0;t<e.length;t++)this._indices[3*t]=e[t][0],this._indices[3*t+1]=e[t][1],this._indices[3*t+2]=e[t][2]}}setNormals(e){if(e instanceof Float32Array)this._normals=e;else{this._normals=new Float32Array(3*e.length);for(let t=0;t<e.length;t++)this._normals[3*t]=e[t].x,this._normals[3*t+1]=e[t].y,this._normals[3*t+2]=e[t].z}}setUVs(e){if(e instanceof Float32Array)this._uvs=e;else{this._uvs=new Float32Array(2*e.length);for(let t=0;t<e.length;t++)this._uvs[2*t]=e[t].x,this._uvs[2*t+1]=e[t].y}}getVertexes(){if(!this._verts)return[];const e=[];for(let t=0;t<this._verts.length/3;t++)e.push(new r.Vector3(this._verts[3*t],this._verts[3*t+1],this._verts[3*t+2]));return e}getVerts(){return this._verts?this._verts:new Float32Array}getIndices(){return this._indices?this._indices:new Uint32Array}getNormals(){return this._normals?this._normals:new Float32Array}getUVs(){return this._uvs?this._uvs:new Float32Array}setColor(e){this.style.face&&(this.style.face.color=e)}clone(){return this._cloneByCtor(l)}cloneDeep(){const e=this._cloneByCtor(l);return e.setVerts(Float32Array.from(this._verts||[])),e.setNormals(Float32Array.from(this._normals||[])),e.setUVs(Float32Array.from(this._uvs||[])),e.setIndices(Uint32Array.from(this._indices||[])),e}merge(e){if(!e.getVerts().length)return;const t=Array.from(this._verts||[]),n=t.length/3,r=Array.from(e.getVerts());t.push(...r);const s=Array.from(this._normals||[]),i=Array.from(e.getNormals());s.push(...i);const o=Array.from(this._uvs||[]),a=Array.from(e.getUVs());o.push(...a);const c=Array.from(this._indices||[]);let l=Array.from(e.getIndices());l=l.map((e=>e+n)),c.push(...l),this._verts=new Float32Array(t),this._normals=new Float32Array(s),this._uvs=new Float32Array(o),this._indices=new Uint32Array(c)}}t.RenderMesh=l;class d extends o{constructor(){super(...arguments),this.opacity=1,this.type=i.TEXT}setColor(e){this.style.text&&(this.style.text.color=e)}clone(){return this._cloneByCtor(d)}}t.RenderText=d;class u extends o{constructor(){super(...arguments),this.children=[],this.type=i.GROUP}add(e){this.children.push(e)}setVisible(e){super.setVisible(e),this.children.forEach((t=>t.setVisible(e)))}transform(e){this.children.forEach((t=>t.transform(e)))}clone(){const e=new u;return e.elementId=this.elementId,this.globalMatrix&&(e.globalMatrix=this.globalMatrix.clone()),e.setID(this.globalID),this.children.forEach((t=>{e.add(t.clone())})),e}removeAll(e){for(let t=0;t<this.children.length;t++)this.children[t]instanceof u?this.children[t].removeAll(e):this.children[t]instanceof e&&(this.children.splice(t,1),t--)}getAll(e){const t=[];for(const n of this.children)n instanceof u?t.push(...n.getAll(e)):n instanceof e&&t.push(n);return t}}t.RenderGroup=u},26452:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HighLight=void 0;const r=n(55083),s=n(63912);class i{constructor(){this._selectedIds=new Set}static getInstance(){return i._instance||(i._instance=new i,s.eventManager.addEventListener(r.EN_EVENT_TYPE.DOCUMENT_CREATED,i._instance._onDocumentCreatedOrOpened),s.eventManager.addEventListener(r.EN_EVENT_TYPE.DOCUMENT_OPENED,i._instance._onDocumentCreatedOrOpened),s.eventManager.addEventListener(r.EN_EVENT_TYPE.DOCUMENT_CLOSED,i._instance._onDocumentClosed)),i._instance}getActiveObjects(){return this._selectedIds}getSelectedGNodes(){const e=[];return this._selectedIds.forEach((t=>{"number"!=typeof t&&e.push(t)})),e}getActiveElementIds(){const e=[];return this._selectedIds.forEach((t=>{"number"==typeof t&&e.push(t)})),e}getActiveElement(){const e=this.getActiveElementIds()[0];if(void 0!==e)return this._doc.getElementById(e)}clear(){var e;this._selectedIds.size&&(this._selectedIds.clear(),null===(e=this._doc)||void 0===e||e.cacheForView.cacheHighlight(this))}reset(...e){const t=new Set(e);([...this._selectedIds].find((e=>!t.has(e)))||e.find((e=>!this._selectedIds.has(e))))&&(this._selectedIds.clear(),e.forEach((e=>{this._selectedIds.add(e)})),this._doc.cacheForView.cacheHighlight(this))}_onDocumentCreatedOrOpened(e){i.getInstance()._doc=e,i.getInstance().clear()}_onDocumentClosed(){i.getInstance()._doc=void 0,i.getInstance().clear()}}t.HighLight=i},21498:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Selection=void 0;const r=n(18064),s=n(63912),i=n(27122),o=n(55083),a=n(7055),c=n(73872);class l{constructor(){this._selectedIds=[],this._selectedGNodes=[],s.eventManager.addEventListener(o.EN_EVENT_TYPE.DOCUMENT_CREATED,this._onDocumentCreatedOrOpened),s.eventManager.addEventListener(o.EN_EVENT_TYPE.DOCUMENT_OPENED,this._onDocumentCreatedOrOpened),s.eventManager.addEventListener(o.EN_EVENT_TYPE.DOCUMENT_CLOSED,this._onDocumentClosed)}static getInstance(){return l._instance||(l._instance=new l),l._instance}getDoc(){return this._doc}getSelectedGNodes(){return this._selectedGNodes}getSelectedElements(){const e=this.getSelectedElementIds();return this._doc.getElementsByIds(e)}getSelectedElementIds(){const e=this._selectedIds,t=new Set(e);return this._selectedGNodes.forEach((e=>{t.add(e.elementId.asInt())})),[...t]}getActiveIds(){const e=this._selectedIds;return e.length?e.map((e=>new r.ElementId(e))):[]}getActiveElements(){return this.getDoc().getElementsByIds(this.getActiveIds())}clear(e=!0){if((this._selectedIds.length||this._selectedGNodes.length)&&(this._selectedIds.splice(0),this._selectedGNodes.splice(0),this._doc.cacheForView.cacheSelection(this),this.clearAllControlPts(),e)){const e=new s.SelectionEvent;s.eventManager.dispatchEvent(e)}}add(e,t){let n=[],r=[];if(e.length&&"number"==typeof e[0]?(n=[...new Set(e)].filter((e=>!this._selectedIds.find((t=>t===e)))),this.updateCtrlPoints()):e.length&&e[0]instanceof i.GNode&&(r=[...new Set(e)].filter((e=>!this._selectedGNodes.find((t=>t===e))))),!n.length&&!r.length)return;this._selectedIds.push(...n),this._selectedGNodes.push(...r),this._doc.cacheForView.cacheSelection(this);const o=new s.SelectionEvent(t);s.eventManager.dispatchEvent(o)}delete(e,t){let n=!1;if(e.length&&"number"==typeof e[0]){for(const t of e){const e=this._selectedIds.indexOf(t);e>-1&&(this._selectedIds.splice(e,1),n=!0)}this.updateCtrlPoints()}else if(e.length&&e[0]instanceof i.GNode)for(const t of e){const e=this._selectedGNodes.indexOf(t);e>-1&&(this._selectedGNodes.splice(e,1),n=!0)}if(n){this._doc.cacheForView.cacheSelection(this);const e=new s.SelectionEvent(t);s.eventManager.dispatchEvent(e)}}reset(e,t){this._doc.cacheForView.cacheSelection(this),this._selectedIds.splice(0),this._selectedGNodes.splice(0),e.length&&"number"==typeof e[0]?(this._selectedIds.push(...new Set(e)),this.updateCtrlPoints()):e.length&&e[0]instanceof i.GNode&&this._selectedGNodes.push(...new Set(e)),this._doc.debugMode.logSelectedElement;const n=new s.SelectionEvent(t);s.eventManager.dispatchEvent(n)}updateCtrlPoints(){this._selectedIds.some((e=>this._doc.getElementById(e)instanceof c.CtrlPoint))||this.clearAllControlPts(),this.showSelectionCtrlPoints()}showSelectionCtrlPoints(){if(!this._selectedIds.length)return;const e=this._doc.getElementById(this._selectedIds[0]);if(!e)return;const t=a.castToIWithAuxiliaryElement(e);t&&(t.clearAuxElements(),t.createAuxElements(),this._doc.updateView())}clearAllControlPts(){this._doc.filterElements().forEach((e=>{const t=a.castToIWithAuxiliaryElement(e);t&&t.clearAuxElements()})),this._doc.updateView()}_onDocumentCreatedOrOpened(e){l.getInstance()._doc=e,l.getInstance().clear()}_onDocumentClosed(){l.getInstance().clear(),l.getInstance()._doc=void 0}}t.Selection=l},55751:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapUtil=t.EN_SNAP_TYPE=t.SnapSetting=t.SnapEngine=t.SnapResult=t.PointSnap=t.SnapCandidates=t.EN_SNAP_HELPER_OBJECT=t.SnapContext=void 0;var r=n(96556);Object.defineProperty(t,"SnapContext",{enumerable:!0,get:function(){return r.SnapContext}}),Object.defineProperty(t,"EN_SNAP_HELPER_OBJECT",{enumerable:!0,get:function(){return r.EN_SNAP_HELPER_OBJECT}});var s=n(47840);Object.defineProperty(t,"SnapCandidates",{enumerable:!0,get:function(){return s.SnapCandidates}});var i=n(56230);Object.defineProperty(t,"PointSnap",{enumerable:!0,get:function(){return i.PointSnap}});var o=n(65432);Object.defineProperty(t,"SnapResult",{enumerable:!0,get:function(){return o.SnapResult}});var a=n(67488);Object.defineProperty(t,"SnapEngine",{enumerable:!0,get:function(){return a.SnapEngine}});var c=n(79151);Object.defineProperty(t,"SnapSetting",{enumerable:!0,get:function(){return c.SnapSetting}});var l=n(52531);Object.defineProperty(t,"EN_SNAP_TYPE",{enumerable:!0,get:function(){return l.EN_SNAP_TYPE}});var d=n(25688);Object.defineProperty(t,"SnapUtil",{enumerable:!0,get:function(){return d.SnapUtil}})},56230:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PointSnap=void 0;const r=n(67549),s=n(52531),i=n(65432),o=n(98106);class a extends i.SnapResult{constructor(e,t,n,r,s){super(e),this._snappedPt=t,this._disToRay=n,s&&(this._anotherPt=s),r&&(this._snappedDir=r)}get snappedPt(){return this._snappedPt}set snappedPt(e){this._snappedPt=e}get snappedPlane(){return this._snappedPlane}set snappedPlane(e){this._snappedPlane=e}set snappedDir(e){this._snappedDir=e}get snappedDir(){return this._snappedDir}set anotherSnapType(e){this._anotherSnapType=e}get anotherSnapType(){return this._anotherSnapType}set disToRay(e){this._disToRay=e}get disToRay(){return this._disToRay}getSnapPrompt(){const e=new r.GGroup3d;if(this.getSnapType()===s.EN_SNAP_TYPE.PointOnSnapPlane)return e;switch(e.addPoint3d(this.snappedPt),this.getSnapType()){case s.EN_SNAP_TYPE.ClosedLineParallelToX:if(this._anotherPt){const t={line:{width:2,color:16711680,dotted:!0,dashSize:6,gapSize:6}};e.addCurve3d(new o.Line3d(this._anotherPt,this._snappedPt)).setStyle(t)}break;case s.EN_SNAP_TYPE.ClosedLineParallelToY:if(this._anotherPt){const t={line:{width:2,color:65280,dotted:!0,dashSize:4,gapSize:4}};e.addCurve3d(new o.Line3d(this._anotherPt,this._snappedPt)).setStyle(t)}break;case s.EN_SNAP_TYPE.ClosedLineParallelToZ:if(this._anotherPt){const t={line:{width:2,color:255,dotted:!0,dashSize:4,gapSize:4}};e.addCurve3d(new o.Line3d(this._anotherPt,this._snappedPt)).setStyle(t)}}return e}getSnapPromptString(){return(e=>{let t="unknown";switch(e){case s.EN_SNAP_TYPE.EndPoint:t="端点";break;case s.EN_SNAP_TYPE.IntersectPoint:t="交点";break;case s.EN_SNAP_TYPE.MiddlePoint:t="中点";break;case s.EN_SNAP_TYPE.PerpendicularPoint:t="垂足";break;case s.EN_SNAP_TYPE.Pole:t="极点";break;case s.EN_SNAP_TYPE.PointOnCurve:t="边线";break;case s.EN_SNAP_TYPE.ReferCurve:t="参考线";break;case s.EN_SNAP_TYPE.ExtensionPoint:t="延长线";break;case s.EN_SNAP_TYPE.VerticalToCurve:t="垂直于边线";break;case s.EN_SNAP_TYPE.ParallelToCurve:t="平行于边线";break;case s.EN_SNAP_TYPE.PointOnFace:t="面";break;case s.EN_SNAP_TYPE.PointOnSnapPlane:t="";break;case s.EN_SNAP_TYPE.PtOrigin:t="原点";break;case s.EN_SNAP_TYPE.Center:t="中心";break;case s.EN_SNAP_TYPE.PtInX:t="在X轴上";break;case s.EN_SNAP_TYPE.PtInY:t="在Y轴上";break;case s.EN_SNAP_TYPE.PtInZ:t="在Z轴上";break;case s.EN_SNAP_TYPE.PtInXOY:t="在XOY上";break;case s.EN_SNAP_TYPE.PtInXOZ:t="在XOZ上";break;case s.EN_SNAP_TYPE.PtInYOZ:t="在YOZ上";break;case s.EN_SNAP_TYPE.ParallelToX:t="平行X轴";break;case s.EN_SNAP_TYPE.ParallelToY:t="平行Y轴";break;case s.EN_SNAP_TYPE.ParallelToZ:t="平行Z轴";break;case s.EN_SNAP_TYPE.ClosedLineParallelToX:t="平行X轴";break;case s.EN_SNAP_TYPE.ClosedLineParallelToY:t="平行Y轴";break;case s.EN_SNAP_TYPE.ClosedLineParallelToZ:t="平行Z轴"}return t})(this.getSnapType())}}t.PointSnap=a},47840:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapCandidates=void 0;const r=n(95829),s=n(56230);t.SnapCandidates=class{constructor(){this._currentIndex=-1,this._snapResults=[]}get snapResults(){return this._snapResults}addSnapResult(e){this._snapResults.push(e)}addSnapResults(e){this._snapResults.push(...e)}sort(e){if(this._snapResults.length<2)return;if(e)return void this._snapResults.sort(e);const t=e=>void 0!==e.anotherSnapType?Math.min(e.getSnapType(),e.anotherSnapType):e.getSnapType(),n=this._snapResults.filter((e=>e instanceof s.PointSnap));n.sort(((e,n)=>t(e)-t(n)||e.disToRay-n.disToRay)),this._snapResults=[...n]}getCurrentSnap(){if(!(this._snapResults.length<1))return this._snapResults[this.currentIndex]}get currentIndex(){return this._currentIndex}set currentIndex(e){r.DebugWarn.warn(e<this._snapResults.length&&e>-1,"index不合法","zhiuyang","2020-07-15"),this._currentIndex=e}}},96556:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapContext=t.EN_SNAP_HELPER_OBJECT=void 0,function(e){e.POINT="point",e.CURVE="curve",e.DIR="dir"}(t.EN_SNAP_HELPER_OBJECT||(t.EN_SNAP_HELPER_OBJECT={}));t.SnapContext=class{constructor(e,t,n){this._snapHelpers=new Map,e&&t&&(this._snappableGNodes=e,this._snapRay=t,n&&(this._snapPlane=n))}get snappableGNodes(){return this._snappableGNodes}set snappableGNodes(e){this._snappableGNodes=e}get snapRay(){return this._snapRay}set snapRay(e){this._snapRay=e}get previousPoint(){return this._previousPoint}set previousPoint(e){this._previousPoint=e}get previousLineDir(){return this._previousLineDir}set previousLineDir(e){this._previousLineDir=e}get firstPoint(){return this._firstPoint}set firstPoint(e){this._firstPoint=e}get snapSort(){return this._snapSort}set snapSort(e){this._snapSort=e}get snapPlane(){return this._snapPlane}set snapPlane(e){this._snapPlane=e}getSnapHelpers(e){return this._snapHelpers.get(e)}setSnapHelpers(e,t){this._snapHelpers.set(e,t)}addSnapHelpers(e,t){t.length&&(this._snapHelpers.get(e)&&(t[0].isVector3()?this._snapHelpers.get(e).push(...t):this._snapHelpers.get(e).push(t)),t[0].isVector3()?this.setSnapHelpers(e,t):this.setSnapHelpers(e,[t]))}}},17938:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapDirection=void 0;const r=n(98106),s=n(96556),i=n(52531),o=n(79151),a=n(25688);t.SnapDirection=class{static snapDirection(e){const t=[],n=e.snapRay,r=this.snapExtensionPoint(e,n);r.length>0&&t.push(...r);const s=this.snapHelperDirections(e,n);s.length>0&&t.push(...s);const i=this.snapVerticalDir(e,n);i.length>0&&t.push(...i);const o=this.snapPointParallelToAxis(e,"xyz");o.length>0&&t.push(...o);const a=this.snapLastLineDir(e,n);return a.length>0&&t.push(...a),t}static snapExtensionPoint(e,t){const n=[];if(!o.SnapSetting.getInstance().canSnapExtensionPoint)return n;if(!e.previousPoint||!e.previousLineDir)return n;const s=new r.Line3d(e.previousPoint,e.previousLineDir,[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),c=a.SnapUtil.intersectCurve(t,s,i.EN_SNAP_TYPE.ExtensionPoint);return c&&a.SnapUtil.isSnapResultValid(e.snapPlane,c.snappedPt)?(c.snappedDir=s.getDirection(),[c]):[]}static snapHelperDirections(e,t){var n,c;const l=[];if(!o.SnapSetting.getInstance().canSnapHelperDir)return l;if(!e.previousPoint||!(null===(n=e.getSnapHelpers(s.EN_SNAP_HELPER_OBJECT.DIR))||void 0===n?void 0:n.length))return l;for(const n of e.getSnapHelpers(s.EN_SNAP_HELPER_OBJECT.DIR)){const s=new r.Line3d(e.previousPoint,n,[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),o=a.SnapUtil.intersectCurve(t,s,(null===(c=n.userData)||void 0===c?void 0:c.snapType)||i.EN_SNAP_TYPE.ParallelToCurve);if(o&&a.SnapUtil.isSnapResultValid(e.snapPlane,o.snappedPt))return o.snappedDir=s.getDirection(),o.addSnappedObject(n),[o]}return[]}static snapVerticalDir(e,t){if(!o.SnapSetting.getInstance().canSnapVertical)return[];if(!e.previousPoint||!e.previousLineDir)return[];const n=e.snapPlane||a.SnapUtil.getDefaultSnapPlane(t.getDirection()).plane;if(!n.containsPoint(e.previousPoint)||!n.getNorm().isPerpendicular(e.previousLineDir))return[];const s=n.getNorm().cross(e.previousLineDir).normalize(),c=new r.Line3d(e.previousPoint,s,[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),l=a.SnapUtil.intersectCurve(t,c,i.EN_SNAP_TYPE.VerticalToCurve);return l&&a.SnapUtil.isSnapResultValid(e.snapPlane,l.snappedPt)?(l.snappedDir=s,[l]):[]}static snapLastLineDir(e,t){const n=[];if(!e.firstPoint||!e.previousPoint||e.firstPoint.equals(e.previousPoint))return n;const s=e.snapPlane;let c="xyz";if(s){const e=s.getNorm();e.isParallel(r.Vector3.X())?c=c.replace("x",""):e.isParallel(r.Vector3.Y())?c=c.replace("y",""):e.isParallel(r.Vector3.Z())&&(c=c.replace("z",""))}if(c.includes("x")&&o.SnapSetting.getInstance().getCanSnapClosedLineParallelToAxis(o.EN_XYZ.X)){const n=new r.Line3d(e.firstPoint,r.Vector3.X(),[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),s=a.SnapUtil.intersectCurve(t,n,i.EN_SNAP_TYPE.ClosedLineParallelToX,e.firstPoint);if(s&&a.SnapUtil.isSnapResultValid(e.snapPlane,s.snappedPt))return s.snappedDir=r.Vector3.X(),[s]}if(c.includes("y")&&o.SnapSetting.getInstance().getCanSnapClosedLineParallelToAxis(o.EN_XYZ.Y)){const n=new r.Line3d(e.firstPoint,r.Vector3.Y(),[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),s=a.SnapUtil.intersectCurve(t,n,i.EN_SNAP_TYPE.ClosedLineParallelToY,e.firstPoint);if(s&&a.SnapUtil.isSnapResultValid(e.snapPlane,s.snappedPt))return s.snappedDir=r.Vector3.Y(),[s]}if(c.includes("z")&&o.SnapSetting.getInstance().getCanSnapClosedLineParallelToAxis(o.EN_XYZ.Z)){const n=new r.Line3d(e.firstPoint,r.Vector3.Z(),[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),s=a.SnapUtil.intersectCurve(t,n,i.EN_SNAP_TYPE.ClosedLineParallelToZ,e.firstPoint);if(s&&a.SnapUtil.isSnapResultValid(e.snapPlane,s.snappedPt))return s.snappedDir=r.Vector3.Z(),[s]}return n}static snapPointParallelToAxis(e,t){const n=e.previousPoint;if(!n)return[];const s=e.snapPlane;if(s){const e=s.getNorm();e.isParallel(r.Vector3.X())?t=t.replace("x",""):e.isParallel(r.Vector3.Y())?t=t.replace("y",""):e.isParallel(r.Vector3.Z())&&(t=t.replace("z",""))}if(t.includes("x")){const t=a.SnapUtil.intersectCurve(e.snapRay,new r.Line3d(n,r.Vector3.X(),[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),i.EN_SNAP_TYPE.ParallelToX);if(t&&a.SnapUtil.isSnapResultValid(e.snapPlane,t.snappedPt))return t.snappedDir=r.Vector3.X(),[t]}if(t.includes("y")){const t=a.SnapUtil.intersectCurve(e.snapRay,new r.Line3d(n,r.Vector3.Y(),[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),i.EN_SNAP_TYPE.ParallelToY);if(t&&a.SnapUtil.isSnapResultValid(e.snapPlane,t.snappedPt))return t.snappedDir=r.Vector3.Y(),[t]}if(t.includes("z")){const t=a.SnapUtil.intersectCurve(e.snapRay,new r.Line3d(n,r.Vector3.Z(),[-r.CONST.MODEL_MAX_LENGTH,r.CONST.MODEL_MAX_LENGTH]),i.EN_SNAP_TYPE.ParallelToZ);if(t&&a.SnapUtil.isSnapResultValid(e.snapPlane,t.snappedPt))return t.snappedDir=r.Vector3.Z(),[t]}return[]}}},67488:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapEngine=void 0;const r=n(95829),s=n(38675),i=n(98106),o=n(47840),a=n(79151),c=n(35381),l=n(17938),d=n(52531),u=n(25688);t.SnapEngine=class{static snap(e){r.DebugWarn.warn(e,"snapContext不应该为空"," ","2020-07-15");const t=e.snappableGNodes,n=new o.SnapCandidates;if(a.SnapSetting.getInstance().isSnapOff)return n;if(t[0]&&t[0].canSnap){const r=t[0],s=r.getType();n.addSnapResults(this._snapGNode(s,e,r))}const s=c.SnapPoint.snapReferencePoint(e);n.addSnapResults(s);const i=c.SnapPoint.snapReferenceCurve(e);n.addSnapResults(i);const u=l.SnapDirection.snapDirection(e);n.addSnapResults(u);const h=this._combineSnaps(e,u.concat(i),n.snapResults);if(n.addSnapResults(h),n.sort(e.snapSort),n.snapResults.length)return n;if(e.snapPlane){const t=c.SnapPoint.snapPointIntersectAxis(e);if(t.length>0)n.addSnapResult(t[0]);else{const t=c.SnapPoint.snapPointOnSurface(e,e.snapPlane,void 0,d.EN_SNAP_TYPE.PointOnSnapPlane);t.length>0&&n.addSnapResult(t[0])}}else{const t=c.SnapPoint.snapPointOnAxisPlane(e);t.length>0&&n.addSnapResults(t)}return n.sort(e.snapSort),n}static _snapGNode(e,t,n){switch(e){case s.GNODE_TYPE.GPoint3d:return c.SnapPoint.snapGPoint(t,n);case s.GNODE_TYPE.GEdge:case s.GNODE_TYPE.GCurve2d:case s.GNODE_TYPE.GCurve3d:return c.SnapPoint.snapCurveFeaturePoint(t,n);case s.GNODE_TYPE.GCurves:return c.SnapPoint.snapPtOnGCurves(t,n);case s.GNODE_TYPE.GSurface:case s.GNODE_TYPE.GFace:{const e=c.SnapPoint.snapPointOnFace(t,n);if(e.length>0)return e;break}case s.GNODE_TYPE.GNodeRef:{const e=n.getOriginGNode(),r=n.getMatrix();if(r){const s=t.snapRay.clone(),o=a.SnapSetting.getInstance().getSnapTol(),c=r.getScale(),l=Math.max(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z));l&&a.SnapSetting.getInstance().setSnapTol(o/l);const d=t.snapRay.getOrigin().transformed(r.inversed()),u=t.snapRay.getDirection().vecTransformed(r.inversed()).normalize();t.snapRay=new i.Line3d(d,u,[-i.CONST.MODEL_MAX_LENGTH,i.CONST.MODEL_MAX_LENGTH]);const h=this._snapGNode(e.getType(),t,e);t.snapRay=s,a.SnapSetting.getInstance().setSnapTol(o);for(const e of h)e.setSnappedGNodes([n]),e.snappedPt.transform(r),e.snappedPlane&&e.snappedPlane.transform(r);return h}const s=this._snapGNode(e.getType(),t,e);return s.forEach((e=>e.setSnappedGNodes([n]))),s}}return[]}static _combineIntersects(e,t,n){const r=[],s=c.SnapPoint.snapCurveCurveIntersectPoint(e,e.snappableGNodes);s.length&&r.push(...s);const o=c.SnapPoint.snapCurveSurfaceIntersectPoint(e,e.snappableGNodes);o.length&&r.push(...o);const a=c.SnapPoint.snapSurfaceSurfaceIntersectPoint(e,e.snappableGNodes);if(a.length&&r.push(...a),!t.length)return r;const l=(t,n,r)=>{const s=i.MathAlg.CalculateIntersect.curve3ds(t,n);if(1!==s.length)return;const o=u.SnapUtil.intersectPoint(e.snapRay,s[0].point,r);return o?[o]:void 0},h=e=>{let t=new i.Line3d({x:-i.CONST.MODEL_MAX_LENGTH,y:0,z:0},{x:i.CONST.MODEL_MAX_LENGTH,y:0,z:0});return e===d.EN_SNAP_TYPE.PtInY?t=new i.Line3d({x:0,y:-i.CONST.MODEL_MAX_LENGTH,z:0},{x:0,y:i.CONST.MODEL_MAX_LENGTH,z:0}):e===d.EN_SNAP_TYPE.PtInZ&&(t=new i.Line3d({x:0,y:0,z:-i.CONST.MODEL_MAX_LENGTH},{x:0,y:0,z:i.CONST.MODEL_MAX_LENGTH})),t},g=e=>{let t;const n=e.getSnappedObjects().filter((e=>e instanceof i.Curve3d));return e.snappedPt&&e.snappedDir?t=new i.Line3d(e.snappedPt,e.snappedDir,[-i.CONST.MODEL_MAX_LENGTH,i.CONST.MODEL_MAX_LENGTH]):1===n.length&&(t=n[0]),t},f=(e,t)=>e instanceof i.Line3d&&t instanceof i.Line3d&&e.getDirection().isParallel(t.getDirection());for(const s of t){const t=g(s);if(t)for(const o of n){if(s===o)continue;const n=o.getSnapType();switch(n){case d.EN_SNAP_TYPE.PtInX:case d.EN_SNAP_TYPE.PtInY:case d.EN_SNAP_TYPE.PtInZ:{const e=h(n);if(f(t,e))break;const i=l(t,e,n);(null==i?void 0:i.length)&&(i.forEach((e=>{e.addSnappedGNodes([...s.getSnappedGNodes(),...o.getSnappedGNodes()]),e.addSnappedObjects([...s.getSnappedObjects(),...o.getSnappedObjects()]),e.anotherSnapType=s.getSnapType()})),r.push(...i));break}case d.EN_SNAP_TYPE.PointOnCurve:{const a=o.getSnappedGNodes();if(1!==a.length)break;const c=u.SnapUtil.curveIntersectGNode(t,a[0]);for(const a of c){let c=a.c instanceof i.Line3d?a.c.getDirection():void 0;const l=u.SnapUtil.intersectPoint(e.snapRay,a.pt,n);l&&!f(t,a.c)&&(s.getSnapType()===d.EN_SNAP_TYPE.VerticalToCurve&&c&&s.snappedDir.isPerpendicular(c)&&l.setSnapType(d.EN_SNAP_TYPE.PerpendicularPoint),l.addSnappedGNodes([...s.getSnappedGNodes(),...o.getSnappedGNodes()]),l.addSnappedObjects([...s.getSnappedObjects(),...o.getSnappedObjects()]),l.anotherSnapType=s.getSnapType(),r.push(l))}break}default:{const a=g(o);if(!a||f(t,a))break;const c=i.MathAlg.CalculateIntersect.curve3ds(t,a);for(const t of c){let c=a instanceof i.Line3d?a.getDirection():void 0;const l=u.SnapUtil.intersectPoint(e.snapRay,t.point,n);l&&(s.getSnapType()===d.EN_SNAP_TYPE.VerticalToCurve&&!o.snappedDir&&c&&s.snappedDir.isPerpendicular(c)&&l.setSnapType(d.EN_SNAP_TYPE.PerpendicularPoint),l.addSnappedGNodes([...s.getSnappedGNodes(),...s.getSnappedGNodes()]),l.addSnappedObjects([...o.getSnappedObjects(),...o.getSnappedObjects()]),l.anotherSnapType=s.getSnapType(),r.push(l))}}}}}return r}static _combineSnaps(e,t,n){const r=[];return r.push(...this._combineIntersects(e,t,n)),r}}},35381:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapPoint=void 0;const r=n(95829),s=n(38675),i=n(98106),o=n(96556),a=n(56230),c=n(52531),l=n(79151),d=n(25688);t.SnapPoint=class{static snapGPoint(e,t){var n;const r=[];if(!d.SnapUtil.isSnapResultValid(e.snapPlane,t.geo))return r;let s=c.EN_SNAP_TYPE.IntersectPoint;"center"===(null===(n=t.userData)||void 0===n?void 0:n.snapType)&&(s=c.EN_SNAP_TYPE.Center);const i=d.SnapUtil.intersectPoint(e.snapRay,t.geo,s);return i?(i.addSnappedGNode(t),r.push(i),r):r}static snapCurveCurveIntersectPoint(e,t){const n=[],o=new Map;t.forEach((e=>{e.getType()===s.GNODE_TYPE.GCurve3d?n.push(e.geo):e.getType()===s.GNODE_TYPE.GEdge?(n.push(e.geo.getCurve()),o.set(e.geo.getCurve(),e.geo.getShell())):e.getType()===s.GNODE_TYPE.GCurves?n.push(...e.geo):e.getType()===s.GNODE_TYPE.GNodeRef&&n.push(...e.getCurve3ds())}));const a=[];if(n.length<2)return a;const l=[];for(let e=1;e<n.length;++e){const t=o.get(o[0]),s=o.get(o[e]);if(!t||!s||t!==s)try{const t=i.MathAlg.CalculateIntersect.curve3ds(n[0],n[e]);l.push(...t)}catch(e){r.DebugWarn.warn(!1,e," ","2021-06-15");continue}}if(0===l.length)return a;for(const n of l){const r=d.SnapUtil.intersectPoint(e.snapRay,n.point,c.EN_SNAP_TYPE.IntersectPoint);if(r&&d.SnapUtil.isSnapResultValid(e.snapPlane,r.snappedPt))return r.addSnappedGNode(t[0]),r.addSnappedGNode(t[1]),a.push(r),a}return a}static snapCurveSurfaceIntersectPoint(e,t){if(t.length<2)return[];const n=new Map,o=[],a=[],l=new Map,u=new Map;t.forEach((e=>{if(e.getType()===s.GNODE_TYPE.GCurve3d)o.push(e.geo),n.set(e.geo,e);else if(e.getType()===s.GNODE_TYPE.GEdge)o.push(e.geo.getCurve()),n.set(e.geo.getCurve(),e),l.set(e.geo.getCurve(),e.geo.getShell());else if(e.getType()===s.GNODE_TYPE.GNodeRef){const t=e.getCurve3ds(!0);1===t.length&&(o.push(t[0]),n.set(t[0],e))}})),t.forEach((e=>{if(e.getType()===s.GNODE_TYPE.GFace)a.push(e.geo.getSurface()),n.set(e.geo.getSurface(),e),u.set(e.geo.getSurface(),e.geo.getShell());else if(e.getType()===s.GNODE_TYPE.GSurface)a.push(e.geo),n.set(e.geo.getSurface(),e);else if(e.getType()===s.GNODE_TYPE.GNodeRef){const t=e.getSurface();t&&(a.push(t),n.set(t,e))}}));const h=[],g=new Map;for(const e of o){const t=n.get(e);if(!t||!e.isLine3d()&&!e.isArc3d())continue;const s=l.get(e);for(const o of a){if(!o.isPlane())continue;const a=n.get(o);if(!a)continue;const c=u.get(o);if(!s||!c||s!==c)try{const n=i.MathAlg.CalculateIntersect.curveSurface(e,o);n.forEach((e=>g.set(e,[t,a]))),h.push(...n)}catch(e){r.DebugWarn.warn(!1,e," ","2021-06-15");continue}}}const f=[];return h.forEach((t=>{const n=d.SnapUtil.intersectPoint(e.snapRay,t,c.EN_SNAP_TYPE.IntersectPoint);n&&g.get(t)&&(n.addSnappedGNodes(g.get(t)),f.push(n))})),f.sort(((e,t)=>e.disToRay-t.disToRay)),f}static snapSurfaceSurfaceIntersectPoint(e,t){if(2!==t.length)return[];const n=new Map,o=[],a=new Map;if(t.forEach((e=>{if(e.getType()===s.GNODE_TYPE.GFace)o.push(e.geo.getSurface()),n.set(e.geo.getSurface(),e),a.set(e.geo.getSurface(),e.geo.getShell());else if(e.getType()===s.GNODE_TYPE.GSurface)o.push(e.geo),n.set(e.geo.getSurface(),e);else if(e.getType()===s.GNODE_TYPE.GNodeRef){const t=e.getSurface();t&&(o.push(t),n.set(t,e))}})),2!==o.length)return[];const l=[],u=new Map;for(let e=0;e<o.length;++e){if(!o[e].isPlane())continue;const t=a.get(o[e]);for(let s=e+1;s<o.length;++s){if(!o[s].isPlane())continue;const c=a.get(o[s]);if(t&&c&&t===c)continue;let d=[];try{if(d=i.MathAlg.CalculateIntersect.surfaces(o[e],o[s]).filter((e=>e.curve)),!d.length)continue}catch(e){r.DebugWarn.warn(!1,e," ","2021-06-15");continue}const h=n.get(o[e]),g=n.get(o[s]);h&&g&&d.forEach((e=>{u.set(e.curve,[h,g]),l.push(e.curve)}))}}const h=[];return l.forEach((t=>{const n=d.SnapUtil.intersectCurve(e.snapRay,t,c.EN_SNAP_TYPE.IntersectPoint);n&&u.get(t)&&(n.addSnappedGNodes(u.get(t)),h.push(n))})),h.sort(((e,t)=>e.disToRay-t.disToRay)),h}static snapPtOnGCurves(e,t){const n=[],r=e.snapRay;if(t.getType()!==s.GNODE_TYPE.GCurves)return n;const o=t.geo;if(o.length<2)return n;const u=i.Plane.makePlaneByPointNormal(o[0].getStartPt(),o[0].getDirection().cross(o[1].getDirection()));if(e.snapPlane&&(!u.getNorm().isParallel(e.snapPlane.getNorm())||!e.snapPlane.containsPoint(u.getOrigin())))return n;const h=o[0].getStartPt(),g=o[o.length-1].getEndPt(),f=d.SnapUtil.intersectPoint(r,h,c.EN_SNAP_TYPE.EndPoint);if(f)return[f];const p=d.SnapUtil.intersectPoint(r,g,c.EN_SNAP_TYPE.EndPoint);if(p)return[p];const _=i.MathAlg.CalculateIntersect.curveSurface(r,u);if(0===_.length)return n;for(const e of o){const s=new i.Vector3,o=i.MathAlg.CalculateDistance.pointToCurve3d(_[0],e,s),d=r.getParamAt(s);if(o<l.SnapSetting.getInstance().getSnapTolAtDistance(d)){const e=new a.PointSnap(c.EN_SNAP_TYPE.PointOnCurve,s,o);return e.addSnappedGNode(t),n.push(e),n}}return n}static snapCurveFeaturePoint(e,t){let n=[];const i=this.snapEndOrMidPoint(e,t);if(i.length>0)n=i;else{const r=this.snapPointOnCurve(e,t);r.length>0&&(n=r)}if(0===n.length)return n;let o;switch(t.getType()){case s.GNODE_TYPE.GEdge:o=t.geo.getCurve();break;case s.GNODE_TYPE.GCurve2d:r.DebugWarn.warn(!1,"暂不支持此类型"," ","2020-07-15");break;case s.GNODE_TYPE.GCurve3d:o=t.geo}return n}static snapReferenceCurve(e){var t;const n=[];if(!(null===(t=e.getSnapHelpers(o.EN_SNAP_HELPER_OBJECT.CURVE))||void 0===t?void 0:t.length))return n;const s=[];for(const t of e.getSnapHelpers(o.EN_SNAP_HELPER_OBJECT.CURVE))Array.isArray(t)&&t.length&&t[0].isLine3d()&&t[0].userData.snapType?s.push(t):r.DebugWarn.warn(!1,"未支持的类型"," ","");s.length>6&&r.DebugWarn.warn(!1,"snapHelperCurves太多，可能会影响性能"," ","");for(const t of s)for(const r of t){const t=d.SnapUtil.intersectCurve(e.snapRay,r,r.userData.snapType);if(t&&d.SnapUtil.isSnapResultValid(e.snapPlane,t.snappedPt))return t.addSnappedObject(r),n.push(t),n}return n}static snapReferencePoint(e){var t;const n=[];if(!(null===(t=e.getSnapHelpers(o.EN_SNAP_HELPER_OBJECT.POINT))||void 0===t?void 0:t.length))return n;const r=e.getSnapHelpers(o.EN_SNAP_HELPER_OBJECT.POINT);if(!r.length||!r[0].isVector3())return n;for(const t of r){const r=d.SnapUtil.intersectPoint(e.snapRay,t,t.userData.snapType);if(r&&d.SnapUtil.isSnapResultValid(e.snapPlane,r.snappedPt))return n.push(r),n}return n}static snapEndOrMidPoint(e,t){var n;const r=t.getType()===s.GNODE_TYPE.GNodeRef?t.getOriginGNode():t,o=[];if(!l.SnapSetting.getInstance().canSnapEndPt&&!l.SnapSetting.getInstance().canSnapMidPt)return o;const a=e.snapRay;if(r.getType()===s.GNODE_TYPE.GEdge){const n=r.geo.getStartVertex().getPoint().clone();let s=d.SnapUtil.intersectPoint(a,n,c.EN_SNAP_TYPE.EndPoint);s&&d.SnapUtil.isSnapResultValid(e.snapPlane,s.snappedPt)&&(s.addSnappedGNode(t),o.push(s));const i=r.geo.getEndVertex().getPoint().clone();s=d.SnapUtil.intersectPoint(a,i,c.EN_SNAP_TYPE.EndPoint),s&&d.SnapUtil.isSnapResultValid(e.snapPlane,s.snappedPt)&&(s.addSnappedGNode(t),o.push(s));const l=r.geo.getCurve().getMidPt();s=d.SnapUtil.intersectPoint(a,l,c.EN_SNAP_TYPE.MiddlePoint),s&&d.SnapUtil.isSnapResultValid(e.snapPlane,s.snappedPt)&&(s.addSnappedGNode(t),o.push(s))}else if(r.getType()===s.GNODE_TYPE.GCurve3d){if(null===(n=r.geo.userData)||void 0===n?void 0:n.disableMidPtSnap)return o;const s=r.geo.getStartPt();let i=d.SnapUtil.intersectPoint(a,s,c.EN_SNAP_TYPE.EndPoint);i&&d.SnapUtil.isSnapResultValid(e.snapPlane,i.snappedPt)&&(i.addSnappedGNode(t),o.push(i));const l=r.geo.getEndPt();i=d.SnapUtil.intersectPoint(a,l,c.EN_SNAP_TYPE.EndPoint),i&&d.SnapUtil.isSnapResultValid(e.snapPlane,i.snappedPt)&&(i.addSnappedGNode(t),o.push(i));const u=r.geo.getMidPt();i=d.SnapUtil.intersectPoint(a,u,c.EN_SNAP_TYPE.MiddlePoint),i&&d.SnapUtil.isSnapResultValid(e.snapPlane,i.snappedPt)&&(i.addSnappedGNode(t),o.push(i))}else if(r.getType()===s.GNODE_TYPE.GCurve2d){let n=r.geo.getStartPt();const s=new i.Vector3(n.x,n.y,0);let l=d.SnapUtil.intersectPoint(a,s.clone(),c.EN_SNAP_TYPE.EndPoint);l&&d.SnapUtil.isSnapResultValid(e.snapPlane,l.snappedPt)&&(l.addSnappedGNode(t),o.push(l)),n=r.geo.getEndPt();const u=new i.Vector3(n.x,n.y,0);l=d.SnapUtil.intersectPoint(a,u.clone(),c.EN_SNAP_TYPE.EndPoint),l&&d.SnapUtil.isSnapResultValid(e.snapPlane,l.snappedPt)&&(l.addSnappedGNode(t),o.push(l)),n=r.geo.getMidPt();const h=new i.Vector3(n.x,n.y,0);l=d.SnapUtil.intersectPoint(a,h.clone(),c.EN_SNAP_TYPE.MiddlePoint),l&&d.SnapUtil.isSnapResultValid(e.snapPlane,l.snappedPt)&&(l.addSnappedGNode(t),o.push(l))}return o.sort(((e,t)=>e.disToRay-t.disToRay))}static snapPointOnCurve(e,t){const n=t.getType()===s.GNODE_TYPE.GNodeRef?t.getOriginGNode():t,r=[];if(!l.SnapSetting.getInstance().canSnapPointOnCurve)return r;if(n.getType()===s.GNODE_TYPE.GEdge){const s=this._snapPtOnCurve(n.geo.getCurve(),e,t);if(s)return r.push(s),r}if(n.getType()===s.GNODE_TYPE.GCurve3d){const s=this._snapPtOnCurve(n.geo,e,t);if(s)return r.push(s),r}return r}static snapPointOnFace(e,t){if(!l.SnapSetting.getInstance().canSnapPointOnFace)return[];let n;return t.getType()===s.GNODE_TYPE.GNodeRef?n=t.getSurface():t.getType()!==s.GNODE_TYPE.GFace&&t.getType()!==s.GNODE_TYPE.GSurface||(n=t.geo.getSurface()),n?this.snapPointOnSurface(e,n,t):[]}static snapPointOnSurface(e,t,n,s){const o=[];if(!t.isPlane()&&!t.isCylinder())return o;if(!l.SnapSetting.getInstance().canSnapPtOutSnapPlane&&e.snapPlane&&t.isPlane()&&!e.snapPlane.isCoplanar(t))return o;const d=e.snapRay;let u=[];try{u=i.MathAlg.CalculateIntersect.curveSurface(d,t)}catch(e){return r.DebugWarn.warn(!1,e," ","2021-06-15"),o}const h=(e=>{if(e.length>0){const t=d.getStartPt();let n=Number.MAX_VALUE,r=new i.Vector3;for(const s of e){const e=s.distanceTo(t);e<n&&(n=e),r=s}return r}})(u);if(h){const e=new a.PointSnap(null!=s?s:c.EN_SNAP_TYPE.PointOnFace,h,0);o.push(e),n&&o[0].addSnappedGNode(n),t.isPlane()&&(o[0].snappedPlane=t.clone())}return o}static snapPointOnAxisPlane(e){const t=e.snapRay,n=t.getDirection();if(!l.SnapSetting.getInstance().canSnapAxisPlane)return[];const r=d.SnapUtil.getDefaultSnapPlane(n),s=[];s.push(...this._snapCoordPlane(t,r.plane,r.type));const i=this.snapPointIntersectAxis(e);return i.length>0&&s.push(...i),s}static snapPointIntersectAxis(e){const t=e.snapRay,n=d.SnapUtil.intersectPoint(t,i.Vector3.O(),c.EN_SNAP_TYPE.PtOrigin);if(n)return[n];const r=e.snapPlane;{const e=d.SnapUtil.intersectCurve(t,new i.Line3d(i.Vector3.O(),i.Vector3.X(),[-i.CONST.MODEL_MAX_LENGTH,i.CONST.MODEL_MAX_LENGTH]),c.EN_SNAP_TYPE.PtInX);if(e&&(!r||r.containsPoint(e.snappedPt)))return[e]}{const e=d.SnapUtil.intersectCurve(t,new i.Line3d(i.Vector3.O(),i.Vector3.Y(),[-i.CONST.MODEL_MAX_LENGTH,i.CONST.MODEL_MAX_LENGTH]),c.EN_SNAP_TYPE.PtInY);if(e&&(!r||r.containsPoint(e.snappedPt)))return[e]}{const e=d.SnapUtil.intersectCurve(t,new i.Line3d(i.Vector3.O(),i.Vector3.Z(),[-i.CONST.MODEL_MAX_LENGTH,i.CONST.MODEL_MAX_LENGTH]),c.EN_SNAP_TYPE.PtInZ);if(e&&(!r||r.containsPoint(e.snappedPt)))return[e]}return[]}static _snapCoordPlane(e,t,n){const r=[];if(!l.SnapSetting.getInstance().getCanSnapPtInAxisPlane(n))return r;const s=i.MathAlg.CalculateIntersect.curveSurface(e.clone().extend(i.CONST.MODEL_MAX_LENGTH,!1),t);if(0===s.length)return r;let o=c.EN_SNAP_TYPE.PtInXOY;return n===l.EN_AXIS_PLANE.YOZ?o=c.EN_SNAP_TYPE.PtInYOZ:n===l.EN_AXIS_PLANE.ZOX&&(o=c.EN_SNAP_TYPE.PtInXOZ),r.push(new a.PointSnap(o,s[0],0)),r.forEach((e=>{e.snappedPlane=t.clone()})),r}static _snapPtOnCurve(e,t,n){const r=t.snapRay,s=d.SnapUtil.intersectCurve(r,e,c.EN_SNAP_TYPE.PointOnCurve);if(s&&d.SnapUtil.isSnapResultValid(t.snapPlane,s.snappedPt))return s.addSnappedGNode(n),s}}},65432:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapResult=void 0;t.SnapResult=class{constructor(e){this._snapType=e,this._snappedGNodes=[],this._snappedObjects=[]}getSnapType(){return this._snapType}setSnapType(e){this._snapType=e}getSnappedGNodes(){return this._snappedGNodes}setSnappedGNodes(e){this._snappedGNodes=e}addSnappedGNode(e){this._snappedGNodes.push(e)}addSnappedGNodes(e){this._snappedGNodes.push(...e)}getSnappedObjects(){return this._snappedObjects}setSnappedObjects(e){this._snappedObjects=e}addSnappedObject(e){this._snappedObjects.push(e)}addSnappedObjects(e){this._snappedObjects.push(...e)}getSnapPrompt(){}}},79151:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapSetting=t.EN_AXIS_PLANE=t.EN_XYZ=void 0;const r=n(95829);var s,i;!function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(s=t.EN_XYZ||(t.EN_XYZ={})),function(e){e[e.XOY=0]="XOY",e[e.YOZ=1]="YOZ",e[e.ZOX=2]="ZOX"}(i=t.EN_AXIS_PLANE||(t.EN_AXIS_PLANE={}));class o{constructor(){this.getSnapTolAtDistance=e=>this._scaleAtDistance?this._scaleAtDistance(e)*this._snapTolerance:this._snapTolerance,this._snapTolerance=15,this._isSnapOff=!1,this._reset(!0),this._canSnapPtOutSnapPlane=!0}static getInstance(){return o._instance||(o._instance=new o),o._instance}backup(){this._backup={snapTolerance:this._snapTolerance,isSnapOff:this._isSnapOff,canSnapEndPt:this._canSnapEndPt,canSnapMidPt:this._canSnapMidPt,canSnapCenter:this.canSnapCenter,canSnapPerpendicularPoint:this._canSnapPerpendicularPoint,canSnapExtensionPoint:this._canSnapExtensionPoint,canSnapVertical:this._canSnapVertical,canSnapParallelToX:this._canSnapParallelToX,canSnapParallelToY:this._canSnapParallelToY,canSnapParallelToZ:this._canSnapParallelToZ,canSnapClosedLineParallelToX:this._canSnapClosedLineParallelToX,canSnapClosedLineParallelToY:this._canSnapClosedLineParallelToY,canSnapClosedLineParallelToZ:this._canSnapClosedLineParallelToZ,canSnapPtInX:this._canSnapPtInX,canSnapPtInY:this._canSnapPtInY,canSnapPtInZ:this._canSnapPtInZ,canSnapPtInXOY:this._canSnapPtInXOY,canSnapPtInYOZ:this._canSnapPtInYOZ,canSnapPtInXOZ:this._canSnapPtInXOZ,canSnapPointOnCurve:this._canSnapPointOnCurve,canSnapPointOnFace:this._canSnapPointOnFace,canSnapAxisPlane:this._canSnapAxisPlane,canSnapPtOutSnapPlane:this._canSnapPtOutSnapPlane,canSnapHelperObject:this._canSnapHelperObject,canSnapHelperDir:this._canSnapHelperDir}}restore(){this._backup&&(this._snapTolerance=this._backup.snapTolerance,this._isSnapOff=this._backup.isSnapOff,this._canSnapEndPt=this._backup.canSnapEndPt,this._canSnapMidPt=this._backup.canSnapMidPt,this.canSnapCenter=this._backup.canSnapCenter,this._canSnapPerpendicularPoint=this._backup.canSnapPerpendicularPoint,this._canSnapExtensionPoint=this._backup.canSnapExtensionPoint,this._canSnapVertical=this._backup.canSnapVertical,this._canSnapParallelToX=this._backup.canSnapParallelToX,this._canSnapParallelToY=this._backup.canSnapParallelToY,this._canSnapParallelToZ=this._backup.canSnapParallelToZ,this._canSnapClosedLineParallelToX=this._backup.canSnapClosedLineParallelToX,this._canSnapClosedLineParallelToY=this._backup.canSnapClosedLineParallelToY,this._canSnapClosedLineParallelToZ=this._backup.canSnapClosedLineParallelToZ,this._canSnapPtInX=this._backup.canSnapPtInX,this._canSnapPtInY=this._backup.canSnapPtInY,this._canSnapPtInZ=this._backup.canSnapPtInZ,this._canSnapPtInXOY=this._backup.canSnapPtInXOY,this._canSnapPtInYOZ=this._backup.canSnapPtInYOZ,this._canSnapPtInXOZ=this._backup.canSnapPtInXOZ,this._canSnapPointOnCurve=this._backup.canSnapPointOnCurve,this._canSnapPointOnFace=this._backup.canSnapPointOnFace,this._canSnapAxisPlane=this._backup.canSnapAxisPlane,this._canSnapPtOutSnapPlane=this._backup.canSnapPtOutSnapPlane,this._canSnapHelperObject=this._backup.canSnapHelperObject,this._canSnapHelperDir=this._backup.canSnapHelperDir,delete this._backup)}getSnapTol(){return this._snapTolerance}setSnapTol(e){this._snapTolerance=e}setScaleAtDis(e){this._scaleAtDistance=e}get isSnapOff(){return this._isSnapOff}allowAll(){this._reset(!0)}disableAll(){this._reset(!1)}set isSnapOff(e){this._isSnapOff=e}get canSnapEndPt(){return this._canSnapEndPt}set canSnapEndPt(e){this._canSnapEndPt=e}get canSnapMidPt(){return this._canSnapMidPt}set canSnapMidPt(e){this._canSnapMidPt=e}get canSnapCenter(){return this._canSnapCenter}set canSnapCenter(e){this._canSnapCenter=e}get canSnapPerpendicularPoint(){return this._canSnapPerpendicularPoint}set canSnapPerpendicularPoint(e){this._canSnapPerpendicularPoint=e}get canSnapExtensionPoint(){return this._canSnapExtensionPoint}set canSnapExtensionPoint(e){this._canSnapExtensionPoint=e}get canSnapVertical(){return this._canSnapVertical}set canSnapVertical(e){this._canSnapVertical=e}get canSnapPtOutSnapPlane(){return this._canSnapPtOutSnapPlane}set canSnapPtOutSnapPlane(e){this._canSnapPtOutSnapPlane=e}get canSnapHelperObject(){return this._canSnapHelperObject}set canSnapHelperObject(e){this._canSnapHelperObject=e}get canSnapHelperDir(){return this._canSnapHelperDir}set canSnapHelperDir(e){this._canSnapHelperDir=e}getCanSnapParallelToAxis(e){switch(e){case s.X:return this._canSnapParallelToX;case s.Y:return this._canSnapParallelToY;case s.Z:return this._canSnapParallelToZ;default:r.DebugWarn.warn(!1,"未定义类型"," ","2020-07-15")}return!1}setCanSnapParallelToAxis(e,t){switch(e){case s.X:return void(this._canSnapParallelToX=t);case s.Y:return void(this._canSnapParallelToY=t);case s.Z:return void(this._canSnapParallelToZ=t);default:r.DebugWarn.warn(!1,"未定义类型"," ","2020-07-15")}}getCanSnapClosedLineParallelToAxis(e){switch(e){case s.X:return this._canSnapClosedLineParallelToX;case s.Y:return this._canSnapClosedLineParallelToY;case s.Z:return this._canSnapClosedLineParallelToZ;default:r.DebugWarn.warn(!1,"未定义类型"," ","2020-07-15")}return!1}setCanSnapClosedLineParallelToAxis(e,t){switch(e){case s.X:return void(this._canSnapClosedLineParallelToX=t);case s.Y:return void(this._canSnapClosedLineParallelToY=t);case s.Z:return void(this._canSnapClosedLineParallelToZ=t);default:r.DebugWarn.warn(!1,"未定义类型"," ","2020-07-15")}}getCanSnapPtInAxis(e){switch(e){case s.X:return this._canSnapPtInX;case s.Y:return this._canSnapPtInY;case s.Z:return this._canSnapPtInZ;default:r.DebugWarn.warn(!1,"未定义类型"," ","2020-07-15")}return!1}setCanSnapPtInAxis(e,t){switch(e){case s.X:return void(this._canSnapPtInX=t);case s.Y:return void(this._canSnapPtInY=t);case s.Z:return void(this._canSnapPtInZ=t);default:r.DebugWarn.warn(!1,"未定义类型"," ","2020-07-15")}}getCanSnapPtInAxisPlane(e){switch(e){case i.XOY:return this._canSnapPtInXOY;case i.YOZ:return this._canSnapPtInYOZ;case i.ZOX:return this._canSnapPtInXOZ;default:r.DebugWarn.warn(!1,"未定义类型"," ","2020-07-15")}return!1}setCanSnapPtInAxisPlane(e,t){switch(e){case i.XOY:return void(this._canSnapPtInXOY=t);case i.YOZ:return void(this._canSnapPtInYOZ=t);case i.ZOX:return void(this._canSnapPtInXOZ=t);default:r.DebugWarn.warn(!1,"未定义类型"," ","2020-07-15")}}get canSnapPointOnCurve(){return this._canSnapPointOnCurve}set canSnapPointOnCurve(e){this._canSnapPointOnCurve=e}get canSnapPointOnFace(){return this._canSnapPointOnFace}set canSnapPointOnFace(e){this._canSnapPointOnFace=e}get canSnapAxisPlane(){return this._canSnapAxisPlane}set canSnapAxisPlane(e){this._canSnapAxisPlane=e}_reset(e){this._canSnapEndPt=e,this._canSnapMidPt=e,this._canSnapCenter=e,this._canSnapPerpendicularPoint=e,this._canSnapExtensionPoint=e,this._canSnapVertical=e,this._canSnapParallelToX=e,this._canSnapParallelToY=e,this._canSnapParallelToZ=e,this._canSnapClosedLineParallelToX=e,this._canSnapClosedLineParallelToY=e,this._canSnapClosedLineParallelToZ=e,this._canSnapPtInX=e,this._canSnapPtInY=e,this._canSnapPtInZ=e,this._canSnapPtInXOY=e,this._canSnapPtInYOZ=e,this._canSnapPtInXOZ=e,this._canSnapPointOnCurve=e,this._canSnapPointOnFace=e,this._canSnapAxisPlane=e,this._canSnapPtOutSnapPlane=e,this._canSnapHelperObject=e,this._canSnapHelperDir=e}}t.SnapSetting=o},52531:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_SNAP_TYPE=void 0,function(e){e[e.InvalidType=-1]="InvalidType",e[e.EndPoint=0]="EndPoint",e[e.Pole=1]="Pole",e[e.IntersectPoint=2]="IntersectPoint",e[e.MiddlePoint=3]="MiddlePoint",e[e.Center=4]="Center",e[e.PerpendicularPoint=5]="PerpendicularPoint",e[e.PtOrigin=6]="PtOrigin",e[e.PointOnCurve=7]="PointOnCurve",e[e.ReferCurve=8]="ReferCurve",e[e.PtInX=9]="PtInX",e[e.PtInY=10]="PtInY",e[e.PtInZ=11]="PtInZ",e[e.ParallelToX=12]="ParallelToX",e[e.ParallelToY=13]="ParallelToY",e[e.ParallelToZ=14]="ParallelToZ",e[e.ExtensionPoint=15]="ExtensionPoint",e[e.VerticalToCurve=16]="VerticalToCurve",e[e.ParallelToCurve=17]="ParallelToCurve",e[e.ClosedLineParallelToX=18]="ClosedLineParallelToX",e[e.ClosedLineParallelToY=19]="ClosedLineParallelToY",e[e.ClosedLineParallelToZ=20]="ClosedLineParallelToZ",e[e.PtInXOY=21]="PtInXOY",e[e.PtInYOZ=22]="PtInYOZ",e[e.PtInXOZ=23]="PtInXOZ",e[e.PointOnFace=24]="PointOnFace",e[e.PointOnSnapPlane=25]="PointOnSnapPlane"}(t.EN_SNAP_TYPE||(t.EN_SNAP_TYPE={}))},25688:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapUtil=void 0;const r=n(38675),s=n(98106),i=n(56230),o=n(79151);t.SnapUtil=class{static intersectPoint(e,t,n){const r=new s.Vector3,a=s.MathAlg.CalculateDistance.pointToCurve3d(t,e,r),c=e.getParamAt(r);if(a<o.SnapSetting.getInstance().getSnapTolAtDistance(c)){return new i.PointSnap(n,t,a)}}static intersectCurve(e,t,n,r){const a=new s.Vector3,c=new s.Vector3,l=s.MathAlg.CalculateDistance.curve3dToCurve3d(e,t,a,c),d=e.getParamAt(a);if(l<o.SnapSetting.getInstance().getSnapTolAtDistance(d)){return new i.PointSnap(n,c,l,void 0,r)}}static curveIntersectGNode(e,t){let n=[];if(t.getType()===r.GNODE_TYPE.GCurve3d)n=[t.geo];else if(t.getType()===r.GNODE_TYPE.GEdge)n=[t.geo.getCurve()];else if(t.getType()===r.GNODE_TYPE.GCurves)n=t.geo;else if(t.getType()===r.GNODE_TYPE.GNodeRef){const e=t.getCurve3ds(!0);n.push(...e)}const i=[];return n.forEach((t=>{s.MathAlg.CalculateIntersect.curve3ds(e,t).forEach((e=>{i.push({pt:e.point,c:t})}))})),i}static isSnapResultValid(e,t){return!!o.SnapSetting.getInstance().canSnapPtOutSnapPlane||(void 0===e||e.containsPoint(t))}static getDefaultSnapPlane(e){const t=(e,t)=>{let n=e.angle(t);return n>s.CONST.PI_2&&(n=s.CONST.PI-n),n},n=t(e,s.Vector3.Y()),r=t(e,s.Vector3.X());return n<s.CONST.PI/6?{plane:s.Plane.ZOX(),type:o.EN_AXIS_PLANE.ZOX}:r<s.CONST.PI/6?{plane:s.Plane.YOZ(),type:o.EN_AXIS_PLANE.YOZ}:{plane:s.Plane.XOY(),type:o.EN_AXIS_PLANE.XOY}}}},40415:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.askForGNodeId=void 0;const r=n(95829),s=n(7684);function i(e,t,n){e.topoNameToGNodeIdMap.delete("");const{key:i,arrayFields:o}=function(e){const t=s.isTopoNameValid(e);r.DebugWarn.assert(t,"拓扑命名不合法"," ","2021-08-05");const n=Object.keys(e).filter((n=>{const r=s.isTopoValueBasicType(e[n]);return r&&delete t[n],r}));if(!n.length)throw new Error("拓扑命名非法");return n.sort(),{key:n.map((t=>{const n=e[t];`${n}`.includes("=")&&r.DebugWarn.assert(!1,"拓扑命名不能存在“=”"," ","2021-08-05");let s=`${t}.`;return s+="number"==typeof n?n.toFixed(0):e[t],s})).join("="),arrayFields:Object.keys(t).length?t:void 0}}(t),a=e.topoNameToGNodeIdMap.get(i);if(null==a?void 0:a.length){if(!n)return r.DebugWarn.assert(1===a.length,"命名错误"," ","2021-08-06"),a[0].id;const e=n(t,a);if(e)return e.id}const c=JSON.stringify([...e.topoNameToGNodeIdMap]),l=JSON.parse(c),d=new Map(l);let u;if(e.topoNameToGNodeIdMap=d,e.topoNameToGNodeIdMap.size){const t=[...e.topoNameToGNodeIdMap.values()].flat(100).map((e=>e.id));u=Math.max(...t)}else u=0;u++;let h=d.get(i);return h||(h=[],d.set(i,h)),h.push({id:u,topoName:o}),u}t.askForGNodeId=function(e,t,n,r){const o=i(e,t,r);s.taggedGNodeIdToGeo(n,o),s.taggedTopoNameToGeo(n,t)}},7684:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isTopoNameValid=t.isTopoValueBasicType=t.getTopoNameFromGeo=t.taggedTopoNameToGeo=t.getGNodeIdFromGeo=t.taggedGNodeIdToGeo=t.symbolGNodeId=t.symbolTopoName=void 0;const r=n(95829);function s(e){return"string"==typeof e||"boolean"==typeof e||"number"==typeof e}t.symbolTopoName=Symbol("toponame"),t.symbolGNodeId=Symbol("gnodeId"),t.taggedGNodeIdToGeo=function(e,n){e[t.symbolGNodeId]=n},t.getGNodeIdFromGeo=function(e,n=!0){return n&&"number"!=typeof e[t.symbolGNodeId]&&r.DebugWarn.assert(!1,"无法获取gnodeId"," ","2021-08-06"),e[t.symbolGNodeId]},t.taggedTopoNameToGeo=function(e,n){e[t.symbolTopoName]=n},t.getTopoNameFromGeo=function(e,n=!0){return n&&r.DebugWarn.assert("object"==typeof(null==e?void 0:e[t.symbolTopoName]),"无法获取toponame"," ","2021-08-06"),null==e?void 0:e[t.symbolTopoName]},t.isTopoValueBasicType=s,t.isTopoNameValid=function(e){if("object"!=typeof e||null===e)return!1;let t=!1;try{const n=JSON.stringify(e);if(t=JSON.parse(n),e.constructor!==t.constructor)return!1}catch(e){return!1}let n=!1;for(const t of Object.keys(e)){const r=e[t];if(Array.isArray(r)){if(r.some((e=>!s(e))))return!1}else{if(!s(r))return!1;n=!0}}return!!n&&t}},56183:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeDefaultTopoFindFunc=t.defaultTopoFind=void 0;const r=n(98106);function s(e,t,n){let s=[...t];for(const t of n){const n=new Set(e[t]);let i=s.map((e=>{var r;const s=null===(r=e.topoName)||void 0===r?void 0:r[t];if(!(null==s?void 0:s.length))return;return{candidate:e,ratio:s.filter((e=>n.has(e))).length/s.length}})).filter((e=>null==e?void 0:e.ratio)).sort(((e,t)=>t.ratio-e.ratio));if(!i.length)return;if(i=i.filter((e=>r.MathUtil.isNearlyEqual(e.ratio,i[0].ratio))),1===i.length)return i[0].candidate;s=i.map((e=>e.candidate))}return s[0]}t.defaultTopoFind=s,t.makeDefaultTopoFindFunc=function(e){return(t,n)=>s(t,n,e)}},41207:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.syncTransact=t.transact=void 0;const s=n(95829),i=n(21498),o=n(17731),a=n(63912),c=n(40475);function l(e,t){const n=i.Selection.getInstance().getSelectedElementIds();if(n.length){const r=e.undoRedoEntity.getModifiedElements();n.find((e=>r.has(e)))&&i.Selection.getInstance().reset(n,null==t?void 0:t.selectionEventParam)}if((null==t?void 0:t.dontUpdateView)||e.doc.updateView(),null==t?void 0:t.mergeToLastTransaction){const t=e.parent;s.DebugWarn.assert(t,"事务没有parant?"," ","2020-08-03");const n=t.undoList.length,r=t.undoList[n-2],i=t.undoList[n-1];r instanceof o.Transaction&&i===e&&(r.merge(i),t.undoList.splice(n-1,1))}}function d(e,t,n){null==n||n.dontConsoleError,t.rollBack(),(null==n?void 0:n.dontUpdateView)||t.doc.updateView(),t.doc.cacheForElementsGraph.clear(),t.doc.cacheForElementsGraph.onElementsAdded(t.doc.filterElements()),a.eventManager.dispatchEvent(new a.TransactRollbackEvent)}function u(e,t,n){let r;e.debugMode.showTransactionTime&&(r=Date.now());const s=new o.Transaction(e,t);return s.canUndo=!(null==n?void 0:n.cantUndo),[r,s]}t.transact=function(e,t,n,s){return r(this,void 0,void 0,(function*(){const[r,i]=u(e,t,s);try{let t=!1;const r=n();if(r instanceof Promise&&(yield r.catch((e=>{null==s||s.dontConsoleError,t=!0}))),t)throw new Error("事务过程中异常");if((null==s?void 0:s.notRegenerate)||(yield e.regenerate(!(null==s?void 0:s.dontConsoleError)).catch((e=>{null==s||s.dontConsoleError,t=!0}))),t)throw new Error("关联更新异常");return i.dontSendCommitEvent=null==s?void 0:s.dontLogToTranscription,i.commit(),l(i,s),!0}catch(e){d(0,i,s)}finally{e.debugMode.showTransactionTime}return!1}))},t.syncTransact=function(e,t,n,r){const[s,i]=u(e,t,r);try{const t=n();if(c.assertNotPromise(t),!(null==r?void 0:r.notRegenerate)){const t=e.syncRegenerate(!(null==r?void 0:r.dontConsoleError));c.assertNotPromise(t)}return i.commit(),l(i,r),!0}catch(e){d(0,i,r)}finally{e.debugMode.showTransactionTime}return!1}},60102:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseTransaction=void 0;const r=n(53902),s=n(95829);t.BaseTransaction=class{constructor(e,t){this.doc=e,this._status=r.EN_TRANSACTION_STATUS.EN_NOT_STARTED,this.doc=e,this.name=t,this.start()}start(){var e;return this._status=r.EN_TRANSACTION_STATUS.EN_STARTED,"__root__"===this.name||(null===(e=this.doc.transactionMgr.getLastLeafTranGroup(!0))||void 0===e||e.clearRedoList(),this.parent=this.doc.transactionMgr.getCurrentTransactionGroup(),s.DebugWarn.assert(this.parent,"没有找到transactionGroup"," ","202-04-29"),this.parent.startTransaction(this)),!0}getStatus(){return this._status}isGroup(){return!1}commit(){return this._status=r.EN_TRANSACTION_STATUS.EN_COMMITTED,!0}rollBack(){return this._status=r.EN_TRANSACTION_STATUS.EN_ROLLED_BACK,!0}}},53902:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_TRANSACTION_STATUS=void 0,function(e){e.EN_NOT_STARTED="not-started",e.EN_STARTED="started",e.EN_COMMITTED="committed",e.EN_ROLLED_BACK="rolled_back"}(t.EN_TRANSACTION_STATUS||(t.EN_TRANSACTION_STATUS={}))},17731:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Transaction=void 0;const r=n(88755),s=n(60102),i=n(55083),o=n(63912);class a extends s.BaseTransaction{constructor(e,t){super(e,t),this.doc=e,this.canUndo=!0,this.undoRedoEntity=new r.UndoRedoEntity(e)}commit(){this.dontSendCommitEvent||o.eventManager.dispatchEvent(new o.TransactEvent(i.EN_EVENT_TYPE.TRANSACT_COMMIT,this.name));return this.undoRedoEntity.commit()||this.parent.popTransaction(this),super.commit(),!0}rollBack(){return this.undoRedoEntity.rollback(),this.parent.popTransaction(this),super.rollBack(),!0}reverseAndExcute(){this.undoRedoEntity.reverseAndExcute()}merge(e){return this.undoRedoEntity.merge(e.undoRedoEntity),this}isGroup(){return!1}collectUsedIds(e){this.undoRedoEntity.collectUsedIds(e)}}t.Transaction=a},50412:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TransactionGroup=void 0;const r=n(53902),s=n(60102),i=n(95829),o=n(17731);class a extends s.BaseTransaction{constructor(e,t){super(e,t),this.undoList=[],this.redoList=[],"__root__"!==t&&(this._timeStart=Date.now())}startTransaction(e){var t;i.DebugWarn.assert(this.getStatus()===r.EN_TRANSACTION_STATUS.EN_STARTED,"事务组已完成，不能再启动事务"," ","2020-04-26");const n=null===(t=this.getCurrentTransaction())||void 0===t?void 0:t.name,s=e.name;i.DebugWarn.assert(this.getStatus()===r.EN_TRANSACTION_STATUS.EN_STARTED&&!this.getCurrentTransaction(),`事务不能嵌套, 新事务${s}, 未完成的事务${n}`," ","2020-04-26"),this.undoList.push(e),this.redoList.splice(0);const o=Math.max(this._getMaxUndoStackSize(),4);if(this.undoList.length<=o)return;const a=this.undoList.shift();if(a&&this.parent){const e=this._toTransaction(a),t=this._toTransaction(this.undoList[0]);this.undoList[0]=e.merge(t)}}popTransaction(e){return i.DebugWarn.assert(this.undoList.pop()===e,"只能pop栈顶事务"," ","2020-04-26"),!0}getCurrentTransaction(){const e=this.undoList[this.undoList.length-1];if(e&&!e.isGroup()&&e.getStatus()===r.EN_TRANSACTION_STATUS.EN_STARTED)return e}getLastLeafTranGroup(e){let t;if(this.undoList[this.undoList.length-1])t=this.undoList[this.undoList.length-1];else{const n=e?this.undoList:this.redoList;t=n[n.length-1]}return t?t.isGroup()?t.getLastLeafTranGroup(e):t.parent:this}getCurrentTransactionGroup(){const e=[...this.undoList].reverse().find((e=>e.isGroup()&&e.getStatus()===r.EN_TRANSACTION_STATUS.EN_STARTED));return e?e.getCurrentTransactionGroup():this.getStatus()===r.EN_TRANSACTION_STATUS.EN_STARTED?this:void 0}commit(){var e;return super.commit(),this.undoList.length||null===(e=this.parent)||void 0===e||e.popTransaction(this),this.doc.updateView(),!0}rollBack(){var e;if(super.rollBack(),this._showTime(!1),!this.undoList.length)return null===(e=this.parent)||void 0===e||e.undoList.pop(),!0;const t=this._compressToTransaction(),n=this.parent;return n._replaceTailTransaction(this,t),n._undoWithoutRedo(t),!0}assimilate(){var e,t;if(super.commit(),this._showTime(!0),!this.undoList.length)return null===(e=this.parent)||void 0===e||e.undoList.pop(),!0;const n=this._compressToTransaction();return null===(t=this.parent)||void 0===t||t._replaceTailTransaction(this,n),this.doc.updateView(),!0}collectUsedIds(e){[...this.undoList,...this.redoList].forEach((t=>t.collectUsedIds(e)))}revert(){const e=this.undoList.pop();e&&!e.isGroup()&&e.undoRedoEntity.reverseAndExcute(!1)}undo(){const e=this.undoList[this.undoList.length-1];if(!e)return!1;if(e.isGroup()){const t=e;return!!t._undoListNotEmpty()&&t.undo()}return!!e.canUndo&&(e.reverseAndExcute(),this.undoList.pop(),this.redoList.push(e),!0)}redo(){const e=this.redoList[this.redoList.length-1];if(!e)return!1;if(e.isGroup()){const t=e;return!!t._redoListNotEmpty()&&t.redo()}return e.reverseAndExcute(),this.redoList.pop(),this.undoList.push(e),!0}canUndo(){const e=this.undoList[this.undoList.length-1];if(!e)return!1;if(e.isGroup()){const t=e;return!!t._undoListNotEmpty()&&t.canUndo()}return!!e.canUndo}canRedo(){const e=this.redoList[this.redoList.length-1];if(!e)return!1;if(e.isGroup()){const t=e;return!!t._redoListNotEmpty()&&t.redo()}return!0}isGroup(){return!0}clearRedoList(){this.redoList.splice(0)}setMaxUndoStackSize(e){this._maxUndoStackSize=e}_getMaxUndoStackSize(){var e;return this._maxUndoStackSize||(null===(e=this.parent)||void 0===e?void 0:e._getMaxUndoStackSize())||30}_replaceTailTransaction(e,t){return i.DebugWarn.assert(this.undoList[this.undoList.length-1]===e,"只能替换栈顶事务"," ","2020-04-26"),this.undoList[this.undoList.length-1]=t,t.parent=this,!0}_undoWithoutRedo(e){return e.reverseAndExcute(),this.undoList.pop(),!0}_toTransaction(e){return e.isGroup()?e._compressToTransaction():e}_compressToTransaction(){if(!this.undoList.length){const e=new o.Transaction(this.doc,"empty");return e._status=r.EN_TRANSACTION_STATUS.EN_COMMITTED,e}const e=this.undoList[0].name+"->"+this.undoList[this.undoList.length-1].name;for(;this.undoList.length>1;){const e=this._toTransaction(this.undoList.pop()),t=this._toTransaction(this.undoList[this.undoList.length-1]);this.undoList[this.undoList.length-1]=t,t.merge(e)}const t=this.undoList[0];return t.name=e,t.canUndo=!0,t}_undoListNotEmpty(){return!!this.undoList.length}_redoListNotEmpty(){return!!this.redoList.length}_showTime(e){}}t.TransactionGroup=a},86688:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TransactionMgr=void 0;const r=n(95829),s=n(50412);t.TransactionMgr=class{init(e){this._rootNode=new s.TransactionGroup(e,"__root__"),this.setMaxUndoStackSize(30)}clear(){this._rootNode.undoList.splice(0),this._rootNode.clearRedoList()}setMaxUndoStackSize(e){this._rootNode.setMaxUndoStackSize(e)}getCurrentTransaction(){const e=this._rootNode.getCurrentTransactionGroup();if(e)return e.getCurrentTransaction()}getCurrentTransactionGroup(){return this._rootNode.getCurrentTransactionGroup()}getLastLeafTranGroup(e){return this._rootNode.getLastLeafTranGroup(e)}getLastTransactNodeName(){let e=this._rootNode;for(;;){if(!e.isGroup())return e.name;{const t=e;if(!t.undoList.length)return e.name;e=t.undoList[t.undoList.length-1]}}}getTransactionCache(){return r.DebugWarn.assert(this.getCurrentTransaction(),"没有事务"," ","2020-04-24"),this.getCurrentTransaction().undoRedoEntity}undo(){var e;return!!(null===(e=this.getLastLeafTranGroup(!0))||void 0===e?void 0:e.undo())}redo(){var e;return!!(null===(e=this.getLastLeafTranGroup(!1))||void 0===e?void 0:e.redo())}canUndo(){var e;return!!(null===(e=this.getLastLeafTranGroup(!0))||void 0===e?void 0:e.canUndo())}canRedo(){var e;return!!(null===(e=this.getLastLeafTranGroup(!0))||void 0===e?void 0:e.canRedo())}idPoolGC(){const e=new Set;return this._rootNode.collectUsedIds(e),e}}},88755:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UndoRedoEntity=void 0;const r=n(95829),s=n(55083),i=n(63912),o=n(18064),a=n(62735);t.UndoRedoEntity=class{constructor(e){this._doc=e,this._added=new Set,this._deleted=new Set,this._modified=new Set,this._modifiedProperties=new Map}onElementsAdded(e){e.forEach((e=>this._added.add(e)))}onElementsUpdated(e){e.forEach((e=>this._modified.add(e.id.asInt())))}onElementsDeleted(e){e.forEach((e=>this._deleted.add(e)))}clear(){this._added.clear(),this._modified.clear(),this._modifiedProperties.clear(),this._deleted.clear()}collectUsedIds(e){[...this._added,...this._deleted].forEach((t=>e.add(t.id.asInt()))),[...this._modifiedProperties.keys()].forEach((t=>e.add(t)))}getModifiedElements(){const e=new Set;return this._added.forEach((t=>e.add(t.id.asInt()))),this._modified.forEach((t=>e.add(t))),e}getModifiedDatasToRegenerate(){const e=new Map;this._added.forEach((t=>{if(!t.shouldShowInPropertyGraphStatic())return;const n=t.db.ownKeys();let r=e.get(t.id.asInt());r||(r=[],e.set(t.id.asInt(),r)),n.forEach((e=>r.push(e)))})),this._modified.forEach((t=>{const n=this._doc.getElementById(t);if(r.DebugWarn.assert(n,"ele为空？"," ","2020-04-13"),!n.shouldShowInPropertyGraphStatic())return;const s=Object.keys(n.db._cachedNewData);if(s.length){let t=e.get(n.id.asInt());t||(t=[],e.set(n.id.asInt(),t)),s.forEach((e=>t.push(e)))}}));const t=[];for(const[n,r]of e)t.push({id:new o.ElementId(n),modifiedKeys:r});return t}commit(){if(this._compress(),this.isEmpty())return!1;const e=[];return this._modifiedProperties.clear(),this._modified.forEach((t=>{const n=this._doc.getElementById(t);r.DebugWarn.assert(n,"修改的Element为空"," ","2020-04-13");const s=n.db.getModified();!n.isTemporary()&&s&&s.length&&(this._modifiedProperties.set(t,s),e.push({element:n,modifiedKeys:s.map((e=>e.propertyName))})),n.db.commit()})),this._added.forEach((e=>e.db.commit())),this.updateDependencyGraph(),this._updateViewCache(),i.eventManager.dispatchEvent(new i.ElementEvent(s.EN_EVENT_TYPE.ELEMENT_CREATE,[...this._added].map((e=>({element:e}))))),i.eventManager.dispatchEvent(new i.ElementEvent(s.EN_EVENT_TYPE.ELEMENT_DID_UPDATE,e)),i.eventManager.dispatchEvent(new i.ElementEvent(s.EN_EVENT_TYPE.ELEMENT_DID_DELETE,[...this._deleted].map((e=>({element:e}))))),!0}merge(e){const t=new Set([...e._added]),n=new Set([...e._deleted]),s=new Map;e._modifiedProperties.forEach(((e,t)=>s.set(t,e)));for(const e of[...this._added])r.DebugWarn.assert(!t.has(e),"不可能发生"," ","2020-04-24"),n.has(e)?(this._added.delete(e),n.delete(e)):s.delete(e.id.asInt());for(const e of[...this._deleted])r.DebugWarn.assert(!t.has(e)&&!n.has(e)&&!s.has(e.id.asInt()),"不可能发生"," ","2020-04-24");for(const[e,i]of[...this._modifiedProperties])if([...t].find((t=>t.id.asInt()===e)))r.DebugWarn.assert(!1,"不可能发生"," ","2020-04-24");else if(s.has(e)){s.get(e).forEach((e=>{const t=i.find((t=>t.propertyName===e.propertyName));t?t.newValue=e.newValue:i.push(e)})),s.delete(e)}else if([...n].find((t=>t.id.asInt()===e))){this._modifiedProperties.delete(e);const t=[...n].find((t=>t.id.asInt()===e));i.forEach((({propertyName:e,oldValue:n})=>{t.db._db[e]=n}))}t.forEach((e=>this._added.add(e))),n.forEach((e=>this._deleted.add(e))),s.forEach(((e,t)=>{this._modifiedProperties.set(t,e)})),this._modified.clear(),this._modifiedProperties.forEach(((e,t)=>this._modified.add(t)))}updateDependencyGraph(){this._compress();const e=[...this._added].filter((e=>!!this._doc.getElementById(e.id))),t=[];this._modified.forEach((e=>{const n=this._doc.getElementById(e);r.DebugWarn.assert(n,"修改的Element为空?"," ","2020-04-13"),t.push(n)})),this._doc.cacheForElementsGraph.onElementsAdded(e),this._doc.cacheForElementsGraph.onElementsUpdated(t),this._doc.cacheForElementsGraph.onElementsDeleted([...this._deleted])}rollback(){return this._handleElementsFromDB("delete",...this._added),this._handleElementsFromDB("add",...this._deleted),this._modified.forEach((e=>{const t=this._doc.getElementById(e);t&&t.db.rollBack()})),!0}reverseAndExcute(e=!0){this._reverse(),this._execute(e)}revert(){const e=this._doc.elementMgr;this._deleted.forEach((t=>e.add(t))),this._doc.transactionMgr.getTransactionCache().onElementsAdded([...this._deleted]),this._doc.deleteElementsById(...[...this._added].map((e=>e.id)));for(const[e,t]of this._modifiedProperties){const n=this._doc.getElementById(e);r.DebugWarn.assert(n,"element为空？"," ","2020-04-13");for(const{oldValue:e,propertyName:r}of t)n.db[r]=e}}isEmpty(){return!this._added.size&&!this._deleted.size&&!this._modified.size}_compress(){for(const e of this._added)this._modified.has(e.id.asInt())&&(e.db.commit(),this._modified.delete(e.id.asInt()));for(const e of this._deleted)this._modified.has(e.id.asInt())&&(e.db.rollBack(),this._modified.delete(e.id.asInt()));for(const e of[...this._deleted])this._added.has(e)&&(this._deleted.delete(e),this._added.delete(e))}_updateViewCache(){const e=new Set;for(const[t,n]of this._modifiedProperties){const s=this._doc.getElementById(t);r.DebugWarn.assert(s,"element为空？"," ","2020-04-13"),n.find((({propertyName:e})=>a.shouldCacheToView(s,e)))&&e.add(s)}this._doc.cacheForView.cacheElementChanged(s.EN_EVENT_TYPE.ELEMENT_DID_UPDATE,[...e]),this._doc.cacheForView.cacheElementChanged(s.EN_EVENT_TYPE.ELEMENT_CREATE,[...this._added]),this._doc.cacheForView.cacheElementChanged(s.EN_EVENT_TYPE.ELEMENT_DID_DELETE,[...this._deleted])}_execute(e=!0){this._handleElementsFromDB("add",...this._added);const t=[];for(const[e,n]of this._modifiedProperties){const s=this._doc.getElementById(e);r.DebugWarn.assert(s,"element为空？"," ","2020-04-13"),t.push({element:s,modifiedKeys:n.map((e=>e.propertyName))});for(const e of n)r.DebugWarn.assert(void 0===s.db._cachedNewData[e.propertyName],"数据没有提交？"," ","2020-04-13"),s.db._db[e.propertyName]=e.newValue}this._handleElementsFromDB("delete",...this._deleted),this.updateDependencyGraph(),this._updateViewCache(),e&&(i.eventManager.dispatchEvent(new i.ElementEvent(s.EN_EVENT_TYPE.ELEMENT_CREATE,[...this._added].map((e=>({element:e}))))),i.eventManager.dispatchEvent(new i.ElementEvent(s.EN_EVENT_TYPE.ELEMENT_DID_UPDATE,t)),i.eventManager.dispatchEvent(new i.ElementEvent(s.EN_EVENT_TYPE.ELEMENT_DID_DELETE,[...this._deleted].map((e=>({element:e}))))))}_reverse(){const e=[...this._added],t=[...this._deleted];this._added.clear(),this._deleted.clear(),e.forEach((e=>this._deleted.add(e))),t.forEach((e=>this._added.add(e)));for(const[e,t]of this._modifiedProperties){const n=this._doc.getElementById(e);r.DebugWarn.assert(n,"element为空？"," ","2020-04-13");for(const e of t)[e.oldValue,e.newValue]=[e.newValue,e.oldValue]}}_handleElementsFromDB(e,...t){const n=this._doc.elementMgr;t.forEach((t=>{r.DebugWarn.warn(!t.db.isTransient(),"数据没有入库？"," ","2020-04-13"),"add"===e?n.add(t):n.delete(t)}))}}},95031:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.keyOf=void 0,t.keyOf=function(e){return e}},40475:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assertNotPromise=void 0;const r=n(95829);t.assertNotPromise=function(e){r.DebugWarn.assert(!(e instanceof Promise),"只能调同步方法"," ","2021-06-01")}},51923:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.symbolOriginUVBox=t.ENUM_COLOR_MODE=t.ENUM_PAVE_METHOD=void 0,function(e){e.REPEAT="repeat",e.STRETCH="stretch"}(t.ENUM_PAVE_METHOD||(t.ENUM_PAVE_METHOD={})),function(e){e.texture="texture",e.color="color",e.blend="blend"}(t.ENUM_COLOR_MODE||(t.ENUM_COLOR_MODE={})),t.symbolOriginUVBox=Symbol("symbolOriginUVBox")},26874:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.doNothing=t.sleep=t.isIntersect=t.CreateModelViewGrep=t.addAxis=t.AddGridHelper=t.colorStr2Hex=t.intToCssColor=t.rgbToHex=t.unsafeClone=t.isNumber=void 0;const r=n(98106),s=n(98106),i=n(95829),o=n(66480);function a(e,t=10,n=10,s=4473924,i=8947848,a,c){const l=[],d=n/2,u=t/n,h=t/2;for(let e=0,t=-h;e<=n;e++,t+=u){const n=new r.Line3d(c?c.getPtAt(new r.Vector3(-h,t,0)):new r.Vector3(-h,t,0),c?c.getPtAt(new r.Vector3(h,t,0)):new r.Vector3(h,t,0)),a=new r.Line3d(c?c.getPtAt(new r.Vector3(t,-h,0)):new r.Vector3(t,-h,0),c?c.getPtAt(new r.Vector3(t,h,0)):new r.Vector3(t,h,0)),u=e===d?s:i;l.push(new o.GCurve3d(n).setStyle({line:{color:u}})),l.push(new o.GCurve3d(a).setStyle({line:{color:u}}))}for(const t of l)t.canGpuPick=!1,t.visible=a,e.addNode(t)}function c(e,t,n,s){if(!t)return;const i=[],a=2e4,c=new r.Line3d(n?n.getPtAt(r.Vector3.O()):r.Vector3.O(),n?n.getPtAt(r.Vector3.X(a)):r.Vector3.X(a)),l=new r.Line3d(n?n.getPtAt(r.Vector3.O()):r.Vector3.O(),n?n.getPtAt(r.Vector3.Y(a)):r.Vector3.Y(a)),d=new r.Line3d(n?n.getPtAt(r.Vector3.O()):r.Vector3.O(),n?n.getPtAt(r.Vector3.Z(a)):r.Vector3.Z(a));if(i.push(new o.GCurve3d(c).setStyle({line:{color:16711680}})),i.push(new o.GCurve3d(l).setStyle({line:{color:65280}})),i.push(new o.GCurve3d(d).setStyle({line:{color:255}})),!s){const e=new r.Line3d(new r.Vector3,new r.Vector3(0,-2e4,0));i.push(new o.GCurve3d(e).setStyle({line:{color:65280,dotted:!0}}))}for(const t of i)t.canGpuPick=!1,e.addNode(t)}t.isNumber=function(e){return e===+e},t.unsafeClone=function e(t){const n=Array.isArray(t);if(n||!n&&t instanceof Object){if(t.clone instanceof Function)return t.clone();if(t instanceof Date)return new Date(t);const r=n?[]:{};return Object.keys(t).forEach((n=>{r[n]=e(t[n])})),r}return t},t.rgbToHex=function([e,t,n]){return(1<<24)+(e<<16)+(t<<8)+n},t.intToCssColor=function(e){const t=e.toString(16);return`#${new Array(6-t.length+1).join("0")}${t}`},t.colorStr2Hex=function(e){let t=e.match(/^#([0-9a-fA-F]{6})$/);return t?parseInt(t[1],16):(t=e.match(/^#([0-9a-fA-F]{3})$/),t?parseInt(t[1].split("").map((e=>`${e}${e}`)).join(""),16):(i.DebugWarn.warn(!1,`[pm]: parse color str ${e} to hex value failed`," ","2020-04-13"),16777215))},t.AddGridHelper=a,t.addAxis=c;const l=11184810;t.CreateModelViewGrep=function(e,t,n){a(e,1e4,100,l,l,t),c(e,n)},t.isIntersect=function(e,t,n,i){const o=new r.Vector2(e,t).normalize();o.vecRotate(r.CONST.PI_2);const a=new r.Vector2(n,e).normalize();let c=o.angleTo(a);s.MathUtil.isNearlyBigger(c,r.CONST.PI_2)&&(c=r.CONST.PI-c);const l=Math.cos(c)*e.distanceTo(n);if(Number.isNaN(l))return!1;if(s.MathUtil.isNearlySmallerOrEqual(l,i)){const i=n.clone().add(o.multiplied(l)),a=new r.Vector2(e,i).normalize(),c=new r.Vector2(i,t).normalize();if(s.MathUtil.isNearlyEqual(a.angle(c),0))return!0;const d=n.clone().add(o.multiplied(-l)),u=new r.Vector2(e,d).normalize(),h=new r.Vector2(d,t).normalize();if(s.MathUtil.isNearlyEqual(u.angle(h),0))return!0}return!1};t.sleep=e=>new Promise((t=>setTimeout(t,e))),t.doNothing=function(...e){}},67821:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setUVToRenderMesh=void 0;const r=n(98106),s=n(51923);t.setUVToRenderMesh=function(e,t,n,i,o=!1,a=!0){const c=e&&e.getBirthVersion()||0,l=[];if(t instanceof Float32Array)for(let e=0;e<t.length;e+=2)l.push({x:t[e],y:t[e+1]});else t.forEach((([e,t])=>l.push({x:e,y:t})));i[s.symbolOriginUVBox]=new r.Box2(l),o||function(e,t,n=!0,i=1){const o=(null==t?void 0:t.rotation)||0,a=(null==t?void 0:t.tileSizeX)||1,c=(null==t?void 0:t.tileSizeY)||1,l=(null==t?void 0:t.paveMethod)||s.ENUM_PAVE_METHOD.REPEAT,d=(null==t?void 0:t.offsetX)||0,u=(null==t?void 0:t.offsetY)||0,h=(null==t?void 0:t.scaleX)||1,g=(null==t?void 0:t.scaleY)||1,f=new r.Box2(e);let p=a,_=c;const m=f.getSize();l===s.ENUM_PAVE_METHOD.STRETCH&&(p=m.x,_=m.y);const v=new r.Matrix3;n&&v.applyTranslate(f.min.reverse()),v.applyScale(r.Vector2.O(),{x:1/(h*p),y:1/(g*_)});let E=new r.Vector2(d/(h*p),u/(g*_));if(0===i&&(E=new r.Vector2(h*p,g*_)),o%360){const e=r.MathUtil.degreeToRadius(o);v.applyRotate(r.Vector2.O(),e),E.rotate(r.Vector2.O(),e)}(d||u)&&(0===i?v.applyTranslate({x:d/E.x,y:u/E.y}):v.applyTranslate(E)),!v.isIdentity()&&e.forEach((e=>{const t=new r.Vector2(e).transform(v);e.x=t.x,e.y=t.y}))}(l,n,a,c),i.setUVs(l)}},47475:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorkPlane=t.castIGface=void 0;const r=n(3319),s=n(98106),i=n(95829),o=n(18064);function a(e){if(e&&"number"==typeof e.id&&e.elementId instanceof o.ElementId&&e.geo instanceof r.Face)return e}t.castIGface=a;class c{constructor(e,t){this._name="工作平面",this._gnodeElementID=o.ElementId.INVALID,e instanceof s.Plane?this._ctorByPlane(e):a(e)?this._ctorByGFace(e,t):this._ctorByPlane(s.Plane.XOY())}clone(){const e=new c;return e._plane=this._plane,e._gnodeElementID=this._gnodeElementID,e}get plane(){return this._plane}set plane(e){this._plane=e}get name(){return this._name}set name(e){this._name=e}getGFaceElementId(){return this._gnodeElementID}dump(){return{plane:this._plane.dump(),gnodeElementID:this._gnodeElementID.asInt(),name:this._name}}load(e){return this._plane=s.Plane.XOY().load(e.plane),this._gnodeElementID=new o.ElementId(e.gnodeElementID),this._name=e.name,this}_ctorByPlane(e){this._plane=e}_ctorByGFace(e,t){i.DebugWarn.warn(t,"doc为空"," ","2020-04-29"),this._gnodeElementID=e.elementId;t.getElementById(e.elementId)||i.DebugWarn.warn(!1,`can not find associate element by element id [${e.elementId}]`,"","");const n=e.geo.getSurface();n instanceof s.Plane?this._plane=n.clone():(i.DebugWarn.warn(!1,"workingplane picking a non-plane surface, use XOY plane instead","",""),this._plane=s.Plane.XOY())}}t.WorkPlane=c},79773:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApiCamera=void 0;const r=n(37419),s=n(85749),i=n(96191);t.ApiCamera=class{constructor(e){this._controller=e}setOrbitControllerLockRotation(e){return this._controller.setOrbitControllerLockRotation(e)}getOrbitControllerLockRotation(){return this._controller.getOrbitControllerLockRotation()}update(e=!0){if(e)this._updateControllers();else{this._controller.getCurrentController().update(),this._controller.updateIRender()}}get left(){const e=this._orthogonal();return e?e.left:0}get right(){const e=this._orthogonal();return e?e.right:0}get top(){const e=this._orthogonal();return e?e.top:0}get near(){let e=this._orthogonal();return e?e.near:(e=this._perspective(),e?e.near:0)}set near(e){const t=this._perspective();t&&(t.near=e)}get far(){let e=this._orthogonal();return e?e.far:(e=this._perspective(),e?e.far:0)}set far(e){const t=this._perspective();t&&(t.far=e)}get position(){return this._getCamera().position}set position(e){this._controller.updateCurrentCameraPosition(e)}get forward(){return this._getCamera().forward}get up(){return this._getCamera().up}set up(e){this._getCamera().up=e}get fov(){const e=this._perspective();return e?e.fov:0}set fov(e){const t=this._perspective();t&&(t.fov=e)}get aspect(){const e=this._perspective();return e?e.aspect:1}set aspect(e){const t=this._perspective();t&&(t.aspect=e)}set zoom(e){const t=this._orthogonal();t&&(t.zoom=e)}get zoom(){const e=this._orthogonal();return e?e.zoom:0}setViewDirection(e,t,n,r){this._controller.resetViewDirection(e,t,n,r)}setNamedViewDirection(e){this._controller.resetNamedViewDirection(e)}get target(){return this._controller.getTarget()}set target(e){const t=this._controller.getCurrentController();t instanceof i.OrbitController&&t.setTarget(e)}isOrthogonal(){return this._getCamera()instanceof r.OrthogonalCamera}isOrbitControl(){return this._controller.getCurrentController()instanceof i.OrbitController}lookAt(e){if(!this.isOrbitControl())return;const t=e.getDz(),n=e.getOrigin(),r=e.getDy(),s=this.position.subtracted(this.target),i=n.added(t.multiplied(s.getLength()));this._controller.resetViewDirection(i,n,r)}leftPressed(e){this._pressed("leftPressed",e)}rightPressed(e){this._pressed("rightPressed",e)}forwardPressed(e){this._pressed("forwardPressed",e)}backPressed(e){this._pressed("backPressed",e)}upPressed(e){this._pressed("upPressed",e)}downPressed(e){this._pressed("downPressed",e)}_getCamera(){return this._controller.getCurrentCamera()}_orthogonal(){if(this.isOrthogonal())return this._getCamera()}_perspective(){if(!this.isOrthogonal())return this._getCamera()}_updateControllers(){const e=this._controller.getCurrentController(),t=this._getCamera();if(e instanceof s.FirstPersonController){const t=this._perspective();t&&e.reset(t)}else e.reset(t,e.getTarget());this._controller.updateIRender()}_pressed(e,t){this._controller.getCurrentController()[e]=t}}},66231:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.config=void 0;const r=n(31667),s=n(82658);function i(e=[],t){return e.length?{[e[0]]:i(e.slice(1),t)}:t}t.config=function(e,t){c(i(e&&e.split(".")||[],t))};const o={};function a(e,t){if(!e)throw new Error("Field path is empty");const n=e.split(".");let r=o;for(const e of n.slice(0,n.length-1)){if(e in r||(r[e]={}),"object"!=typeof r[e])throw new Error(`${e} already registered`);r=r[e]}r[n.pop()]=t}function c(e,t=o){if("object"!=typeof e)throw new Error(`set configuration failed: ${e}`);for(const[n,r]of Object.entries(e)){const e=t[n];if(!e)throw new Error(`${n} not registered`);e instanceof Function?e(r):c(r,e)}}[r.categoryInvalid,r.categoryModelLine].forEach((e=>{a(`category.${e.id}.style2d`,e.setStyle.bind(e))})),Object.keys(s.appConfig).forEach((e=>{Object.keys(s.appConfig[e]).forEach((t=>{a(`app.${e}.${t}`,(n=>{s.appConfig[e][t]=n}))}))}))},19180:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Action=t.ActionResult=void 0;const s=n(31667),i=n(16724),o=n(98295),a=n(70768);var c;!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.CANCELED=1]="CANCELED"}(c||(c={}));class l{constructor(e,t){this._status=e,this._data=t}get data(){return this._data}get isSuccess(){return this._status===c.SUCCESS}get isCanceled(){return this._status===c.CANCELED}}t.ActionResult=l;t.Action=class{getPromise(){return this._promise}isFinished(){return this._isFinished}isCanceled(){return this._isCanceled}init(e){this._view=e,this._tmpElementPainters=[new s.TmpElementPainter(this.getCurrentDoc())],this._promise=new Promise((e=>this._resolve=e)),this._isFinished=!1}getIView(){return this._view}getCurrentDoc(){return this.getIView().getDocument()}run(){return r(this,void 0,void 0,(function*(){}))}processKeyboardEvent(e){return e.type===i.EN_KEYBOARD_EVENT_TYPE.KEY_UP?this._onKeyUp(e):this._onKeyDown(e)}processMouseEvent(e,t,n){switch(e){case i.EN_MOUSE_EVENT_TYPE.MOUSE_ENTER:return this._onMouseEnter(t,n);case i.EN_MOUSE_EVENT_TYPE.MOUSE_MOVE:return this._onMouseMove(t,n);case i.EN_MOUSE_EVENT_TYPE.L_BUTTON_DOWN:return this._onLButtonDown(t,n);case i.EN_MOUSE_EVENT_TYPE.L_BUTTON_UP:return this._onLButtonUp(t,n);case i.EN_MOUSE_EVENT_TYPE.R_CLICK:return this._onRClick(t,n);case i.EN_MOUSE_EVENT_TYPE.R_BUTTON_DOWN:return this._onRButtonDown(t,n);case i.EN_MOUSE_EVENT_TYPE.R_BUTTON_UP:return this._onRButtonUp(t,n);case i.EN_MOUSE_EVENT_TYPE.M_BUTTON_DOWN:return this._onMButtonDown(t,n);case i.EN_MOUSE_EVENT_TYPE.M_BUTTON_UP:return this._onMButtonUp(t,n);case i.EN_MOUSE_EVENT_TYPE.WHEEL_FORWARD:return this._onWheelForward(t,n);case i.EN_MOUSE_EVENT_TYPE.WHEEL_BACKWARD:return this._onWheelBackward(t,n);case i.EN_MOUSE_EVENT_TYPE.CLICK:return this._onClick(t,n);case i.EN_MOUSE_EVENT_TYPE.SGL_CLICK:return this._onSglClick(t,n);case i.EN_MOUSE_EVENT_TYPE.DBL_CLICK:return this._onDblClick(t,n);case i.EN_MOUSE_EVENT_TYPE.DRAG_START:return this._onDragStart(t,n);case i.EN_MOUSE_EVENT_TYPE.DRAG_MOVE:return this._onDragMove(t,n);case i.EN_MOUSE_EVENT_TYPE.DRAG_END:return this._onDragEnd(t,n);case i.EN_MOUSE_EVENT_TYPE.MOUSE_LEAVE:return this._onMouseLeave(t,n);default:return!1}}cancel(){this._isCanceled||(this._isCanceled=!0,this._markCanceled())}clearTmp(){for(const e of this._tmpElementPainters)e&&e.clearTmp()}getBuildInTmpElementPainter(){return this._tmpElementPainters[0]}getTmpElementPainters(){return this._tmpElementPainters}getTmpElementPainterByIndex(e){if(!(e<0||e>=this._tmpElementPainters.length))return this._tmpElementPainters[e];s.DebugWarn.assert(!1,"index无效"," ","2020-08-27")}clearUsersTmpElementPainters(){for(let e=1;e<this._tmpElementPainters.length;e++)this._tmpElementPainters[e].destroy();this._tmpElementPainters.splice(1)}applyNewTmpElementPainter(){const e=new s.TmpElementPainter(this.getCurrentDoc());return this._tmpElementPainters.push(e),e}setStatusBarInfo(e){const t=new s.MessageEvent(s.EN_EVENT_TYPE.MESSAGE_STAUS_BAR_INFO,e);s.eventManager.dispatchEventDelay(t,50)}markCanceled(){this._markCanceled()}markSuccess(e){this._markSuccess(e)}toast(e,t=!1){const n=t?s.EN_EVENT_TYPE.MESSAGE_NOTICE:s.EN_EVENT_TYPE.MESSAGE_TOAST,r=new s.MessageEvent(n,e);s.eventManager.dispatchEventDelay(r,50)}showMouseTip({tip:e,pos:t,image:n}){s.eventManager.dispatchEvent(new s.Event(s.EN_EVENT_TYPE.MESSAGE_MOUSE_TEXT1,{x:t.x+20,y:t.y-35,text:e,image:n}))}hideMouseTip(){this.showMouseTip({pos:{x:0,y:0},tip:""})}drawTmpGRep(e,t=8947848,n=0,r=!1){this._drawTmpGRep(e,t,n,r)}_onResume(){}_markCanceled(e){this._markFinished(),this._resolve(new l(c.CANCELED,e))}_markSuccess(e){this._markFinished(),this._resolve(new l(c.SUCCESS,e))}_runChildAction(e){return r(this,void 0,void 0,(function*(){return o.ActionManager.getInstance().runAction(e)}))}_onKeyDown(e){return"esc"===e.key&&(!(o.ActionManager.getInstance()._actionStack.length<2)&&(this._markCanceled(),!0))}_onMouseEnter(e,t){return(null===window||void 0===window?void 0:window.focus)&&window.focus(),!1}_onMouseLeave(e,t){return!1}_onKeyUp(e){return!1}_onLButtonDown(e,t){return!1}_onLButtonUp(e,t){return!1}_onMButtonDown(e,t){return!1}_onMButtonUp(e,t){return!1}_onWheelForward(e,t){return!1}_onWheelBackward(e,t){return!1}_onRButtonDown(e,t){return!(o.ActionManager.getInstance()._actionStack.length<2)&&(this._markCanceled(),!0)}_onRButtonUp(e,t){return!1}_onMouseMove(e,t){return!1}_onClick(e,t){return!1}_onRClick(e,t){return!1}_onSglClick(e,t){return!1}_onDblClick(e,t){return!1}_onDragStart(e,t){return!1}_onDragMove(e,t){return!1}_onDragEnd(e,t){return!1}_drawTmpCurve(e){this.getBuildInTmpElementPainter().drawTmpCurve(e)}_drawTmpLine(e,t,n){this.getBuildInTmpElementPainter().drawTmpLine(e,t,n)}_drawTmpRect(e,t,n){this.getBuildInTmpElementPainter().drawTmpRect(e,t,n)}_drawTmpTriangle(e,t,n){this.getBuildInTmpElementPainter().drawTmpTriangle(e,t,n)}_drawTmpGRep(e,t=8947848,n=0,r=!1){n<0||n>=this._tmpElementPainters.length?s.DebugWarn.assert(!1,"index无效"," ","2020-08-27"):this._tmpElementPainters[n].drawTmpGRep(e,t,r)}_updateView(){this.getCurrentDoc().updateView()}_onFinished(){}_markFinished(){if(!this._isFinished){this._isFinished=!0;for(const e of this._tmpElementPainters)e.destroy();this._tmpElementPainters=[],this._onFinished(),a.platformEventMgr.emit(a.EN_PLATFORM_EVENT_TYPE.ACTION_FINISHED)}}}},57491:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompoundAction=void 0;const r=n(19180);function s(e,t,n,r){let s=!1;return e.forEach((e=>{const i=e[t](n,r);i&&(s=i)})),s}class i extends r.Action{constructor(){super(...arguments),this._mouseCallbacks=[]}_onLButtonDown(e,t){return s(this._mouseCallbacks,"onLButtonDown",e,t)}_onLButtonUp(e,t){return s(this._mouseCallbacks,"onLButtonUp",e,t)}_onMButtonDown(e,t){return s(this._mouseCallbacks,"onMButtonDown",e,t)}_onMButtonUp(e,t){return s(this._mouseCallbacks,"onMButtonUp",e,t)}_onWheelForward(e,t){return s(this._mouseCallbacks,"onWheelForward",e,t)}_onWheelBackward(e,t){return s(this._mouseCallbacks,"onWheelBackward",e,t)}_onRButtonDown(e,t){return s(this._mouseCallbacks,"onRButtonDown",e,t)}_onRButtonUp(e,t){return s(this._mouseCallbacks,"onRButtonUp",e,t)}_onMouseMove(e,t){return s(this._mouseCallbacks,"onMouseMove",e,t)}_onClick(e,t){return s(this._mouseCallbacks,"onClick",e,t)}_onRClick(e,t){return s(this._mouseCallbacks,"onRClick",e,t)}_onSglClick(e,t){return s(this._mouseCallbacks,"onSglClick",e,t)}_onDblClick(e,t){return s(this._mouseCallbacks,"onDblClick",e,t)}_onDragStart(e,t){return s(this._mouseCallbacks,"onDragStart",e,t)}_onDragMove(e,t){return s(this._mouseCallbacks,"onDragMove",e,t)}_onDragEnd(e,t){return s(this._mouseCallbacks,"onDragEnd",e,t)}_onMouseLeave(e,t){return s(this._mouseCallbacks,"onMouseLeave",e,t)}_onKeyDown(e){let t=!1;return this._mouseCallbacks.forEach((n=>{const r=n.onKeyDown(e);r&&(t=r)})),t}}t.CompoundAction=i},10196:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IActionMouseCallbackToSelect=t.IActionMouseCallbackToHighlight=t.IActionMouseCallback=void 0;const r=n(16088);class s{constructor(e){this._masterAction=e}onLButtonDown(e,t){return!1}onLButtonUp(e,t){return!1}onMButtonDown(e,t){return!1}onMButtonUp(e,t){return!1}onRButtonDown(e,t){return!1}onRButtonUp(e,t){return!1}onMouseMove(e,t){return!1}onWheelForward(e,t){return!1}onWheelBackward(e,t){return!1}onClick(e,t){return!1}onRClick(e,t){return!1}onSglClick(e,t){return!1}onDblClick(e,t){return!1}onDragStart(e,t){return!1}onDragMove(e,t){return!1}onDragEnd(e,t){return!1}onMouseLeave(e,t){return!1}onKeyDown(e){return"esc"===e.key&&(!(r.ActionManager.getInstance()._actionStack.length<2)&&(this._masterAction.markCanceled(),!0))}}t.IActionMouseCallback=s;t.IActionMouseCallbackToHighlight=class extends s{setCpuPickFunction(e){return this._cpuPick=r.throttle(((t,n)=>e(t,n)),100),this}};t.IActionMouseCallbackToSelect=class extends s{setCpuPickFunction(e){return this._cpuPick=r.throttle(((t,n)=>e(t,n)),100),this}}},92429:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IElementDragStrategy=void 0;t.IElementDragStrategy=class{static handleElement(e){return!1}onMouseLeave(e,t){return!1}onKeyDown(e){return!1}canBeDraggedWhenNotSelected(){return!1}}},4196:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MouseCallbackToHighLight=void 0;const r=n(31667),s=n(50347),i=n(10196);class o extends i.IActionMouseCallbackToHighlight{constructor(){super(...arguments),this._isLButtonDown=!1}onLButtonDown(e,t){return this._isLButtonDown=!0,t.shiftKey&&(this._screenPt1=e),!1}onLButtonUp(e,t){return this._isLButtonDown=!1,delete this._screenPt1,!1}onMouseMove(e,t){var n,i;if(this._isLButtonDown)return!1;if(this._screenPt1)return!1;this._masterAction.clearTmp();let[o]=s.PickUtil.pickGNode(this._masterAction.getIView(),e);return!o&&this._cpuPick&&(o=this._cpuPick(this._masterAction.getIView(),e)[0]),(null===(n=null==o?void 0:o.elementId)||void 0===n?void 0:n.isValid())?(o&&"center"===(null===(i=o.userData)||void 0===i?void 0:i.snapType)||o&&o.elementId&&o.elementId.isValid()&&r.HighLight.getInstance().getActiveObjects().has(o.elementId.asInt())||(r.HighLight.getInstance().reset(o.elementId.asInt()),this._masterAction._updateView()),!1):(r.HighLight.getInstance().clear(),this._masterAction._updateView(),!1)}}t.MouseCallbackToHighLight=o},87219:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MouseCallbackToSelect=void 0;const r=n(31667),s=n(10196),i=n(50347);class o extends s.IActionMouseCallbackToSelect{onClick(e,t){var n;const[s]=i.PickUtil.pickGNodes(this._masterAction.getIView(),e,void 0,void 0,!1);let o=s[0];if(!o&&this._cpuPick&&(o=this._cpuPick(this._masterAction.getIView(),e)[0]),r.HighLight.getInstance().clear(),!(null===(n=null==o?void 0:o.elementId)||void 0===n?void 0:n.isValid())&&!t.shiftKey)return r.Selection.getInstance().clear(),this._masterAction._updateView(),!1;if(o){if(t.shiftKey){r.Selection.getInstance().getSelectedElementIds().includes(o.elementId.asInt())?r.Selection.getInstance().delete([o.elementId.asInt()]):r.Selection.getInstance().add([o.elementId.asInt()],e)}else r.Selection.getInstance().reset([o.elementId.asInt()],e);this._masterAction._updateView()}return!1}}t.MouseCallbackToSelect=o},3376:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MouseCallbackToDrag=void 0;const r=n(31667),s=n(50347),i=n(10196),o=n(51918),a=n(69127),c=n(79762);class l extends i.IActionMouseCallback{constructor(){super(...arguments),this._isDraging=!1}static getInstance(){if(!l._instance){const e=new a.DefaultAction;e.init(c.app.getCurrentView()),l._instance=new l(e)}return l._instance}static registerDragStrategy(e){this._registeredStrategy.push(e)}static setDefaultDragStrategy(e){this._defaultStrategy=e}hasRegisteredStrategy(e){return!!l._registeredStrategy.find((t=>t.handleElement(e)))}onLButtonDown(e,t){return[this._mouseDownPicked]=s.PickUtil.pickGNode(this._masterAction.getIView(),e,void 0,void 0,!1),!1}onDragStart(e,t){var n;this._isDraging=!0,r.HighLight.getInstance().clear();const s=this._masterAction.getCurrentDoc().getElementById((null===(n=this._mouseDownPicked)||void 0===n?void 0:n.elementId)||-1);if(!(null==s?void 0:s.canBeMoved()))return!1;this._ug=new r.TransactionGroup(this._masterAction.getCurrentDoc(),"drag element");const i=l._registeredStrategy.find((e=>e.handleElement(s)))||l._defaultStrategy;return!!i&&(this._strategy=new i,this._strategy.canBeDraggedWhenNotSelected()||r.Selection.getInstance().getSelectedElementIds()[0]===s.id.asInt()?this._strategy.onDragStart(s,this._masterAction.getIView(),e,t):(delete this._strategy,!1))}onDragMove(e,t){var n,s;try{return null===(n=this._strategy)||void 0===n||n.onDragMove(this._masterAction.getIView(),e,t),!!this._strategy}catch(e){return null===(s=this._ug)||void 0===s||s.rollBack(),r.Selection.getInstance().clear(),this._masterAction._updateView(),delete this._ug,delete this._strategy,this._isDraging=!1,!0}}onDragEnd(e,t){var n,r;return!!this._ug&&(null===(n=this._strategy)||void 0===n||n.onDragEnd(this._masterAction.getIView(),e,t),null===(r=this._ug)||void 0===r||r.assimilate(),delete this._ug,delete this._strategy,this._isDraging=!1,!!this._strategy)}onMouseLeave(e,t){return this._onCancel(),!0}onKeyDown(e){return"esc"===e.key&&(this._onCancel(),!0)}_onCancel(){var e;this._isDraging&&(o.GripHelper.clear(this._masterAction.getCurrentDoc()),this._isDraging=!1,null===(e=this._ug)||void 0===e||e.rollBack(),delete this._ug,delete this._strategy,this._masterAction.clearTmp(),this._masterAction.clearUsersTmpElementPainters(),this._masterAction.setStatusBarInfo({}),this._masterAction._updateView())}}t.MouseCallbackToDrag=l,l._registeredStrategy=[]},11644:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.App=void 0;const s=n(31667),i=n(98295),o=n(87724),a=n(39778),c=n(79773),l=n(66231);class d{constructor(){this.logRecorder=new a.LogRecorder,this._viewMap=new Map,this._setCurView=e=>{this._currentView!==e&&(this._currentView&&(this._currentView.deactivateInput(),i.ActionManager.getInstance().resetAllActions()),this._currentView=e,this._currentView.activateInput())}}static getInstance(){return this._instance||(this._instance=new d,this._instance._init()),this._instance}start(){return r(this,void 0,void 0,(function*(){s.DocumentManager.getInstance().createMainDocument("new-doc");const e=this.getMainDoc();s.UniqueElementUtil.getOrCreateUniqueElement(e,s.WorkPlaneUE),this.actionMgr=i.ActionManager.getInstance(),this.logRecorder.clear()}))}stop(){this.logRecorder.clear(),this._viewMap.forEach(((e,t)=>this.destroyView(t))),i.ActionManager.getInstance().resetAllActions(!0),delete this._currentView,delete this._doc}setCurrentView(e=""){const t=this._viewMap.get(e);t?this._setCurView(t):s.DebugWarn.assert(!1,`can not find view with id: ${e}`," ","2020-04-13")}getMainDoc(){return this._doc}getCurrentView(){return this._currentView}getAllViews(){return[...this._viewMap.values()]}createView(e="",t,n,r){const i=this._viewMap.get(e);if(i)return s.DebugWarn.assert(!1,`view id already created: ${e}`," ","2020-04-13"),i;const a=new o.UIView(n,t,r,this._setCurView);return a.start(),this._viewMap.set(e,a),a.setCurrentCamera(new c.ApiCamera(a.getControllerSwitcher())),a}getViewById(e=""){return this._viewMap.get(e)}destroyView(e=""){const t=this._viewMap.get(e);t&&(t.destroy(),this._viewMap.delete(e))}config(e,t){l.config(e,t)}sendCmd(e,t){return r(this,void 0,void 0,(function*(){return s.CmdManager.getInstance().sendCmd(this,e,t)}))}dump(){return new s.DocSaver(this.getMainDoc()).dump()}load(e){return r(this,void 0,void 0,(function*(){return new s.DocSaver(this.getMainDoc()).load(e)}))}_init(){s.eventManager.addEventListener(s.EN_EVENT_TYPE.DOCUMENT_CREATED,d._instance._onDocumentCreatedOrOpened),s.eventManager.addEventListener(s.EN_EVENT_TYPE.DOCUMENT_OPENED,d._instance._onDocumentCreatedOrOpened),s.eventManager.addEventListener(s.EN_EVENT_TYPE.DOCUMENT_CLOSED,d._instance._onDocumentClosed),this.logRecorder.init(),s.HighLight.getInstance(),s.Selection.getInstance()}_onDocumentCreatedOrOpened(e){d.getInstance()._doc=e}_onDocumentClosed(){delete d.getInstance()._doc}}t.App=d},82658:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appConfig=void 0,t.appConfig={common:{click_tolerance:4,dbl_click_interval:300,color_capture:13981141,color_selection:33023,color_active:16771071,active_group_is_overlay:!1,selection_group_is_overlay:!0,opacity_selection:.4,opacity_active:.5,color_frozen:11184810,color_edge_frozen:13421772,color_background:15724527,color_grid:11184810,pick_length:15,default_render_zoom_ratio:.1,default_style_opacity:1,default_style_text_size:.32,default_style_text_color:0,default_style_point_size:8,point_size_gpu_pick_context:2,default_selected_point_size:10,default_style_point_color:0,default_style_line_width:1,default_style_line_color:0,default_style_face_color:8421504,default_finish_surface_offset:.002,default_style_ctrlpoint_size:18,default_style_ctrlpoint_color:17596,default_style_ctrlpoint_hover:59391,default_style_snappoint_color:34559,default_style_snappoint_hover:34559,default_style_measure_line:3355443,default_style_rect_model_line:34559,default_style_snap_line_style:{lineColor:43775,lineDotted:!0},isGlobal:!1},PerspectiveCamera:{fov:45},OrthogonalCamera:{near:-1e6,far:1e6,orbitRadius:1e6}}},66750:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.matrixT2X=t.matrixX2T=t.vecT2X=t.vecX2T=t.Camera=void 0;const o=n(31667),a=i(n(78406));function c(e){return new o.math.Vector3(e.x,e.y,e.z)}function l(e){const t=new o.math.Matrix4,n=e.elements;return t.copy([[n[0],n[1],n[2],n[3]],[n[4],n[5],n[6],n[7]],[n[8],n[9],n[10],n[11]],[n[12],n[13],n[14],n[15]]]),t}t.Camera=class{constructor(){this._screen={width:1,height:1},this._impl=new a.Camera}get screen(){return this._screen}setScreen(e,t){this._screen.width=e,this._screen.height=t}get up(){return c(this._impl.up)}set up(e){this._impl.up.set(e.x,e.y,e.z)}get position(){return c(this._impl.position)}set position(e){this._impl.position.set(e.x,e.y,e.z)}get forward(){const e=new a.Vector3;return c(this._impl.getWorldDirection(e))}updateMatrix(){this._impl.updateMatrix(),this._impl.updateMatrixWorld(!0)}getWorldDirection(){const e=new a.Vector3;return this._impl.getWorldDirection(e),c(e)}getTransfrom(){return l(this._impl.matrixWorld)}lookAt(e,t=o.math.Vector3.Z()){this._impl.up.set(t.x,t.y,t.z),this._impl.lookAt(e.x,e.y,e.z)}generateCameraRay(e,t){const n=new a.Raycaster,r=new a.Vector2;r.x=e/this._screen.width*2-1,r.y=-t/this._screen.height*2+1,n.setFromCamera(r,this._impl);const{ray:s}=n,i=new o.math.Line3d(s.origin,s.direction,[0,1]);return i.extend(100*o.math.CONST.MODEL_MAX_LENGTH,!0),i}getTHREECamera(){return this._impl}},t.vecX2T=function(e){return new a.Vector3(e.x,e.y,e.z)},t.vecT2X=c,t.matrixX2T=function(e){const t=new a.Matrix4,n=e.data;return t.set(n[0][0],n[1][0],n[2][0],n[3][0],n[0][1],n[1][1],n[2][1],n[3][1],n[0][2],n[1][2],n[2][2],n[3][2],n[0][3],n[1][3],n[2][3],n[3][3]),t},t.matrixT2X=l},37419:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.OrthogonalCamera=void 0;const o=i(n(78406)),a=n(66750);class c extends a.Camera{constructor(e,t,n,r,s,i){super(),this._impl=new o.OrthographicCamera(e,t,n,r,s,i)}get left(){return this._impl.left}get right(){return this._impl.right}get top(){return this._impl.top}get bottom(){return this._impl.bottom}get near(){return this._impl.near}get far(){return this._impl.far}get zoom(){return this._impl.zoom}set zoom(e){this._impl.zoom=e}setScreen(e,t){super.setScreen(e,t),this._impl.left=-e/2,this._impl.right=e/2,this._impl.top=t/2,this._impl.bottom=-t/2,this._impl.setViewOffset(e,t,0,0,e,t)}updateProjectionMatrix(){this._impl.updateProjectionMatrix()}getProjectionMatrix(){return a.matrixT2X(this._impl.projectionMatrix)}getQuaternion(){return this._impl.quaternion}}t.OrthogonalCamera=c},85029:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.PerspectiveCamera=void 0;const o=i(n(78406)),a=n(66750);class c extends a.Camera{constructor(e,t,n,r){super(),this._impl=new o.PerspectiveCamera(e,t,n,r)}setScreen(e,t){super.setScreen(e,t),this._impl.aspect=e/t}get fov(){return this._impl.fov}set fov(e){this._impl.fov=e}get aspect(){return this._impl.aspect}set aspect(e){this._impl.aspect=e}get near(){return this._impl.near}set near(e){this._impl.near=e}get far(){return this._impl.far}set far(e){this._impl.far=e}getQuaternion(){return this._impl.quaternion}}t.PerspectiveCamera=c},30054:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Cmd=void 0;const s=n(31667),i=n(98295);class o extends s.Cmd{toast(e,t=!1){const n=t?s.EN_EVENT_TYPE.MESSAGE_NOTICE:s.EN_EVENT_TYPE.MESSAGE_TOAST,r=new s.MessageEvent(n,e);s.eventManager.dispatchEvent(r)}showMouseTip({tip:e,pos:t,image:n}){s.eventManager.dispatchEvent(new s.Event(s.EN_EVENT_TYPE.MESSAGE_MOUSE_TEXT1,{x:t.x+20,y:t.y-35,text:e,image:n}))}hideMouseTip(){this.showMouseTip({pos:{x:0,y:0},tip:""})}setStatusBarInfo(e){const t=new s.MessageEvent(s.EN_EVENT_TYPE.MESSAGE_STAUS_BAR_INFO,e);s.eventManager.dispatchEventDelay(t,50)}getIApp(){return super.getIApp()}runAction(e){return r(this,void 0,void 0,(function*(){return this._runAction(e)}))}_runAction(e){return r(this,void 0,void 0,(function*(){return i.ActionManager.getInstance().runAction(e)}))}}t.Cmd=o},46718:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ControllerSwitcher=void 0;const r=n(31667),s=n(82658),i=n(37419),o=n(85029),a=n(85749),c=n(96191);t.ControllerSwitcher=class{constructor(e,t){this._orthographicCamera=new i.OrthogonalCamera(-1e3,1e3,1e3,-1e3,s.appConfig.OrthogonalCamera.near,s.appConfig.OrthogonalCamera.far),this._orthographicCamera.zoom=s.appConfig.common.default_render_zoom_ratio,this._perspectiveCamera=new o.PerspectiveCamera(s.appConfig.PerspectiveCamera.fov,1,10,1e6),this._orbitController=new c.OrbitController(this._orthographicCamera,t),this._firstPersonController=new a.FirstPersonController(this._perspectiveCamera),this._irender=e,this.useMode("orbitControl");const n=this.throttle(100,!0,(e=>{}),!1);r.eventManager.addEventListener("position",n),r.eventManager.addEventListener("rotation",n),r.eventManager.addEventListener("fov",n),r.eventManager.addEventListener("aspect",n)}setRenderer(e){this._irender=e,this._irender.camera=this._camera}useMode(e){if(this._mode!==e)if(this._mode=e,"firstPerson"===e)this._camera=this._perspectiveCamera,this._irender&&(this._irender.camera=this._camera),this.resetViewDirection(new r.math.Vector3(0,0,1500),new r.math.Vector3(1,1,1500),r.math.Vector3.Z());else{this._camera=this._orthographicCamera,this._irender&&(this._irender.camera=this._camera);const e=r.math.Vector3.O(),t=s.appConfig.OrthogonalCamera.orbitRadius;this.resetViewDirection(e.clone().add({x:t,y:t,z:t}),e,r.math.Vector3.Z())}}getCurrentCamera(){return this._camera}updateCurrentCameraPosition(e){const t=this.getCurrentController();t instanceof a.FirstPersonController&&(t.position=e)}onResize(e,t){this._orthographicCamera.setScreen(e,t),this._perspectiveCamera.setScreen(e,t),this._onUpdate(),this.updateIRender()}getCurrentController(){return"firstPerson"===this._mode?this._firstPersonController:this._orbitController}tick(e){"firstPerson"===this._mode?(this._firstPersonController.tick(e),this._firstPersonController.update()):"orbitControl"===this._mode&&(this._orbitController.tick(e),this._orbitController.update()),this._onUpdate(),this.updateIRender()}processKeyboardEvent(e){return"firstPerson"===this._mode?(this._firstPersonController.processKeyboardEvent(e),!0):!!this._orbitController.processKeyboardEvent(e)&&(this._orbitController.update(),this._onUpdate(),this.updateIRender(),!0)}processMouseEvent(e,t,n,r){if("firstPerson"===this._mode){if(this._firstPersonController.processMouseEvent(e,t,n))return this._firstPersonController.update(),this._onUpdate(),this.updateIRender(),!0}else if(this._orbitController.processMouseEvent(e,t,n,r))return this._orbitController.update(),this._onUpdate(),this.updateIRender(),!0;return!1}setOrbitControlCamera(e){return"firstPerson"!==this._mode&&(this._camera="orthographic"===e?this._orthographicCamera:this._perspectiveCamera,this._orbitController.switchCamera(this._camera),this._irender&&(this._irender.camera=this._camera),this._onUpdate(),this.updateIRender(),!0)}resetViewDirection(e,t,n,r){this._camera.position=e,this._camera.lookAt(t,n),"firstPerson"===this._mode?this._firstPersonController.reset(this._perspectiveCamera):(this._orbitController.reset(this.getCurrentCamera(),t),r&&(this._orthographicCamera.zoom=r)),this._onUpdate(),this.updateIRender()}updateIRender(){this._irender?this._irender.updateView():r.DebugWarn.warn(!1,"no irender bound to controller switcher","","")}getTarget(){const e=this.getCurrentController();return e instanceof c.OrbitController?e.getTarget():r.math.Vector3.O()}resetNamedViewDirection(e,t,n){const s=this.getCurrentCamera(),i=(null==n?void 0:n.clone())||this.getTarget(),o=new r.math.Vector3;e.includes("top")?o.add({x:0,y:0,z:1}):e.includes("bottom")&&o.add({x:0,y:0,z:-1}),e.includes("right")?o.add({x:1,y:0,z:0}):e.includes("left")&&o.add({x:-1,y:0,z:0}),e.includes("front")?o.add({x:0,y:-1,z:0}):e.includes("back")&&o.add({x:0,y:1,z:0}),o.normalize();let a=r.math.Vector3.Z();if("top"===e||"bottom"===e){const e=this._camera.up;Math.abs(e.x)>Math.abs(e.y)?(a=r.math.Vector3.X(),e.x<0&&(a=a.multiply(-1))):(a=r.math.Vector3.Y(),e.y<0&&(a=a.multiply(-1)))}else a=e.includes("top")||e.includes("bottom")?o.cross(r.math.Vector3.Z()).normalize().cross(o):r.math.Vector3.Z();const c=null!=t?t:i.distanceTo(s.position),l=i.added(o.multiplied(c));this.resetViewDirection(l,i,a)}setOrbitControllerLockRotation(e){this._orbitController.lockRotation=e}getOrbitControllerLockRotation(){return this._orbitController.lockRotation}throttle(e,t,n,r){let s,i=!1,o=0;function a(){s&&clearTimeout(s)}function c(){const c=Date.now()-o;if(i)return;const l=()=>{o=Date.now(),n.apply(void 0,arguments)};r&&!s&&l(),a(),!r&&c>e?l():t||(s=setTimeout(r?function(){s=void 0}:l,void 0===r?e-c:e))}return c.cancel=function(){a(),i=!0},c}_onUpdate(){this.onUpdate&&this.onUpdate()}}},85749:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.FirstPersonController=void 0;const o=n(31667),a=i(n(78406)),c=n(16724);t.FirstPersonController=class{constructor(e){this._lookSpeed=3.6,this._moveSpeed=1.8,this._mouseWheelDelta=40,this._localCamera=new a.PerspectiveCamera,this._position=new a.Vector3,this._rotating=!1,this._screenX=0,this._screenY=0,this._forwardPressed=!1,this._backPressed=!1,this._leftPressed=!1,this._rightPressed=!1,this._upPressed=!1,this._downPressed=!1,this.reset(e)}get forwardPressed(){return this._forwardPressed}set forwardPressed(e){this._forwardPressed=e}get backPressed(){return this._backPressed}set backPressed(e){this._backPressed=e}get leftPressed(){return this._leftPressed}set leftPressed(e){this._leftPressed=e}get rightPressed(){return this._rightPressed}set rightPressed(e){this._rightPressed=e}get upPressed(){return this._upPressed}set upPressed(e){this._upPressed=e}get downPressed(){return this._downPressed}set downPressed(e){this._downPressed=e}get position(){return new o.math.Vector3(this._position.x,this._position.y,this._position.z)}set position(e){this._position=new a.Vector3(e.x,e.y,e.z),this._camera.position=new o.math.Vector3(e.x,e.y,e.z)}reset(e){e&&(this._camera=e),this._storeLastState();const t=this._camera.getTHREECamera();this._localCamera.copy(t),this._localCamera.quaternion.copy(t.quaternion),this._localCamera.up.copy(t.up),this._localCamera.position.set(0,0,0),this._position.copy(t.position),this.update()}update(){this._updateWorldCamera(),this._checkEmitEvent()}processKeyboardEvent(e){return!0}processMouseEvent(e,t,n){switch(this._storeLastState(),e){case c.EN_MOUSE_EVENT_TYPE.DRAG_START:this._rotating=!0,this._screenX=t.x,this._screenY=t.y;break;case c.EN_MOUSE_EVENT_TYPE.DRAG_END:this._rotating=!1;break;case c.EN_MOUSE_EVENT_TYPE.DRAG_MOVE:if(this._rotating)return this._handleMouseMoveRotate(t.x,t.y),!0;break;case c.EN_MOUSE_EVENT_TYPE.WHEEL_FORWARD:return this._moveForward(this._mouseWheelDelta),!0;case c.EN_MOUSE_EVENT_TYPE.WHEEL_BACKWARD:return this._moveForward(-this._mouseWheelDelta),!0;case c.EN_MOUSE_EVENT_TYPE.MOUSE_LEAVE:return this._cancelPressing(),!0}return!1}tick(e){this._smoothMoving(e)}_updateWorldCamera(){const e=this._camera.getTHREECamera();e.up.copy(this._localCamera.up),e.position.copy(this._position),e.quaternion.copy(this._localCamera.quaternion),e.updateMatrixWorld(!0),e.updateProjectionMatrix()}_yaw(e){const t=new a.Quaternion;t.setFromAxisAngle(new a.Vector3(0,0,1),e),this._localCamera.applyQuaternion(t),this._localCamera.up.applyQuaternion(t)}_pitch(e){const t=new a.Quaternion,n=this._getRightDir();t.setFromAxisAngle(n,e),this._localCamera.applyQuaternion(t),this._localCamera.up.applyQuaternion(t)}_handleMouseMoveRotate(e,t){const n=(e-this._screenX)/this._camera.screen.width,r=(t-this._screenY)/this._camera.screen.height;this._screenX=e,this._screenY=t,0!==n&&this._yaw(n*this._lookSpeed),0!==r&&this._pitch(r*this._lookSpeed)}_moveForward(e){const t=new a.Vector3;this._localCamera.getWorldDirection(t),t.z=0,t.normalize(),t.multiplyScalar(e*this._moveSpeed),this._position.add(t)}_moveRight(e){const t=this._getRightDir();t.multiplyScalar(e*this._moveSpeed),this._position.add(t)}_moveUp(e){const t=new a.Vector3(0,0,1);t.multiplyScalar(e*this._moveSpeed),this._position.add(t)}_getRightDir(){const e=new a.Vector3;this._localCamera.getWorldDirection(e);const{up:t}=this._localCamera;return e.cross(t).normalize()}_storeLastState(){}_checkEmitEvent(){}_smoothMoving(e){const t=e*this._moveSpeed;this._forwardPressed?this._moveForward(t):this._backPressed&&this._moveForward(-t),this._leftPressed?this._moveRight(-t):this._rightPressed&&this._moveRight(t),this._upPressed?this._moveUp(t):this._downPressed&&this._moveUp(-t)}_cancelPressing(){this._forwardPressed=!1,this._backPressed=!1,this._leftPressed=!1,this._rightPressed=!1,this._upPressed=!1,this._downPressed=!1,this._rotating=!1}}},96191:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.OrbitController=void 0;const o=n(31667),a=i(n(78406)),c=n(37419),l=n(66750),d=n(16724),u=n(85029),h=n(82658);t.OrbitController=class{constructor(e,t,n=new o.math.Vector3){this.rotateSpeed=.5,this.zoomSpeed=1,this.lockRotation=!1,this._target=new a.Vector3,this._dirty=!1,this._localCamera=new a.Camera,this._rotateThetaDelta=0,this._rotatePhiDelta=0,this._offset=new a.Vector3,this._rotateEnd=new a.Vector2,this._rotateStart=new a.Vector2,this._panStart=new a.Vector2,this._panEnd=new a.Vector2,this._lastPosition=new a.Vector3,this._lastTarget=new a.Vector3,this._forwardPressed=!1,this._backPressed=!1,this._leftPressed=!1,this._rightPressed=!1,this._upPressed=!1,this._downPressed=!1,this._camera=e,this._logRecorder=t,this._target.set(n.x,n.y,n.z),this.reset(e,n)}get forwardPressed(){return this._forwardPressed}set forwardPressed(e){this._forwardPressed=e}get backPressed(){return this._backPressed}set backPressed(e){this._backPressed=e}get leftPressed(){return this._leftPressed}set leftPressed(e){this._leftPressed=e}get rightPressed(){return this._rightPressed}set rightPressed(e){this._rightPressed=e}get upPressed(){return this._upPressed}set upPressed(e){this._upPressed=e}get downPressed(){return this._downPressed}set downPressed(e){this._downPressed=e}reset(e,t=o.math.Vector3.O()){e&&(this._camera=e),this.setTarget(t),this._storeLastState();const n=this._camera.getTHREECamera();this._localCamera.position.copy(n.position.clone().sub(l.vecX2T(t))),this._localCamera.up.copy(n.up),this.update()}switchCamera(e){const t=(e,t,n)=>{const r=this._localCamera.position.clone().negate(),s=a.Math.degToRad(t),i=a.Math.degToRad(e),o=r.length()*Math.tan(.5*s)/Math.tan(.5*i);return r.normalize().multiplyScalar(-o*n)};if(e===this._camera)return;const n=a.Math.radToDeg(2*Math.atan(.45));e instanceof u.PerspectiveCamera&&this._localCamera.position.copy(t(h.appConfig.PerspectiveCamera.fov,n,h.appConfig.common.default_render_zoom_ratio/this._camera.zoom)),e instanceof c.OrthogonalCamera&&this._localCamera.position.copy(t(n,h.appConfig.PerspectiveCamera.fov,e.zoom/h.appConfig.common.default_render_zoom_ratio)),this._camera=e,this.update()}update(){this._updateByPhi(),this._updateByTheta(),this._target.add(this._offset),this._updateWorldCamera(),this._offset.set(0,0,0),this._rotateThetaDelta=0,this._rotatePhiDelta=0,this._checkEmitEvent()}getTarget(){return l.vecT2X(this._target)}setTarget(e){this._target.set(e.x,e.y,e.z)}processMouseEvent(e,t,n,r){this._storeLastState();const s=r?Math.min(r.delta,8):8;switch(e){case d.EN_MOUSE_EVENT_TYPE.DRAG_START:this._handlMouseDownRotate(t.x,t.y);break;case d.EN_MOUSE_EVENT_TYPE.WHEEL_BACKWARD:this._handleMouseWheel(-s,t.x,t.y),this._dirty=!0;break;case d.EN_MOUSE_EVENT_TYPE.WHEEL_FORWARD:this._handleMouseWheel(s,t.x,t.y),this._dirty=!0;break;case d.EN_MOUSE_EVENT_TYPE.L_BUTTON_UP:case d.EN_MOUSE_EVENT_TYPE.M_BUTTON_UP:case d.EN_MOUSE_EVENT_TYPE.R_BUTTON_UP:this._state="none";break;case d.EN_MOUSE_EVENT_TYPE.M_BUTTON_DOWN:case d.EN_MOUSE_EVENT_TYPE.R_BUTTON_DOWN:this._handleMouseDownPan(t.x,t.y);break;case d.EN_MOUSE_EVENT_TYPE.MOUSE_MOVE:"pan"===this._state&&(this._handleMousePanMove(t.x,t.y),this._dirty=!0);break;case d.EN_MOUSE_EVENT_TYPE.DRAG_MOVE:"rotate"===this._state&&(this._handleMouseMoveRotate(t.x,t.y),this._dirty=!0);break;case d.EN_MOUSE_EVENT_TYPE.MOUSE_LEAVE:this._cancelPressing()}let i=!1;return this._dirty&&(i=!0,this._dirty=!1),i}tick(e){this._smoothMoving(e)}processKeyboardEvent(e){return!1}_handlMouseDownRotate(e,t){this._state="rotate",this._rotateStart.set(e,t)}_handleMouseMoveRotate(e,t){if(this.lockRotation)return;this._rotateEnd.set(e,t);const n=new a.Vector2;n.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed),this._rotateLeft(-2*Math.PI*n.x/this._camera.screen.width),this._rotateUp(-2*Math.PI*n.y/this._camera.screen.height),this._rotateStart.copy(this._rotateEnd)}_handleMouseDownPan(e,t){this._state="pan",this._panStart.set(e,t)}_rotateUp(e){this._rotateThetaDelta=e}_rotateLeft(e){this._rotatePhiDelta=e}_updateWorldCamera(){const e=this._target.clone().add(this._localCamera.position),t=this._camera.getTHREECamera();t.up.copy(this._localCamera.up),t.position.copy(e),t.lookAt(this._target);let n=1;this._camera instanceof c.OrthogonalCamera&&(n=this._camera.zoom),this._logRecorder.recordCamera(e,this._target,this._localCamera.up,n),t.updateMatrixWorld(!0),t.updateProjectionMatrix()}_updateByPhi(){if(0!==this._rotatePhiDelta){const e=new a.Quaternion;e.setFromAxisAngle(new a.Vector3(0,0,1),this._rotatePhiDelta),this._localCamera.applyQuaternion(e),this._localCamera.up.applyQuaternion(e),this._localCamera.position.applyQuaternion(e),this._localCamera.updateMatrixWorld(!0)}}_updateByTheta(){if(0!==this._rotateThetaDelta){const e=this._localCamera.position.clone().negate(),{up:t}=this._localCamera,n=e.clone().cross(t).normalize(),r=new a.Quaternion;r.setFromAxisAngle(n,this._rotateThetaDelta),this._localCamera.up.applyQuaternion(r),this._localCamera.position.applyQuaternion(r),this._localCamera.updateMatrixWorld(!0)}}_handleMouseWheel(e,t,n){const r=this._localCamera.position.clone(),s=r.length(),i=3*e*Math.min(.01*s,22);if(i>0&&i<1e-6)return;const o=s/(s+i);if(this._camera instanceof c.OrthogonalCamera){const e=1-o,r=(t-this._camera.screen.width/2)/this._camera.zoom*e,s=(-n+this._camera.screen.height/2)/this._camera.zoom*e,i=new a.Vector3(r,s,0);i.applyQuaternion(this._camera.getQuaternion()),this._target.copy(this._target.add(i)),this._dollyIn(o)}else if(this._camera instanceof u.PerspectiveCamera){const i=2*this._localCamera.position.length()*Math.tan(a.Math.degToRad(this._camera.fov/2))/this._camera.screen.height,c=1-o,l=i*(t-this._camera.screen.width/2)*c,d=i*(-n+this._camera.screen.height/2)*c,u=new a.Vector3(l,d,0);u.applyQuaternion(this._camera.getQuaternion()),this._target.copy(this._target.add(u));const h=this._target.clone().add(r.normalize().multiplyScalar(s*o));e>0&&s<100&&this._target.add(r.normalize().negate().multiplyScalar(100)),this._localCamera.position.copy(h.sub(this._target))}}_handleMousePanMove(e,t){this._panEnd.set(e,t);const n=new a.Vector2;n.subVectors(this._panEnd,this._panStart),this._pan(n.x,n.y),this._panStart.copy(this._panEnd)}_dollyIn(e){this._camera instanceof c.OrthogonalCamera&&(this._camera.zoom/=e)}_panLeft(e){const t=new a.Vector3;t.setFromMatrixColumn(this._camera.getTHREECamera().matrix,0),t.multiplyScalar(-e),this._offset.add(t)}_panUp(e){const t=this._localCamera.up.clone().normalize();t.multiplyScalar(e),this._offset.add(t)}_pan(e,t){if(this._camera instanceof c.OrthogonalCamera)this._panLeft(e*(this._camera.right-this._camera.left)/this._camera.zoom/this._camera.screen.width),this._panUp(t*(this._camera.top-this._camera.bottom)/this._camera.zoom/this._camera.screen.height);else if(this._camera instanceof u.PerspectiveCamera){const n=2*this._localCamera.position.length()*Math.tan(a.Math.degToRad(this._camera.fov/2)),r=n*this._camera.aspect,s=this._localCamera.position.clone().negate().normalize(),i=this._localCamera.up.clone().cross(s).normalize(),o=s.clone().cross(i).normalize(),c=e*r/this._camera.screen.width,l=t*n/this._camera.screen.height,d=i.clone().multiplyScalar(c),u=o.clone().multiplyScalar(l),h=d.clone().add(u);this._offset.add(h)}}_storeLastState(){this._lastPosition.copy(this._localCamera.position),this._lastTarget.copy(this._target)}_checkEmitEvent(){const e=new o.Event(o.EN_EVENT_TYPE.CAMERA_CHANGE,this._camera);o.eventManager.dispatchEvent(e)}_moveForward(e){const t=this._localCamera.position.clone().negate().normalize();t.z=0,t.normalize(),t.multiplyScalar(e),this._offset.add(t)}_moveRight(e){const t=this._localCamera.position.clone().negate().normalize(),n=this._localCamera.up.clone().cross(t).negate().normalize();n.multiplyScalar(e),this._offset.add(n)}_moveUp(e){const t=this._localCamera.up.clone();t.multiplyScalar(e),this._offset.add(t)}_smoothMoving(e){const t=1.8*e;this._forwardPressed?this._moveForward(t):this._backPressed&&this._moveForward(-t),this._leftPressed?this._moveRight(-t):this._rightPressed&&this._moveRight(t),this._upPressed?this._moveUp(t):this._downPressed&&this._moveUp(-t)}_cancelPressing(){this._state="none",this._forwardPressed=!1,this._backPressed=!1,this._leftPressed=!1,this._rightPressed=!1,this._upPressed=!1,this._downPressed=!1}}},9771:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createIRender=void 0;const r=n(27261),s=n(68655);t.createIRender=function(e){let t=!1;try{const e=document.createElement("canvas");t=!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){t=!1}return t?new s.ThreeJsRender(e):new r.NullRender}},16724:function(e,t){"use strict";var n,r,s;Object.defineProperty(t,"__esModule",{value:!0}),t.EN_KEY_CODE=t.EN_KEYBOARD_EVENT_TYPE=t.EN_MOUSE_EVENT_TYPE=void 0,function(e){e.MOUSE_MOVE="move",e.L_BUTTON_DOWN="l_down",e.L_BUTTON_UP="l_up",e.R_BUTTON_DOWN="r_down",e.R_BUTTON_UP="r_up",e.M_BUTTON_DOWN="m_down",e.M_BUTTON_UP="m_up",e.WHEEL_FORWARD="wheel+",e.WHEEL_BACKWARD="wheel-",e.R_CLICK="r_clk",e.CLICK="clk",e.SGL_CLICK="sgl_clk",e.DBL_CLICK="db_clk",e.DRAG_START="drag_start",e.DRAG_MOVE="drag_move",e.DRAG_END="drag_end",e.MOUSE_LEAVE="mouse_leave",e.MOUSE_ENTER="mouse_enter"}(n||(n={})),t.EN_MOUSE_EVENT_TYPE=n,function(e){e.KEY_DOWN="keydown",e.KEY_UP="keyup"}(r||(r={})),t.EN_KEYBOARD_EVENT_TYPE=r,function(e){e[e.ESC=27]="ESC",e[e.DEL=46]="DEL",e[e.TAB=9]="TAB",e[e.ENT=13]="ENT",e[e.SHIFT=16]="SHIFT",e[e.A=65]="A",e[e.B=66]="B",e[e.C=67]="C",e[e.D=68]="D",e[e.E=69]="E",e[e.F=70]="F",e[e.G=71]="G",e[e.H=72]="H",e[e.I=73]="I",e[e.J=74]="J",e[e.K=75]="K",e[e.L=76]="L",e[e.M=77]="M",e[e.N=78]="N",e[e.O=79]="O",e[e.P=80]="P",e[e.Q=81]="Q",e[e.R=82]="R",e[e.S=83]="S",e[e.T=84]="T",e[e.U=85]="U",e[e.V=86]="V",e[e.W=87]="W",e[e.X=88]="X",e[e.Y=89]="Y",e[e.Z=90]="Z",e[e.NUM_0=48]="NUM_0",e[e.NUM_1=49]="NUM_1",e[e.NUM_2=50]="NUM_2",e[e.NUM_3=51]="NUM_3",e[e.NUM_4=52]="NUM_4",e[e.NUM_5=53]="NUM_5",e[e.NUM_6=54]="NUM_6",e[e.NUM_7=55]="NUM_7",e[e.NUM_8=56]="NUM_8",e[e.NUM_9=57]="NUM_9"}(s||(s={})),t.EN_KEY_CODE=s},24878:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FnKey=void 0;t.FnKey=class{constructor(e){this._ctrlKey=!!(null==e?void 0:e.ctrlKey),this._altKey=!!(null==e?void 0:e.altKey),this._shiftKey=!!(null==e?void 0:e.shiftKey),this._metaKey=!!(null==e?void 0:e.metaKey)}dump(){const e={ctrlKey:this._ctrlKey,altKey:this._altKey,shiftKey:this._shiftKey,metaKe:this._metaKey};let t=!0;for(const n of Object.keys(e))e[n]?t=!1:delete e[n];if(!t)return e}get ctrlKey(){return this._ctrlKey}get altKey(){return this._altKey}get shiftKey(){return this._shiftKey}get metaKey(){return this._metaKey}}},47290:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.HotkeyManager=void 0;const o=i(n(89149)),a=n(98295),c=n(11644);function l(e){e.preventDefault?e.preventDefault():e.returnValue=!1}t.HotkeyManager=class{static setStopCallback(e){const t=o.prototype.stopCallback;o.prototype.stopCallback=function(n,r,s){if(this.paused)return!0;const i=t.call(this,n,r,s);return i||e(n,r,s)}}static register(e){e.forEach((({key:e,func:t,cmdParam:n,type:r})=>{"action"===t?(o.bind(e,(t=>{l(t),a.ActionManager.getInstance().processKeyboardEvent({key:e,type:"keydown"})}),"keydown"),o.bind(e,(t=>{l(t),a.ActionManager.getInstance().processKeyboardEvent({key:e,type:"keyup"})}),"keyup")):"string"==typeof t?o.bind(e,(e=>{l(e),c.App.getInstance().sendCmd(t,n)}),r):o.bind(e,(n=>{l(n),t(),c.App.getInstance().getCurrentView().getLoops().processKeyboardEvent({key:e,type:r})}),r)}))}}},57214:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InputStack=void 0;const r=n(31667);t.InputStack=class{constructor(){this._observerStack=[]}addObserver(e){this._observerStack.push(e)}removeObserver(e){const t=this._observerStack.indexOf(e);t>=0&&this._observerStack.splice(t,1)}tick(e){for(const t of this._observerStack)t.tick(e)}processKeyboardEvent(e){let t=!1;for(const n of this._observerStack)if(t=n.processKeyboardEvent(e)||t,t)break;return t}processMouseEvent(e,t,n,s){let i=!1;const o=Array.isArray(t)?new r.math.Vector2(t):t;for(const t of this._observerStack)if(i=t.processMouseEvent(e,o,n,s)||i,i)break;return i}}},46377:function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Loops=void 0;const s=n(31667),i=r(n(96362)),o=n(82658),a=n(16724),c=n(24878);t.Loops=class{constructor(e,t){this._renderFrameIndex=0,this._logicFrameIndex=0,this._running=!1,this._isDragging=!1,this._logicLooping=!1,this._downKeys=new Set,this._lastUpdate=Date.now(),this._conditionalRendering=new l,this._onTouchStart=e=>{this._logicFrameIndex++,this._conditionalRendering.touch();const t=this._getScreenPos(e);let n=!1;this._mouseDownPos=t.clone(),n=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.L_BUTTON_DOWN,t,new c.FnKey(e)),this._isDragging=!1,n&&e.stopPropagation()},this._onTouchMove=e=>{this._onMouseMoveThrottle(e)},this._onTouchEnd=e=>{var t;this._logicFrameIndex++;const n=this._getScreenPos(e);let r=!1;{const s=new c.FnKey(e);this._mouseDownPos&&n.sqDistanceTo(this._mouseDownPos)<=o.appConfig.common.click_tolerance&&this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.CLICK,n,s),this._dblClickTimeout?(window.clearTimeout(this._dblClickTimeout),(null===(t=this._lastMouseUp)||void 0===t?void 0:t.equals(n,2))?(delete this._dblClickTimeout,this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.DBL_CLICK,n,s)):this._dblClickTimeout=window.setTimeout((()=>{delete this._dblClickTimeout,this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.SGL_CLICK,n,s)}),o.appConfig.common.dbl_click_interval)):this._dblClickTimeout=window.setTimeout((()=>{delete this._dblClickTimeout,this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.SGL_CLICK,n,s)}),o.appConfig.common.dbl_click_interval),this._lastMouseUp=n.clone(),r=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.L_BUTTON_UP,n,s),delete this._mouseDownPos,this._isDragging&&this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.DRAG_END,n,s),this._isDragging=!1}r&&e.stopPropagation()},this._onMouseDown=e=>{this._logicFrameIndex++,this._conditionalRendering.touch();const t=this._getScreenPos(e);let n=!1;2===e.button?(this._rMouseDownPos=t.clone(),n=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.R_BUTTON_DOWN,t,new c.FnKey(e))):0===e.button?(this._mouseDownPos=t.clone(),n=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.L_BUTTON_DOWN,t,new c.FnKey(e))):1===e.button&&(n=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.M_BUTTON_DOWN,t,new c.FnKey(e)),e.preventDefault()),this._isDragging=!1,n&&e.stopPropagation()},this._onMouseMove=e=>{this._onMouseMoveThrottle(e)},this._onMouseMoveThrottle=i.default((e=>{const t=e;this._logicFrameIndex++,this._conditionalRendering.touch();const n=new c.FnKey(t),r=this._getScreenPos(t),s=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.MOUSE_MOVE,r,n);!this._isDragging&&this._mouseDownPos&&r.sqDistanceTo(this._mouseDownPos)>o.appConfig.common.click_tolerance?(this._isDragging=!0,this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.DRAG_START,r,n)):this._isDragging&&this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.DRAG_MOVE,r,n),s&&t.stopPropagation()}),16,{leading:!0,trailing:!1}),this._onMouseUp=e=>{var t;this._logicFrameIndex++;const n=this._getScreenPos(e);let r=!1;if(2===e.button)r=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.R_BUTTON_UP,n,new c.FnKey(e)),!r&&this._rMouseDownPos&&this._rMouseDownPos.distanceTo(n)<=o.appConfig.common.click_tolerance&&(r=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.R_CLICK,n,new c.FnKey(e)),delete this._rMouseDownPos);else if(0===e.button){const s=new c.FnKey(e);this._mouseDownPos&&n.sqDistanceTo(this._mouseDownPos)<=o.appConfig.common.click_tolerance&&this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.CLICK,n,s),this._dblClickTimeout?(window.clearTimeout(this._dblClickTimeout),(null===(t=this._lastMouseUp)||void 0===t?void 0:t.equals(n,2))?(delete this._dblClickTimeout,this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.DBL_CLICK,n,s)):this._dblClickTimeout=window.setTimeout((()=>{delete this._dblClickTimeout,this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.SGL_CLICK,n,s)}),o.appConfig.common.dbl_click_interval)):this._dblClickTimeout=window.setTimeout((()=>{delete this._dblClickTimeout,this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.SGL_CLICK,n,s)}),o.appConfig.common.dbl_click_interval),this._lastMouseUp=n.clone(),r=this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.L_BUTTON_UP,n,s),delete this._mouseDownPos,this._isDragging&&this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.DRAG_END,n,s),this._isDragging=!1}else 1===e.button&&(this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.M_BUTTON_UP,n,new c.FnKey(e)),e.preventDefault());r&&e.stopPropagation()},this._onMouseWheel=e=>{this._logicFrameIndex++,this._conditionalRendering.touch();const t=this._getScreenPos(e),n=new c.FnKey(e),r={delta:Math.abs(e.deltaY)};this._inputStack.processMouseEvent(e.deltaY<0?a.EN_MOUSE_EVENT_TYPE.WHEEL_FORWARD:a.EN_MOUSE_EVENT_TYPE.WHEEL_BACKWARD,t,n,r)&&e.stopPropagation()},this._onContextMenu=e=>{e.preventDefault()},this._onMouseLeave=e=>{this._isDragging=!1,delete this._mouseDownPos,this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.MOUSE_LEAVE,this._getScreenPos(e),new c.FnKey(e))},this._onMouseEnter=e=>{this._inputStack.processMouseEvent(a.EN_MOUSE_EVENT_TYPE.MOUSE_ENTER,this._getScreenPos(e),new c.FnKey(e))},this._container=e,this._inputStack=t}setRender(e){this._renderer=e,this._conditionalRendering.setRender(e)}start(){this._running=!0,this._startRenderLoop()}stop(){this._running=!1}activateInput(){this._container.addEventListener("mousedown",this._onMouseDown),this._container.addEventListener("mousemove",this._onMouseMove),this._container.addEventListener("mouseup",this._onMouseUp),this._container.addEventListener("wheel",this._onMouseWheel),this._container.addEventListener("contextmenu",this._onContextMenu,!1),this._container.addEventListener("mouseleave",this._onMouseLeave),this._container.addEventListener("mouseenter",this._onMouseEnter),this._container.addEventListener("touchstart",this._onTouchStart,!1),this._container.addEventListener("touchmove",this._onTouchMove,!1),this._container.addEventListener("touchend",this._onTouchEnd,!1)}deactiveInput(){this._container.removeEventListener("mousedown",this._onMouseDown),this._container.removeEventListener("mousemove",this._onMouseMove),this._container.removeEventListener("mouseup",this._onMouseUp),this._container.removeEventListener("wheel",this._onMouseWheel),this._container.removeEventListener("contextmenu",this._onContextMenu,!1),this._container.removeEventListener("mouseleave",this._onMouseLeave),this._container.removeEventListener("mouseenter",this._onMouseEnter),this._container.removeEventListener("touchstart",this._onTouchStart,!1),this._container.removeEventListener("touchmove",this._onTouchMove,!1),this._container.removeEventListener("touchend",this._onTouchEnd,!1)}getCurrentLogicFrame(){return this._logicFrameIndex}getCurrentRenderFrame(){return this._renderFrameIndex}processKeyboardEvent(e){return e.type===a.EN_KEYBOARD_EVENT_TYPE.KEY_DOWN?this._processKeyDown(e):this._processKeyUp(e),this._inputStack.processKeyboardEvent(e)}_getScreenPos(e){const t=this._container.getBoundingClientRect(),n=e instanceof MouseEvent?e.clientX:e.touches[0].clientX,r=e instanceof MouseEvent?e.clientY:e.touches[0].clientY,i=n-t.left,o=r-t.top;return new s.math.Vector2(i,o)}_startRenderLoop(){if(!function(){if(window&&window.requestAnimationFrame)return!0;return!1}())return s.DebugWarn.warn(!1,"no render loop supported","",""),!1;const e=()=>{this._renderer&&!this._renderer.isSync()&&(this._renderFrameIndex++,this._conditionalRendering.render()),this._running&&window.requestAnimationFrame(e)};return window.requestAnimationFrame(e),!0}_processKeyDown(e){if(this._downKeys.has(e.key))return;0===this._downKeys.size&&(this._lastUpdate=Date.now()),this._downKeys.add(e.key);const t=()=>{const e=Date.now(),t=e-this._lastUpdate;this._lastUpdate=e,this._inputStack.tick(t),this._conditionalRendering.touch()};this._logicLooping||(this._intervalID=setInterval(t,30),this._logicLooping=!0)}_processKeyUp(e){this._downKeys.delete(e.key),0===this._downKeys.size&&(clearInterval(this._intervalID),this._logicLooping=!1)}};class l{constructor(){this._renderComplex=!1}setRender(e){this._renderer=e}touch(){clearTimeout(this._timer),this._timer=setTimeout((()=>{this._timeFunction()}),180)}render(){this._renderer&&(this._renderComplex&&this._renderer.updateView(),this._renderer.render())}_timeFunction(){this._renderComplex=!0,this.render(),this._renderComplex=!1}}},87724:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UIView=void 0;const r=n(31667),s=n(46718),i=n(57214),o=n(46377),a=n(98295),c=n(27261),l=n(68655),d=n(82658),u=n(37419),h=n(11644);t.UIView=class{constructor(e,t,n={},l){this._container=e,this._inputStack=new i.InputStack,this._autoResizable=!0,this._doActiveView=e=>{this._activeView&&this._activeView(this)},this._onResize=()=>{if(!this._container)return;const e=this.getSize();h.App.getInstance().logRecorder.recordWindowSize(e.x,e.y),this._modelView&&this._modelView.iRender.onResize(e.x,e.y),this._controllerSwitcher.onResize(e.x,e.y)},r.DebugWarn.assert(e,"创建View的时候必须指定一个div容器"," ","2020-12-23"),this._autoResizable=!1!==n.autoResizable,this._renderer=new c.NullRender,this._autoResizable&&window.addEventListener("resize",this._onResize),this._controllerSwitcher=new s.ControllerSwitcher(this._renderer,h.App.getInstance().logRecorder),this._inputStack.addObserver(a.ActionManager.getInstance()),this._inputStack.addObserver(this._controllerSwitcher),this._loops=new o.Loops(this._container,this._inputStack),this._onResize(),this._activeView=l,this._container.addEventListener("click",this._doActiveView),this._initRender(t)}getContainerDiv(){return this._container}getDocument(){const e=h.App.getInstance().getMainDoc();return r.DebugWarn.assert(e,"doc为空"," ","2020-04-21"),e}getCurrentCamera(){return this._camera}setCurrentCamera(e){this._camera=e}getRenderPicker(){if(this._renderer instanceof l.ThreeJsRender)return this._renderer;throw new Error("cant getRenderPicker")}getRenderFeature(){return this._renderer.renderFeature}onCameraPosUpdate(e){this._controllerSwitcher.onUpdate=e}setRenderFeature(e){this._renderer.renderFeature=e}useController(e){"orbit-control"===e?this._controllerSwitcher.useMode("orbitControl"):this._controllerSwitcher.useMode("firstPerson")}setOrbitControlCamera(e){return h.App.getInstance().logRecorder.recordCameraType("orthographic"===e?0:1),this._controllerSwitcher.setOrbitControlCamera(e)}resetModelView(e){e.iRender=this._renderer,this._modelView=e,a.ActionManager.getInstance().resetAllActions(!0),this._modelView.onUnMount(),this._modelView.onMount()}getSize(){return new r.math.Vector2(this._container.clientWidth,this._container.clientHeight)}getWorkPlane(){return r.UniqueElementUtil.getOrCreateUniqueElement(this.getDocument(),r.WorkPlaneUE).getWorkPlane()}getCameraInfo(){r.DebugWarn.assert(this._modelView,"view not initialized"," ","2020-04-13");return this._modelView.getCameraInfo()}activateInput(){this._loops.activateInput()}deactivateInput(){this._loops.deactiveInput()}start(){this._loops.start()}stop(){this._loops.stop()}destroy(){this.stop(),this.deactivateInput(),this._autoResizable&&window.removeEventListener("resize",this._onResize),this._container&&(this._container.removeEventListener("click",this._doActiveView),delete this._container),this._modelView&&(this._modelView.onUnMount(),this.getDocument().deleteElementsById(this._modelView.id),delete this._modelView),this._renderer&&(this._renderer.destroy(),delete this._renderer)}clear(){this._modelView&&(this._modelView.onUnMount(),this.getDocument().deleteElementsById(this._modelView.id),delete this._modelView),this._renderer&&(this._renderer.destroy(),delete this._renderer)}screenToWorldPlane(e,t){const n=this.generateCameraRay((new r.math.Vector2).copy(e));n.extendDouble(r.math.CONST.MODEL_MAX_LENGTH);const s=r.math.MathAlg.CalculateIntersect.curveSurface(n,t);return 0===s.length?r.math.Vector3.O():s[0]}screenToWorkPlaneUV(e){const t=this.screenToWorkPlane(e);return this.getWorkPlane().plane.getUVAt(t)}screenToNDC(e){const t=new r.math.Vector2;return t.x=e.x/this._container.clientWidth*2-1,t.y=-e.y/this._container.clientHeight*2+1,t}getWorldToScreenMatrix(){const e=this.getCameraInfo(),t=e.matrixProjection,n=e.matrixView,s=t.clone().multiply(n),i=this._container.clientWidth/2,o=this._container.clientHeight/2;return s.applyScale(new r.math.Vector3,{x:i,y:-o,z:0}).preMultiply(r.math.Matrix4.makeTranslate({x:i,y:o,z:0}))}worldToScreen(e){const t=this.getCameraInfo(),n=t.matrixProjection,s=t.matrixView,i=n.clone().multiply(s),o=new r.math.Vector3(e).transform(i);return this.NDCToScreen(new r.math.Vector2(o.x,o.y))}NDCToScreen(e){const t=new r.math.Vector2;return t.x=this._container.clientWidth*(e.x+1)/2,t.y=this._container.clientHeight*(1-e.y)/2,t}generateCameraRay(e){r.DebugWarn.assert(this._modelView,"view not initialized"," ","2020-04-13");const t=this._controllerSwitcher.getCurrentCamera().generateCameraRay(e.x,e.y);if(!this.worldToScreen(t.getOrigin()).equals(e)){const n=this.getCameraInfo(),s=e.x/this._container.clientWidth*2-1,i=-e.y/this._container.clientHeight*2+1,o=new r.math.Vector3(s,i,(n.near+n.far)/(n.near-n.far));o.transform(n.matrixProjection.inversed()),o.transform(n.matrixView.inversed()),t.setOrigin(o),r.DebugWarn.assert(this.worldToScreen(o).equals(e),"generateCameraRay error","","")}return t}screenToWorkPlane(e){const{plane:t}=this.getWorkPlane();return this.screenToWorldPlane(e,t)}setWorkPlane(e){r.UniqueElementUtil.getOrCreateUniqueElement(this.getDocument(),r.WorkPlaneUE).setWorkPlane(new r.WorkPlane(e,this.getDocument()))}getAllVisibleGReps(){return r.DebugWarn.assert(this._modelView,"modelview is not created for this view","",""),this._modelView.getAllVisibleGReps()}getModelView(){return r.DebugWarn.assert(this._modelView,"modelview is not created for this view","",""),this._modelView}get showGrid(){return r.DebugWarn.assert(this._modelView,"modelview is not created for this view","",""),this._modelView.showGrid}set showGrid(e){r.DebugWarn.assert(this._modelView,"modelview is not created for this view","",""),this._modelView.showGrid=e,this._modelView.updateView()}get showAxis(){return r.DebugWarn.assert(this._modelView,"modelview is not created for this view","",""),this._modelView.showAxis}set showAxis(e){r.DebugWarn.assert(this._modelView,"modelview is not created for this view","",""),this._modelView.showAxis=e,this._modelView.updateView()}getControllerSwitcher(){return this._controllerSwitcher}getLoops(){return this._loops}getInputStack(){return this._inputStack}updateElementTransformationDynamic(e,t){this._modelView&&this._modelView.iRender.updateElementTransformationDynamic(e,t)}updateElementVisible(e,t){this._modelView&&this._modelView.iRender.updateElementVisible(e,t)}_initRender(e){this._renderer&&this._renderer.destroy(),this._renderer=e,this._onResize(),this._controllerSwitcher.setRenderer(this._renderer),this._loops.setRender(this._renderer),this._onResize();const t=this._controllerSwitcher.getCurrentCamera();t instanceof u.OrthogonalCamera&&(t.zoom=d.appConfig.common.default_render_zoom_ratio),this._controllerSwitcher.useMode("orbitControl"),this._controllerSwitcher.resetNamedViewDirection("top",1e3,r.math.Vector3.O())}}},51807:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ViewCube=void 0;const o=i(n(78406)),a=n(31667),c=n(82736),l=n(16724),d=60,u=105;t.ViewCube=class{constructor(e){this._mouseMoved=!1,this.onWindowResize=()=>{this._width=this._cubeContainer.offsetWidth,this._height=this._cubeContainer.offsetHeight,this._camera.aspect=this._width/this._height,this._camera.updateProjectionMatrix(),this._renderer.setSize(this._width,this._height),requestAnimationFrame(this.render)},this.render=()=>{const e=new o.Vector3(0,0,0),t=new a.math.Vector3(this._appCamera.target,this._appCamera.position),n=t.getLength()/this._viewCubeDistance,r=new o.Vector3(t.x/n,t.z/n,-t.y/n),s=new o.Vector3(this._appCamera.up.x,this._appCamera.up.z,-this._appCamera.up.y);this._camera.position.copy(r),this._camera.up=s,this._camera.lookAt(e),this._renderer.clear(),this._renderer.render(this._cubeScene,this._camera),this._renderer.render(this._gridScene,this._camera),this._renderer.render(this._shadowScene,this._camera)},this._processMouseMove=e=>{if(this._dragging)return;const t=this._getEventCoords(e),n=this._getPickVector(t,this._currectPos),r=this._findPickingIntersects(n,this._intersectsFace);this._intersectedFace&&!this._dragging&&(this._intersectedFace.material.opacity=0,this._intersectedFace=void 0,requestAnimationFrame(this.render)),r.length>0&&!this._dragging&&(this._intersectedFace=r[0].object,this._intersectedFace.material.opacity=.3,requestAnimationFrame(this.render))},this._onDocumentMouseDown=e=>{e.preventDefault(),e.stopPropagation();const t=this._getEventCoords(e);if(this._mouseMoved=!1,this._currectPos=this._getPosition(),document.addEventListener("mouseup",this._onDocumentMouseUp,!1),document.addEventListener("touchend",this._onDocumentMouseUp,!1),3===t.which)return;const n=this._getPickVector(t,this._currectPos);this._findPickingIntersects(n,this._cubeBuffer).length>0&&(document.addEventListener("mousemove",this._onDocumentMouseMoveCube,!1),document.addEventListener("touchmove",this._onDocumentMouseMoveCube,!1))},this._onDocumentMouseMoveCube=e=>{e.preventDefault(),e.stopPropagation(),this._mouseMoved=!0,this._dragging=!0;const t=new a.math.Vector2(this._prevX,this._prevY);this._appControllerSwitcher.processMouseEvent(l.EN_MOUSE_EVENT_TYPE.DRAG_START,t);const n=this._getEventCoords(e);if(n.movementX===n.movementY&&0===n.movementX)return;let r=new a.math.Vector2(this._prevX,this._prevY);const s=new a.math.Vector2(t,r).multiply(10);r=t.added(s),this._appControllerSwitcher.processMouseEvent(l.EN_MOUSE_EVENT_TYPE.DRAG_MOVE,r)},this._mouseOverCube=()=>{this._cubeContainer.style.opacity="1.0",this._transparent=!1,requestAnimationFrame(this.render)},this._mouseMoveOverCube=e=>{if(this._transparent)this._cubeContainer.style.opacity=1;else{const t=Math.max(4*Math.abs((e.clientX-this._currectPos.x)/this._currectPos.w-.5)-1,0),n=Math.max(4*Math.abs((e.clientY-this._currectPos.y)/this._currectPos.h-.5)-1,0),r=Math.max(0,Math.min(Math.sqrt(t*t+n*n),1));this._cubeContainer.style.opacity=1-.5*r}},this._mouseOutCube=()=>{this._cubeContainer.style.opacity=.5,this._transparent=!0,requestAnimationFrame(this.render)},this._onDocumentMouseUp=e=>{if(e.preventDefault(),e.stopPropagation(),this._dragging)return this._appControllerSwitcher.processMouseEvent(l.EN_MOUSE_EVENT_TYPE.DRAG_END,new a.math.Vector2),this._dragging=!1,void this._endMouseUp(!1);const t=this._getEventCoords(e),n=this._getPickVector(t,this._currectPos);this._findPickingIntersects(n,this._cubeBuffer).length,this._endMouseUp(!1)},this._processMouseClick=e=>{if(this._mouseMoved)return;const t=this._getEventCoords(e),n=this._getPickVector(t,this._currectPos),r=this._findPickingIntersects(n,this._intersectsFace);if(r.length>0&&!this._dragging){const e=r[0].object;this.onBeforeClicked&&this.onBeforeClicked(this._appCamera),this._appCamera.setNamedViewDirection(e.name)}};const t=document.getElementsByClassName("diy-viewcube");t&&t.length>0&&(this._cubeContainer=t[0]),e&&(this._appCamera=e,this._appControllerSwitcher=this._appCamera._controller),this._intersectsFace=[],this._cubeBuffer=[],this._width=0,this._height=0,this._dragging=!1,this._transparent=!0,this._viewCubeDistance=800,this.initialize()}initialize(){if(!this._cubeContainer||!this._appCamera)return;this._camera=new o.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2e3),this._camera.position.copy(new o.Vector3(this._appCamera.position.x,this._appCamera.position.y,this._appCamera.position.z)),this._camera.lookAt(new o.Vector3);const e=this._cubeContainer.getBoundingClientRect(),t=e.width,n=e.height;this._shadowScene=new o.Scene,this._cubeScene=new o.Scene,this._gridScene=new o.Scene;const r=200,s=o.ShaderLib.cube,i=new o.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:o.UniformsUtils.clone(s.uniforms),depthWrite:!1});this._currectPos=this._getPosition();const a=new c.DDSLoader;a.load("https://3d-resource.oss-cn-beijing.aliyuncs.com/viewcubezh.dds",(e=>{i.uniforms.tCube.value=e,requestAnimationFrame(this.render.bind(this))})),i.uniforms.tCube.value=a;const l=new o.BoxGeometry(r,r,r,1,1,1),d=new o.Mesh(l,i);d.position.set(0,0,0),this._cubeScene.add(d);const u=new o.Geometry;u.vertices.push(new o.Vector3(0,0,0)),u.vertices.push(new o.Vector3(-100,-120,-100)),u.vertices.push(new o.Vector3(100,-120,-100)),u.vertices.push(new o.Vector3(100,-120,100)),u.vertices.push(new o.Vector3(-100,-120,100)),u.faces.push(new o.Face3(4,3,2)),u.faces.push(new o.Face3(4,2,1));const h=new o.MeshBasicMaterial({color:0,transparent:!0,opacity:.5}),g=new o.Mesh(u,h);this._shadowScene.add(g),this._createCubeGrid(),this._renderer=new o.WebGLRenderer({alpha:!0}),this._cubeContainer.onmouseover=this._mouseOverCube,this._cubeContainer.onmousemove=this._mouseMoveOverCube,this._cubeContainer.onmouseout=this._mouseOutCube,this._mouseOutCube(),this.setSize(t,n),this._renderer.autoClear=!1,this._renderer.setSize(t,n),this._renderer.sortObjects=!1,this._cubeContainer.appendChild(this._renderer.domElement),this._cubeContainer.addEventListener("touchstart",this._onDocumentMouseDown,!1),this._cubeContainer.addEventListener("mousedown",this._onDocumentMouseDown,!1),this._cubeContainer.addEventListener("mousemove",this._processMouseMove,!1),this._cubeContainer.addEventListener("click",this._processMouseClick,!1),window.addEventListener("resize",this.onWindowResize,!1)}setSize(e,t){if(this._width=e,this._height=t,this._cubeContainer.children.length>1)for(let e=1;e<this._cubeContainer.children.length;e++)this._cubeContainer.children[e].style.bottom=`${(this._height/5).toString()}px`;this.onWindowResize()}_endMouseUp(e){e||(document.removeEventListener("mouseup",this._onDocumentMouseUp,!1),document.removeEventListener("touchend",this._onDocumentMouseUp,!1)),document.removeEventListener("mousemove",this._onDocumentMouseMoveCube,!1),document.removeEventListener("touchmove",this._onDocumentMouseMoveCube,!1)}_addMeshForTouchAndDisplay(e,t){e.name=t,this._intersectsFace.push(e),this._cubeBuffer.push(e),this._gridScene.add(e)}_addBasicFace(e,t,n){const r=this._buildCubeFace(e,t);this._addMeshForTouchAndDisplay(r,n)}_addSixBasicFaces(){this._addBasicFace(0,0,"front"),this._addBasicFace(0,Math.PI/2,"right"),this._addBasicFace(0,Math.PI,"back"),this._addBasicFace(0,-Math.PI/2,"left"),this._addBasicFace(Math.PI/2,0,"bottom"),this._addBasicFace(-Math.PI/2,0,"top")}_addEightCorners(){const e=["front,top,right","back,top,right","front,top,left","back,top,left","front,bottom,right","back,bottom,right","front,bottom,left","back,bottom,left"],t=[];t[0]=this._buildCubeCorner(0,0),t[1]=this._buildCubeCorner(0,Math.PI/2),t[2]=this._buildCubeCorner(0,-Math.PI/2),t[3]=this._buildCubeCorner(0,Math.PI),t[4]=this._buildCubeCorner(Math.PI/2,0),t[5]=this._buildCubeCorner(Math.PI/2,Math.PI/2),t[6]=this._buildCubeCorner(Math.PI/2,-Math.PI/2),t[7]=this._buildCubeCorner(Math.PI/2,Math.PI);for(let n=0;n<t.length;n++)this._addMeshForTouchAndDisplay(t[n],e[n])}_addTwelveEdgeCubes(){const e=["top,front","top right","top,left","top,back","bottom,front","bottom,right","bottom,left","bottom,back","left,front","front,right","right,back","back,left"],t=[];t[0]=this._buildCubeEdge(0,0,0),t[1]=this._buildCubeEdge(0,Math.PI/2,0),t[2]=this._buildCubeEdge(0,-Math.PI/2,0),t[3]=this._buildCubeEdge(0,Math.PI,0),t[4]=this._buildCubeEdge(Math.PI/2,0,0),t[5]=this._buildCubeEdge(Math.PI/2,Math.PI/2,0),t[6]=this._buildCubeEdge(Math.PI/2,-Math.PI/2,0),t[7]=this._buildCubeEdge(Math.PI/2,Math.PI,0),t[8]=this._buildCubeEdge(0,0,Math.PI/2),t[9]=this._buildCubeEdge(0,0,-Math.PI/2),t[10]=this._buildCubeEdge(-Math.PI/2,0,-Math.PI/2),t[11]=this._buildCubeEdge(-Math.PI,0,-Math.PI/2);for(let n=0;n<t.length;n++)this._addMeshForTouchAndDisplay(t[n],e[n])}_createCubeGrid(){this._addSixBasicFaces(),this._addEightCorners(),this._addTwelveEdgeCubes()}_buildCubeCorner(e,t){const n=new o.Geometry,r=new o.Vector3(u,u,u),s=new o.Vector3(d,u,u),i=new o.Vector3(d,d,u),a=new o.Vector3(u,d,u),c=new o.Vector3(u,u,d),l=new o.Vector3(u,u,u),h=new o.Vector3(u,d,u),g=new o.Vector3(u,d,d),f=new o.Vector3(u,u,u),p=new o.Vector3(u,u,d),_=new o.Vector3(d,u,d),m=new o.Vector3(d,u,u);n.vertices.push(r),n.vertices.push(s),n.vertices.push(i),n.vertices.push(a),n.vertices.push(c),n.vertices.push(l),n.vertices.push(h),n.vertices.push(g),n.vertices.push(f),n.vertices.push(p),n.vertices.push(_),n.vertices.push(m),n.faces.push(new o.Face3(0,1,2)),n.faces.push(new o.Face3(0,2,3)),n.faces.push(new o.Face3(4,5,6)),n.faces.push(new o.Face3(4,6,7)),n.faces.push(new o.Face3(8,9,10)),n.faces.push(new o.Face3(8,10,11)),n.applyMatrix((new o.Matrix4).makeRotationX(e)),n.applyMatrix((new o.Matrix4).makeRotationY(t)),n.computeFaceNormals(),n.computeVertexNormals();const v=new o.MeshBasicMaterial({overdraw:1,opacity:0,color:45055,transparent:!0});return new o.Mesh(n,v)}_buildCubeEdge(e,t,n){const r=new o.Geometry,s=new o.Vector3(d,u,u),i=new o.Vector3(-60,u,u),a=new o.Vector3(-60,d,u),c=new o.Vector3(d,d,u),l=new o.Vector3(d,u,d),h=new o.Vector3(-60,u,d),g=new o.Vector3(-60,u,u),f=new o.Vector3(d,u,u);r.vertices.push(s),r.vertices.push(i),r.vertices.push(a),r.vertices.push(c),r.vertices.push(l),r.vertices.push(h),r.vertices.push(g),r.vertices.push(f),r.faces.push(new o.Face3(0,1,2)),r.faces.push(new o.Face3(0,2,3)),r.faces.push(new o.Face3(4,5,6)),r.faces.push(new o.Face3(4,6,7)),r.applyMatrix((new o.Matrix4).makeRotationX(e)),r.applyMatrix((new o.Matrix4).makeRotationY(t)),r.applyMatrix((new o.Matrix4).makeRotationZ(n)),r.computeFaceNormals(),r.computeVertexNormals();const p=new o.MeshBasicMaterial({overdraw:1,opacity:0,color:45055,transparent:!0});return new o.Mesh(r,p)}_buildCubeFace(e,t){const n=new o.Geometry,r=new o.Vector3(0,0,0),s=new o.Vector3(d,-60,u),i=new o.Vector3(d,d,u),a=new o.Vector3(-60,d,u),c=new o.Vector3(-60,-60,u);n.vertices.push(r),n.vertices.push(s),n.vertices.push(i),n.vertices.push(a),n.vertices.push(c),n.faces.push(new o.Face3(1,2,3)),n.faces.push(new o.Face3(1,3,4)),n.applyMatrix((new o.Matrix4).makeRotationX(e)),n.applyMatrix((new o.Matrix4).makeRotationY(t)),n.computeFaceNormals(),n.computeVertexNormals();const l=new o.MeshBasicMaterial({overdraw:1,opacity:0,color:45055,transparent:!0});return new o.Mesh(n,l)}_findPickingIntersects(e,t){let n=new o.Vector3;n.copy(e),n=n.unproject(this._camera);return new o.Raycaster(this._camera.position,n.sub(this._camera.position).normalize()).intersectObjects(t)}_getPosition(){const e=this._cubeContainer.getBoundingClientRect();return{x:e.left,y:e.top,w:e.width,h:e.height}}_getPickVector(e,t){let n=e.clientX-t.x,r=e.clientY-t.y;return n=n/t.w*2-1,r=(t.h-r)/t.h*2-1,new o.Vector3(n,r,.5)}_getEventCoords(e){let t={};return 0===e.type.indexOf("touch")?e.touches.length>0?(t.clientX=e.touches[0].clientX,t.clientY=e.touches[0].clientY,t.pageX=e.touches[0].pageX,t.pageY=e.touches[0].pageY,t.screenX=e.touches[0].screenX,t.screenY=e.touches[0].screenY,t.movementX=t.screenX-this._prevX,t.movementY=t.screenY-this._prevY,t.which=1):t=this._prevCoords:(t.clientX=e.clientX,t.clientY=e.clientY,t.pageX=e.pageX,t.pageY=e.pageY,t.screenX=e.screenX,t.screenY=e.screenY,t.which=e.which,t.movementX=t.screenX-this._prevX,t.movementY=t.screenY-this._prevY),this._prevX=t.screenX,this._prevY=t.screenY,this._prevCoords=t,t}}},79762:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.app=void 0;const r=n(11644);t.app=r.App.getInstance()},98295:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ActionManager=void 0;const s=n(79762),i=n(16724),o=n(70768);class a{constructor(){this._actionStack=[]}static getInstance(){return a.instance||(a.instance=new a),a.instance}registerDefaultAction(e){const t=this._defaultActionCtor;return this._defaultActionCtor=e,t}processKeyboardEvent(e){if(!this._isValidDoc())return!1;this._initDefaultAction();const t=this._actionStack[this._actionStack.length-1];return!(null==t?void 0:t.isFinished())&&(s.app.logRecorder.processKeyboardEvent(t.getClassName(),e),o.platformEventMgr.emit(o.EN_PLATFORM_EVENT_TYPE.KEY_EVENT_PRE_ACTION,e),this._actionStack.concat().reverse().some((t=>t.processKeyboardEvent(e))))}processMouseEvent(e,t,n){if(!this._isValidDoc())return!1;o.platformEventMgr.emit(o.EN_PLATFORM_EVENT_TYPE.MOUSE_EVENT_PRE_ACTION,{mouseEventType:e,pos:t}),this._initDefaultAction();const r=this._actionStack[this._actionStack.length-1];return!(null==r?void 0:r.isFinished())&&((!e.includes("clk")&&!e.includes("up")&&e!==i.EN_MOUSE_EVENT_TYPE.DRAG_END||this.___lastMouseDownAction===r)&&(e.includes("down")&&(this.___lastMouseDownAction=r),(r.constructor!==this._defaultActionCtor||e!==i.EN_MOUSE_EVENT_TYPE.MOUSE_ENTER)&&(s.app.logRecorder.processMouseEvent(r.getClassName(),e,t,n),!!r.processMouseEvent(e,t,n))))}resetAllActions(e=!0){for(;this._actionStack.length;){if(!e&&1===this._actionStack.length)return;const t=this._actionStack.pop();t&&t.cancel()}}getCurrentAction(){if(!this._isValidDoc())return;this._initDefaultAction();return this._actionStack[this._actionStack.length-1]}tick(e){}runAction(e){var t;return r(this,void 0,void 0,(function*(){this._actionStack[Math.max(1,this._actionStack.length)]=e,e.init(s.app.getCurrentView()),yield e.run();const n=yield e.getPromise();return e===this._actionStack[this._actionStack.length-1]&&this._actionStack.pop(),null===(t=this.getCurrentAction())||void 0===t||t._onResume(),n}))}_initDefaultAction(){if(!this._actionStack[0]&&this._defaultActionCtor){const e=new this._defaultActionCtor;this._actionStack[0]=e,e.init(s.app.getCurrentView()),e.run().catch((e=>{}))}}_isValidDoc(){return!!s.app.getMainDoc()}}t.ActionManager=a},69127:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultAction=void 0;const r=n(31667),s=n(50347),i=n(19180),o=n(98295),a=n(3376);class c extends i.Action{getClassName(){return"DefaultAction"}_onMouseMove(e){const[t]=s.PickUtil.pickGNode(this.getIView(),e);return void 0===t?(r.HighLight.getInstance().clear(),this._updateView(),!1):(t&&t.elementId&&t.elementId.isValid()&&r.HighLight.getInstance().getActiveObjects().has(t.elementId.asInt())||(r.HighLight.getInstance().reset(t.elementId.asInt()),this._updateView()),!1)}_onClick(e,t){const[n]=s.PickUtil.pickGNode(this.getIView(),e);return r.HighLight.getInstance().clear(),void 0!==n||t.ctrlKey?(n&&(t.ctrlKey?r.Selection.getInstance().add([n.elementId.asInt()],e):r.Selection.getInstance().reset([n.elementId.asInt()],e),this._updateView()),a.MouseCallbackToDrag.getInstance().onClick(e,t),!1):(r.Selection.getInstance().clear(),this._updateView(),!1)}_onLButtonDown(e){return[this._mouseDownPicked]=s.PickUtil.pickGNode(this.getIView(),e),a.MouseCallbackToDrag.getInstance().onLButtonDown(e),!1}_onDragStart(e,t){var n;this._draggedStartPt=this.getIView().screenToWorkPlane(e);const s=r.Selection.getInstance().getSelectedElementIds();if(s.length&&this._mouseDownPicked&&s[0]===this._mouseDownPicked.elementId.asInt())return this._draggedElement=this.getCurrentDoc().getElementById(s[0]),(null===(n=this._draggedElement)||void 0===n?void 0:n.canBeMoved())?(this._mouseDownPicked=void 0,a.MouseCallbackToDrag.getInstance().onDragStart(e,t)):(this._draggedElement=void 0,!1)}_onDragMove(e,t){return a.MouseCallbackToDrag.getInstance().onDragMove(e,t)}_onDragEnd(e,t){if(!this._draggedElement)return!1;if(a.MouseCallbackToDrag.getInstance().hasRegisteredStrategy(this._draggedElement)){const n=a.MouseCallbackToDrag.getInstance().onDragEnd(e,t);return this.clearTmp(),n}{const t=this.getIView().screenToWorkPlane(e),n=new r.math.Vector3(this._draggedStartPt,t);return r.transact(this.getCurrentDoc(),"拖动element",(()=>{this._draggedElement.translate(n)})),this._draggedElement=void 0,!0}}}t.DefaultAction=c,o.ActionManager.getInstance().registerDefaultAction(c)},80588:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DrawArcFaceActionByThreePts=void 0;const s=n(31667),i=n(31667),o=n(19180),a=n(84535),c=n(85522),l=n(72686);class d extends o.Action{constructor(e){super(),this._step="first",this._constraintPlane=e}getClassName(){return"DrawArcFaceActionByThreePts"}run(){return r(this,void 0,void 0,(function*(){for(;!this.isFinished();)"first"===this._step?yield this._runStepFirst():"second"===this._step&&(yield this._runStepSecond())}))}getStartEndPtInfo(){return[this._p0,this._p2]}_movePt(e,t){if(!this._p0||!this._p1)return;const n=new s.GRep,r=t.point.clone();if(this._constraintPlane){const e=new s.math.Vector3;s.math.MathAlg.CalculateDistance.pointToSurface(t.point,this._constraintPlane,e),t.point=e}const i=s.math.Plane.makePlaneByTreePoints(this._p0.point,this._p1.point,t.point);if(this._p2=t,!i)return void this.clearTmp();this._constraintPlane&&!t.point.equals(r)&&n.addCurve3d(new s.math.Line3d(t.point,r)).setStyle({line:a.dotLineStyle});const o=s.math.Arc3d.makeArcByThreePoints(this._p0.point,t.point,this._p1.point);o&&(n.addPoint3d(this._p0.point),n.addPoint3d(this._p1.point),n.addCurve3d(o),this._drawTmpGRep(n),this._updateView())}_runStepFirst(){return r(this,void 0,void 0,(function*(){this._drawLineAction=new c.DrawLineAction(this._constraintPlane);const e=yield this._runChildAction(this._drawLineAction);if(e.isCanceled)"string"==typeof e.data&&"pick_first_pt"===e.data?this.markCanceled():this._step="first";else if(e.data&&"string"!=typeof e.data){if(e.data instanceof s.math.Line3d){[this._p0,this._p1]=this._drawLineAction.getStartEndPtInfo(),this._step="second";const e=new s.GRep;e.addPoint3d(this._p0.point),e.addPoint3d(this._p1.point),this.drawTmpGRep(e),this._updateView()}}else this._step="first"}))}_runStepSecond(){return r(this,void 0,void 0,(function*(){if(!this._p0||!this._p1)return this._step="first",!1;const e=new l.PickObserver((e=>r(this,void 0,void 0,(function*(){this._p2=e,this._p1.point.equals(e.point)||this._movePt(this._p1.point,e)})))),t=new i.SnapContext;t.snapPlane=this._constraintPlane,this._pickAction=new l.PickPointAction(e,t);if((yield this._runChildAction(this._pickAction)).isCanceled)return this._reset(),this.clearTmp(),!1;return(yield this._onArcFinished())?this._reset():this._step="second",this.clearTmp(),this._updateView(),!0}))}_onArcFinished(){return r(this,void 0,void 0,(function*(){if(!this._p0||!this._p1||!this._p2)return!1;const e=s.math.Plane.makePlaneByTreePoints(this._p0.point,this._p1.point,this._p2.point);if(!e)return!1;const t=this._p0.point.interpolated(this._p1.point,.5),n=this._p1.point.subtracted(this._p0.point).cross(e.getNorm()),r=new s.math.Line3d(t,n,[-s.math.CONST.MODEL_MAX_LENGTH,s.math.CONST.MODEL_MAX_LENGTH]).getProjectedPtBy(this._p2.point),i=s.math.Arc3d.makeArcByThreePoints(this._p0.point,r,this._p1.point);if(!i)return!1;return[i].push(new s.math.Line3d(this._p1.point,this._p0.point)),this._updateView(),this.clearTmp(),!0}))}_reset(){this._p0=void 0,this._p1=void 0,this._p2=void 0,this._pickAction=void 0,this._drawLineAction=void 0,this._step="first"}}t.DrawArcFaceActionByThreePts=d},85522:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DrawLineAction=void 0;const s=n(31667),i=n(84535),o=n(19180),a=n(88123),c=n(72686);class l extends o.Action{constructor(e,t){super(),this._step="pick_first_pt",this._snapPlane=e,this._drawLineCallbacks=null!=t?t:{}}getClassName(){return"DrawLineAction"}run(){return r(this,void 0,void 0,(function*(){for(;!this.isFinished();)"pick_first_pt"===this._step?yield this._runStepFirstPoint():yield this._runStepSecondPoint(),this._pickAction=void 0}))}getStartEndPtInfo(){return[this._startPt,this._endPt]}_runStepFirstPoint(){var e;return r(this,void 0,void 0,(function*(){a.SnapHelperManager.getInstance().clearSnapHelperObjects(a.EN_SNAP_HELPER_TYPE.BRIEF);const t=new c.PickObserver(void 0),n=new s.SnapContext;n.snapPlane=null===(e=this._snapPlane)||void 0===e?void 0:e.clone(),this._pickAction=new c.PickPointAction(t,n);const r=yield this._runChildAction(this._pickAction);if((null==r?void 0:r.isCanceled)||!(null==r?void 0:r.data))return void this._markCanceled("pick_first_pt");let i=!1;i=this._drawLineCallbacks.onFirstPtFinished?yield this._drawLineCallbacks.onFirstPtFinished(r):yield this._onFirstPtFinished(r),i&&(this._startPt=r.data,this._step="pick_second_pt")}))}_onFirstPtFinished(e){return r(this,void 0,void 0,(function*(){return!0}))}_runStepSecondPoint(){var e;return r(this,void 0,void 0,(function*(){if(!this._startPt)return void this._reset();const t=new c.PickObserver(((e,t)=>{this._startPt&&!this._startPt.point.equals(e.point)&&(this._drawLineCallbacks.moveCallbackOfSecondPt?this._drawLineCallbacks.moveCallbackOfSecondPt(this._startPt,e,t):this._movePt(this._startPt,e,t))})),n=new s.SnapContext;n.snapPlane=null===(e=this._snapPlane)||void 0===e?void 0:e.clone(),n.previousPoint=this._startPt.point,this._pickAction=new c.PickPointAction(t,n);const r=yield this._runChildAction(this._pickAction);if(r.isCanceled||!r.data)return this._step="pick_first_pt",void this._reset();yield this._onSecondPtFinished(r)}))}_onSecondPtFinished(e){return r(this,void 0,void 0,(function*(){if(!this._startPt)return;if(this._startPt.point.equals(e.data.point))return;this._endPt=e.data,this._line=new s.math.Line3d(this._startPt.point,e.data.point);let t=!1;t=this._drawLineCallbacks.onLineFinished?yield this._drawLineCallbacks.onLineFinished(this._startPt,e.data):yield this._onFirstPtFinished(e),t?this._markSuccess(this._line):this._line=void 0}))}_onLineFinished(e,t){return r(this,void 0,void 0,(function*(){return!0}))}_movePt(e,t,n){if(e.point.equals(t.point))return;const r=new s.GRep,o=new s.math.Line3d(e.point,t.point);let a=0;a=t.snapType===s.EN_SNAP_TYPE.ExtensionPoint?16004596:i.getColorAccordingToDir(o.getDirection());const c={color:a};r.addCurve3d(o).setStyle({line:c}),this._drawTmpGRep(r),this._updateView()}_onFinished(){a.SnapHelperManager.getInstance().clearSnapHelperObjects(a.EN_SNAP_HELPER_TYPE.BRIEF)}_reset(){this._step="pick_first_pt",this._pickAction=void 0,this._startPt=void 0,this._line=void 0,a.SnapHelperManager.getInstance().clearSnapHelperObjects(a.EN_SNAP_HELPER_TYPE.BRIEF)}}t.DrawLineAction=l},96460:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DrawLinearElementAction=void 0;const s=n(31667),i=n(31667),o=n(72686),a=n(19180);class c extends a.Action{constructor(){super(...arguments),this._continuity=!1,this._snapContext=new s.SnapContext,this._clearTmpOnLineFinished=!0,this._step="pick_first_pt"}run(){return r(this,void 0,void 0,(function*(){for(;!this.isFinished();)"pick_first_pt"===this._step?yield this._runStepFirstPoint():yield this._runStepContinuePoint(),this._pickAction=void 0}))}_movePt(e,t,n){e.point.equals(t.point)||this._drawTmpLine(e.point,t.point),this._updateView()}_onPickPointClick(e,t){}_onKeyWhenMovePt(e,t,n){}_onLineFinished(e,t){return r(this,void 0,void 0,(function*(){return this._clearTmpOnLineFinished&&this.clearTmp(),this._updateView(),!0}))}_onCancelPickAction(){return this.clearTmp(),!0}_runStepFirstPoint(){return r(this,void 0,void 0,(function*(){const e=new o.PickObserver(void 0);e.setClickCallback(((e,t)=>{e&&this._onPickPointClick(e,t)})),e.highlightPickedGNodes=this._highlightPickedGNode,this._pickAction=new o.PickPointAction(e);const t=yield this._runChildAction(this._pickAction);!(null==t?void 0:t.isCanceled)&&(null==t?void 0:t.data)?yield this._onFirstPtFinished(t):this._markCanceled()}))}_onFirstPtFinished(e){return r(this,void 0,void 0,(function*(){if(e.isCanceled)this._onCancelPickAction(),this._markSuccess(void 0);else{this._firstPt=e.data;const{point:t,screenPt:n,pickedPlane:r,pickedGNodes:s}=this._firstPt;this._previousPt={point:t.clone(),screenPt:null==n?void 0:n.clone(),pickedPlane:null==r?void 0:r.clone(),pickedGNodes:s,snapType:this._firstPt.snapType},this._step="continue_pick"}}))}_runStepContinuePoint(){var e,t;return r(this,void 0,void 0,(function*(){if(!this._previousPt)return void(this._step="pick_first_pt");const n=new o.PickObserver(((e,t)=>{this._previousPt&&this._movePt(this._previousPt,e,t)}));n.setClickCallback(((e,t)=>{e&&this._onPickPointClick(e,t)})),n.highlightPickedGNodes=this._highlightPickedGNode;const r=this._snapContext;this._snappedPlane&&(r.snapPlane=this._snappedPlane.clone()),r.previousPoint=null===(e=this._previousPt.point)||void 0===e?void 0:e.clone(),r.previousLineDir=null===(t=this._previousLineDir)||void 0===t?void 0:t.clone(),r.firstPoint=this._firstPt.point,this._pickAction=new o.PickPointAction(n,r);const s=yield this._runChildAction(this._pickAction);!s.isCanceled&&s.data?yield this._onSecondPtFinished(s):this._markCanceled()}))}_onSecondPtFinished(e){return r(this,void 0,void 0,(function*(){let t,n=!1;if(e.isCanceled?(this._step="pick_first_pt",n=!1,this._onCancelPickAction()):(t=e.data,n=!0),n=!(!n||!t),n&&t){(yield this._onLineFinished(this._previousPt,t))?this._continuity?(this._previousPt&&(this._previousLineDir=new i.math.Vector3(this._previousPt.point,t.point)),this._snappedPlane||this._previousPt.point.equals(this._firstPt.point)||this._previousPt.point.equals(t.point)||(this._snappedPlane=i.math.Plane.makePlaneByTreePoints(this._firstPt.point,this._previousPt.point,t.point)),this._previousPt=t,this._step="continue_pick"):this._step="pick_first_pt":this._step="continue_pick"}}))}}t.DrawLinearElementAction=c},99878:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DrawRectElementAction=void 0;const s=n(31667),i=n(31667),o=n(19180),a=n(72686),c=n(5535);class l extends o.Action{constructor(){super(),this._pickFilter=(new c.PickFilter).allowAll(),this._step="first",this._p0={point:s.math.Vector3.O(),screenPt:s.math.Vector2.O()},this._p1={point:s.math.Vector3.O(),screenPt:s.math.Vector2.O()}}run(){return r(this,void 0,void 0,(function*(){for(;!this.isFinished();)"first"===this._step?yield this._runStepFirst():yield this._runStepSecond()}))}_movePt(e,t,n){}_onRectFinished(e,t){return r(this,void 0,void 0,(function*(){return!0}))}_onKeyWhenMovePt(e,t,n){}_runStepFirst(){return r(this,void 0,void 0,(function*(){const e=new a.PickObserver(void 0),t=new i.SnapContext;this._constraintPlane&&(t.snapPlane=this._constraintPlane),this._pickAction=new a.PickPointAction(e,t);const n=yield this._runChildAction(this._pickAction);n.isCanceled?this._markSuccess(void 0):(this._p0=n.data,this._step="second")}))}_runStepSecond(){return r(this,void 0,void 0,(function*(){const e=(e,t)=>{this._p1=e,this._p0.point.equals(e.point)||this._movePt(this._p0,e,t)},t=new a.PickObserver(e,this._pickFilter),n=new i.SnapContext;this._constraintPlane&&(n.snapPlane=this._constraintPlane),this._pickAction=new a.PickPointAction(t,n);let r="p1_ok";const s=yield this._runChildAction(this._pickAction);s.isCanceled&&(r="p1_cancel");let o=!1;switch(r){case"p1_ok":this._p0.point.equals(s.data.point)||(this._p1=s.data,this._step="first",o=!0);break;case"p1_cancel":this._p1=this._p0,this._step="first"}if(o){const e=yield this._onRectFinished(this._p0,this._p1);this._step=e?"first":"second"}this.clearTmp(),"first"!==this._step&&e(this._p1),this._updateView()}))}}t.DrawRectElementAction=l},19211:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LoadResourceAction=void 0;const i=s(n(65337)),o=n(19180);class a extends o.Action{constructor(e,t,n){super(),this._method=e,this._url=t,this._responseType=n}getClassName(){return"LoadResourceAction"}run(){return r(this,void 0,void 0,(function*(){const e=yield this._load();this._markSuccess(e)}))}_load(){return i.default({method:this._method,url:this._url,responseType:this._responseType}).then((e=>e)).catch((e=>e))}}t.LoadResourceAction=a},89511:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PickElementAction=void 0;const s=n(54636),i=n(5535),o=n(19180);class a extends o.Action{constructor(e=[],t,n){super(),e.length&&(this._set=new Set(e)),n&&(this._mouseMoveCallBack=n),t&&(this._isElementAllowed=t)}getClassName(){return"PickElementAction"}run(){return r(this,void 0,void 0,(function*(){const e=new i.PickFilter;for(e.allowAll(),this._set&&e.setCustomizedFilter((e=>!(!this._isElementAllowed||!this._isElementAllowed(e.elementId))||this._set.has(e.category)));!this.isFinished();){const t=this._mouseMoveCallBack?e=>{this._mouseMoveCallBack(e)}:void 0,n=yield this._runChildAction(new s.PickGNodeAction(e,t));if(n.isCanceled)return void this._markCanceled();const r=n.data.gnode;if(void 0===r)continue;const i=r.elementId;return void this._markSuccess(i)}}))}setFilterCategory(e){this._set=new Set(e)}}t.PickElementAction=a},3230:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PickElementsAction=void 0;const s=n(31667),i=n(54636),o=n(5535),a=n(19180);class c extends a.Action{constructor(e=[],t,n){super(),this._continuePick=!1,e.length&&(this._set=new Set(e)),n&&(this._mouseMoveCallBack=n),t&&(this._isElementAllowed=t)}getClassName(){return"PickElementsAction"}run(){return r(this,void 0,void 0,(function*(){const e=new o.PickFilter;for(e.allowAll(),this._set&&e.setCustomizedFilter((e=>!(!this._isElementAllowed||!this._isElementAllowed(e.elementId))||this._set.has(e.category))),this._pickedElements=new Set;!this.isFinished();){const t=this._mouseMoveCallBack?e=>{this._mouseMoveCallBack(e)}:void 0;this._pickAction=new i.PickGNodeAction(e,t);const n=yield this._runChildAction(this._pickAction);if(n.isCanceled)return void this._markCanceled();const r=n.data.gnode;if(null==r?void 0:r.elementId.isValid()){const e=this.getCurrentDoc().getElementById(n.data.gnode.elementId);this._pickedElements.add(e),s.Selection.getInstance().add([e.id.asInt()]),this._updateView()}if(!this._continuePick)return void this._markSuccess(Array.from(this._pickedElements).map((e=>e.id)))}}))}setFilterCategory(e){this._set=new Set(e)}_onKeyDown(e){return"mod"===e.key?(this._continuePick=!0,!0):super._onKeyDown(e)}_onKeyUp(e){return"mod"!==e.key||(this._continuePick=!1,this._pickedElements.size?this._pickAction.markSuccess({}):this._pickAction.markCanceled(),!0)}}t.PickElementsAction=c},49726:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.PickFileAction=void 0;const s=n(19180);let i;class o extends s.Action{constructor(e=".json",t="text"){super(),this._fileType=e,this._format=t}getClassName(){return"PickFileAction"}run(){return r(this,void 0,void 0,(function*(){this._loadFile(this._fileType,this._format)}))}_pickFile(e,t){if(!i){const e=document.createElement("input");e.setAttribute("type","file"),e.style.display="none",document.body&&(document.body.appendChild(e),i=e)}const n=i;n.setAttribute("multiple",t?"true":"false"),n.setAttribute("accept",e),n.value="";return new Promise(((e,t)=>{n.onchange=()=>{const r=n.files;if(r){const t=[],s=r.length;for(let e=0;e<s;++e)t.push(r[e]);n.value="",e(t)}else n.value="",t(new Error("Get no file"))},n.click()}))}_loadFile(e,t){return r(this,void 0,void 0,(function*(){const n=(yield this._pickFile(e,!1))[0],r=new FileReader;switch(r.onload=e=>{this._markSuccess({data:e.target.result,file:n})},r.onerror=()=>this._markCanceled(),t){case"text":r.readAsText(n);break;case"dataURL":r.readAsDataURL(n)}}))}}t.PickFileAction=o},54636:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickGNodeAction=void 0;const r=n(31667),s=n(50347),i=n(19180),o=n(82658);class a extends i.Action{constructor(e,t,n={}){super(),this._pickFilter=e,this._mouseMoveCallBack=t,this._extra=n,this._calMouseIntersectGNode=!1,this._mouseDown=!1}getClassName(){return"PickGNodeAction"}allCalMouseIntersectGNodePt(){this._calMouseIntersectGNode=!0}getPickFilter(){return this._pickFilter}setPickFilter(e){this._pickFilter=e}_mouseIntersectGNode(e,t){if(this._calMouseIntersectGNode)return s.PickUtil.mouseIntersectGNode(e,t)}_onLButtonDown(e,t){return this._mouseDown=!0,super._onLButtonDown(e,t)}_onLButtonUp(e,t){return this._mouseDown||this._onClick(e,t),this._mouseDown=!1,super._onLButtonUp(e,t)}_onMouseMove(e,t){var n,i,o,a,c,l;let[d,u]=s.PickUtil.pickGNode(this.getIView(),e,this._pickFilter);(null==d?void 0:d.elementId.isValid())?null===(i=(n=this._extra).onPickedValidGNode)||void 0===i||i.call(n):u?null===(a=(o=this._extra).onPickedInvalidGNode)||void 0===a||a.call(o):null===(l=(c=this._extra).onPickedNothing)||void 0===l||l.call(c),!d&&this._extra.cpuPick&&(d=this._extra.cpuPick(this.getIView(),e)[0]),this.clearTmp(),this._mouseMoveCallBack&&this._mouseMoveCallBack({mousePt:e,fnKey:t,gnode:d,mouseIntersectGNode:d?this._mouseIntersectGNode(e,d):void 0});const h=this.getPickedPoint(e,d);if(h){const e=new r.GRep;return e.addNode(h.point),this._drawTmpGRep(e),this._highLightGNode(d,t),this._updateView(),!0}return(!d||!r.HighLight.getInstance().getActiveObjects().has(d))&&(void 0===d||void 0===d.globalID?(r.HighLight.getInstance().clear(),this._updateView(),!1):(this._highLightGNode(d,t),this._updateView(),!1))}_onClick(e,t){var n;let[i]=s.PickUtil.pickGNode(this.getIView(),e,this._pickFilter);if(!i&&this._extra.cpuPick&&(i=this._extra.cpuPick(this.getIView(),e)[0]),r.HighLight.getInstance().clear(),this.clearTmp(),void 0===i)return r.HighLight.getInstance().clear(),this._updateView(),this._markSuccess({mousePt:e,fnKey:t}),!1;!1!==this._extra.addToSelection&&(r.Selection.getInstance().add([i]),this._updateView());const o=this.getPickedPoint(e,i);let a=(null==o?void 0:o.isStart)?"start":"end";return o||(a=void 0),this._markSuccess({mousePt:e,fnKey:t,gnode:i,gnodeKey:(null===(n=this._extra)||void 0===n?void 0:n.needGNodeKey)?new r.GNodeKey(i.elementId,i.id,a):void 0,mouseIntersectGNode:this._mouseIntersectGNode(e,i)}),!1}getPickedPoint(e,t){if(!this._extra.pickState||"point"!==this._extra.pickState&&"curve_and_point"!==this._extra.pickState)return;if((null==t?void 0:t.getType())!==r.GNODE_TYPE.GCurve3d&&(null==t?void 0:t.getType())!==r.GNODE_TYPE.GEdge)return;const n=t,i=this.getIView(),a=i.generateCameraRay(e);a.extendDouble(r.math.CONST.MODEL_MAX_LENGTH);const c=n.getStartPt(),l=n.getEndPt(),d=r.math.Vector3.O(),u=r.math.Vector3.O(),h=r.math.MathAlg.CalculateDistance.pointToCurve3d(c,a,d),g=r.math.MathAlg.CalculateDistance.pointToCurve3d(l,a,d),f=h<g,p=h<g?h:g,_=h<g?d:u,m={point:{color:o.appConfig.common.color_active,size:10}};if("point"===this._extra.pickState)return{point:new r.GPoint3d(f?c:l).setStyle(m),isStart:f};const v=a.getParamAt(_);if(p<1/s.PickUtil.pixelsPerUnitCreator(i.getCameraInfo(),i.getSize().y)(v)*10){return{point:new r.GPoint3d(f?c:l).setStyle(m),isStart:f}}}_highLightGNode(e,t){if(!e)return;let n;if(n="gnode"===this._extra.highLightStrategy||"grep"!==this._extra.highLightStrategy&&("hotkey"===this._extra.highLightStrategy?t.ctrlKey||t.metaKey:!(!this._pickFilter||this._pickFilter.isEnableGRep())),n)r.HighLight.getInstance().reset(e);else{this.getCurrentDoc().getElementById(e.elementId)&&r.HighLight.getInstance().reset(e.elementId.asInt())}}}t.PickGNodeAction=a},24126:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getPickedPlane=t.EN_SNAP_POINT_COLOR=t.clonePickedResult=void 0;const r=n(31667);t.clonePickedResult=function(e){var t,n,r;return{point:null===(t=e.point)||void 0===t?void 0:t.clone(),screenPt:null===(n=e.screenPt)||void 0===n?void 0:n.clone(),pickedPlane:null===(r=e.pickedPlane)||void 0===r?void 0:r.clone(),pickedGNodes:e.pickedGNodes,pickedRefObject:e.pickedRefObject,snapType:e.snapType}},function(e){e[e.POINT_ON_FACE=1842204]="POINT_ON_FACE",e[e.END_POINT=4063173]="END_POINT",e[e.POINT_ON_CURVE=1842204]="POINT_ON_CURVE",e[e.MIDDLE_POINT=4063173]="MIDDLE_POINT",e[e.PARALLEL_TO_AXIS=4063173]="PARALLEL_TO_AXIS",e[e.INTERSECT_POINT=4063173]="INTERSECT_POINT",e[e.VERTICAL_PARALLEL=4063173]="VERTICAL_PARALLEL"}(t.EN_SNAP_POINT_COLOR||(t.EN_SNAP_POINT_COLOR={})),t.getPickedPlane=function(e,t){return r.math.Plane.makePlaneByPointNormal(t,e.getWorkPlane().plane.getNorm())}},5535:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickFilter=void 0;const r=n(31667),s=[r.GNODE_TYPE.GCurve3d,r.GNODE_TYPE.GCurve2d,r.GNODE_TYPE.GFace,r.GNODE_TYPE.GSurface,r.GNODE_TYPE.GEdge,r.GNODE_TYPE.GCurves,r.GNODE_TYPE.GMesh];t.PickFilter=class{constructor(){this._filteredTypes=new Set}allowAll(){return s.forEach((e=>{this.allow(e)})),this}setCustomizedFilter(e){return this._customizedFilter=e,this}isEnableGRep(){return this._filteredTypes.size===s.length}disallowAll(){return this._filteredTypes.clear(),this}allow(e){return this._filteredTypes.add(e),this}disallow(e){return this._filteredTypes.delete(e),this}isEnable(e,t){let n;return n=e.getType()===r.GNODE_TYPE.GNodeRef?this._filteredTypes.has(e.getOriginGNode().getType())||this._filteredTypes.has(r.GNODE_TYPE.GNodeRef):this._filteredTypes.has(e.getType()),!!n&&(this._customizedFilter?this._customizedFilter(e,t):n)}}},72686:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickObserver=t.PickPointAction=void 0;const r=n(31667),s=n(31667),i=n(19180),o=n(88123),a=n(66059),c=n(33680);class l extends i.Action{constructor(e,t){super(),this._hoverSnappedPtTime=(new Date).getTime(),this._hoverPickedGNodeTime=(new Date).getTime(),this._observer=e,t&&(this._snapContext=t,this._snapContext.addSnapHelpers(r.EN_SNAP_HELPER_OBJECT.POINT,o.SnapHelperManager.getInstance().getAllSnapHelperPoints()))}getClassName(){return"PickPointAction"}getSnapContext(){return this._snapContext}setSnapContext(e){this._snapContext=e}getCurrentResult(){return this._currentPickResult}getCurrentMousePos(){return this._currentMousePos}getPickObserver(){return this._observer}_onClick(e,t){if(this._currentMousePos=e,this._observer.getClickCallback()&&this._currentPickResult&&this._observer.getClickCallback()(this._currentPickResult,t),this._currentPickResult)this._markSuccess(this._currentPickResult);else{const t=this._getPickPointResult(e);this._markSuccess(t)}return!0}_onMouseMove(e,t){return this._onMouseMoveThrottle(e,t),!1}_onKeyDown(e){return!!super._onKeyDown(e)}_onFinished(){super._onFinished(),o.SnapHelperManager.getInstance().clearSnapHelperObjects(o.EN_SNAP_HELPER_TYPE.BRIEF),this.hideMouseTip()}_onMouseMoveThrottle(e,t){if(this.isFinished())return;this._currentMousePos=e,this.getBuildInTmpElementPainter()&&this.getBuildInTmpElementPainter().clearTmp();const n=this._getPickPointResult(e);this._observer.movePoint(n,t),this._currentPickResult=n}_getPickPointResult(e){var t,n,s,i;a.createReferenceCurves(this._lastPickedResult,this._hoverSnappedPtTime),a.createReferenceDirs(this._lastPickedResult,this._hoverSnappedPtTime,null===(t=this._snapContext)||void 0===t?void 0:t.previousPoint),a.createReferencePoint(this._lastPickedResult,this._hoverPickedGNodeTime),this._snapContext||(this._snapContext=new r.SnapContext);const o=c.RunSnapUtil.snapPoint(e,this._snapContext,this.getIView(),this._observer);return this._hoverSnappedPtTime=(new Date).getTime(),(null===(s=null===(n=this._lastPickedResult)||void 0===n?void 0:n.pickedGNodes)||void 0===s?void 0:s.length)&&(null===(i=null==o?void 0:o.pickedGNodes)||void 0===i?void 0:i.length)&&this._lastPickedResult.pickedGNodes.length===o.pickedGNodes.length?o.pickedGNodes.some(((e,t)=>e!==this._lastPickedResult.pickedGNodes[t]))&&(this._hoverPickedGNodeTime=(new Date).getTime()):this._hoverPickedGNodeTime=(new Date).getTime(),this._lastPickedResult=o,this._lastPickedResult.point=o.point.clone(),o}}t.PickPointAction=l;t.PickObserver=class{constructor(e,t){this._movingCallBack=e,this._currentPos=s.math.Vector3.O(),this._pickFilter=t}movePoint(e,t){this._movingCallBack&&this._movingCallBack(e,t),this._currentPos=e.point}setClickCallback(e){this._clickCallBack=e}getClickCallback(){return this._clickCallBack}getPickFilter(){return this._pickFilter}setPickFilter(e){return this._pickFilter=e,this}get highlightPickedGNodes(){return this._highlightPickedGNodes}set highlightPickedGNodes(e){this._highlightPickedGNodes=e}}},50347:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PickUtil=void 0;const r=n(31667),s=n(79762);function i(e){return e.getType()===r.GNODE_TYPE.GNodeRef?i(e.getOriginGNode()):e.getType()===r.GNODE_TYPE.GPoint2d||e.getType()===r.GNODE_TYPE.GPoint3d?-1:e.getType()===r.GNODE_TYPE.GEdge||e.getType()===r.GNODE_TYPE.GCurves||e.getType()===r.GNODE_TYPE.GCurve2d||e.getType()===r.GNODE_TYPE.GCurve3d?0:e.getType()===r.GNODE_TYPE.GFace?1:100}t.PickUtil=class{static pickGNode(e,t,n,r,s){const[i,o]=this.pickGNodes(e,t,n,r,s);return[i[0],o]}static pickGNodes(e,t,n,s,o){let a,c;c=s?s*e.getCameraInfo().pixelToWorldScale:8*e.getCameraInfo().pixelToWorldScale;const l=e.getRenderPicker();if(l?(a=l.pick(t.x,t.y),a=o?a.filter((e=>e.canSnap)):a.filter((e=>e.canPick))):(r.DebugWarn.warn(!1,"pick gnodes not supported","",""),a=[]),!a.length)return[a,!1];if(n&&(a=a.filter((e=>n.isEnable(e,t)))),!a.length)return[a,!0];if(a.sort(((e,t)=>i(e)-i(t))),l)return[a,!0];const d=e.generateCameraRay(t),u=d.getPtAt(0),h=d.getDirection(),g=[];let f=[],p=1/0;for(const e of a){const t=e.intersected(u,c,h);if(t){let n=d.getParamAt(t);if(n<0)continue;e.getType()===r.GNODE_TYPE.GPoint3d&&(n=-1e3+n),n<p?(p=n,g.splice(0,g.length),g.push(e)):n===p&&g.push(e)}}return g.length>0&&(f=g),[f,!0]}static mouseIntersectGNode(e,t){const n=s.app.getCurrentView();if(r.DebugWarn.assert(n,"uiView为空","",""),t.getType()===r.GNODE_TYPE.GCurve2d){const r=n.screenToWorkPlaneUV(e);return t.geo.getProjectedPtBy(r)}if(t.getType()===r.GNODE_TYPE.GCurve3d){const r=n.screenToWorkPlane(e);return t.geo.getProjectedPtBy(r)}if(t.getType()===r.GNODE_TYPE.GEdge){const s=n.generateCameraRay(e).extendDouble(r.math.CONST.MODEL_MAX_LENGTH),i=new r.math.Vector3,o=new r.math.Vector3;return r.math.MathAlg.CalculateDistance.curve3dToCurve3d(s,t.geo.getCurve(),i,o),o}if(t.getType()===r.GNODE_TYPE.GFace||t.getType()===r.GNODE_TYPE.GSurface){const s=n.generateCameraRay(e).extendDouble(r.math.CONST.MODEL_MAX_LENGTH),i=t.geo.getSurface(),o=r.math.MathAlg.CalculateIntersect.curveSurface(s,i);let a,c=r.math.CONST.MODEL_MAX_LENGTH;for(const e of o){if(t.getType()===r.GNODE_TYPE.GFace&&!i.isPlane()&&!r.brep.alg.BrepPositionJudge.isPtInFace(e,t.geo))continue;const s=e.distanceTo(n.getCurrentCamera().position);s<c&&(c=s,a=e)}return a}const i=n.generateCameraRay(e),o=i.getPtAt(0),a=i.getDirection(),c=8*n.getCameraInfo().pixelToWorldScale;return t.intersected(o,c,a)}static pixelsPerUnitCreator(e,t){if(e.orthogonal){const n=t/(Math.abs(e.top-e.bottom)*e.pixelToWorldScale);return e=>n}const n=e.fov*Math.PI/180,r=t/(2*Math.tan(n/2));return e=>r/e}}},33680:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RunSnapUtil=void 0;const r=n(31667),s=n(31667),i=n(16088),o=n(98295),a=n(88123),c=n(24126),l=n(50347),d=n(66059);t.RunSnapUtil=class{static snapPoint(e,t,n,o){var c;const[d]=l.PickUtil.pickGNodes(n,e,o.getPickFilter(),void 0,!0);d.filter((e=>e.canSnap));const u=n.generateCameraRay(e);u.extendDouble(r.math.CONST.MODEL_MAX_LENGTH),t.snappableGNodes=d,t.snapRay=u,t.addSnapHelpers(s.EN_SNAP_HELPER_OBJECT.POINT,a.SnapHelperManager.getInstance().getAllSnapHelperPoints());const h=a.SnapHelperManager.getInstance().getAllSnapHelperCurves(),g=a.SnapHelperManager.getInstance().getAllSnapHelperDirs(),f=a.SnapHelperManager.getInstance().getAllSnapHelperPoints();t.setSnapHelpers(s.EN_SNAP_HELPER_OBJECT.CURVE,h),t.setSnapHelpers(s.EN_SNAP_HELPER_OBJECT.DIR,g),t.setSnapHelpers(s.EN_SNAP_HELPER_OBJECT.POINT,f);const p=l.PickUtil.pixelsPerUnitCreator(n.getCameraInfo(),n.getSize().y);s.SnapSetting.getInstance().setScaleAtDis((e=>1/p(e)));const _=s.SnapEngine.snap(t);if(_&&_.snapResults.length>0){this._drawSnapPrompt(_,n),o.highlightPickedGNodes&&r.HighLight.getInstance().reset(..._.snapResults[0].getSnappedGNodes());const t=new r.SnappeddEvent(_.snapResults[0].getSnappedGNodes());r.eventManager.dispatchEvent(t);const s=null===(c=_.snapResults[0].snappedPlane)||void 0===c?void 0:c.clone(),i={point:_.snapResults[0].snappedPt,screenPt:e,pickedPlane:s,pickedGNodes:_.snapResults[0].getSnappedGNodes(),snapType:_.snapResults[0].getSnapType()};return n.getDocument().updateView(),i}const m=new s.SnapCandidates,v={point:n.screenToWorkPlane(e),screenPt:e,pickedPlane:n.getWorkPlane().plane.clone(),pickedGNodes:[],snapType:s.EN_SNAP_TYPE.PointOnSnapPlane};m.addSnapResult(new s.PointSnap(s.EN_SNAP_TYPE.PointOnSnapPlane,v.point,0));return i.debounce((()=>{this._drawSnapPrompt(m,n),n.getDocument().updateView()}),16,{leading:!0})(),v}static _drawSnapPrompt(e,t){var n,i;const a=e.snapResults[0];if(a instanceof s.PointSnap){const e=new r.GRep;let l=c.EN_SNAP_POINT_COLOR.POINT_ON_FACE;switch(a.getSnapType()){case s.EN_SNAP_TYPE.Pole:case s.EN_SNAP_TYPE.EndPoint:l=c.EN_SNAP_POINT_COLOR.END_POINT;break;case s.EN_SNAP_TYPE.MiddlePoint:case s.EN_SNAP_TYPE.Center:l=c.EN_SNAP_POINT_COLOR.MIDDLE_POINT;break;case s.EN_SNAP_TYPE.ExtensionPoint:l=c.EN_SNAP_POINT_COLOR.PARALLEL_TO_AXIS;break;case s.EN_SNAP_TYPE.PointOnCurve:l=c.EN_SNAP_POINT_COLOR.POINT_ON_CURVE;break;case s.EN_SNAP_TYPE.ParallelToX:case s.EN_SNAP_TYPE.ParallelToY:case s.EN_SNAP_TYPE.ParallelToZ:case s.EN_SNAP_TYPE.ClosedLineParallelToX:case s.EN_SNAP_TYPE.ClosedLineParallelToY:case s.EN_SNAP_TYPE.ClosedLineParallelToZ:l=c.EN_SNAP_POINT_COLOR.PARALLEL_TO_AXIS;break;case s.EN_SNAP_TYPE.IntersectPoint:l=c.EN_SNAP_POINT_COLOR.INTERSECT_POINT;break;case s.EN_SNAP_TYPE.ReferCurve:d.drawSnapHelperPrompt(a,e),l=c.EN_SNAP_POINT_COLOR.POINT_ON_CURVE;break;case s.EN_SNAP_TYPE.PerpendicularPoint:case s.EN_SNAP_TYPE.ParallelToCurve:case s.EN_SNAP_TYPE.VerticalToCurve:d.drawSnapHelperPrompt(a,e),l=c.EN_SNAP_POINT_COLOR.VERTICAL_PARALLEL}if(a.anotherSnapType)switch(a.anotherSnapType){case s.EN_SNAP_TYPE.ReferCurve:case s.EN_SNAP_TYPE.ParallelToCurve:case s.EN_SNAP_TYPE.VerticalToCurve:d.drawSnapHelperPrompt(a,e)}const u=a.getSnapPrompt();e.addNode(u);const h=t.worldToScreen(a.snappedPt);null===(n=o.ActionManager.getInstance().getCurrentAction())||void 0===n||n.showMouseTip({tip:a.getSnapPromptString(),pos:h});const g={point:{size:8,color:l}};e.setStyle(g),e.canGpuPick=!1,null===(i=o.ActionManager.getInstance().getCurrentAction())||void 0===i||i.drawTmpGRep(e)}}}},66059:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.drawSnapHelperPrompt=t.createReferencePoint=t.createReferenceDirs=t.createReferenceCurves=void 0;const r=n(31667),s=n(31667),i=n(88123),o=n(24126),a=200;t.createReferenceCurves=function(e,t){var n;if(!s.SnapSetting.getInstance().canSnapHelperObject||!(null===(n=null==e?void 0:e.pickedGNodes)||void 0===n?void 0:n.length))return;const o=(new Date).getTime();if(e&&(e.snapType===s.EN_SNAP_TYPE.MiddlePoint||e.snapType===s.EN_SNAP_TYPE.EndPoint)&&o-t>a){const t=new r.math.Line3d(e.point,r.math.Vector3.X(),[-r.math.CONST.MODEL_MAX_LENGTH,r.math.CONST.MODEL_MAX_LENGTH]);t.userData={snapType:s.EN_SNAP_TYPE.ReferCurve,lastPickedPt:e.point.clone()};const n=new r.math.Line3d(e.point,r.math.Vector3.Y(),[-r.math.CONST.MODEL_MAX_LENGTH,r.math.CONST.MODEL_MAX_LENGTH]);n.userData={snapType:s.EN_SNAP_TYPE.ReferCurve,lastPickedPt:e.point.clone()};const o=new r.math.Line3d(e.point,r.math.Vector3.Z(),[-r.math.CONST.MODEL_MAX_LENGTH,r.math.CONST.MODEL_MAX_LENGTH]);o.userData={snapType:s.EN_SNAP_TYPE.ReferCurve,lastPickedPt:e.point.clone()},i.SnapHelperManager.getInstance().addSnapHelperCurves(i.EN_SNAP_HELPER_TYPE.BRIEF,[t,n,o])}},t.createReferenceDirs=function(e,t,n){var o;if(!s.SnapSetting.getInstance().canSnapHelperDir)return;const c=(new Date).getTime();if(e&&c-t>a&&1===(null===(o=e.pickedGNodes)||void 0===o?void 0:o.length)){const t=e.pickedGNodes[0];let o;if(t.getType()===r.GNODE_TYPE.GEdge||t.getType()===r.GNODE_TYPE.GCurve3d)o=t.getType()===r.GNODE_TYPE.GEdge?t.geo.getCurve():t.geo;else if(t.getType()===r.GNODE_TYPE.GNodeRef){const e=t.getCurve3ds(!0);1===e.length&&(o=e[0])}if(!o||!o.isLine3d())return;const a=o.getDirection().clone();if(a.userData={refCurve:o},i.SnapHelperManager.getInstance().addSnapHelperDirs(i.EN_SNAP_HELPER_TYPE.BRIEF,a),n){const e=new r.math.Vector3;if(r.math.MathAlg.CalculateDistance.pointToCurve3d(n,o,e),e.equals(n))return;const t=e.subtracted(n).normalize();if(!t.isPerpendicular(o.getDirection()))return;t.userData={refCurve:o,snapType:s.EN_SNAP_TYPE.VerticalToCurve},i.SnapHelperManager.getInstance().addSnapHelperDirs(i.EN_SNAP_HELPER_TYPE.BRIEF,t)}}},t.createReferencePoint=function(e,t){var n,o;const c=(new Date).getTime();if(e&&c-t>a&&1===(null===(n=e.pickedGNodes)||void 0===n?void 0:n.length)&&e.pickedGNodes[0].getType()===r.GNODE_TYPE.GFace){const n=e.pickedGNodes[0];if(!n.geo.getSurface().isPlane())return t;const r=n.geo.getCentroidPoint();return r.userData={snapType:s.EN_SNAP_TYPE.Center},i.SnapHelperManager.getInstance().addSnapHelperPoints(i.EN_SNAP_HELPER_TYPE.BRIEF,r),c}if(e&&c-t>a&&1===(null===(o=e.pickedGNodes)||void 0===o?void 0:o.length)&&e.pickedGNodes[0].getType()===r.GNODE_TYPE.GEdge){const n=e.pickedGNodes[0];if(!n.geo.getCurve().isArc3d())return t;return r.math.CurveUtil.getArc3dPoles(n.geo.getCurve()).forEach((e=>{e.userData={snapType:s.EN_SNAP_TYPE.Pole},i.SnapHelperManager.getInstance().addSnapHelperPoints(i.EN_SNAP_HELPER_TYPE.BRIEF,e)})),c}return t},t.drawSnapHelperPrompt=function(e,t){var n,i;if(e.getSnappedObjects().length)for(const a of e.getSnappedObjects())if(a.userData.snapType===s.EN_SNAP_TYPE.ReferCurve&&a.userData.lastPickedPt){const n=new r.math.Line3d(a.userData.lastPickedPt,e.snappedPt);let s=o.EN_SNAP_POINT_COLOR.PARALLEL_TO_AXIS;const i=n.getDirection();i.isParallel(r.math.Vector3.X())?s=16711680:i.isParallel(r.math.Vector3.Y())?s=65280:i.isParallel(r.math.Vector3.Z())&&(s=255),t.addCurve3d(n).setStyle({line:{dotted:!0,color:s,dashSize:6,gapSize:6}}),t.addPoint3d(a.userData.lastPickedPt).setStyle({point:{color:o.EN_SNAP_POINT_COLOR.PARALLEL_TO_AXIS}})}else a.isVector3()&&(null===(n=a.userData)||void 0===n?void 0:n.refCurve)&&t.addCurve3d(null===(i=a.userData)||void 0===i?void 0:i.refCurve).setStyle({line:{color:o.EN_SNAP_POINT_COLOR.VERTICAL_PARALLEL}})}},40555:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SelectWorkFaceCMD=void 0;const i=n(31667),o=n(88826),a=n(54636),c=n(5535),l=n(19180),d=n(30054);class u extends l.Action{run(){return s(this,void 0,void 0,(function*(){const e=new c.PickFilter;e.disallowAll(),e.allow(i.GNODE_TYPE.GFace);const t=new a.PickGNodeAction(e),n=yield this._runChildAction(t);if(n.isCanceled)return void this._markCanceled();const r=n.data.gnode;if(r){const e=r;this.getIView().setWorkPlane(e),this._markSuccess(void 0)}}))}getClassName(){return"SelectWorkFaceAction"}}let h=class extends d.Cmd{execute(e){return s(this,void 0,void 0,(function*(){yield this._runAction(new u)}))}};h=r([i.registerCmd(o.PlatformCmdIds.CMD_SELECT_WORK_FACE)],h),t.SelectWorkFaceCMD=h},58128:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ArrayCmd=t.ArrayAction=void 0;const i=n(31667),o=n(88826),a=n(96460),c=n(30054);class l extends a.DrawLinearElementAction{constructor(e,t){super(),this._arrayNum=e,this._moveTo=t}getClassName(){return"ArrayAction"}run(){const e=Object.create(null,{run:{get:()=>super.run}});return s(this,void 0,void 0,(function*(){if(this._ids=i.Selection.getInstance().getSelectedElementIds(),!this._ids.length)return this._markCanceled(),void this.toast("请先选择要拷贝的Element");yield e.run.call(this)}))}_onLineFinished(e,t){return s(this,void 0,void 0,(function*(){const n=this._ids.map((e=>this.getCurrentDoc().getElementById(e)));return yield i.transact(this.getCurrentDoc(),"",(()=>{const r=new i.math.Vector3(e.point,t.point).clone().multiply(1/(this._moveTo-1));n.forEach((e=>{for(let t=1;t<this._arrayNum;t++)this._cloneTranslateElement(e,r.multiply(t))}))})),!0}))}_cloneTranslateElement(e,t){e.clone().translate(t)}}t.ArrayAction=l;let d=class extends c.Cmd{clearSelection(){return!1}execute(e={arrayNum:3,moveTo:2}){return s(this,void 0,void 0,(function*(){i.DebugWarn.assert(e.arrayNum>1,"阵列个数至少两个","luting","2020-04-30"),i.DebugWarn.assert(e.moveTo>1&&e.moveTo<=e.arrayNum,"移动到的个数至少两个, 且不能大于阵列个数","luting","2020-04-30"),yield this._runAction(new l(e.arrayNum,e.moveTo))}))}};d=r([i.registerCmd(o.PlatformCmdIds.CMD_ARRAY_SELECTED_ELEMENTS)],d),t.ArrayCmd=d},55797:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CopyCmd=t.CopyAction=void 0;const i=n(31667),o=n(88826),a=n(96460),c=n(30054);class l extends a.DrawLinearElementAction{run(){const e=Object.create(null,{run:{get:()=>super.run}});return s(this,void 0,void 0,(function*(){if(this._ids=i.Selection.getInstance().getSelectedElementIds(),!this._ids.length)return this._markCanceled(),void this.toast("请先选择要拷贝的Element");yield e.run.call(this)}))}getClassName(){return"CopyAction"}_onLineFinished(e,t){return s(this,void 0,void 0,(function*(){const n=this._ids.map((e=>this.getCurrentDoc().getElementById(e)));return yield i.transact(this.getCurrentDoc(),"",(()=>{n.forEach((n=>{n.clone().translate(new i.math.Vector3(e.point,t.point))}))})),!0}))}}t.CopyAction=l;let d=class extends c.Cmd{clearSelection(){return!1}execute(){return s(this,void 0,void 0,(function*(){yield this._runAction(new l)}))}};d=r([i.registerCmd(o.PlatformCmdIds.CMD_COPY_SELECTED_ELEMENTS)],d),t.CopyCmd=d},51069:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.EditModeCancelCmd=void 0;const i=n(31667),o=n(92830),a=n(88826),c=n(30054);let l=class extends c.Cmd{execute(){return s(this,void 0,void 0,(function*(){yield o.EditorManager.getInstance().editModeCancle(),this.getCurrentDoc().updateView()}))}};l=r([i.registerCmd(a.PlatformCmdIds.CMD_EDIT_MODE_CANCLE)],l),t.EditModeCancelCmd=l},29875:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.EditModeOKCmd=void 0;const i=n(31667),o=n(30054),a=n(92830),c=n(88826);let l=class extends o.Cmd{execute(){return s(this,void 0,void 0,(function*(){yield a.EditorManager.getInstance().editModeOK()}))}};l=r([i.registerCmd(c.PlatformCmdIds.CMD_EDIT_MODE_OK)],l),t.EditModeOKCmd=l},38055:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.HideCmd=void 0;const i=n(31667),o=n(88826),a=n(30054);let c=class extends a.Cmd{clearSelection(){return!1}execute(){return s(this,void 0,void 0,(function*(){const e=i.Selection.getInstance().getSelectedElementIds();if(!e.length)return;const t=this.getCurrentDoc(),n=[];t.getElementsByIds(e).forEach((e=>{n.push(e.id)})),yield i.transact(t,"隐藏",(()=>{this._hideElementsById(...n)}))}))}_hideElementsById(...e){const t=this.getCurrentDoc().getElementsByIds(e);return!!t.length&&(t.forEach((e=>{e.visible=!1})),!0)}};c=r([i.registerCmd(o.PlatformCmdIds.CMD_HIDE_SELECTED_ELEMENTS)],c),t.HideCmd=c},92909:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RevealFromLocalCmd=t.LoadFileAction=void 0;const i=n(31667),o=n(88826),a=n(79762),c=n(49726),l=n(19180),d=n(30054),u=e=>s(void 0,void 0,void 0,(function*(){var t;i.DocumentManager.getInstance().closeDocument(null===(t=a.app.getMainDoc())||void 0===t?void 0:t.getUUID());const n=yield i.DocumentManager.getInstance().openDocument(e);if(!n)return;const r=a.app.getCurrentView();if(i.DebugWarn.assert(r,"CurrentView为空"," ","2020-04-21"),r){const e=a.app.getMainDoc().create(i.ModelView).modelViewInit();r.resetModelView(e)}n.updateView(),n.transactionMgr.clear()}));class h extends l.Action{constructor(e=!1){super(),this._isFamilyDoc=e}getClassName(){return"LoadFileAction"}run(){return s(this,void 0,void 0,(function*(){const e=new c.PickFileAction,t=yield this._runChildAction(e);if(t.isCanceled)return void this._markCanceled();const n=i.FileUtil.parse(t.data.data);return n?this._isFamilyDoc?this._isValidNestModule(t.data.data)?void this.markSuccess():(i.eventManager.dispatchEvent(new i.MessageEvent(i.EN_EVENT_TYPE.MESSAGE_ERROR,"不能重复加载自身!")),void this.markCanceled()):(yield u(n),void this.markSuccess()):void 0}))}_isValidNestModule(e){const t=this.getCurrentDoc();return-1===e.indexOf(t.getUUID())}}t.LoadFileAction=h;let g=class extends d.Cmd{execute(e){return s(this,void 0,void 0,(function*(){if("boolean"==typeof e||void 0===e){if(e)yield this._runAction(new h);else if("string"==typeof e){const t=e;yield this._loadFileByUrl(t)}else yield this._openFromStorage()}else{const t=e;yield this._loadFile(t)}}))}_openFromStorage(){return s(this,void 0,void 0,(function*(){let e;if(e=window.localStorage.getItem("tp"),!e)return;const t=i.FileUtil.parse(e);t&&(yield u(t))}))}_loadFile(e){return s(this,void 0,void 0,(function*(){const{data:t}=e,n=i.FileUtil.parse(t);n&&(yield u(n))}))}_loadFileByUrl(e){return s(this,void 0,void 0,(function*(){let t=!1;const n=yield i.axios({method:"get",url:e,responseType:"json"}).catch((e=>{t=!0}));if(t||!n)throw new Error("error");if(-1!==n.data.er)throw Error(n.data);const r=i.JsonUtil.unpack(n.data.item);yield this._loadFile(r)}))}};g=r([i.registerCmd(o.PlatformCmdIds.CMD_OPEN_FILE)],g),t.RevealFromLocalCmd=g},55788:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ReplayFromLocalCmd=t.getUrlParamAsNumber=t.getUrlParam=void 0;const i=n(31667),o=n(88826),a=n(49726),c=n(19180),l=n(30054),d=n(36005),u=n(19211);function h(e){const t=new RegExp(`(^|&)${e}=([^&]*)(&|$)`),n=window.location.search.substr(1).match(t);if(null!=n)return unescape(n[2])}t.getUrlParam=h,t.getUrlParamAsNumber=function(e){const t=h(e);if(t)try{const e=Number.parseInt(t,10);if(!Number.isNaN(e)&&e>0)return e}catch(e){}return-1};class g extends c.Action{getClassName(){return"LoadRecordsFromDiskAction"}run(){return s(this,void 0,void 0,(function*(){const e=new a.PickFileAction,t=yield this._runChildAction(e);if(!t||t.isCanceled)return void this._markCanceled();const n=JSON.parse(t.data.data);n&&n.length&&((new d.LogReplayer).replay(this.getCurrentDoc(),"磁盘脚本",n),this._markSuccess())}))}}class f extends c.Action{constructor(e){super(),this._logURL=e}getClassName(){return"LoadRecordsFromNetAction"}run(){return s(this,void 0,void 0,(function*(){const e=new u.LoadResourceAction("get",this._logURL,"json"),t=yield this._runChildAction(e);if(!t||t.isCanceled)return void this._markCanceled();const n=t.data.data;(new d.LogReplayer).replay(this.getCurrentDoc(),this._logURL,n),this._markSuccess()}))}}let p=class extends l.Cmd{execute(e){return s(this,void 0,void 0,(function*(){const t=h("log.url");"localStorage"!==(null==e?void 0:e.logURL)&&"localStorage"!==t?"disk"!==(null==e?void 0:e.logURL)?t&&this._runAction(new f(t.replace(/___/g,"/"))):yield this._runAction(new g):this._openFromStorage()}))}_openFromStorage(){return s(this,void 0,void 0,(function*(){let e;if(e=window.localStorage.getItem("log"),!e)return;const t=JSON.parse(e);yield(new d.LogReplayer).replay(this.getCurrentDoc(),"localStorage",t)}))}};p=r([i.registerCmd(o.PlatformCmdIds.CMD_REPLAY_RECORDS)],p),t.ReplayFromLocalCmd=p},96579:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t},a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SaveFileToLocalCmd=void 0;const c=o(n(18588)),l=n(31667),d=n(88826),u=n(30054);let h=class extends u.Cmd{execute(e=!1){return a(this,void 0,void 0,(function*(){const t=this.getCurrentDoc().save();e?this._saveFileToDisk(t):this._saveFileToStorage(t)}))}_saveFileToStorage(e){const t=window.localStorage,n=l.JsonUtil.pack(e);t.setItem("tp",n)}_saveFileToDisk(e){const t=JSON.stringify(e),n=`pm-${(new Date).toUTCString()}.json`,r=new Blob([t],{type:`text/plain;charset=${document.characterSet}`});c.saveAs(r,n)}};h=i([l.registerCmd(d.PlatformCmdIds.CMD_SAVE_FILE_TO_LOCAL)],h),t.SaveFileToLocalCmd=h},37873:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t},a=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ReplayFromLocalCmd=void 0;const c=n(31667),l=o(n(18588)),d=n(88826),u=n(30054);let h=class extends u.Cmd{clearSelection(){return!1}execute(){return a(this,void 0,void 0,(function*(){const e=JSON.stringify(this.getIApp().logRecorder.dump()),t=`log-${(new Date).toUTCString()}.json`,n=new Blob([e],{type:`text/plain;charset=${document.characterSet}`});l.saveAs(n,t)}))}};h=i([c.registerCmd(d.PlatformCmdIds.CMD_SAVE_RECORDS_TO_LOCAL)],h),t.ReplayFromLocalCmd=h},99801:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ShowAllHiddenCmd=void 0;const i=n(31667),o=n(88826),a=n(30054);let c=class extends a.Cmd{clearSelection(){return!1}execute(){return s(this,void 0,void 0,(function*(){const e=this.getCurrentDoc();yield i.transact(e,"显示所有隐藏",(()=>{this._showAllHiddenElements()}))}))}_showAllHiddenElements(){this.getCurrentDoc().filterElements((e=>!e.visible)).forEach((e=>{e.visible=!0}))}};c=r([i.registerCmd(o.PlatformCmdIds.CMD_SHOW_HIDDEN_ELEMENTS)],c),t.ShowAllHiddenCmd=c},65470:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.TranslateCmd=t.TranslateAction=void 0;const i=n(31667),o=n(88826),a=n(96460),c=n(30054);class l extends a.DrawLinearElementAction{run(){const e=Object.create(null,{run:{get:()=>super.run}});return s(this,void 0,void 0,(function*(){if(this._ids=i.Selection.getInstance().getSelectedElementIds(),!this._ids.length)return this._markCanceled(),void this.toast("请先选择要拷贝的Element");yield e.run.call(this)}))}getClassName(){return"TranslateAction"}_onLineFinished(e,t){return s(this,void 0,void 0,(function*(){const n=this._ids.map((e=>this.getCurrentDoc().getElementById(e)));return yield i.transact(this.getCurrentDoc(),"",(()=>{n.forEach((n=>{n.translate(new i.math.Vector3(e.point,t.point))}))})),!0}))}}t.TranslateAction=l;let d=class extends c.Cmd{clearSelection(){return!1}execute(){return s(this,void 0,void 0,(function*(){yield this._runAction(new l)}))}};d=r([i.registerCmd(o.PlatformCmdIds.CMD_TRANSLATE_SELECTED_ELEMENTS)],d),t.TranslateCmd=d},18271:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ZoomWindowCmd=void 0;const i=n(31667),o=n(88826),a=n(30054),c=n(99878),l=n(82658),d=n(91428);class u extends c.DrawRectElementAction{getClassName(){return"ZoomWindowAction"}onActionCancelled(){this.clearTmp(),this._updateView()}_movePt(e,t){const n=new i.GRep;this._getRect3dOnScreen(e.screenPt,t.screenPt).forEach((e=>{n.addCurve3d(e)})),this._drawTmpGRep(n,l.appConfig.common.default_style_rect_model_line),this._updateView()}_getRect3dOnScreen(e,t){const n=this.getIView().generateCameraRay(t.added(e).multiply(.5)),r=new i.math.Plane(this.getIView().getCameraInfo().position,n.getDirection()),s=i.math.Loop.createByRectangle(t,e).toPath().map((e=>this.getIView().screenToWorldPlane(e,r)));return s.map(((e,t)=>new i.math.Line3d(e,s[(t+1)%s.length])))}_onRectFinished(e,t){return s(this,void 0,void 0,(function*(){const n=new i.math.Box2([e.screenPt,t.screenPt]);return d.zoomWindow(this.getIView(),n),!0}))}}let h=class extends a.Cmd{execute(){return s(this,void 0,void 0,(function*(){yield this._runAction(new u)}))}};h=r([i.registerCmd(o.PlatformCmdIds.CMD_ZOOM_WINDOW)],h),t.ZoomWindowCmd=h},88826:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlatformCmdIds=void 0;class n{}t.PlatformCmdIds=n,n.CMD_HIDE_SELECTED_ELEMENTS="cmd.hide.selected.elements",n.CMD_COPY_SELECTED_ELEMENTS="cmd.copy.selected.elements",n.CMD_SHOW_HIDDEN_ELEMENTS="cmd.show.hidden.elements",n.CMD_ZOOM_WINDOW="platform.cmd.zoom.window",n.CMD_TRANSLATE_SELECTED_ELEMENTS="cmd.translate.selected.elements",n.CMD_ARRAY_SELECTED_ELEMENTS="cmd.array.selected.elements",n.CMD_SAVE_FILE_TO_LOCAL="cmd.save.file.to.local",n.CMD_OPEN_FILE="cmd.open.file",n.CMD_EDIT_MODE_OK="cmd.edit_mode.ok",n.CMD_EDIT_MODE_CANCLE="cmd.edit_mode.cancle",n.CMD_SELECT_WORK_FACE="cmd.select_work_face",n.CMD_REPLAY_RECORDS="cmd.replay.records",n.CMD_SAVE_RECORDS_TO_LOCAL="cmd.save.records.to.lacal"},69821:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Editor=void 0;const s=n(31667);t.Editor=class{constructor(e,t){this._buttonShownInUI=new Map,this._doc=e,this._transactionGroup=new s.TransactionGroup(e,this.getEditorName()),this._edittingElement=e.getElementById(t)}getEditingElement(){return this._edittingElement}onEnter(){return r(this,void 0,void 0,(function*(){return!0}))}onSave(){return r(this,void 0,void 0,(function*(){return this._transactionGroup.assimilate(),!0}))}onValidate(){return r(this,void 0,void 0,(function*(){return{valid:!0}}))}onCancel(){return r(this,void 0,void 0,(function*(){this._rollBack()}))}getButtonsShownInUI(){return[...this._buttonShownInUI.values()]}addButtonShownInUI(...e){e.forEach((e=>this._buttonShownInUI.set(e.cmd,e)))}getDocument(){return this._doc}_rollBack(){this._transactionGroup.rollBack(),this._doc.updateView()}}},92830:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.EditorManager=void 0;const s=n(31667),i=n(98295),o=Symbol("success"),a=Symbol("cancle");class c{constructor(){this._editorStack=[]}static getInstance(){return this.instance||(this.instance=new c),this.instance}get editor(){if(this._currentEditor)return this._currentEditor}getEditorStack(){return[...this._editorStack]}hasNestedEditor(){return this._editorStack.length>1}enterEditMode(e,t,n){return r(this,void 0,void 0,(function*(){if(!(yield e.onEnter()))return!1;this._editorStack.push(e),this._currentEditor=e,this._currentEditor[o]=t,this._currentEditor[a]=n;const r=new s.MessageEvent(s.EN_EVENT_TYPE.MESSAGE_EDIT_MODE_ENTER,"");return s.eventManager.dispatchEvent(r),!0}))}editModeOK(){var e;return r(this,void 0,void 0,(function*(){if(!this._currentEditor)return void s.DebugWarn.warn(!1,"no edit mode callback command found","","2020-04-13");const t=yield this._currentEditor.onValidate();if(!0===t.valid){if(yield this._currentEditor.onSave()){const t=this._currentEditor._transactionGroup;s.DebugWarn.assert("committed"===t.getStatus()||"rolled_back"===t.getStatus(),"请调用父类的onSave以提交事务组"," ","2021-07-19");const n=this._currentEditor;return this._popEditor(),void(null===(e=n[o])||void 0===e||e.call(n))}}s.eventManager.dispatchEvent(new s.MessageEvent(s.EN_EVENT_TYPE.MESSAGE_NOTICE,`${t.msg||"退出失败"}`))}))}editModeCancle(){var e;return r(this,void 0,void 0,(function*(){if(this._currentEditor){yield this._currentEditor.onCancel();const t=this._currentEditor;this._popEditor(),null===(e=t[a])||void 0===e||e.call(t)}}))}_popEditor(){i.ActionManager.getInstance().resetAllActions(),this._editorStack.pop(),this._editorStack.length?this._currentEditor=this._editorStack[this._editorStack.length-1]:delete this._currentEditor;const e=new s.MessageEvent(s.EN_EVENT_TYPE.MESSAGE_EDIT_MODE_EXIT,"");s.eventManager.dispatchEvent(e)}}t.EditorManager=c},4550:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(69127),n(40555),n(55797),n(55788),n(37873),n(51069),n(29875),n(38055),n(92909),n(96579),n(99801),n(65470),n(58128),n(18271)},68605:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleEditor=void 0;const r=n(69821);class s extends r.Editor{constructor(e,t,n){super(e,t),this._name="编辑模式",this._name=n}getEditorName(){return this._name}}t.SimpleEditor=s},1305:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Toast=void 0;const r=n(31667);t.Toast=class{static toast(e){r.eventManager.dispatchEvent(new r.MessageEvent(r.EN_EVENT_TYPE.MESSAGE_TOAST,e))}static info(e){r.eventManager.dispatchEvent(new r.MessageEvent(r.EN_EVENT_TYPE.MESSAGE_NOTICE,e))}static error(e){r.eventManager.dispatchEvent(new r.MessageEvent(r.EN_EVENT_TYPE.MESSAGE_ERROR,e))}}},97285:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.categoryGripElement=t.CategoryGripElement=void 0;const r=n(31667);class s extends r.Category{constructor(){super(...arguments),this._defaultStyle={point:{color:8942}}}getRenderArea(){return r.EN_RENDER_AREA.OVERLAY}}t.CategoryGripElement=s,t.categoryGripElement=new s},61982:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DBGrip=void 0;const r=n(31667);class s extends r.DBElement{constructor(){super(...arguments),this.masterIds=[r.ElementId.INVALID],this.pos=r.math.Vector3.O(),this.index=0}}t.DBGrip=s},23269:function(e,t,n){"use strict";var r=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.GripElement=void 0;const s=n(31667),i=n(97285),o=n(61982);let a=class extends s.Element{get category(){return this._customized&&this._customized.category!==s.categoryInvalid?this._customized.category:i.categoryGripElement}init(e,t,n,r){return this._db.masterIds=e,this._db.index=t,this.gripCallbacks=n,r&&(this._customized=r,this._customized.init(this.getDoc(),this.id)),this}getCustomized(){return this._customized}setCustomized(e){this._customized=e}getPosition(){return this._db.pos}updatePosition(){const e=this.getMasters();if(!e.length)return;const t=this.gripCallbacks.calcGripsPos(e,[this.getIndex()]);1===t.length&&this.setPostion(t[0])}setPostion(e){return!this._db.pos.equals(e)&&(this._db.pos=new s.math.Vector3(e),this.regenerateGRep(),!0)}getMaster(){return this.getDoc().getElementById(this._db.masterIds[0])}getMasters(){return this.getDoc().getElementsByIds(this._db.masterIds)}getIndex(){return this._db.index}isTemporary(){return!0}canBeMoved(){return!0}translate(e){const t=this._db.pos.added(e);return this.setPostion(t),this.gripCallbacks.moveCallBack&&this.gripCallbacks.moveCallBack(this,t),!0}regenerateGRep(){if(this._customized){const e=this._customized.regenerateGRep();if(!e.isEmpty())return void this.setGRep(e)}const e=new s.GRep;e.addPoint3d(this._db.pos),this.setGRep(e)}getGNodesWhenSelected(){const e=[];return this.getGRep().children.forEach((t=>{if(t.getType()===s.GNODE_TYPE.GPoint3d)e.push(t.toRenderNode());else if(t.getType()===s.GNODE_TYPE.GCurve3d)e.push(new s.GCurves([t.geo]));else if(t.getType()===s.GNODE_TYPE.GFace){const n=t.toRenderNodeForActive();e.push(n)}})),e}};a=r([s.elementMeta("61836214-eb75-4012-9905-6ee5bc29b78f",o.DBGrip,!1)],a),t.GripElement=a},51918:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GripHelper=void 0;const r=n(31667),s=n(23269),i=n(97285);class o{static generate(e,t){const n=e.filter((e=>e.category!==i.categoryGripElement));if(!n.length)return[];this.clear(n[0].getDoc());const r=t||this._serialIdToCreator.get(n[0].getSerialId());if(!r)return[];let o=[];if(r.calcGripsPos){if(o=r.calcGripsPos(n).map(((e,t)=>n[0].getDoc().create(s.GripElement).init(n.map((e=>e.id)),t,r))),r.registerGripCustomized){const e=r.registerGripCustomized(o);o.forEach(((t,n)=>{e[n]&&t.setCustomized(e[n])}))}o.forEach((e=>e.updatePosition()))}return o}static update(e,t){let n=e.getAllElementsByCtor(s.GripElement);t&&(n=n.filter((e=>!e.id.equals(t)))),n.forEach((e=>e.updatePosition()))}static clear(e){const t=e.getAllElementsByCtor(s.GripElement).map((e=>e.id));e.deleteElementsById(...t)}static register(e,t){const n=r.getElementSerialId(e);r.DebugWarn.assert(n,`${e.name}没有加注解?`," ","2021-05-07"),this._serialIdToCreator.set(n,t)}}t.GripHelper=o,o._serialIdToCreator=new Map},16088:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorkPlane=t.Camera=t.Transaction=t.JsonData=t.PropertyId=t.RayToCurve3dDistance=t.categoryModelLine=t.EN_CATEGORY_IDS=t.Category=t.EventManager=t.SimpleEditor=t.Editor=t.GRep=t.GText3d=t.GGroup3d=t.GCurve3d=t.GCurve2d=t.GPoint3d=t.GPoint2d=t.GGeoNode2d=t.GNode3d=t.GNode=t.EN_EVENT_TYPE=t.DebugWarn=t.UniqueElementUtil=t.TmpElement=t.ModelCmdIds=t.ElementId=t.elementMeta=t.Element=t.PickUtil=t.PickFilter=t.DrawArcFaceActionByThreePts=t.DrawLineAction=t.PickObserver=t.PickPointAction=t.PickFileAction=t.PickGNodeAction=t.PickElementsAction=t.PickElementAction=t.DrawRectElementAction=t.DrawLinearElementAction=t.LoadFileAction=t.PlatformCmdIds=t.Toast=t.ActionManager=t.throttle=t.debounce=t.createIRender=t.FileSaver=void 0,t.RunSnapUtil=t.getColorAccordingToDir=t.EN_RECORD_TYPE=t.ViewCube=t.EN_SNAP_HELPER_TYPE=t.SnapHelperManager=t.EN_OS_TYPE=t.getOSType=t.EN_MOUSE_EVENT_TYPE=t.platformEventMgr=t.EN_PLATFORM_EVENT_TYPE=t.BaseRecord=t.RecordLoader=t.clonePickedResult=t.getPickedPlane=t.LogReplayer=t.LogRecorder=t.takeSceenshotToDataUrl=t.takeSceenshot=t.zoomWindow=t.zoomExtentsWithoutRotation=t.FnKey=t.EN_KEYBOARD_EVENT_TYPE=t.Cmd=t.IElementDragStrategy=t.MouseCallbackToDrag=t.MouseCallbackToSelect=t.MouseCallbackToHighLight=t.IActionMouseCallbackToHighlight=t.IActionMouseCallbackToSelect=t.IActionMouseCallback=t.CompoundAction=t.ActionResult=t.Action=t.eventManager=t.HotkeyManager=t.EventManagerGeneric=t.CalculatorMgr=t.categoryGripElement=t.GripElement=t.GripHelper=t.appConfig=t.app=t.DBElement=t.EditorManager=t.transact=void 0;const a=i(n(18588));t.FileSaver=a;const c=n(31667);Object.defineProperty(t,"transact",{enumerable:!0,get:function(){return c.transact}}),Object.defineProperty(t,"WorkPlane",{enumerable:!0,get:function(){return c.WorkPlane}}),Object.defineProperty(t,"DBElement",{enumerable:!0,get:function(){return c.DBElement}});const l=o(n(14186));t.debounce=l.default;const d=o(n(96362));t.throttle=d.default;const u=n(79773);Object.defineProperty(t,"Camera",{enumerable:!0,get:function(){return u.ApiCamera}}),n(4550),n(97030);var h=n(9771);Object.defineProperty(t,"createIRender",{enumerable:!0,get:function(){return h.createIRender}});var g=n(98295);Object.defineProperty(t,"ActionManager",{enumerable:!0,get:function(){return g.ActionManager}});var f=n(1305);Object.defineProperty(t,"Toast",{enumerable:!0,get:function(){return f.Toast}});var p=n(88826);Object.defineProperty(t,"PlatformCmdIds",{enumerable:!0,get:function(){return p.PlatformCmdIds}});var _=n(92909);Object.defineProperty(t,"LoadFileAction",{enumerable:!0,get:function(){return _.LoadFileAction}});var m=n(96460);Object.defineProperty(t,"DrawLinearElementAction",{enumerable:!0,get:function(){return m.DrawLinearElementAction}});var v=n(99878);Object.defineProperty(t,"DrawRectElementAction",{enumerable:!0,get:function(){return v.DrawRectElementAction}});var E=n(89511);Object.defineProperty(t,"PickElementAction",{enumerable:!0,get:function(){return E.PickElementAction}});var P=n(3230);Object.defineProperty(t,"PickElementsAction",{enumerable:!0,get:function(){return P.PickElementsAction}});var y=n(54636);Object.defineProperty(t,"PickGNodeAction",{enumerable:!0,get:function(){return y.PickGNodeAction}});var C=n(49726);Object.defineProperty(t,"PickFileAction",{enumerable:!0,get:function(){return C.PickFileAction}});var S=n(72686);Object.defineProperty(t,"PickPointAction",{enumerable:!0,get:function(){return S.PickPointAction}}),Object.defineProperty(t,"PickObserver",{enumerable:!0,get:function(){return S.PickObserver}});var T=n(85522);Object.defineProperty(t,"DrawLineAction",{enumerable:!0,get:function(){return T.DrawLineAction}});var b=n(80588);Object.defineProperty(t,"DrawArcFaceActionByThreePts",{enumerable:!0,get:function(){return b.DrawArcFaceActionByThreePts}});var w=n(5535);Object.defineProperty(t,"PickFilter",{enumerable:!0,get:function(){return w.PickFilter}});var x=n(50347);Object.defineProperty(t,"PickUtil",{enumerable:!0,get:function(){return x.PickUtil}});var M=n(31667);Object.defineProperty(t,"Element",{enumerable:!0,get:function(){return M.Element}}),Object.defineProperty(t,"elementMeta",{enumerable:!0,get:function(){return M.elementMeta}}),Object.defineProperty(t,"ElementId",{enumerable:!0,get:function(){return M.ElementId}});var N=n(31667);Object.defineProperty(t,"ModelCmdIds",{enumerable:!0,get:function(){return N.ModelCmdIds}});var A=n(31667);Object.defineProperty(t,"TmpElement",{enumerable:!0,get:function(){return A.TmpElement}});var O=n(31667);Object.defineProperty(t,"UniqueElementUtil",{enumerable:!0,get:function(){return O.UniqueElementUtil}});var I=n(31667);Object.defineProperty(t,"DebugWarn",{enumerable:!0,get:function(){return I.DebugWarn}});var D=n(31667);Object.defineProperty(t,"EN_EVENT_TYPE",{enumerable:!0,get:function(){return D.EN_EVENT_TYPE}});var L=n(31667);Object.defineProperty(t,"GNode",{enumerable:!0,get:function(){return L.GNode}}),Object.defineProperty(t,"GNode3d",{enumerable:!0,get:function(){return L.GNode3d}}),Object.defineProperty(t,"GGeoNode2d",{enumerable:!0,get:function(){return L.GGeoNode2d}}),Object.defineProperty(t,"GPoint2d",{enumerable:!0,get:function(){return L.GPoint2d}}),Object.defineProperty(t,"GPoint3d",{enumerable:!0,get:function(){return L.GPoint3d}}),Object.defineProperty(t,"GCurve2d",{enumerable:!0,get:function(){return L.GCurve2d}}),Object.defineProperty(t,"GCurve3d",{enumerable:!0,get:function(){return L.GCurve3d}}),Object.defineProperty(t,"GGroup3d",{enumerable:!0,get:function(){return L.GGroup3d}}),Object.defineProperty(t,"GText3d",{enumerable:!0,get:function(){return L.GText3d}}),Object.defineProperty(t,"GRep",{enumerable:!0,get:function(){return L.GRep}});var V=n(69821);Object.defineProperty(t,"Editor",{enumerable:!0,get:function(){return V.Editor}});var R=n(68605);Object.defineProperty(t,"SimpleEditor",{enumerable:!0,get:function(){return R.SimpleEditor}});var U=n(31667);Object.defineProperty(t,"EventManager",{enumerable:!0,get:function(){return U.EventManager}});var B=n(31667);Object.defineProperty(t,"Category",{enumerable:!0,get:function(){return B.Category}});var F=n(31667);Object.defineProperty(t,"EN_CATEGORY_IDS",{enumerable:!0,get:function(){return F.EN_CATEGORY_IDS}});var k=n(31667);Object.defineProperty(t,"categoryModelLine",{enumerable:!0,get:function(){return k.categoryModelLine}});var G=n(31667);Object.defineProperty(t,"RayToCurve3dDistance",{enumerable:!0,get:function(){return G.RayToCurve3dDistance}});var j=n(31667);Object.defineProperty(t,"PropertyId",{enumerable:!0,get:function(){return j.PropertyId}});var z=n(31667);Object.defineProperty(t,"JsonData",{enumerable:!0,get:function(){return z.JsonData}});var W=n(31667);Object.defineProperty(t,"Transaction",{enumerable:!0,get:function(){return W.Transaction}});var q=n(92830);Object.defineProperty(t,"EditorManager",{enumerable:!0,get:function(){return q.EditorManager}});var H=n(79762);Object.defineProperty(t,"app",{enumerable:!0,get:function(){return H.app}});var Y=n(82658);Object.defineProperty(t,"appConfig",{enumerable:!0,get:function(){return Y.appConfig}});var X=n(51918);Object.defineProperty(t,"GripHelper",{enumerable:!0,get:function(){return X.GripHelper}});var J=n(23269);Object.defineProperty(t,"GripElement",{enumerable:!0,get:function(){return J.GripElement}});var K=n(97285);Object.defineProperty(t,"categoryGripElement",{enumerable:!0,get:function(){return K.categoryGripElement}});var Z=n(31667);Object.defineProperty(t,"CalculatorMgr",{enumerable:!0,get:function(){return Z.CalculatorMgr}});var $=n(31667);Object.defineProperty(t,"EventManagerGeneric",{enumerable:!0,get:function(){return $.EventManagerGeneric}});var Q=n(47290);Object.defineProperty(t,"HotkeyManager",{enumerable:!0,get:function(){return Q.HotkeyManager}});var ee=n(31667);Object.defineProperty(t,"eventManager",{enumerable:!0,get:function(){return ee.eventManager}});var te=n(19180);Object.defineProperty(t,"Action",{enumerable:!0,get:function(){return te.Action}}),Object.defineProperty(t,"ActionResult",{enumerable:!0,get:function(){return te.ActionResult}});var ne=n(57491);Object.defineProperty(t,"CompoundAction",{enumerable:!0,get:function(){return ne.CompoundAction}});var re=n(10196);Object.defineProperty(t,"IActionMouseCallback",{enumerable:!0,get:function(){return re.IActionMouseCallback}}),Object.defineProperty(t,"IActionMouseCallbackToSelect",{enumerable:!0,get:function(){return re.IActionMouseCallbackToSelect}}),Object.defineProperty(t,"IActionMouseCallbackToHighlight",{enumerable:!0,get:function(){return re.IActionMouseCallbackToHighlight}});var se=n(4196);Object.defineProperty(t,"MouseCallbackToHighLight",{enumerable:!0,get:function(){return se.MouseCallbackToHighLight}});var ie=n(87219);Object.defineProperty(t,"MouseCallbackToSelect",{enumerable:!0,get:function(){return ie.MouseCallbackToSelect}});var oe=n(3376);Object.defineProperty(t,"MouseCallbackToDrag",{enumerable:!0,get:function(){return oe.MouseCallbackToDrag}});var ae=n(92429);Object.defineProperty(t,"IElementDragStrategy",{enumerable:!0,get:function(){return ae.IElementDragStrategy}});var ce=n(30054);Object.defineProperty(t,"Cmd",{enumerable:!0,get:function(){return ce.Cmd}});var le=n(16724);Object.defineProperty(t,"EN_KEYBOARD_EVENT_TYPE",{enumerable:!0,get:function(){return le.EN_KEYBOARD_EVENT_TYPE}});var de=n(24878);Object.defineProperty(t,"FnKey",{enumerable:!0,get:function(){return de.FnKey}});var ue=n(91428);Object.defineProperty(t,"zoomExtentsWithoutRotation",{enumerable:!0,get:function(){return ue.zoomExtentsWithoutRotation}}),Object.defineProperty(t,"zoomWindow",{enumerable:!0,get:function(){return ue.zoomWindow}});var he=n(55426);Object.defineProperty(t,"takeSceenshot",{enumerable:!0,get:function(){return he.takeSceenshot}}),Object.defineProperty(t,"takeSceenshotToDataUrl",{enumerable:!0,get:function(){return he.takeSceenshotToDataUrl}});var ge=n(39778);Object.defineProperty(t,"LogRecorder",{enumerable:!0,get:function(){return ge.LogRecorder}});var fe=n(36005);Object.defineProperty(t,"LogReplayer",{enumerable:!0,get:function(){return fe.LogReplayer}});var pe=n(24126);Object.defineProperty(t,"getPickedPlane",{enumerable:!0,get:function(){return pe.getPickedPlane}}),Object.defineProperty(t,"clonePickedResult",{enumerable:!0,get:function(){return pe.clonePickedResult}});var _e=n(74216);Object.defineProperty(t,"RecordLoader",{enumerable:!0,get:function(){return _e.RecordLoader}});var me=n(77314);Object.defineProperty(t,"BaseRecord",{enumerable:!0,get:function(){return me.BaseRecord}});var ve=n(70768);Object.defineProperty(t,"EN_PLATFORM_EVENT_TYPE",{enumerable:!0,get:function(){return ve.EN_PLATFORM_EVENT_TYPE}}),Object.defineProperty(t,"platformEventMgr",{enumerable:!0,get:function(){return ve.platformEventMgr}});var Ee=n(16724);Object.defineProperty(t,"EN_MOUSE_EVENT_TYPE",{enumerable:!0,get:function(){return Ee.EN_MOUSE_EVENT_TYPE}});var Pe=n(58658);Object.defineProperty(t,"getOSType",{enumerable:!0,get:function(){return Pe.getOSType}}),Object.defineProperty(t,"EN_OS_TYPE",{enumerable:!0,get:function(){return Pe.EN_OS_TYPE}});var ye=n(88123);Object.defineProperty(t,"SnapHelperManager",{enumerable:!0,get:function(){return ye.SnapHelperManager}}),Object.defineProperty(t,"EN_SNAP_HELPER_TYPE",{enumerable:!0,get:function(){return ye.EN_SNAP_HELPER_TYPE}});var Ce=n(51807);Object.defineProperty(t,"ViewCube",{enumerable:!0,get:function(){return Ce.ViewCube}});var Se=n(62452);Object.defineProperty(t,"EN_RECORD_TYPE",{enumerable:!0,get:function(){return Se.EN_RECORD_TYPE}});var Te=n(84535);Object.defineProperty(t,"getColorAccordingToDir",{enumerable:!0,get:function(){return Te.getColorAccordingToDir}});var be=n(33680);Object.defineProperty(t,"RunSnapUtil",{enumerable:!0,get:function(){return be.RunSnapUtil}})},27261:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NullRender=void 0;const r=n(31667);class s extends r.IRender{createScene(){}clearScene(){}createRenderArea(e){}addGrep(e){}drawSelections(e){}drawActives(e){}clearRenderArea(e){}removeObject(e){return!1}requestTmpElement(){return r.ElementId.INVALID}setCanRotate(e){}updateView(){}destroy(){}onResize(e,t){}getActiveCameraInfo(){return new r.CameraInfo}getBase64Png(e){return""}_updateViewWithRenderFeature(){}}t.NullRender=s},70634:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.DecryptLambertMaterial=void 0;const o=i(n(78406)),a=o.ShaderLib.lambert,c=["uniform vec3 diffuse;","uniform vec3 emissive;","uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","    varying vec3 vLightBack;","#endif","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <bsdfs>","#include <lights_pars_begin>","#include <fog_pars_fragment>","#include <shadowmap_pars_fragment>","#include <shadowmask_pars_fragment>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","varying highp vec3 vWorldPosition;","vec3 inputToLinear( in vec3 a ) {","\t#ifdef GAMMA_INPUT","return pow( a, vec3( float( GAMMA_FACTOR ) ) );","#else","return a;","#endif","}","void main() {","    #include <clipping_planes_fragment>","    vec4 diffuseColor = vec4( diffuse, opacity );","    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","    vec3 totalEmissiveRadiance = emissive;","    #include <logdepthbuf_fragment>","#ifdef USE_MAP","vec4 texelColor = texture2D( map, vUv );","texelColor.brg = texelColor.rgb;","texelColor.r = 1.0 - texelColor.r;","texelColor.g = 1.0 - texelColor.g;","texelColor.b = 1.0 - texelColor.b;","texelColor.xyz = inputToLinear( texelColor.xyz );","diffuseColor *= texelColor;","#endif","    #include <color_fragment>","    #include <alphamap_fragment>","    #include <alphatest_fragment>","    #include <specularmap_fragment>","    #include <emissivemap_fragment>","    reflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );","    #include <lightmap_fragment>","    reflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );","    #ifdef DOUBLE_SIDED","        reflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;","    #else","        reflectedLight.directDiffuse = vLightFront;","    #endif","    reflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();","    #include <aomap_fragment>","    vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;","    #include <envmap_fragment>","    gl_FragColor = vec4( outgoingLight, diffuseColor.a );","    #include <tonemapping_fragment>","    #include <encodings_fragment>","    #include <fog_fragment>","    #include <premultiplied_alpha_fragment>","    #include <dithering_fragment>","}"].join("\n");t.DecryptLambertMaterial=()=>{const e=o.UniformsUtils.clone(a.uniforms);return new o.ShaderMaterial({uniforms:e,vertexShader:"\n#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n    varying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n    #include <uv_vertex>\n    #include <uv2_vertex>\n    #include <color_vertex>\n    #include <beginnormal_vertex>\n    #include <morphnormal_vertex>\n    #include <skinbase_vertex>\n    #include <skinnormal_vertex>\n    #include <defaultnormal_vertex>\n    #include <begin_vertex>\n    #include <morphtarget_vertex>\n    #include <skinning_vertex>\n    #include <project_vertex>\n    #include <logdepthbuf_vertex>\n    #include <clipping_planes_vertex>\n    #include <worldpos_vertex>\n    #include <envmap_vertex>\n    vec3 diffuse = vec3( 1.0 );\n    GeometricContext geometry;\n    geometry.position = mvPosition.xyz;\n    geometry.normal = normalize( transformedNormal );\n    geometry.viewDir = normalize( -mvPosition.xyz );\n    GeometricContext backGeometry;\n    backGeometry.position = geometry.position;\n    backGeometry.normal = -geometry.normal;\n    backGeometry.viewDir = geometry.viewDir;\n    vLightFront = vec3( 0.0 );\n    #ifdef DOUBLE_SIDED\n        vLightBack = vec3( 0.0 );\n    #endif\n    IncidentLight directLight;\n    float dotNL;\n    vec3 directLightColor_Diffuse;\n    #if NUM_DIR_LIGHTS > 0\n        const int limitDirNum = 1;\n        for ( int i = 0; i < limitDirNum; i ++ ) {\n            getDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n            dotNL = dot( geometry.normal, directLight.direction );\n            directLightColor_Diffuse = PI * directLight.color;\n            vLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n            #ifdef DOUBLE_SIDED\n                vLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n            #endif\n        }\n    #endif\n    #if NUM_HEMI_LIGHTS > 0\n        const int limitHemiNum = 1;\n        for ( int i = 0; i < limitHemiNum; i ++ ) {\n            vLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n            #ifdef DOUBLE_SIDED\n                vLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n            #endif\n        }\n    #endif\n    #include <shadowmap_vertex>\n    #include <fog_vertex>\n}",fragmentShader:c,lights:!0,fog:!0})}},34566:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.materialManager=void 0;const o=i(n(78406)),a=n(31667),c=n(34615),l=n(70634),d=n(51246),u=n(58050);let h;const g=function(){const e=document.createElement("canvas");e.width=128,e.height=128;const t=e.getContext("2d");return t.arc(64,64,60,0,2*Math.PI),t.fillStyle="rgb(255,255,255)",t.fill(),new o.CanvasTexture(e)}();t.materialManager=new class{newLineMaterial(e){if(e.fatLineStyle)return this._newFatLineMaterial(e.fatLineStyle);let t;if(e.dotted){const n=new o.LineDashedMaterial;n.userData.originDashSize=e.dashSize||6,n.userData.originGapSize=e.gapSize||6,n.dashSize=e.dashSize||6,n.gapSize=e.gapSize||6,n.scale=1,t=n}else t=new o.LineBasicMaterial;const n=t;return t.polygonOffset=!0,t.polygonOffsetFactor=-1,t.polygonOffsetUnits=-4,n.color=new o.Color(e.color),n.transparent=!0,void 0!==e.opacity&&(n.opacity=e.opacity),e.width&&(n.linewidth=e.width),!1===e.depthWrite&&(n.depthWrite=e.depthWrite,n.depthTest=e.depthWrite),t}newFaceMaterial(e,t){var n;let r;const s=!(!e.texture||(i=e.texture,!i.includes("-fc.png")));var i;if(s)r=l.DecryptLambertMaterial();else{let t=!!a.isNumber(e.opacity)&&e.opacity<=.99,s=a.isNumber(e.opacity)?e.opacity:1;const i=!1===e.doubleSide?o.FrontSide:o.DoubleSide;e.normalMap||"MeshPhongMaterial"===e.materialType?r=new o.MeshPhongMaterial({color:e.color,transparent:t,opacity:e.opacity,side:i,alphaTest:e.opacity}):((null===(n=e.texture)||void 0===n?void 0:n.includes("opacity-map.png"))&&(t=!0,1===s&&(s=.99)),r=new o.MeshBasicMaterial({color:e.color,transparent:t,side:i,opacity:s})),!1===e.depthWrite?r.depthWrite=e.depthWrite:t&&(r.depthWrite=!1)}return void 0!==e.polygonOffset&&void 0!==e.polygonOffsetFactor&&void 0!==e.polygonOffsetUnits?(r.polygonOffset=e.polygonOffset,r.polygonOffsetUnits=e.polygonOffsetUnits,r.polygonOffsetFactor=e.polygonOffsetFactor):(r.polygonOffset=!0,r.polygonOffsetFactor=1,r.polygonOffsetUnits=2),e.texture&&this._loadTexture(e.texture,s,r,t),e.normalMap&&this._loadTexture(e.normalMap,s,r,t,!0),r}newPointMaterial(e){var t;return new o.PointsMaterial({size:e.size,sizeAttenuation:!1,transparent:!0,opacity:null!==(t=e.opacity)&&void 0!==t?t:1,color:e.color,map:g})}release(e){var t;e&&(Array.isArray(e)?e.forEach((e=>this.release(e))):(e.dispose(),(e instanceof o.MeshBasicMaterial||e instanceof o.ShaderMaterial)&&(null===(t=e.map)||void 0===t||t.dispose())))}getHighLightPointMaterial(){if(this._highLightPointMaterial)return this._highLightPointMaterial;let e={depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-4,polygonOffsetUnits:-4,side:2,transparent:!0,opacity:.65};const t=new o.Color(4953855),n=["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),r=["void main() {","float step = 6.0;","float modx = mod(gl_FragCoord.x, step);","float mody = mod(gl_FragCoord.y, step);","float e = 2.0;","if((modx>=-e&&modx<=e)&&(mody>=-e&&mody<=e)) {",`gl_FragColor = vec4(${t.r},${t.g},${t.b},${e.opacity||.65});`,"} else {","discard;","}","}"].join("\n");return e=Object.assign(e||{},{vertexShader:n,fragmentShader:r}),this._highLightPointMaterial=new o.ShaderMaterial(e),this._highLightPointMaterial}_newFatLineMaterial(e){const t=new c.LineMaterial(e);return t.resolution=new o.Vector2(screen.width,screen.width),e.dashed&&(t.defines.USE_DASH=""),t}_loadTexture(e,t,n,r,s=!1){const i={loadingMgr:r};return function(){if(!h){const e=new u.TextureCache;h=new d.TextureLoader(e)}return h}().load(e,i).then((e=>{this._applyTexture(e,t,n,s)}))}_applyTexture(e,t,n,r=!1){if(t){(t=>{t.map=e,t.uniforms.map.value=e,t.needsUpdate=!0})(n)}else{(t=>{r?t.normalMap=e:t.map=e,e.wrapS=o.RepeatWrapping,e.wrapT=o.RepeatWrapping,t.needsUpdate=!0})(n)}}}},41373:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isBucketGpuSelectable=t.isBucketRenderable=t.genMeshesBuffer=t.genMeshBuffer=t.genLineBuffer=t.genPointBuffer=t.BucketList=void 0;const a=o(n(12756)),c=i(n(78406)),l=n(31667),d=n(34615),u=n(34566),h=n(97852);function g(e){return a.default({t:e.type,s:e.style,f:e.flags})}function f(e,t=!1){const n=new c.BufferGeometry,r=[e.point.x||0,e.point.y||0,e.point.z||0];n.addAttribute("position",new c.Float32BufferAttribute(r,3));const s=t?void 0:e.globalMatrix;return v(n,e.globalID,s),n}function p(e,t=!1){const n=h.ThreeJsUtil.createLineBuffer(e.points),r=t?void 0:e.globalMatrix;return v(n,e.globalID,r),n}function _(e,t=!1){const n=new c.BufferGeometry,r=e.getVerts(),s=e.getIndices(),i=e.getNormals(),o=e.getUVs();n.addAttribute("position",new c.Float32BufferAttribute(r,3)),n.addAttribute("normal",new c.Float32BufferAttribute(i,3)),n.addAttribute("uv",new c.Float32BufferAttribute(o,2)),n.setIndex(new c.BufferAttribute(s,1));const a=t?void 0:e.globalMatrix;return v(n,e.globalID,a),n}t.BucketList=class{constructor(e,t,n){this._bukMap=new Map,this._dynamicMap=new Map,this._hudMap=new Map,this._mtlHashMap=new Map,this._mtlHashCounting=new Map,this._mtlHashlDeletePending=new Set,this._screenSize=e,this._envMap=t,this._loadingMgr=n}addRootGRep(e){const t=function(e,t){const n={buckets:[],dynamics:[],huds:[]},r=e.toRenderNode();let s=[];const i=new Map,o=[],a=(e,t)=>{if(l.FlagTester.isDynamic(t.flags))o.push({rNode:t,buf:e});else{const n=g(t);i.has(n)||i.set(n,[]);i.get(n).push({rNode:t,buf:e})}};r.type===l.EN_RNODE_TYPE.GROUP?s=function(e){const t=[],n=[];let r=e;for(;r;){for(const e of r.children)e.type===l.EN_RNODE_TYPE.GROUP?t.push(e):n.push(e);r=t.pop()}return n}(r):s.push(r);for(const e of s){let r,s;const i=l.FlagTester.isDynamic(e.flags);switch(e.type){case l.EN_RNODE_TYPE.POINT:r=f(e,i);break;case l.EN_RNODE_TYPE.EDGE:r=p(e,i);break;case l.EN_RNODE_TYPE.MESH:r=_(e,i);break;case l.EN_RNODE_TYPE.TEXT:s=h.ThreeJsUtil.newThreeTextObject3D(e,t.width,t.height),s.userData.originPosition=s.position.clone()}r&&a(r,e),s&&n.huds.push(s)}const c=(t,n)=>{const r={gIDs:[],eID:e.elementId.asInt(),rNodes:[],originBufs:[],sHash:n,flags:0,layer:e.grepRenderArea,type:l.EN_RNODE_TYPE.UNKOWN};for(const e of t)r.gIDs.push(e.rNode.globalID),r.rNodes.push(e.rNode),r.originBufs.push(e.buf),r.type=e.rNode.type,r.flags=e.rNode.flags;return 1===r.originBufs.length?r.buf=r.originBufs[0]:r.buf=h.ThreeJsUtil.mergeBufferGeometries(r.originBufs,!1),r.buf.userData=r.rNodes[0].userData,r};return i.forEach(((e,t)=>{const r=c(e,t);n.buckets.push(r)})),o.forEach((e=>{const t=c([e],g(e.rNode));n.dynamics.push(t)})),n}(e,{width:this._screenSize.x,height:this._screenSize.y,envMap:this._envMap});this._regMaterials(t);const n=e.elementId.asInt();return this._bukMap.set(n,t.buckets),this._dynamicMap.set(n,t.dynamics),this._hudMap.set(n,t.huds),t}removeRootGrep(e){this._deleteMaterial(),this._unregMaterials(e),this._clearBuks(this._bukMap.get(e)),this._clearBuks(this._dynamicMap.get(e));const t=this._hudMap.get(e);t&&t.forEach((e=>{h.ThreeJsUtil.removeNode(e,!0,!0,!0)})),this._bukMap.delete(e),this._dynamicMap.delete(e),this._hudMap.delete(e)}clearBuckets(e){this._clearBuks(this._bukMap.get(e)),this._bukMap.delete(e)}getBuckets(e){const t=this._bukMap.get(e);return t||[]}getDynamicBuckets(e){const t=this._dynamicMap.get(e);return t||[]}getObj3D(e){const t=new c.Group,n=this._bukMap.get(e);n&&n.filter(E).forEach((e=>{const n=y(e,this._mtlHashMap.get(e.sHash));t.add(n)}));const r=this._dynamicMap.get(e),s=[];r&&r.filter(E).forEach((e=>{const t=y(e,this._mtlHashMap.get(e.sHash));s.push(t)}));let i=this._hudMap.get(e);return i||(i=[]),{elementGrp:t,dynamicObjs:s,huds:i}}getSharedMaterial(e){return this._mtlHashMap.get(e)}clear(){this._bukMap.forEach(((e,t)=>{this.removeRootGrep(t)}))}_regMaterials(e){let t;const n=[...e.buckets,...e.dynamics];for(const e of n)t=this._mtlHashMap.get(e.sHash),t||(t=P(e.rNodes[0],this._envMap,this._loadingMgr)),this._increaseMaterialHashCounting(e.sHash,t)}_unregMaterials(e){const t=e=>{e&&e.forEach((e=>{this._decreaseMaterialhashCounting(e.sHash)}))};t(this._bukMap.get(e)),t(this._dynamicMap.get(e))}_increaseMaterialHashCounting(e,t){this._mtlHashCounting.has(e)?this._mtlHashCounting.set(e,this._mtlHashCounting.get(e)+1):(this._mtlHashCounting.set(e,1),this._mtlHashMap.set(e,t)),this._mtlHashlDeletePending.has(e)&&this._mtlHashlDeletePending.delete(e)}_decreaseMaterialhashCounting(e){this._mtlHashCounting.has(e)?this._mtlHashCounting.set(e,this._mtlHashCounting.get(e)-1):l.DebugWarn.warn(!1,"deRef a sHash counting <= 0","",""),this._mtlHashCounting.get(e)<=0&&this._mtlHashlDeletePending.add(e)}_deleteMaterial(){for(const e of this._mtlHashlDeletePending.values())u.materialManager.release(this._mtlHashMap.get(e)),this._mtlHashMap.delete(e),this._mtlHashCounting.delete(e),this._mtlHashlDeletePending.delete(e)}_clearBuks(e){e&&e.forEach((e=>{e.buf&&(1!==e.originBufs.length&&e.buf.dispose(),e.originBufs.forEach((e=>e.dispose())))}))}},t.genPointBuffer=f,t.genLineBuffer=p,t.genMeshBuffer=_,t.genMeshesBuffer=function(e,t=!1){const n=new c.BufferGeometry,r=[],s=[],i=[],o=[];return e.forEach((e=>{const t=r.length/3;e.getVerts().forEach((e=>r.push(e))),e.getNormals().forEach((e=>i.push(e))),e.getUVs().forEach((e=>o.push(e))),e.getIndices().forEach((e=>s.push(e+t)))})),n.addAttribute("position",new c.Float32BufferAttribute(r,3)),n.addAttribute("normal",new c.Float32BufferAttribute(i,3)),n.addAttribute("uv",new c.Float32BufferAttribute(o,2)),n.setIndex(new c.BufferAttribute(new Uint32Array(s),1)),v(n,-1),n};const m=new c.Color;function v(e,t,n){n&&e.applyMatrix(h.ThreeJsUtil.brepMatrixToThreeMatrix(n)),m.setHex(t),h.ThreeJsUtil.applyVertexColors(e,m)}function E(e){return e.rNodes[0].isVisible()}function P(e,t,n){let r;switch(e.type){case l.EN_RNODE_TYPE.EDGE:r=u.materialManager.newLineMaterial(e.style.line);break;case l.EN_RNODE_TYPE.FACE:case l.EN_RNODE_TYPE.MESH:r=u.materialManager.newFaceMaterial(e.style.face,n),r instanceof c.MeshStandardMaterial&&t&&(r.envMap=t);break;case l.EN_RNODE_TYPE.POINT:r=u.materialManager.newPointMaterial(e.style.point);break;default:l.DebugWarn.warn(!1,`unsupported material rNode.type ${e.type}`,"",""),r=new c.Material}return r}function y(e,t){let n;if(t instanceof d.LineMaterial){const r=new d.LineGeometry;return r.setPositions(e.buf.attributes.position.array),n=new d.Line2(r,t),n.computeLineDistances(),n}n=h.ThreeJsUtil.newObject3D(e.type,e.buf),t instanceof c.LineDashedMaterial&&n.computeLineDistances();const r=e.rNodes[0];return n.material=t,l.FlagTester.isDynamic(e.flags)&&(n.userData.dynamicBucket=!0,n.userData.globalID=r.globalID,void 0!==r.onBeforeRender&&(n.userData.dynamicCallback=r.onBeforeRender),r.globalMatrix&&(h.ThreeJsUtil.brepMatrixToThreeMatrix(r.globalMatrix).decompose(n.position,n.quaternion,n.scale),n.updateMatrix())),!0===r.gnode.disableGNodeRenderFeature&&(n.userData.disableGNodeRenderFeature=!0),n}t.isBucketRenderable=E,t.isBucketGpuSelectable=function(e){return l.FlagTester.gpuSelectable(e.rNodes[0].flags)}},80265:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ThreeJsLights=void 0;const o=i(n(78406));t.ThreeJsLights=class{constructor(e){this._ambientLight=new o.AmbientLight(16777215,.4),this._directionalLight=new o.DirectionalLight(16777215,.1),this._directionalLight.position.set(1e6,1e6,5e5),this._directionalLight.lookAt(0,0,0),this._directionalLight.updateMatrix(),this._directionalLight.shadow.mapSize.set(4096,4096),this._directionalLight.shadow.camera.near=10,this._directionalLight.shadow.camera.far=1e4,this._directionalLight.shadow.camera.left=-5e3,this._directionalLight.shadow.camera.right=5e3,this._directionalLight.shadow.camera.top=5e3,this._directionalLight.shadow.camera.bottom=-5e3,this._directionalLight.shadow.camera.updateProjectionMatrix(),this._directionalLight1=new o.DirectionalLight(16777215,.1),this._directionalLight1.position.set(-5e3,-1e4,8e3),this._directionalLight2=new o.DirectionalLight(16777215,.1),this._directionalLight2.position.set(5e3,1e4,-8e3),this._directionalLight3=new o.DirectionalLight(16777215,.1),this._directionalLight3.position.set(5e3,-1e4,8e3),this._directionalLight4=new o.DirectionalLight(16777215,.1),this._directionalLight4.position.set(-5e3,1e4,-8e3),this._himesphereLight=new o.HemisphereLight(16777215,13882323,.5),this._himesphereLight.position.set(0,0,1e5),this._himesphereLight.lookAt(0,0,0),this._himesphereLight.updateMatrix(),e.add(this._ambientLight),e.add(this._directionalLight),e.add(this._directionalLight1),e.add(this._directionalLight2),e.add(this._directionalLight3),e.add(this._directionalLight4),e.add(this._himesphereLight)}}},34056:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ThreePickingContext=void 0;const o=i(n(78406)),a=n(31667),c=n(82658),l=n(41373),d=n(97852);t.ThreePickingContext=class{constructor(e){this.pickingBuffer=new Uint8Array(4*c.appConfig.common.pick_length*c.appConfig.common.pick_length),this._ePointMap=new Map,this._eLineMap=new Map,this._eFaceMap=new Map,this._eIDDynamicMap=new Map,this._bucketList=e,this.pickScene=new o.Scene,this._linePickingMaterial=new o.LineBasicMaterial({vertexColors:o.VertexColors}),this._linePickingMaterial.polygonOffset=!0,this._linePickingMaterial.polygonOffsetFactor=-1,this._linePickingMaterial.polygonOffsetUnits=-4,this._meshPickingMaterial=new o.MeshBasicMaterial({vertexColors:o.VertexColors}),this._pointPickingMaterial=new o.PointsMaterial({vertexColors:o.VertexColors,size:c.appConfig.common.point_size_gpu_pick_context,sizeAttenuation:!1}),this._meshPickingMaterial.side=o.DoubleSide,this._meshPickingMaterial.polygonOffset=!0,this._meshPickingMaterial.polygonOffsetFactor=1,this._meshPickingMaterial.polygonOffsetUnits=4,this._overlayPointPickingMaterial=this._pointPickingMaterial.clone(),this._overlayLinePickingMaterial=this._linePickingMaterial.clone(),this._overlayMeshPickingMaterial=this._meshPickingMaterial.clone(),this._meshPickingMaterialPolyoffset=this._meshPickingMaterial.clone(),this._overlayMeshPickingMaterialPolyoffset=this._meshPickingMaterial.clone(),this._overlayMeshPickingMaterialPolyoffset.polygonOffsetUnits=10,this._meshPickingMaterialPolyoffset.polygonOffsetUnits=10,this._overlayPointPickingMaterial.depthTest=!1,this._overlayLinePickingMaterial.depthTest=!1,this._overlayMeshPickingMaterial.depthTest=!1,this._overlayMeshPickingMaterialPolyoffset.depthTest=!1,this.pickingTexture=new o.WebGLRenderTarget(c.appConfig.common.pick_length,c.appConfig.common.pick_length),this._spiralOrder=function(e){let t=0,n=e-1,r=0,s=n;const i=[];for(;;){for(let n=r;n<=s;++n)i.push(t*e+n);if(++t>n)break;for(let r=t;r<=n;++r)i.push(r*e+s);if(--s<r)break;for(let t=s;t>=r;--t)i.push(n*e+t);if(--n<t)break;for(let s=n;s>=t;--s)i.push(s*e+r);if(++r>s)break}return i.reverse(),i}(c.appConfig.common.pick_length)}addElement(e){let t;[...this._bucketList.getBuckets(e),...this._bucketList.getDynamicBuckets(e)].filter(l.isBucketGpuSelectable).forEach((n=>{if(!n.buf)return void a.DebugWarn.warn(!1,`three.js bucket - eID ${e} has no merged buffer.`,"","");const r=n.rNodes[0];let s;switch(n.type){case a.EN_RNODE_TYPE.POINT:t=this._getObjListFromMap(this._ePointMap,e),n.layer===a.EN_RENDER_AREA.OVERLAY?(s=new o.Points(n.buf,this._overlayPointPickingMaterial),s.renderOrder=5e4):s=new o.Points(n.buf,this._pointPickingMaterial);break;case a.EN_RNODE_TYPE.EDGE:t=this._getObjListFromMap(this._eLineMap,e),n.layer===a.EN_RENDER_AREA.OVERLAY?(s=new o.LineSegments(n.buf,this._overlayLinePickingMaterial),s.renderOrder=49999):s=new o.LineSegments(n.buf,this._linePickingMaterial);break;case a.EN_RNODE_TYPE.MESH:case a.EN_RNODE_TYPE.FACE:t=this._getObjListFromMap(this._eFaceMap,e);const r=this._bucketList.getSharedMaterial(n.sHash);if(n.layer===a.EN_RENDER_AREA.OVERLAY){const e=r.polygonOffsetUnits>4?this._overlayMeshPickingMaterialPolyoffset.clone():this._overlayMeshPickingMaterial.clone();let t=e;e.side!==r.side&&(t=t.clone(),t.side=r.side),t.polygonOffset=r.polygonOffset,t.polygonOffsetFactor=r.polygonOffsetFactor,t.polygonOffsetUnits=r.polygonOffsetUnits,s=new o.Mesh(n.buf,t),s.renderOrder=49998}else{const e=r.polygonOffsetUnits>4?this._meshPickingMaterialPolyoffset.clone():this._meshPickingMaterial.clone();let t=e;e.side!==r.side&&(t=t.clone(),t.side=r.side),t.polygonOffset=r.polygonOffset,t.polygonOffsetFactor=r.polygonOffsetFactor,t.polygonOffsetUnits=r.polygonOffsetUnits,s=new o.Mesh(n.buf,t)}break;default:t=void 0,s=void 0}if(s&&t){a.FlagTester.isDynamic(r.flags)&&(this._eIDDynamicMap.has(e)||this._eIDDynamicMap.set(e,[]),this._eIDDynamicMap.get(e).push(s),s.userData.globalID=r.globalID,r.globalMatrix&&(d.ThreeJsUtil.brepMatrixToThreeMatrix(r.globalMatrix).decompose(s.position,s.quaternion,s.scale),s.updateMatrix())),t.push(s),this.pickScene.add(s)}}))}setMeshVisible(e,t){this._getObjListFromMap(this._eFaceMap,e).forEach((e=>{e.visible=t}))}removeElement(e){const t=e=>{this.pickScene.remove(e)};this._getObjListFromMap(this._ePointMap,e).forEach(t),this._getObjListFromMap(this._eLineMap,e).forEach(t),this._getObjListFromMap(this._eFaceMap,e).forEach(t),this._ePointMap.delete(e),this._eLineMap.delete(e),this._eFaceMap.delete(e),this._eIDDynamicMap.delete(e)}updateDynamicMatrix(e,t,n){const r=this._eIDDynamicMap.get(e);if(r){const e=r.findIndex((e=>e.userData.globalID===t));if(e>=0){const t=r[e];n.decompose(t.position,t.quaternion,t.scale),t.updateMatrix()}}}clear(){const e=e=>{for(const t of e)this.pickScene.remove(t)};this._ePointMap.forEach((t=>e(t))),this._eLineMap.forEach((t=>e(t))),this._eFaceMap.forEach((t=>e(t))),this._ePointMap.clear(),this._eLineMap.clear(),this._eFaceMap.clear()}destroy(){this.clear(),this.pickScene.dispose()}getSpiralOrder(){return this._spiralOrder}_getObjListFromMap(e,t){return e.has(t)||e.set(t,[]),e.get(t)}}},68655:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ThreeJsRender=void 0;const o=i(n(78406)),a=n(94134),c=n(31667),l=n(34615),d=n(82658),u=n(37419),h=n(85029),g=n(34566),f=n(41373),p=n(34056),_=n(97852),m=n(80265),v=n(58658);let E=(new Date).getTime();function P(e){const t=new c.math.Matrix4,{elements:n}=e;for(let e=0;e<4;e++)for(let r=0;r<4;r++)t.set(e,r,n[e+4*r]);return t}class y extends c.IRender{constructor(e){if(super(),this._canvasDomParent=e,this._areaGroupMap=new Map,this._overlayActiveGroup=new o.Group,this._selectionGroup=new o.Group,this._overlaySelectionGroup=new o.Group,this._eidMap=new Map,this._hudMap=new Map,this._gnodeCollection=new Map,this._eidGIDMap=new Map,this._eidDynamicMap=new Map,this._isSync=!0,this._debugPickScene=!1,this.updateView=()=>{this._configFeature(),this._updateCamera(),this._isSync=!1},this._cameraInfo=new c.CameraInfo,!1===a.WEBGL.isWebGL2Available())this._renderer=new o.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0});else{const e=document.createElement("canvas"),t=e.getContext("webgl2");this._renderer=new o.WebGLRenderer({canvas:e,context:t,antialias:!0,alpha:!0,preserveDrawingBuffer:!0})}this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setClearColor(d.appConfig.common.color_background,1),this._canvasDomParent.appendChild(this._renderer.domElement),this._orthoCamera=new o.OrthographicCamera(-1,1,1,-1),this._persCamera=new o.PerspectiveCamera,this._pickCamera=new o.PerspectiveCamera,this._pickCamera.up.set(0,0,1),this._currentCamera=this._orthoCamera,this._hudScene=new o.Scene,this._hudCamera=new o.OrthographicCamera(-1,1,1,-1),this._hudCamera.position.set(0,0,1),this._hudCamera.lookAt(0,0,0),this._hudCamera.updateMatrixWorld(),this._width=1,this._height=1,this._screenSize=new c.math.Vector2(this._width,this._height),this._cubeTextureEnv=new o.CubeTexture;const t=new o.LoadingManager((()=>this.updateView()));this._bucketList=new f.BucketList(this._screenSize,this._cubeTextureEnv,t),this._pickContext=new p.ThreePickingContext(this._bucketList),this._cameraLayers=new o.Layers,this._cameraLayers.enable(1)}set container(e){e!==this._canvasDomParent&&(this._canvasDomParent=e,this._canvasDomParent.appendChild(this._renderer.domElement),this._getCamera().setScreen(e.clientWidth,e.clientHeight),this._updateCamera())}get width(){return this._width}createScene(){if(!this._scene){this._scene=new o.Scene,new m.ThreeJsLights(this._scene),this._overlayScene=new o.Scene,this._baseScene=new o.Scene;for(let e=0;e<c.EN_RENDER_AREA.___COUNT;e++)this.createRenderArea(c.EN_RENDER_AREA[c.EN_RENDER_AREA[e]]);const e=this._getCamera(),t=e.screen;e instanceof u.OrthogonalCamera?(this._orthoCamera.copy(e.getTHREECamera()),this._currentCamera=this._orthoCamera):e instanceof h.PerspectiveCamera&&(this._persCamera.copy(e.getTHREECamera()),this._currentCamera=this._persCamera),this._scene.add(this._orthoCamera),this._scene.add(this._persCamera);const n=new o.LightProbe;n.intensity=.01,this._scene.add(n),this.onResize(t.width,t.height),this._configFeature(),d.appConfig.common.active_group_is_overlay?this._createActiveGroup(this._overlayScene):this._createActiveGroup(this._scene),d.appConfig.common.selection_group_is_overlay?this._createSelectionGroup(this._overlayScene,this._overlaySelectionGroup):this._createSelectionGroup(this._scene)}this.updateView()}clearScene(){for(let e=0;e<c.EN_RENDER_AREA.___COUNT;e++)this.clearRenderArea(c.EN_RENDER_AREA[c.EN_RENDER_AREA[e]]);for(;this._hudScene.children.length>0;)this._hudScene.remove(this._hudScene.children[0]);this._bucketList.clear(),this._renderer.renderLists.dispose(),this._hudMap.clear(),this._eidDynamicMap.clear(),this._eidMap.clear(),this._gnodeCollection.clear(),this._eidGIDMap.clear(),this._pickContext.clear()}createRenderArea(e){const t=new o.Group;this._areaGroupMap.set(e,t),e===c.EN_RENDER_AREA.OVERLAY?this._overlayScene.add(t):e===c.EN_RENDER_AREA.BASE?this._baseScene.add(t):e===c.EN_RENDER_AREA.SELECTION||e===c.EN_RENDER_AREA.ACTIVE||this._scene.add(t),c.DebugWarn.assert(this.getRenderArea(e)===t,"renderarea 位置错乱"," ","2020-04-13")}addGrep(e){let t=e.grepRenderArea;void 0===t&&(t=c.EN_RENDER_AREA.MODEL);const n=this.getRenderArea(t);this._bucketList.addRootGRep(e);const r=e.elementId.asInt(),s=this._bucketList.getObj3D(r),{elementGrp:i}=s,{dynamicObjs:o,huds:a}=s;if(e.canGpuPick&&this._pickContext.addElement(r),this._bucketList.clearBuckets(r),o.forEach((e=>{let t=this._eidDynamicMap.get(r);t||(t=[],this._eidDynamicMap.set(r,t)),t.push(e),i.add(e)})),i.userData.elementId=e.elementId.asInt(),i.userData.disableGNodeRenderFeature=!e.enableRenderFeature,e.enableRenderFeature&&(i.userData.wireframeStyle=e.wireframeStyle,i.userData.wireOnlySameAsWhite=e.wireOnlySameAsWhite,"real"!==this.renderFeature.geometry&&this._applyRenderFeature(i)),this._tryToSetZoomFreeInfo(e,i),this._tryToDynamicModifyDotLine(i),n.add(i),a.forEach((e=>{this._hudScene.add(e)})),this._hudMap.set(r,a),this._eidMap.set(r,i),t===c.EN_RENDER_AREA.MODEL||t===c.EN_RENDER_AREA.OVERLAY||t===c.EN_RENDER_AREA.BASE){const t=[];e.toRenderNode().traverse((e=>{if(!e.canPick())return;const n=e.gnode;c.DebugWarn.assert(n,"g不存在"," ","2020-08-20"),n.getType()!==c.GNODE_TYPE.GRep&&(this._gnodeCollection.set(e.globalID,n),t.push(e.globalID))})),this._eidGIDMap.set(r,t)}}removeObject(e){const t="number"==typeof e?e:e.asInt();this._pickContext.removeElement(t),this._bucketList.removeRootGrep(t);const n=this._eidMap.get(t);n&&(this._eidMap.delete(t),n.parent&&n.parent.remove(n));const r=this._hudMap.get(t);if(r){this._hudMap.delete(t);for(const e of r)this._hudScene.remove(e)}const s=this._eidGIDMap.get(t);return s&&s.forEach((e=>{this._gnodeCollection.delete(e)})),this._eidGIDMap.delete(t),this._eidDynamicMap.delete(t),!0}drawSelections(e){if(e instanceof c.GCurves)this.drawGCurves(e,d.appConfig.common.color_selection,this._getRenderArea(e.drawOverlay));else if(e instanceof c.RenderEdge)this.drawRenderEdge(e,d.appConfig.common.color_selection,this._getRenderArea(e.drawOverlay));else if(e instanceof c.RenderPoint)this.drawRenderPoint(e,d.appConfig.common.color_selection,this._getRenderArea(e.drawOverlay));else if(Array.isArray(e)){if(!(e.length&&e[0]instanceof c.RenderMesh))return;this.drawGMeshes(e,this._getRenderArea(e[0].drawOverlay))}}drawActives(e,t){if(e instanceof c.GCurves)this.drawGCurves(e,d.appConfig.common.color_active,this._overlayActiveGroup);else if(e instanceof c.RenderEdge)this.drawRenderEdge(e,d.appConfig.common.color_active,this._overlayActiveGroup);else if(e instanceof c.RenderPoint)this.drawRenderPoint(e,d.appConfig.common.color_active,this._overlayActiveGroup);else if(Array.isArray(e)){if(!(e.length&&e[0]instanceof c.RenderMesh))return;this.drawGMeshes(e,this._overlayActiveGroup,t)}}drawGCurves(e,t,n){if(v.getOSType()===v.EN_OS_TYPE.mac){const r=e.toRenderNode(),s=_.ThreeJsUtil.createLineBuffer(r.points),i={fatLineStyle:{color:t,linewidth:2}},o=[],a=g.materialManager.newLineMaterial(i);for(let e=0;e<s.attributes.position.array.length;e+=6){const t=new l.LineGeometry;t.setPositions([s.attributes.position.array[e],s.attributes.position.array[e+1],s.attributes.position.array[e+2],s.attributes.position.array[e+3],s.attributes.position.array[e+4],s.attributes.position.array[e+5]]);const n=new l.Line2(t,a);n.computeLineDistances(),o.push(n)}n.add(...o)}else{const r=e.toRenderNode(),s=_.ThreeJsUtil.createLineBuffer(r.points),i=Object.assign(Object.assign({},e.getStyle().line),{color:t}),a=g.materialManager.newLineMaterial(i),c=new o.LineSegments(s,a);n.add(c)}}drawRenderEdge(e,t,n){if(v.getOSType()===v.EN_OS_TYPE.mac){const r=f.genLineBuffer(e),s={fatLineStyle:{color:t,linewidth:2}},i=[],o=g.materialManager.newLineMaterial(s);for(let e=0;e<r.attributes.position.array.length;e+=6){const t=new l.LineGeometry;t.setPositions([r.attributes.position.array[e],r.attributes.position.array[e+1],r.attributes.position.array[e+2],r.attributes.position.array[e+3],r.attributes.position.array[e+4],r.attributes.position.array[e+5]]);const n=new l.Line2(t,o);n.computeLineDistances(),i.push(n)}n.add(...i)}else{const r=f.genLineBuffer(e),s={color:t},i=g.materialManager.newLineMaterial(s),a=new o.LineSegments(r,i);n.add(a)}}drawGMeshes(e,t,n){const r=[];let s;s=n?g.materialManager.newFaceMaterial(n):g.materialManager.getHighLightPointMaterial();const i=[],a=[];e.forEach((e=>{e.globalMatrix?a.push(e):i.push(e)})),a.forEach((e=>{const t=f.genMeshBuffer(e),n=new o.Mesh(t,s);r.push(n)}));const c=f.genMeshesBuffer(i),l=new o.Mesh(c,s);r.push(l),t.add(...r)}drawRenderPoint(e,t,n){const r=f.genPointBuffer(e),s=g.materialManager.newPointMaterial({color:t,size:d.appConfig.common.default_selected_point_size}),i=new o.Points(r,s);n.add(i)}clearSelection(){this.clearRenderArea(c.EN_RENDER_AREA.SELECTION),_.ThreeJsUtil.removeGroupChildren(this._selectionGroup,!0,!0),_.ThreeJsUtil.removeGroupChildren(this._overlaySelectionGroup,!0,!0)}clearHighlight(){this.clearRenderArea(c.EN_RENDER_AREA.ACTIVE),_.ThreeJsUtil.removeGroupChildren(this._overlayActiveGroup,!0,!0)}clearRenderArea(e){const t=this._areaGroupMap.get(e);if(!t)return;const n=e===c.EN_RENDER_AREA.ACTIVE||e===c.EN_RENDER_AREA.SELECTION;_.ThreeJsUtil.removeGroupChildren(t,!0,n),this._renderer.renderLists.dispose()}getRenderArea(e){const t=this._areaGroupMap.get(e);return c.DebugWarn.assert(t,"no such render area in three-renderer"," ","2020-04-13"),t}render(){if(!((new Date).getTime()-E<20)&&this._scene&&this._currentCamera){this._renderer.autoClear=!0;try{this._renderer.render(this._baseScene,this._currentCamera),this._renderer.autoClear=!1,this._renderer.clearDepth(),this._debugPickScene?this._renderer.render(this._pickContext.pickScene,this._currentCamera):this._renderer.render(this._scene,this._currentCamera)}catch(e){}this._renderer.autoClear=!1,this._renderer.clearDepth(),this._renderer.render(this._overlayScene,this._currentCamera),this._renderer.render(this._hudScene,this._hudCamera),this._isSync=!0,E=(new Date).getTime()}}isSync(){return this._isSync}onResize(e,t){this._width===e&&this._height===t||(this._renderer.setSize(e,t),this._width=e,this._height=t,this._screenSize.x=e,this._screenSize.y=t,this._refreshHUDs(),this.updateView())}getActiveCameraInfo(){return this._currentCamera===this._orthoCamera?(this._cameraInfo.orthogonal=!0,this._cameraInfo.left=this._orthoCamera.left,this._cameraInfo.right=this._orthoCamera.right,this._cameraInfo.top=this._orthoCamera.top,this._cameraInfo.bottom=this._orthoCamera.bottom,this._cameraInfo.near=this._orthoCamera.near,this._cameraInfo.far=this._orthoCamera.far,this._cameraInfo.matrixView=P(this._orthoCamera.matrixWorldInverse),this._cameraInfo.matrixProjection=P(this._orthoCamera.projectionMatrix),this._cameraInfo.pixelToWorldScale=1/this._orthoCamera.zoom):(this._cameraInfo.orthogonal=!1,this._cameraInfo.matrixView=P(this._persCamera.matrixWorldInverse),this._cameraInfo.matrixProjection=P(this._persCamera.projectionMatrix),this._cameraInfo.fov=this._persCamera.fov,this._cameraInfo.pixelToWorldScale=.01),this._cameraInfo}destroy(){this._pickContext.destroy(),this._renderer.forceContextLoss(),this._renderer.domElement.remove(),this._eidMap.forEach(((e,t)=>{this.removeObject(t)})),this._renderer.dispose(),this._areaGroupMap.clear(),this._eidMap.clear(),this._bucketList.clear()}pick(e,t){return this._cameraPick(this._currentCamera,e,t)}showDebugScene(e){this._debugPickScene=e}updateElementVisible(e,t){var n;const r=this._eidMap.get(e.asInt());r&&(r.visible=t,null===(n=this._pickContext)||void 0===n||n.setMeshVisible(e.asInt(),t))}updateElementTransformationDynamic(e,t){var n,r;const s=this._eidMap.get(e.asInt()),i=this._hudMap.get(e.asInt())||[],a="__oldMatrix__";if(s){const e=null!==(r=null===(n=s[a])||void 0===n?void 0:n.preMultiply(t))&&void 0!==r?r:t.clone(),i=_.ThreeJsUtil.brepMatrixToThreeMatrix(e);s.traverse((e=>{var t;null===(t=e.geometry)||void 0===t||t.applyMatrix(i)})),s.updateMatrix(),s[a]=t.inversed()}i.forEach((e=>{const{x:n,y:r,z:s}=t.getTranslation(),i=e.userData.originPosition.clone();i.add(new o.Vector3(n,r,s));const a=new o.Vector3;e.position.set(i.x,i.y,i.z),e.updateMatrixWorld(),a.setFromMatrixPosition(e.matrixWorld),a.project(this._currentCamera),e.position.set(a.x,a.y,0),e.matrixWorldNeedsUpdate=!0})),this._isSync=0===i.length&&!s}rayPick(e,t){const n=new o.Raycaster(new o.Vector3(e.x,e.y,e.z),new o.Vector3(t.x,t.y,t.z),0,100).intersectObject(this.getRenderArea(c.EN_RENDER_AREA.MODEL),!0),r=[],s=new o.Color;for(const e of n)if(e.object instanceof o.Mesh&&e.object.geometry instanceof o.BufferGeometry){const{faceIndex:t}=e,n=e.object.geometry.getAttribute("color");if(n&&null!=t&&t>=0){s.r=n.array[3*t]||0,s.g=n.array[3*t+1]||0,s.b=n.array[3*t+2]||0;const i=s.getHex();if(i===d.appConfig.common.color_background)continue;const o=this._gnodeCollection.get(i);void 0!==o&&r.push({distance:e.distance,point:_.ThreeJsUtil.threeV3TobrepV3(e.point),gnode:o})}}return r}_updateViewWithRenderFeature(){this._eidMap.forEach((e=>this._applyRenderFeature(e))),this._isSync=!1}_getCamera(){return this._viewCamera}_tryToSetZoomFreeInfo(e,t){if(!e.zoomFreeInfo)return;const{x:n,y:r,z:s}=e.zoomFreeInfo.position;t.position.set(n,r,s),t.traverse((e=>{e instanceof o.Group||(e.onBeforeRender=function(e,t,n){const r=new o.Vector2;e.getSize(r);const{y:s}=r;let i=1;if(n instanceof o.OrthographicCamera)i=1/n.zoom;else if(n instanceof o.PerspectiveCamera){const e=this.getWorldPosition(new o.Vector3).distanceTo(n.position),t=n.bounds||new o.Vector4(0,0,1,1),r=n.fov*Math.PI/180;i=e*(2*Math.tan(r/2)/(s*t.w))}this.scale.set(i,i,i),this.updateMatrix(),this.updateMatrixWorld()})}))}_tryToDynamicModifyDotLine(e){e.traverse((e=>{e instanceof o.LineSegments&&e.material instanceof o.LineDashedMaterial&&(e.onBeforeRender=function(e,t,n){const r=new o.Vector2;e.getSize(r);const{y:s}=r;let i=1;if(n instanceof o.OrthographicCamera)i=1/n.zoom;else if(n instanceof o.PerspectiveCamera){const e=this.getWorldPosition(new o.Vector3).distanceTo(n.position),t=n.bounds||new o.Vector4(0,0,1,1),r=n.fov*Math.PI/180;i=e*(2*Math.tan(r/2)/(s*t.w))}const a=this.material;a.dashSize=a.userData.originDashSize*i,a.gapSize=a.userData.originGapSize*i,this.updateMatrix(),this.updateMatrixWorld()})}))}_cameraPick(e,t,n){const r=d.appConfig.common.pick_length,s=Math.floor(r/2);e.setViewOffset(this._width,this._height,t-s,n-s,r,r),this._renderer.setRenderTarget(this._pickContext.pickingTexture),this._renderer.autoClear=!0,this._renderer.render(this._pickContext.pickScene,e),this._renderer.autoClear=!1,e.clearViewOffset(),this._pickContext.pickingBuffer.fill(0),this._renderer.readRenderTargetPixels(this._pickContext.pickingTexture,0,0,r,r,this._pickContext.pickingBuffer);const i=new Set;return this._pickContext.getSpiralOrder().forEach((e=>{const t=this._pickContext.pickingBuffer[4*e],n=this._pickContext.pickingBuffer[4*e+1],r=this._pickContext.pickingBuffer[4*e+2],s=_.ThreeJsUtil.colorToGlobalID(t,n,r);s!==d.appConfig.common.color_background&&this._gnodeCollection.has(s)&&i.add(this._gnodeCollection.get(s))})),this._renderer.setRenderTarget(null),[...i.values()]}_updateCamera(){const e=this._getCamera(),{width:t}=e.screen,{height:n}=e.screen;let r=!1;if(this._viewCamera instanceof u.OrthogonalCamera){const e=this._viewCamera.getTHREECamera();this._orthoCamera.copy(e),this._orthoCamera.position.copy(e.position),this._orthoCamera.quaternion.copy(e.quaternion),this._orthoCamera.updateMatrixWorld(!0),this._orthoCamera.updateProjectionMatrix(),this._orthoCamera.view=e.view,r=!0,this._currentCamera=this._orthoCamera}else if(this._viewCamera instanceof h.PerspectiveCamera){const e=this._viewCamera.getTHREECamera();this._persCamera.copy(e),this._persCamera.position.copy(e.position),this._persCamera.quaternion.copy(e.quaternion),this._persCamera.updateMatrixWorld(!0),this._persCamera.updateProjectionMatrix(),this._persCamera.view=e.view,this._currentCamera=this._persCamera}this.onResize(t,n);_.ThreeJsUtil.brepMatrixToThreeMatrix(e.getTransfrom()).decompose(this._currentCamera.position,this._currentCamera.quaternion,new o.Vector3),this._currentCamera.updateMatrix(),this._currentCamera.updateProjectionMatrix(),this._currentCamera.layers.mask=this._cameraLayers.mask;const s=new o.Vector3;if(this._hudScene.children.forEach((e=>{e instanceof o.Camera||(e.position.copy(e.userData.originPosition),e.updateMatrixWorld(),s.setFromMatrixPosition(e.matrixWorld),s.project(this._currentCamera),e.position.set(s.x,s.y,0))})),this._eidDynamicMap.size>0){const e=_.ThreeJsUtil.threeMatrixTobrepMatrix(this._currentCamera.matrix),t=_.ThreeJsUtil.threeMatrixTobrepMatrix(this._currentCamera.projectionMatrix),n=r?this._orthoCamera.zoom:1;this._eidDynamicMap.forEach(((r,s)=>{r.forEach((r=>{if(r.userData.dynamicCallback)try{const i=r.userData.dynamicCallback(e,t,n),o=_.ThreeJsUtil.brepMatrixToThreeMatrix(i);o.decompose(r.position,r.quaternion,r.scale),r.updateMatrix(),this._pickContext.updateDynamicMatrix(s,r.userData.globalID,o)}catch(e){c.DebugWarn.warn(!1,`${e}`,"","")}}))}))}}_refreshHUDs(){this._hudMap.forEach((e=>{e.forEach((e=>{e instanceof o.Sprite&&_.ThreeJsUtil.scaleSprite(e,this._width,this._height)}))}))}_configFeature(){this._scene&&(this._renderer.shadowMap.enabled=!1)}_applyRenderFeature(e){const t=this.renderFeature.geometry;if(e.userData.disableGNodeRenderFeature)return;let n=!1;if("white"===t||"wire-only"===t&&e.userData.wireOnlySameAsWhite?e.traverse((t=>{var r,s,i,a;if(t.userData.disableGNodeRenderFeature||"Mesh"!==t.type)return;const c=t,l=c.material;t.userData.renderFeatureOldMtl||(c.userData.renderFeatureOldMtl=l);const d=(null===(r=e.userData.wireframeStyle)||void 0===r?void 0:r.face)||{color:16777215,transparent:l.transparent,opacity:l.opacity,depthWrite:l.depthWrite,uvMatrix:l.uvMatrix,polygonOffset:null===(s=l.polygonOffset)||void 0===s||s,polygonOffsetFactor:null!==(i=l.polygonOffsetFactor)&&void 0!==i?i:1,polygonOffsetUnits:null!==(a=l.polygonOffsetUnits)&&void 0!==a?a:2,doubleSide:l.side===o.DoubleSide};c.visible=!0,c.material=g.materialManager.newFaceMaterial(d),n=!0})):"wire-only"===t?e.traverse((e=>{e.userData.disableGNodeRenderFeature||"Mesh"!==e.type||(e.visible=!1,e.userData.renderFeatureInvisible=!0,n=!0)})):"real"===t&&e.traverse((e=>{e.userData.renderFeatureInvisible&&(e.visible=!0,delete e.userData.renderFeatureInvisible),e.userData.renderFeatureOldMtl&&(e.material=e.userData.renderFeatureOldMtl,delete e.userData.renderFeatureOldMtl),n=!0})),n){const t="real"===this.renderFeature.geometry||"white"===this.renderFeature.geometry||"wire-only"===this.renderFeature.geometry&&e.userData.wireOnlySameAsWhite;this._pickContext.setMeshVisible(e.userData.elementId,t)}}_createActiveGroup(e){e.add(this._overlayActiveGroup),this._overlayActiveGroup.renderOrder=c.EN_RENDER_AREA.ACTIVE,this._overlayActiveGroup.onBeforeRender=()=>{this._renderer.clearDepth()}}_createSelectionGroup(e,t){t?(e.add(t),t.renderOrder=c.EN_RENDER_AREA.SELECTION,t.onBeforeRender=()=>{this._renderer.clearDepth()}):(e.add(this._selectionGroup),this._selectionGroup.renderOrder=c.EN_RENDER_AREA.SELECTION,this._selectionGroup.onBeforeRender=()=>{this._renderer.clearDepth()})}_getRenderArea(e){return d.appConfig.common.selection_group_is_overlay||e?this._overlaySelectionGroup:this._selectionGroup}}t.ThreeJsRender=y},97852:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ThreeJsUtil=void 0;const o=n(31667),a=i(n(78406)),c=n(29869),l=n(34566);class d{static ixyzToThreeV3(e){return new a.Vector3(e.x,e.y,e.z||0)}static threeV3TobrepV3(e){return new o.math.Vector3(e.x,e.y,e.z)}static brepMatrixToThreeMatrix(e){const t=new a.Matrix4,n=e.data;return t.set(n[0][0],n[1][0],n[2][0],n[3][0],n[0][1],n[1][1],n[2][1],n[3][1],n[0][2],n[1][2],n[2][2],n[3][2],n[0][3],n[1][3],n[2][3],n[3][3]),t}static threeMatrixTobrepMatrix(e){const t=e.elements,n=new o.math.Matrix4;return n.copy([[t[0],t[1],t[2],t[3]],[t[4],t[5],t[6],t[7]],[t[8],t[9],t[10],t[11]],[t[12],t[13],t[14],t[15]]]),n}static newObject3D(e,t){let n;switch(e){case o.EN_RNODE_TYPE.POINT:n=new a.Points(t);break;case o.EN_RNODE_TYPE.EDGE:{n=new a.LineSegments(t);const e=new a.Vector3;t.computeBoundingBox(),t.boundingBox.getCenter(e),n.localToWorld(e),n.renderOrder=e.z;break}case o.EN_RNODE_TYPE.FACE:case o.EN_RNODE_TYPE.MESH:n=new a.Mesh(t);break;default:n=new a.Object3D}return n}static removeNode(e,t=!0,n=!0,r=!0){e&&(d.removeGroupChildren(e,t,n),d.___disposeNode(e,t,n),e.parent&&e.parent.remove(e))}static removeGroupChildren(e,t=!0,n=!0){for(let r=e.children.length-1;r>=0;r--){const s=e.children[r];this.removeGroupChildren(s,t,n),this.___disposeNode(s,t,n),e.remove(s)}}static ___disposeNode(e,t=!0,n=!0){e instanceof a.Mesh||e instanceof a.Line||e instanceof a.Points||e instanceof a.LineSegments||e instanceof a.Sprite?(e.geometry&&t&&e.geometry.dispose(),e.material&&n&&l.materialManager.release(e.material)):e instanceof a.Points&&e.geometry&&e.geometry.dispose()}static applyVertexColors(e,t){const{position:n}=e.attributes;if(!n)return;const r=[];for(let e=0;e<n.count;e++)r.push(t.r,t.g,t.b);e.addAttribute("color",new a.Float32BufferAttribute(r,3))}static mergeBufferGeometries(e,t){if(0===e.length)return;const n=null!==e[0].index,r=new Set(Object.keys(e[0].attributes)),s={},i=new a.BufferGeometry;let o=0;for(let a=0;a<e.length;a++){const c=e[a];if(n!==(null!==c.index))return;const l=Object.keys(c.attributes);for(const e of l){if(!r.has(e))return;void 0===s[e]&&(s[e]=[]),s[e].push(c.attributes[e])}if(t){let e;if(n)e=c.index.count;else{if(void 0===c.attributes.position)return;e=c.attributes.position.count}i.addGroup(o,e,a),o+=e}}if(n){let t=0;const n=[];for(let r=0,s=e.length;r<s;++r){const{index:s}=e[r];for(let e=0;e<s.count;++e)n.push(s.getX(e)+t);t+=e[r].attributes.position.count}i.setIndex(n)}for(const e in s){if(!e)continue;const t=this.mergeBufferAttributes(s[e]);if(!t)return;i.addAttribute(e,t)}return i}static mergeBufferAttributes(e){let t,n,r,s=0;for(let i=0,o=e.length;i<o;++i){const o=e[i];if(o.isInterleavedBufferAttribute)return null;if(void 0===t&&(t=o.array.constructor),t!==o.array.constructor)return null;if(void 0===n&&(n=o.itemSize),n!==o.itemSize)return null;if(void 0===r&&(r=o.normalized),r!==o.normalized)return null;s+=o.array.length}const i=new t(s);let o=0;for(let t=0,n=e.length;t<n;++t)i.set(e[t].array,o),o+=e[t].array.length;return new a.BufferAttribute(i,n,r)}static createLineBuffer(e){const t=new a.BufferGeometry;if(0===e.length)return t;let n=0;e.forEach((e=>{n+=e.length-1}));let r=0;const s=new Float32Array(6*n);for(const t of e){for(let e=0;e<t.length-1;e++){const n=t[e],i=t[e+1];s[0+6*(r+e)]=n.x||0,s[1+6*(r+e)]=n.y||0,s[2+6*(r+e)]=n.z||0,s[3+6*(r+e)]=i.x||0,s[4+6*(r+e)]=i.y||0,s[5+6*(r+e)]=i.z||0}r+=t.length-1}return t.addAttribute("position",new a.BufferAttribute(s,3)),t}static cloneToWorld(e,t,n){const r=e.clone();return r.applyMatrix(this.brepMatrixToThreeMatrix(t)),r.removeAttribute("lineDistance"),this._tmpColor.setHex(n),this.applyVertexColors(r,this._tmpColor),r}static colorToGlobalID(e,t,n){return e<<16|t<<8|n}static newThreeTextObject3D(e,t,n){const r=c.TextTexture.getDefaultOptions();r.text=e.text,e.style.text&&(r.fontSize=e.style.text.size,r.fillColor=e.style.text.color,r.nostroke=e.style.text.nostroke);const s=c.createTextTexture(r.text,r),i=new a.Sprite,l=new a.SpriteMaterial({transparent:!0,map:s,sizeAttenuation:!1});i.material=l;const u=new o.math.Vector3(e.position).transform(e.globalMatrix||new o.math.Matrix4);return i.position.set(u.x,u.y,u.z),d.scaleSprite(i,t,n),i}static scaleSprite(e,t,n){const{map:r}=e.material;if(!r||0===t||0===n)return;const s=r.image.width/t,i=r.image.height/n;e.scale.set(s,i,1),e.updateMatrix()}}t.ThreeJsUtil=d,d._tmpColor=new a.Color},57169:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CanvasText=void 0;const n={fontSize:20,color:"black",fontFamily:"黑体,Arail,monospace,serif",fontStyle:"normal",fontVariant:"normal",fontWeight:"normal"};t.CanvasText=class{constructor(e,t){this._text=e,this._style=t,window&&window.document&&this._init()}_init(){this._style=Object.assign(Object.assign({},n),this._style);const e=window.document.createElement("canvas");e.width=1,e.height=1,this.canvas=e;const t=e.getContext("2d");if(t){t.font=this._getFontStr();const n=this._text.includes("\n")?this._text.split("\n"):[this._text],r=1.4*t.measureText("M").width*n.length;let s=1;n.forEach((e=>{const n=t.measureText(this._text);s=Math.max(s,n.width)})),e.width=Math.ceil(s),e.height=Math.ceil(r),t.textBaseline="alphabetic",t.fillStyle=this._style.color||"#000",t.fillText(this._text,0,e.height-2)}}_getFontStr(){const e=this._style||n;return`${e.fontStyle} ${e.fontVariant} ${e.fontWeight} ${e.fontSize}px ${e.fontFamily.split(",").map((e=>`"${e}"`)).join(",")}`}}},29869:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.createTextTexture=t.TextTexture=t.powerOf2=void 0;const o=i(n(78406)),a=n(57169);function c(e){if(e<2)return 1;let t=2;for(;;){if(!(t<e))return t;t*=2}}t.powerOf2=c;class l extends o.Texture{constructor(e){super(document.createElement("canvas"),e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.encoding),this._width=1,this._height=1,this._fillColor=e.fillColor,this._fontFamily=e.fontFamily,this._fontSize=e.fontSize,this._fontStyle=e.fontStyle,this._fontVariant=e.fontVariant,this._fontWeight=e.fontWeight,this._strokeColor=e.strokeColor,this._strokeWidth=e.strokeWidth,this._text=e.text,this._redrawNow()}static getDefaultOptions(){return{fillColor:0,fontFamily:"PingFang SC,Microsoft YaHei,sans-serif",fontSize:16,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",strokeColor:0,strokeWidth:0,text:""}}static getFont(e,t,n,r,s){return[e,t,n,`${r}px`,s].join(" ")}static getLines(e){return e.split("\n")}get fillColor(){return this._fillColor}set fillColor(e){this._fillColor!==e&&(this._fillColor=e,this._redraw())}get font(){return l.getFont(this.fontStyle,this.fontVariant,this.fontWeight,this.fontSize,this.fontFamily)}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this._redraw())}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize!==e&&(this._fontSize=e,this._redraw())}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e,this._redraw())}get fontVariant(){return this._fontVariant}set fontVariant(e){this._fontVariant!==e&&(this._fontVariant=e,this._redraw())}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this._redraw())}_redraw(){clearTimeout(this._redrawTimeoutId),this._redrawTimeoutId=setTimeout((()=>{this._redrawNow()}),0)}_redrawNow(){const e=16/this.fontSize;clearTimeout(this._redrawTimeoutId);const t=this.image;if(this.text&&this.text.length>0){const n=new a.CanvasText(this.text,{fontSize:22}).canvas;t.width=c(n.width),t.height=c(n.height);t.getContext("2d").drawImage(n,(t.width-n.width)/2,(t.height-n.height)/2),this._width=t.width/e,this._height=t.height/e}else t.height=1,t.width=t.height,this._width=1,this._height=1;this.needsUpdate=!0}get width(){return this._width}get height(){return this._height}get strokeColor(){return this._strokeColor}set strokeColor(e){this._strokeColor!==e&&(this._strokeColor=e,this._redraw())}get strokeWidth(){return this._strokeWidth}set strokeWidth(e){this._strokeWidth!==e&&(this._strokeWidth=e,this._redraw())}get strokeWidthInPixels(){return this._strokeWidth*this.fontSize}get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this._redraw())}}t.TextTexture=l;const d=512,u=64;t.createTextTexture=function(e,t){const n=document.createElement("canvas"),r=n.getContext("2d");if(r){n.width=d,n.height=u;const s=new o.Texture(n);return s.generateMipmaps=!1,s.wrapS=o.ClampToEdgeWrapping,s.wrapT=o.ClampToEdgeWrapping,s.minFilter=o.NearestFilter,s.magFilter=o.NearestFilter,(e=>{const n=Math.max(16,100*t.fontSize);var s;r.font=`${n}px ${t.fontFamily}`,r.fillStyle=`rgba(${(s=t.fillColor)>>16&255}, ${s>>8&255}, ${255&s}, 1)`,r.textAlign="center",r.textBaseline="middle",r.strokeStyle="white",r.lineWidth=4})(),t.nostroke||r.strokeText(e,d/2,u/2),r.fillText(e,d/2,u/2),s.needsUpdate=!0,s}return new o.Texture}},88123:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnapHelperManager=t.EN_SNAP_HELPER_TYPE=void 0,function(e){e[e.UNKENOW=-1]="UNKENOW",e[e.BRIEF=0]="BRIEF",e[e.PERMANENT=2]="PERMANENT"}(t.EN_SNAP_HELPER_TYPE||(t.EN_SNAP_HELPER_TYPE={}));class n{constructor(){this._snapHelperCvs=new Map,this._snapHelperDirs=new Map,this._snapHelperPts=new Map,this._keyToSnapHelperCvs=new Map,this._keyToSnapHelperDirs=new Map,this._keyToSnapHelperPts=new Map}static getInstance(){return n._instance||(n._instance=new n),n._instance}addSnapHelperCurves(e,t){t.length&&!this._keyToSnapHelperCvs.get(t[0].toString())&&(this._snapHelperCvs.get(e)?(this._snapHelperCvs.get(e).length>1&&this._snapHelperCvs.get(e).splice(0,this._snapHelperCvs.get(e).length-1),this._snapHelperCvs.get(e).push(t[0].toString())):this._snapHelperCvs.set(e,[t[0].toString()]),this._keyToSnapHelperCvs.set(t[0].toString(),t))}addSnapHelperDirs(e,t){const n=t.toString();this._keyToSnapHelperDirs.get(n)||(this._snapHelperDirs.get(e)?(this._snapHelperDirs.get(e).length>1&&this._snapHelperDirs.get(e).splice(0,this._snapHelperDirs.get(e).length-1),this._snapHelperDirs.get(e).push(n)):this._snapHelperDirs.set(e,[n]),this._keyToSnapHelperDirs.set(n,t))}addSnapHelperPoints(e,t){const n=t.toString();this._keyToSnapHelperPts.get(n)||(this._snapHelperPts.get(e)?(this._snapHelperPts.get(e).push(n),this._snapHelperPts.get(e).length):this._snapHelperPts.set(e,[n]),this._keyToSnapHelperPts.set(n,t))}deleteSnapHelperPoints(e,t){const n=this._snapHelperPts.get(e);n&&t.forEach((e=>{const t=e.toString(),r=n.findIndex((e=>t===e));r>-1&&n.splice(r,1),this._keyToSnapHelperPts.delete(t)}))}clearSnapHelperObjects(e){var t,n,r;null===(t=this._snapHelperCvs.get(e))||void 0===t||t.splice(0).forEach((e=>this._keyToSnapHelperCvs.delete(e))),null===(n=this._snapHelperDirs.get(e))||void 0===n||n.splice(0).forEach((e=>this._keyToSnapHelperDirs.delete(e))),null===(r=this._snapHelperPts.get(e))||void 0===r||r.splice(0).forEach((e=>this._keyToSnapHelperPts.delete(e))),this._snapHelperCvs.delete(e),this._snapHelperDirs.delete(e),this._snapHelperPts.delete(e)}deleteAllSnapHelperCurves(){this._snapHelperCvs=new Map,this._keyToSnapHelperCvs=new Map}deleteAllSnapHelperDirs(){this._snapHelperDirs=new Map,this._keyToSnapHelperDirs=new Map}deleteAllSnapHelperPoints(){this._snapHelperPts=new Map,this._keyToSnapHelperPts=new Map}getAllSnapHelperCurves(){const e=[];for(const t of this._snapHelperCvs.values())t.forEach((t=>{const n=this._keyToSnapHelperCvs.get(t);n&&e.push(n)}));return e}getAllSnapHelperDirs(){const e=[];for(const t of this._snapHelperDirs.values())t.forEach((t=>{const n=this._keyToSnapHelperDirs.get(t);n&&e.push(n)}));return e}getAllSnapHelperPoints(){const e=[];for(const t of this._snapHelperPts.values())t.forEach((t=>{const n=this._keyToSnapHelperPts.get(t);n&&e.push(n)}));return e}getSnapHelperPoints(e){const t=[];for(const n of this._snapHelperPts.get(e)||[]){const e=this._keyToSnapHelperPts.get(n);e&&t.push(e)}return t}}t.SnapHelperManager=n},58050:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextureCache=void 0;const r=n(31667);class s extends r.ResourceCache{constructor(){super(...arguments),this._textureByKey=new Map,this._deletingCache=new Map}clear(){this._textureByKey.clear()}_doSet(e,t){this._textureByKey.set(e,t),t.then((t=>{t.addEventListener&&t.addEventListener("dispose",(()=>{this._deleteCache(e)}))}))}_doGet(e){const t=this._textureByKey.get(e);return this._deletingCache.delete(e),this._deleteOverTimedCache(),t}_deleteCache(e){this._deletingCache.set(e,Date.now())}_deleteOverTimedCache(){const e=[];for(const[t,n]of this._deletingCache)Date.now()-n>12e4&&e.push(t);e.forEach((e=>this._deletingCache.delete(e)))}}t.TextureCache=s},51246:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TextureLoader=void 0;const o=i(n(78406)),a=n(31667);class c extends a.Loader{doLoad(e,t){return new Promise((n=>{const r=a.globalURLTranformer.transform(e);new o.TextureLoader(t.loadingMgr).load(r,(e=>(n(e),e)))}))}}t.TextureLoader=c},70768:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.platformEventMgr=t.EN_PLATFORM_EVENT_TYPE=void 0;const r=n(31667);!function(e){e.ACTION_FINISHED="action.finished",e.MOUSE_EVENT_PRE_ACTION="mouse.event.pre.action",e.KEY_EVENT_PRE_ACTION="key.event.pre.action"}(t.EN_PLATFORM_EVENT_TYPE||(t.EN_PLATFORM_EVENT_TYPE={})),t.platformEventMgr=new r.EventManagerGeneric},36707:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CompressRecords=void 0;const r=n(62452),s=n(16724);t.CompressRecords=class{static execute(e){const t=e[e.length-1],n=e[e.length-2];if(!n||!t)return!1;if(this._isMouseMove(t)&&this._isMouseMove(n)){const r=t,s=n;if(r.a===s.a&&this._fnKeyEquals(r,s))return e.splice(e.length-2,1),!0}if(t.tp===r.EN_RECORD_TYPE.WINDOW_SIZE&&n.tp===r.EN_RECORD_TYPE.WINDOW_SIZE)return e.splice(e.length-2,1),!0;const s=e[e.length-3],i=e[e.length-4];if(!s||!i)return!1;if(t.tp===r.EN_RECORD_TYPE.CAMERA&&s.tp===r.EN_RECORD_TYPE.CAMERA&&this._isMouseMove(n)&&this._isMouseMove(i)&&n.a===i.a)return e.splice(e.length-4,2),!0;const o=e[e.length-5],a=e[e.length-6];return!(!o||!a)&&(!!(t.tp===r.EN_RECORD_TYPE.CAMERA&&i.tp===r.EN_RECORD_TYPE.CAMERA&&this._isMouseDragMove(n)&&this._isMouseDragMove(o)&&this._isMouseMove(s)&&this._isMouseMove(a))&&(e.splice(e.length-6,3),!0))}static _isMouseMove(e){const t=e;return t.tp===r.EN_RECORD_TYPE.MOUSE&&t.mtp===s.EN_MOUSE_EVENT_TYPE.MOUSE_MOVE}static _isMouseDragMove(e){const t=e;return t.tp===r.EN_RECORD_TYPE.MOUSE&&t.mtp===s.EN_MOUSE_EVENT_TYPE.DRAG_MOVE}static _fnKeyEquals(e,t){var n,r,s,i,o,a,c,l;return!!(null===(n=null==e?void 0:e.fnKey)||void 0===n?void 0:n.altKey)==!!(null===(r=null==t?void 0:t.fnKey)||void 0===r?void 0:r.altKey)&&!!(null===(s=null==e?void 0:e.fnKey)||void 0===s?void 0:s.shiftKey)==!!(null===(i=null==t?void 0:t.fnKey)||void 0===i?void 0:i.shiftKey)&&!!(null===(o=null==e?void 0:e.fnKey)||void 0===o?void 0:o.ctrlKey)==!!(null===(a=null==t?void 0:t.fnKey)||void 0===a?void 0:a.ctrlKey)&&!!(null===(c=null==e?void 0:e.fnKey)||void 0===c?void 0:c.metaKey)==!!(null===(l=null==t?void 0:t.fnKey)||void 0===l?void 0:l.metaKey)}}},62452:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EN_RECORD_TYPE=void 0,function(e){e.INVALID="invalid",e.CMD="cmd",e.MOUSE="ms",e.CAMERA="cmr",e.CAMERA_TYPE="cmr_tp",e.KEY="k",e.INPUT_ENTEROR_TAB="ipt_e_or_t",e.WINDOW_SIZE="win_size",e.ASSERT_SELECTION="slct",e.ASSERT_TRANSACT="tsct",e.PAUSE="pause"}(t.EN_RECORD_TYPE||(t.EN_RECORD_TYPE={}))},97030:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(7323),n(3257),n(84959),n(62259),n(84303),n(92902),n(34464),n(97657),n(51271),n(33374)},77314:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseRecord=void 0;t.BaseRecord=class{isReady(){return!0}}},39778:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LogRecorder=void 0;const r=n(31667),s=n(16724),i=n(62452),o=n(88826),a=n(36707);class c{constructor(){this.enabled=!0,this.recording=!0,this._records=[]}static registerIgnoredCmds(...e){e.forEach((e=>this._ignoredCmds.add(e)))}static unRegisterIgnoredCmds(...e){e.forEach((e=>this._ignoredCmds.delete(e)))}init(){r.eventManager.addEventListener(r.EN_EVENT_TYPE.TRANSACT_COMMIT,(e=>{this.recordTransact(e)})),r.eventManager.addEventListener(r.EN_EVENT_TYPE.SELECTION_CHANGE,(e=>{if(!e)return;if(r.CmdManager.getInstance().getCurrentCmd())return;const t=r.Selection.getInstance().getSelectedElementIds().length;t&&this.recordSelection(t)})),r.eventManager.addEventListener(r.EN_EVENT_TYPE.PRE_SEND_CMD,(({cmdId:e,param:t})=>{this.recordCmd(e,t)}))}processKeyboardEvent(e,t){return this.recording&&this.recordKey(e,t),!1}processMouseEvent(e,t,n,r){if(!this.recording)return!1;if(t.includes("wheel")||t===s.EN_MOUSE_EVENT_TYPE.MOUSE_ENTER||t===s.EN_MOUSE_EVENT_TYPE.R_BUTTON_DOWN||t===s.EN_MOUSE_EVENT_TYPE.R_BUTTON_UP||t===s.EN_MOUSE_EVENT_TYPE.MOUSE_LEAVE)return!1;const o={tp:i.EN_RECORD_TYPE.MOUSE,a:e,mtp:t,pos:n.toArray2(),fnKey:r.dump()};return this.addRecord(o),!1}clear(){this._records.splice(0)}recordCmd(e,t,n=!0){if(n&&c._ignoredCmds.has(e))return!0;const s={tp:i.EN_RECORD_TYPE.CMD,cmdId:e},o=!t||"string"==typeof t||"boolean"==typeof t||"number"==typeof t;let a=t;try{if(!o){const e=JSON.stringify(t);if(a=JSON.parse(e),a.constructor!==t.constructor)return r.DebugWarn.assert(!1,"CMD参数必须是dumpLoad类型"," ","202-05-12"),!1}}catch(e){return r.DebugWarn.assert(!1,"CMD参数必须是dumpLoad类型"," ","202-05-12"),!1}return a&&(s.param=a),this.addRecord(s),!0}recordTransact(e){const t={tp:i.EN_RECORD_TYPE.ASSERT_TRANSACT,name:e};this.addRecord(t)}recordWindowSize(e,t){const n={tp:i.EN_RECORD_TYPE.WINDOW_SIZE,w:e,h:t},r=this._records[this._records.length-1];r&&r.tp===i.EN_RECORD_TYPE.WINDOW_SIZE&&this._records.pop(),this._records.push(n)}recordSelection(e){const t={tp:i.EN_RECORD_TYPE.ASSERT_SELECTION,cnt:e};this.addRecord(t)}recordKey(e,t){const n={tp:i.EN_RECORD_TYPE.KEY,a:e,k:t.key,type:t.type};this.addRecord(n)}recordStatusBarInput(e,t,n){const r={tp:i.EN_RECORD_TYPE.INPUT_ENTEROR_TAB,v:e,e:t,c:n};this.addRecord(r)}recordCamera(e,t,n,r){const s={tp:i.EN_RECORD_TYPE.CAMERA,data:[e.x,e.y,e.z,t.x,t.y,t.z,n.x,n.y,n.z,r]},o=this._records[this._records.length-1];o&&o.tp===i.EN_RECORD_TYPE.CAMERA&&this._records.pop(),this.addRecord(s)}recordCameraType(e){const t={tp:i.EN_RECORD_TYPE.CAMERA_TYPE,data:e},n=this._records[this._records.length-1];n&&n.tp===i.EN_RECORD_TYPE.CAMERA_TYPE&&this._records.pop(),this.addRecord(t)}dump(){return this._records}addRecord(e){var t,n;this.enabled&&(this._records.length||this.recordWindowSize(window.innerWidth,window.innerHeight),this._records.push(e),c.customedAdjust.forEach((e=>e(this._records))),(null===(n=null===(t=null===window||void 0===window?void 0:window.location)||void 0===t?void 0:t.href)||void 0===n?void 0:n.includes("log.compress=false"))||a.CompressRecords.execute(this._records))}}t.LogRecorder=c,c.customedAdjust=[],c._ignoredCmds=new Set([o.PlatformCmdIds.CMD_SAVE_RECORDS_TO_LOCAL])},36005:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.LogReplayer=void 0;const s=n(31667),i=n(74216),o=n(62452),a=n(11644),c=n(55788);t.LogReplayer=class{constructor(){this._allRecords=[],this._COUNT=0,this._logName="",this._canStart=!0,this._replayAFrame=e=>r(this,void 0,void 0,(function*(){if(!this._canStart)return;this._canStart=!1;const t=this._allRecords.shift();if(!t)return void this._sendResult("success");if(t.getType()===o.EN_RECORD_TYPE.PAUSE)return void this._sendResult("fail");if(!t.isReady())return this._allRecords.unshift(t),void(this._canStart=!0);if(t.getType()===o.EN_RECORD_TYPE.ASSERT_TRANSACT){if(this._transactionQueue.length){const e=this._transactionQueue.shift(),n=t._name;n!==e&&(s.DebugWarn.assert(!1,`事务不匹配,期望值：${n},实际值：${e},`," ","2020-05-12"),this._sendResult("fail"))}else this._allRecords.unshift(t);return void(this._canStart=!0)}if(!(yield t.replay(e)))return this._sendResult("fail"),void alert("测试报错，请检查");yield this._replayAFrame(e),this._canStart=!0})),this._transactionQueue=[],this._onTransactionCommitted=e=>{this._transactionQueue.push(e)},this._listenTransactionCommitted=()=>{s.eventManager.addEventListener(s.EN_EVENT_TYPE.TRANSACT_COMMIT,this._onTransactionCommitted)},this._unListenTransactionCommitted=()=>{s.eventManager.removeEventListener(s.EN_EVENT_TYPE.TRANSACT_COMMIT,this._onTransactionCommitted)}}replay(e,t,n){return r(this,void 0,void 0,(function*(){const r=new Promise((e=>{this._resolve=e}));this._logName=t,this._allRecords=n.map((e=>i.RecordLoader.load(e))),this._COUNT=this._allRecords.length,a.App.getInstance().getCurrentView().getLoops().deactiveInput(),this._listenTransactionCommitted();const s=c.getUrlParamAsNumber("log.speed"),o=Math.max(s,1);return this._itv=setInterval((()=>this._replayAFrame(e)),o),r}))}_sendResult(e){var t,n;const r=window.localStorage;r.removeItem(`_test_${this._logName}`),r.setItem(`_test_${this._logName}`,e),this._unListenTransactionCommitted(),this._itv&&clearInterval(this._itv),this._canStart=!1,a.App.getInstance().getCurrentView().getLoops().activateInput(),this._resolve(e),"fail"!==e&&((null===(n=null===(t=null===window||void 0===window?void 0:window.location)||void 0===t?void 0:t.href)||void 0===n?void 0:n.includes("log.close=false"))||window.close())}}},92902:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordAssertSelection=void 0;const s=n(31667),i=n(74216),o=n(77314),a=n(62452);class c extends o.BaseRecord{constructor(){super(...arguments),this._cnt=0}getType(){return a.EN_RECORD_TYPE.ASSERT_SELECTION}replay(){return r(this,void 0,void 0,(function*(){const e=s.Selection.getInstance().getSelectedElementIds().length;return e===this._cnt||(s.DebugWarn.assert(e===this._cnt,`选择集数量不一致,期望值${this._cnt},实际值:${e}`," ","2020-05-12"),!1)}))}dump(){return{tp:this.getType(),cnt:this._cnt}}load({cnt:e}){return this._cnt=e,this}}t.RecordAssertSelection=c,i.RecordLoader.registerType(new c)},84303:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordAssertTransact=void 0;const s=n(31667),i=n(62452),o=n(74216),a=n(77314);class c extends a.BaseRecord{constructor(){super(...arguments),this._name=""}init(e){return this._name=e,this}getType(){return i.EN_RECORD_TYPE.ASSERT_TRANSACT}replay(e){return r(this,void 0,void 0,(function*(){const t=e.transactionMgr.getLastTransactNodeName();return!(t!==this._name&&!t.endsWith(`->${this._name}`))||(s.DebugWarn.assert(!1,`事务不匹配,期望值：${this._name},实际值：${t},`," ","2020-05-12"),!1)}))}dump(){return{tp:this.getType(),name:this._name}}load({name:e}){return this._name=e,this}}t.RecordAssertTransact=c,o.RecordLoader.registerType(new c)},34464:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordCameraPos=void 0;const s=n(31667),i=n(62452),o=n(74216),a=n(11644),c=n(77314);class l extends c.BaseRecord{constructor(){super(...arguments),this._pos=new s.math.Vector3,this._target=new s.math.Vector3,this._up=new s.math.Vector3,this._zoom=50}init(e,t,n,r){return this._pos=new s.math.Vector3(e),this._target=new s.math.Vector3(t),this._up=new s.math.Vector3(n),this._zoom=r,this}getType(){return i.EN_RECORD_TYPE.CAMERA}replay(){return r(this,void 0,void 0,(function*(){return a.App.getInstance().getCurrentView().getCurrentCamera().setViewDirection(this._pos,this._target,this._up,this._zoom),!0}))}dump(){return{tp:this.getType(),data:[...this._pos.toArray3(),...this._target.toArray3(),...this._up.toArray3(),this._zoom]}}load({data:e}){const t=[...e];return this._pos.resetFromArray(t),t.splice(0,3),this._target.resetFromArray(t),t.splice(0,3),this._up.resetFromArray(t),t.splice(0,3),this._zoom=t[0],this}}t.RecordCameraPos=l,o.RecordLoader.registerType(new l)},97657:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordCameraType=void 0;const s=n(62452),i=n(74216),o=n(11644),a=n(77314);class c extends a.BaseRecord{init(e){return this._data=e,this}getType(){return s.EN_RECORD_TYPE.CAMERA_TYPE}replay(){var e;return r(this,void 0,void 0,(function*(){return!!(null===(e=o.App.getInstance().getCurrentView())||void 0===e?void 0:e.setOrbitControlCamera(0===this._data?"orthographic":"pespective"))}))}dump(){return{tp:this.getType(),data:this._data}}load({data:e}){return this._data=e,this}}t.RecordCameraType=c,i.RecordLoader.registerType(new c)},7323:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordCmd=void 0;const s=n(31667),i=n(62452),o=n(74216),a=n(77314),c=n(11644);class l extends a.BaseRecord{getType(){return i.EN_RECORD_TYPE.CMD}replay(){return r(this,void 0,void 0,(function*(){return c.App.getInstance().sendCmd(this._cmdId,this._param),yield s.sleep(150),!0}))}dump(){return{type:this.getType(),cmdId:this._cmdId}}load({cmdId:e,param:t}){return this._cmdId=e,this._param=t,this}}t.RecordCmd=l,o.RecordLoader.registerType(new l)},33374:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordInputEnterOrTab=void 0;const s=n(31667),i=n(62452),o=n(74216),a=n(77314);class c extends a.BaseRecord{constructor(){super(...arguments),this._isEnter=!1,this._changed=!0,this._value=""}getType(){return i.EN_RECORD_TYPE.INPUT_ENTEROR_TAB}replay(){return r(this,void 0,void 0,(function*(){yield s.sleep(100);const e=document.activeElement;return e.value=this._value,e.__DIY_CHANGED__=this._changed,function(e,t,n){const r=e.ownerDocument,s=r.defaultView||r.parentWindow;let i;r.createEvent?(s.KeyEvent?(i=r.createEvent("KeyEvents"),i.initKeyEvent(t,!0,!0,s,!1,!1,!1,!1,n,0)):(i=r.createEvent("UIEvents"),Object.defineProperty(i,"keyCode",{get(){return this.keyCodeVal}}),Object.defineProperty(i,"which",{get(){return this.keyCodeVal}}),i.initUIEvent(t,!0,!0,s,1),i.keyCodeVal=n,i.keyCode),e.dispatchEvent(i)):r.createEventObject&&(i=r.createEventObject(),i.keyCode=n,e.fireEvent(`on${t}`,i))}(e,"keydown",this._isEnter?13:9),yield s.sleep(100),!0}))}dump(){return{tp:this.getType(),e:this._isEnter,v:this._value,c:this._changed}}load({e:e,v:t,c:n}){return this._isEnter=e,this._value=t,void 0!==n&&(this._changed=n),this}}t.RecordInputEnterOrTab=c,o.RecordLoader.registerType(new c)},51271:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordKey=void 0;const s=n(62452),i=n(74216),o=n(77314),a=n(98295);class c extends o.BaseRecord{getType(){return s.EN_RECORD_TYPE.KEY}isReady(){var e;return(null===(e=a.ActionManager.getInstance().getCurrentAction())||void 0===e?void 0:e.getClassName())===this._actionName}replay(){return r(this,void 0,void 0,(function*(){return a.ActionManager.getInstance().processKeyboardEvent(this._hotKey),!0}))}dump(){return{tp:this.getType(),type:this._hotKey.type,k:this._hotKey.key,a:this._actionName}}load({type:e,k:t,a:n}){return this._actionName=n,this._hotKey={type:e,key:t},this}}t.RecordKey=c,i.RecordLoader.registerType(new c)},74216:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RecordLoader=void 0;class n{static registerType(e){this._types.set(e.getType(),e.constructor)}static load(e){return(new(this._types.get(e.tp))).load(e)}}t.RecordLoader=n,n._types=new Map},3257:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordMouse=void 0;const s=n(31667),i=n(62452),o=n(24878),a=n(16724),c=n(74216),l=n(77314),d=n(98295);class u extends l.BaseRecord{constructor(){super(...arguments),this._pos=new s.math.Vector2}getType(){return i.EN_RECORD_TYPE.MOUSE}isReady(){var e;return this._mouseEventType===a.EN_MOUSE_EVENT_TYPE.MOUSE_MOVE||(null===(e=d.ActionManager.getInstance().getCurrentAction())||void 0===e?void 0:e.getClassName())===this._actionName}replay(){return r(this,void 0,void 0,(function*(){d.ActionManager.getInstance().processMouseEvent(this._mouseEventType,this._pos,this._fnKey);let e=document.querySelector("#_mouseDiv_");if(!e){e=document.createElement("div"),e.id="_mouseDiv_",Object.assign(e.style,{width:"1px",height:"1px",position:"fixed",zIndex:10}),document.body.appendChild(e);{const t=document.createElement("div");Object.assign(t.style,{width:"240px",height:"1px","margin-left":"-120px","background-color":"black"}),e.appendChild(t)}{const t=document.createElement("div");Object.assign(t.style,{width:"1px",height:"240px","margin-top":"-120px","background-color":"black"}),e.appendChild(t)}}return Object.assign(e.style,{left:`${this._pos.x}px`,top:`${this._pos.y}px`}),!0}))}getMouseType(){return this._mouseEventType}dump(){return{tp:this.getType(),pos:this._pos.toArray2(),mtp:this._mouseEventType,fnKey:this._fnKey,a:this._actionName}}load(e){const{pos:t,a:n,mtp:r,fnKey:s}=e;if(this._pos.resetFromArray(t),this._mouseEventType=r,s){const{ctrlKey:e,altKey:t,shiftKey:n,metaKey:r}=s;this._fnKey=new o.FnKey({ctrlKey:!!e,altKey:!!t,shiftKey:!!n,metaKey:!!r})}else this._fnKey=new o.FnKey;return this._actionName=n,this}}t.RecordMouse=u,c.RecordLoader.registerType(new u)},84959:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordPause=void 0;const s=n(62452),i=n(74216),o=n(77314);class a extends o.BaseRecord{getType(){return s.EN_RECORD_TYPE.PAUSE}replay(){return r(this,void 0,void 0,(function*(){return!0}))}dump(){return{tp:this.getType()}}load(){return this}}t.RecordPause=a,i.RecordLoader.registerType(new a)},62259:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RecordWindowSize=t.resizeViewPort=void 0;const s=n(31667),i=n(62452),o=n(74216),a=n(77314);function c(e,t){if(s.DebugWarn.assert(window.outerWidth,"浏览器兼容问题?"," ","2020-05-11"),!window.outerWidth)return;const n=e+(window.outerWidth-window.innerWidth),r=t+(window.outerHeight-window.innerHeight);window.moveTo(0,0),window.resizeTo(n,r)}t.resizeViewPort=c;class l extends a.BaseRecord{constructor(){super(...arguments),this._width=800,this._height=600}getType(){return i.EN_RECORD_TYPE.WINDOW_SIZE}replay(){return r(this,void 0,void 0,(function*(){return this._height<1||this._width<1||(c(this._width,this._height),yield s.sleep(500)),!0}))}dump(){return{tp:this.getType(),w:this._width,h:this._height}}load({w:e,h:t}){return this._width=e,this._height=t,this}}t.RecordWindowSize=l,o.RecordLoader.registerType(new l)},82736:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.DDSLoader=void 0;const o=i(n(78406));class a extends o.CompressedTextureLoader{constructor(){super(),this._parser=this._parse}_parse(e,t){const n={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function r(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function s(e,t,n,r){const s=n*r*4,i=new Uint8Array(e,t,s),o=new Uint8Array(s);let a=0,c=0;for(let e=0;e<r;e++)for(let e=0;e<n;e++){const e=i[c];c++;const t=i[c];c++;const n=i[c];c++;const r=i[c];c++,o[a]=n,a++,o[a]=t,a++,o[a]=e,a++,o[a]=r,a++}return o}const i=r("DXT1"),a=r("DXT3"),c=r("DXT5"),l=new Int32Array(e,0,31);if(542327876!==l[0])return n;if(4&!l[20])return n;let d;let u=!1;switch(l[21]){case i:d=8,n.format=o.RGB_S3TC_DXT1_Format;break;case a:d=16,n.format=o.RGBA_S3TC_DXT3_Format;break;case c:d=16,n.format=o.RGBA_S3TC_DXT5_Format;break;default:if(!(32===l[22]&&16711680&l[23]&&65280&l[24]&&255&l[25]&&4278190080&l[26]))return n;u=!0,d=64,n.format=o.RGBAFormat}n.mipmapCount=1,131072&l[2]&&!1!==t&&(n.mipmapCount=Math.max(1,l[7])),n.isCubemap=!!(512&l[28]),n.width=l[4],n.height=l[3];let h=l[1]+4,g=n.width,f=n.height;const p=n.isCubemap?6:1;let _,m;for(let t=0;t<p;t++){for(let t=0;t<n.mipmapCount;t++){u?(_=s(e,h,g,f),m=_.length):(m=Math.max(4,g)/4*Math.max(4,f)/4*d,_=new Uint8Array(e,h,m));const t={data:_,width:g,height:f};n.mipmaps.push(t),h+=m,g=Math.max(.5*g,1),f=Math.max(.5*f,1)}g=n.width,f=n.height}return n}}t.DDSLoader=a},58658:function(e,t){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.getOSType=t.EN_OS_TYPE=void 0,function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.windows=1]="windows",e[e.mac=2]="mac"}(n=t.EN_OS_TYPE||(t.EN_OS_TYPE={})),t.getOSType=function(){var e,t;return(null===(e=null===navigator||void 0===navigator?void 0:navigator.platform)||void 0===e?void 0:e.includes("Mac"))?n.mac:(null===(t=null===navigator||void 0===navigator?void 0:navigator.platform)||void 0===t?void 0:t.includes("Win"))?n.windows:n.UNKNOWN}},55426:function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(s,i){function o(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.takeSceenshotToDataUrl=t.takeSceenshot=void 0;const s=n(31667),i=n(79762),o=n(9771),a="second_view_3d";function c(e,t){const n=Symbol("hide"),r=[],i=s.UniqueElementUtil.getOrCreateUniqueElement(e,s.WorkPlaneUE);i&&r.push(i),r.push(...e.getAllElementsByCtor(s.ModelView)),r.forEach((e=>e.setCustomizedVisible(n,!1)));const o=new s.TransactionGroup(e,"");if(t){const r=e.filterElements(t);r.length&&s.syncTransact(e,"临时隐藏",(()=>{r.forEach((e=>e.setCustomizedVisible(n,!1)))}))}return s.Selection.getInstance().clear(),s.HighLight.getInstance().clear(),{tg:o,tmpElements:r,symbolHide:n}}const l=e=>r(void 0,void 0,void 0,(function*(){return new Promise((t=>{const n=e.getElementsByTagName("canvas")[0];n.style.display="none",setTimeout((()=>r(void 0,void 0,void 0,(function*(){const e=yield(e=>new Promise((t=>{requestAnimationFrame((()=>{e.toBlob((e=>{t(e)}),"image/jpeg")}))})))(n);s.DebugWarn.assert(e,"blob为null","luting","2020-06-30"),t(e)}))),500)}))})),d=(e,t)=>{const{div:n,view:r}=((e=400,t=400)=>{const n=document.createElement("div");Object.assign(n.style,{position:"absolute",right:0,top:"50px",width:`${e}px`,height:`${t}px`,zIndex:2}),document.body.appendChild(n);const r=o.createIRender(n),c=i.app.createView(a,r,n);i.app.setCurrentView(a);const l=i.app.getMainDoc().create(s.ModelView).modelViewInit();return c.resetModelView(l),c.showAxis=!1,c.showGrid=!1,{div:n,view:c}})(e.size.width,e.size.height),c=r.getCurrentCamera();let l=c.position,d=c.up,u=s.math.Vector3.O();const h=Math.PI/4;{e.camera&&e.camera.position?l=new s.math.Vector3(e.camera.position):(l.x=u.x+Math.sqrt(10*Math.sin(h)/2),l.y=u.y-Math.sqrt(10*Math.sin(h)/2),l.z=u.z+Math.sqrt(10*Math.sin(h)/2));const t=s.math.Vector3.Z();d=e.camera&&e.camera.up?new s.math.Vector3(e.camera.up):t,c.setViewDirection(l,u,d)}const g=new s.math.Box2;let f=t;if(f)f.getCornerPts().forEach((e=>{const t=r.worldToScreen(e);g.expandByPoint(t)}));else{f=new s.math.Box3;const e=i.app.getMainDoc();for(const t of e.filterElements((e=>e.isElementVisible()))){const e=t.getGRep().toRenderNode(),n=[];e.traverse((e=>{e instanceof s.RenderMesh&&n.push(e)}));for(const e of n){const t=e.getVerts();for(let n=0;n<t.length/3;n++){const i=new s.math.Vector3(t[3*n],t[3*n+1],t[3*n+2]);e.globalMatrix&&!e.globalMatrix.isIdentity()&&i.transform(e.globalMatrix),f.expandByPoint(i);const o=r.worldToScreen(i);g.expandByPoint(o)}}}}if(g.isValid()){const t=c.target.subtracted(c.position),n=g.getSize(),i=g.getCenter(),o=Math.min(e.size.width/n.x,e.size.height/n.y),a=new s.math.Vector2(i.x,i.y);u=r.screenToWorldPlane(a,new s.math.Plane(s.math.Vector3.O(),t));const l=u.subtracted(t),h=.9*o*c.zoom;c.setViewDirection(l,u,d,h)}return{div:n,view:r}};t.takeSceenshot=(e,t,n)=>r(void 0,void 0,void 0,(function*(){const s=i.app.getMainDoc(),{tmpElements:o,tg:u,symbolHide:h}=c(s,n),{div:g,view:f}=d(e,t);return f.getModelView().updateView(),new Promise((e=>{requestAnimationFrame((()=>r(void 0,void 0,void 0,(function*(){const t=yield l(g);i.app.destroyView(a),document.body.removeChild(g),o.forEach((e=>e.setCustomizedVisible(h,!0))),u.rollBack(),s.updateView(),t&&e(t)}))))}))}));t.takeSceenshotToDataUrl=(e,t,n)=>r(void 0,void 0,void 0,(function*(){const s=i.app.getMainDoc(),{tmpElements:o,tg:l,symbolHide:u}=c(s,n),{div:h,view:g}=d(e,t);g.getModelView().updateView();const f=yield(p=h,r(void 0,void 0,void 0,(function*(){return new Promise((e=>{const t=p.getElementsByTagName("canvas")[0];t.style.display="none",setTimeout((()=>r(void 0,void 0,void 0,(function*(){const n=yield((e,t)=>new Promise((n=>{requestAnimationFrame((()=>{n(e.toDataURL("image/jpeg",t))}))})))(t,.8);o.forEach((e=>e.setCustomizedVisible(u,!0))),l.rollBack(),e(n)}))),1e3)}))})));var p;return i.app.destroyView(a),document.body.removeChild(h),f}))},84535:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tmpLineStyle=t.dashedFatLineStyle=t.dotLineStyle=t.getColorAccordingToDir=void 0;const r=n(31667);t.getColorAccordingToDir=function(e){let t=0;return e.isParallel(r.math.Vector3.X())?t=16711680:e.isParallel(r.math.Vector3.Y())?t=111106:e.isParallel(r.math.Vector3.Z())&&(t=255),t},t.dotLineStyle={dotted:!0,color:0,dashSize:10,gapSize:10},t.dashedFatLineStyle={fatLineStyle:{dashed:!0,color:0,linewidth:1,dashSize:50,gapSize:50}},t.tmpLineStyle={color:0}},91428:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.zoomWindow=t.zoomExtentsWithoutRotation=void 0;const r=n(31667);function s(e,t){const n=e.getCurrentCamera(),s=new r.math.Box3;for(const e of t)s.union(e);if(!s.isValid()||(e=>{const t=[];return t.push(...e.min.toArray3()),t.push(...e.max.toArray3()),t.some((e=>Math.abs(e)>=r.math.CONST.MODEL_MAX_LENGTH))})(s))return;const i=s.getCenter(),o=n.target.subtracted(n.position);if(n.isOrthogonal()){const s=new r.math.Box2;for(const n of t){const t=n.getCornerPts();for(const n of t){const t=e.worldToScreen(n);s.expandByPoint(t)}}if(!s.isValid())return;const a=s.getSize().add({x:0,y:100}),c=Math.min(e.getSize().x/a.x,e.getSize().y/a.y),l=i.subtracted(o),d=.9*c*n.zoom;return n.setViewDirection(l,i,n.up,d),{position:l,target:i,up:n.up,zoom:d}}const a=.5*s.getSize().getLength()/Math.tan(n.fov/2*Math.PI/180);const c=i.subtracted(o.normalized().multiply(a));n.setViewDirection(c,i,n.up)}t.zoomExtentsWithoutRotation=function(e,t){const n=e.getCurrentCamera();let r=e.getAllVisibleGReps();t&&(r=r.filter((n=>t(e.getDocument().getElementById(n.elementId)))));const i=r.map((e=>e.getBoundingBox()));let o=n.zoom;const a=Date.now();do{o=n.zoom;if(!s(e,i))return}while(Date.now()-a<1e3&&Math.abs(o-n.zoom)>.01)},t.zoomWindow=function(e,t){const n=e.getCurrentCamera(),s=n.position,i=n.up;if(t.isValid()){const o=t.getCenter(),a=Math.min(e.getSize().x/t.getSize().x,e.getSize().y/t.getSize().y),c=new r.math.Vector2(o.x,o.y),l=e.screenToWorldPlane(c,r.math.Plane.XOY()),d=new r.math.Vector3(n.target,l);n.setViewDirection(s.added(d),l,i,a*n.zoom)}}}},n={};function r(e){var s=n[e];if(void 0!==s)return s.exports;var i=n[e]={id:e,loaded:!1,exports:{}};return t[e].call(i.exports,i,i.exports,r),i.loaded=!0,i.exports}r.m=t,r.amdD=function(){throw new Error("define cannot be used indirect")},e=[],r.O=function(t,n,s,i){if(!n){var o=1/0;for(d=0;d<e.length;d++){n=e[d][0],s=e[d][1],i=e[d][2];for(var a=!0,c=0;c<n.length;c++)(!1&i||o>=i)&&Object.keys(r.O).every((function(e){return r.O[e](n[c])}))?n.splice(c--,1):(a=!1,i<o&&(o=i));if(a){e.splice(d--,1);var l=s();void 0!==l&&(t=l)}}return t}i=i||0;for(var d=e.length;d>0&&e[d-1][2]>i;d--)e[d]=e[d-1];e[d]=[n,s,i]},r.d=function(e,t){for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e},function(){var e={179:0};r.O.j=function(t){return 0===e[t]};var t=function(t,n){var s,i,o=n[0],a=n[1],c=n[2],l=0;if(o.some((function(t){return 0!==e[t]}))){for(s in a)r.o(a,s)&&(r.m[s]=a[s]);if(c)var d=c(r)}for(t&&t(n);l<o.length;l++)i=o[l],r.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return r.O(d)},n=self.webpackChunkdemo_app=self.webpackChunkdemo_app||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))}(),r.O(void 0,[135],(function(){return r(63607)}));var s=r.O(void 0,[135],(function(){return r(11166)}));s=r.O(s)}();